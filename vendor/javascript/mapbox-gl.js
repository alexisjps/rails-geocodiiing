import ut from"process";var pt=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var wt={};var Tt=ut;(function(ut,pt){wt=pt()})(0,(function(){var ut,wt,St;function define(pt,Tt){if(ut)if(wt){var It="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+ut+")(sharedChunk); ("+wt+")(sharedChunk); self.onerror = null;";var Lt={};ut(Lt);St=Tt(Lt);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(St.workerUrl=window.URL.createObjectURL(new Blob([It],{type:"text/javascript"})))}else wt=Tt;else ut=Tt}define(["exports"],(function(ut){var wt="3.5.1";let St;const It={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==St){const ut=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{St=null!=Tt.env.API_URL_REGEX?new RegExp(Tt.env.API_URL_REGEX):ut}catch(pt){St=ut}}return St},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!It.API_URL)return null;try{const ut=new URL(It.API_URL);return"api.mapbox.cn"===ut.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===ut.hostname?"https://events.mapbox.com/events/v2":null}catch(ut){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function i(ut){return It.API_URL_REGEX.test(ut)}function s(ut){return 0===ut.indexOf("mapbox:")}function a(ut){return It.API_CDN_URL_REGEX.test(ut)}function o(ut){return It.API_SPRITE_REGEX.test(ut)}function l(ut){return It.API_STYLE_REGEX.test(ut)&&!o(ut)}const Lt={create:"create",load:"load",fullLoad:"fullLoad"},Xt={mark(ut){performance.mark(ut)},measure(ut,pt,wt){performance.measure(ut,pt,wt)}};function h(ut){const pt=ut.name.split("?")[0];return a(pt)&&pt.includes("mapbox-gl.js")?"javascript":a(pt)&&pt.includes("mapbox-gl.css")?"css":function(ut){return It.API_FONTS_REGEX.test(ut)}(pt)?"fontRange":o(pt)?"sprite":l(pt)?"style":function(ut){return It.API_TILEJSON_REGEX.test(ut)}(pt)?"tilejson":"other"}function p(ut){return ut&&ut.__esModule&&Object.prototype.hasOwnProperty.call(ut,"default")?ut.default:ut}var Yt={},Mi={};Object.defineProperty(Mi,"__esModule",{value:!0}),Mi.setMatrixArrayType=function(ut){Mi.ARRAY_TYPE=br=ut},Mi.toRadian=function(ut){return ut*Vr},Mi.equals=function(ut,pt){return Math.abs(ut-pt)<=vr*Math.max(1,Math.abs(ut),Math.abs(pt))},Mi.RANDOM=Mi.ARRAY_TYPE=Mi.EPSILON=void 0;var vr=1e-6;Mi.EPSILON=vr;var br="undefined"!=typeof Float32Array?Float32Array:Array;Mi.ARRAY_TYPE=br;var Ar=Math.random;Mi.RANDOM=Ar;var Vr=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var ut=0,pt=arguments.length;pt--;)ut+=arguments[pt]*arguments[pt];return Math.sqrt(ut)});var nn={};function v(ut){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},v(ut)}Object.defineProperty(nn,"__esModule",{value:!0}),nn.create=function(){var ut=new sn.ARRAY_TYPE(4);return sn.ARRAY_TYPE!=Float32Array&&(ut[1]=0,ut[2]=0),ut[0]=1,ut[3]=1,ut},nn.clone=function(ut){var pt=new sn.ARRAY_TYPE(4);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt},nn.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut},nn.identity=function(ut){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=1,ut},nn.fromValues=function(ut,pt,wt,Tt){var St=new sn.ARRAY_TYPE(4);return St[0]=ut,St[1]=pt,St[2]=wt,St[3]=Tt,St},nn.set=function(ut,pt,wt,Tt,St){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut},nn.transpose=function(ut,pt){if(ut===pt){var wt=pt[1];ut[1]=pt[2],ut[2]=wt}else ut[0]=pt[0],ut[1]=pt[2],ut[2]=pt[1],ut[3]=pt[3];return ut},nn.invert=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=wt*It-St*Tt;return Lt?(ut[0]=It*(Lt=1/Lt),ut[1]=-Tt*Lt,ut[2]=-St*Lt,ut[3]=wt*Lt,ut):null},nn.adjoint=function(ut,pt){var wt=pt[0];return ut[0]=pt[3],ut[1]=-pt[1],ut[2]=-pt[2],ut[3]=wt,ut},nn.determinant=function(ut){return ut[0]*ut[3]-ut[2]*ut[1]},nn.multiply=M,nn.rotate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=Math.sin(wt),Yt=Math.cos(wt);return ut[0]=Tt*Yt+It*Xt,ut[1]=St*Yt+Lt*Xt,ut[2]=Tt*-Xt+It*Yt,ut[3]=St*-Xt+Lt*Yt,ut},nn.scale=function(ut,pt,wt){var Tt=pt[1],St=pt[2],It=pt[3],Lt=wt[0],Xt=wt[1];return ut[0]=pt[0]*Lt,ut[1]=Tt*Lt,ut[2]=St*Xt,ut[3]=It*Xt,ut},nn.fromRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=Tt,ut[1]=wt,ut[2]=-wt,ut[3]=Tt,ut},nn.fromScaling=function(ut,pt){return ut[0]=pt[0],ut[1]=0,ut[2]=0,ut[3]=pt[1],ut},nn.str=function(ut){return"mat2("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+")"},nn.frob=function(ut){return Math.hypot(ut[0],ut[1],ut[2],ut[3])},nn.LDU=function(ut,pt,wt,Tt){return ut[2]=Tt[2]/Tt[0],wt[0]=Tt[0],wt[1]=Tt[1],wt[3]=Tt[3]-ut[2]*wt[1],[ut,pt,wt]},nn.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut},nn.subtract=A,nn.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]},nn.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[0],Xt=pt[1],Yt=pt[2],Mi=pt[3];return Math.abs(wt-Lt)<=sn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Lt))&&Math.abs(Tt-Xt)<=sn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Xt))&&Math.abs(St-Yt)<=sn.EPSILON*Math.max(1,Math.abs(St),Math.abs(Yt))&&Math.abs(It-Mi)<=sn.EPSILON*Math.max(1,Math.abs(It),Math.abs(Mi))},nn.multiplyScalar=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut},nn.multiplyScalarAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut[3]=pt[3]+wt[3]*Tt,ut},nn.sub=nn.mul=void 0;var sn=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==v(ut)&&"function"!=typeof ut)return{default:ut};var wt=w(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function w(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(w=function(ut){return ut?wt:pt})(ut)}function M(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=wt[0],Yt=wt[1],Mi=wt[2],vr=wt[3];return ut[0]=Tt*Xt+It*Yt,ut[1]=St*Xt+Lt*Yt,ut[2]=Tt*Mi+It*vr,ut[3]=St*Mi+Lt*vr,ut}function A(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut[3]=pt[3]-wt[3],ut}nn.mul=M,nn.sub=A;var an={};function I(ut){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},I(ut)}Object.defineProperty(an,"__esModule",{value:!0}),an.create=function(){var ut=new ln.ARRAY_TYPE(6);return ln.ARRAY_TYPE!=Float32Array&&(ut[1]=0,ut[2]=0,ut[4]=0,ut[5]=0),ut[0]=1,ut[3]=1,ut},an.clone=function(ut){var pt=new ln.ARRAY_TYPE(6);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt[4]=ut[4],pt[5]=ut[5],pt},an.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[4]=pt[4],ut[5]=pt[5],ut},an.identity=function(ut){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=1,ut[4]=0,ut[5]=0,ut},an.fromValues=function(ut,pt,wt,Tt,St,It){var Lt=new ln.ARRAY_TYPE(6);return Lt[0]=ut,Lt[1]=pt,Lt[2]=wt,Lt[3]=Tt,Lt[4]=St,Lt[5]=It,Lt},an.set=function(ut,pt,wt,Tt,St,It,Lt){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut[4]=It,ut[5]=Lt,ut},an.invert=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=wt*It-Tt*St;return Yt?(ut[0]=It*(Yt=1/Yt),ut[1]=-Tt*Yt,ut[2]=-St*Yt,ut[3]=wt*Yt,ut[4]=(St*Xt-It*Lt)*Yt,ut[5]=(Tt*Lt-wt*Xt)*Yt,ut):null},an.determinant=function(ut){return ut[0]*ut[3]-ut[1]*ut[2]},an.multiply=z,an.rotate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=Math.sin(wt),vr=Math.cos(wt);return ut[0]=Tt*vr+It*Mi,ut[1]=St*vr+Lt*Mi,ut[2]=Tt*-Mi+It*vr,ut[3]=St*-Mi+Lt*vr,ut[4]=Xt,ut[5]=Yt,ut},an.scale=function(ut,pt,wt){var Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=wt[0],Mi=wt[1];return ut[0]=pt[0]*Yt,ut[1]=Tt*Yt,ut[2]=St*Mi,ut[3]=It*Mi,ut[4]=Lt,ut[5]=Xt,ut},an.translate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=wt[0],vr=wt[1];return ut[0]=Tt,ut[1]=St,ut[2]=It,ut[3]=Lt,ut[4]=Tt*Mi+It*vr+Xt,ut[5]=St*Mi+Lt*vr+Yt,ut},an.fromRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=Tt,ut[1]=wt,ut[2]=-wt,ut[3]=Tt,ut[4]=0,ut[5]=0,ut},an.fromScaling=function(ut,pt){return ut[0]=pt[0],ut[1]=0,ut[2]=0,ut[3]=pt[1],ut[4]=0,ut[5]=0,ut},an.fromTranslation=function(ut,pt){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=1,ut[4]=pt[0],ut[5]=pt[1],ut},an.str=function(ut){return"mat2d("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+", "+ut[4]+", "+ut[5]+")"},an.frob=function(ut){return Math.hypot(ut[0],ut[1],ut[2],ut[3],ut[4],ut[5],1)},an.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut[4]=pt[4]+wt[4],ut[5]=pt[5]+wt[5],ut},an.subtract=P,an.multiplyScalar=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut[4]=pt[4]*wt,ut[5]=pt[5]*wt,ut},an.multiplyScalarAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut[3]=pt[3]+wt[3]*Tt,ut[4]=pt[4]+wt[4]*Tt,ut[5]=pt[5]+wt[5]*Tt,ut},an.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]&&ut[4]===pt[4]&&ut[5]===pt[5]},an.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],Xt=ut[5],Yt=pt[0],Mi=pt[1],vr=pt[2],br=pt[3],Ar=pt[4],Vr=pt[5];return Math.abs(wt-Yt)<=ln.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Yt))&&Math.abs(Tt-Mi)<=ln.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Mi))&&Math.abs(St-vr)<=ln.EPSILON*Math.max(1,Math.abs(St),Math.abs(vr))&&Math.abs(It-br)<=ln.EPSILON*Math.max(1,Math.abs(It),Math.abs(br))&&Math.abs(Lt-Ar)<=ln.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(Ar))&&Math.abs(Xt-Vr)<=ln.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(Vr))},an.sub=an.mul=void 0;var ln=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==I(ut)&&"function"!=typeof ut)return{default:ut};var wt=k(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function k(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(k=function(ut){return ut?wt:pt})(ut)}function z(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=wt[0],vr=wt[1],br=wt[2],Ar=wt[3],Vr=wt[4],nn=wt[5];return ut[0]=Tt*Mi+It*vr,ut[1]=St*Mi+Lt*vr,ut[2]=Tt*br+It*Ar,ut[3]=St*br+Lt*Ar,ut[4]=Tt*Vr+It*nn+Xt,ut[5]=St*Vr+Lt*nn+Yt,ut}function P(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut[3]=pt[3]-wt[3],ut[4]=pt[4]-wt[4],ut[5]=pt[5]-wt[5],ut}an.mul=z,an.sub=P;var cn={};function B(ut){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},B(ut)}Object.defineProperty(cn,"__esModule",{value:!0}),cn.create=function(){var ut=new un.ARRAY_TYPE(9);return un.ARRAY_TYPE!=Float32Array&&(ut[1]=0,ut[2]=0,ut[3]=0,ut[5]=0,ut[6]=0,ut[7]=0),ut[0]=1,ut[4]=1,ut[8]=1,ut},cn.fromMat4=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[4],ut[4]=pt[5],ut[5]=pt[6],ut[6]=pt[8],ut[7]=pt[9],ut[8]=pt[10],ut},cn.clone=function(ut){var pt=new un.ARRAY_TYPE(9);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt[4]=ut[4],pt[5]=ut[5],pt[6]=ut[6],pt[7]=ut[7],pt[8]=ut[8],pt},cn.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[4]=pt[4],ut[5]=pt[5],ut[6]=pt[6],ut[7]=pt[7],ut[8]=pt[8],ut},cn.fromValues=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){var Mi=new un.ARRAY_TYPE(9);return Mi[0]=ut,Mi[1]=pt,Mi[2]=wt,Mi[3]=Tt,Mi[4]=St,Mi[5]=It,Mi[6]=Lt,Mi[7]=Xt,Mi[8]=Yt,Mi},cn.set=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut[4]=It,ut[5]=Lt,ut[6]=Xt,ut[7]=Yt,ut[8]=Mi,ut},cn.identity=function(ut){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=1,ut[5]=0,ut[6]=0,ut[7]=0,ut[8]=1,ut},cn.transpose=function(ut,pt){if(ut===pt){var wt=pt[1],Tt=pt[2],St=pt[5];ut[1]=pt[3],ut[2]=pt[6],ut[3]=wt,ut[5]=pt[7],ut[6]=Tt,ut[7]=St}else ut[0]=pt[0],ut[1]=pt[3],ut[2]=pt[6],ut[3]=pt[1],ut[4]=pt[4],ut[5]=pt[7],ut[6]=pt[2],ut[7]=pt[5],ut[8]=pt[8];return ut},cn.invert=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=pt[6],Mi=pt[7],vr=pt[8],br=vr*Lt-Xt*Mi,Ar=-vr*It+Xt*Yt,Vr=Mi*It-Lt*Yt,nn=wt*br+Tt*Ar+St*Vr;return nn?(ut[0]=br*(nn=1/nn),ut[1]=(-vr*Tt+St*Mi)*nn,ut[2]=(Xt*Tt-St*Lt)*nn,ut[3]=Ar*nn,ut[4]=(vr*wt-St*Yt)*nn,ut[5]=(-Xt*wt+St*It)*nn,ut[6]=Vr*nn,ut[7]=(-Mi*wt+Tt*Yt)*nn,ut[8]=(Lt*wt-Tt*It)*nn,ut):null},cn.adjoint=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=pt[6],Mi=pt[7],vr=pt[8];return ut[0]=Lt*vr-Xt*Mi,ut[1]=St*Mi-Tt*vr,ut[2]=Tt*Xt-St*Lt,ut[3]=Xt*Yt-It*vr,ut[4]=wt*vr-St*Yt,ut[5]=St*It-wt*Xt,ut[6]=It*Mi-Lt*Yt,ut[7]=Tt*Yt-wt*Mi,ut[8]=wt*Lt-Tt*It,ut},cn.determinant=function(ut){var pt=ut[3],wt=ut[4],Tt=ut[5],St=ut[6],It=ut[7],Lt=ut[8];return ut[0]*(Lt*wt-Tt*It)+ut[1]*(-Lt*pt+Tt*St)+ut[2]*(It*pt-wt*St)},cn.multiply=R,cn.translate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=pt[8],Ar=wt[0],Vr=wt[1];return ut[0]=Tt,ut[1]=St,ut[2]=It,ut[3]=Lt,ut[4]=Xt,ut[5]=Yt,ut[6]=Ar*Tt+Vr*Lt+Mi,ut[7]=Ar*St+Vr*Xt+vr,ut[8]=Ar*It+Vr*Yt+br,ut},cn.rotate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=pt[8],Ar=Math.sin(wt),Vr=Math.cos(wt);return ut[0]=Vr*Tt+Ar*Lt,ut[1]=Vr*St+Ar*Xt,ut[2]=Vr*It+Ar*Yt,ut[3]=Vr*Lt-Ar*Tt,ut[4]=Vr*Xt-Ar*St,ut[5]=Vr*Yt-Ar*It,ut[6]=Mi,ut[7]=vr,ut[8]=br,ut},cn.scale=function(ut,pt,wt){var Tt=wt[0],St=wt[1];return ut[0]=Tt*pt[0],ut[1]=Tt*pt[1],ut[2]=Tt*pt[2],ut[3]=St*pt[3],ut[4]=St*pt[4],ut[5]=St*pt[5],ut[6]=pt[6],ut[7]=pt[7],ut[8]=pt[8],ut},cn.fromTranslation=function(ut,pt){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=1,ut[5]=0,ut[6]=pt[0],ut[7]=pt[1],ut[8]=1,ut},cn.fromRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=Tt,ut[1]=wt,ut[2]=0,ut[3]=-wt,ut[4]=Tt,ut[5]=0,ut[6]=0,ut[7]=0,ut[8]=1,ut},cn.fromScaling=function(ut,pt){return ut[0]=pt[0],ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=pt[1],ut[5]=0,ut[6]=0,ut[7]=0,ut[8]=1,ut},cn.fromMat2d=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=0,ut[3]=pt[2],ut[4]=pt[3],ut[5]=0,ut[6]=pt[4],ut[7]=pt[5],ut[8]=1,ut},cn.fromQuat=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=wt+wt,Xt=Tt+Tt,Yt=St+St,Mi=wt*Lt,vr=Tt*Lt,br=Tt*Xt,Ar=St*Lt,Vr=St*Xt,nn=St*Yt,sn=It*Lt,an=It*Xt,ln=It*Yt;return ut[0]=1-br-nn,ut[3]=vr-ln,ut[6]=Ar+an,ut[1]=vr+ln,ut[4]=1-Mi-nn,ut[7]=Vr-sn,ut[2]=Ar-an,ut[5]=Vr+sn,ut[8]=1-Mi-br,ut},cn.normalFromMat4=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=pt[6],Mi=pt[7],vr=pt[8],br=pt[9],Ar=pt[10],Vr=pt[11],nn=pt[12],sn=pt[13],an=pt[14],ln=pt[15],cn=wt*Xt-Tt*Lt,un=wt*Yt-St*Lt,fn=wt*Mi-It*Lt,_n=Tt*Yt-St*Xt,gn=Tt*Mi-It*Xt,yn=St*Mi-It*Yt,xn=vr*sn-br*nn,vn=vr*an-Ar*nn,bn=vr*ln-Vr*nn,wn=br*an-Ar*sn,Tn=br*ln-Vr*sn,En=Ar*ln-Vr*an,Mn=cn*En-un*Tn+fn*wn+_n*bn-gn*vn+yn*xn;return Mn?(ut[0]=(Xt*En-Yt*Tn+Mi*wn)*(Mn=1/Mn),ut[1]=(Yt*bn-Lt*En-Mi*vn)*Mn,ut[2]=(Lt*Tn-Xt*bn+Mi*xn)*Mn,ut[3]=(St*Tn-Tt*En-It*wn)*Mn,ut[4]=(wt*En-St*bn+It*vn)*Mn,ut[5]=(Tt*bn-wt*Tn-It*xn)*Mn,ut[6]=(sn*yn-an*gn+ln*_n)*Mn,ut[7]=(an*fn-nn*yn-ln*un)*Mn,ut[8]=(nn*gn-sn*fn+ln*cn)*Mn,ut):null},cn.projection=function(ut,pt,wt){return ut[0]=2/pt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=-2/wt,ut[5]=0,ut[6]=-1,ut[7]=1,ut[8]=1,ut},cn.str=function(ut){return"mat3("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+", "+ut[4]+", "+ut[5]+", "+ut[6]+", "+ut[7]+", "+ut[8]+")"},cn.frob=function(ut){return Math.hypot(ut[0],ut[1],ut[2],ut[3],ut[4],ut[5],ut[6],ut[7],ut[8])},cn.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut[4]=pt[4]+wt[4],ut[5]=pt[5]+wt[5],ut[6]=pt[6]+wt[6],ut[7]=pt[7]+wt[7],ut[8]=pt[8]+wt[8],ut},cn.subtract=V,cn.multiplyScalar=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut[4]=pt[4]*wt,ut[5]=pt[5]*wt,ut[6]=pt[6]*wt,ut[7]=pt[7]*wt,ut[8]=pt[8]*wt,ut},cn.multiplyScalarAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut[3]=pt[3]+wt[3]*Tt,ut[4]=pt[4]+wt[4]*Tt,ut[5]=pt[5]+wt[5]*Tt,ut[6]=pt[6]+wt[6]*Tt,ut[7]=pt[7]+wt[7]*Tt,ut[8]=pt[8]+wt[8]*Tt,ut},cn.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]&&ut[4]===pt[4]&&ut[5]===pt[5]&&ut[6]===pt[6]&&ut[7]===pt[7]&&ut[8]===pt[8]},cn.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],Xt=ut[5],Yt=ut[6],Mi=ut[7],vr=ut[8],br=pt[0],Ar=pt[1],Vr=pt[2],nn=pt[3],sn=pt[4],an=pt[5],ln=pt[6],cn=pt[7],fn=pt[8];return Math.abs(wt-br)<=un.EPSILON*Math.max(1,Math.abs(wt),Math.abs(br))&&Math.abs(Tt-Ar)<=un.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Ar))&&Math.abs(St-Vr)<=un.EPSILON*Math.max(1,Math.abs(St),Math.abs(Vr))&&Math.abs(It-nn)<=un.EPSILON*Math.max(1,Math.abs(It),Math.abs(nn))&&Math.abs(Lt-sn)<=un.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(sn))&&Math.abs(Xt-an)<=un.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(an))&&Math.abs(Yt-ln)<=un.EPSILON*Math.max(1,Math.abs(Yt),Math.abs(ln))&&Math.abs(Mi-cn)<=un.EPSILON*Math.max(1,Math.abs(Mi),Math.abs(cn))&&Math.abs(vr-fn)<=un.EPSILON*Math.max(1,Math.abs(vr),Math.abs(fn))},cn.sub=cn.mul=void 0;var un=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==B(ut)&&"function"!=typeof ut)return{default:ut};var wt=C(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function C(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(C=function(ut){return ut?wt:pt})(ut)}function R(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=pt[8],Ar=wt[0],Vr=wt[1],nn=wt[2],sn=wt[3],an=wt[4],ln=wt[5],cn=wt[6],un=wt[7],fn=wt[8];return ut[0]=Ar*Tt+Vr*Lt+nn*Mi,ut[1]=Ar*St+Vr*Xt+nn*vr,ut[2]=Ar*It+Vr*Yt+nn*br,ut[3]=sn*Tt+an*Lt+ln*Mi,ut[4]=sn*St+an*Xt+ln*vr,ut[5]=sn*It+an*Yt+ln*br,ut[6]=cn*Tt+un*Lt+fn*Mi,ut[7]=cn*St+un*Xt+fn*vr,ut[8]=cn*It+un*Yt+fn*br,ut}function V(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut[3]=pt[3]-wt[3],ut[4]=pt[4]-wt[4],ut[5]=pt[5]-wt[5],ut[6]=pt[6]-wt[6],ut[7]=pt[7]-wt[7],ut[8]=pt[8]-wt[8],ut}cn.mul=R,cn.sub=V;var fn={};function L(ut){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},L(ut)}Object.defineProperty(fn,"__esModule",{value:!0}),fn.create=function(){var ut=new _n.ARRAY_TYPE(16);return _n.ARRAY_TYPE!=Float32Array&&(ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0),ut[0]=1,ut[5]=1,ut[10]=1,ut[15]=1,ut},fn.clone=function(ut){var pt=new _n.ARRAY_TYPE(16);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt[4]=ut[4],pt[5]=ut[5],pt[6]=ut[6],pt[7]=ut[7],pt[8]=ut[8],pt[9]=ut[9],pt[10]=ut[10],pt[11]=ut[11],pt[12]=ut[12],pt[13]=ut[13],pt[14]=ut[14],pt[15]=ut[15],pt},fn.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[4]=pt[4],ut[5]=pt[5],ut[6]=pt[6],ut[7]=pt[7],ut[8]=pt[8],ut[9]=pt[9],ut[10]=pt[10],ut[11]=pt[11],ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15],ut},fn.fromValues=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){var an=new _n.ARRAY_TYPE(16);return an[0]=ut,an[1]=pt,an[2]=wt,an[3]=Tt,an[4]=St,an[5]=It,an[6]=Lt,an[7]=Xt,an[8]=Yt,an[9]=Mi,an[10]=vr,an[11]=br,an[12]=Ar,an[13]=Vr,an[14]=nn,an[15]=sn,an},fn.set=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut[4]=It,ut[5]=Lt,ut[6]=Xt,ut[7]=Yt,ut[8]=Mi,ut[9]=vr,ut[10]=br,ut[11]=Ar,ut[12]=Vr,ut[13]=nn,ut[14]=sn,ut[15]=an,ut},fn.identity=N,fn.transpose=function(ut,pt){if(ut===pt){var wt=pt[1],Tt=pt[2],St=pt[3],It=pt[6],Lt=pt[7],Xt=pt[11];ut[1]=pt[4],ut[2]=pt[8],ut[3]=pt[12],ut[4]=wt,ut[6]=pt[9],ut[7]=pt[13],ut[8]=Tt,ut[9]=It,ut[11]=pt[14],ut[12]=St,ut[13]=Lt,ut[14]=Xt}else ut[0]=pt[0],ut[1]=pt[4],ut[2]=pt[8],ut[3]=pt[12],ut[4]=pt[1],ut[5]=pt[5],ut[6]=pt[9],ut[7]=pt[13],ut[8]=pt[2],ut[9]=pt[6],ut[10]=pt[10],ut[11]=pt[14],ut[12]=pt[3],ut[13]=pt[7],ut[14]=pt[11],ut[15]=pt[15];return ut},fn.invert=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=pt[6],Mi=pt[7],vr=pt[8],br=pt[9],Ar=pt[10],Vr=pt[11],nn=pt[12],sn=pt[13],an=pt[14],ln=pt[15],cn=wt*Xt-Tt*Lt,un=wt*Yt-St*Lt,fn=wt*Mi-It*Lt,_n=Tt*Yt-St*Xt,gn=Tt*Mi-It*Xt,yn=St*Mi-It*Yt,xn=vr*sn-br*nn,vn=vr*an-Ar*nn,bn=vr*ln-Vr*nn,wn=br*an-Ar*sn,Tn=br*ln-Vr*sn,En=Ar*ln-Vr*an,Mn=cn*En-un*Tn+fn*wn+_n*bn-gn*vn+yn*xn;return Mn?(ut[0]=(Xt*En-Yt*Tn+Mi*wn)*(Mn=1/Mn),ut[1]=(St*Tn-Tt*En-It*wn)*Mn,ut[2]=(sn*yn-an*gn+ln*_n)*Mn,ut[3]=(Ar*gn-br*yn-Vr*_n)*Mn,ut[4]=(Yt*bn-Lt*En-Mi*vn)*Mn,ut[5]=(wt*En-St*bn+It*vn)*Mn,ut[6]=(an*fn-nn*yn-ln*un)*Mn,ut[7]=(vr*yn-Ar*fn+Vr*un)*Mn,ut[8]=(Lt*Tn-Xt*bn+Mi*xn)*Mn,ut[9]=(Tt*bn-wt*Tn-It*xn)*Mn,ut[10]=(nn*gn-sn*fn+ln*cn)*Mn,ut[11]=(br*fn-vr*gn-Vr*cn)*Mn,ut[12]=(Xt*vn-Lt*wn-Yt*xn)*Mn,ut[13]=(wt*wn-Tt*vn+St*xn)*Mn,ut[14]=(sn*un-nn*_n-an*cn)*Mn,ut[15]=(vr*_n-br*un+Ar*cn)*Mn,ut):null},fn.adjoint=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=pt[4],Xt=pt[5],Yt=pt[6],Mi=pt[7],vr=pt[8],br=pt[9],Ar=pt[10],Vr=pt[11],nn=pt[12],sn=pt[13],an=pt[14],ln=pt[15];return ut[0]=Xt*(Ar*ln-Vr*an)-br*(Yt*ln-Mi*an)+sn*(Yt*Vr-Mi*Ar),ut[1]=-(Tt*(Ar*ln-Vr*an)-br*(St*ln-It*an)+sn*(St*Vr-It*Ar)),ut[2]=Tt*(Yt*ln-Mi*an)-Xt*(St*ln-It*an)+sn*(St*Mi-It*Yt),ut[3]=-(Tt*(Yt*Vr-Mi*Ar)-Xt*(St*Vr-It*Ar)+br*(St*Mi-It*Yt)),ut[4]=-(Lt*(Ar*ln-Vr*an)-vr*(Yt*ln-Mi*an)+nn*(Yt*Vr-Mi*Ar)),ut[5]=wt*(Ar*ln-Vr*an)-vr*(St*ln-It*an)+nn*(St*Vr-It*Ar),ut[6]=-(wt*(Yt*ln-Mi*an)-Lt*(St*ln-It*an)+nn*(St*Mi-It*Yt)),ut[7]=wt*(Yt*Vr-Mi*Ar)-Lt*(St*Vr-It*Ar)+vr*(St*Mi-It*Yt),ut[8]=Lt*(br*ln-Vr*sn)-vr*(Xt*ln-Mi*sn)+nn*(Xt*Vr-Mi*br),ut[9]=-(wt*(br*ln-Vr*sn)-vr*(Tt*ln-It*sn)+nn*(Tt*Vr-It*br)),ut[10]=wt*(Xt*ln-Mi*sn)-Lt*(Tt*ln-It*sn)+nn*(Tt*Mi-It*Xt),ut[11]=-(wt*(Xt*Vr-Mi*br)-Lt*(Tt*Vr-It*br)+vr*(Tt*Mi-It*Xt)),ut[12]=-(Lt*(br*an-Ar*sn)-vr*(Xt*an-Yt*sn)+nn*(Xt*Ar-Yt*br)),ut[13]=wt*(br*an-Ar*sn)-vr*(Tt*an-St*sn)+nn*(Tt*Ar-St*br),ut[14]=-(wt*(Xt*an-Yt*sn)-Lt*(Tt*an-St*sn)+nn*(Tt*Yt-St*Xt)),ut[15]=wt*(Xt*Ar-Yt*br)-Lt*(Tt*Ar-St*br)+vr*(Tt*Yt-St*Xt),ut},fn.determinant=function(ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3],It=ut[4],Lt=ut[5],Xt=ut[6],Yt=ut[7],Mi=ut[8],vr=ut[9],br=ut[10],Ar=ut[11],Vr=ut[12],nn=ut[13],sn=ut[14],an=ut[15];return(pt*Lt-wt*It)*(br*an-Ar*sn)-(pt*Xt-Tt*It)*(vr*an-Ar*nn)+(pt*Yt-St*It)*(vr*sn-br*nn)+(wt*Xt-Tt*Lt)*(Mi*an-Ar*Vr)-(wt*Yt-St*Lt)*(Mi*sn-br*Vr)+(Tt*Yt-St*Xt)*(Mi*nn-vr*Vr)},fn.multiply=j,fn.translate=function(ut,pt,wt){var Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn=wt[0],an=wt[1],ln=wt[2];return pt===ut?(ut[12]=pt[0]*sn+pt[4]*an+pt[8]*ln+pt[12],ut[13]=pt[1]*sn+pt[5]*an+pt[9]*ln+pt[13],ut[14]=pt[2]*sn+pt[6]*an+pt[10]*ln+pt[14],ut[15]=pt[3]*sn+pt[7]*an+pt[11]*ln+pt[15]):(St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=pt[8],Ar=pt[9],Vr=pt[10],nn=pt[11],ut[0]=Tt=pt[0],ut[1]=St,ut[2]=It,ut[3]=Lt,ut[4]=Xt,ut[5]=Yt,ut[6]=Mi,ut[7]=vr,ut[8]=br,ut[9]=Ar,ut[10]=Vr,ut[11]=nn,ut[12]=Tt*sn+Xt*an+br*ln+pt[12],ut[13]=St*sn+Yt*an+Ar*ln+pt[13],ut[14]=It*sn+Mi*an+Vr*ln+pt[14],ut[15]=Lt*sn+vr*an+nn*ln+pt[15]),ut},fn.scale=function(ut,pt,wt){var Tt=wt[0],St=wt[1],It=wt[2];return ut[0]=pt[0]*Tt,ut[1]=pt[1]*Tt,ut[2]=pt[2]*Tt,ut[3]=pt[3]*Tt,ut[4]=pt[4]*St,ut[5]=pt[5]*St,ut[6]=pt[6]*St,ut[7]=pt[7]*St,ut[8]=pt[8]*It,ut[9]=pt[9]*It,ut[10]=pt[10]*It,ut[11]=pt[11]*It,ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15],ut},fn.rotate=function(ut,pt,wt,Tt){var St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,gn,yn,xn,vn,bn,wn,Tn,En=Tt[0],Mn=Tt[1],Sn=Tt[2],An=Math.hypot(En,Mn,Sn);return An<_n.EPSILON?null:(En*=An=1/An,Mn*=An,Sn*=An,St=Math.sin(wt),It=Math.cos(wt),Yt=pt[1],Mi=pt[2],vr=pt[3],Ar=pt[5],Vr=pt[6],nn=pt[7],an=pt[9],ln=pt[10],cn=pt[11],un=En*En*(Lt=1-It)+It,yn=En*Mn*Lt-Sn*St,xn=Mn*Mn*Lt+It,vn=Sn*Mn*Lt+En*St,bn=En*Sn*Lt+Mn*St,wn=Mn*Sn*Lt-En*St,Tn=Sn*Sn*Lt+It,ut[0]=(Xt=pt[0])*un+(br=pt[4])*(fn=Mn*En*Lt+Sn*St)+(sn=pt[8])*(gn=Sn*En*Lt-Mn*St),ut[1]=Yt*un+Ar*fn+an*gn,ut[2]=Mi*un+Vr*fn+ln*gn,ut[3]=vr*un+nn*fn+cn*gn,ut[4]=Xt*yn+br*xn+sn*vn,ut[5]=Yt*yn+Ar*xn+an*vn,ut[6]=Mi*yn+Vr*xn+ln*vn,ut[7]=vr*yn+nn*xn+cn*vn,ut[8]=Xt*bn+br*wn+sn*Tn,ut[9]=Yt*bn+Ar*wn+an*Tn,ut[10]=Mi*bn+Vr*wn+ln*Tn,ut[11]=vr*bn+nn*wn+cn*Tn,pt!==ut&&(ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15]),ut)},fn.rotateX=function(ut,pt,wt){var Tt=Math.sin(wt),St=Math.cos(wt),It=pt[4],Lt=pt[5],Xt=pt[6],Yt=pt[7],Mi=pt[8],vr=pt[9],br=pt[10],Ar=pt[11];return pt!==ut&&(ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15]),ut[4]=It*St+Mi*Tt,ut[5]=Lt*St+vr*Tt,ut[6]=Xt*St+br*Tt,ut[7]=Yt*St+Ar*Tt,ut[8]=Mi*St-It*Tt,ut[9]=vr*St-Lt*Tt,ut[10]=br*St-Xt*Tt,ut[11]=Ar*St-Yt*Tt,ut},fn.rotateY=function(ut,pt,wt){var Tt=Math.sin(wt),St=Math.cos(wt),It=pt[0],Lt=pt[1],Xt=pt[2],Yt=pt[3],Mi=pt[8],vr=pt[9],br=pt[10],Ar=pt[11];return pt!==ut&&(ut[4]=pt[4],ut[5]=pt[5],ut[6]=pt[6],ut[7]=pt[7],ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15]),ut[0]=It*St-Mi*Tt,ut[1]=Lt*St-vr*Tt,ut[2]=Xt*St-br*Tt,ut[3]=Yt*St-Ar*Tt,ut[8]=It*Tt+Mi*St,ut[9]=Lt*Tt+vr*St,ut[10]=Xt*Tt+br*St,ut[11]=Yt*Tt+Ar*St,ut},fn.rotateZ=function(ut,pt,wt){var Tt=Math.sin(wt),St=Math.cos(wt),It=pt[0],Lt=pt[1],Xt=pt[2],Yt=pt[3],Mi=pt[4],vr=pt[5],br=pt[6],Ar=pt[7];return pt!==ut&&(ut[8]=pt[8],ut[9]=pt[9],ut[10]=pt[10],ut[11]=pt[11],ut[12]=pt[12],ut[13]=pt[13],ut[14]=pt[14],ut[15]=pt[15]),ut[0]=It*St+Mi*Tt,ut[1]=Lt*St+vr*Tt,ut[2]=Xt*St+br*Tt,ut[3]=Yt*St+Ar*Tt,ut[4]=Mi*St-It*Tt,ut[5]=vr*St-Lt*Tt,ut[6]=br*St-Xt*Tt,ut[7]=Ar*St-Yt*Tt,ut},fn.fromTranslation=function(ut,pt){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=1,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=1,ut[11]=0,ut[12]=pt[0],ut[13]=pt[1],ut[14]=pt[2],ut[15]=1,ut},fn.fromScaling=function(ut,pt){return ut[0]=pt[0],ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=pt[1],ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=pt[2],ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut},fn.fromRotation=function(ut,pt,wt){var Tt,St,It,Lt=wt[0],Xt=wt[1],Yt=wt[2],Mi=Math.hypot(Lt,Xt,Yt);return Mi<_n.EPSILON?null:(Lt*=Mi=1/Mi,Xt*=Mi,Yt*=Mi,Tt=Math.sin(pt),St=Math.cos(pt),ut[0]=Lt*Lt*(It=1-St)+St,ut[1]=Xt*Lt*It+Yt*Tt,ut[2]=Yt*Lt*It-Xt*Tt,ut[3]=0,ut[4]=Lt*Xt*It-Yt*Tt,ut[5]=Xt*Xt*It+St,ut[6]=Yt*Xt*It+Lt*Tt,ut[7]=0,ut[8]=Lt*Yt*It+Xt*Tt,ut[9]=Xt*Yt*It-Lt*Tt,ut[10]=Yt*Yt*It+St,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut)},fn.fromXRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=Tt,ut[6]=wt,ut[7]=0,ut[8]=0,ut[9]=-wt,ut[10]=Tt,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut},fn.fromYRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=Tt,ut[1]=0,ut[2]=-wt,ut[3]=0,ut[4]=0,ut[5]=1,ut[6]=0,ut[7]=0,ut[8]=wt,ut[9]=0,ut[10]=Tt,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut},fn.fromZRotation=function(ut,pt){var wt=Math.sin(pt),Tt=Math.cos(pt);return ut[0]=Tt,ut[1]=wt,ut[2]=0,ut[3]=0,ut[4]=-wt,ut[5]=Tt,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=1,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut},fn.fromRotationTranslation=q,fn.fromQuat2=function(ut,pt){var wt=new _n.ARRAY_TYPE(3),Tt=-pt[0],St=-pt[1],It=-pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=Tt*Tt+St*St+It*It+Lt*Lt;return br>0?(wt[0]=2*(Xt*Lt+vr*Tt+Yt*It-Mi*St)/br,wt[1]=2*(Yt*Lt+vr*St+Mi*Tt-Xt*It)/br,wt[2]=2*(Mi*Lt+vr*It+Xt*St-Yt*Tt)/br):(wt[0]=2*(Xt*Lt+vr*Tt+Yt*It-Mi*St),wt[1]=2*(Yt*Lt+vr*St+Mi*Tt-Xt*It),wt[2]=2*(Mi*Lt+vr*It+Xt*St-Yt*Tt)),q(ut,pt,wt),ut},fn.getTranslation=function(ut,pt){return ut[0]=pt[12],ut[1]=pt[13],ut[2]=pt[14],ut},fn.getScaling=$,fn.getRotation=function(ut,pt){var wt=new _n.ARRAY_TYPE(3);$(wt,pt);var Tt=1/wt[0],St=1/wt[1],It=1/wt[2],Lt=pt[0]*Tt,Xt=pt[1]*St,Yt=pt[2]*It,Mi=pt[4]*Tt,vr=pt[5]*St,br=pt[6]*It,Ar=pt[8]*Tt,Vr=pt[9]*St,nn=pt[10]*It,sn=Lt+vr+nn,an=0;return sn>0?(an=2*Math.sqrt(sn+1),ut[3]=.25*an,ut[0]=(br-Vr)/an,ut[1]=(Ar-Yt)/an,ut[2]=(Xt-Mi)/an):Lt>vr&&Lt>nn?(an=2*Math.sqrt(1+Lt-vr-nn),ut[3]=(br-Vr)/an,ut[0]=.25*an,ut[1]=(Xt+Mi)/an,ut[2]=(Ar+Yt)/an):vr>nn?(an=2*Math.sqrt(1+vr-Lt-nn),ut[3]=(Ar-Yt)/an,ut[0]=(Xt+Mi)/an,ut[1]=.25*an,ut[2]=(br+Vr)/an):(an=2*Math.sqrt(1+nn-Lt-vr),ut[3]=(Xt-Mi)/an,ut[0]=(Ar+Yt)/an,ut[1]=(br+Vr)/an,ut[2]=.25*an),ut},fn.fromRotationTranslationScale=function(ut,pt,wt,Tt){var St=pt[0],It=pt[1],Lt=pt[2],Xt=pt[3],Yt=St+St,Mi=It+It,vr=Lt+Lt,br=St*Yt,Ar=St*Mi,Vr=St*vr,nn=It*Mi,sn=It*vr,an=Lt*vr,ln=Xt*Yt,cn=Xt*Mi,un=Xt*vr,fn=Tt[0],_n=Tt[1],gn=Tt[2];return ut[0]=(1-(nn+an))*fn,ut[1]=(Ar+un)*fn,ut[2]=(Vr-cn)*fn,ut[3]=0,ut[4]=(Ar-un)*_n,ut[5]=(1-(br+an))*_n,ut[6]=(sn+ln)*_n,ut[7]=0,ut[8]=(Vr+cn)*gn,ut[9]=(sn-ln)*gn,ut[10]=(1-(br+nn))*gn,ut[11]=0,ut[12]=wt[0],ut[13]=wt[1],ut[14]=wt[2],ut[15]=1,ut},fn.fromRotationTranslationScaleOrigin=function(ut,pt,wt,Tt,St){var It=pt[0],Lt=pt[1],Xt=pt[2],Yt=pt[3],Mi=It+It,vr=Lt+Lt,br=Xt+Xt,Ar=It*Mi,Vr=It*vr,nn=It*br,sn=Lt*vr,an=Lt*br,ln=Xt*br,cn=Yt*Mi,un=Yt*vr,fn=Yt*br,_n=Tt[0],gn=Tt[1],yn=Tt[2],xn=St[0],vn=St[1],bn=St[2],wn=(1-(sn+ln))*_n,Tn=(Vr+fn)*_n,En=(nn-un)*_n,Mn=(Vr-fn)*gn,Sn=(1-(Ar+ln))*gn,An=(an+cn)*gn,In=(nn+un)*yn,Pn=(an-cn)*yn,zn=(1-(Ar+sn))*yn;return ut[0]=wn,ut[1]=Tn,ut[2]=En,ut[3]=0,ut[4]=Mn,ut[5]=Sn,ut[6]=An,ut[7]=0,ut[8]=In,ut[9]=Pn,ut[10]=zn,ut[11]=0,ut[12]=wt[0]+xn-(wn*xn+Mn*vn+In*bn),ut[13]=wt[1]+vn-(Tn*xn+Sn*vn+Pn*bn),ut[14]=wt[2]+bn-(En*xn+An*vn+zn*bn),ut[15]=1,ut},fn.fromQuat=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=wt+wt,Xt=Tt+Tt,Yt=St+St,Mi=wt*Lt,vr=Tt*Lt,br=Tt*Xt,Ar=St*Lt,Vr=St*Xt,nn=St*Yt,sn=It*Lt,an=It*Xt,ln=It*Yt;return ut[0]=1-br-nn,ut[1]=vr+ln,ut[2]=Ar-an,ut[3]=0,ut[4]=vr-ln,ut[5]=1-Mi-nn,ut[6]=Vr+sn,ut[7]=0,ut[8]=Ar+an,ut[9]=Vr-sn,ut[10]=1-Mi-br,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut},fn.frustum=function(ut,pt,wt,Tt,St,It,Lt){var Xt=1/(wt-pt),Yt=1/(St-Tt),Mi=1/(It-Lt);return ut[0]=2*It*Xt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=2*It*Yt,ut[6]=0,ut[7]=0,ut[8]=(wt+pt)*Xt,ut[9]=(St+Tt)*Yt,ut[10]=(Lt+It)*Mi,ut[11]=-1,ut[12]=0,ut[13]=0,ut[14]=Lt*It*2*Mi,ut[15]=0,ut},fn.perspectiveNO=G,fn.perspectiveZO=function(ut,pt,wt,Tt,St){var It,Lt=1/Math.tan(pt/2);return ut[0]=Lt/wt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=Lt,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[11]=-1,ut[12]=0,ut[13]=0,ut[15]=0,null!=St&&St!==1/0?(ut[10]=St*(It=1/(Tt-St)),ut[14]=St*Tt*It):(ut[10]=-1,ut[14]=-Tt),ut},fn.perspectiveFromFieldOfView=function(ut,pt,wt,Tt){var St=Math.tan(pt.upDegrees*Math.PI/180),It=Math.tan(pt.downDegrees*Math.PI/180),Lt=Math.tan(pt.leftDegrees*Math.PI/180),Xt=Math.tan(pt.rightDegrees*Math.PI/180),Yt=2/(Lt+Xt),Mi=2/(St+It);return ut[0]=Yt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=Mi,ut[6]=0,ut[7]=0,ut[8]=-(Lt-Xt)*Yt*.5,ut[9]=(St-It)*Mi*.5,ut[10]=Tt/(wt-Tt),ut[11]=-1,ut[12]=0,ut[13]=0,ut[14]=Tt*wt/(wt-Tt),ut[15]=0,ut},fn.orthoNO=X,fn.orthoZO=function(ut,pt,wt,Tt,St,It,Lt){var Xt=1/(pt-wt),Yt=1/(Tt-St),Mi=1/(It-Lt);return ut[0]=-2*Xt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=-2*Yt,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=Mi,ut[11]=0,ut[12]=(pt+wt)*Xt,ut[13]=(St+Tt)*Yt,ut[14]=It*Mi,ut[15]=1,ut},fn.lookAt=function(ut,pt,wt,Tt){var St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn=pt[0],sn=pt[1],an=pt[2],ln=Tt[0],cn=Tt[1],un=Tt[2],fn=wt[0],gn=wt[1],yn=wt[2];return Math.abs(nn-fn)<_n.EPSILON&&Math.abs(sn-gn)<_n.EPSILON&&Math.abs(an-yn)<_n.EPSILON?N(ut):(vr=nn-fn,br=sn-gn,Ar=an-yn,St=cn*(Ar*=Vr=1/Math.hypot(vr,br,Ar))-un*(br*=Vr),It=un*(vr*=Vr)-ln*Ar,Lt=ln*br-cn*vr,(Vr=Math.hypot(St,It,Lt))?(St*=Vr=1/Vr,It*=Vr,Lt*=Vr):(St=0,It=0,Lt=0),Xt=br*Lt-Ar*It,Yt=Ar*St-vr*Lt,Mi=vr*It-br*St,(Vr=Math.hypot(Xt,Yt,Mi))?(Xt*=Vr=1/Vr,Yt*=Vr,Mi*=Vr):(Xt=0,Yt=0,Mi=0),ut[0]=St,ut[1]=Xt,ut[2]=vr,ut[3]=0,ut[4]=It,ut[5]=Yt,ut[6]=br,ut[7]=0,ut[8]=Lt,ut[9]=Mi,ut[10]=Ar,ut[11]=0,ut[12]=-(St*nn+It*sn+Lt*an),ut[13]=-(Xt*nn+Yt*sn+Mi*an),ut[14]=-(vr*nn+br*sn+Ar*an),ut[15]=1,ut)},fn.targetTo=function(ut,pt,wt,Tt){var St=pt[0],It=pt[1],Lt=pt[2],Xt=Tt[0],Yt=Tt[1],Mi=Tt[2],vr=St-wt[0],br=It-wt[1],Ar=Lt-wt[2],Vr=vr*vr+br*br+Ar*Ar;Vr>0&&(vr*=Vr=1/Math.sqrt(Vr),br*=Vr,Ar*=Vr);var nn=Yt*Ar-Mi*br,sn=Mi*vr-Xt*Ar,an=Xt*br-Yt*vr;return(Vr=nn*nn+sn*sn+an*an)>0&&(nn*=Vr=1/Math.sqrt(Vr),sn*=Vr,an*=Vr),ut[0]=nn,ut[1]=sn,ut[2]=an,ut[3]=0,ut[4]=br*an-Ar*sn,ut[5]=Ar*nn-vr*an,ut[6]=vr*sn-br*nn,ut[7]=0,ut[8]=vr,ut[9]=br,ut[10]=Ar,ut[11]=0,ut[12]=St,ut[13]=It,ut[14]=Lt,ut[15]=1,ut},fn.str=function(ut){return"mat4("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+", "+ut[4]+", "+ut[5]+", "+ut[6]+", "+ut[7]+", "+ut[8]+", "+ut[9]+", "+ut[10]+", "+ut[11]+", "+ut[12]+", "+ut[13]+", "+ut[14]+", "+ut[15]+")"},fn.frob=function(ut){return Math.hypot(ut[0],ut[1],ut[2],ut[3],ut[4],ut[5],ut[6],ut[7],ut[8],ut[9],ut[10],ut[11],ut[12],ut[13],ut[14],ut[15])},fn.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut[4]=pt[4]+wt[4],ut[5]=pt[5]+wt[5],ut[6]=pt[6]+wt[6],ut[7]=pt[7]+wt[7],ut[8]=pt[8]+wt[8],ut[9]=pt[9]+wt[9],ut[10]=pt[10]+wt[10],ut[11]=pt[11]+wt[11],ut[12]=pt[12]+wt[12],ut[13]=pt[13]+wt[13],ut[14]=pt[14]+wt[14],ut[15]=pt[15]+wt[15],ut},fn.subtract=Y,fn.multiplyScalar=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut[4]=pt[4]*wt,ut[5]=pt[5]*wt,ut[6]=pt[6]*wt,ut[7]=pt[7]*wt,ut[8]=pt[8]*wt,ut[9]=pt[9]*wt,ut[10]=pt[10]*wt,ut[11]=pt[11]*wt,ut[12]=pt[12]*wt,ut[13]=pt[13]*wt,ut[14]=pt[14]*wt,ut[15]=pt[15]*wt,ut},fn.multiplyScalarAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut[3]=pt[3]+wt[3]*Tt,ut[4]=pt[4]+wt[4]*Tt,ut[5]=pt[5]+wt[5]*Tt,ut[6]=pt[6]+wt[6]*Tt,ut[7]=pt[7]+wt[7]*Tt,ut[8]=pt[8]+wt[8]*Tt,ut[9]=pt[9]+wt[9]*Tt,ut[10]=pt[10]+wt[10]*Tt,ut[11]=pt[11]+wt[11]*Tt,ut[12]=pt[12]+wt[12]*Tt,ut[13]=pt[13]+wt[13]*Tt,ut[14]=pt[14]+wt[14]*Tt,ut[15]=pt[15]+wt[15]*Tt,ut},fn.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]&&ut[4]===pt[4]&&ut[5]===pt[5]&&ut[6]===pt[6]&&ut[7]===pt[7]&&ut[8]===pt[8]&&ut[9]===pt[9]&&ut[10]===pt[10]&&ut[11]===pt[11]&&ut[12]===pt[12]&&ut[13]===pt[13]&&ut[14]===pt[14]&&ut[15]===pt[15]},fn.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],Xt=ut[5],Yt=ut[6],Mi=ut[7],vr=ut[8],br=ut[9],Ar=ut[10],Vr=ut[11],nn=ut[12],sn=ut[13],an=ut[14],ln=ut[15],cn=pt[0],un=pt[1],fn=pt[2],gn=pt[3],yn=pt[4],xn=pt[5],vn=pt[6],bn=pt[7],wn=pt[8],Tn=pt[9],En=pt[10],Mn=pt[11],Sn=pt[12],An=pt[13],In=pt[14],Pn=pt[15];return Math.abs(wt-cn)<=_n.EPSILON*Math.max(1,Math.abs(wt),Math.abs(cn))&&Math.abs(Tt-un)<=_n.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(un))&&Math.abs(St-fn)<=_n.EPSILON*Math.max(1,Math.abs(St),Math.abs(fn))&&Math.abs(It-gn)<=_n.EPSILON*Math.max(1,Math.abs(It),Math.abs(gn))&&Math.abs(Lt-yn)<=_n.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(yn))&&Math.abs(Xt-xn)<=_n.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(xn))&&Math.abs(Yt-vn)<=_n.EPSILON*Math.max(1,Math.abs(Yt),Math.abs(vn))&&Math.abs(Mi-bn)<=_n.EPSILON*Math.max(1,Math.abs(Mi),Math.abs(bn))&&Math.abs(vr-wn)<=_n.EPSILON*Math.max(1,Math.abs(vr),Math.abs(wn))&&Math.abs(br-Tn)<=_n.EPSILON*Math.max(1,Math.abs(br),Math.abs(Tn))&&Math.abs(Ar-En)<=_n.EPSILON*Math.max(1,Math.abs(Ar),Math.abs(En))&&Math.abs(Vr-Mn)<=_n.EPSILON*Math.max(1,Math.abs(Vr),Math.abs(Mn))&&Math.abs(nn-Sn)<=_n.EPSILON*Math.max(1,Math.abs(nn),Math.abs(Sn))&&Math.abs(sn-An)<=_n.EPSILON*Math.max(1,Math.abs(sn),Math.abs(An))&&Math.abs(an-In)<=_n.EPSILON*Math.max(1,Math.abs(an),Math.abs(In))&&Math.abs(ln-Pn)<=_n.EPSILON*Math.max(1,Math.abs(ln),Math.abs(Pn))},fn.sub=fn.mul=fn.ortho=fn.perspective=void 0;var _n=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==L(ut)&&"function"!=typeof ut)return{default:ut};var wt=U(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function U(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(U=function(ut){return ut?wt:pt})(ut)}function N(ut){return ut[0]=1,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=1,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=1,ut[11]=0,ut[12]=0,ut[13]=0,ut[14]=0,ut[15]=1,ut}function j(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=pt[8],Ar=pt[9],Vr=pt[10],nn=pt[11],sn=pt[12],an=pt[13],ln=pt[14],cn=pt[15],un=wt[0],fn=wt[1],_n=wt[2],gn=wt[3];return ut[0]=un*Tt+fn*Xt+_n*br+gn*sn,ut[1]=un*St+fn*Yt+_n*Ar+gn*an,ut[2]=un*It+fn*Mi+_n*Vr+gn*ln,ut[3]=un*Lt+fn*vr+_n*nn+gn*cn,ut[4]=(un=wt[4])*Tt+(fn=wt[5])*Xt+(_n=wt[6])*br+(gn=wt[7])*sn,ut[5]=un*St+fn*Yt+_n*Ar+gn*an,ut[6]=un*It+fn*Mi+_n*Vr+gn*ln,ut[7]=un*Lt+fn*vr+_n*nn+gn*cn,ut[8]=(un=wt[8])*Tt+(fn=wt[9])*Xt+(_n=wt[10])*br+(gn=wt[11])*sn,ut[9]=un*St+fn*Yt+_n*Ar+gn*an,ut[10]=un*It+fn*Mi+_n*Vr+gn*ln,ut[11]=un*Lt+fn*vr+_n*nn+gn*cn,ut[12]=(un=wt[12])*Tt+(fn=wt[13])*Xt+(_n=wt[14])*br+(gn=wt[15])*sn,ut[13]=un*St+fn*Yt+_n*Ar+gn*an,ut[14]=un*It+fn*Mi+_n*Vr+gn*ln,ut[15]=un*Lt+fn*vr+_n*nn+gn*cn,ut}function q(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=Tt+Tt,Yt=St+St,Mi=It+It,vr=Tt*Xt,br=Tt*Yt,Ar=Tt*Mi,Vr=St*Yt,nn=St*Mi,sn=It*Mi,an=Lt*Xt,ln=Lt*Yt,cn=Lt*Mi;return ut[0]=1-(Vr+sn),ut[1]=br+cn,ut[2]=Ar-ln,ut[3]=0,ut[4]=br-cn,ut[5]=1-(vr+sn),ut[6]=nn+an,ut[7]=0,ut[8]=Ar+ln,ut[9]=nn-an,ut[10]=1-(vr+Vr),ut[11]=0,ut[12]=wt[0],ut[13]=wt[1],ut[14]=wt[2],ut[15]=1,ut}function $(ut,pt){var wt=pt[4],Tt=pt[5],St=pt[6],It=pt[8],Lt=pt[9],Xt=pt[10];return ut[0]=Math.hypot(pt[0],pt[1],pt[2]),ut[1]=Math.hypot(wt,Tt,St),ut[2]=Math.hypot(It,Lt,Xt),ut}function G(ut,pt,wt,Tt,St){var It,Lt=1/Math.tan(pt/2);return ut[0]=Lt/wt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=Lt,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[11]=-1,ut[12]=0,ut[13]=0,ut[15]=0,null!=St&&St!==1/0?(ut[10]=(St+Tt)*(It=1/(Tt-St)),ut[14]=2*St*Tt*It):(ut[10]=-1,ut[14]=-2*Tt),ut}function X(ut,pt,wt,Tt,St,It,Lt){var Xt=1/(pt-wt),Yt=1/(Tt-St),Mi=1/(It-Lt);return ut[0]=-2*Xt,ut[1]=0,ut[2]=0,ut[3]=0,ut[4]=0,ut[5]=-2*Yt,ut[6]=0,ut[7]=0,ut[8]=0,ut[9]=0,ut[10]=2*Mi,ut[11]=0,ut[12]=(pt+wt)*Xt,ut[13]=(St+Tt)*Yt,ut[14]=(Lt+It)*Mi,ut[15]=1,ut}function Y(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut[3]=pt[3]-wt[3],ut[4]=pt[4]-wt[4],ut[5]=pt[5]-wt[5],ut[6]=pt[6]-wt[6],ut[7]=pt[7]-wt[7],ut[8]=pt[8]-wt[8],ut[9]=pt[9]-wt[9],ut[10]=pt[10]-wt[10],ut[11]=pt[11]-wt[11],ut[12]=pt[12]-wt[12],ut[13]=pt[13]-wt[13],ut[14]=pt[14]-wt[14],ut[15]=pt[15]-wt[15],ut}fn.perspective=G,fn.ortho=X,fn.mul=j,fn.sub=Y;var gn={},yn={};function K(ut){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},K(ut)}Object.defineProperty(yn,"__esModule",{value:!0}),yn.create=Q,yn.clone=function(ut){var pt=new xn.ARRAY_TYPE(3);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt},yn.length=tt,yn.fromValues=function(ut,pt,wt){var Tt=new xn.ARRAY_TYPE(3);return Tt[0]=ut,Tt[1]=pt,Tt[2]=wt,Tt},yn.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut},yn.set=function(ut,pt,wt,Tt){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut},yn.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut},yn.subtract=et,yn.multiply=rt,yn.divide=nt,yn.ceil=function(ut,pt){return ut[0]=Math.ceil(pt[0]),ut[1]=Math.ceil(pt[1]),ut[2]=Math.ceil(pt[2]),ut},yn.floor=function(ut,pt){return ut[0]=Math.floor(pt[0]),ut[1]=Math.floor(pt[1]),ut[2]=Math.floor(pt[2]),ut},yn.min=function(ut,pt,wt){return ut[0]=Math.min(pt[0],wt[0]),ut[1]=Math.min(pt[1],wt[1]),ut[2]=Math.min(pt[2],wt[2]),ut},yn.max=function(ut,pt,wt){return ut[0]=Math.max(pt[0],wt[0]),ut[1]=Math.max(pt[1],wt[1]),ut[2]=Math.max(pt[2],wt[2]),ut},yn.round=function(ut,pt){return ut[0]=Math.round(pt[0]),ut[1]=Math.round(pt[1]),ut[2]=Math.round(pt[2]),ut},yn.scale=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut},yn.scaleAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut},yn.distance=it,yn.squaredDistance=st,yn.squaredLength=at,yn.negate=function(ut,pt){return ut[0]=-pt[0],ut[1]=-pt[1],ut[2]=-pt[2],ut},yn.inverse=function(ut,pt){return ut[0]=1/pt[0],ut[1]=1/pt[1],ut[2]=1/pt[2],ut},yn.normalize=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=wt*wt+Tt*Tt+St*St;return It>0&&(It=1/Math.sqrt(It)),ut[0]=pt[0]*It,ut[1]=pt[1]*It,ut[2]=pt[2]*It,ut},yn.dot=ot,yn.cross=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=wt[0],Xt=wt[1],Yt=wt[2];return ut[0]=St*Yt-It*Xt,ut[1]=It*Lt-Tt*Yt,ut[2]=Tt*Xt-St*Lt,ut},yn.lerp=function(ut,pt,wt,Tt){var St=pt[0],It=pt[1],Lt=pt[2];return ut[0]=St+Tt*(wt[0]-St),ut[1]=It+Tt*(wt[1]-It),ut[2]=Lt+Tt*(wt[2]-Lt),ut},yn.hermite=function(ut,pt,wt,Tt,St,It){var Lt=It*It,Xt=Lt*(2*It-3)+1,Yt=Lt*(It-2)+It,Mi=Lt*(It-1),vr=Lt*(3-2*It);return ut[0]=pt[0]*Xt+wt[0]*Yt+Tt[0]*Mi+St[0]*vr,ut[1]=pt[1]*Xt+wt[1]*Yt+Tt[1]*Mi+St[1]*vr,ut[2]=pt[2]*Xt+wt[2]*Yt+Tt[2]*Mi+St[2]*vr,ut},yn.bezier=function(ut,pt,wt,Tt,St,It){var Lt=1-It,Xt=Lt*Lt,Yt=It*It,Mi=Xt*Lt,vr=3*It*Xt,br=3*Yt*Lt,Ar=Yt*It;return ut[0]=pt[0]*Mi+wt[0]*vr+Tt[0]*br+St[0]*Ar,ut[1]=pt[1]*Mi+wt[1]*vr+Tt[1]*br+St[1]*Ar,ut[2]=pt[2]*Mi+wt[2]*vr+Tt[2]*br+St[2]*Ar,ut},yn.random=function(ut,pt){pt=pt||1;var wt=2*xn.RANDOM()*Math.PI,Tt=2*xn.RANDOM()-1,St=Math.sqrt(1-Tt*Tt)*pt;return ut[0]=Math.cos(wt)*St,ut[1]=Math.sin(wt)*St,ut[2]=Tt*pt,ut},yn.transformMat4=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=wt[3]*Tt+wt[7]*St+wt[11]*It+wt[15];return ut[0]=(wt[0]*Tt+wt[4]*St+wt[8]*It+wt[12])/(Lt=Lt||1),ut[1]=(wt[1]*Tt+wt[5]*St+wt[9]*It+wt[13])/Lt,ut[2]=(wt[2]*Tt+wt[6]*St+wt[10]*It+wt[14])/Lt,ut},yn.transformMat3=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2];return ut[0]=Tt*wt[0]+St*wt[3]+It*wt[6],ut[1]=Tt*wt[1]+St*wt[4]+It*wt[7],ut[2]=Tt*wt[2]+St*wt[5]+It*wt[8],ut},yn.transformQuat=function(ut,pt,wt){var Tt=wt[0],St=wt[1],It=wt[2],Lt=pt[0],Xt=pt[1],Yt=pt[2],Mi=St*Yt-It*Xt,vr=It*Lt-Tt*Yt,br=Tt*Xt-St*Lt,Ar=St*br-It*vr,Vr=It*Mi-Tt*br,nn=Tt*vr-St*Mi,sn=2*wt[3];return vr*=sn,br*=sn,Vr*=2,nn*=2,ut[0]=Lt+(Mi*=sn)+(Ar*=2),ut[1]=Xt+vr+Vr,ut[2]=Yt+br+nn,ut},yn.rotateX=function(ut,pt,wt,Tt){var St=[],It=[];return St[0]=pt[0]-wt[0],St[1]=pt[1]-wt[1],St[2]=pt[2]-wt[2],It[0]=St[0],It[1]=St[1]*Math.cos(Tt)-St[2]*Math.sin(Tt),It[2]=St[1]*Math.sin(Tt)+St[2]*Math.cos(Tt),ut[0]=It[0]+wt[0],ut[1]=It[1]+wt[1],ut[2]=It[2]+wt[2],ut},yn.rotateY=function(ut,pt,wt,Tt){var St=[],It=[];return St[0]=pt[0]-wt[0],St[1]=pt[1]-wt[1],St[2]=pt[2]-wt[2],It[0]=St[2]*Math.sin(Tt)+St[0]*Math.cos(Tt),It[1]=St[1],It[2]=St[2]*Math.cos(Tt)-St[0]*Math.sin(Tt),ut[0]=It[0]+wt[0],ut[1]=It[1]+wt[1],ut[2]=It[2]+wt[2],ut},yn.rotateZ=function(ut,pt,wt,Tt){var St=[],It=[];return St[0]=pt[0]-wt[0],St[1]=pt[1]-wt[1],St[2]=pt[2]-wt[2],It[0]=St[0]*Math.cos(Tt)-St[1]*Math.sin(Tt),It[1]=St[0]*Math.sin(Tt)+St[1]*Math.cos(Tt),It[2]=St[2],ut[0]=It[0]+wt[0],ut[1]=It[1]+wt[1],ut[2]=It[2]+wt[2],ut},yn.angle=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=pt[0],Lt=pt[1],Xt=pt[2],Yt=Math.sqrt(wt*wt+Tt*Tt+St*St)*Math.sqrt(It*It+Lt*Lt+Xt*Xt),Mi=Yt&&ot(ut,pt)/Yt;return Math.acos(Math.min(Math.max(Mi,-1),1))},yn.zero=function(ut){return ut[0]=0,ut[1]=0,ut[2]=0,ut},yn.str=function(ut){return"vec3("+ut[0]+", "+ut[1]+", "+ut[2]+")"},yn.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]},yn.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=pt[0],Lt=pt[1],Xt=pt[2];return Math.abs(wt-It)<=xn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(It))&&Math.abs(Tt-Lt)<=xn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Lt))&&Math.abs(St-Xt)<=xn.EPSILON*Math.max(1,Math.abs(St),Math.abs(Xt))},yn.forEach=yn.sqrLen=yn.len=yn.sqrDist=yn.dist=yn.div=yn.mul=yn.sub=void 0;var xn=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==K(ut)&&"function"!=typeof ut)return{default:ut};var wt=J(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function J(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(J=function(ut){return ut?wt:pt})(ut)}function Q(){var ut=new xn.ARRAY_TYPE(3);return xn.ARRAY_TYPE!=Float32Array&&(ut[0]=0,ut[1]=0,ut[2]=0),ut}function tt(ut){return Math.hypot(ut[0],ut[1],ut[2])}function et(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut}function rt(ut,pt,wt){return ut[0]=pt[0]*wt[0],ut[1]=pt[1]*wt[1],ut[2]=pt[2]*wt[2],ut}function nt(ut,pt,wt){return ut[0]=pt[0]/wt[0],ut[1]=pt[1]/wt[1],ut[2]=pt[2]/wt[2],ut}function it(ut,pt){return Math.hypot(pt[0]-ut[0],pt[1]-ut[1],pt[2]-ut[2])}function st(ut,pt){var wt=pt[0]-ut[0],Tt=pt[1]-ut[1],St=pt[2]-ut[2];return wt*wt+Tt*Tt+St*St}function at(ut){var pt=ut[0],wt=ut[1],Tt=ut[2];return pt*pt+wt*wt+Tt*Tt}function ot(ut,pt){return ut[0]*pt[0]+ut[1]*pt[1]+ut[2]*pt[2]}yn.sub=et,yn.mul=rt,yn.div=nt,yn.dist=it,yn.sqrDist=st,yn.len=tt,yn.sqrLen=at;var vn,bn=(vn=Q(),function(ut,pt,wt,Tt,St,It){var Lt,Xt;for(pt||(pt=3),wt||(wt=0),Xt=Tt?Math.min(Tt*pt+wt,ut.length):ut.length,Lt=wt;Lt<Xt;Lt+=pt)vn[0]=ut[Lt],vn[1]=ut[Lt+1],vn[2]=ut[Lt+2],St(vn,vn,It),ut[Lt]=vn[0],ut[Lt+1]=vn[1],ut[Lt+2]=vn[2];return ut});yn.forEach=bn;var wn={};function ht(ut){return ht="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},ht(ut)}Object.defineProperty(wn,"__esModule",{value:!0}),wn.create=dt,wn.clone=function(ut){var pt=new Tn.ARRAY_TYPE(4);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt},wn.fromValues=function(ut,pt,wt,Tt){var St=new Tn.ARRAY_TYPE(4);return St[0]=ut,St[1]=pt,St[2]=wt,St[3]=Tt,St},wn.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut},wn.set=function(ut,pt,wt,Tt,St){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut},wn.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut},wn.subtract=mt,wn.multiply=yt,wn.divide=gt,wn.ceil=function(ut,pt){return ut[0]=Math.ceil(pt[0]),ut[1]=Math.ceil(pt[1]),ut[2]=Math.ceil(pt[2]),ut[3]=Math.ceil(pt[3]),ut},wn.floor=function(ut,pt){return ut[0]=Math.floor(pt[0]),ut[1]=Math.floor(pt[1]),ut[2]=Math.floor(pt[2]),ut[3]=Math.floor(pt[3]),ut},wn.min=function(ut,pt,wt){return ut[0]=Math.min(pt[0],wt[0]),ut[1]=Math.min(pt[1],wt[1]),ut[2]=Math.min(pt[2],wt[2]),ut[3]=Math.min(pt[3],wt[3]),ut},wn.max=function(ut,pt,wt){return ut[0]=Math.max(pt[0],wt[0]),ut[1]=Math.max(pt[1],wt[1]),ut[2]=Math.max(pt[2],wt[2]),ut[3]=Math.max(pt[3],wt[3]),ut},wn.round=function(ut,pt){return ut[0]=Math.round(pt[0]),ut[1]=Math.round(pt[1]),ut[2]=Math.round(pt[2]),ut[3]=Math.round(pt[3]),ut},wn.scale=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut},wn.scaleAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut[2]=pt[2]+wt[2]*Tt,ut[3]=pt[3]+wt[3]*Tt,ut},wn.distance=xt,wn.squaredDistance=bt,wn.length=vt,wn.squaredLength=_t,wn.negate=function(ut,pt){return ut[0]=-pt[0],ut[1]=-pt[1],ut[2]=-pt[2],ut[3]=-pt[3],ut},wn.inverse=function(ut,pt){return ut[0]=1/pt[0],ut[1]=1/pt[1],ut[2]=1/pt[2],ut[3]=1/pt[3],ut},wn.normalize=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=wt*wt+Tt*Tt+St*St+It*It;return Lt>0&&(Lt=1/Math.sqrt(Lt)),ut[0]=wt*Lt,ut[1]=Tt*Lt,ut[2]=St*Lt,ut[3]=It*Lt,ut},wn.dot=function(ut,pt){return ut[0]*pt[0]+ut[1]*pt[1]+ut[2]*pt[2]+ut[3]*pt[3]},wn.cross=function(ut,pt,wt,Tt){var St=wt[0]*Tt[1]-wt[1]*Tt[0],It=wt[0]*Tt[2]-wt[2]*Tt[0],Lt=wt[0]*Tt[3]-wt[3]*Tt[0],Xt=wt[1]*Tt[2]-wt[2]*Tt[1],Yt=wt[1]*Tt[3]-wt[3]*Tt[1],Mi=wt[2]*Tt[3]-wt[3]*Tt[2],vr=pt[0],br=pt[1],Ar=pt[2],Vr=pt[3];return ut[0]=br*Mi-Ar*Yt+Vr*Xt,ut[1]=-vr*Mi+Ar*Lt-Vr*It,ut[2]=vr*Yt-br*Lt+Vr*St,ut[3]=-vr*Xt+br*It-Ar*St,ut},wn.lerp=function(ut,pt,wt,Tt){var St=pt[0],It=pt[1],Lt=pt[2],Xt=pt[3];return ut[0]=St+Tt*(wt[0]-St),ut[1]=It+Tt*(wt[1]-It),ut[2]=Lt+Tt*(wt[2]-Lt),ut[3]=Xt+Tt*(wt[3]-Xt),ut},wn.random=function(ut,pt){var wt,Tt,St,It,Lt,Xt;pt=pt||1;do{Lt=(wt=2*Tn.RANDOM()-1)*wt+(Tt=2*Tn.RANDOM()-1)*Tt}while(Lt>=1);do{Xt=(St=2*Tn.RANDOM()-1)*St+(It=2*Tn.RANDOM()-1)*It}while(Xt>=1);var Yt=Math.sqrt((1-Lt)/Xt);return ut[0]=pt*wt,ut[1]=pt*Tt,ut[2]=pt*St*Yt,ut[3]=pt*It*Yt,ut},wn.transformMat4=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3];return ut[0]=wt[0]*Tt+wt[4]*St+wt[8]*It+wt[12]*Lt,ut[1]=wt[1]*Tt+wt[5]*St+wt[9]*It+wt[13]*Lt,ut[2]=wt[2]*Tt+wt[6]*St+wt[10]*It+wt[14]*Lt,ut[3]=wt[3]*Tt+wt[7]*St+wt[11]*It+wt[15]*Lt,ut},wn.transformQuat=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=wt[0],Xt=wt[1],Yt=wt[2],Mi=wt[3],vr=Mi*Tt+Xt*It-Yt*St,br=Mi*St+Yt*Tt-Lt*It,Ar=Mi*It+Lt*St-Xt*Tt,Vr=-Lt*Tt-Xt*St-Yt*It;return ut[0]=vr*Mi+Vr*-Lt+br*-Yt-Ar*-Xt,ut[1]=br*Mi+Vr*-Xt+Ar*-Lt-vr*-Yt,ut[2]=Ar*Mi+Vr*-Yt+vr*-Xt-br*-Lt,ut[3]=pt[3],ut},wn.zero=function(ut){return ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=0,ut},wn.str=function(ut){return"vec4("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+")"},wn.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]},wn.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=pt[0],Xt=pt[1],Yt=pt[2],Mi=pt[3];return Math.abs(wt-Lt)<=Tn.EPSILON*Math.max(1,Math.abs(wt),Math.abs(Lt))&&Math.abs(Tt-Xt)<=Tn.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(Xt))&&Math.abs(St-Yt)<=Tn.EPSILON*Math.max(1,Math.abs(St),Math.abs(Yt))&&Math.abs(It-Mi)<=Tn.EPSILON*Math.max(1,Math.abs(It),Math.abs(Mi))},wn.forEach=wn.sqrLen=wn.len=wn.sqrDist=wn.dist=wn.div=wn.mul=wn.sub=void 0;var Tn=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==ht(ut)&&"function"!=typeof ut)return{default:ut};var wt=ft(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function ft(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(ft=function(ut){return ut?wt:pt})(ut)}function dt(){var ut=new Tn.ARRAY_TYPE(4);return Tn.ARRAY_TYPE!=Float32Array&&(ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=0),ut}function mt(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut[2]=pt[2]-wt[2],ut[3]=pt[3]-wt[3],ut}function yt(ut,pt,wt){return ut[0]=pt[0]*wt[0],ut[1]=pt[1]*wt[1],ut[2]=pt[2]*wt[2],ut[3]=pt[3]*wt[3],ut}function gt(ut,pt,wt){return ut[0]=pt[0]/wt[0],ut[1]=pt[1]/wt[1],ut[2]=pt[2]/wt[2],ut[3]=pt[3]/wt[3],ut}function xt(ut,pt){return Math.hypot(pt[0]-ut[0],pt[1]-ut[1],pt[2]-ut[2],pt[3]-ut[3])}function bt(ut,pt){var wt=pt[0]-ut[0],Tt=pt[1]-ut[1],St=pt[2]-ut[2],It=pt[3]-ut[3];return wt*wt+Tt*Tt+St*St+It*It}function vt(ut){return Math.hypot(ut[0],ut[1],ut[2],ut[3])}function _t(ut){var pt=ut[0],wt=ut[1],Tt=ut[2],St=ut[3];return pt*pt+wt*wt+Tt*Tt+St*St}wn.sub=mt,wn.mul=yt,wn.div=gt,wn.dist=xt,wn.sqrDist=bt,wn.len=vt,wn.sqrLen=_t;var En=function(){var ut=dt();return function(pt,wt,Tt,St,It,Lt){var Xt,Yt;for(wt||(wt=4),Tt||(Tt=0),Yt=St?Math.min(St*wt+Tt,pt.length):pt.length,Xt=Tt;Xt<Yt;Xt+=wt)ut[0]=pt[Xt],ut[1]=pt[Xt+1],ut[2]=pt[Xt+2],ut[3]=pt[Xt+3],It(ut,ut,Lt),pt[Xt]=ut[0],pt[Xt+1]=ut[1],pt[Xt+2]=ut[2],pt[Xt+3]=ut[3];return pt}}();function Mt(ut){return Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},Mt(ut)}wn.forEach=En,Object.defineProperty(gn,"__esModule",{value:!0}),gn.create=Pt,gn.identity=function(ut){return ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=1,ut},gn.setAxisAngle=Et,gn.getAxisAngle=function(ut,pt){var wt=2*Math.acos(pt[3]),Tt=Math.sin(wt/2);return Tt>Mn.EPSILON?(ut[0]=pt[0]/Tt,ut[1]=pt[1]/Tt,ut[2]=pt[2]/Tt):(ut[0]=1,ut[1]=0,ut[2]=0),wt},gn.getAngle=function(ut,pt){var wt=zn(ut,pt);return Math.acos(2*wt*wt-1)},gn.multiply=Bt,gn.rotateX=function(ut,pt,wt){wt*=.5;var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=Math.sin(wt),Yt=Math.cos(wt);return ut[0]=Tt*Yt+Lt*Xt,ut[1]=St*Yt+It*Xt,ut[2]=It*Yt-St*Xt,ut[3]=Lt*Yt-Tt*Xt,ut},gn.rotateY=function(ut,pt,wt){wt*=.5;var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=Math.sin(wt),Yt=Math.cos(wt);return ut[0]=Tt*Yt-It*Xt,ut[1]=St*Yt+Lt*Xt,ut[2]=It*Yt+Tt*Xt,ut[3]=Lt*Yt-St*Xt,ut},gn.rotateZ=function(ut,pt,wt){wt*=.5;var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=Math.sin(wt),Yt=Math.cos(wt);return ut[0]=Tt*Yt+St*Xt,ut[1]=St*Yt-Tt*Xt,ut[2]=It*Yt+Lt*Xt,ut[3]=Lt*Yt-It*Xt,ut},gn.calculateW=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2];return ut[0]=wt,ut[1]=Tt,ut[2]=St,ut[3]=Math.sqrt(Math.abs(1-wt*wt-Tt*Tt-St*St)),ut},gn.exp=Dt,gn.ln=Ct,gn.pow=function(ut,pt,wt){return Ct(ut,pt),Pn(ut,ut,wt),Dt(ut,ut),ut},gn.slerp=Rt,gn.random=function(ut){var pt=Mn.RANDOM(),wt=Mn.RANDOM(),Tt=Mn.RANDOM(),St=Math.sqrt(1-pt),It=Math.sqrt(pt);return ut[0]=St*Math.sin(2*Math.PI*wt),ut[1]=St*Math.cos(2*Math.PI*wt),ut[2]=It*Math.sin(2*Math.PI*Tt),ut[3]=It*Math.cos(2*Math.PI*Tt),ut},gn.invert=function(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=wt*wt+Tt*Tt+St*St+It*It,Xt=Lt?1/Lt:0;return ut[0]=-wt*Xt,ut[1]=-Tt*Xt,ut[2]=-St*Xt,ut[3]=It*Xt,ut},gn.conjugate=function(ut,pt){return ut[0]=-pt[0],ut[1]=-pt[1],ut[2]=-pt[2],ut[3]=pt[3],ut},gn.fromMat3=Vt,gn.fromEuler=function(ut,pt,wt,Tt){var St=.5*Math.PI/180;pt*=St,wt*=St,Tt*=St;var It=Math.sin(pt),Lt=Math.cos(pt),Xt=Math.sin(wt),Yt=Math.cos(wt),Mi=Math.sin(Tt),vr=Math.cos(Tt);return ut[0]=It*Yt*vr-Lt*Xt*Mi,ut[1]=Lt*Xt*vr+It*Yt*Mi,ut[2]=Lt*Yt*Mi-It*Xt*vr,ut[3]=Lt*Yt*vr+It*Xt*Mi,ut},gn.str=function(ut){return"quat("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+")"},gn.setAxes=gn.sqlerp=gn.rotationTo=gn.equals=gn.exactEquals=gn.normalize=gn.sqrLen=gn.squaredLength=gn.len=gn.length=gn.lerp=gn.dot=gn.scale=gn.mul=gn.add=gn.set=gn.copy=gn.fromValues=gn.clone=void 0;var Mn=zt(Mi),Sn=zt(cn),An=zt(yn),In=zt(wn);function kt(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(kt=function(ut){return ut?wt:pt})(ut)}function zt(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==Mt(ut)&&"function"!=typeof ut)return{default:ut};var wt=kt(pt);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}function Pt(){var ut=new Mn.ARRAY_TYPE(4);return Mn.ARRAY_TYPE!=Float32Array&&(ut[0]=0,ut[1]=0,ut[2]=0),ut[3]=1,ut}function Et(ut,pt,wt){wt*=.5;var Tt=Math.sin(wt);return ut[0]=Tt*pt[0],ut[1]=Tt*pt[1],ut[2]=Tt*pt[2],ut[3]=Math.cos(wt),ut}function Bt(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=wt[0],Yt=wt[1],Mi=wt[2],vr=wt[3];return ut[0]=Tt*vr+Lt*Xt+St*Mi-It*Yt,ut[1]=St*vr+Lt*Yt+It*Xt-Tt*Mi,ut[2]=It*vr+Lt*Mi+Tt*Yt-St*Xt,ut[3]=Lt*vr-Tt*Xt-St*Yt-It*Mi,ut}function Dt(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=Math.sqrt(wt*wt+Tt*Tt+St*St),Xt=Math.exp(It),Yt=Lt>0?Xt*Math.sin(Lt)/Lt:0;return ut[0]=wt*Yt,ut[1]=Tt*Yt,ut[2]=St*Yt,ut[3]=Xt*Math.cos(Lt),ut}function Ct(ut,pt){var wt=pt[0],Tt=pt[1],St=pt[2],It=pt[3],Lt=Math.sqrt(wt*wt+Tt*Tt+St*St),Xt=Lt>0?Math.atan2(Lt,It)/Lt:0;return ut[0]=wt*Xt,ut[1]=Tt*Xt,ut[2]=St*Xt,ut[3]=.5*Math.log(wt*wt+Tt*Tt+St*St+It*It),ut}function Rt(ut,pt,wt,Tt){var St,It,Lt,Xt,Yt,Mi=pt[0],vr=pt[1],br=pt[2],Ar=pt[3],Vr=wt[0],nn=wt[1],sn=wt[2],an=wt[3];return(It=Mi*Vr+vr*nn+br*sn+Ar*an)<0&&(It=-It,Vr=-Vr,nn=-nn,sn=-sn,an=-an),1-It>Mn.EPSILON?(St=Math.acos(It),Lt=Math.sin(St),Xt=Math.sin((1-Tt)*St)/Lt,Yt=Math.sin(Tt*St)/Lt):(Xt=1-Tt,Yt=Tt),ut[0]=Xt*Mi+Yt*Vr,ut[1]=Xt*vr+Yt*nn,ut[2]=Xt*br+Yt*sn,ut[3]=Xt*Ar+Yt*an,ut}function Vt(ut,pt){var wt,Tt=pt[0]+pt[4]+pt[8];if(Tt>0)wt=Math.sqrt(Tt+1),ut[3]=.5*wt,ut[0]=(pt[5]-pt[7])*(wt=.5/wt),ut[1]=(pt[6]-pt[2])*wt,ut[2]=(pt[1]-pt[3])*wt;else{var St=0;pt[4]>pt[0]&&(St=1),pt[8]>pt[3*St+St]&&(St=2);var It=(St+1)%3,Lt=(St+2)%3;wt=Math.sqrt(pt[3*St+St]-pt[3*It+It]-pt[3*Lt+Lt]+1),ut[St]=.5*wt,ut[3]=(pt[3*It+Lt]-pt[3*Lt+It])*(wt=.5/wt),ut[It]=(pt[3*It+St]+pt[3*St+It])*wt,ut[Lt]=(pt[3*Lt+St]+pt[3*St+Lt])*wt}return ut}gn.clone=In.clone,gn.fromValues=In.fromValues,gn.copy=In.copy,gn.set=In.set,gn.add=In.add,gn.mul=Bt;var Pn=In.scale;gn.scale=Pn;var zn=In.dot;gn.dot=zn,gn.lerp=In.lerp;var Ln=In.length;gn.length=Ln,gn.len=Ln;var kn=In.squaredLength;gn.squaredLength=kn,gn.sqrLen=kn;var Bn=In.normalize;gn.normalize=Bn,gn.exactEquals=In.exactEquals,gn.equals=In.equals;var Wn,Yn,Jn,Qn=(Wn=An.create(),Yn=An.fromValues(1,0,0),Jn=An.fromValues(0,1,0),function(ut,pt,wt){var Tt=An.dot(pt,wt);return Tt<-.999999?(An.cross(Wn,Yn,pt),An.len(Wn)<1e-6&&An.cross(Wn,Jn,pt),An.normalize(Wn,Wn),Et(ut,Wn,Math.PI),ut):Tt>.999999?(ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=1,ut):(An.cross(Wn,pt,wt),ut[0]=Wn[0],ut[1]=Wn[1],ut[2]=Wn[2],ut[3]=1+Tt,Bn(ut,ut))});gn.rotationTo=Qn;var bo,ko,No=(bo=Pt(),ko=Pt(),function(ut,pt,wt,Tt,St,It){return Rt(bo,pt,St,It),Rt(ko,wt,Tt,It),Rt(ut,bo,ko,2*It*(1-It)),ut});gn.sqlerp=No;var Js,ua=(Js=Sn.create(),function(ut,pt,wt,Tt){return Js[0]=wt[0],Js[3]=wt[1],Js[6]=wt[2],Js[1]=Tt[0],Js[4]=Tt[1],Js[7]=Tt[2],Js[2]=-pt[0],Js[5]=-pt[1],Js[8]=-pt[2],Bn(ut,Vt(ut,Js))});gn.setAxes=ua;var ga={};function Jt(ut){return Jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},Jt(ut)}Object.defineProperty(ga,"__esModule",{value:!0}),ga.create=function(){var ut=new xa.ARRAY_TYPE(8);return xa.ARRAY_TYPE!=Float32Array&&(ut[0]=0,ut[1]=0,ut[2]=0,ut[4]=0,ut[5]=0,ut[6]=0,ut[7]=0),ut[3]=1,ut},ga.clone=function(ut){var pt=new xa.ARRAY_TYPE(8);return pt[0]=ut[0],pt[1]=ut[1],pt[2]=ut[2],pt[3]=ut[3],pt[4]=ut[4],pt[5]=ut[5],pt[6]=ut[6],pt[7]=ut[7],pt},ga.fromValues=function(ut,pt,wt,Tt,St,It,Lt,Xt){var Yt=new xa.ARRAY_TYPE(8);return Yt[0]=ut,Yt[1]=pt,Yt[2]=wt,Yt[3]=Tt,Yt[4]=St,Yt[5]=It,Yt[6]=Lt,Yt[7]=Xt,Yt},ga.fromRotationTranslationValues=function(ut,pt,wt,Tt,St,It,Lt){var Xt=new xa.ARRAY_TYPE(8);Xt[0]=ut,Xt[1]=pt,Xt[2]=wt,Xt[3]=Tt;var Yt=.5*St,Mi=.5*It,vr=.5*Lt;return Xt[4]=Yt*Tt+Mi*wt-vr*pt,Xt[5]=Mi*Tt+vr*ut-Yt*wt,Xt[6]=vr*Tt+Yt*pt-Mi*ut,Xt[7]=-Yt*ut-Mi*pt-vr*wt,Xt},ga.fromRotationTranslation=ie,ga.fromTranslation=function(ut,pt){return ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=1,ut[4]=.5*pt[0],ut[5]=.5*pt[1],ut[6]=.5*pt[2],ut[7]=0,ut},ga.fromRotation=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[4]=0,ut[5]=0,ut[6]=0,ut[7]=0,ut},ga.fromMat4=function(ut,pt){var wt=Ra.create();Da.getRotation(wt,pt);var Tt=new xa.ARRAY_TYPE(3);return Da.getTranslation(Tt,pt),ie(ut,wt,Tt),ut},ga.copy=se,ga.identity=function(ut){return ut[0]=0,ut[1]=0,ut[2]=0,ut[3]=1,ut[4]=0,ut[5]=0,ut[6]=0,ut[7]=0,ut},ga.set=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){return ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=St,ut[4]=It,ut[5]=Lt,ut[6]=Xt,ut[7]=Yt,ut},ga.getDual=function(ut,pt){return ut[0]=pt[4],ut[1]=pt[5],ut[2]=pt[6],ut[3]=pt[7],ut},ga.setDual=function(ut,pt){return ut[4]=pt[0],ut[5]=pt[1],ut[6]=pt[2],ut[7]=pt[3],ut},ga.getTranslation=function(ut,pt){var wt=pt[4],Tt=pt[5],St=pt[6],It=pt[7],Lt=-pt[0],Xt=-pt[1],Yt=-pt[2],Mi=pt[3];return ut[0]=2*(wt*Mi+It*Lt+Tt*Yt-St*Xt),ut[1]=2*(Tt*Mi+It*Xt+St*Lt-wt*Yt),ut[2]=2*(St*Mi+It*Yt+wt*Xt-Tt*Lt),ut},ga.translate=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=.5*wt[0],Yt=.5*wt[1],Mi=.5*wt[2],vr=pt[4],br=pt[5],Ar=pt[6],Vr=pt[7];return ut[0]=Tt,ut[1]=St,ut[2]=It,ut[3]=Lt,ut[4]=Lt*Xt+St*Mi-It*Yt+vr,ut[5]=Lt*Yt+It*Xt-Tt*Mi+br,ut[6]=Lt*Mi+Tt*Yt-St*Xt+Ar,ut[7]=-Tt*Xt-St*Yt-It*Mi+Vr,ut},ga.rotateX=function(ut,pt,wt){var Tt=-pt[0],St=-pt[1],It=-pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=Xt*Lt+vr*Tt+Yt*It-Mi*St,Ar=Yt*Lt+vr*St+Mi*Tt-Xt*It,Vr=Mi*Lt+vr*It+Xt*St-Yt*Tt,nn=vr*Lt-Xt*Tt-Yt*St-Mi*It;return Ra.rotateX(ut,pt,wt),ut[4]=br*(Lt=ut[3])+nn*(Tt=ut[0])+Ar*(It=ut[2])-Vr*(St=ut[1]),ut[5]=Ar*Lt+nn*St+Vr*Tt-br*It,ut[6]=Vr*Lt+nn*It+br*St-Ar*Tt,ut[7]=nn*Lt-br*Tt-Ar*St-Vr*It,ut},ga.rotateY=function(ut,pt,wt){var Tt=-pt[0],St=-pt[1],It=-pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=Xt*Lt+vr*Tt+Yt*It-Mi*St,Ar=Yt*Lt+vr*St+Mi*Tt-Xt*It,Vr=Mi*Lt+vr*It+Xt*St-Yt*Tt,nn=vr*Lt-Xt*Tt-Yt*St-Mi*It;return Ra.rotateY(ut,pt,wt),ut[4]=br*(Lt=ut[3])+nn*(Tt=ut[0])+Ar*(It=ut[2])-Vr*(St=ut[1]),ut[5]=Ar*Lt+nn*St+Vr*Tt-br*It,ut[6]=Vr*Lt+nn*It+br*St-Ar*Tt,ut[7]=nn*Lt-br*Tt-Ar*St-Vr*It,ut},ga.rotateZ=function(ut,pt,wt){var Tt=-pt[0],St=-pt[1],It=-pt[2],Lt=pt[3],Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=Xt*Lt+vr*Tt+Yt*It-Mi*St,Ar=Yt*Lt+vr*St+Mi*Tt-Xt*It,Vr=Mi*Lt+vr*It+Xt*St-Yt*Tt,nn=vr*Lt-Xt*Tt-Yt*St-Mi*It;return Ra.rotateZ(ut,pt,wt),ut[4]=br*(Lt=ut[3])+nn*(Tt=ut[0])+Ar*(It=ut[2])-Vr*(St=ut[1]),ut[5]=Ar*Lt+nn*St+Vr*Tt-br*It,ut[6]=Vr*Lt+nn*It+br*St-Ar*Tt,ut[7]=nn*Lt-br*Tt-Ar*St-Vr*It,ut},ga.rotateByQuatAppend=function(ut,pt,wt){var Tt=wt[0],St=wt[1],It=wt[2],Lt=wt[3],Xt=pt[0],Yt=pt[1],Mi=pt[2],vr=pt[3];return ut[0]=Xt*Lt+vr*Tt+Yt*It-Mi*St,ut[1]=Yt*Lt+vr*St+Mi*Tt-Xt*It,ut[2]=Mi*Lt+vr*It+Xt*St-Yt*Tt,ut[3]=vr*Lt-Xt*Tt-Yt*St-Mi*It,ut[4]=(Xt=pt[4])*Lt+(vr=pt[7])*Tt+(Yt=pt[5])*It-(Mi=pt[6])*St,ut[5]=Yt*Lt+vr*St+Mi*Tt-Xt*It,ut[6]=Mi*Lt+vr*It+Xt*St-Yt*Tt,ut[7]=vr*Lt-Xt*Tt-Yt*St-Mi*It,ut},ga.rotateByQuatPrepend=function(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=wt[0],Yt=wt[1],Mi=wt[2],vr=wt[3];return ut[0]=Tt*vr+Lt*Xt+St*Mi-It*Yt,ut[1]=St*vr+Lt*Yt+It*Xt-Tt*Mi,ut[2]=It*vr+Lt*Mi+Tt*Yt-St*Xt,ut[3]=Lt*vr-Tt*Xt-St*Yt-It*Mi,ut[4]=Tt*(vr=wt[7])+Lt*(Xt=wt[4])+St*(Mi=wt[6])-It*(Yt=wt[5]),ut[5]=St*vr+Lt*Yt+It*Xt-Tt*Mi,ut[6]=It*vr+Lt*Mi+Tt*Yt-St*Xt,ut[7]=Lt*vr-Tt*Xt-St*Yt-It*Mi,ut},ga.rotateAroundAxis=function(ut,pt,wt,Tt){if(Math.abs(Tt)<xa.EPSILON)return se(ut,pt);var St=Math.hypot(wt[0],wt[1],wt[2]);Tt*=.5;var It=Math.sin(Tt),Lt=It*wt[0]/St,Xt=It*wt[1]/St,Yt=It*wt[2]/St,Mi=Math.cos(Tt),vr=pt[0],br=pt[1],Ar=pt[2],Vr=pt[3];ut[0]=vr*Mi+Vr*Lt+br*Yt-Ar*Xt,ut[1]=br*Mi+Vr*Xt+Ar*Lt-vr*Yt,ut[2]=Ar*Mi+Vr*Yt+vr*Xt-br*Lt,ut[3]=Vr*Mi-vr*Lt-br*Xt-Ar*Yt;var nn=pt[4],sn=pt[5],an=pt[6],ln=pt[7];return ut[4]=nn*Mi+ln*Lt+sn*Yt-an*Xt,ut[5]=sn*Mi+ln*Xt+an*Lt-nn*Yt,ut[6]=an*Mi+ln*Yt+nn*Xt-sn*Lt,ut[7]=ln*Mi-nn*Lt-sn*Xt-an*Yt,ut},ga.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut[2]=pt[2]+wt[2],ut[3]=pt[3]+wt[3],ut[4]=pt[4]+wt[4],ut[5]=pt[5]+wt[5],ut[6]=pt[6]+wt[6],ut[7]=pt[7]+wt[7],ut},ga.multiply=ae,ga.scale=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut[2]=pt[2]*wt,ut[3]=pt[3]*wt,ut[4]=pt[4]*wt,ut[5]=pt[5]*wt,ut[6]=pt[6]*wt,ut[7]=pt[7]*wt,ut},ga.lerp=function(ut,pt,wt,Tt){var St=1-Tt;return ll(pt,wt)<0&&(Tt=-Tt),ut[0]=pt[0]*St+wt[0]*Tt,ut[1]=pt[1]*St+wt[1]*Tt,ut[2]=pt[2]*St+wt[2]*Tt,ut[3]=pt[3]*St+wt[3]*Tt,ut[4]=pt[4]*St+wt[4]*Tt,ut[5]=pt[5]*St+wt[5]*Tt,ut[6]=pt[6]*St+wt[6]*Tt,ut[7]=pt[7]*St+wt[7]*Tt,ut},ga.invert=function(ut,pt){var wt=Tl(pt);return ut[0]=-pt[0]/wt,ut[1]=-pt[1]/wt,ut[2]=-pt[2]/wt,ut[3]=pt[3]/wt,ut[4]=-pt[4]/wt,ut[5]=-pt[5]/wt,ut[6]=-pt[6]/wt,ut[7]=pt[7]/wt,ut},ga.conjugate=function(ut,pt){return ut[0]=-pt[0],ut[1]=-pt[1],ut[2]=-pt[2],ut[3]=pt[3],ut[4]=-pt[4],ut[5]=-pt[5],ut[6]=-pt[6],ut[7]=pt[7],ut},ga.normalize=function(ut,pt){var wt=Tl(pt);if(wt>0){wt=Math.sqrt(wt);var Tt=pt[0]/wt,St=pt[1]/wt,It=pt[2]/wt,Lt=pt[3]/wt,Xt=pt[4],Yt=pt[5],Mi=pt[6],vr=pt[7],br=Tt*Xt+St*Yt+It*Mi+Lt*vr;ut[0]=Tt,ut[1]=St,ut[2]=It,ut[3]=Lt,ut[4]=(Xt-Tt*br)/wt,ut[5]=(Yt-St*br)/wt,ut[6]=(Mi-It*br)/wt,ut[7]=(vr-Lt*br)/wt}return ut},ga.str=function(ut){return"quat2("+ut[0]+", "+ut[1]+", "+ut[2]+", "+ut[3]+", "+ut[4]+", "+ut[5]+", "+ut[6]+", "+ut[7]+")"},ga.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]&&ut[2]===pt[2]&&ut[3]===pt[3]&&ut[4]===pt[4]&&ut[5]===pt[5]&&ut[6]===pt[6]&&ut[7]===pt[7]},ga.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=ut[2],It=ut[3],Lt=ut[4],Xt=ut[5],Yt=ut[6],Mi=ut[7],vr=pt[0],br=pt[1],Ar=pt[2],Vr=pt[3],nn=pt[4],sn=pt[5],an=pt[6],ln=pt[7];return Math.abs(wt-vr)<=xa.EPSILON*Math.max(1,Math.abs(wt),Math.abs(vr))&&Math.abs(Tt-br)<=xa.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(br))&&Math.abs(St-Ar)<=xa.EPSILON*Math.max(1,Math.abs(St),Math.abs(Ar))&&Math.abs(It-Vr)<=xa.EPSILON*Math.max(1,Math.abs(It),Math.abs(Vr))&&Math.abs(Lt-nn)<=xa.EPSILON*Math.max(1,Math.abs(Lt),Math.abs(nn))&&Math.abs(Xt-sn)<=xa.EPSILON*Math.max(1,Math.abs(Xt),Math.abs(sn))&&Math.abs(Yt-an)<=xa.EPSILON*Math.max(1,Math.abs(Yt),Math.abs(an))&&Math.abs(Mi-ln)<=xa.EPSILON*Math.max(1,Math.abs(Mi),Math.abs(ln))},ga.sqrLen=ga.squaredLength=ga.len=ga.length=ga.dot=ga.mul=ga.setReal=ga.getReal=void 0;var xa=ne(Mi),Ra=ne(gn),Da=ne(fn);function re(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(re=function(ut){return ut?wt:pt})(ut)}function ne(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==Jt(ut)&&"function"!=typeof ut)return{default:ut};var wt=re(pt);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}function ie(ut,pt,wt){var Tt=.5*wt[0],St=.5*wt[1],It=.5*wt[2],Lt=pt[0],Xt=pt[1],Yt=pt[2],Mi=pt[3];return ut[0]=Lt,ut[1]=Xt,ut[2]=Yt,ut[3]=Mi,ut[4]=Tt*Mi+St*Yt-It*Xt,ut[5]=St*Mi+It*Lt-Tt*Yt,ut[6]=It*Mi+Tt*Xt-St*Lt,ut[7]=-Tt*Lt-St*Xt-It*Yt,ut}function se(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut[2]=pt[2],ut[3]=pt[3],ut[4]=pt[4],ut[5]=pt[5],ut[6]=pt[6],ut[7]=pt[7],ut}function ae(ut,pt,wt){var Tt=pt[0],St=pt[1],It=pt[2],Lt=pt[3],Xt=wt[4],Yt=wt[5],Mi=wt[6],vr=wt[7],br=pt[4],Ar=pt[5],Vr=pt[6],nn=pt[7],sn=wt[0],an=wt[1],ln=wt[2],cn=wt[3];return ut[0]=Tt*cn+Lt*sn+St*ln-It*an,ut[1]=St*cn+Lt*an+It*sn-Tt*ln,ut[2]=It*cn+Lt*ln+Tt*an-St*sn,ut[3]=Lt*cn-Tt*sn-St*an-It*ln,ut[4]=Tt*vr+Lt*Xt+St*Mi-It*Yt+br*cn+nn*sn+Ar*ln-Vr*an,ut[5]=St*vr+Lt*Yt+It*Xt-Tt*Mi+Ar*cn+nn*an+Vr*sn-br*ln,ut[6]=It*vr+Lt*Mi+Tt*Yt-St*Xt+Vr*cn+nn*ln+br*an-Ar*sn,ut[7]=Lt*vr-Tt*Xt-St*Yt-It*Mi+nn*cn-br*sn-Ar*an-Vr*ln,ut}ga.getReal=Ra.copy,ga.setReal=Ra.copy,ga.mul=ae;var ll=Ra.dot;ga.dot=ll;var yl=Ra.length;ga.length=yl,ga.len=yl;var Tl=Ra.squaredLength;ga.squaredLength=Tl,ga.sqrLen=Tl;var Al={};function he(ut){return he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},he(ut)}Object.defineProperty(Al,"__esModule",{value:!0}),Al.create=de,Al.clone=function(ut){var pt=new Il.ARRAY_TYPE(2);return pt[0]=ut[0],pt[1]=ut[1],pt},Al.fromValues=function(ut,pt){var wt=new Il.ARRAY_TYPE(2);return wt[0]=ut,wt[1]=pt,wt},Al.copy=function(ut,pt){return ut[0]=pt[0],ut[1]=pt[1],ut},Al.set=function(ut,pt,wt){return ut[0]=pt,ut[1]=wt,ut},Al.add=function(ut,pt,wt){return ut[0]=pt[0]+wt[0],ut[1]=pt[1]+wt[1],ut},Al.subtract=me,Al.multiply=ye,Al.divide=ge,Al.ceil=function(ut,pt){return ut[0]=Math.ceil(pt[0]),ut[1]=Math.ceil(pt[1]),ut},Al.floor=function(ut,pt){return ut[0]=Math.floor(pt[0]),ut[1]=Math.floor(pt[1]),ut},Al.min=function(ut,pt,wt){return ut[0]=Math.min(pt[0],wt[0]),ut[1]=Math.min(pt[1],wt[1]),ut},Al.max=function(ut,pt,wt){return ut[0]=Math.max(pt[0],wt[0]),ut[1]=Math.max(pt[1],wt[1]),ut},Al.round=function(ut,pt){return ut[0]=Math.round(pt[0]),ut[1]=Math.round(pt[1]),ut},Al.scale=function(ut,pt,wt){return ut[0]=pt[0]*wt,ut[1]=pt[1]*wt,ut},Al.scaleAndAdd=function(ut,pt,wt,Tt){return ut[0]=pt[0]+wt[0]*Tt,ut[1]=pt[1]+wt[1]*Tt,ut},Al.distance=xe,Al.squaredDistance=be,Al.length=ve,Al.squaredLength=_e,Al.negate=function(ut,pt){return ut[0]=-pt[0],ut[1]=-pt[1],ut},Al.inverse=function(ut,pt){return ut[0]=1/pt[0],ut[1]=1/pt[1],ut},Al.normalize=function(ut,pt){var wt=pt[0],Tt=pt[1],St=wt*wt+Tt*Tt;return St>0&&(St=1/Math.sqrt(St)),ut[0]=pt[0]*St,ut[1]=pt[1]*St,ut},Al.dot=function(ut,pt){return ut[0]*pt[0]+ut[1]*pt[1]},Al.cross=function(ut,pt,wt){var Tt=pt[0]*wt[1]-pt[1]*wt[0];return ut[0]=ut[1]=0,ut[2]=Tt,ut},Al.lerp=function(ut,pt,wt,Tt){var St=pt[0],It=pt[1];return ut[0]=St+Tt*(wt[0]-St),ut[1]=It+Tt*(wt[1]-It),ut},Al.random=function(ut,pt){pt=pt||1;var wt=2*Il.RANDOM()*Math.PI;return ut[0]=Math.cos(wt)*pt,ut[1]=Math.sin(wt)*pt,ut},Al.transformMat2=function(ut,pt,wt){var Tt=pt[0],St=pt[1];return ut[0]=wt[0]*Tt+wt[2]*St,ut[1]=wt[1]*Tt+wt[3]*St,ut},Al.transformMat2d=function(ut,pt,wt){var Tt=pt[0],St=pt[1];return ut[0]=wt[0]*Tt+wt[2]*St+wt[4],ut[1]=wt[1]*Tt+wt[3]*St+wt[5],ut},Al.transformMat3=function(ut,pt,wt){var Tt=pt[0],St=pt[1];return ut[0]=wt[0]*Tt+wt[3]*St+wt[6],ut[1]=wt[1]*Tt+wt[4]*St+wt[7],ut},Al.transformMat4=function(ut,pt,wt){var Tt=pt[0],St=pt[1];return ut[0]=wt[0]*Tt+wt[4]*St+wt[12],ut[1]=wt[1]*Tt+wt[5]*St+wt[13],ut},Al.rotate=function(ut,pt,wt,Tt){var St=pt[0]-wt[0],It=pt[1]-wt[1],Lt=Math.sin(Tt),Xt=Math.cos(Tt);return ut[0]=St*Xt-It*Lt+wt[0],ut[1]=St*Lt+It*Xt+wt[1],ut},Al.angle=function(ut,pt){var wt=ut[0],Tt=ut[1],St=pt[0],It=pt[1],Lt=Math.sqrt(wt*wt+Tt*Tt)*Math.sqrt(St*St+It*It);return Math.acos(Math.min(Math.max(Lt&&(wt*St+Tt*It)/Lt,-1),1))},Al.zero=function(ut){return ut[0]=0,ut[1]=0,ut},Al.str=function(ut){return"vec2("+ut[0]+", "+ut[1]+")"},Al.exactEquals=function(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]},Al.equals=function(ut,pt){var wt=ut[0],Tt=ut[1],St=pt[0],It=pt[1];return Math.abs(wt-St)<=Il.EPSILON*Math.max(1,Math.abs(wt),Math.abs(St))&&Math.abs(Tt-It)<=Il.EPSILON*Math.max(1,Math.abs(Tt),Math.abs(It))},Al.forEach=Al.sqrLen=Al.sqrDist=Al.dist=Al.div=Al.mul=Al.sub=Al.len=void 0;var Il=function(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==he(ut)&&"function"!=typeof ut)return{default:ut};var wt=fe(void 0);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}(Mi);function fe(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(fe=function(ut){return ut?wt:pt})(ut)}function de(){var ut=new Il.ARRAY_TYPE(2);return Il.ARRAY_TYPE!=Float32Array&&(ut[0]=0,ut[1]=0),ut}function me(ut,pt,wt){return ut[0]=pt[0]-wt[0],ut[1]=pt[1]-wt[1],ut}function ye(ut,pt,wt){return ut[0]=pt[0]*wt[0],ut[1]=pt[1]*wt[1],ut}function ge(ut,pt,wt){return ut[0]=pt[0]/wt[0],ut[1]=pt[1]/wt[1],ut}function xe(ut,pt){return Math.hypot(pt[0]-ut[0],pt[1]-ut[1])}function be(ut,pt){var wt=pt[0]-ut[0],Tt=pt[1]-ut[1];return wt*wt+Tt*Tt}function ve(ut){return Math.hypot(ut[0],ut[1])}function _e(ut){var pt=ut[0],wt=ut[1];return pt*pt+wt*wt}Al.len=ve,Al.sub=me,Al.mul=ye,Al.div=ge,Al.dist=xe,Al.sqrDist=be,Al.sqrLen=_e;var zl=function(){var ut=de();return function(pt,wt,Tt,St,It,Lt){var Xt,Yt;for(wt||(wt=2),Tt||(Tt=0),Yt=St?Math.min(St*wt+Tt,pt.length):pt.length,Xt=Tt;Xt<Yt;Xt+=wt)ut[0]=pt[Xt],ut[1]=pt[Xt+1],It(ut,ut,Lt),pt[Xt]=ut[0],pt[Xt+1]=ut[1];return pt}}();function Me(ut){return Me="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ut){return typeof ut}:function(ut){return ut&&"function"==typeof Symbol&&ut.constructor===Symbol&&ut!==Symbol.prototype?"symbol":typeof ut},Me(ut)}Al.forEach=zl,Object.defineProperty(Yt,"__esModule",{value:!0}),ut.aA=Yt.vec4=ut._=Yt.vec3=Yt.vec2=Yt.quat2=ut.av=Yt.quat=ut.ad=Yt.mat4=ut.bC=Yt.mat3=Yt.mat2d=ut.aC=Yt.mat2=Yt.glMatrix=void 0;var ec=Re(Mi);Yt.glMatrix=ec;var tc=Re(nn);ut.aC=Yt.mat2=tc;var ic=Re(an);Yt.mat2d=ic;var nc=Re(cn);ut.bC=Yt.mat3=nc;var oc=Re(fn);ut.ad=Yt.mat4=oc;var sc=Re(gn);ut.av=Yt.quat=sc;var ac=Re(ga);Yt.quat2=ac;var lc=Re(Al);Yt.vec2=lc;var cc=Re(yn);ut._=Yt.vec3=cc;var uc=Re(wn);function Ce(ut){if("function"!=typeof WeakMap)return null;var pt=new WeakMap,wt=new WeakMap;return(Ce=function(ut){return ut?wt:pt})(ut)}function Re(ut,pt){if(ut&&ut.__esModule)return ut;if(null===ut||"object"!==Me(ut)&&"function"!=typeof ut)return{default:ut};var wt=Ce(pt);if(wt&&wt.has(ut))return wt.get(ut);var Tt={},St=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var It in ut)if("default"!==It&&Object.prototype.hasOwnProperty.call(ut,It)){var Lt=St?Object.getOwnPropertyDescriptor(ut,It):null;Lt&&(Lt.get||Lt.set)?Object.defineProperty(Tt,It,Lt):Tt[It]=ut[It]}return Tt.default=ut,wt&&wt.set(ut,Tt),Tt}ut.aA=Yt.vec4=uc;var dc=Fe;function Fe(ut,wt,Tt,St){(this||pt).cx=3*ut,(this||pt).bx=3*(Tt-ut)-(this||pt).cx,(this||pt).ax=1-(this||pt).cx-(this||pt).bx,(this||pt).cy=3*wt,(this||pt).by=3*(St-wt)-(this||pt).cy,(this||pt).ay=1-(this||pt).cy-(this||pt).by,(this||pt).p1x=ut,(this||pt).p1y=wt,(this||pt).p2x=Tt,(this||pt).p2y=St}Fe.prototype={sampleCurveX:function(ut){return(((this||pt).ax*ut+(this||pt).bx)*ut+(this||pt).cx)*ut},sampleCurveY:function(ut){return(((this||pt).ay*ut+(this||pt).by)*ut+(this||pt).cy)*ut},sampleCurveDerivativeX:function(ut){return(3*(this||pt).ax*ut+2*(this||pt).bx)*ut+(this||pt).cx},solveCurveX:function(ut,pt){if(void 0===pt&&(pt=1e-6),ut<0)return 0;if(ut>1)return 1;for(var wt=ut,Tt=0;Tt<8;Tt++){var St=this.sampleCurveX(wt)-ut;if(Math.abs(St)<pt)return wt;var It=this.sampleCurveDerivativeX(wt);if(Math.abs(It)<1e-6)break;wt-=St/It}var Lt=0,Xt=1;for(wt=ut,Tt=0;Tt<20&&(St=this.sampleCurveX(wt),!(Math.abs(St-ut)<pt));Tt++)ut>St?Lt=wt:Xt=wt,wt=.5*(Xt-Lt)+Lt;return wt},solve:function(ut,pt){return this.sampleCurveY(this.solveCurveX(ut,pt))}};var fc=p(dc),gc=Ue;function Ue(ut,wt){(this||pt).x=ut,(this||pt).y=wt}Ue.prototype={clone:function(){return new Ue((this||pt).x,(this||pt).y)},add:function(ut){return this.clone()._add(ut)},sub:function(ut){return this.clone()._sub(ut)},multByPoint:function(ut){return this.clone()._multByPoint(ut)},divByPoint:function(ut){return this.clone()._divByPoint(ut)},mult:function(ut){return this.clone()._mult(ut)},div:function(ut){return this.clone()._div(ut)},rotate:function(ut){return this.clone()._rotate(ut)},rotateAround:function(ut,pt){return this.clone()._rotateAround(ut,pt)},matMult:function(ut){return this.clone()._matMult(ut)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||pt).x*(this||pt).x+(this||pt).y*(this||pt).y)},equals:function(ut){return(this||pt).x===ut.x&&(this||pt).y===ut.y},dist:function(ut){return Math.sqrt(this.distSqr(ut))},distSqr:function(ut){var wt=ut.x-(this||pt).x,Tt=ut.y-(this||pt).y;return wt*wt+Tt*Tt},angle:function(){return Math.atan2((this||pt).y,(this||pt).x)},angleTo:function(ut){return Math.atan2((this||pt).y-ut.y,(this||pt).x-ut.x)},angleWith:function(ut){return this.angleWithSep(ut.x,ut.y)},angleWithSep:function(ut,wt){return Math.atan2((this||pt).x*wt-(this||pt).y*ut,(this||pt).x*ut+(this||pt).y*wt)},_matMult:function(ut){var wt=ut[2]*(this||pt).x+ut[3]*(this||pt).y;return(this||pt).x=ut[0]*(this||pt).x+ut[1]*(this||pt).y,(this||pt).y=wt,this||pt},_add:function(ut){return(this||pt).x+=ut.x,(this||pt).y+=ut.y,this||pt},_sub:function(ut){return(this||pt).x-=ut.x,(this||pt).y-=ut.y,this||pt},_mult:function(ut){return(this||pt).x*=ut,(this||pt).y*=ut,this||pt},_div:function(ut){return(this||pt).x/=ut,(this||pt).y/=ut,this||pt},_multByPoint:function(ut){return(this||pt).x*=ut.x,(this||pt).y*=ut.y,this||pt},_divByPoint:function(ut){return(this||pt).x/=ut.x,(this||pt).y/=ut.y,this||pt},_unit:function(){return this._div(this.mag()),this||pt},_perp:function(){var ut=(this||pt).y;return(this||pt).y=(this||pt).x,(this||pt).x=-ut,this||pt},_rotate:function(ut){var wt=Math.cos(ut),Tt=Math.sin(ut),St=Tt*(this||pt).x+wt*(this||pt).y;return(this||pt).x=wt*(this||pt).x-Tt*(this||pt).y,(this||pt).y=St,this||pt},_rotateAround:function(ut,wt){var Tt=Math.cos(ut),St=Math.sin(ut),It=wt.y+St*((this||pt).x-wt.x)+Tt*((this||pt).y-wt.y);return(this||pt).x=wt.x+Tt*((this||pt).x-wt.x)-St*((this||pt).y-wt.y),(this||pt).y=It,this||pt},_round:function(){return(this||pt).x=Math.round((this||pt).x),(this||pt).y=Math.round((this||pt).y),this||pt}},Ue.convert=function(ut){return ut instanceof Ue?ut:Array.isArray(ut)?new Ue(ut[0],ut[1]):ut};var xc=p(gc);const Mc=Math.PI/180,Sc=180/Math.PI;function $e(ut){return ut*Mc}function Ge(ut){return ut*Sc}const Ac=[[0,0],[1,0],[1,1],[0,1]];function Ye(ut){if(ut<=0)return 0;if(ut>=1)return 1;const pt=ut*ut,wt=pt*ut;return 4*(ut<.5?wt:3*(ut-pt)+wt-.75)}function Ze(ut,pt,wt,Tt){const St=new fc(ut,pt,wt,Tt);return function(ut){return St.solve(ut)}}const Dc=Ze(.25,.1,.25,1);function Ke(ut,pt,wt){return Math.min(wt,Math.max(pt,ut))}function We(ut,pt,wt){return(wt=Ke((wt-ut)/(pt-ut),0,1))*wt*(3-2*wt)}function Je(ut,pt,wt){const Tt=wt-pt,St=((ut-pt)%Tt+Tt)%Tt+pt;return St===pt?wt:St}function Qe(ut,pt,wt){if(!ut.length)return wt(null,[]);let Tt=ut.length;const St=new Array(ut.length);let It=null;ut.forEach(((ut,Lt)=>{pt(ut,((ut,pt)=>{ut&&(It=ut),St[Lt]=pt,0==--Tt&&wt(It,St)}))}))}function tr(ut){const pt=[];for(const wt in ut)pt.push(ut[wt]);return pt}function er(ut,...pt){for(const wt of pt)for(const pt in wt)ut[pt]=wt[pt];return ut}let qc=1;function nr(){return qc++}function ir(){return function t(ut){return ut?(ut^Math.random()*(16>>ut/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function sr(ut){return ut<=1?1:Math.pow(2,Math.ceil(Math.log(ut)/Math.LN2))}function ar(ut){return!!ut&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(ut)}function or(ut,pt){ut.forEach((ut=>{pt[ut]&&(pt[ut]=pt[ut].bind(pt))}))}function lr(ut,pt){return-1!==ut.indexOf(pt,ut.length-pt.length)}function ur(ut,wt,Tt){const St={};for(const Tt in ut)St[Tt]=wt.call(this||pt,ut[Tt],Tt,ut);return St}function cr(ut,wt,Tt){const St={};for(const Tt in ut)wt.call(this||pt,ut[Tt],Tt,ut)&&(St[Tt]=ut[Tt]);return St}function hr(ut){return Array.isArray(ut)?ut.map(hr):"object"==typeof ut&&ut?ur(ut,hr):ut}const $c={};function fr(ut){$c[ut]||("undefined"!=typeof console&&console.warn(ut),$c[ut]=!0)}function dr(ut,pt,wt){return(wt.y-ut.y)*(pt.x-ut.x)>(pt.y-ut.y)*(wt.x-ut.x)}function mr(ut){let pt=0;for(let wt,Tt,St=0,It=ut.length,Lt=It-1;St<It;Lt=St++)wt=ut[St],Tt=ut[Lt],pt+=(Tt.x-wt.x)*(wt.y+Tt.y);return pt}function yr([ut,pt,wt]){const Tt=$e(pt+90),St=$e(wt);return{x:ut*Math.cos(Tt)*Math.sin(St),y:ut*Math.sin(Tt)*Math.sin(St),z:ut*Math.cos(St),azimuthal:pt,polar:wt}}function gr(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function xr(ut){const pt={};if(ut.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((ut,wt,Tt,St)=>{const It=Tt||St;return pt[wt]=!It||It.toLowerCase(),""})),pt["max-age"]){const ut=parseInt(pt["max-age"],10);isNaN(ut)?delete pt["max-age"]:pt["max-age"]=ut}return pt}let wu,Tu,Mu,Iu,Ou,Nu,ju=null;function Ir(ut){try{const pt=self[ut];return pt.setItem("_mapbox_test_",1),pt.removeItem("_mapbox_test_"),!0}catch(ut){return!1}}function Tr(ut,pt){return[ut[4*pt],ut[4*pt+1],ut[4*pt+2],ut[4*pt+3]]}function kr(ut,pt,wt,Tt){for(;pt<wt;){const St=pt+wt>>1;ut[St]<Tt?pt=St+1:wt=St}return pt}function zr(ut,pt,wt,Tt){for(;pt<wt;){const St=pt+wt>>1;ut[St]<=Tt?pt=St+1:wt=St}return pt}function Pr(ut){return ut>0?1/(1.001-ut):1+ut}function Er(ut){return ut>0?1-1/(1.001-ut):-ut}function Br(){return null==wu&&(wu=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),wu}const Ju={now:()=>void 0!==Iu?Iu:performance.now(),setNow(ut){Iu=ut},restoreNow(){Iu=void 0},frame(ut){const pt=requestAnimationFrame(ut);return{cancel:()=>cancelAnimationFrame(pt)}},getImageData(ut,pt=0){const{width:wt,height:Tt}=ut;Ou||(Ou=document.createElement("canvas"));const St=Ou.getContext("2d",{willReadFrequently:!0});if(!St)throw new Error("failed to create canvas 2d context");return(wt>Ou.width||Tt>Ou.height)&&(Ou.width=wt,Ou.height=Tt),St.clearRect(-pt,-pt,wt+2*pt,Tt+2*pt),St.drawImage(ut,0,0,wt,Tt),St.getImageData(-pt,-pt,wt+2*pt,Tt+2*pt)},resolveURL:ut=>(Tu||(Tu=document.createElement("a")),Tu.href=ut,Tu.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==Mu&&(Mu=window.matchMedia("(prefers-reduced-motion: reduce)")),Mu.matches)},hasCanvasFingerprintNoise(){if(void 0!==Nu)return Nu;if(!Br())return Nu=!1,!1;const ut=new OffscreenCanvas(85,1),pt=ut.getContext("2d",{willReadFrequently:!0});let wt=0;for(let Tt=0;Tt<ut.width;++Tt)pt.fillStyle=`rgba(${wt++},${wt++},${wt++}, 255)`,pt.fillRect(Tt,0,1,1);const Tt=pt.getImageData(0,0,ut.width,ut.height);wt=0;for(let ut=0;ut<Tt.data.length;++ut)if(ut%4!=3&&wt++!==Tt.data[ut])return Nu=!0,!0;return Nu=!1,!1}};function Cr(ut,pt){const wt=ut.indexOf("?");if(wt<0)return`${ut}?${new URLSearchParams(pt).toString()}`;const Tt=new URLSearchParams(ut.slice(wt));for(const ut in pt)Tt.set(ut,pt[ut]);return`${ut.slice(0,wt)}?${Tt.toString()}`}function Rr(ut,pt={persistentParams:[]}){const wt=ut.indexOf("?");if(wt<0)return ut;const Tt=new URLSearchParams,St=new URLSearchParams(ut.slice(wt));for(const ut of pt.persistentParams){const pt=St.get(ut);pt&&Tt.set(ut,pt)}const It=Tt.toString();return`${ut.slice(0,wt)}${It.length>0?`?${It}`:""}`}const mh="mapbox-tiles";let yh=500,Th=50;let Sh,Ih;function Nr(){try{return caches}catch(ut){}}function jr(){const ut=Nr();ut&&!Sh&&(Sh=ut.open(mh))}let Ph=1/0;const kh={supported:!1,testSupport:function(ut){!Qh&&Jh&&(ed?Kr(ut):qh=ut)}};let qh,Jh,Qh=!1,ed=!1;const td="undefined"!=typeof self?self:{};function Kr(ut){const pt=ut.createTexture();ut.bindTexture(ut.TEXTURE_2D,pt);try{if(ut.texImage2D(ut.TEXTURE_2D,0,ut.RGBA,ut.RGBA,ut.UNSIGNED_BYTE,Jh),ut.isContextLost())return;kh.supported=!0}catch(ut){}ut.deleteTexture(pt),Qh=!0}td.document&&(Jh=td.document.createElement("img"),Jh.onload=function(){qh&&Kr(qh),qh=null,ed=!0},Jh.onerror=function(){Qh=!0,qh=null},Jh.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const id={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(id);class Jr extends Error{constructor(ut,pt,wt){401===pt&&i(wt)&&(ut+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(ut),this.status=pt,this.url=wt}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const rd=gr()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const tn=function(ut,pt){if(!(/^file:/.test(wt=ut.url)||/^file:/.test(rd())&&!/^\w+:/.test(wt))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(ut,pt){const wt=new AbortController,Tt=new Request(ut.url,{method:ut.method||"GET",body:ut.body,credentials:ut.credentials,headers:ut.headers,referrer:rd(),referrerPolicy:ut.referrerPolicy,signal:wt.signal});let St=!1,It=!1;const Lt=(Xt=Tt.url).indexOf("sku=")>0&&i(Xt);var Xt;"json"===ut.type&&Tt.headers.set("Accept","application/json");const u=(wt,St,Xt)=>{if(It)return;if(wt&&"SecurityError"!==wt.message&&fr(wt.toString()),St&&Xt)return c(St);const Yt=Date.now();fetch(Tt).then((wt=>{if(wt.ok){const ut=Lt?wt.clone():null;return c(wt,ut,Yt)}return pt(new Jr(wt.statusText,wt.status,ut.url))})).catch((wt=>{"AbortError"!==wt.name&&pt(new Error(`${wt.message} ${ut.url}`))}))},c=(wt,Lt,Xt)=>{("arrayBuffer"===ut.type?wt.arrayBuffer():"json"===ut.type?wt.json():wt.text()).then((ut=>{It||(Lt&&Xt&&function(ut,pt,wt){if(jr(),!Sh)return;const Tt=xr(pt.headers.get("Cache-Control")||"");if(Tt["no-store"])return;const St={status:pt.status,statusText:pt.statusText,headers:new Headers};pt.headers.forEach(((ut,pt)=>St.headers.set(pt,ut))),Tt["max-age"]&&St.headers.set("Expires",new Date(wt+1e3*Tt["max-age"]).toUTCString());const It=St.headers.get("Expires");if(!It)return;if(new Date(It).getTime()-wt<42e4)return;let Lt=Rr(ut.url,{persistentParams:["language","worldview"]});if(206===pt.status){const pt=ut.headers.get("Range");if(!pt)return;St.status=200,Lt=Cr(Lt,{range:pt})}!function(ut,pt){if(void 0===Ih)try{new Response(new ReadableStream),Ih=!0}catch(ut){Ih=!1}Ih?pt(ut.body):ut.blob().then(pt)}(pt,(ut=>{const wt=new Response(200!==(Tt=pt.status)&&404!==Tt&&[101,103,204,205,304].includes(Tt)?null:ut,St);var Tt;jr(),Sh&&Sh.then((ut=>ut.put(Lt,wt))).catch((ut=>fr(ut.message)))}))}(Tt,Lt,Xt),St=!0,pt(null,ut,wt.headers.get("Cache-Control"),wt.headers.get("Expires")))})).catch((ut=>{It||pt(new Error(ut.message))}))};return Lt?function(ut,pt){if(jr(),!Sh)return pt(null);Sh.then((wt=>{let Tt=Rr(ut.url,{persistentParams:["language","worldview"]});const St=ut.headers.get("Range");St&&(Tt=Cr(Tt,{range:St})),wt.match(Tt).then((ut=>{const St=function(ut){if(!ut)return!1;const pt=new Date(ut.headers.get("Expires")||0),wt=xr(ut.headers.get("Cache-Control")||"");return pt>Date.now()&&!wt["no-cache"]}(ut);wt.delete(Tt),St&&wt.put(Tt,ut.clone()),pt(null,ut,St)})).catch(pt)})).catch(pt)}(Tt,u):u(null,null),{cancel:()=>{It=!0,St||wt.abort()}}}(ut,pt);if(gr()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",ut,pt,void 0,!0)}var wt;return function(ut,pt){const wt=new XMLHttpRequest;wt.open(ut.method||"GET",ut.url,!0),"arrayBuffer"===ut.type&&(wt.responseType="arraybuffer");for(const pt in ut.headers)wt.setRequestHeader(pt,ut.headers[pt]);return"json"===ut.type&&(wt.responseType="text",wt.setRequestHeader("Accept","application/json")),wt.withCredentials="include"===ut.credentials,wt.onerror=()=>{pt(new Error(wt.statusText))},wt.onload=()=>{if((wt.status>=200&&wt.status<300||0===wt.status)&&null!==wt.response){let Tt=wt.response;if("json"===ut.type)try{Tt=JSON.parse(wt.response)}catch(ut){return pt(ut)}pt(null,Tt,wt.getResponseHeader("Cache-Control"),wt.getResponseHeader("Expires"))}else pt(new Jr(wt.statusText,wt.status,ut.url))},wt.send(ut.body),{cancel:()=>wt.abort()}}(ut,pt)},en=function(ut,pt){return tn(er(ut,{type:"arrayBuffer"}),pt)};function rn(ut){const pt=document.createElement("a");return pt.href=ut,pt.protocol===location.protocol&&pt.host===location.host}const nd="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let od,sd;od=[],sd=0;const on=function(ut,wt){if(kh.supported&&(ut.headers||(ut.headers={}),ut.headers.accept="image/webp,*/*"),sd>=It.MAX_PARALLEL_IMAGE_REQUESTS){const Tt={requestParameters:ut,callback:wt,cancelled:!1,cancel(){(this||pt).cancelled=!0}};return od.push(Tt),Tt}sd++;let Tt=!1;const i=()=>{if(!Tt)for(Tt=!0,sd--;od.length&&sd<It.MAX_PARALLEL_IMAGE_REQUESTS;){const ut=od.shift(),{requestParameters:pt,callback:wt,cancelled:Tt}=ut;Tt||(ut.cancel=on(pt,wt).cancel)}},St=en(ut,((ut,pt,Tt,St)=>{i(),ut?wt(ut):pt&&(self.createImageBitmap?function(ut,pt){const wt=new Blob([new Uint8Array(ut)],{type:"image/png"});createImageBitmap(wt).then((ut=>{pt(null,ut)})).catch((ut=>{pt(new Error(`Could not load image because of ${ut.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(pt,((ut,pt)=>wt(ut,pt,Tt,St))):function(ut,pt){const wt=new Image;wt.onload=()=>{pt(null,wt),URL.revokeObjectURL(wt.src),wt.onload=null,requestAnimationFrame((()=>{wt.src=nd}))},wt.onerror=()=>pt(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Tt=new Blob([new Uint8Array(ut)],{type:"image/png"});wt.src=ut.byteLength?URL.createObjectURL(Tt):nd}(pt,((ut,pt)=>wt(ut,pt,Tt,St))))}));return{cancel:()=>{St.cancel(),i()}}},ad="01",md="NO_ACCESS_TOKEN",Cd=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function hn(ut){const pt=ut.match(Cd);if(!pt)throw new Error("Unable to parse URL object");return{protocol:pt[1],authority:pt[2],path:pt[3]||"/",params:pt[4]?pt[4].split("&"):[]}}function pn(ut){const pt=ut.params.length?`?${ut.params.join("&")}`:"";return`${ut.protocol}://${ut.authority}${ut.path}${pt}`}const Pd="mapbox.eventData";function dn(ut){if(!ut)return null;const pt=ut.split(".");if(!pt||3!==pt.length)return null;try{return JSON.parse(decodeURIComponent(atob(pt[1]).split("").map((ut=>"%"+("00"+ut.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(ut){return null}}class mn{constructor(ut){this.type=ut,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(ut){const pt=dn(It.ACCESS_TOKEN);let wt="";return wt=pt&&pt.u?btoa(encodeURIComponent(pt.u).replace(/%([0-9A-F]{2})/g,((ut,pt)=>String.fromCharCode(Number("0x"+pt))))):It.ACCESS_TOKEN||"",ut?`${Pd}.${ut}:${wt}`:`${Pd}:${wt}`}fetchEventData(){const ut=Ir("localStorage"),pt=this.getStorageKey(),wt=this.getStorageKey("uuid");if(ut)try{const ut=localStorage.getItem(pt);ut&&(this.eventData=JSON.parse(ut));const Tt=localStorage.getItem(wt);Tt&&(this.anonId=Tt)}catch(ut){fr("Unable to read from LocalStorage")}}saveEventData(){const ut=Ir("localStorage"),pt=this.getStorageKey(),wt=this.getStorageKey("uuid"),Tt=this.anonId;if(ut&&Tt)try{localStorage.setItem(wt,Tt),Object.keys(this.eventData).length>=1&&localStorage.setItem(pt,JSON.stringify(this.eventData))}catch(ut){fr("Unable to write to LocalStorage")}}processRequests(ut){}postEvent(ut,pt,wt,Tt){if(!It.EVENTS_URL)return;const St=hn(It.EVENTS_URL);St.params.push(`access_token=${Tt||It.ACCESS_TOKEN||""}`);const Lt={event:this.type,created:new Date(ut).toISOString()},Xt=pt?er(Lt,pt):Lt,Yt={url:pn(St),headers:{"Content-Type":"text/plain"},body:JSON.stringify([Xt])};this.pendingRequest=function(ut,pt){return tn(er(ut,{method:"POST"}),pt)}(Yt,(ut=>{this.pendingRequest=null,wt(ut),this.saveEventData(),this.processRequests(Tt)}))}queueRequest(ut,pt){this.queue.push(ut),this.processRequests(pt)}}const zd=new class extends mn{constructor(ut){super("appUserTurnstile"),this._customAccessToken=ut}postTurnstileEvent(ut,pt){It.EVENTS_URL&&It.ACCESS_TOKEN&&Array.isArray(ut)&&ut.some((ut=>s(ut)||i(ut)))&&this.queueRequest(Date.now(),pt)}processRequests(ut){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const pt=dn(It.ACCESS_TOKEN),Tt=pt?pt.u:It.ACCESS_TOKEN;let St=Tt!==this.eventData.tokenU;ar(this.anonId)||(this.anonId=ir(),St=!0);const Lt=this.queue.shift();if(this.eventData.lastSuccess){const ut=new Date(this.eventData.lastSuccess),pt=new Date(Lt),wt=(Lt-this.eventData.lastSuccess)/864e5;St=St||wt>=1||wt<-1||ut.getDate()!==pt.getDate()}else St=!0;St?this.postEvent(Lt,{sdkIdentifier:"mapbox-gl-js",sdkVersion:wt,skuId:ad,"enabled.telemetry":!1,userId:this.anonId},(ut=>{ut||(this.eventData.lastSuccess=Lt,this.eventData.tokenU=Tt)}),ut):this.processRequests()}},Ld=zd.postTurnstileEvent.bind(zd),Rd=new class extends mn{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(ut,pt,wt,Tt){this.skuToken=pt,this.errorCb=Tt,It.EVENTS_URL&&(wt||It.ACCESS_TOKEN?this.queueRequest({id:ut,timestamp:Date.now()},wt):this.errorCb(new Error(md)))}processRequests(ut){if(this.pendingRequest||0===this.queue.length)return;const{id:pt,timestamp:Tt}=this.queue.shift();pt&&this.success[pt]||(this.anonId||this.fetchEventData(),ar(this.anonId)||(this.anonId=ir()),this.postEvent(Tt,{sdkIdentifier:"mapbox-gl-js",sdkVersion:wt,skuId:ad,skuToken:this.skuToken,userId:this.anonId},(ut=>{ut?this.errorCb(ut):pt&&(this.success[pt]=!0)}),ut))}remove(){this.errorCb=null}},Od=Rd.postMapLoadEvent.bind(Rd),Fd=new class extends mn{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(ut){let pt=this.mapInstanceIdMap.get(ut);return pt||(pt=ir(),this.mapInstanceIdMap.set(ut,pt)),pt}getEventId(ut){const pt=this.eventIdPerMapInstanceMap.get(ut)||0;return this.eventIdPerMapInstanceMap.set(ut,pt+1),pt}postStyleLoadEvent(ut,pt){const{map:wt,style:Tt,importedStyles:St}=pt;if(!It.EVENTS_URL||!ut&&!It.ACCESS_TOKEN)return;const Lt=this.getMapInstanceId(wt),Xt={mapInstanceId:Lt,eventId:this.getEventId(Lt),style:Tt};St.length&&(Xt.importedStyles=St),this.queueRequest({timestamp:Date.now(),payload:Xt},ut)}processRequests(ut){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:pt,payload:wt}=this.queue.shift();this.postEvent(pt,wt,(()=>{}),ut)}},Nd=Fd.postStyleLoadEvent.bind(Fd),Vd=new class extends mn{constructor(){super("gljs.performance")}postPerformanceEvent(ut,pt){It.EVENTS_URL&&(ut||It.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:pt},ut)}processRequests(ut){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:pt,performanceData:Tt}=this.queue.shift(),St=function(ut){const pt=performance.getEntriesByType("resource"),Tt=performance.getEntriesByType("mark"),St=function(ut){const pt={};if(ut)for(const wt in ut)if("other"!==wt)for(const Tt of ut[wt]){const ut=`${wt}ResolveRangeMin`,St=`${wt}ResolveRangeMax`,It=`${wt}RequestCount`,Lt=`${wt}RequestCachedCount`;pt[ut]=Math.min(pt[ut]||1/0,Tt.startTime),pt[St]=Math.max(pt[St]||-1/0,Tt.responseEnd);const o=ut=>{void 0===pt[ut]&&(pt[ut]=0),++pt[ut]};void 0!==Tt.transferSize&&0===Tt.transferSize&&o(Lt),o(It)}return pt}(function(ut,pt){const wt={};if(ut)for(const Tt of ut){const ut=pt(Tt);void 0===wt[ut]&&(wt[ut]=[]),wt[ut].push(Tt)}return wt}(pt,h)),It=window.devicePixelRatio,Xt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,Yt=Xt?Xt.effectiveType:void 0,Mi={counters:[],metadata:[],attributes:[]},p=(ut,pt,wt)=>{null!=wt&&ut.push({name:pt,value:wt.toString()})};for(const ut in St)p(Mi.counters,ut,St[ut]);if(ut.interactionRange[0]!==1/0&&ut.interactionRange[1]!==-1/0&&(p(Mi.counters,"interactionRangeMin",ut.interactionRange[0]),p(Mi.counters,"interactionRangeMax",ut.interactionRange[1])),Tt)for(const ut of Object.keys(Lt)){const pt=Lt[ut],wt=Tt.find((ut=>ut.name===pt));wt&&p(Mi.counters,pt,wt.startTime)}return p(Mi.counters,"visibilityHidden",ut.visibilityHidden),p(Mi.attributes,"style",function(ut){if(ut)for(const pt of ut){const ut=pt.name.split("?")[0];if(l(ut)){const pt=ut.split("/").slice(-2);if(2===pt.length)return`mapbox://styles/${pt[0]}/${pt[1]}`}}}(pt)),p(Mi.attributes,"terrainEnabled",ut.terrainEnabled?"true":"false"),p(Mi.attributes,"fogEnabled",ut.fogEnabled?"true":"false"),p(Mi.attributes,"projection",ut.projection),p(Mi.attributes,"zoom",ut.zoom),p(Mi.metadata,"devicePixelRatio",It),p(Mi.metadata,"connectionEffectiveType",Yt),p(Mi.metadata,"navigatorUserAgent",navigator.userAgent),p(Mi.metadata,"screenWidth",window.screen.width),p(Mi.metadata,"screenHeight",window.screen.height),p(Mi.metadata,"windowWidth",window.innerWidth),p(Mi.metadata,"windowHeight",window.innerHeight),p(Mi.metadata,"mapWidth",ut.width/It),p(Mi.metadata,"mapHeight",ut.height/It),p(Mi.metadata,"webglRenderer",ut.renderer),p(Mi.metadata,"webglVendor",ut.vendor),p(Mi.metadata,"sdkVersion",wt),p(Mi.metadata,"sdkIdentifier","mapbox-gl-js"),Mi}(Tt);for(const ut of St.metadata);for(const ut of St.counters);for(const ut of St.attributes);this.postEvent(pt,St,(()=>{}),ut)}},Ud=Vd.postPerformanceEvent.bind(Vd),jd=new class extends mn{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(ut,pt,wt,Tt){if(!It.API_URL||!It.SESSION_PATH)return;const St=hn(It.API_URL+It.SESSION_PATH);St.params.push(`sku=${pt||""}`),St.params.push(`access_token=${Tt||It.ACCESS_TOKEN||""}`);const Lt={url:pn(St),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(ut,pt){return tn(er(ut,{method:"GET"}),pt)}(Lt,(ut=>{this.pendingRequest=null,wt(ut),this.saveEventData(),this.processRequests(Tt)}))}getSessionAPI(ut,pt,wt,Tt){this.skuToken=pt,this.errorCb=Tt,It.SESSION_PATH&&It.API_URL&&(wt||It.ACCESS_TOKEN?this.queueRequest({id:ut,timestamp:Date.now()},wt):this.errorCb(new Error(md)))}processRequests(ut){if(this.pendingRequest||0===this.queue.length)return;const{id:pt,timestamp:wt}=this.queue.shift();pt&&this.success[pt]||this.getSession(wt,this.skuToken,(ut=>{ut?this.errorCb(ut):pt&&(this.success[pt]=!0)}),ut)}remove(){this.errorCb=null}},Gd=jd.getSessionAPI.bind(jd),qd=new Set;var Zd={exports:{}},$d={exports:function(ut,pt){var wt,Tt,St,It,Lt,Xt,Yt,Mi;for(Tt=ut.length-(wt=3&ut.length),St=pt,Lt=3432918353,Xt=461845907,Mi=0;Mi<Tt;)Yt=255&ut.charCodeAt(Mi)|(255&ut.charCodeAt(++Mi))<<8|(255&ut.charCodeAt(++Mi))<<16|(255&ut.charCodeAt(++Mi))<<24,++Mi,St=27492+(65535&(It=5*(65535&(St=(St^=Yt=(65535&(Yt=(Yt=(65535&Yt)*Lt+(((Yt>>>16)*Lt&65535)<<16)&4294967295)<<15|Yt>>>17))*Xt+(((Yt>>>16)*Xt&65535)<<16)&4294967295)<<13|St>>>19))+((5*(St>>>16)&65535)<<16)&4294967295))+((58964+(It>>>16)&65535)<<16);switch(Yt=0,wt){case 3:Yt^=(255&ut.charCodeAt(Mi+2))<<16;case 2:Yt^=(255&ut.charCodeAt(Mi+1))<<8;case 1:St^=Yt=(65535&(Yt=(Yt=(65535&(Yt^=255&ut.charCodeAt(Mi)))*Lt+(((Yt>>>16)*Lt&65535)<<16)&4294967295)<<15|Yt>>>17))*Xt+(((Yt>>>16)*Xt&65535)<<16)&4294967295}return St^=ut.length,St=2246822507*(65535&(St^=St>>>16))+((2246822507*(St>>>16)&65535)<<16)&4294967295,St=3266489909*(65535&(St^=St>>>13))+((3266489909*(St>>>16)&65535)<<16)&4294967295,(St^=St>>>16)>>>0}},Wd={exports:({},function(ut,pt){for(var wt,Tt=ut.length,St=pt^Tt,It=0;Tt>=4;)wt=1540483477*(65535&(wt=255&ut.charCodeAt(It)|(255&ut.charCodeAt(++It))<<8|(255&ut.charCodeAt(++It))<<16|(255&ut.charCodeAt(++It))<<24))+((1540483477*(wt>>>16)&65535)<<16),St=1540483477*(65535&St)+((1540483477*(St>>>16)&65535)<<16)^(wt=1540483477*(65535&(wt^=wt>>>24))+((1540483477*(wt>>>16)&65535)<<16)),Tt-=4,++It;switch(Tt){case 3:St^=(255&ut.charCodeAt(It+2))<<16;case 2:St^=(255&ut.charCodeAt(It+1))<<8;case 1:St=1540483477*(65535&(St^=255&ut.charCodeAt(It)))+((1540483477*(St>>>16)&65535)<<16)}return St=1540483477*(65535&(St^=St>>>13))+((1540483477*(St>>>16)&65535)<<16),(St^=St>>>15)>>>0})},Hd=$d.exports,Xd=Wd.exports;Zd.exports=Hd,Zd.exports.murmur3=Hd,Zd.exports.murmur2=Xd;var Yd=p(Zd.exports);function Dn(ut,pt,wt){wt[ut]&&-1!==wt[ut].indexOf(pt)||(wt[ut]=wt[ut]||[],wt[ut].push(pt))}function Cn(ut,pt,wt){if(wt&&wt[ut]){const Tt=wt[ut].indexOf(pt);-1!==Tt&&wt[ut].splice(Tt,1)}}class Rn{constructor(ut,pt={}){er(this,pt),this.type=ut}}class Vn extends Rn{constructor(ut,pt={}){super("error",er({error:ut},pt))}}class Fn{on(ut,pt){return this._listeners=this._listeners||{},Dn(ut,pt,this._listeners),this}off(ut,pt){return Cn(ut,pt,this._listeners),Cn(ut,pt,this._oneTimeListeners),this}once(ut,pt){return pt?(this._oneTimeListeners=this._oneTimeListeners||{},Dn(ut,pt,this._oneTimeListeners),this):new Promise((pt=>this.once(ut,pt)))}fire(ut,pt){"string"==typeof ut&&(ut=new Rn(ut,pt||{}));const wt=ut.type;if(this.listens(wt)){ut.target=this;const pt=this._listeners&&this._listeners[wt]?this._listeners[wt].slice():[];for(const wt of pt)wt.call(this,ut);const Tt=this._oneTimeListeners&&this._oneTimeListeners[wt]?this._oneTimeListeners[wt].slice():[];for(const pt of Tt)Cn(wt,pt,this._oneTimeListeners),pt.call(this,ut);const St=this._eventedParent;St&&(er(ut,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),St.fire(ut))}else ut instanceof Vn&&console.error(ut.error);return this}listens(ut){return!!(this._listeners&&this._listeners[ut]&&this._listeners[ut].length>0||this._oneTimeListeners&&this._oneTimeListeners[ut]&&this._oneTimeListeners[ut].length>0||this._eventedParent&&this._eventedParent.listens(ut))}setEventedParent(ut,pt){return this._eventedParent=ut,this._eventedParentData=pt,this}}ut.F=void 0;var Jd={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function On(ut){return(ut=Math.round(ut))<0?0:ut>255?255:ut}function Un(ut){return On("%"===ut[ut.length-1]?parseFloat(ut)/100*255:parseInt(ut))}function Nn(ut){return(pt="%"===ut[ut.length-1]?parseFloat(ut)/100:parseFloat(ut))<0?0:pt>1?1:pt;var pt}function jn(ut,pt,wt){return wt<0?wt+=1:wt>1&&(wt-=1),6*wt<1?ut+(pt-ut)*wt*6:2*wt<1?pt:3*wt<2?ut+(pt-ut)*(2/3-wt)*6:ut}try{ut.F={}.parseCSSColor=function(ut){var pt,wt=ut.replace(/ /g,"").toLowerCase();if(wt in Jd)return Jd[wt].slice();if("#"===wt[0])return 4===wt.length?(pt=parseInt(wt.substr(1),16))>=0&&pt<=4095?[(3840&pt)>>4|(3840&pt)>>8,240&pt|(240&pt)>>4,15&pt|(15&pt)<<4,1]:null:7===wt.length&&(pt=parseInt(wt.substr(1),16))>=0&&pt<=16777215?[(16711680&pt)>>16,(65280&pt)>>8,255&pt,1]:null;var Tt=wt.indexOf("("),St=wt.indexOf(")");if(-1!==Tt&&St+1===wt.length){var It=wt.substr(0,Tt),Lt=wt.substr(Tt+1,St-(Tt+1)).split(","),Xt=1;switch(It){case"rgba":if(4!==Lt.length)return null;Xt=Nn(Lt.pop());case"rgb":return 3!==Lt.length?null:[Un(Lt[0]),Un(Lt[1]),Un(Lt[2]),Xt];case"hsla":if(4!==Lt.length)return null;Xt=Nn(Lt.pop());case"hsl":if(3!==Lt.length)return null;var Yt=(parseFloat(Lt[0])%360+360)%360/360,Mi=Nn(Lt[1]),vr=Nn(Lt[2]),br=vr<=.5?vr*(Mi+1):vr+Mi-vr*Mi,Ar=2*vr-br;return[On(255*jn(Ar,br,Yt+1/3)),On(255*jn(Ar,br,Yt)),On(255*jn(Ar,br,Yt-1/3)),Xt];default:return null}}return null}}catch(ut){}class qn{constructor(ut,pt,wt,Tt=1){this.r=ut,this.g=pt,this.b=wt,this.a=Tt}static parse(pt){if(!pt)return;if(pt instanceof qn)return pt;if("string"!=typeof pt)return;const wt=ut.F(pt);return wt?new qn(wt[0]/255*wt[3],wt[1]/255*wt[3],wt[2]/255*wt[3],wt[3]):void 0}toString(){const[ut,pt,wt,Tt]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(ut)},${Math.round(pt)},${Math.round(wt)},${Tt})`}toRenderColor(ut){const{r:pt,g:wt,b:Tt,a:St}=this;return new $n(ut,pt,wt,Tt,St)}}class $n{constructor(ut,pt,wt,Tt,St){if(ut){const It=ut.image.height,Lt=It*It;pt=0===St?0:pt/St*(It-1),wt=0===St?0:wt/St*(It-1),Tt=0===St?0:Tt/St*(It-1);const Xt=Math.floor(pt),Yt=Math.floor(wt),Mi=Math.floor(Tt),vr=Math.ceil(pt),br=Math.ceil(wt),Ar=Math.ceil(Tt),Vr=pt-Xt,nn=wt-Yt,sn=Tt-Mi,an=ut.image.data,ln=4*(Xt+Yt*Lt+Mi*It),cn=4*(Xt+Yt*Lt+Ar*It),un=4*(Xt+br*Lt+Mi*It),fn=4*(Xt+br*Lt+Ar*It),_n=4*(vr+Yt*Lt+Mi*It),gn=4*(vr+Yt*Lt+Ar*It),yn=4*(vr+br*Lt+Mi*It),xn=4*(vr+br*Lt+Ar*It);if(ln<0||xn>=an.length)throw new Error("out of range");this.r=Gn(Gn(Gn(an[ln],an[cn],sn),Gn(an[un],an[fn],sn),nn),Gn(Gn(an[_n],an[gn],sn),Gn(an[yn],an[xn],sn),nn),Vr)/255*St,this.g=Gn(Gn(Gn(an[ln+1],an[cn+1],sn),Gn(an[un+1],an[fn+1],sn),nn),Gn(Gn(an[_n+1],an[gn+1],sn),Gn(an[yn+1],an[xn+1],sn),nn),Vr)/255*St,this.b=Gn(Gn(Gn(an[ln+2],an[cn+2],sn),Gn(an[un+2],an[fn+2],sn),nn),Gn(Gn(an[_n+2],an[gn+2],sn),Gn(an[yn+2],an[xn+2],sn),nn),Vr)/255*St,this.a=St}else this.r=pt,this.g=wt,this.b=Tt,this.a=St}toArray(){const{r:ut,g:pt,b:wt,a:Tt}=this;return 0===Tt?[0,0,0,0]:[255*ut/Tt,255*pt/Tt,255*wt/Tt,Tt]}toArray01(){const{r:ut,g:pt,b:wt,a:Tt}=this;return 0===Tt?[0,0,0,0]:[ut/Tt,pt/Tt,wt/Tt,Tt]}toArray01Scaled(ut){const{r:pt,g:wt,b:Tt,a:St}=this;return 0===St?[0,0,0]:[pt/St*ut,wt/St*ut,Tt/St*ut]}toArray01PremultipliedAlpha(){const{r:ut,g:pt,b:wt,a:Tt}=this;return[ut,pt,wt,Tt]}toArray01Linear(){const{r:ut,g:pt,b:wt,a:Tt}=this;return 0===Tt?[0,0,0,0]:[Math.pow(ut/Tt,2.2),Math.pow(pt/Tt,2.2),Math.pow(wt/Tt,2.2),Tt]}}function Gn(ut,pt,wt){return ut*(1-wt)+pt*wt}function Xn(ut,pt,wt){return ut.map(((ut,Tt)=>Gn(ut,pt[Tt],wt)))}qn.black=new qn(0,0,0,1),qn.white=new qn(1,1,1,1),qn.transparent=new qn(0,0,0,0),qn.red=new qn(1,0,0,1),qn.blue=new qn(0,0,1,1);var Qd=Object.freeze({__proto__:null,array:Xn,color:function(ut,pt,wt){return new qn(Gn(ut.r,pt.r,wt),Gn(ut.g,pt.g,wt),Gn(ut.b,pt.b,wt),Gn(ut.a,pt.a,wt))},number:Gn});function Zn(ut,...pt){for(const wt of pt)for(const pt in wt)ut[pt]=wt[pt];return ut}class Hn extends Error{constructor(ut,pt){super(pt),this.message=pt,this.key=ut}}class Kn{constructor(ut,pt=[]){this.parent=ut,this.bindings={};for(const[ut,wt]of pt)this.bindings[ut]=wt}concat(ut){return new Kn(this,ut)}get(ut){if(this.bindings[ut])return this.bindings[ut];if(this.parent)return this.parent.get(ut);throw new Error(`${ut} not found in scope.`)}has(ut){return!!this.bindings[ut]||!!this.parent&&this.parent.has(ut)}}const ep={kind:"null"},tp={kind:"number"},sp={kind:"string"},ap={kind:"boolean"},mp={kind:"color"},_p={kind:"object"},yp={kind:"value"},xp={kind:"collator"},vp={kind:"formatted"},bp={kind:"resolvedImage"};function oi(ut,pt){return{kind:"array",itemType:ut,N:pt}}function li(ut){if("array"===ut.kind){const pt=li(ut.itemType);return"number"==typeof ut.N?`array<${pt}, ${ut.N}>`:"value"===ut.itemType.kind?"array":`array<${pt}>`}return ut.kind}const Jp=[ep,tp,sp,ap,mp,vp,_p,oi(yp),bp];function ci(ut,pt){if("error"===pt.kind)return null;if("array"===ut.kind){if("array"===pt.kind&&(0===pt.N&&"value"===pt.itemType.kind||!ci(ut.itemType,pt.itemType))&&("number"!=typeof ut.N||ut.N===pt.N))return null}else{if(ut.kind===pt.kind)return null;if("value"===ut.kind)for(const ut of Jp)if(!ci(ut,pt))return null}return`Expected ${li(ut)} but found ${li(pt)} instead.`}function hi(ut,pt){return pt.some((pt=>pt.kind===ut.kind))}function pi(ut,pt){return pt.some((pt=>"null"===pt?null===ut:"array"===pt?Array.isArray(ut):"object"===pt?ut&&!Array.isArray(ut)&&"object"==typeof ut:pt===typeof ut))}class fi{constructor(ut,pt,wt){this.sensitivity=ut?pt?"variant":"case":pt?"accent":"base",this.locale=wt,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(ut,pt){return this.collator.compare(ut,pt)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class di{constructor(ut,pt,wt,Tt,St){this.text=ut.normalize?ut.normalize():ut,this.image=pt,this.scale=wt,this.fontStack=Tt,this.textColor=St}}class mi{constructor(ut){this.sections=ut}static fromString(ut){return new mi([new di(ut,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((ut=>0!==ut.text.length||ut.image&&0!==ut.image.namePrimary.length))}static factory(ut){return ut instanceof mi?ut:mi.fromString(ut)}toString(){return 0===this.sections.length?"":this.sections.map((ut=>ut.text)).join("")}serialize(){const ut=["format"];for(const pt of this.sections){if(pt.image){ut.push(["image",pt.image.namePrimary]);continue}ut.push(pt.text);const wt={};pt.fontStack&&(wt["text-font"]=["literal",pt.fontStack.split(",")]),pt.scale&&(wt["font-scale"]=pt.scale),pt.textColor&&(wt["text-color"]=["rgba"].concat(pt.textColor.toRenderColor(null).toArray())),ut.push(wt)}return ut}}class yi{constructor(ut){this.namePrimary=ut.namePrimary,ut.nameSecondary&&(this.nameSecondary=ut.nameSecondary),this.available=ut.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(ut,pt){return ut?new yi({namePrimary:ut,nameSecondary:pt,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function gi(ut,pt,wt,Tt){return"number"==typeof ut&&ut>=0&&ut<=255&&"number"==typeof pt&&pt>=0&&pt<=255&&"number"==typeof wt&&wt>=0&&wt<=255?void 0===Tt||"number"==typeof Tt&&Tt>=0&&Tt<=1?null:`Invalid rgba value [${[ut,pt,wt,Tt].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof Tt?[ut,pt,wt,Tt]:[ut,pt,wt]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function xi(ut){if(null===ut)return!0;if("string"==typeof ut)return!0;if("boolean"==typeof ut)return!0;if("number"==typeof ut)return!0;if(ut instanceof qn)return!0;if(ut instanceof fi)return!0;if(ut instanceof mi)return!0;if(ut instanceof yi)return!0;if(Array.isArray(ut)){for(const pt of ut)if(!xi(pt))return!1;return!0}if("object"==typeof ut){for(const pt in ut)if(!xi(ut[pt]))return!1;return!0}return!1}function bi(ut){if(null===ut)return ep;if("string"==typeof ut)return sp;if("boolean"==typeof ut)return ap;if("number"==typeof ut)return tp;if(ut instanceof qn)return mp;if(ut instanceof fi)return xp;if(ut instanceof mi)return vp;if(ut instanceof yi)return bp;if(Array.isArray(ut)){const pt=ut.length;let wt;for(const pt of ut){const ut=bi(pt);if(wt){if(wt===ut)continue;wt=yp;break}wt=ut}return oi(wt||yp,pt)}return _p}function vi(ut){const pt=typeof ut;return null===ut?"":"string"===pt||"number"===pt||"boolean"===pt?String(ut):ut instanceof qn||ut instanceof mi||ut instanceof yi?ut.toString():JSON.stringify(ut)}class _i{constructor(ut,pt){this.type=ut,this.value=pt}static parse(ut,pt){if(2!==ut.length)return pt.error(`'literal' expression requires exactly one argument, but found ${ut.length-1} instead.`);if(!xi(ut[1]))return pt.error("invalid value");const wt=ut[1];let Tt=bi(wt);const St=pt.expectedType;return"array"!==Tt.kind||0!==Tt.N||!St||"array"!==St.kind||"number"==typeof St.N&&0!==St.N||(Tt=St),new _i(Tt,wt)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof qn?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof mi?this.value.serialize():this.value}}class wi{constructor(ut){this.name="ExpressionEvaluationError",this.message=ut}toJSON(){return this.message}}const Qp={string:sp,number:tp,boolean:ap,object:_p};class Ai{constructor(ut,pt){this.type=ut,this.args=pt}static parse(ut,pt){if(ut.length<2)return pt.error("Expected at least one argument.");let wt,Tt=1;const St=ut[0];if("array"===St){let St,It;if(ut.length>2){const wt=ut[1];if("string"!=typeof wt||!(wt in Qp)||"object"===wt)return pt.error('The item type argument of "array" must be one of string, number, boolean',1);St=Qp[wt],Tt++}else St=yp;if(ut.length>3){if(null!==ut[2]&&("number"!=typeof ut[2]||ut[2]<0||ut[2]!==Math.floor(ut[2])))return pt.error('The length argument to "array" must be a positive integer literal',2);It=ut[2],Tt++}wt=oi(St,It)}else wt=Qp[St];const It=[];for(;Tt<ut.length;Tt++){const wt=pt.parse(ut[Tt],Tt,yp);if(!wt)return null;It.push(wt)}return new Ai(wt,It)}evaluate(ut){for(let pt=0;pt<this.args.length;pt++){const wt=this.args[pt].evaluate(ut);if(!ci(this.type,bi(wt)))return wt;if(pt===this.args.length-1)throw new wi(`Expected value to be of type ${li(this.type)}, but found ${li(bi(wt))} instead.`)}return null}eachChild(ut){this.args.forEach(ut)}outputDefined(){return this.args.every((ut=>ut.outputDefined()))}serialize(){const ut=this.type,pt=[ut.kind];if("array"===ut.kind){const wt=ut.itemType;if("string"===wt.kind||"number"===wt.kind||"boolean"===wt.kind){pt.push(wt.kind);const Tt=ut.N;("number"==typeof Tt||this.args.length>1)&&pt.push(Tt)}}return pt.concat(this.args.map((ut=>ut.serialize())))}}class Si{constructor(ut){this.type=vp,this.sections=ut}static parse(ut,pt){if(ut.length<2)return pt.error("Expected at least one argument.");const wt=ut[1];if(!Array.isArray(wt)&&"object"==typeof wt)return pt.error("First argument must be an image or text section.");const Tt=[];let St=!1;for(let wt=1;wt<=ut.length-1;++wt){const It=ut[wt];if(St&&"object"==typeof It&&!Array.isArray(It)){St=!1;let ut=null;if(It["font-scale"]&&(ut=pt.parse(It["font-scale"],1,tp),!ut))return null;let wt=null;if(It["text-font"]&&(wt=pt.parse(It["text-font"],1,oi(sp)),!wt))return null;let Lt=null;if(It["text-color"]&&(Lt=pt.parse(It["text-color"],1,mp),!Lt))return null;const Xt=Tt[Tt.length-1];Xt.scale=ut,Xt.font=wt,Xt.textColor=Lt}else{const It=pt.parse(ut[wt],1,yp);if(!It)return null;const Lt=It.type.kind;if("string"!==Lt&&"value"!==Lt&&"null"!==Lt&&"resolvedImage"!==Lt)return pt.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");St=!0,Tt.push({content:It,scale:null,font:null,textColor:null})}}return new Si(Tt)}evaluate(ut){return new mi(this.sections.map((pt=>{const wt=pt.content.evaluate(ut);return bi(wt)===bp?new di("",wt,null,null,null):new di(vi(wt),null,pt.scale?pt.scale.evaluate(ut):null,pt.font?pt.font.evaluate(ut).join(","):null,pt.textColor?pt.textColor.evaluate(ut):null)})))}eachChild(ut){for(const pt of this.sections)ut(pt.content),pt.scale&&ut(pt.scale),pt.font&&ut(pt.font),pt.textColor&&ut(pt.textColor)}outputDefined(){return!1}serialize(){const ut=["format"];for(const pt of this.sections){ut.push(pt.content.serialize());const wt={};pt.scale&&(wt["font-scale"]=pt.scale.serialize()),pt.font&&(wt["text-font"]=pt.font.serialize()),pt.textColor&&(wt["text-color"]=pt.textColor.serialize()),ut.push(wt)}return ut}}class Ii{constructor(ut,pt){this.type=bp,this.inputPrimary=ut,this.inputSecondary=pt}static parse(ut,pt){if(ut.length<2)return pt.error("Expected two or more arguments.");const wt=pt.parse(ut[1],1,sp);if(!wt)return pt.error("No image name provided.");if(2===ut.length)return new Ii(wt);const Tt=pt.parse(ut[2],1,sp);return Tt?new Ii(wt,Tt):pt.error("Secondary image variant is not a string.")}evaluate(ut){const pt=yi.fromString(this.inputPrimary.evaluate(ut),this.inputSecondary?this.inputSecondary.evaluate(ut):void 0);return pt&&ut.availableImages&&(pt.available=ut.availableImages.indexOf(pt.namePrimary)>-1,pt.nameSecondary&&pt.available&&ut.availableImages&&(pt.available=ut.availableImages.indexOf(pt.nameSecondary)>-1)),pt}eachChild(ut){ut(this.inputPrimary),this.inputSecondary&&ut(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Ti(ut){return ut instanceof Number?"number":ut instanceof String?"string":ut instanceof Boolean?"boolean":Array.isArray(ut)?"array":null===ut?"null":typeof ut}const nf={"to-boolean":ap,"to-color":mp,"to-number":tp,"to-string":sp};class zi{constructor(ut,pt){this.type=ut,this.args=pt}static parse(ut,pt){if(ut.length<2)return pt.error("Expected at least one argument.");const wt=ut[0],Tt=[];let St=ep;if("to-array"===wt){if(!Array.isArray(ut[1]))return null;const wt=ut[1].length;if(pt.expectedType){if("array"!==pt.expectedType.kind)return pt.error(`Expected ${pt.expectedType.kind} but found array.`);St=oi(pt.expectedType.itemType,wt)}else{if(!(wt>0&&xi(ut[1][0])))return null;St=oi(bi(ut[1][0]),wt)}for(let It=0;It<wt;It++){const wt=ut[1][It];let Lt;if("array"===Ti(wt))Lt=pt.parse(wt,void 0,St.itemType);else{const ut=Ti(wt);if(ut!==St.itemType.kind)return pt.error(`Expected ${St.itemType.kind} but found ${ut}.`);Lt=pt.registry.literal.parse(["literal",void 0===wt?null:wt],pt)}if(!Lt)return null;Tt.push(Lt)}}else{if(("to-boolean"===wt||"to-string"===wt)&&2!==ut.length)return pt.error("Expected one argument.");St=nf[wt];for(let wt=1;wt<ut.length;wt++){const St=pt.parse(ut[wt],wt,yp);if(!St)return null;Tt.push(St)}}return new zi(St,Tt)}evaluate(ut){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(ut));if("color"===this.type.kind){let pt,wt;for(const Tt of this.args){if(pt=Tt.evaluate(ut),wt=null,pt instanceof qn)return pt;if("string"==typeof pt){const wt=ut.parseColor(pt);if(wt)return wt}else if(Array.isArray(pt)&&(wt=pt.length<3||pt.length>4?`Invalid rbga value ${JSON.stringify(pt)}: expected an array containing either three or four numeric values.`:gi(pt[0],pt[1],pt[2],pt[3]),!wt))return new qn(pt[0]/255,pt[1]/255,pt[2]/255,pt[3])}throw new wi(wt||`Could not parse color from value '${"string"==typeof pt?pt:String(JSON.stringify(pt))}'`)}if("number"===this.type.kind){let pt=null;for(const wt of this.args){if(pt=wt.evaluate(ut),null===pt)return 0;const Tt=Number(pt);if(!isNaN(Tt))return Tt}throw new wi(`Could not convert ${JSON.stringify(pt)} to number.`)}return"formatted"===this.type.kind?mi.fromString(vi(this.args[0].evaluate(ut))):"resolvedImage"===this.type.kind?yi.fromString(vi(this.args[0].evaluate(ut))):"array"===this.type.kind?this.args.map((pt=>pt.evaluate(ut))):vi(this.args[0].evaluate(ut))}eachChild(ut){this.args.forEach(ut)}outputDefined(){return this.args.every((ut=>ut.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new Si([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ii(this.args[0]).serialize();const ut="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((pt=>{ut.push(pt.serialize())})),ut}}const of=["Unknown","Point","LineString","Polygon"];class Ei{constructor(ut,pt){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=ut,this.options=pt}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?of[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(ut){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const ut=this.featureDistanceData.center,pt=this.featureDistanceData.scale,{x:wt,y:Tt}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(wt*pt-ut[0])+this.featureDistanceData.bearing[1]*(Tt*pt-ut[1])}return 0}parseColor(ut){let pt=this._parseColorCache[ut];return pt||(pt=this._parseColorCache[ut]=qn.parse(ut)),pt}getConfig(ut){return this.options?this.options.get(ut):null}}class Bi{constructor(ut,pt,wt,Tt,St){this.name=ut,this.type=pt,this._evaluate=wt,this.args=Tt,this._overloadIndex=St}evaluate(ut){if(!this._evaluate){const ut=Bi.definitions[this.name];this._evaluate=Array.isArray(ut)?ut[2]:ut.overloads[this._overloadIndex][1]}return this._evaluate(ut,this.args)}eachChild(ut){this.args.forEach(ut)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((ut=>ut.serialize())))}static parse(ut,pt){const wt=ut[0],Tt=Bi.definitions[wt];if(!Tt)return pt.error(`Unknown expression "${wt}". If you wanted a literal array, use ["literal", [...]].`,0);const St=Array.isArray(Tt)?Tt[0]:Tt.type,It=Array.isArray(Tt)?[[Tt[1],Tt[2]]]:Tt.overloads,Lt=[];let Xt=null,Yt=-1;for(const[Tt,Mi]of It){if(Array.isArray(Tt)&&Tt.length!==ut.length-1)continue;Lt.push(Tt),Yt++,Xt=new Sf(pt.registry,pt.path,null,pt.scope,void 0,pt._scope,pt.options);const It=[];let vr=!1;for(let pt=1;pt<ut.length;pt++){const wt=ut[pt],St=Array.isArray(Tt)?Tt[pt-1]:Tt.type,Lt=Xt.parse(wt,1+It.length,St);if(!Lt){vr=!0;break}It.push(Lt)}if(!vr)if(Array.isArray(Tt)&&Tt.length!==It.length)Xt.error(`Expected ${Tt.length} arguments, but found ${It.length} instead.`);else{for(let ut=0;ut<It.length;ut++){const pt=Array.isArray(Tt)?Tt[ut]:Tt.type,wt=It[ut];Xt.concat(ut+1).checkSubtype(pt,wt.type)}if(0===Xt.errors.length)return new Bi(wt,St,Mi,It,Yt)}}if(1===Lt.length)pt.errors.push(...Xt.errors);else{const wt=(Lt.length?Lt:It.map((([ut])=>ut))).map(Di).join(" | "),Tt=[];for(let wt=1;wt<ut.length;wt++){const St=pt.parse(ut[wt],1+Tt.length);if(!St)return null;Tt.push(li(St.type))}pt.error(`Expected arguments of type ${wt}, but found (${Tt.join(", ")}) instead.`)}return null}static register(ut,pt){Bi.definitions=pt;for(const wt in pt)ut[wt]=Bi}}function Di(ut){return Array.isArray(ut)?`(${ut.map(li).join(", ")})`:`(${li(ut.type)}...)`}class Ci{constructor(ut,pt,wt){this.type=xp,this.locale=wt,this.caseSensitive=ut,this.diacriticSensitive=pt}static parse(ut,pt){if(2!==ut.length)return pt.error("Expected one argument.");const wt=ut[1];if("object"!=typeof wt||Array.isArray(wt))return pt.error("Collator options argument must be an object.");const Tt=pt.parse(void 0!==wt["case-sensitive"]&&wt["case-sensitive"],1,ap);if(!Tt)return null;const St=pt.parse(void 0!==wt["diacritic-sensitive"]&&wt["diacritic-sensitive"],1,ap);if(!St)return null;let It=null;return wt.locale&&(It=pt.parse(wt.locale,1,sp),!It)?null:new Ci(Tt,St,It)}evaluate(ut){return new fi(this.caseSensitive.evaluate(ut),this.diacriticSensitive.evaluate(ut),this.locale?this.locale.evaluate(ut):null)}eachChild(ut){ut(this.caseSensitive),ut(this.diacriticSensitive),this.locale&&ut(this.locale)}outputDefined(){return!1}serialize(){const ut={};return ut["case-sensitive"]=this.caseSensitive.serialize(),ut["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(ut.locale=this.locale.serialize()),["collator",ut]}}var sf={exports:{}};sf.exports=function(){function t(ut,pt,wt,Tt,St){for(;Tt>wt;){if(Tt-wt>600){var It=Tt-wt+1,Lt=pt-wt+1,Xt=Math.log(It),Yt=.5*Math.exp(2*Xt/3),Mi=.5*Math.sqrt(Xt*Yt*(It-Yt)/It)*(Lt-It/2<0?-1:1);t(ut,pt,Math.max(wt,Math.floor(pt-Lt*Yt/It+Mi)),Math.min(Tt,Math.floor(pt+(It-Lt)*Yt/It+Mi)),St)}var vr=ut[pt],br=wt,Ar=Tt;for(e(ut,wt,pt),St(ut[Tt],vr)>0&&e(ut,wt,Tt);br<Ar;){for(e(ut,br,Ar),br++,Ar--;St(ut[br],vr)<0;)br++;for(;St(ut[Ar],vr)>0;)Ar--}0===St(ut[wt],vr)?e(ut,wt,Ar):e(ut,++Ar,Tt),Ar<=pt&&(wt=Ar+1),pt<=Ar&&(Tt=Ar-1)}}function e(ut,pt,wt){var Tt=ut[pt];ut[pt]=ut[wt],ut[wt]=Tt}function r(ut,pt){return ut<pt?-1:ut>pt?1:0}return function(ut,pt,wt,Tt,St){t(ut,pt,wt||0,Tt||ut.length-1,St||r)}}();var af=p(sf.exports);function Fi(ut){let pt=0;for(let wt,Tt,St=0,It=ut.length,Lt=It-1;St<It;Lt=St++)wt=ut[St],Tt=ut[Lt],pt+=(Tt.x-wt.x)*(wt.y+Tt.y);return pt}function Li(ut,pt){ut[0]=Math.min(ut[0],pt[0]),ut[1]=Math.min(ut[1],pt[1]),ut[2]=Math.max(ut[2],pt[0]),ut[3]=Math.max(ut[3],pt[1])}function Oi(ut,pt){return!(ut[0]<=pt[0]||ut[2]>=pt[2]||ut[1]<=pt[1]||ut[3]>=pt[3])}function Ui(ut,pt,wt){const Tt=ut[0]-pt[0],St=ut[1]-pt[1],It=ut[0]-wt[0],Lt=ut[1]-wt[1];return Tt*Lt-It*St==0&&Tt*It<=0&&St*Lt<=0}function Ni(ut,pt,wt=!1){let Tt=!1;for(let Xt=0,Yt=pt.length;Xt<Yt;Xt++){const Yt=pt[Xt];for(let pt=0,Xt=Yt.length,Mi=Xt-1;pt<Xt;Mi=pt++){const Xt=Yt[Mi],vr=Yt[pt];if(Ui(ut,Xt,vr))return wt;(It=Xt)[1]>(St=ut)[1]!=(Lt=vr)[1]>St[1]&&St[0]<(Lt[0]-It[0])*(St[1]-It[1])/(Lt[1]-It[1])+It[0]&&(Tt=!Tt)}}var St,It,Lt;return Tt}function ji(ut,pt,wt,Tt){const St=Tt[0]-wt[0],It=Tt[1]-wt[1],Lt=(ut[0]-wt[0])*It-St*(ut[1]-wt[1]),Xt=(pt[0]-wt[0])*It-St*(pt[1]-wt[1]);return Lt>0&&Xt<0||Lt<0&&Xt>0}function qi(ut,pt,wt,Tt){return 0!=(St=[Tt[0]-wt[0],Tt[1]-wt[1]])[0]*(It=[pt[0]-ut[0],pt[1]-ut[1]])[1]-St[1]*It[0]&&!(!ji(ut,pt,wt,Tt)||!ji(wt,Tt,ut,pt));var St,It}const lf=8192;function Gi(ut,pt){const wt=(180+ut[0])/360,Tt=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+ut[1]*Math.PI/360)))/360,St=Math.pow(2,pt.z);return[Math.round(wt*St*lf),Math.round(Tt*St*lf)]}function Xi(ut,pt){for(let wt=0;wt<pt.length;wt++)if(Ni(ut,pt[wt]))return!0;return!1}function Yi(ut,pt,wt){for(const Tt of wt)for(let wt=0,St=Tt.length,It=St-1;wt<St;It=wt++)if(qi(ut,pt,Tt[It],Tt[wt]))return!0;return!1}function Zi(ut,pt){for(let wt=0;wt<ut.length;++wt)if(!Ni(ut[wt],pt))return!1;for(let wt=0;wt<ut.length-1;++wt)if(Yi(ut[wt],ut[wt+1],pt))return!1;return!0}function Hi(ut,pt){for(let wt=0;wt<pt.length;wt++)if(Zi(ut,pt[wt]))return!0;return!1}function Ki(ut,pt,wt){const Tt=[];for(let St=0;St<ut.length;St++){const It=[];for(let Tt=0;Tt<ut[St].length;Tt++){const Lt=Gi(ut[St][Tt],wt);Li(pt,Lt),It.push(Lt)}Tt.push(It)}return Tt}function Wi(ut,pt,wt){const Tt=[];for(let St=0;St<ut.length;St++){const It=Ki(ut[St],pt,wt);Tt.push(It)}return Tt}function Ji(ut,pt,wt,Tt){if(ut[0]<wt[0]||ut[0]>wt[2]){const pt=.5*Tt;let St=ut[0]-wt[0]>pt?-Tt:wt[0]-ut[0]>pt?Tt:0;0===St&&(St=ut[0]-wt[2]>pt?-Tt:wt[2]-ut[0]>pt?Tt:0),ut[0]+=St}Li(pt,ut)}function Qi(ut,pt,wt,Tt){const St=Math.pow(2,Tt.z)*lf,It=[Tt.x*lf,Tt.y*lf],Lt=[];if(!ut)return Lt;for(const Tt of ut)for(const ut of Tt){const Tt=[ut.x+It[0],ut.y+It[1]];Ji(Tt,pt,wt,St),Lt.push(Tt)}return Lt}function ts(ut,pt,wt,Tt){const St=Math.pow(2,Tt.z)*lf,It=[Tt.x*lf,Tt.y*lf],Lt=[];if(!ut)return Lt;for(const wt of ut){const ut=[];for(const Tt of wt){const wt=[Tt.x+It[0],Tt.y+It[1]];Li(pt,wt),ut.push(wt)}Lt.push(ut)}if(pt[2]-pt[0]<=St/2){(Xt=pt)[0]=Xt[1]=1/0,Xt[2]=Xt[3]=-1/0;for(const ut of Lt)for(const Tt of ut)Ji(Tt,pt,wt,St)}var Xt;return Lt}class es{constructor(ut,pt){this.type=ap,this.geojson=ut,this.geometries=pt}static parse(ut,pt){if(2!==ut.length)return pt.error(`'within' expression requires exactly one argument, but found ${ut.length-1} instead.`);if(xi(ut[1])){const pt=ut[1];if("FeatureCollection"===pt.type)for(let ut=0;ut<pt.features.length;++ut){const wt=pt.features[ut].geometry.type;if("Polygon"===wt||"MultiPolygon"===wt)return new es(pt,pt.features[ut].geometry)}else if("Feature"===pt.type){const ut=pt.geometry.type;if("Polygon"===ut||"MultiPolygon"===ut)return new es(pt,pt.geometry)}else if("Polygon"===pt.type||"MultiPolygon"===pt.type)return new es(pt,pt)}return pt.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(ut){if(null!=ut.geometry()&&null!=ut.canonicalID()){if("Point"===ut.geometryType())return function(ut,pt){const wt=[1/0,1/0,-1/0,-1/0],Tt=[1/0,1/0,-1/0,-1/0],St=ut.canonicalID();if(!St)return!1;if("Polygon"===pt.type){const It=Ki(pt.coordinates,Tt,St),Lt=Qi(ut.geometry(),wt,Tt,St);if(!Oi(wt,Tt))return!1;for(const ut of Lt)if(!Ni(ut,It))return!1}if("MultiPolygon"===pt.type){const It=Wi(pt.coordinates,Tt,St),Lt=Qi(ut.geometry(),wt,Tt,St);if(!Oi(wt,Tt))return!1;for(const ut of Lt)if(!Xi(ut,It))return!1}return!0}(ut,this.geometries);if("LineString"===ut.geometryType())return function(ut,pt){const wt=[1/0,1/0,-1/0,-1/0],Tt=[1/0,1/0,-1/0,-1/0],St=ut.canonicalID();if(!St)return!1;if("Polygon"===pt.type){const It=Ki(pt.coordinates,Tt,St),Lt=ts(ut.geometry(),wt,Tt,St);if(!Oi(wt,Tt))return!1;for(const ut of Lt)if(!Zi(ut,It))return!1}if("MultiPolygon"===pt.type){const It=Wi(pt.coordinates,Tt,St),Lt=ts(ut.geometry(),wt,Tt,St);if(!Oi(wt,Tt))return!1;for(const ut of Lt)if(!Hi(ut,It))return!1}return!0}(ut,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const cf={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},uf=1/298.257223563,hf=uf*(2-uf),df=Math.PI/180;class as{static fromTile(ut,pt,wt){const Tt=Math.PI*(1-2*(ut+.5)/Math.pow(2,pt)),St=Math.atan(.5*(Math.exp(Tt)-Math.exp(-Tt)))/df;return new as(St,wt)}static get units(){return cf}constructor(ut,pt){if(void 0===ut)throw new Error("No latitude given.");if(pt&&!cf[pt])throw new Error(`Unknown unit ${pt}. Use one of: ${Object.keys(cf).join(", ")}`);const wt=6378.137*df*(pt?cf[pt]:1),Tt=Math.cos(ut*df),St=1/(1-hf*(1-Tt*Tt)),It=Math.sqrt(St);this.kx=wt*It*Tt,this.ky=wt*It*St*(1-hf)}distance(ut,pt){const wt=us(ut[0]-pt[0])*this.kx,Tt=(ut[1]-pt[1])*this.ky;return Math.sqrt(wt*wt+Tt*Tt)}bearing(ut,pt){const wt=us(pt[0]-ut[0])*this.kx;return Math.atan2(wt,(pt[1]-ut[1])*this.ky)/df}destination(ut,pt,wt){const Tt=wt*df;return this.offset(ut,Math.sin(Tt)*pt,Math.cos(Tt)*pt)}offset(ut,pt,wt){return[ut[0]+pt/this.kx,ut[1]+wt/this.ky]}lineDistance(ut){let pt=0;for(let wt=0;wt<ut.length-1;wt++)pt+=this.distance(ut[wt],ut[wt+1]);return pt}area(ut){let pt=0;for(let wt=0;wt<ut.length;wt++){const Tt=ut[wt];for(let ut=0,St=Tt.length,It=St-1;ut<St;It=ut++)pt+=us(Tt[ut][0]-Tt[It][0])*(Tt[ut][1]+Tt[It][1])*(wt?-1:1)}return Math.abs(pt)/2*this.kx*this.ky}along(ut,pt){let wt=0;if(pt<=0)return ut[0];for(let Tt=0;Tt<ut.length-1;Tt++){const St=ut[Tt],It=ut[Tt+1],Lt=this.distance(St,It);if(wt+=Lt,wt>pt)return ls(St,It,(pt-(wt-Lt))/Lt)}return ut[ut.length-1]}pointToSegmentDistance(ut,pt,wt){let[Tt,St]=pt,It=us(wt[0]-Tt)*this.kx,Lt=(wt[1]-St)*this.ky;if(0!==It||0!==Lt){const pt=(us(ut[0]-Tt)*this.kx*It+(ut[1]-St)*this.ky*Lt)/(It*It+Lt*Lt);pt>1?(Tt=wt[0],St=wt[1]):pt>0&&(Tt+=It/this.kx*pt,St+=Lt/this.ky*pt)}return It=us(ut[0]-Tt)*this.kx,Lt=(ut[1]-St)*this.ky,Math.sqrt(It*It+Lt*Lt)}pointOnLine(ut,pt){let wt=1/0,Tt=ut[0][0],St=ut[0][1],It=0,Lt=0;for(let Xt=0;Xt<ut.length-1;Xt++){let Yt=ut[Xt][0],Mi=ut[Xt][1],vr=us(ut[Xt+1][0]-Yt)*this.kx,br=(ut[Xt+1][1]-Mi)*this.ky,Ar=0;0===vr&&0===br||(Ar=(us(pt[0]-Yt)*this.kx*vr+(pt[1]-Mi)*this.ky*br)/(vr*vr+br*br),Ar>1?(Yt=ut[Xt+1][0],Mi=ut[Xt+1][1]):Ar>0&&(Yt+=vr/this.kx*Ar,Mi+=br/this.ky*Ar)),vr=us(pt[0]-Yt)*this.kx,br=(pt[1]-Mi)*this.ky;const Vr=vr*vr+br*br;Vr<wt&&(wt=Vr,Tt=Yt,St=Mi,It=Xt,Lt=Ar)}return{point:[Tt,St],index:It,t:Math.max(0,Math.min(1,Lt))}}lineSlice(ut,pt,wt){let Tt=this.pointOnLine(wt,ut),St=this.pointOnLine(wt,pt);if(Tt.index>St.index||Tt.index===St.index&&Tt.t>St.t){const ut=Tt;Tt=St,St=ut}const It=[Tt.point],Lt=Tt.index+1,Xt=St.index;!os(wt[Lt],It[0])&&Lt<=Xt&&It.push(wt[Lt]);for(let ut=Lt+1;ut<=Xt;ut++)It.push(wt[ut]);return os(wt[Xt],St.point)||It.push(St.point),It}lineSliceAlong(ut,pt,wt){let Tt=0;const St=[];for(let It=0;It<wt.length-1;It++){const Lt=wt[It],Xt=wt[It+1],Yt=this.distance(Lt,Xt);if(Tt+=Yt,Tt>ut&&0===St.length&&St.push(ls(Lt,Xt,(ut-(Tt-Yt))/Yt)),Tt>=pt)return St.push(ls(Lt,Xt,(pt-(Tt-Yt))/Yt)),St;Tt>ut&&St.push(Xt)}return St}bufferPoint(ut,pt){const wt=pt/this.ky,Tt=pt/this.kx;return[ut[0]-Tt,ut[1]-wt,ut[0]+Tt,ut[1]+wt]}bufferBBox(ut,pt){const wt=pt/this.ky,Tt=pt/this.kx;return[ut[0]-Tt,ut[1]-wt,ut[2]+Tt,ut[3]+wt]}insideBBox(ut,pt){return us(ut[0]-pt[0])>=0&&us(ut[0]-pt[2])<=0&&ut[1]>=pt[1]&&ut[1]<=pt[3]}}function os(ut,pt){return ut[0]===pt[0]&&ut[1]===pt[1]}function ls(ut,pt,wt){const Tt=us(pt[0]-ut[0]);return[ut[0]+Tt*wt,ut[1]+(pt[1]-ut[1])*wt]}function us(ut){for(;ut<-180;)ut+=360;for(;ut>180;)ut-=360;return ut}var pf={exports:{}};!function(ut,wt){ut.exports=function(){var t=function(ut,wt){if(void 0===ut&&(ut=[]),void 0===wt&&(wt=e),(this||pt).data=ut,(this||pt).length=(this||pt).data.length,(this||pt).compare=wt,(this||pt).length>0)for(var Tt=((this||pt).length>>1)-1;Tt>=0;Tt--)this._down(Tt)};function e(ut,pt){return ut<pt?-1:ut>pt?1:0}return t.prototype.push=function(ut){(this||pt).data.push(ut),(this||pt).length++,this._up((this||pt).length-1)},t.prototype.pop=function(){if(0!==(this||pt).length){var ut=(this||pt).data[0],wt=(this||pt).data.pop();return(this||pt).length--,(this||pt).length>0&&((this||pt).data[0]=wt,this._down(0)),ut}},t.prototype.peek=function(){return(this||pt).data[0]},t.prototype._up=function(ut){for(var wt=(this||pt).data,Tt=(this||pt).compare,St=wt[ut];ut>0;){var It=ut-1>>1,Lt=wt[It];if(Tt(St,Lt)>=0)break;wt[ut]=Lt,ut=It}wt[ut]=St},t.prototype._down=function(ut){for(var wt=(this||pt).data,Tt=(this||pt).compare,St=(this||pt).length>>1,It=wt[ut];ut<St;){var Lt=1+(ut<<1),Xt=wt[Lt],Yt=Lt+1;if(Yt<(this||pt).length&&Tt(wt[Yt],Xt)<0&&(Lt=Yt,Xt=wt[Yt]),Tt(Xt,It)>=0)break;wt[ut]=Xt,ut=Lt}wt[ut]=It},t}()}(pf);var ff=p(pf.exports),xf=8192;function fs(ut,pt){return pt.dist-ut.dist}const bf=100,wf=50;function ys(ut){const pt=[1/0,1/0,-1/0,-1/0];if(pt.length!==ut.length)return!1;for(let wt=0;wt<pt.length;wt++)if(pt[wt]!==ut[wt])return!1;return!0}function gs(ut){return ut[1]-ut[0]+1}function xs(ut,pt){const wt=ut[1]>=ut[0]&&ut[1]<pt;return wt||console.warn("Distance Expression: Index is out of range"),wt}function bs(ut,pt){if(ut[0]>ut[1])return[null,null];const wt=gs(ut);if(pt){if(2===wt)return[ut,null];const pt=Math.floor(wt/2);return[[ut[0],ut[0]+pt],[ut[0]+pt,ut[1]]]}{if(1===wt)return[ut,null];const pt=Math.floor(wt/2)-1;return[[ut[0],ut[0]+pt],[ut[0]+pt+1,ut[1]]]}}function vs(ut,pt){const wt=[1/0,1/0,-1/0,-1/0];if(!xs(pt,ut.length))return wt;for(let Tt=pt[0];Tt<=pt[1];++Tt)Li(wt,ut[Tt]);return wt}function _s(ut){const pt=[1/0,1/0,-1/0,-1/0];for(let wt=0;wt<ut.length;++wt)for(let Tt=0;Tt<ut[wt].length;++Tt)Li(pt,ut[wt][Tt]);return pt}function ws(ut,pt,wt){if(ys(ut)||ys(pt))return NaN;let Tt=0,St=0;return ut[2]<pt[0]&&(Tt=pt[0]-ut[2]),ut[0]>pt[2]&&(Tt=ut[0]-pt[2]),ut[1]>pt[3]&&(St=ut[1]-pt[3]),ut[3]<pt[1]&&(St=pt[1]-ut[3]),wt.distance([0,0],[Tt,St])}function Ms(ut){return 360*ut-180}function As(ut){return 360/Math.PI*Math.atan(Math.exp((180-360*ut)*Math.PI/180))-90}function Ss(ut,pt){const wt=Math.pow(2,pt.z),Tt=(ut.y/xf+pt.y)/wt;return[Ms((ut.x/xf+pt.x)/wt),As(Tt)]}function Is(ut,pt){const wt=[];for(let Tt=0;Tt<ut.length;++Tt)wt.push(Ss(ut[Tt],pt));return wt}function Ts(ut,pt,wt){const Tt=wt.pointOnLine(pt,ut).point;return wt.distance(ut,Tt)}function ks(ut,pt,wt,Tt,St){const It=wt.slice(Tt[0],Tt[1]+1);let Lt=1/0;for(let wt=pt[0];wt<=pt[1];++wt)if(0===(Lt=Math.min(Lt,Ts(ut[wt],It,St))))return 0;return Lt}function zs(ut,pt,wt,Tt,St){const It=Math.min(St.pointToSegmentDistance(ut,wt,Tt),St.pointToSegmentDistance(pt,wt,Tt)),Lt=Math.min(St.pointToSegmentDistance(wt,ut,pt),St.pointToSegmentDistance(Tt,ut,pt));return Math.min(It,Lt)}function Ps(ut,pt,wt,Tt,St){if(!xs(pt,ut.length)||!xs(Tt,wt.length))return NaN;let It=1/0;for(let Lt=pt[0];Lt<pt[1];++Lt)for(let pt=Tt[0];pt<Tt[1];++pt){if(qi(ut[Lt],ut[Lt+1],wt[pt],wt[pt+1]))return 0;It=Math.min(It,zs(ut[Lt],ut[Lt+1],wt[pt],wt[pt+1],St))}return It}function Es(ut,pt,wt,Tt,St){if(!xs(pt,ut.length)||!xs(Tt,wt.length))return NaN;let It=1/0;for(let Lt=pt[0];Lt<=pt[1];++Lt)for(let pt=Tt[0];pt<=Tt[1];++pt)if(0===(It=Math.min(It,St.distance(ut[Lt],wt[pt]))))return It;return It}function Bs(ut,pt,wt){if(Ni(ut,pt,!0))return 0;let Tt=1/0;for(const St of pt){const pt=St.length;if(pt<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(St[0]!==St[pt-1]&&0===(Tt=Math.min(Tt,wt.pointToSegmentDistance(ut,St[pt-1],St[0]))))return Tt;if(0===(Tt=Math.min(Tt,Ts(ut,St,wt))))return Tt}return Tt}function Ds(ut,pt,wt,Tt){if(!xs(pt,ut.length))return NaN;for(let Tt=pt[0];Tt<=pt[1];++Tt)if(Ni(ut[Tt],wt,!0))return 0;let St=1/0;for(let It=pt[0];It<pt[1];++It)for(const pt of wt)for(let wt=0,Lt=pt.length,Xt=Lt-1;wt<Lt;Xt=wt++){if(qi(ut[It],ut[It+1],pt[Xt],pt[wt]))return 0;St=Math.min(St,zs(ut[It],ut[It+1],pt[Xt],pt[wt],Tt))}return St}function Cs(ut,pt){for(const wt of ut)for(let ut=0;ut<=wt.length-1;++ut)if(Ni(wt[ut],pt,!0))return!0;return!1}function Rs(ut,pt,wt,Tt=1/0){const St=_s(ut),It=_s(pt);if(Tt!==1/0&&ws(St,It,wt)>=Tt)return Tt;if(Oi(St,It)){if(Cs(ut,pt))return 0}else if(Cs(pt,ut))return 0;let Lt=Tt;for(const Tt of ut)for(let ut=0,St=Tt.length,It=St-1;ut<St;It=ut++)for(const St of pt)for(let pt=0,Xt=St.length,Yt=Xt-1;pt<Xt;Yt=pt++){if(qi(Tt[It],Tt[ut],St[Yt],St[pt]))return 0;Lt=Math.min(Lt,zs(Tt[It],Tt[ut],St[Yt],St[pt],wt))}return Lt}function Vs(ut,pt,wt,Tt,St,It,Lt){if(null===It||null===Lt)return;const Xt=ws(vs(Tt,It),vs(St,Lt),wt);Xt<pt&&ut.push({dist:Xt,range1:It,range2:Lt})}function Fs(ut,pt,wt,Tt,St=1/0){let It=Math.min(Tt.distance(ut[0],wt[0][0]),St);if(0===It)return It;const Lt=new ff([{dist:0,range1:[0,ut.length-1],range2:[0,0]}],fs),Xt=pt?wf:bf,Yt=_s(wt);for(;Lt.length;){const St=Lt.pop();if(St.dist>=It)continue;const Mi=St.range1;if(gs(Mi)<=Xt){if(!xs(Mi,ut.length))return NaN;if(pt){const pt=Ds(ut,Mi,wt,Tt);if(0===(It=Math.min(It,pt)))return It}else for(let pt=Mi[0];pt<=Mi[1];++pt){const St=Bs(ut[pt],wt,Tt);if(0===(It=Math.min(It,St)))return It}}else{const wt=bs(Mi,pt);if(null!==wt[0]){const pt=ws(vs(ut,wt[0]),Yt,Tt);pt<It&&Lt.push({dist:pt,range1:wt[0],range2:[0,0]})}if(null!==wt[1]){const pt=ws(vs(ut,wt[1]),Yt,Tt);pt<It&&Lt.push({dist:pt,range1:wt[1],range2:[0,0]})}}}return It}function Ls(ut,pt,wt,Tt,St,It=1/0){let Lt=Math.min(It,St.distance(ut[0],wt[0]));if(0===Lt)return Lt;const Xt=new ff([{dist:0,range1:[0,ut.length-1],range2:[0,wt.length-1]}],fs),Yt=pt?wf:bf,Mi=Tt?wf:bf;for(;Xt.length;){const It=Xt.pop();if(It.dist>=Lt)continue;const vr=It.range1,br=It.range2;if(gs(vr)<=Yt&&gs(br)<=Mi){if(!xs(vr,ut.length)||!xs(br,wt.length))return NaN;if(pt&&Tt?Lt=Math.min(Lt,Ps(ut,vr,wt,br,St)):pt||Tt?pt&&!Tt?Lt=Math.min(Lt,ks(wt,br,ut,vr,St)):!pt&&Tt&&(Lt=Math.min(Lt,ks(ut,vr,wt,br,St))):Lt=Math.min(Lt,Es(ut,vr,wt,br,St)),0===Lt)return Lt}else{const It=bs(vr,pt),Yt=bs(br,Tt);Vs(Xt,Lt,St,ut,wt,It[0],Yt[0]),Vs(Xt,Lt,St,ut,wt,It[0],Yt[1]),Vs(Xt,Lt,St,ut,wt,It[1],Yt[0]),Vs(Xt,Lt,St,ut,wt,It[1],Yt[1])}}return Lt}function Os(ut,pt,wt,Tt,St=1/0){let It=St;const Lt=vs(ut,[0,ut.length-1]);for(const St of wt)if(!(It!==1/0&&ws(Lt,vs(St,[0,St.length-1]),Tt)>=It)&&(It=Math.min(It,Ls(ut,pt,St,!0,Tt,It)),0===It))return It;return It}function Us(ut,pt,wt,Tt,St=1/0){let It=St;const Lt=vs(ut,[0,ut.length-1]);for(const St of wt){if(It!==1/0&&ws(Lt,_s(St),Tt)>=It)continue;const wt=Fs(ut,pt,St,Tt,It);if(isNaN(wt))return wt;if(0===(It=Math.min(It,wt)))return It}return It}function Ns(ut){return"Point"===ut||"MultiPoint"===ut||"LineString"===ut||"MultiLineString"===ut||"Polygon"===ut||"MultiPolygon"===ut}class js{constructor(ut,pt){this.type=tp,this.geojson=ut,this.geometries=pt}static parse(ut,pt){if(2!==ut.length)return pt.error(`'distance' expression requires either one argument, but found ' ${ut.length-1} instead.`);if(xi(ut[1])){const pt=ut[1];if("FeatureCollection"===pt.type){for(let ut=0;ut<pt.features.length;++ut)if(Ns(pt.features[ut].geometry.type))return new js(pt,pt.features[ut].geometry)}else if("Feature"===pt.type){if(Ns(pt.geometry.type))return new js(pt,pt.geometry)}else if(Ns(pt.type))return new js(pt,pt)}return pt.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(ut){const pt=ut.geometry(),wt=ut.canonicalID();if(null!=pt&&null!=wt){if("Point"===ut.geometryType())return function(ut,pt,wt){const Tt=[];for(const wt of ut)for(const ut of wt)Tt.push(Ss(ut,pt));const St=new as(Tt[0][1],"meters");return"Point"===wt.type||"MultiPoint"===wt.type||"LineString"===wt.type?Ls(Tt,!1,"Point"===wt.type?[wt.coordinates]:wt.coordinates,"LineString"===wt.type,St):"MultiLineString"===wt.type?Os(Tt,!1,wt.coordinates,St):"Polygon"===wt.type||"MultiPolygon"===wt.type?Us(Tt,!1,"Polygon"===wt.type?[wt.coordinates]:wt.coordinates,St):null}(pt,wt,this.geometries);if("LineString"===ut.geometryType())return function(ut,pt,wt){const Tt=[];for(const wt of ut){const ut=[];for(const Tt of wt)ut.push(Ss(Tt,pt));Tt.push(ut)}const St=new as(Tt[0][0][1],"meters");if("Point"===wt.type||"MultiPoint"===wt.type||"LineString"===wt.type)return Os("Point"===wt.type?[wt.coordinates]:wt.coordinates,"LineString"===wt.type,Tt,St);if("MultiLineString"===wt.type){let ut=1/0;for(let pt=0;pt<wt.coordinates.length;pt++){const It=Os(wt.coordinates[pt],!0,Tt,St,ut);if(isNaN(It))return It;if(0===(ut=Math.min(ut,It)))return ut}return ut}if("Polygon"===wt.type||"MultiPolygon"===wt.type){let ut=1/0;for(let pt=0;pt<Tt.length;pt++){const It=Us(Tt[pt],!0,"Polygon"===wt.type?[wt.coordinates]:wt.coordinates,St,ut);if(isNaN(It))return It;if(0===(ut=Math.min(ut,It)))return ut}return ut}return null}(pt,wt,this.geometries);if("Polygon"===ut.geometryType())return function(ut,pt,wt){const Tt=[];for(const wt of function(ut,pt){const wt=ut.length;if(wt<=1)return[ut];const Tt=[];let St,It;for(let pt=0;pt<wt;pt++){const wt=Fi(ut[pt]);0!==wt&&(ut[pt].area=Math.abs(wt),void 0===It&&(It=wt<0),It===wt<0?(St&&Tt.push(St),St=[ut[pt]]):St.push(ut[pt]))}return St&&Tt.push(St),Tt}(ut)){const ut=[];for(let Tt=0;Tt<wt.length;++Tt)ut.push(Is(wt[Tt],pt));Tt.push(ut)}const St=new as(Tt[0][0][0][1],"meters");if("Point"===wt.type||"MultiPoint"===wt.type||"LineString"===wt.type)return Us("Point"===wt.type?[wt.coordinates]:wt.coordinates,"LineString"===wt.type,Tt,St);if("MultiLineString"===wt.type){let ut=1/0;for(let pt=0;pt<wt.coordinates.length;pt++){const It=Us(wt.coordinates[pt],!0,Tt,St,ut);if(isNaN(It))return It;if(0===(ut=Math.min(ut,It)))return ut}return ut}return"Polygon"===wt.type||"MultiPolygon"===wt.type?function(ut,pt,wt){let Tt=1/0;for(const St of ut)for(const ut of pt){const pt=Rs(St,ut,wt,Tt);if(isNaN(pt))return pt;if(0===(Tt=Math.min(Tt,pt)))return Tt}return Tt}("Polygon"===wt.type?[wt.coordinates]:wt.coordinates,Tt,St):null}(pt,wt,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function qs(ut,pt){switch(ut){case"string":return vi(pt);case"number":return+pt;case"boolean":return!!pt;case"color":return qn.parse(pt);case"formatted":return mi.fromString(vi(pt));case"resolvedImage":return yi.fromString(vi(pt))}return pt}function $s(ut,pt,wt,Tt){return void 0!==Tt&&(ut=Tt*Math.round(ut/Tt)),void 0!==pt&&ut<pt&&(ut=pt),void 0!==wt&&ut>wt&&(ut=wt),ut}class Gs{constructor(ut,pt,wt){this.type=ut,this.key=pt,this.scope=wt}static parse(ut,pt){let wt=pt.expectedType;if(null==wt&&(wt=yp),ut.length<2||ut.length>3)return pt.error("Invalid number of arguments for 'config' expression.");const Tt=pt.parse(ut[1],1);if(!(Tt instanceof _i))return pt.error("Key name of 'config' expression must be a string literal.");if(ut.length>=3){const St=pt.parse(ut[2],2);return St instanceof _i?new Gs(wt,vi(Tt.value),vi(St.value)):pt.error("Scope of 'config' expression must be a string literal.")}return new Gs(wt,vi(Tt.value))}evaluate(ut){const pt=[this.key,this.scope,ut.scope].filter(Boolean).join(""),wt=ut.getConfig(pt);if(!wt)return null;const{type:Tt,value:St,values:It,minValue:Lt,maxValue:Xt,stepValue:Yt}=wt,Mi=wt.default.evaluate(ut);let vr=Mi;if(St){const pt=ut.scope;ut.scope=(pt||"").split("").slice(1).join(""),vr=St.evaluate(ut),ut.scope=pt}return Tt&&(vr=qs(Tt,vr)),void 0===vr||void 0===Lt&&void 0===Xt&&void 0===Yt||("number"==typeof vr?vr=$s(vr,Lt,Xt,Yt):Array.isArray(vr)&&(vr=vr.map((ut=>"number"==typeof ut?$s(ut,Lt,Xt,Yt):ut)))),void 0!==St&&void 0!==vr&&It&&!It.includes(vr)&&(vr=Mi,Tt&&(vr=qs(Tt,vr))),(Tt&&Tt!==this.type||void 0!==vr&&bi(vr)!==this.type)&&(vr=qs(this.type.kind,vr)),vr}eachChild(){}outputDefined(){return!1}serialize(){const ut=["config",this.key];return this.scope&&ut.concat(this.key),ut}}function Xs(ut){if(ut instanceof Bi){if("get"===ut.name&&1===ut.args.length)return!1;if("feature-state"===ut.name)return!1;if("has"===ut.name&&1===ut.args.length)return!1;if("properties"===ut.name||"geometry-type"===ut.name||"id"===ut.name)return!1;if(/^filter-/.test(ut.name))return!1}if(ut instanceof es)return!1;if(ut instanceof js)return!1;let pt=!0;return ut.eachChild((ut=>{pt&&!Xs(ut)&&(pt=!1)})),pt}function Ys(ut){if(ut instanceof Bi&&"feature-state"===ut.name)return!1;let pt=!0;return ut.eachChild((ut=>{pt&&!Ys(ut)&&(pt=!1)})),pt}function Zs(ut){if(ut instanceof Gs)return!1;let pt=!0;return ut.eachChild((ut=>{pt&&!Zs(ut)&&(pt=!1)})),pt}function Hs(ut,pt){if(ut instanceof Bi&&pt.indexOf(ut.name)>=0)return!1;let wt=!0;return ut.eachChild((ut=>{wt&&!Hs(ut,pt)&&(wt=!1)})),wt}class Ks{constructor(ut,pt){this.type=pt.type,this.name=ut,this.boundExpression=pt}static parse(ut,pt){if(2!==ut.length||"string"!=typeof ut[1])return pt.error("'var' expression requires exactly one string literal argument.");const wt=ut[1];return pt.scope.has(wt)?new Ks(wt,pt.scope.get(wt)):pt.error(`Unknown variable "${wt}". Make sure "${wt}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(ut){return this.boundExpression.evaluate(ut)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ws{constructor(ut,pt=[],wt,Tt=new Kn,St=[],It,Lt){this.registry=ut,this.path=pt,this.key=pt.map((ut=>`[${ut}]`)).join(""),this.scope=Tt,this.errors=St,this.expectedType=wt,this._scope=It,this.options=Lt}parse(ut,pt,wt,Tt,St={}){return pt||wt?this.concat(pt,wt,Tt)._parse(ut,St):this._parse(ut,St)}_parse(ut,pt){function r(ut,pt,wt){return"assert"===wt?new Ai(pt,[ut]):"coerce"===wt?new zi(pt,[ut]):ut}if(null!==ut&&"string"!=typeof ut&&"boolean"!=typeof ut&&"number"!=typeof ut||(ut=["literal",ut]),Array.isArray(ut)){if(0===ut.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const wt="string"==typeof ut[0]?this.registry[ut[0]]:void 0;if(wt){let Tt=wt.parse(ut,this);if(!Tt)return null;if(this.expectedType){const ut=this.expectedType,wt=Tt.type;if("string"!==ut.kind&&"number"!==ut.kind&&"boolean"!==ut.kind&&"object"!==ut.kind&&"array"!==ut.kind||"value"!==wt.kind)if("color"!==ut.kind&&"formatted"!==ut.kind&&"resolvedImage"!==ut.kind||"value"!==wt.kind&&"string"!==wt.kind){if(this.checkSubtype(ut,wt))return null}else Tt=r(Tt,ut,pt.typeAnnotation||"coerce");else Tt=r(Tt,ut,pt.typeAnnotation||"assert")}if(!(Tt instanceof _i)&&"resolvedImage"!==Tt.type.kind&&Qs(Tt)){const pt=new Ei(this._scope,this.options);try{Tt=new _i(Tt.type,Tt.evaluate(pt))}catch(ut){return this.error(ut.message),null}}return Tt}return zi.parse(["to-array",ut],this)}return this.error(void 0===ut?"'undefined' value invalid. Use null instead.":"object"==typeof ut?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof ut} instead.`)}concat(ut,pt,wt){const Tt="number"==typeof ut?this.path.concat(ut):this.path,St=wt?this.scope.concat(wt):this.scope;return new Ws(this.registry,Tt,pt||null,St,this.errors,this._scope,this.options)}error(ut,...pt){const wt=`${this.key}${pt.map((ut=>`[${ut}]`)).join("")}`;this.errors.push(new Hn(wt,ut))}checkSubtype(ut,pt){const wt=ci(ut,pt);return wt&&this.error(wt),wt}}var Sf=Ws;function Qs(ut){if(ut instanceof Ks)return Qs(ut.boundExpression);if(ut instanceof Bi&&"error"===ut.name)return!1;if(ut instanceof Ci)return!1;if(ut instanceof es)return!1;if(ut instanceof js)return!1;if(ut instanceof Gs)return!1;const pt=ut instanceof zi||ut instanceof Ai;let wt=!0;return ut.eachChild((ut=>{wt=pt?wt&&Qs(ut):wt&&ut instanceof _i})),!!wt&&Xs(ut)&&Hs(ut,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function ta(ut,pt){const wt=ut.length-1;let Tt,St,It=0,Lt=wt,Xt=0;for(;It<=Lt;)if(Xt=Math.floor((It+Lt)/2),Tt=ut[Xt],St=ut[Xt+1],Tt<=pt){if(Xt===wt||pt<St)return Xt;It=Xt+1}else{if(!(Tt>pt))throw new wi("Input is not a number.");Lt=Xt-1}return 0}class ea{constructor(ut,pt,wt){this.type=ut,this.input=pt,this.labels=[],this.outputs=[];for(const[ut,pt]of wt)this.labels.push(ut),this.outputs.push(pt)}static parse(ut,pt){if(ut.length-1<4)return pt.error(`Expected at least 4 arguments, but found only ${ut.length-1}.`);if((ut.length-1)%2!=0)return pt.error("Expected an even number of arguments.");const wt=pt.parse(ut[1],1,tp);if(!wt)return null;const Tt=[];let St=null;pt.expectedType&&"value"!==pt.expectedType.kind&&(St=pt.expectedType);for(let wt=1;wt<ut.length;wt+=2){const It=1===wt?-1/0:ut[wt],Lt=ut[wt+1],Xt=wt,Yt=wt+1;if("number"!=typeof It)return pt.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Xt);if(Tt.length&&Tt[Tt.length-1][0]>=It)return pt.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',Xt);const Mi=pt.parse(Lt,Yt,St);if(!Mi)return null;St=St||Mi.type,Tt.push([It,Mi])}return new ea(St,wt,Tt)}evaluate(ut){const pt=this.labels,wt=this.outputs;if(1===pt.length)return wt[0].evaluate(ut);const Tt=this.input.evaluate(ut);if(Tt<=pt[0])return wt[0].evaluate(ut);const St=pt.length;return Tt>=pt[St-1]?wt[St-1].evaluate(ut):wt[ta(pt,Tt)].evaluate(ut)}eachChild(ut){ut(this.input);for(const pt of this.outputs)ut(pt)}outputDefined(){return this.outputs.every((ut=>ut.outputDefined()))}serialize(){const ut=["step",this.input.serialize()];for(let pt=0;pt<this.labels.length;pt++)pt>0&&ut.push(this.labels[pt]),ut.push(this.outputs[pt].serialize());return ut}}const Af=.95047,Hf=1.08883,rm=4/29,nm=6/29,cm=3*nm*nm,hm=nm*nm*nm,dm=Math.PI/180,pm=180/Math.PI;function ca(ut){return ut>hm?Math.pow(ut,1/3):ut/cm+rm}function ha(ut){return ut>nm?ut*ut*ut:cm*(ut-rm)}function pa(ut){return 255*(ut<=.0031308?12.92*ut:1.055*Math.pow(ut,1/2.4)-.055)}function fa(ut){return(ut/=255)<=.04045?ut/12.92:Math.pow((ut+.055)/1.055,2.4)}function da(ut){const pt=fa(ut.r),wt=fa(ut.g),Tt=fa(ut.b),St=ca((.4124564*pt+.3575761*wt+.1804375*Tt)/Af),It=ca((.2126729*pt+.7151522*wt+.072175*Tt)/1);return{l:116*It-16,a:500*(St-It),b:200*(It-ca((.0193339*pt+.119192*wt+.9503041*Tt)/Hf)),alpha:ut.a}}function ma(ut){let pt=(ut.l+16)/116,wt=isNaN(ut.a)?pt:pt+ut.a/500,Tt=isNaN(ut.b)?pt:pt-ut.b/200;return pt=1*ha(pt),wt=Af*ha(wt),Tt=Hf*ha(Tt),new qn(pa(3.2404542*wt-1.5371385*pt-.4985314*Tt),pa(-.969266*wt+1.8760108*pt+.041556*Tt),pa(.0556434*wt-.2040259*pt+1.0572252*Tt),ut.alpha)}function ya(ut,pt,wt){const Tt=pt-ut;return ut+wt*(Tt>180||Tt<-180?Tt-360*Math.round(Tt/360):Tt)}const mm={forward:da,reverse:ma,interpolate:function(ut,pt,wt){return{l:Gn(ut.l,pt.l,wt),a:Gn(ut.a,pt.a,wt),b:Gn(ut.b,pt.b,wt),alpha:Gn(ut.alpha,pt.alpha,wt)}}},ym={forward:function(ut){const{l:pt,a:wt,b:Tt}=da(ut),St=Math.atan2(Tt,wt)*pm;return{h:St<0?St+360:St,c:Math.sqrt(wt*wt+Tt*Tt),l:pt,alpha:ut.a}},reverse:function(ut){const pt=ut.h*dm,wt=ut.c;return ma({l:ut.l,a:Math.cos(pt)*wt,b:Math.sin(pt)*wt,alpha:ut.alpha})},interpolate:function(ut,pt,wt){return{h:ya(ut.h,pt.h,wt),c:Gn(ut.c,pt.c,wt),l:Gn(ut.l,pt.l,wt),alpha:Gn(ut.alpha,pt.alpha,wt)}}};var Dm=Object.freeze({__proto__:null,hcl:ym,lab:mm});class va{constructor(ut,pt,wt,Tt,St){this.type=ut,this.operator=pt,this.interpolation=wt,this.input=Tt,this.labels=[],this.outputs=[];for(const[ut,pt]of St)this.labels.push(ut),this.outputs.push(pt)}static interpolationFactor(ut,pt,wt,Tt){let St=0;if("exponential"===ut.name)St=_a(pt,ut.base,wt,Tt);else if("linear"===ut.name)St=_a(pt,1,wt,Tt);else if("cubic-bezier"===ut.name){const It=ut.controlPoints;St=new fc(It[0],It[1],It[2],It[3]).solve(_a(pt,1,wt,Tt))}return St}static parse(ut,pt){let[wt,Tt,St,...It]=ut;if(!Array.isArray(Tt)||0===Tt.length)return pt.error("Expected an interpolation type expression.",1);if("linear"===Tt[0])Tt={name:"linear"};else if("exponential"===Tt[0]){const ut=Tt[1];if("number"!=typeof ut)return pt.error("Exponential interpolation requires a numeric base.",1,1);Tt={name:"exponential",base:ut}}else{if("cubic-bezier"!==Tt[0])return pt.error(`Unknown interpolation type ${String(Tt[0])}`,1,0);{const ut=Tt.slice(1);if(4!==ut.length||ut.some((ut=>"number"!=typeof ut||ut<0||ut>1)))return pt.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);Tt={name:"cubic-bezier",controlPoints:ut}}}if(ut.length-1<4)return pt.error(`Expected at least 4 arguments, but found only ${ut.length-1}.`);if((ut.length-1)%2!=0)return pt.error("Expected an even number of arguments.");if(St=pt.parse(St,2,tp),!St)return null;const Lt=[];let Xt=null;"interpolate-hcl"===wt||"interpolate-lab"===wt?Xt=mp:pt.expectedType&&"value"!==pt.expectedType.kind&&(Xt=pt.expectedType);for(let ut=0;ut<It.length;ut+=2){const wt=It[ut],Tt=It[ut+1],St=ut+3,Yt=ut+4;if("number"!=typeof wt)return pt.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',St);if(Lt.length&&Lt[Lt.length-1][0]>=wt)return pt.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',St);const Mi=pt.parse(Tt,Yt,Xt);if(!Mi)return null;Xt=Xt||Mi.type,Lt.push([wt,Mi])}return"number"===Xt.kind||"color"===Xt.kind||"array"===Xt.kind&&"number"===Xt.itemType.kind&&"number"==typeof Xt.N?new va(Xt,wt,Tt,St,Lt):pt.error(`Type ${li(Xt)} is not interpolatable.`)}evaluate(ut){const pt=this.labels,wt=this.outputs;if(1===pt.length)return wt[0].evaluate(ut);const Tt=this.input.evaluate(ut);if(Tt<=pt[0])return wt[0].evaluate(ut);const St=pt.length;if(Tt>=pt[St-1])return wt[St-1].evaluate(ut);const It=ta(pt,Tt),Lt=va.interpolationFactor(this.interpolation,Tt,pt[It],pt[It+1]),Xt=wt[It].evaluate(ut),Yt=wt[It+1].evaluate(ut);return"interpolate"===this.operator?Qd[this.type.kind.toLowerCase()](Xt,Yt,Lt):"interpolate-hcl"===this.operator?ym.reverse(ym.interpolate(ym.forward(Xt),ym.forward(Yt),Lt)):mm.reverse(mm.interpolate(mm.forward(Xt),mm.forward(Yt),Lt))}eachChild(ut){ut(this.input);for(const pt of this.outputs)ut(pt)}outputDefined(){return this.outputs.every((ut=>ut.outputDefined()))}serialize(){let ut;ut="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const pt=[this.operator,ut,this.input.serialize()];for(let ut=0;ut<this.labels.length;ut++)pt.push(this.labels[ut],this.outputs[ut].serialize());return pt}}function _a(ut,pt,wt,Tt){const St=Tt-wt,It=ut-wt;return 0===St?0:1===pt?It/St:(Math.pow(pt,It)-1)/(Math.pow(pt,St)-1)}class wa{constructor(ut,pt){this.type=ut,this.args=pt}static parse(ut,pt){if(ut.length<2)return pt.error("Expectected at least one argument.");let wt=null;const Tt=pt.expectedType;Tt&&"value"!==Tt.kind&&(wt=Tt);const St=[];for(const Tt of ut.slice(1)){const ut=pt.parse(Tt,1+St.length,wt,void 0,{typeAnnotation:"omit"});if(!ut)return null;wt=wt||ut.type,St.push(ut)}const It=Tt&&St.some((ut=>ci(Tt,ut.type)));return new wa(It?yp:wt,St)}evaluate(ut){let pt,wt=null,Tt=0;for(const St of this.args){if(Tt++,wt=St.evaluate(ut),wt&&wt instanceof yi&&!wt.available&&(pt||(pt=wt),wt=null,Tt===this.args.length))return pt;if(null!==wt)break}return wt}eachChild(ut){this.args.forEach(ut)}outputDefined(){return this.args.every((ut=>ut.outputDefined()))}serialize(){const ut=["coalesce"];return this.eachChild((pt=>{ut.push(pt.serialize())})),ut}}class Ma{constructor(ut,pt){this.type=pt.type,this.bindings=[].concat(ut),this.result=pt}evaluate(ut){return this.result.evaluate(ut)}eachChild(ut){for(const pt of this.bindings)ut(pt[1]);ut(this.result)}static parse(ut,pt){if(ut.length<4)return pt.error(`Expected at least 3 arguments, but found ${ut.length-1} instead.`);const wt=[];for(let Tt=1;Tt<ut.length-1;Tt+=2){const St=ut[Tt];if("string"!=typeof St)return pt.error(`Expected string, but found ${typeof St} instead.`,Tt);if(/[^a-zA-Z0-9_]/.test(St))return pt.error("Variable names must contain only alphanumeric characters or '_'.",Tt);const It=pt.parse(ut[Tt+1],Tt+1);if(!It)return null;wt.push([St,It])}const Tt=pt.parse(ut[ut.length-1],ut.length-1,pt.expectedType,wt);return Tt?new Ma(wt,Tt):null}outputDefined(){return this.result.outputDefined()}serialize(){const ut=["let"];for(const[pt,wt]of this.bindings)ut.push(pt,wt.serialize());return ut.push(this.result.serialize()),ut}}class Aa{constructor(ut,pt,wt){this.type=ut,this.index=pt,this.input=wt}static parse(ut,pt){if(3!==ut.length)return pt.error(`Expected 2 arguments, but found ${ut.length-1} instead.`);const wt=pt.parse(ut[1],1,tp),Tt=pt.parse(ut[2],2,oi(pt.expectedType||yp));return wt&&Tt?new Aa(Tt.type.itemType,wt,Tt):null}evaluate(ut){const pt=this.index.evaluate(ut),wt=this.input.evaluate(ut);if(pt<0)throw new wi(`Array index out of bounds: ${pt} < 0.`);if(pt>=wt.length)throw new wi(`Array index out of bounds: ${pt} > ${wt.length-1}.`);if(pt!==Math.floor(pt))throw new wi(`Array index must be an integer, but found ${pt} instead.`);return wt[pt]}eachChild(ut){ut(this.index),ut(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Sa{constructor(ut,pt){this.type=ap,this.needle=ut,this.haystack=pt}static parse(ut,pt){if(3!==ut.length)return pt.error(`Expected 2 arguments, but found ${ut.length-1} instead.`);const wt=pt.parse(ut[1],1,yp),Tt=pt.parse(ut[2],2,yp);return wt&&Tt?hi(wt.type,[ap,sp,tp,ep,yp])?new Sa(wt,Tt):pt.error(`Expected first argument to be of type boolean, string, number or null, but found ${li(wt.type)} instead`):null}evaluate(ut){const pt=this.needle.evaluate(ut),wt=this.haystack.evaluate(ut);if(null==wt)return!1;if(!pi(pt,["boolean","string","number","null"]))throw new wi(`Expected first argument to be of type boolean, string, number or null, but found ${li(bi(pt))} instead.`);if(!pi(wt,["string","array"]))throw new wi(`Expected second argument to be of type array or string, but found ${li(bi(wt))} instead.`);return wt.indexOf(pt)>=0}eachChild(ut){ut(this.needle),ut(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ia{constructor(ut,pt,wt){this.type=tp,this.needle=ut,this.haystack=pt,this.fromIndex=wt}static parse(ut,pt){if(ut.length<=2||ut.length>=5)return pt.error(`Expected 3 or 4 arguments, but found ${ut.length-1} instead.`);const wt=pt.parse(ut[1],1,yp),Tt=pt.parse(ut[2],2,yp);if(!wt||!Tt)return null;if(!hi(wt.type,[ap,sp,tp,ep,yp]))return pt.error(`Expected first argument to be of type boolean, string, number or null, but found ${li(wt.type)} instead`);if(4===ut.length){const St=pt.parse(ut[3],3,tp);return St?new Ia(wt,Tt,St):null}return new Ia(wt,Tt)}evaluate(ut){const pt=this.needle.evaluate(ut),wt=this.haystack.evaluate(ut);if(!pi(pt,["boolean","string","number","null"]))throw new wi(`Expected first argument to be of type boolean, string, number or null, but found ${li(bi(pt))} instead.`);if(!pi(wt,["string","array"]))throw new wi(`Expected second argument to be of type array or string, but found ${li(bi(wt))} instead.`);if(this.fromIndex){const Tt=this.fromIndex.evaluate(ut);return wt.indexOf(pt,Tt)}return wt.indexOf(pt)}eachChild(ut){ut(this.needle),ut(this.haystack),this.fromIndex&&ut(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const ut=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),ut]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Ta{constructor(ut,pt,wt,Tt,St,It){this.inputType=ut,this.type=pt,this.input=wt,this.cases=Tt,this.outputs=St,this.otherwise=It}static parse(ut,pt){if(ut.length<5)return pt.error(`Expected at least 4 arguments, but found only ${ut.length-1}.`);if(ut.length%2!=1)return pt.error("Expected an even number of arguments.");let wt,Tt;pt.expectedType&&"value"!==pt.expectedType.kind&&(Tt=pt.expectedType);const St={},It=[];for(let Lt=2;Lt<ut.length-1;Lt+=2){let Xt=ut[Lt];const Yt=ut[Lt+1];Array.isArray(Xt)||(Xt=[Xt]);const Mi=pt.concat(Lt);if(0===Xt.length)return Mi.error("Expected at least one branch label.");for(const ut of Xt){if("number"!=typeof ut&&"string"!=typeof ut)return Mi.error("Branch labels must be numbers or strings.");if("number"==typeof ut&&Math.abs(ut)>Number.MAX_SAFE_INTEGER)return Mi.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof ut&&Math.floor(ut)!==ut)return Mi.error("Numeric branch labels must be integer values.");if(wt){if(Mi.checkSubtype(wt,bi(ut)))return null}else wt=bi(ut);if(void 0!==St[String(ut)])return Mi.error("Branch labels must be unique.");St[String(ut)]=It.length}const vr=pt.parse(Yt,Lt,Tt);if(!vr)return null;Tt=Tt||vr.type,It.push(vr)}const Lt=pt.parse(ut[1],1,yp);if(!Lt)return null;const Xt=pt.parse(ut[ut.length-1],ut.length-1,Tt);return Xt?"value"!==Lt.type.kind&&pt.concat(1).checkSubtype(wt,Lt.type)?null:new Ta(wt,Tt,Lt,St,It,Xt):null}evaluate(ut){const pt=this.input.evaluate(ut);return(bi(pt)===this.inputType&&this.outputs[this.cases[pt]]||this.otherwise).evaluate(ut)}eachChild(ut){ut(this.input),this.outputs.forEach(ut),ut(this.otherwise)}outputDefined(){return this.outputs.every((ut=>ut.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const ut=["match",this.input.serialize()],pt=Object.keys(this.cases).sort(),wt=[],Tt={};for(const ut of pt){const pt=Tt[this.cases[ut]];void 0===pt?(Tt[this.cases[ut]]=wt.length,wt.push([this.cases[ut],[ut]])):wt[pt][1].push(ut)}const i=ut=>"number"===this.inputType.kind?Number(ut):ut;for(const[pt,Tt]of wt)ut.push(1===Tt.length?i(Tt[0]):Tt.map(i)),ut.push(this.outputs[pt].serialize());return ut.push(this.otherwise.serialize()),ut}}class ka{constructor(ut,pt,wt){this.type=ut,this.branches=pt,this.otherwise=wt}static parse(ut,pt){if(ut.length<4)return pt.error(`Expected at least 3 arguments, but found only ${ut.length-1}.`);if(ut.length%2!=0)return pt.error("Expected an odd number of arguments.");let wt;pt.expectedType&&"value"!==pt.expectedType.kind&&(wt=pt.expectedType);const Tt=[];for(let St=1;St<ut.length-1;St+=2){const It=pt.parse(ut[St],St,ap);if(!It)return null;const Lt=pt.parse(ut[St+1],St+1,wt);if(!Lt)return null;Tt.push([It,Lt]),wt=wt||Lt.type}const St=pt.parse(ut[ut.length-1],ut.length-1,wt);return St?new ka(wt,Tt,St):null}evaluate(ut){for(const[pt,wt]of this.branches)if(pt.evaluate(ut))return wt.evaluate(ut);return this.otherwise.evaluate(ut)}eachChild(ut){for(const[pt,wt]of this.branches)ut(pt),ut(wt);ut(this.otherwise)}outputDefined(){return this.branches.every((([ut,pt])=>pt.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const ut=["case"];return this.eachChild((pt=>{ut.push(pt.serialize())})),ut}}class za{constructor(ut,pt,wt,Tt){this.type=ut,this.input=pt,this.beginIndex=wt,this.endIndex=Tt}static parse(ut,pt){if(ut.length<=2||ut.length>=5)return pt.error(`Expected 3 or 4 arguments, but found ${ut.length-1} instead.`);const wt=pt.parse(ut[1],1,yp),Tt=pt.parse(ut[2],2,tp);if(!wt||!Tt)return null;if(!hi(wt.type,[oi(yp),sp,yp]))return pt.error(`Expected first argument to be of type array or string, but found ${li(wt.type)} instead`);if(4===ut.length){const St=pt.parse(ut[3],3,tp);return St?new za(wt.type,wt,Tt,St):null}return new za(wt.type,wt,Tt)}evaluate(ut){const pt=this.input.evaluate(ut),wt=this.beginIndex.evaluate(ut);if(!pi(pt,["string","array"]))throw new wi(`Expected first argument to be of type array or string, but found ${li(bi(pt))} instead.`);if(this.endIndex){const Tt=this.endIndex.evaluate(ut);return pt.slice(wt,Tt)}return pt.slice(wt)}eachChild(ut){ut(this.input),ut(this.beginIndex),this.endIndex&&ut(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const ut=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),ut]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Pa(ut,pt){return"=="===ut||"!="===ut?"boolean"===pt.kind||"string"===pt.kind||"number"===pt.kind||"null"===pt.kind||"value"===pt.kind:"string"===pt.kind||"number"===pt.kind||"value"===pt.kind}function Ea(ut,pt,wt,Tt){return 0===Tt.compare(pt,wt)}function Ba(ut,pt,wt){const Tt="=="!==ut&&"!="!==ut;return class i{constructor(ut,pt,wt){this.type=ap,this.lhs=ut,this.rhs=pt,this.collator=wt,this.hasUntypedArgument="value"===ut.type.kind||"value"===pt.type.kind}static parse(ut,pt){if(3!==ut.length&&4!==ut.length)return pt.error("Expected two or three arguments.");const wt=ut[0];let St=pt.parse(ut[1],1,yp);if(!St)return null;if(!Pa(wt,St.type))return pt.concat(1).error(`"${wt}" comparisons are not supported for type '${li(St.type)}'.`);let It=pt.parse(ut[2],2,yp);if(!It)return null;if(!Pa(wt,It.type))return pt.concat(2).error(`"${wt}" comparisons are not supported for type '${li(It.type)}'.`);if(St.type.kind!==It.type.kind&&"value"!==St.type.kind&&"value"!==It.type.kind)return pt.error(`Cannot compare types '${li(St.type)}' and '${li(It.type)}'.`);Tt&&("value"===St.type.kind&&"value"!==It.type.kind?St=new Ai(It.type,[St]):"value"!==St.type.kind&&"value"===It.type.kind&&(It=new Ai(St.type,[It])));let Lt=null;if(4===ut.length){if("string"!==St.type.kind&&"string"!==It.type.kind&&"value"!==St.type.kind&&"value"!==It.type.kind)return pt.error("Cannot use collator to compare non-string types.");if(Lt=pt.parse(ut[3],3,xp),!Lt)return null}return new i(St,It,Lt)}evaluate(St){const It=this.lhs.evaluate(St),Lt=this.rhs.evaluate(St);if(Tt&&this.hasUntypedArgument){const pt=bi(It),wt=bi(Lt);if(pt.kind!==wt.kind||"string"!==pt.kind&&"number"!==pt.kind)throw new wi(`Expected arguments for "${ut}" to be (string, string) or (number, number), but found (${pt.kind}, ${wt.kind}) instead.`)}if(this.collator&&!Tt&&this.hasUntypedArgument){const ut=bi(It),wt=bi(Lt);if("string"!==ut.kind||"string"!==wt.kind)return pt(St,It,Lt)}return this.collator?wt(St,It,Lt,this.collator.evaluate(St)):pt(St,It,Lt)}eachChild(ut){ut(this.lhs),ut(this.rhs),this.collator&&ut(this.collator)}outputDefined(){return!0}serialize(){const pt=[ut];return this.eachChild((ut=>{pt.push(ut.serialize())})),pt}}}const Om=Ba("==",(function(ut,pt,wt){return pt===wt}),Ea),Bm=Ba("!=",(function(ut,pt,wt){return pt!==wt}),(function(ut,pt,wt,Tt){return!Ea(0,pt,wt,Tt)})),Um=Ba("<",(function(ut,pt,wt){return pt<wt}),(function(ut,pt,wt,Tt){return Tt.compare(pt,wt)<0})),$m=Ba(">",(function(ut,pt,wt){return pt>wt}),(function(ut,pt,wt,Tt){return Tt.compare(pt,wt)>0})),Hm=Ba("<=",(function(ut,pt,wt){return pt<=wt}),(function(ut,pt,wt,Tt){return Tt.compare(pt,wt)<=0})),Xm=Ba(">=",(function(ut,pt,wt){return pt>=wt}),(function(ut,pt,wt,Tt){return Tt.compare(pt,wt)>=0}));class Oa{constructor(ut,pt,wt,Tt,St,It){this.type=sp,this.number=ut,this.locale=pt,this.currency=wt,this.unit=Tt,this.minFractionDigits=St,this.maxFractionDigits=It}static parse(ut,pt){if(3!==ut.length)return pt.error("Expected two arguments.");const wt=pt.parse(ut[1],1,tp);if(!wt)return null;const Tt=ut[2];if("object"!=typeof Tt||Array.isArray(Tt))return pt.error("NumberFormat options argument must be an object.");let St=null;if(Tt.locale&&(St=pt.parse(Tt.locale,1,sp),!St))return null;let It=null;if(Tt.currency&&(It=pt.parse(Tt.currency,1,sp),!It))return null;let Lt=null;if(Tt.unit&&(Lt=pt.parse(Tt.unit,1,sp),!Lt))return null;let Xt=null;if(Tt["min-fraction-digits"]&&(Xt=pt.parse(Tt["min-fraction-digits"],1,tp),!Xt))return null;let Yt=null;return Tt["max-fraction-digits"]&&(Yt=pt.parse(Tt["max-fraction-digits"],1,tp),!Yt)?null:new Oa(wt,St,It,Lt,Xt,Yt)}evaluate(ut){return new Intl.NumberFormat(this.locale?this.locale.evaluate(ut):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(ut):void 0,unit:this.unit?this.unit.evaluate(ut):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(ut):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(ut):void 0}).format(this.number.evaluate(ut))}eachChild(ut){ut(this.number),this.locale&&ut(this.locale),this.currency&&ut(this.currency),this.unit&&ut(this.unit),this.minFractionDigits&&ut(this.minFractionDigits),this.maxFractionDigits&&ut(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const ut={};return this.locale&&(ut.locale=this.locale.serialize()),this.currency&&(ut.currency=this.currency.serialize()),this.unit&&(ut.unit=this.unit.serialize()),this.minFractionDigits&&(ut["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(ut["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),ut]}}class Ua{constructor(ut){this.type=tp,this.input=ut}static parse(ut,pt){if(2!==ut.length)return pt.error(`Expected 1 argument, but found ${ut.length-1} instead.`);const wt=pt.parse(ut[1],1);return wt?"array"!==wt.type.kind&&"string"!==wt.type.kind&&"value"!==wt.type.kind?pt.error(`Expected argument of type string or array, but found ${li(wt.type)} instead.`):new Ua(wt):null}evaluate(ut){const pt=this.input.evaluate(ut);if("string"==typeof pt)return pt.length;if(Array.isArray(pt))return pt.length;throw new wi(`Expected value to be of type string or array, but found ${li(bi(pt))} instead.`)}eachChild(ut){ut(this.input)}outputDefined(){return!1}serialize(){const ut=["length"];return this.eachChild((pt=>{ut.push(pt.serialize())})),ut}}function Na(ut){return function(){ut=1831565813+(ut|=0)|0;let pt=Math.imul(ut^ut>>>15,1|ut);return pt=pt+Math.imul(pt^pt>>>7,61|pt)^pt,((pt^pt>>>14)>>>0)/4294967296}}const Qm={"==":Om,"!=":Bm,">":$m,"<":Um,">=":Xm,"<=":Hm,array:Ai,at:Aa,boolean:Ai,case:ka,coalesce:wa,collator:Ci,format:Si,image:Ii,in:Sa,"index-of":Ia,interpolate:va,"interpolate-hcl":va,"interpolate-lab":va,length:Ua,let:Ma,literal:_i,match:Ta,number:Ai,"number-format":Oa,object:Ai,slice:za,step:ea,string:Ai,"to-boolean":zi,"to-color":zi,"to-number":zi,"to-string":zi,var:Ks,within:es,distance:js,config:Gs};function qa(ut,[pt,wt,Tt,St]){pt=pt.evaluate(ut),wt=wt.evaluate(ut),Tt=Tt.evaluate(ut);const It=St?St.evaluate(ut):1,Lt=gi(pt,wt,Tt,It);if(Lt)throw new wi(Lt);return new qn(pt/255*It,wt/255*It,Tt/255*It,It)}function $a(ut,[pt,wt,Tt,St]){pt=pt.evaluate(ut),wt=wt.evaluate(ut),Tt=Tt.evaluate(ut);const It=St?St.evaluate(ut):1,Lt=function(ut,pt,wt,Tt){return"number"==typeof ut&&ut>=0&&ut<=360?"number"==typeof pt&&pt>=0&&pt<=100&&"number"==typeof wt&&wt>=0&&wt<=100?void 0===Tt||"number"==typeof Tt&&Tt>=0&&Tt<=1?null:`Invalid hsla value [${[ut,pt,wt,Tt].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof Tt?[ut,pt,wt,Tt]:[ut,pt,wt]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof Tt?[ut,pt,wt,Tt]:[ut,pt,wt]).join(", ")}]: 'h' must be between 0 and 360.`}(pt,wt,Tt,It);if(Lt)throw new wi(Lt);const Xt=`hsla(${pt}, ${wt}%, ${Tt}%, ${It})`,Yt=qn.parse(Xt);if(!Yt)throw new wi(`Failed to parse HSLA color: ${Xt}`);return Yt}function Ga(ut,pt){return ut in pt}function Xa(ut,pt){const wt=pt[ut];return void 0===wt?null:wt}function Ya(ut){return{type:ut}}function Za(ut){return{result:"success",value:ut}}function Ha(ut){return{result:"error",value:ut}}function Ka(ut,pt){return!!ut&&!!ut.parameters&&ut.parameters.indexOf(pt)>-1}function Wa(ut){return"data-driven"===ut["property-type"]}function Ja(ut){return Ka(ut.expression,"measure-light")}function Qa(ut){return Ka(ut.expression,"zoom")}function to(ut){return!!ut.expression&&ut.expression.interpolated}function eo(ut){return"object"==typeof ut&&null!==ut&&!Array.isArray(ut)}function ro(ut){return ut}function no(ut,pt){const wt="color"===pt.type,Tt=ut.stops&&"object"==typeof ut.stops[0][0],St=Tt||!(Tt||void 0!==ut.property),It=ut.type||(to(pt)?"exponential":"interval");if(wt&&((ut=Zn({},ut)).stops&&(ut.stops=ut.stops.map((ut=>[ut[0],qn.parse(ut[1])]))),ut.default=qn.parse(ut.default?ut.default:pt.default)),ut.colorSpace&&"rgb"!==ut.colorSpace&&!Dm[ut.colorSpace])throw new Error(`Unknown color space: ${ut.colorSpace}`);let Lt,Xt,Yt;if("exponential"===It)Lt=oo;else if("interval"===It)Lt=ao;else if("categorical"===It){Lt=so,Xt=Object.create(null);for(const pt of ut.stops)Xt[pt[0]]=pt[1];Yt=typeof ut.stops[0][0]}else{if("identity"!==It)throw new Error(`Unknown function type "${It}"`);Lt=lo}if(Tt){const wt={},Tt=[];for(let pt=0;pt<ut.stops.length;pt++){const St=ut.stops[pt],It=St[0].zoom;void 0===wt[It]&&(wt[It]={zoom:It,type:ut.type,property:ut.property,default:ut.default,stops:[]},Tt.push(It)),wt[It].stops.push([St[0].value,St[1]])}const St=[];for(const ut of Tt)St.push([wt[ut].zoom,no(wt[ut],pt)]);const It={name:"linear"};return{kind:"composite",interpolationType:It,interpolationFactor:va.interpolationFactor.bind(void 0,It),zoomStops:St.map((ut=>ut[0])),evaluate:({zoom:wt},Tt)=>oo({stops:St,base:ut.base},pt,wt).evaluate(wt,Tt)}}if(St){const wt="exponential"===It?{name:"exponential",base:void 0!==ut.base?ut.base:1}:null;return{kind:"camera",interpolationType:wt,interpolationFactor:va.interpolationFactor.bind(void 0,wt),zoomStops:ut.stops.map((ut=>ut[0])),evaluate:({zoom:wt})=>Lt(ut,pt,wt,Xt,Yt)}}return{kind:"source",evaluate(wt,Tt){const St=Tt&&Tt.properties?Tt.properties[ut.property]:void 0;return void 0===St?io(ut.default,pt.default):Lt(ut,pt,St,Xt,Yt)}}}function io(ut,pt,wt){return void 0!==ut?ut:void 0!==pt?pt:void 0!==wt?wt:void 0}function so(ut,pt,wt,Tt,St){return io(typeof wt===St?Tt[wt]:void 0,ut.default,pt.default)}function ao(ut,pt,wt){if("number"!==Ti(wt))return io(ut.default,pt.default);const Tt=ut.stops.length;if(1===Tt)return ut.stops[0][1];if(wt<=ut.stops[0][0])return ut.stops[0][1];if(wt>=ut.stops[Tt-1][0])return ut.stops[Tt-1][1];const St=ta(ut.stops.map((ut=>ut[0])),wt);return ut.stops[St][1]}function oo(ut,pt,wt){const Tt=void 0!==ut.base?ut.base:1;if("number"!==Ti(wt))return io(ut.default,pt.default);const St=ut.stops.length;if(1===St)return ut.stops[0][1];if(wt<=ut.stops[0][0])return ut.stops[0][1];if(wt>=ut.stops[St-1][0])return ut.stops[St-1][1];const It=ta(ut.stops.map((ut=>ut[0])),wt),Lt=function(ut,pt,wt,Tt){const St=Tt-wt,It=ut-wt;return 0===St?0:1===pt?It/St:(Math.pow(pt,It)-1)/(Math.pow(pt,St)-1)}(wt,Tt,ut.stops[It][0],ut.stops[It+1][0]),Xt=ut.stops[It][1],Yt=ut.stops[It+1][1];let Mi=Qd[pt.type]||ro;if(ut.colorSpace&&"rgb"!==ut.colorSpace){const pt=Dm[ut.colorSpace];Mi=(ut,wt)=>pt.reverse(pt.interpolate(pt.forward(ut),pt.forward(wt),Lt))}return"function"==typeof Xt.evaluate?{evaluate(...ut){const pt=Xt.evaluate.apply(void 0,ut),wt=Yt.evaluate.apply(void 0,ut);if(void 0!==pt&&void 0!==wt)return Mi(pt,wt,Lt)}}:Mi(Xt,Yt,Lt)}function lo(ut,pt,wt){return"color"===pt.type?wt=qn.parse(wt):"formatted"===pt.type?wt=mi.fromString(wt.toString()):"resolvedImage"===pt.type?wt=yi.fromString(wt.toString()):Ti(wt)===pt.type||"enum"===pt.type&&pt.values[wt]||(wt=void 0),io(wt,ut.default,pt.default)}Bi.register(Qm,{error:[{kind:"error"},[sp],(ut,[pt])=>{throw new wi(pt.evaluate(ut))}],typeof:[sp,[yp],(ut,[pt])=>li(bi(pt.evaluate(ut)))],"to-rgba":[oi(tp,4),[mp],(ut,[pt])=>pt.evaluate(ut).toRenderColor(null).toArray()],rgb:[mp,[tp,tp,tp],qa],rgba:[mp,[tp,tp,tp,tp],qa],hsl:[mp,[tp,tp,tp],$a],hsla:[mp,[tp,tp,tp,tp],$a],has:{type:ap,overloads:[[[sp],(ut,[pt])=>Ga(pt.evaluate(ut),ut.properties())],[[sp,_p],(ut,[pt,wt])=>Ga(pt.evaluate(ut),wt.evaluate(ut))]]},get:{type:yp,overloads:[[[sp],(ut,[pt])=>Xa(pt.evaluate(ut),ut.properties())],[[sp,_p],(ut,[pt,wt])=>Xa(pt.evaluate(ut),wt.evaluate(ut))]]},"feature-state":[yp,[sp],(ut,[pt])=>Xa(pt.evaluate(ut),ut.featureState||{})],properties:[_p,[],ut=>ut.properties()],"geometry-type":[sp,[],ut=>ut.geometryType()],id:[yp,[],ut=>ut.id()],zoom:[tp,[],ut=>ut.globals.zoom],pitch:[tp,[],ut=>ut.globals.pitch||0],"distance-from-center":[tp,[],ut=>ut.distanceFromCenter()],"measure-light":[tp,[sp],(ut,[pt])=>ut.measureLight(pt.evaluate(ut))],"heatmap-density":[tp,[],ut=>ut.globals.heatmapDensity||0],"line-progress":[tp,[],ut=>ut.globals.lineProgress||0],"raster-value":[tp,[],ut=>ut.globals.rasterValue||0],"raster-particle-speed":[tp,[],ut=>ut.globals.rasterParticleSpeed||0],"sky-radial-progress":[tp,[],ut=>ut.globals.skyRadialProgress||0],accumulated:[yp,[],ut=>void 0===ut.globals.accumulated?null:ut.globals.accumulated],"+":[tp,Ya(tp),(ut,pt)=>{let wt=0;for(const Tt of pt)wt+=Tt.evaluate(ut);return wt}],"*":[tp,Ya(tp),(ut,pt)=>{let wt=1;for(const Tt of pt)wt*=Tt.evaluate(ut);return wt}],"-":{type:tp,overloads:[[[tp,tp],(ut,[pt,wt])=>pt.evaluate(ut)-wt.evaluate(ut)],[[tp],(ut,[pt])=>-pt.evaluate(ut)]]},"/":[tp,[tp,tp],(ut,[pt,wt])=>pt.evaluate(ut)/wt.evaluate(ut)],"%":[tp,[tp,tp],(ut,[pt,wt])=>pt.evaluate(ut)%wt.evaluate(ut)],ln2:[tp,[],()=>Math.LN2],pi:[tp,[],()=>Math.PI],e:[tp,[],()=>Math.E],"^":[tp,[tp,tp],(ut,[pt,wt])=>Math.pow(pt.evaluate(ut),wt.evaluate(ut))],sqrt:[tp,[tp],(ut,[pt])=>Math.sqrt(pt.evaluate(ut))],log10:[tp,[tp],(ut,[pt])=>Math.log(pt.evaluate(ut))/Math.LN10],ln:[tp,[tp],(ut,[pt])=>Math.log(pt.evaluate(ut))],log2:[tp,[tp],(ut,[pt])=>Math.log(pt.evaluate(ut))/Math.LN2],sin:[tp,[tp],(ut,[pt])=>Math.sin(pt.evaluate(ut))],cos:[tp,[tp],(ut,[pt])=>Math.cos(pt.evaluate(ut))],tan:[tp,[tp],(ut,[pt])=>Math.tan(pt.evaluate(ut))],asin:[tp,[tp],(ut,[pt])=>Math.asin(pt.evaluate(ut))],acos:[tp,[tp],(ut,[pt])=>Math.acos(pt.evaluate(ut))],atan:[tp,[tp],(ut,[pt])=>Math.atan(pt.evaluate(ut))],min:[tp,Ya(tp),(ut,pt)=>Math.min(...pt.map((pt=>pt.evaluate(ut))))],max:[tp,Ya(tp),(ut,pt)=>Math.max(...pt.map((pt=>pt.evaluate(ut))))],abs:[tp,[tp],(ut,[pt])=>Math.abs(pt.evaluate(ut))],round:[tp,[tp],(ut,[pt])=>{const wt=pt.evaluate(ut);return wt<0?-Math.round(-wt):Math.round(wt)}],floor:[tp,[tp],(ut,[pt])=>Math.floor(pt.evaluate(ut))],ceil:[tp,[tp],(ut,[pt])=>Math.ceil(pt.evaluate(ut))],"filter-==":[ap,[sp,yp],(ut,[pt,wt])=>ut.properties()[pt.value]===wt.value],"filter-id-==":[ap,[yp],(ut,[pt])=>ut.id()===pt.value],"filter-type-==":[ap,[sp],(ut,[pt])=>ut.geometryType()===pt.value],"filter-<":[ap,[sp,yp],(ut,[pt,wt])=>{const Tt=ut.properties()[pt.value],St=wt.value;return typeof Tt==typeof St&&Tt<St}],"filter-id-<":[ap,[yp],(ut,[pt])=>{const wt=ut.id(),Tt=pt.value;return typeof wt==typeof Tt&&wt<Tt}],"filter->":[ap,[sp,yp],(ut,[pt,wt])=>{const Tt=ut.properties()[pt.value],St=wt.value;return typeof Tt==typeof St&&Tt>St}],"filter-id->":[ap,[yp],(ut,[pt])=>{const wt=ut.id(),Tt=pt.value;return typeof wt==typeof Tt&&wt>Tt}],"filter-<=":[ap,[sp,yp],(ut,[pt,wt])=>{const Tt=ut.properties()[pt.value],St=wt.value;return typeof Tt==typeof St&&Tt<=St}],"filter-id-<=":[ap,[yp],(ut,[pt])=>{const wt=ut.id(),Tt=pt.value;return typeof wt==typeof Tt&&wt<=Tt}],"filter->=":[ap,[sp,yp],(ut,[pt,wt])=>{const Tt=ut.properties()[pt.value],St=wt.value;return typeof Tt==typeof St&&Tt>=St}],"filter-id->=":[ap,[yp],(ut,[pt])=>{const wt=ut.id(),Tt=pt.value;return typeof wt==typeof Tt&&wt>=Tt}],"filter-has":[ap,[yp],(ut,[pt])=>pt.value in ut.properties()],"filter-has-id":[ap,[],ut=>null!==ut.id()&&void 0!==ut.id()],"filter-type-in":[ap,[oi(sp)],(ut,[pt])=>pt.value.indexOf(ut.geometryType())>=0],"filter-id-in":[ap,[oi(yp)],(ut,[pt])=>pt.value.indexOf(ut.id())>=0],"filter-in-small":[ap,[sp,oi(yp)],(ut,[pt,wt])=>wt.value.indexOf(ut.properties()[pt.value])>=0],"filter-in-large":[ap,[sp,oi(yp)],(ut,[pt,wt])=>function(ut,pt,wt,Tt){for(;wt<=Tt;){const St=wt+Tt>>1;if(pt[St]===ut)return!0;pt[St]>ut?Tt=St-1:wt=St+1}return!1}(ut.properties()[pt.value],wt.value,0,wt.value.length-1)],all:{type:ap,overloads:[[[ap,ap],(ut,[pt,wt])=>pt.evaluate(ut)&&wt.evaluate(ut)],[Ya(ap),(ut,pt)=>{for(const wt of pt)if(!wt.evaluate(ut))return!1;return!0}]]},any:{type:ap,overloads:[[[ap,ap],(ut,[pt,wt])=>pt.evaluate(ut)||wt.evaluate(ut)],[Ya(ap),(ut,pt)=>{for(const wt of pt)if(wt.evaluate(ut))return!0;return!1}]]},"!":[ap,[ap],(ut,[pt])=>!pt.evaluate(ut)],"is-supported-script":[ap,[sp],(ut,[pt])=>{const wt=ut.globals&&ut.globals.isSupportedScript;return!wt||wt(pt.evaluate(ut))}],upcase:[sp,[sp],(ut,[pt])=>pt.evaluate(ut).toUpperCase()],downcase:[sp,[sp],(ut,[pt])=>pt.evaluate(ut).toLowerCase()],concat:[sp,Ya(yp),(ut,pt)=>pt.map((pt=>vi(pt.evaluate(ut)))).join("")],"resolved-locale":[sp,[xp],(ut,[pt])=>pt.evaluate(ut).resolvedLocale()],random:[tp,[tp,tp,yp],(ut,pt)=>{const[wt,Tt,St]=pt.map((pt=>pt.evaluate(ut)));if(wt>Tt)return wt;if(wt===Tt)return wt;let It;if("string"==typeof St)It=function(ut){let pt=0;if(0===ut.length)return pt;for(let wt=0;wt<ut.length;wt++)pt=(pt<<5)-pt+ut.charCodeAt(wt),pt|=0;return pt}(St);else{if("number"!=typeof St)throw new wi(`Invalid seed input: ${St}`);It=St}return wt+Na(It)()*(Tt-wt)}]});class uo{constructor(ut,pt,wt,Tt){this.expression=ut,this._warningHistory={},this._evaluator=new Ei(wt,Tt),this._defaultValue=pt?function(ut){return"color"===ut.type&&(eo(ut.default)||Array.isArray(ut.default))?new qn(0,0,0,0):"color"===ut.type?qn.parse(ut.default)||null:void 0===ut.default?null:ut.default}(pt):null,this._enumValues=pt&&"enum"===pt.type?pt.values:null}evaluateWithoutErrorHandling(ut,pt,wt,Tt,St,It,Lt,Xt){return this._evaluator.globals=ut,this._evaluator.feature=pt,this._evaluator.featureState=wt,this._evaluator.canonical=Tt||null,this._evaluator.availableImages=St||null,this._evaluator.formattedSection=It,this._evaluator.featureTileCoord=Lt||null,this._evaluator.featureDistanceData=Xt||null,this.expression.evaluate(this._evaluator)}evaluate(ut,pt,wt,Tt,St,It,Lt,Xt){this._evaluator.globals=ut,this._evaluator.feature=pt||null,this._evaluator.featureState=wt||null,this._evaluator.canonical=Tt||null,this._evaluator.availableImages=St||null,this._evaluator.formattedSection=It||null,this._evaluator.featureTileCoord=Lt||null,this._evaluator.featureDistanceData=Xt||null;try{const ut=this.expression.evaluate(this._evaluator);if(null==ut||"number"==typeof ut&&ut!=ut)return this._defaultValue;if(this._enumValues&&!(ut in this._enumValues))throw new wi(`Expected value to be one of ${Object.keys(this._enumValues).map((ut=>JSON.stringify(ut))).join(", ")}, but found ${JSON.stringify(ut)} instead.`);return ut}catch(ut){return this._warningHistory[ut.message]||(this._warningHistory[ut.message]=!0,"undefined"!=typeof console&&console.warn(ut.message)),this._defaultValue}}}function co(ut){return Array.isArray(ut)&&ut.length>0&&"string"==typeof ut[0]&&ut[0]in Qm}function ho(ut,pt,wt,Tt){const St=new Sf(Qm,[],pt?function(ut){const pt={color:mp,string:sp,number:tp,enum:sp,boolean:ap,formatted:vp,resolvedImage:bp};return"array"===ut.type?oi(pt[ut.value]||yp,ut.length):pt[ut.type]}(pt):void 0,void 0,void 0,wt,Tt),It=St.parse(ut,void 0,void 0,void 0,pt&&"string"===pt.type?{typeAnnotation:"coerce"}:void 0);return It?Za(new uo(It,pt,wt,Tt)):Ha(St.errors)}class po{constructor(ut,pt,wt){this.kind=ut,this._styleExpression=pt,this.isLightConstant=wt,this.isStateDependent="constant"!==ut&&!Ys(pt.expression),this.isConfigDependent=!Zs(pt.expression)}evaluateWithoutErrorHandling(ut,pt,wt,Tt,St,It){return this._styleExpression.evaluateWithoutErrorHandling(ut,pt,wt,Tt,St,It)}evaluate(ut,pt,wt,Tt,St,It){return this._styleExpression.evaluate(ut,pt,wt,Tt,St,It)}}class fo{constructor(ut,pt,wt,Tt,St){this.kind=ut,this.zoomStops=wt,this._styleExpression=pt,this.isStateDependent="camera"!==ut&&!Ys(pt.expression),this.isLightConstant=St,this.isConfigDependent=!Zs(pt.expression),this.interpolationType=Tt}evaluateWithoutErrorHandling(ut,pt,wt,Tt,St,It){return this._styleExpression.evaluateWithoutErrorHandling(ut,pt,wt,Tt,St,It)}evaluate(ut,pt,wt,Tt,St,It){return this._styleExpression.evaluate(ut,pt,wt,Tt,St,It)}interpolationFactor(ut,pt,wt){return this.interpolationType?va.interpolationFactor(this.interpolationType,ut,pt,wt):0}}function mo(ut,pt,wt,Tt){if("error"===(ut=ho(ut,pt,wt,Tt)).result)return ut;const St=ut.value.expression,It=Xs(St);if(!It&&!Wa(pt))return Ha([new Hn("","data expressions not supported")]);const Lt=Hs(St,["zoom","pitch","distance-from-center"]);if(!Lt&&!Qa(pt))return Ha([new Hn("","zoom expressions not supported")]);const Xt=Hs(St,["measure-light"]);if(!Xt&&!Ja(pt))return Ha([new Hn("","measure-light expression not supported")]);const Yt=pt.expression&&pt.expression.relaxZoomRestriction,Mi=go(St);return Mi||Lt||Yt?Mi instanceof Hn?Ha([Mi]):Mi instanceof va&&!to(pt)?Ha([new Hn("",'"interpolate" expressions cannot be used with this property')]):Za(Mi?new fo(It?"camera":"composite",ut.value,Mi.labels,Mi instanceof va?Mi.interpolation:void 0,Xt):new po(It?"constant":"source",ut.value,Xt)):Ha([new Hn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class yo{constructor(ut,pt){this._parameters=ut,this._specification=pt,Zn(this,no(this._parameters,this._specification))}static deserialize(ut){return new yo(ut._parameters,ut._specification)}static serialize(ut){return{_parameters:ut._parameters,_specification:ut._specification}}}function go(ut){let pt=null;if(ut instanceof Ma)pt=go(ut.result);else if(ut instanceof wa){for(const wt of ut.args)if(pt=go(wt),pt)break}else(ut instanceof ea||ut instanceof va)&&ut.input instanceof Bi&&"zoom"===ut.input.name&&(pt=ut);return pt instanceof Hn||ut.eachChild((ut=>{const wt=go(ut);wt instanceof Hn?pt=wt:pt&&wt&&pt!==wt&&(pt=new Hn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),pt}var o_=vo,a_=3;function vo(ut,wt,Tt){var St=(this||pt).cells=[];if(ut instanceof ArrayBuffer){(this||pt).arrayBuffer=ut;var It=new Int32Array((this||pt).arrayBuffer);ut=It[0],(this||pt).d=(wt=It[1])+2*(Tt=It[2]);for(var Lt=0;Lt<(this||pt).d*(this||pt).d;Lt++){var Xt=It[a_+Lt],Yt=It[a_+Lt+1];St.push(Xt===Yt?null:It.subarray(Xt,Yt))}var Mi=It[a_+St.length+1];(this||pt).keys=It.subarray(It[a_+St.length],Mi),(this||pt).bboxes=It.subarray(Mi),(this||pt).insert=(this||pt)._insertReadonly}else{(this||pt).d=wt+2*Tt;for(var vr=0;vr<(this||pt).d*(this||pt).d;vr++)St.push([]);(this||pt).keys=[],(this||pt).bboxes=[]}(this||pt).n=wt,(this||pt).extent=ut,(this||pt).padding=Tt,(this||pt).scale=wt/ut,(this||pt).uid=0;var br=Tt/wt*ut;(this||pt).min=-br,(this||pt).max=ut+br}vo.prototype.insert=function(ut,wt,Tt,St,It){this._forEachCell(wt,Tt,St,It,(this||pt)._insertCell,(this||pt).uid++),(this||pt).keys.push(ut),(this||pt).bboxes.push(wt),(this||pt).bboxes.push(Tt),(this||pt).bboxes.push(St),(this||pt).bboxes.push(It)},vo.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},vo.prototype._insertCell=function(ut,wt,Tt,St,It,Lt){(this||pt).cells[It].push(Lt)},vo.prototype.query=function(ut,wt,Tt,St,It){var Lt=(this||pt).min,Xt=(this||pt).max;if(ut<=Lt&&wt<=Lt&&Xt<=Tt&&Xt<=St&&!It)return Array.prototype.slice.call((this||pt).keys);var Yt=[];return this._forEachCell(ut,wt,Tt,St,(this||pt)._queryCell,Yt,{},It),Yt},vo.prototype._queryCell=function(ut,wt,Tt,St,It,Lt,Xt,Yt){var Mi=(this||pt).cells[It];if(null!==Mi)for(var vr=(this||pt).keys,br=(this||pt).bboxes,Ar=0;Ar<Mi.length;Ar++){var Vr=Mi[Ar];if(void 0===Xt[Vr]){var nn=4*Vr;(Yt?Yt(br[nn+0],br[nn+1],br[nn+2],br[nn+3]):ut<=br[nn+2]&&wt<=br[nn+3]&&Tt>=br[nn+0]&&St>=br[nn+1])?(Xt[Vr]=!0,Lt.push(vr[Vr])):Xt[Vr]=!1}}},vo.prototype._forEachCell=function(ut,wt,Tt,St,It,Lt,Xt,Yt){for(var Mi=this._convertToCellCoord(ut),vr=this._convertToCellCoord(wt),br=this._convertToCellCoord(Tt),Ar=this._convertToCellCoord(St),Vr=Mi;Vr<=br;Vr++)for(var nn=vr;nn<=Ar;nn++){var sn=(this||pt).d*nn+Vr;if((!Yt||Yt(this._convertFromCellCoord(Vr),this._convertFromCellCoord(nn),this._convertFromCellCoord(Vr+1),this._convertFromCellCoord(nn+1)))&&It.call(this||pt,ut,wt,Tt,St,sn,Lt,Xt,Yt))return}},vo.prototype._convertFromCellCoord=function(ut){return(ut-(this||pt).padding)/(this||pt).scale},vo.prototype._convertToCellCoord=function(ut){return Math.max(0,Math.min((this||pt).d-1,Math.floor(ut*(this||pt).scale)+(this||pt).padding))},vo.prototype.toArrayBuffer=function(){if((this||pt).arrayBuffer)return(this||pt).arrayBuffer;for(var ut=(this||pt).cells,wt=a_+(this||pt).cells.length+1+1,Tt=0,St=0;St<(this||pt).cells.length;St++)Tt+=(this||pt).cells[St].length;var It=new Int32Array(wt+Tt+(this||pt).keys.length+(this||pt).bboxes.length);It[0]=(this||pt).extent,It[1]=(this||pt).n,It[2]=(this||pt).padding;for(var Lt=wt,Xt=0;Xt<ut.length;Xt++){var Yt=ut[Xt];It[a_+Xt]=Lt,It.set(Yt,Lt),Lt+=Yt.length}return It[a_+ut.length]=Lt,It.set((this||pt).keys,Lt),It[a_+ut.length+1]=Lt+=(this||pt).keys.length,It.set((this||pt).bboxes,Lt),Lt+=(this||pt).bboxes.length,It.buffer};var l_=p(o_);const c_={};function Mo(ut,pt,wt={}){Object.defineProperty(ut,"_classRegistryKey",{value:pt,writable:!1}),c_[pt]={klass:ut,omit:wt.omit||[]}}Mo(Object,"Object"),l_.serialize=function(ut,pt){const wt=ut.toArrayBuffer();return pt&&pt.add(wt),{buffer:wt}},l_.deserialize=function(ut){return new l_(ut.buffer)},Object.defineProperty(l_,"name",{value:"Grid"}),Mo(l_,"Grid"),Mo(qn,"Color"),Mo(Error,"Error"),Mo(mi,"Formatted"),Mo(di,"FormattedSection"),Mo(Jr,"AJAXError"),Mo(yi,"ResolvedImage"),Mo(yo,"StylePropertyFunction"),Mo(uo,"StyleExpression",{omit:["_evaluator"]}),Mo(fo,"ZoomDependentExpression"),Mo(po,"ZoomConstantExpression"),Mo(Bi,"CompoundExpression",{omit:["_evaluate"]});for(const ut in Qm)c_[Qm[ut]._classRegistryKey]||Mo(Qm[ut],`Expression${ut}`);function Ao(ut){return ut&&"undefined"!=typeof ArrayBuffer&&(ut instanceof ArrayBuffer||ut.constructor&&"ArrayBuffer"===ut.constructor.name)}function So(ut){return self.ImageBitmap&&ut instanceof ImageBitmap}function Io(ut,pt){if(null==ut||"boolean"==typeof ut||"number"==typeof ut||"string"==typeof ut||ut instanceof Boolean||ut instanceof Number||ut instanceof String||ut instanceof Date||ut instanceof RegExp)return ut;if(Ao(ut)||So(ut))return pt&&pt.add(ut),ut;if(ArrayBuffer.isView(ut)){const wt=ut;return pt&&pt.add(wt.buffer),wt}if(ut instanceof ImageData)return pt&&pt.add(ut.data.buffer),ut;if(Array.isArray(ut)){const wt=[];for(const Tt of ut)wt.push(Io(Tt,pt));return wt}if(ut instanceof Map){const pt={$name:"Map"};for(const[wt,Tt]of ut.entries())pt[wt]=Io(Tt);return pt}if("object"==typeof ut){const wt=ut.constructor,Tt=wt._classRegistryKey;if(!Tt)throw new Error(`can't serialize object of unregistered class ${Tt}`);const St=wt.serialize?wt.serialize(ut,pt):{};if(!wt.serialize){for(const wt in ut)ut.hasOwnProperty(wt)&&(c_[Tt].omit.indexOf(wt)>=0||(St[wt]=Io(ut[wt],pt)));ut instanceof Error&&(St.message=ut.message)}if(St.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Tt&&(St.$name=Tt),St}throw new Error("can't serialize object of type "+typeof ut)}function To(ut){if(null==ut||"boolean"==typeof ut||"number"==typeof ut||"string"==typeof ut||ut instanceof Boolean||ut instanceof Number||ut instanceof String||ut instanceof Date||ut instanceof RegExp||Ao(ut)||So(ut)||ArrayBuffer.isView(ut)||ut instanceof ImageData)return ut;if(Array.isArray(ut))return ut.map(To);if("object"==typeof ut){const pt=ut.$name||"Object";if("Map"===pt){const pt=new Map;for(const wt of Object.keys(ut))"$name"!==wt&&pt.set(wt,To(ut[wt]));return pt}const{klass:wt}=c_[pt];if(!wt)throw new Error(`can't deserialize unregistered class ${pt}`);if(wt.deserialize)return wt.deserialize(ut);const Tt=Object.create(wt.prototype);for(const pt of Object.keys(ut))"$name"!==pt&&(Tt[pt]=To(ut[pt]));return Tt}throw new Error("can't deserialize object of type "+typeof ut)}const u_={"Latin-1 Supplement":ut=>ut>=128&&ut<=255,Arabic:ut=>ut>=1536&&ut<=1791,"Arabic Supplement":ut=>ut>=1872&&ut<=1919,"Arabic Extended-A":ut=>ut>=2208&&ut<=2303,"Hangul Jamo":ut=>ut>=4352&&ut<=4607,"Unified Canadian Aboriginal Syllabics":ut=>ut>=5120&&ut<=5759,Khmer:ut=>ut>=6016&&ut<=6143,"Unified Canadian Aboriginal Syllabics Extended":ut=>ut>=6320&&ut<=6399,"General Punctuation":ut=>ut>=8192&&ut<=8303,"Letterlike Symbols":ut=>ut>=8448&&ut<=8527,"Number Forms":ut=>ut>=8528&&ut<=8591,"Miscellaneous Technical":ut=>ut>=8960&&ut<=9215,"Control Pictures":ut=>ut>=9216&&ut<=9279,"Optical Character Recognition":ut=>ut>=9280&&ut<=9311,"Enclosed Alphanumerics":ut=>ut>=9312&&ut<=9471,"Geometric Shapes":ut=>ut>=9632&&ut<=9727,"Miscellaneous Symbols":ut=>ut>=9728&&ut<=9983,"Miscellaneous Symbols and Arrows":ut=>ut>=11008&&ut<=11263,"CJK Radicals Supplement":ut=>ut>=11904&&ut<=12031,"Kangxi Radicals":ut=>ut>=12032&&ut<=12255,"Ideographic Description Characters":ut=>ut>=12272&&ut<=12287,"CJK Symbols and Punctuation":ut=>ut>=12288&&ut<=12351,Hiragana:ut=>ut>=12352&&ut<=12447,Katakana:ut=>ut>=12448&&ut<=12543,Bopomofo:ut=>ut>=12544&&ut<=12591,"Hangul Compatibility Jamo":ut=>ut>=12592&&ut<=12687,Kanbun:ut=>ut>=12688&&ut<=12703,"Bopomofo Extended":ut=>ut>=12704&&ut<=12735,"CJK Strokes":ut=>ut>=12736&&ut<=12783,"Katakana Phonetic Extensions":ut=>ut>=12784&&ut<=12799,"Enclosed CJK Letters and Months":ut=>ut>=12800&&ut<=13055,"CJK Compatibility":ut=>ut>=13056&&ut<=13311,"CJK Unified Ideographs Extension A":ut=>ut>=13312&&ut<=19903,"Yijing Hexagram Symbols":ut=>ut>=19904&&ut<=19967,"CJK Unified Ideographs":ut=>ut>=19968&&ut<=40959,"Yi Syllables":ut=>ut>=40960&&ut<=42127,"Yi Radicals":ut=>ut>=42128&&ut<=42191,"Hangul Jamo Extended-A":ut=>ut>=43360&&ut<=43391,"Hangul Syllables":ut=>ut>=44032&&ut<=55215,"Hangul Jamo Extended-B":ut=>ut>=55216&&ut<=55295,"Private Use Area":ut=>ut>=57344&&ut<=63743,"CJK Compatibility Ideographs":ut=>ut>=63744&&ut<=64255,"Arabic Presentation Forms-A":ut=>ut>=64336&&ut<=65023,"Vertical Forms":ut=>ut>=65040&&ut<=65055,"CJK Compatibility Forms":ut=>ut>=65072&&ut<=65103,"Small Form Variants":ut=>ut>=65104&&ut<=65135,"Arabic Presentation Forms-B":ut=>ut>=65136&&ut<=65279,"Halfwidth and Fullwidth Forms":ut=>ut>=65280&&ut<=65519,"CJK Unified Ideographs Extension B":ut=>ut>=131072&&ut<=173791};function zo(ut){for(const pt of ut)if(Bo(pt.charCodeAt(0)))return!0;return!1}function Po(ut){for(const pt of ut)if(!Eo(pt.charCodeAt(0)))return!1;return!0}function Eo(ut){return!(u_.Arabic(ut)||u_["Arabic Supplement"](ut)||u_["Arabic Extended-A"](ut)||u_["Arabic Presentation Forms-A"](ut)||u_["Arabic Presentation Forms-B"](ut))}function Bo(ut){return!(746!==ut&&747!==ut&&(ut<4352||!(u_["Bopomofo Extended"](ut)||u_.Bopomofo(ut)||u_["CJK Compatibility Forms"](ut)&&!(ut>=65097&&ut<=65103)||u_["CJK Compatibility Ideographs"](ut)||u_["CJK Compatibility"](ut)||u_["CJK Radicals Supplement"](ut)||u_["CJK Strokes"](ut)||!(!u_["CJK Symbols and Punctuation"](ut)||ut>=12296&&ut<=12305||ut>=12308&&ut<=12319||12336===ut)||u_["CJK Unified Ideographs Extension A"](ut)||u_["CJK Unified Ideographs"](ut)||u_["Enclosed CJK Letters and Months"](ut)||u_["Hangul Compatibility Jamo"](ut)||u_["Hangul Jamo Extended-A"](ut)||u_["Hangul Jamo Extended-B"](ut)||u_["Hangul Jamo"](ut)||u_["Hangul Syllables"](ut)||u_.Hiragana(ut)||u_["Ideographic Description Characters"](ut)||u_.Kanbun(ut)||u_["Kangxi Radicals"](ut)||u_["Katakana Phonetic Extensions"](ut)||u_.Katakana(ut)&&12540!==ut||!(!u_["Halfwidth and Fullwidth Forms"](ut)||65288===ut||65289===ut||65293===ut||ut>=65306&&ut<=65310||65339===ut||65341===ut||65343===ut||ut>=65371&&ut<=65503||65507===ut||ut>=65512&&ut<=65519)||!(!u_["Small Form Variants"](ut)||ut>=65112&&ut<=65118||ut>=65123&&ut<=65126)||u_["Unified Canadian Aboriginal Syllabics"](ut)||u_["Unified Canadian Aboriginal Syllabics Extended"](ut)||u_["Vertical Forms"](ut)||u_["Yijing Hexagram Symbols"](ut)||u_["Yi Syllables"](ut)||u_["Yi Radicals"](ut))))}function Do(ut){return!(Bo(ut)||function(ut){return!!(u_["Latin-1 Supplement"](ut)&&(167===ut||169===ut||174===ut||177===ut||188===ut||189===ut||190===ut||215===ut||247===ut)||u_["General Punctuation"](ut)&&(8214===ut||8224===ut||8225===ut||8240===ut||8241===ut||8251===ut||8252===ut||8258===ut||8263===ut||8264===ut||8265===ut||8273===ut)||u_["Letterlike Symbols"](ut)||u_["Number Forms"](ut)||u_["Miscellaneous Technical"](ut)&&(ut>=8960&&ut<=8967||ut>=8972&&ut<=8991||ut>=8996&&ut<=9e3||9003===ut||ut>=9085&&ut<=9114||ut>=9150&&ut<=9165||9167===ut||ut>=9169&&ut<=9179||ut>=9186&&ut<=9215)||u_["Control Pictures"](ut)&&9251!==ut||u_["Optical Character Recognition"](ut)||u_["Enclosed Alphanumerics"](ut)||u_["Geometric Shapes"](ut)||u_["Miscellaneous Symbols"](ut)&&!(ut>=9754&&ut<=9759)||u_["Miscellaneous Symbols and Arrows"](ut)&&(ut>=11026&&ut<=11055||ut>=11088&&ut<=11097||ut>=11192&&ut<=11243)||u_["CJK Symbols and Punctuation"](ut)||u_.Katakana(ut)||u_["Private Use Area"](ut)||u_["CJK Compatibility Forms"](ut)||u_["Small Form Variants"](ut)||u_["Halfwidth and Fullwidth Forms"](ut)||8734===ut||8756===ut||8757===ut||ut>=9984&&ut<=10087||ut>=10102&&ut<=10131||65532===ut||65533===ut)}(ut))}function Co(ut){return ut>=1424&&ut<=2303||u_["Arabic Presentation Forms-A"](ut)||u_["Arabic Presentation Forms-B"](ut)}function Ro(ut,pt){return!(!pt&&Co(ut)||ut>=2304&&ut<=3583||ut>=3840&&ut<=4255||u_.Khmer(ut))}function Vo(ut){for(const pt of ut)if(Co(pt.charCodeAt(0)))return!0;return!1}const h_="deferred",d_="loading",p_="loaded";let f_=null,m_="unavailable",__=null;const qo=function(ut){ut&&"string"==typeof ut&&ut.indexOf("NetworkError")>-1&&(m_="error"),f_&&f_(ut)};function $o(){g_.fire(new Rn("pluginStateChange",{pluginStatus:m_,pluginURL:__}))}const g_=new Fn,Xo=function(){return m_},Yo=function(){if(m_!==h_||!__)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");m_=d_,$o(),__&&en({url:__},(ut=>{ut?qo(ut):(m_=p_,$o())}))},y_={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>m_===p_||null!=y_.applyArabicShaping,isLoading:()=>m_===d_,setState(ut){m_=ut.pluginStatus,__=ut.pluginURL},isParsed:()=>null!=y_.applyArabicShaping&&null!=y_.processBidirectionalText&&null!=y_.processStyledBidirectionalText,getPluginURL:()=>__};class Ho{constructor(ut,pt){this.zoom=ut,pt?(this.now=pt.now,this.fadeDuration=pt.fadeDuration,this.transition=pt.transition,this.pitch=pt.pitch,this.brightness=pt.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(ut){return function(ut,pt){for(const wt of ut)if(!Ro(wt.charCodeAt(0),pt))return!1;return!0}(ut,y_.isLoaded())}}class Ko{constructor(ut,pt,wt,Tt){this.property=ut,this.value=pt,this.expression=function(ut,pt,wt,Tt){if(eo(ut))return new yo(ut,pt);if(co(ut)||Array.isArray(ut)&&ut.length>0){const St=mo(ut,pt,wt,Tt);if("error"===St.result)throw new Error(St.value.map((ut=>`${ut.key}: ${ut.message}`)).join(", "));return St.value}{let wt=ut;return"string"==typeof ut&&"color"===pt.type&&(wt=qn.parse(ut)),{kind:"constant",isConfigDependent:!1,evaluate:()=>wt}}}(void 0===pt?ut.specification.default:pt,ut.specification,wt,Tt)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(ut,pt,wt){return this.property.possiblyEvaluate(this,ut,pt,wt)}}class Wo{constructor(ut,pt,wt){this.property=ut,this.value=new Ko(ut,void 0,pt,wt)}transitioned(ut,pt){return new Qo(this.property,this.value,pt,er({},ut.transition,this.transition),ut.now)}untransitioned(){return new Qo(this.property,this.value,null,{},0)}}class Jo{constructor(ut,pt,wt){this._properties=ut,this._values=Object.create(ut.defaultTransitionablePropertyValues),this._scope=pt,this._options=wt,this.isConfigDependent=!1}getValue(ut){return hr(this._values[ut].value.value)}setValue(ut,pt){this._values.hasOwnProperty(ut)||(this._values[ut]=new Wo(this._values[ut].property,this._scope,this._options)),this._values[ut].value=new Ko(this._values[ut].property,null===pt?void 0:hr(pt),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[ut].value.expression.isConfigDependent}setTransitionOrValue(ut,pt){pt&&(this._options=pt);const wt=this._properties.properties;if(ut)for(const pt in ut){const Tt=ut[pt];if(lr(pt,"-transition")){const ut=pt.slice(0,-11);wt[ut]&&this.setTransition(ut,Tt)}else wt.hasOwnProperty(pt)&&this.setValue(pt,Tt)}}getTransition(ut){return hr(this._values[ut].transition)}setTransition(ut,pt){this._values.hasOwnProperty(ut)||(this._values[ut]=new Wo(this._values[ut].property)),this._values[ut].transition=hr(pt)||void 0}serialize(){const ut={};for(const pt of Object.keys(this._values)){const wt=this.getValue(pt);void 0!==wt&&(ut[pt]=wt);const Tt=this.getTransition(pt);void 0!==Tt&&(ut[`${pt}-transition`]=Tt)}return ut}transitioned(ut,pt){const wt=new tl(this._properties);for(const Tt of Object.keys(this._values))wt._values[Tt]=this._values[Tt].transitioned(ut,pt._values[Tt]);return wt}untransitioned(){const ut=new tl(this._properties);for(const pt of Object.keys(this._values))ut._values[pt]=this._values[pt].untransitioned();return ut}}class Qo{constructor(ut,pt,wt,Tt,St){const It=Tt.delay||0,Lt=Tt.duration||0;St=St||0,this.property=ut,this.value=pt,this.begin=St+It,this.end=this.begin+Lt,ut.specification.transition&&(Tt.delay||Tt.duration)&&(this.prior=wt)}possiblyEvaluate(ut,pt,wt){const Tt=ut.now||0,St=this.value.possiblyEvaluate(ut,pt,wt),It=this.prior;if(It){if(Tt>this.end)return this.prior=null,St;if(this.value.isDataDriven())return this.prior=null,St;if(Tt<this.begin)return It.possiblyEvaluate(ut,pt,wt);{const Lt=(Tt-this.begin)/(this.end-this.begin);return this.property.interpolate(It.possiblyEvaluate(ut,pt,wt),St,Ye(Lt))}}return St}}class tl{constructor(ut){this._properties=ut,this._values=Object.create(ut.defaultTransitioningPropertyValues)}possiblyEvaluate(ut,pt,wt){const Tt=new nl(this._properties);for(const St of Object.keys(this._values))Tt._values[St]=this._values[St].possiblyEvaluate(ut,pt,wt);return Tt}hasTransition(){for(const ut of Object.keys(this._values))if(this._values[ut].prior)return!0;return!1}}class el{constructor(ut,pt,wt){this._properties=ut,this._values=Object.create(ut.defaultPropertyValues),this._scope=pt,this._options=wt,this.isConfigDependent=!1}getValue(ut){return hr(this._values[ut].value)}setValue(ut,pt){this._values[ut]=new Ko(this._values[ut].property,null===pt?void 0:hr(pt),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[ut].expression.isConfigDependent}serialize(){const ut={};for(const pt of Object.keys(this._values)){const wt=this.getValue(pt);void 0!==wt&&(ut[pt]=wt)}return ut}possiblyEvaluate(ut,pt,wt){const Tt=new nl(this._properties);for(const St of Object.keys(this._values))Tt._values[St]=this._values[St].possiblyEvaluate(ut,pt,wt);return Tt}}class rl{constructor(ut,pt,wt){this.property=ut,this.value=pt,this.parameters=wt}isConstant(){return"constant"===this.value.kind}constantOr(ut){return"constant"===this.value.kind?this.value.value:ut}evaluate(ut,pt,wt,Tt){return this.property.evaluate(this.value,this.parameters,ut,pt,wt,Tt)}}class nl{constructor(ut){this._properties=ut,this._values=Object.create(ut.defaultPossiblyEvaluatedValues)}get(ut){return this._values[ut]}}class il{constructor(ut){this.specification=ut}possiblyEvaluate(ut,pt){return ut.expression.evaluate(pt)}interpolate(ut,pt,wt){const Tt=Qd[this.specification.type];return Tt?Tt(ut,pt,wt):ut}}class sl{constructor(ut,pt){this.specification=ut,this.overrides=pt}possiblyEvaluate(ut,pt,wt,Tt){return new rl(this,"constant"===ut.expression.kind||"camera"===ut.expression.kind?{kind:"constant",value:ut.expression.evaluate(pt,null,{},wt,Tt)}:ut.expression,pt)}interpolate(ut,pt,wt){if("constant"!==ut.value.kind||"constant"!==pt.value.kind)return ut;if(void 0===ut.value.value||void 0===pt.value.value)return new rl(this,{kind:"constant",value:void 0},ut.parameters);const Tt=Qd[this.specification.type];return Tt?new rl(this,{kind:"constant",value:Tt(ut.value.value,pt.value.value,wt)},ut.parameters):ut}evaluate(ut,pt,wt,Tt,St,It){return"constant"===ut.kind?ut.value:ut.evaluate(pt,wt,Tt,St,It)}}class al{constructor(ut){this.specification=ut}possiblyEvaluate(ut,pt,wt,Tt){return!!ut.expression.evaluate(pt,null,{},wt,Tt)}interpolate(){return!1}}class ol{constructor(ut){this.properties=ut,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const pt=new Ho(0,{});for(const wt in ut){const Tt=ut[wt];Tt.specification.overridable&&this.overridableProperties.push(wt);const St=this.defaultPropertyValues[wt]=new Ko(Tt,void 0),It=this.defaultTransitionablePropertyValues[wt]=new Wo(Tt);this.defaultTransitioningPropertyValues[wt]=It.untransitioned(),this.defaultPossiblyEvaluatedValues[wt]=St.possiblyEvaluate(pt)}}}Mo(sl,"DataDrivenProperty"),Mo(il,"DataConstantProperty"),Mo(al,"ColorRampProperty");var x_=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant","experimental":true}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function ul(ut){return ut instanceof Number||ut instanceof String||ut instanceof Boolean?ut.valueOf():ut}function cl(ut){if(Array.isArray(ut))return ut.map(cl);if(ut instanceof Object&&!(ut instanceof Number||ut instanceof String||ut instanceof Boolean)){const pt={};for(const wt in ut)pt[wt]=cl(ut[wt]);return pt}return ul(ut)}function hl(ut){if(!0===ut||!1===ut)return!0;if(!Array.isArray(ut)||0===ut.length)return!1;switch(ut[0]){case"has":return ut.length>=2&&"$id"!==ut[1]&&"$type"!==ut[1];case"in":return ut.length>=3&&("string"!=typeof ut[1]||Array.isArray(ut[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==ut.length||Array.isArray(ut[1])||Array.isArray(ut[2]);case"any":case"all":for(const pt of ut.slice(1))if(!hl(pt)&&"boolean"!=typeof pt)return!1;return!0;default:return!0}}function pl(ut,pt="fill"){if(null==ut)return{filter:()=>!0,needGeometry:!1,needFeature:!1};hl(ut)||(ut=bl(ut));const wt=ut;let Tt=!0;try{Tt=function(ut){if(!ml(ut))return ut;let pt=cl(ut);return dl(pt),pt=fl(pt),pt}(wt)}catch(ut){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(wt,null,2)}\n        `)}const St=x_[`filter_${pt}`],It=ho(Tt,St);let Lt=null;if("error"===It.result)throw new Error(It.value.map((ut=>`${ut.key}: ${ut.message}`)).join(", "));Lt=(ut,pt,wt)=>It.value.evaluate(ut,pt,{},wt);let Xt=null,Yt=null;if(Tt!==wt){const ut=ho(wt,St);if("error"===ut.result)throw new Error(ut.value.map((ut=>`${ut.key}: ${ut.message}`)).join(", "));Xt=(pt,wt,Tt,St,It)=>ut.value.evaluate(pt,wt,{},Tt,void 0,void 0,St,It),Yt=!Xs(ut.value.expression)}return{filter:Lt,dynamicFilter:Xt||void 0,needGeometry:xl(Tt),needFeature:!!Yt}}function fl(ut){if(!Array.isArray(ut))return ut;const pt=function(ut){if(v_.has(ut[0]))for(let pt=1;pt<ut.length;pt++)if(ml(ut[pt]))return!0;return ut}(ut);return!0===pt?pt:pt.map((ut=>fl(ut)))}function dl(ut){let pt=!1;const wt=[];if("case"===ut[0]){for(let Tt=1;Tt<ut.length-1;Tt+=2)pt=pt||ml(ut[Tt]),wt.push(ut[Tt+1]);wt.push(ut[ut.length-1])}else if("match"===ut[0]){pt=pt||ml(ut[1]);for(let pt=2;pt<ut.length-1;pt+=2)wt.push(ut[pt+1]);wt.push(ut[ut.length-1])}else if("step"===ut[0]){pt=pt||ml(ut[1]);for(let pt=1;pt<ut.length-1;pt+=2)wt.push(ut[pt+1])}pt&&(ut.length=0,ut.push("any",...wt));for(let pt=1;pt<ut.length;pt++)dl(ut[pt])}function ml(ut){if(!Array.isArray(ut))return!1;if("pitch"===(pt=ut[0])||"distance-from-center"===pt)return!0;var pt;for(let pt=1;pt<ut.length;pt++)if(ml(ut[pt]))return!0;return!1}const v_=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function gl(ut,pt){return ut<pt?-1:ut>pt?1:0}function xl(ut){if(!Array.isArray(ut))return!1;if("within"===ut[0]||"distance"===ut[0])return!0;for(let pt=1;pt<ut.length;pt++)if(xl(ut[pt]))return!0;return!1}function bl(ut){if(!ut)return!0;const pt=ut[0];return ut.length<=1?"any"!==pt:"=="===pt?vl(ut[1],ut[2],"=="):"!="===pt?Ml(vl(ut[1],ut[2],"==")):"<"===pt||">"===pt||"<="===pt||">="===pt?vl(ut[1],ut[2],pt):"any"===pt?(wt=ut.slice(1),["any"].concat(wt.map(bl))):"all"===pt?["all"].concat(ut.slice(1).map(bl)):"none"===pt?["all"].concat(ut.slice(1).map(bl).map(Ml)):"in"===pt?_l(ut[1],ut.slice(2)):"!in"===pt?Ml(_l(ut[1],ut.slice(2))):"has"===pt?wl(ut[1]):"!has"!==pt||Ml(wl(ut[1]));var wt}function vl(ut,pt,wt){switch(ut){case"$type":return[`filter-type-${wt}`,pt];case"$id":return[`filter-id-${wt}`,pt];default:return[`filter-${wt}`,ut,pt]}}function _l(ut,pt){if(0===pt.length)return!1;switch(ut){case"$type":return["filter-type-in",["literal",pt]];case"$id":return["filter-id-in",["literal",pt]];default:return pt.length>200&&!pt.some((ut=>typeof ut!=typeof pt[0]))?["filter-in-large",ut,["literal",pt.sort(gl)]]:["filter-in-small",ut,["literal",pt]]}}function wl(ut){switch(ut){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",ut]}}function Ml(ut){return["!",ut]}const b_="";function Sl(ut,pt){return pt?`${ut}${b_}${pt}`:ut}const w_="-transition",T_=new Set(["fill","line","background","hillshade","raster"]);class kl extends Fn{constructor(ut,pt,wt,Tt,St){if(super(),this.id=ut.id,this.fqid=Sl(this.id,wt),this.type=ut.type,this.scope=wt,this.lut=Tt,this.options=St,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==ut.type&&(this.metadata=ut.metadata,this.minzoom=ut.minzoom,this.maxzoom=ut.maxzoom,"background"!==ut.type&&"sky"!==ut.type&&"slot"!==ut.type&&(this.source=ut.source,this.sourceLayer=ut["source-layer"],this.filter=ut.filter),ut.slot&&(this.slot=ut.slot),pt.layout&&(this._unevaluatedLayout=new el(pt.layout,this.scope,St),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),pt.paint)){this._transitionablePaint=new Jo(pt.paint,this.scope,St);for(const pt in ut.paint)this.setPaintProperty(pt,ut.paint[pt]);for(const pt in ut.layout)this.setLayoutProperty(pt,ut.layout[pt]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new nl(pt.paint)}}onAdd(ut){}onRemove(ut){}isDraped(ut){return T_.has(this.type)}getLayoutProperty(ut){return"visibility"===ut?this.visibility:this._unevaluatedLayout.getValue(ut)}setLayoutProperty(ut,pt){if("custom"===this.type&&"visibility"===ut)return void(this.visibility=pt);const wt=this._unevaluatedLayout;wt._properties.properties[ut]&&(wt.setValue(ut,pt),this.isConfigDependent=this.isConfigDependent||wt.isConfigDependent,"visibility"===ut&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(ut){return lr(ut,w_)?this._transitionablePaint.getTransition(ut.slice(0,-11)):this._transitionablePaint.getValue(ut)}setPaintProperty(ut,pt){const wt=this._transitionablePaint,Tt=wt._properties.properties;if(lr(ut,w_)){const St=ut.slice(0,-11);return Tt[St]&&wt.setTransition(St,pt||void 0),!1}if(!Tt[ut])return!1;const St=wt._values[ut],It=St.value.isDataDriven(),Lt=St.value;wt.setValue(ut,pt),this.isConfigDependent=this.isConfigDependent||wt.isConfigDependent,this._handleSpecialPaintPropertyUpdate(ut);const Xt=wt._values[ut].value,Yt=Xt.isDataDriven(),Mi=lr(ut,"pattern")||"line-dasharray"===ut;return Yt||It||Mi||this._handleOverridablePaintPropertyUpdate(ut,Lt,Xt)}_handleSpecialPaintPropertyUpdate(ut){}getProgramIds(){return null}getDefaultProgramParams(ut,pt,wt){return null}_handleOverridablePaintPropertyUpdate(ut,pt,wt){return!1}isHidden(ut){return!!(this.minzoom&&ut<this.minzoom)||!!(this.maxzoom&&ut>=this.maxzoom)||"none"===this.visibility}updateTransitions(ut){this._transitioningPaint=this._transitionablePaint.transitioned(ut,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(ut,pt){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(ut,void 0,pt)),this.paint=this._transitioningPaint.possiblyEvaluate(ut,void 0,pt)}serialize(){return cr({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((ut,pt)=>!(void 0===ut||"layout"===pt&&!Object.keys(ut).length||"paint"===pt&&!Object.keys(ut).length)))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const ut in this.paint._values){const pt=this.paint.get(ut);if(pt instanceof rl&&Wa(pt.property.specification)&&("source"===pt.value.kind||"composite"===pt.value.kind)&&pt.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=pl(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(ut){this._stats&&("shadow"===ut.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(ut){}queryIntersectsFeature(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){}queryIntersectsMatchingFeature(ut,pt,wt,Tt){}}const E_={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Pl{constructor(ut,pt){this._structArray=ut,this._pos1=pt*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class El{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(ut,pt){return ut._trim(),pt&&(ut.isTransferred=!0,pt.add(ut.arrayBuffer)),{length:ut.length,arrayBuffer:ut.arrayBuffer}}static deserialize(ut){const pt=Object.create(this.prototype);return pt.arrayBuffer=ut.arrayBuffer,pt.length=ut.length,pt.capacity=ut.arrayBuffer.byteLength/pt.bytesPerElement,pt._refreshViews(),pt}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(ut){this.reserve(ut),this.length=ut}reserve(ut){if(ut>this.capacity){this.capacity=Math.max(ut,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const pt=this.uint8;this._refreshViews(),pt&&this.uint8.set(pt)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...ut){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...ut){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Bl(ut,pt=1){let wt=0,Tt=0;return{members:ut.map((ut=>{const St=E_[ut.type].BYTES_PER_ELEMENT,It=wt=Dl(wt,Math.max(pt,St)),Lt=ut.components||1;return Tt=Math.max(Tt,St),wt+=St*Lt,{name:ut.name,type:ut.type,components:Lt,offset:It}})),size:Dl(wt,Math.max(Tt,pt)),alignment:pt}}function Dl(ut,pt){return Math.ceil(ut/pt)*pt}class Cl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,ut,pt)}emplace(ut,pt,wt){const Tt=2*ut;return this.int16[Tt+0]=pt,this.int16[Tt+1]=wt,ut}}Cl.prototype.bytesPerElement=4,Mo(Cl,"StructArrayLayout2i4");class Rl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,ut,pt,wt)}emplace(ut,pt,wt,Tt){const St=3*ut;return this.int16[St+0]=pt,this.int16[St+1]=wt,this.int16[St+2]=Tt,ut}}Rl.prototype.bytesPerElement=6,Mo(Rl,"StructArrayLayout3i6");class Vl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,ut,pt,wt,Tt)}emplace(ut,pt,wt,Tt,St){const It=4*ut;return this.int16[It+0]=pt,this.int16[It+1]=wt,this.int16[It+2]=Tt,this.int16[It+3]=St,ut}}Vl.prototype.bytesPerElement=8,Mo(Vl,"StructArrayLayout4i8");class Fl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,ut,pt,wt,Tt,St)}emplace(ut,pt,wt,Tt,St,It){const Lt=5*ut;return this.int16[Lt+0]=pt,this.int16[Lt+1]=wt,this.int16[Lt+2]=Tt,this.int16[Lt+3]=St,this.int16[Lt+4]=It,ut}}Fl.prototype.bytesPerElement=10,Mo(Fl,"StructArrayLayout5i10");class Ll extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt){const Xt=this.length;return this.resize(Xt+1),this.emplace(Xt,ut,pt,wt,Tt,St,It,Lt)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=6*ut,Mi=12*ut,vr=3*ut;return this.int16[Yt+0]=pt,this.int16[Yt+1]=wt,this.uint8[Mi+4]=Tt,this.uint8[Mi+5]=St,this.uint8[Mi+6]=It,this.uint8[Mi+7]=Lt,this.float32[vr+2]=Xt,ut}}Ll.prototype.bytesPerElement=12,Mo(Ll,"StructArrayLayout2i4ub1f12");class Ol extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,ut,pt,wt,Tt)}emplace(ut,pt,wt,Tt,St){const It=4*ut;return this.float32[It+0]=pt,this.float32[It+1]=wt,this.float32[It+2]=Tt,this.float32[It+3]=St,ut}}Ol.prototype.bytesPerElement=16,Mo(Ol,"StructArrayLayout4f16");class Ul extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,ut,pt,wt)}emplace(ut,pt,wt,Tt){const St=3*ut;return this.float32[St+0]=pt,this.float32[St+1]=wt,this.float32[St+2]=Tt,ut}}Ul.prototype.bytesPerElement=12,Mo(Ul,"StructArrayLayout3f12");class Nl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,ut,pt,wt,Tt,St)}emplace(ut,pt,wt,Tt,St,It){const Lt=6*ut,Xt=3*ut;return this.uint16[Lt+0]=pt,this.uint16[Lt+1]=wt,this.uint16[Lt+2]=Tt,this.uint16[Lt+3]=St,this.float32[Xt+2]=It,ut}}Nl.prototype.bytesPerElement=12,Mo(Nl,"StructArrayLayout4ui1f12");class jl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,ut,pt,wt,Tt)}emplace(ut,pt,wt,Tt,St){const It=4*ut;return this.uint16[It+0]=pt,this.uint16[It+1]=wt,this.uint16[It+2]=Tt,this.uint16[It+3]=St,ut}}jl.prototype.bytesPerElement=8,Mo(jl,"StructArrayLayout4ui8");class ql extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,ut,pt,wt,Tt,St,It)}emplace(ut,pt,wt,Tt,St,It,Lt){const Xt=6*ut;return this.int16[Xt+0]=pt,this.int16[Xt+1]=wt,this.int16[Xt+2]=Tt,this.int16[Xt+3]=St,this.int16[Xt+4]=It,this.int16[Xt+5]=Lt,ut}}ql.prototype.bytesPerElement=12,Mo(ql,"StructArrayLayout6i12");class $l extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br){const Ar=this.length;return this.resize(Ar+1),this.emplace(Ar,ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar){const Vr=12*ut;return this.int16[Vr+0]=pt,this.int16[Vr+1]=wt,this.int16[Vr+2]=Tt,this.int16[Vr+3]=St,this.uint16[Vr+4]=It,this.uint16[Vr+5]=Lt,this.uint16[Vr+6]=Xt,this.uint16[Vr+7]=Yt,this.int16[Vr+8]=Mi,this.int16[Vr+9]=vr,this.int16[Vr+10]=br,this.int16[Vr+11]=Ar,ut}}$l.prototype.bytesPerElement=24,Mo($l,"StructArrayLayout4i4ui4i24");class Gl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It){const Lt=this.length;return this.resize(Lt+1),this.emplace(Lt,ut,pt,wt,Tt,St,It)}emplace(ut,pt,wt,Tt,St,It,Lt){const Xt=10*ut,Yt=5*ut;return this.int16[Xt+0]=pt,this.int16[Xt+1]=wt,this.int16[Xt+2]=Tt,this.float32[Yt+2]=St,this.float32[Yt+3]=It,this.float32[Yt+4]=Lt,ut}}Gl.prototype.bytesPerElement=20,Mo(Gl,"StructArrayLayout3i3f20");class Xl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,ut)}emplace(ut,pt){return this.uint32[1*ut+0]=pt,ut}}Xl.prototype.bytesPerElement=4,Mo(Xl,"StructArrayLayout1ul4");class Yl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,ut)}emplace(ut,pt){return this.float32[1*ut+0]=pt,ut}}Yl.prototype.bytesPerElement=4,Mo(Yl,"StructArrayLayout1f4");class Zl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,ut,pt)}emplace(ut,pt,wt){const Tt=2*ut;return this.uint16[Tt+0]=pt,this.uint16[Tt+1]=wt,ut}}Zl.prototype.bytesPerElement=4,Mo(Zl,"StructArrayLayout2ui4");class Hl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar){const Vr=this.length;return this.resize(Vr+1),this.emplace(Vr,ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr){const nn=20*ut,sn=10*ut;return this.int16[nn+0]=pt,this.int16[nn+1]=wt,this.int16[nn+2]=Tt,this.int16[nn+3]=St,this.int16[nn+4]=It,this.float32[sn+3]=Lt,this.float32[sn+4]=Xt,this.float32[sn+5]=Yt,this.float32[sn+6]=Mi,this.int16[nn+14]=vr,this.uint32[sn+8]=br,this.uint16[nn+18]=Ar,this.uint16[nn+19]=Vr,ut}}Hl.prototype.bytesPerElement=40,Mo(Hl,"StructArrayLayout5i4f1i1ul2ui40");class Kl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt){const Xt=this.length;return this.resize(Xt+1),this.emplace(Xt,ut,pt,wt,Tt,St,It,Lt)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=8*ut;return this.int16[Yt+0]=pt,this.int16[Yt+1]=wt,this.int16[Yt+2]=Tt,this.int16[Yt+4]=St,this.int16[Yt+5]=It,this.int16[Yt+6]=Lt,this.int16[Yt+7]=Xt,ut}}Kl.prototype.bytesPerElement=16,Mo(Kl,"StructArrayLayout3i2i2i16");class Wl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,ut,pt,wt,Tt,St)}emplace(ut,pt,wt,Tt,St,It){const Lt=4*ut,Xt=8*ut;return this.float32[Lt+0]=pt,this.float32[Lt+1]=wt,this.float32[Lt+2]=Tt,this.int16[Xt+6]=St,this.int16[Xt+7]=It,ut}}Wl.prototype.bytesPerElement=16,Mo(Wl,"StructArrayLayout2f1f2i16");class Jl extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,ut,pt,wt,Tt)}emplace(ut,pt,wt,Tt,St){const It=12*ut,Lt=3*ut;return this.uint8[It+0]=pt,this.uint8[It+1]=wt,this.float32[Lt+1]=Tt,this.float32[Lt+2]=St,ut}}Jl.prototype.bytesPerElement=12,Mo(Jl,"StructArrayLayout2ub2f12");class Ql extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,ut,pt,wt)}emplace(ut,pt,wt,Tt){const St=3*ut;return this.uint16[St+0]=pt,this.uint16[St+1]=wt,this.uint16[St+2]=Tt,ut}}Ql.prototype.bytesPerElement=6,Mo(Ql,"StructArrayLayout3ui6");class tu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn){const _n=this.length;return this.resize(_n+1),this.emplace(_n,ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n){const gn=30*ut,yn=15*ut,xn=60*ut;return this.int16[gn+0]=pt,this.int16[gn+1]=wt,this.int16[gn+2]=Tt,this.float32[yn+2]=St,this.float32[yn+3]=It,this.uint16[gn+8]=Lt,this.uint16[gn+9]=Xt,this.uint32[yn+5]=Yt,this.uint32[yn+6]=Mi,this.uint32[yn+7]=vr,this.uint16[gn+16]=br,this.uint16[gn+17]=Ar,this.uint16[gn+18]=Vr,this.float32[yn+10]=nn,this.float32[yn+11]=sn,this.uint8[xn+48]=an,this.uint8[xn+49]=ln,this.uint8[xn+50]=cn,this.uint32[yn+13]=un,this.int16[gn+28]=fn,this.uint8[xn+58]=_n,ut}}tu.prototype.bytesPerElement=60,Mo(tu,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class eu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n,gn,yn,xn,vn,bn,wn,Tn,En,Mn,Sn,An,In){const Pn=this.length;return this.resize(Pn+1),this.emplace(Pn,ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n,gn,yn,xn,vn,bn,wn,Tn,En,Mn,Sn,An,In)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n,gn,yn,xn,vn,bn,wn,Tn,En,Mn,Sn,An,In,Pn){const zn=22*ut,Ln=44*ut,kn=88*ut;return this.float32[zn+0]=pt,this.float32[zn+1]=wt,this.int16[Ln+4]=Tt,this.int16[Ln+5]=St,this.int16[Ln+6]=It,this.int16[Ln+7]=Lt,this.int16[Ln+8]=Xt,this.int16[Ln+9]=Yt,this.int16[Ln+10]=Mi,this.int16[Ln+11]=vr,this.int16[Ln+12]=br,this.uint16[Ln+13]=Ar,this.uint16[Ln+14]=Vr,this.uint16[Ln+15]=nn,this.uint16[Ln+16]=sn,this.uint16[Ln+17]=an,this.uint16[Ln+18]=ln,this.uint16[Ln+19]=cn,this.uint16[Ln+20]=un,this.uint16[Ln+21]=fn,this.uint16[Ln+22]=_n,this.uint16[Ln+23]=gn,this.uint16[Ln+24]=yn,this.uint16[Ln+25]=xn,this.uint16[Ln+26]=vn,this.uint16[Ln+27]=bn,this.uint32[zn+14]=wn,this.float32[zn+15]=Tn,this.float32[zn+16]=En,this.float32[zn+17]=Mn,this.float32[zn+18]=Sn,this.float32[zn+19]=An,this.float32[zn+20]=In,this.uint8[kn+84]=Pn,ut}}eu.prototype.bytesPerElement=88,Mo(eu,"StructArrayLayout2f9i15ui1ul6f1ub88");class ru extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St){const It=this.length;return this.resize(It+1),this.emplace(It,ut,pt,wt,Tt,St)}emplace(ut,pt,wt,Tt,St,It){const Lt=5*ut;return this.float32[Lt+0]=pt,this.float32[Lt+1]=wt,this.float32[Lt+2]=Tt,this.float32[Lt+3]=St,this.float32[Lt+4]=It,ut}}ru.prototype.bytesPerElement=20,Mo(ru,"StructArrayLayout5f20");class nu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt){const Xt=this.length;return this.resize(Xt+1),this.emplace(Xt,ut,pt,wt,Tt,St,It,Lt)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=7*ut;return this.float32[Yt+0]=pt,this.float32[Yt+1]=wt,this.float32[Yt+2]=Tt,this.float32[Yt+3]=St,this.float32[Yt+4]=It,this.float32[Yt+5]=Lt,this.float32[Yt+6]=Xt,ut}}nu.prototype.bytesPerElement=28,Mo(nu,"StructArrayLayout7f28");class iu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt){const wt=this.length;return this.resize(wt+1),this.emplace(wt,ut,pt)}emplace(ut,pt,wt){const Tt=2*ut;return this.float32[Tt+0]=pt,this.float32[Tt+1]=wt,ut}}iu.prototype.bytesPerElement=8,Mo(iu,"StructArrayLayout2f8");class su extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt){const St=this.length;return this.resize(St+1),this.emplace(St,ut,pt,wt,Tt)}emplace(ut,pt,wt,Tt,St){const It=6*ut;return this.uint32[3*ut+0]=pt,this.uint16[It+2]=wt,this.uint16[It+3]=Tt,this.uint16[It+4]=St,ut}}su.prototype.bytesPerElement=12,Mo(su,"StructArrayLayout1ul3ui12");class au extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,ut)}emplace(ut,pt){return this.uint16[1*ut+0]=pt,ut}}au.prototype.bytesPerElement=2,Mo(au,"StructArrayLayout1ui2");class ou extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){const an=this.length;return this.resize(an+1),this.emplace(an,ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an){const ln=16*ut;return this.float32[ln+0]=pt,this.float32[ln+1]=wt,this.float32[ln+2]=Tt,this.float32[ln+3]=St,this.float32[ln+4]=It,this.float32[ln+5]=Lt,this.float32[ln+6]=Xt,this.float32[ln+7]=Yt,this.float32[ln+8]=Mi,this.float32[ln+9]=vr,this.float32[ln+10]=br,this.float32[ln+11]=Ar,this.float32[ln+12]=Vr,this.float32[ln+13]=nn,this.float32[ln+14]=sn,this.float32[ln+15]=an,ut}}ou.prototype.bytesPerElement=64,Mo(ou,"StructArrayLayout16f64");class lu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(ut,pt,wt,Tt,St,It,Lt){const Xt=this.length;return this.resize(Xt+1),this.emplace(Xt,ut,pt,wt,Tt,St,It,Lt)}emplace(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=10*ut,Mi=5*ut;return this.uint16[Yt+0]=pt,this.uint16[Yt+1]=wt,this.uint16[Yt+2]=Tt,this.uint16[Yt+3]=St,this.float32[Mi+2]=It,this.float32[Mi+3]=Lt,this.float32[Mi+4]=Xt,ut}}lu.prototype.bytesPerElement=20,Mo(lu,"StructArrayLayout4ui3f20");class uu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,ut)}emplace(ut,pt){return this.int16[1*ut+0]=pt,ut}}uu.prototype.bytesPerElement=2,Mo(uu,"StructArrayLayout1i2");class cu extends El{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(ut){const pt=this.length;return this.resize(pt+1),this.emplace(pt,ut)}emplace(ut,pt){return this.uint8[1*ut+0]=pt,ut}}cu.prototype.bytesPerElement=1,Mo(cu,"StructArrayLayout1ub1");class hu extends Pl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}hu.prototype.size=40;class pu extends Hl{get(ut){return new hu(this,ut)}}Mo(pu,"CollisionBoxArray");class fu extends Pl{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(ut){this._structArray.uint8[this._pos1+49]=ut}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(ut){this._structArray.uint8[this._pos1+50]=ut}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(ut){this._structArray.uint32[this._pos4+13]=ut}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(ut){this._structArray.uint8[this._pos1+58]=ut}}fu.prototype.size=60;class du extends tu{get(ut){return new fu(this,ut)}}Mo(du,"PlacedSymbolArray");class mu extends Pl{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(ut){this._structArray.uint32[this._pos4+14]=ut}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(ut){this._structArray.float32[this._pos4+18]=ut}get occlusionState(){return this._structArray.float32[this._pos4+19]}set occlusionState(ut){this._structArray.float32[this._pos4+19]=ut}get occlusionOpacity(){return this._structArray.float32[this._pos4+20]}set occlusionOpacity(ut){this._structArray.float32[this._pos4+20]=ut}get hasIconTextFit(){return this._structArray.uint8[this._pos1+84]}}mu.prototype.size=88;class yu extends eu{get(ut){return new mu(this,ut)}}Mo(yu,"SymbolInstanceArray");class gu extends Yl{getoffsetX(ut){return this.float32[1*ut+0]}}Mo(gu,"GlyphOffsetArray");class xu extends Cl{getx(ut){return this.int16[2*ut+0]}gety(ut){return this.int16[2*ut+1]}}Mo(xu,"SymbolLineVertexArray");class bu extends Pl{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}bu.prototype.size=12;class vu extends su{get(ut){return new bu(this,ut)}}Mo(vu,"FeatureIndexArray");class _u extends Zl{geta_centroid_pos0(ut){return this.uint16[2*ut+0]}geta_centroid_pos1(ut){return this.uint16[2*ut+1]}}Mo(_u,"FillExtrusionCentroidArray");const M_=Bl([{name:"a_pos",components:2,type:"Int16"}],4),S_=Bl([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Au{constructor(ut=[]){this.segments=ut}_prepareSegment(ut,pt,wt,Tt){let St=this.segments[this.segments.length-1];return ut>Au.MAX_VERTEX_ARRAY_LENGTH&&fr(`Max vertices per segment is ${Au.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${ut}`),(!St||St.vertexLength+ut>Au.MAX_VERTEX_ARRAY_LENGTH||St.sortKey!==Tt)&&(St={vertexOffset:pt,primitiveOffset:wt,vertexLength:0,primitiveLength:0},void 0!==Tt&&(St.sortKey=Tt),this.segments.push(St)),St}prepareSegment(ut,pt,wt,Tt){return this._prepareSegment(ut,pt.length,wt.length,Tt)}get(){return this.segments}destroy(){for(const ut of this.segments)for(const pt in ut.vaos)ut.vaos[pt].destroy()}static simpleSegment(ut,pt,wt,Tt){return new Au([{vertexOffset:ut,primitiveOffset:pt,vertexLength:wt,primitiveLength:Tt,vaos:{},sortKey:0}])}}function Su(ut,pt){return 256*(ut=Ke(Math.floor(ut),0,255))+Ke(Math.floor(pt),0,255)}Au.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Mo(Au,"SegmentVector");const A_=Bl([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),I_=Bl([{name:"a_dash",components:4,type:"Uint16"}]);class ku{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(ut,pt,wt,Tt){this.ids.push(zu(ut)),this.positions.push(pt,wt,Tt)}eachPosition(ut,pt){const wt=zu(ut);let Tt=0,St=this.ids.length-1;for(;Tt<St;){const ut=Tt+St>>1;this.ids[ut]>=wt?St=ut:Tt=ut+1}for(;this.ids[Tt]===wt;)pt(this.positions[3*Tt],this.positions[3*Tt+1],this.positions[3*Tt+2]),Tt++}static serialize(ut,pt){const wt=new Float64Array(ut.ids),Tt=new Uint32Array(ut.positions);return Pu(wt,Tt,0,wt.length-1),pt&&(pt.add(wt.buffer),pt.add(Tt.buffer)),{ids:wt,positions:Tt}}static deserialize(ut){const pt=new ku;let wt;pt.ids=ut.ids,pt.positions=ut.positions;for(const ut of pt.ids)ut!==wt&&pt.uniqueIds.push(ut),wt=ut;return pt.indexed=!0,pt}}function zu(ut){const pt=+ut;return!isNaN(pt)&&Number.MIN_SAFE_INTEGER<=pt&&pt<=Number.MAX_SAFE_INTEGER?pt:Yd(String(ut))}function Pu(ut,pt,wt,Tt){for(;wt<Tt;){const St=ut[wt+Tt>>1];let It=wt-1,Lt=Tt+1;for(;;){do{It++}while(ut[It]<St);do{Lt--}while(ut[Lt]>St);if(It>=Lt)break;Eu(ut,It,Lt),Eu(pt,3*It,3*Lt),Eu(pt,3*It+1,3*Lt+1),Eu(pt,3*It+2,3*Lt+2)}Lt-wt<Tt-Lt?(Pu(ut,pt,wt,Lt),wt=Lt+1):(Pu(ut,pt,Lt+1,Tt),Tt=Lt)}}function Eu(ut,pt,wt){const Tt=ut[pt];ut[pt]=ut[wt],ut[wt]=Tt}Mo(ku,"FeaturePositionMap");class Bu{constructor(ut){this.gl=ut.gl,this.initialized=!1}fetchUniformLocation(ut,pt){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(ut,pt),this.initialized=!0),!!this.location}set(ut,pt,wt){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Du extends Bu{constructor(ut){super(ut),this.current=0}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&this.current!==wt&&(this.current=wt,this.gl.uniform1i(this.location,wt))}}class Cu extends Bu{constructor(ut){super(ut),this.current=0}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&this.current!==wt&&(this.current=wt,this.gl.uniform1f(this.location,wt))}}class Ru extends Bu{constructor(ut){super(ut),this.current=[0,0]}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&(wt[0]===this.current[0]&&wt[1]===this.current[1]||(this.current=wt,this.gl.uniform2f(this.location,wt[0],wt[1])))}}class Vu extends Bu{constructor(ut){super(ut),this.current=[0,0,0]}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&(wt[0]===this.current[0]&&wt[1]===this.current[1]&&wt[2]===this.current[2]||(this.current=wt,this.gl.uniform3f(this.location,wt[0],wt[1],wt[2])))}}class Fu extends Bu{constructor(ut){super(ut),this.current=[0,0,0,0]}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&(wt[0]===this.current[0]&&wt[1]===this.current[1]&&wt[2]===this.current[2]&&wt[3]===this.current[3]||(this.current=wt,this.gl.uniform4f(this.location,wt[0],wt[1],wt[2],wt[3])))}}class Lu extends Bu{constructor(ut){super(ut),this.current=qn.transparent.toRenderColor(null)}set(ut,pt,wt){this.fetchUniformLocation(ut,pt)&&(wt.r===this.current.r&&wt.g===this.current.g&&wt.b===this.current.b&&wt.a===this.current.a||(this.current=wt,this.gl.uniform4f(this.location,wt.r,wt.g,wt.b,wt.a)))}}const C_=new Float32Array(16);class Uu extends Bu{constructor(ut){super(ut),this.current=C_}set(ut,pt,wt){if(this.fetchUniformLocation(ut,pt)){if(wt[12]!==this.current[12]||wt[0]!==this.current[0])return this.current=wt,void this.gl.uniformMatrix4fv(this.location,!1,wt);for(let ut=1;ut<16;ut++)if(wt[ut]!==this.current[ut]){this.current=wt,this.gl.uniformMatrix4fv(this.location,!1,wt);break}}}}const P_=new Float32Array(9),z_=new Float32Array(4);class qu extends Bu{constructor(ut){super(ut),this.current=z_}set(ut,pt,wt){if(this.fetchUniformLocation(ut,pt))for(let ut=0;ut<4;ut++)if(wt[ut]!==this.current[ut]){this.current=wt,this.gl.uniformMatrix2fv(this.location,!1,wt);break}}}function $u(ut){return[Su(255*ut.r,255*ut.g),Su(255*ut.b,255*ut.a)]}class Gu{constructor(ut,pt,wt,Tt){this.value=ut,this.uniformNames=pt.map((ut=>`u_${ut}`)),this.type=wt,this.context=Tt}setUniform(ut,pt,wt,Tt,St){const It=Tt.constantOr(this.value);pt.set(ut,St,It instanceof qn?It.toRenderColor(this.context.lut):It)}getBinding(ut,pt){return"color"===this.type?new Lu(ut):new Cu(ut)}}class Xu{constructor(ut,pt){this.uniformNames=pt.map((ut=>`u_${ut}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(ut){this.pixelRatio=ut.pixelRatio||1,this.pattern=ut.tl.concat(ut.br)}setUniform(ut,pt,wt,Tt,St){const It="u_pattern"===St||"u_dash"===St?this.pattern:"u_pixel_ratio"===St?this.pixelRatio:null;It&&pt.set(ut,St,It)}getBinding(ut,pt){return"u_pattern"===pt||"u_dash"===pt?new Fu(ut):new Cu(ut)}}class Yu{constructor(ut,pt,wt,Tt){this.expression=ut,this.type=wt,this.maxValue=0,this.paintVertexAttributes=pt.map((ut=>({name:`a_${ut}`,type:"Float32",components:"color"===wt?2:1,offset:0}))),this.paintVertexArray=new Tt}populatePaintArray(ut,pt,wt,Tt,St,It,Lt){const Xt=this.paintVertexArray.length,Yt=this.expression.evaluate(new Ho(0,{brightness:It}),pt,{},St,Tt,Lt);this.paintVertexArray.resize(ut),this._setPaintValue(Xt,ut,Yt,this.context)}updatePaintArray(ut,pt,wt,Tt,St,It,Lt){const Xt=this.expression.evaluate({zoom:0,brightness:Lt},wt,Tt,void 0,St);this._setPaintValue(ut,pt,Xt,this.context)}_setPaintValue(ut,pt,wt,Tt){if("color"===this.type){const St=$u(wt.toRenderColor(Tt.lut));for(let wt=ut;wt<pt;wt++)this.paintVertexArray.emplace(wt,St[0],St[1])}else{for(let Tt=ut;Tt<pt;Tt++)this.paintVertexArray.emplace(Tt,wt);this.maxValue=Math.max(this.maxValue,Math.abs(wt))}}upload(ut){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=ut.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Zu{constructor(ut,pt,wt,Tt,St,It){this.expression=ut,this.uniformNames=pt.map((ut=>`u_${ut}_t`)),this.type=wt,this.useIntegerZoom=Tt,this.context=St,this.maxValue=0,this.paintVertexAttributes=pt.map((ut=>({name:`a_${ut}`,type:"Float32",components:"color"===wt?4:2,offset:0}))),this.paintVertexArray=new It}populatePaintArray(ut,pt,wt,Tt,St,It,Lt){const Xt=this.expression.evaluate(new Ho(this.context.zoom,{brightness:It}),pt,{},St,Tt,Lt),Yt=this.expression.evaluate(new Ho(this.context.zoom+1,{brightness:It}),pt,{},St,Tt,Lt),Mi=this.paintVertexArray.length;this.paintVertexArray.resize(ut),this._setPaintValue(Mi,ut,Xt,Yt,this.context)}updatePaintArray(ut,pt,wt,Tt,St,It,Lt){const Xt=this.expression.evaluate({zoom:this.context.zoom,brightness:Lt},wt,Tt,void 0,St),Yt=this.expression.evaluate({zoom:this.context.zoom+1,brightness:Lt},wt,Tt,void 0,St);this._setPaintValue(ut,pt,Xt,Yt,this.context)}_setPaintValue(ut,pt,wt,Tt,St){if("color"===this.type){const Tt=$u(wt.toRenderColor(St.lut)),It=$u(wt.toRenderColor(St.lut));for(let wt=ut;wt<pt;wt++)this.paintVertexArray.emplace(wt,Tt[0],Tt[1],It[0],It[1])}else{for(let St=ut;St<pt;St++)this.paintVertexArray.emplace(St,wt,Tt);this.maxValue=Math.max(this.maxValue,Math.abs(wt),Math.abs(Tt))}}upload(ut){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=ut.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(ut,pt,wt,Tt,St){const It=this.useIntegerZoom?Math.floor(wt.zoom):wt.zoom,Lt=Ke(this.expression.interpolationFactor(It,this.context.zoom,this.context.zoom+1),0,1);pt.set(ut,St,Lt)}getBinding(ut,pt){return new Cu(ut)}}class Hu{constructor(ut,pt,wt,Tt,St){this.expression=ut,this.layerId=St,this.paintVertexAttributes=("array"===wt?I_:A_).members;for(let ut=0;ut<pt.length;++ut);this.paintVertexArray=new Tt}populatePaintArray(ut,pt,wt,Tt){const St=this.paintVertexArray.length;this.paintVertexArray.resize(ut),this._setPaintValues(St,ut,pt.patterns&&pt.patterns[this.layerId],wt)}updatePaintArray(ut,pt,wt,Tt,St,It,Lt){this._setPaintValues(ut,pt,wt.patterns&&wt.patterns[this.layerId],It)}_setPaintValues(ut,pt,wt,Tt){if(!Tt||!wt)return;const St=Tt[wt];if(!St)return;const{tl:It,br:Lt,pixelRatio:Xt}=St;for(let wt=ut;wt<pt;wt++)this.paintVertexArray.emplace(wt,It[0],It[1],Lt[0],Lt[1],Xt)}upload(ut){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=ut.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ku{constructor(ut,pt,wt=(()=>!0)){this.binders={},this._buffers=[],this.context=pt;const Tt=[];for(const St in ut.paint._values){const It=ut.paint.get(St);if(!wt(St))continue;if(!(It instanceof rl&&Wa(It.property.specification)))continue;const Lt=Qu(St,ut.type),Xt=It.value,Yt=It.property.specification.type,Mi=!!It.property.useIntegerZoom,vr="line-dasharray"===St||St.endsWith("pattern"),br="line-dasharray"===St&&"constant"!==ut.layout.get("line-cap").value.kind;if("constant"!==Xt.kind||br)if("source"===Xt.kind||br||vr){const pt=rc(St,Yt,"source");this.binders[St]=vr?new Hu(Xt,Lt,Yt,pt,ut.id):new Yu(Xt,Lt,Yt,pt),Tt.push(`/a_${St}`)}else{const ut=rc(St,Yt,"composite");this.binders[St]=new Zu(Xt,Lt,Yt,Mi,pt,ut),Tt.push(`/z_${St}`)}else this.binders[St]=vr?new Xu(Xt.value,Lt):new Gu(Xt.value,Lt,Yt,pt),Tt.push(`/u_${St}`)}this.cacheKey=Tt.sort().join("")}getMaxValue(ut){const pt=this.binders[ut];return pt instanceof Yu||pt instanceof Zu?pt.maxValue:0}populatePaintArrays(ut,pt,wt,Tt,St,It,Lt){for(const Xt in this.binders){const Yt=this.binders[Xt];Yt.context=this.context,(Yt instanceof Yu||Yt instanceof Zu||Yt instanceof Hu)&&Yt.populatePaintArray(ut,pt,wt,Tt,St,It,Lt)}}setConstantPatternPositions(ut){for(const pt in this.binders){const wt=this.binders[pt];wt instanceof Xu&&wt.setConstantPatternPositions(ut)}}updatePaintArrays(ut,pt,wt,Tt,St,It,Lt,Xt){let Yt=!1;const Mi=Object.keys(ut),vr=0!==Mi.length,br=vr?Mi:pt.uniqueIds;this.context.lut=St.lut;for(const Mi in this.binders){const Ar=this.binders[Mi];if(Ar.context=this.context,(Ar instanceof Yu||Ar instanceof Zu||Ar instanceof Hu)&&(!0===Ar.expression.isStateDependent||!1===Ar.expression.isLightConstant)){const Vr=St.paint.get(Mi);Ar.expression=Vr.value;for(const wt of br){const St=ut[wt.toString()];pt.eachPosition(wt,((ut,pt,wt)=>{const Yt=Tt.feature(ut);Ar.updatePaintArray(pt,wt,Yt,St,It,Lt,Xt)}))}if(!vr)for(const pt of wt.uniqueIds){const St=ut[pt.toString()];wt.eachPosition(pt,((ut,pt,wt)=>{const Yt=Tt.feature(ut);Ar.updatePaintArray(pt,wt,Yt,St,It,Lt,Xt)}))}Yt=!0}}return Yt}defines(){const ut=[];for(const pt in this.binders){const wt=this.binders[pt];(wt instanceof Gu||wt instanceof Xu)&&ut.push(...wt.uniformNames.map((ut=>`#define HAS_UNIFORM_${ut}`)))}return ut}getBinderAttributes(){const ut=[];for(const pt in this.binders){const wt=this.binders[pt];if(wt instanceof Yu||wt instanceof Zu||wt instanceof Hu)for(let pt=0;pt<wt.paintVertexAttributes.length;pt++)ut.push(wt.paintVertexAttributes[pt].name)}return ut}getBinderUniforms(){const ut=[];for(const pt in this.binders){const wt=this.binders[pt];if(wt instanceof Gu||wt instanceof Xu||wt instanceof Zu)for(const pt of wt.uniformNames)ut.push(pt)}return ut}getPaintVertexBuffers(){return this._buffers}getUniforms(ut){const pt=[];for(const wt in this.binders){const Tt=this.binders[wt];if(Tt instanceof Gu||Tt instanceof Xu||Tt instanceof Zu)for(const St of Tt.uniformNames)pt.push({name:St,property:wt,binding:Tt.getBinding(ut,St)})}return pt}setUniforms(ut,pt,wt,Tt,St){for(const{name:pt,property:It,binding:Lt}of wt)this.binders[It].setUniform(ut,Lt,St,Tt.get(It),pt)}updatePaintBuffers(){this._buffers=[];for(const ut in this.binders){const pt=this.binders[ut];(pt instanceof Yu||pt instanceof Zu||pt instanceof Hu)&&pt.paintVertexBuffer&&this._buffers.push(pt.paintVertexBuffer)}}upload(ut){for(const pt in this.binders){const wt=this.binders[pt];(wt instanceof Yu||wt instanceof Zu||wt instanceof Hu)&&wt.upload(ut)}this.updatePaintBuffers()}destroy(){for(const ut in this.binders){const pt=this.binders[ut];(pt instanceof Yu||pt instanceof Zu||pt instanceof Hu)&&pt.destroy()}}}class Wu{constructor(ut,pt,wt=(()=>!0)){this.programConfigurations={};for(const Tt of ut)this.programConfigurations[Tt.id]=new Ku(Tt,pt,wt);this.needsUpload=!1,this._featureMap=new ku,this._featureMapWithoutIds=new ku,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(ut,pt,wt,Tt,St,It,Lt,Xt){for(const wt in this.programConfigurations)this.programConfigurations[wt].populatePaintArrays(ut,pt,Tt,St,It,Lt,Xt);void 0!==pt.id?this._featureMap.add(pt.id,wt,this._bufferOffset,ut):(this._featureMapWithoutIds.add(this._idlessCounter,wt,this._bufferOffset,ut),this._idlessCounter+=1),this._bufferOffset=ut,this.needsUpload=!0}updatePaintArrays(ut,pt,wt,Tt,St,It){for(const Lt of wt)this.needsUpload=this.programConfigurations[Lt.id].updatePaintArrays(ut,this._featureMap,this._featureMapWithoutIds,pt,Lt,Tt,St,It||0)||this.needsUpload}get(ut){return this.programConfigurations[ut]}upload(ut){if(this.needsUpload){for(const pt in this.programConfigurations)this.programConfigurations[pt].upload(ut);this.needsUpload=!1}}destroy(){for(const ut in this.programConfigurations)this.programConfigurations[ut].destroy()}}const L_={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Qu(ut,pt){return L_[ut]||[ut.replace(`${pt}-`,"").replace(/-/g,"_")]}const R_={"line-pattern":{source:Nl,composite:Nl},"fill-pattern":{source:Nl,composite:Nl},"fill-extrusion-pattern":{source:Nl,composite:Nl},"line-dasharray":{source:jl,composite:jl}},D_={color:{source:iu,composite:Ol},number:{source:Yl,composite:iu}};function rc(ut,pt,wt){const Tt=R_[ut];return Tt&&Tt[wt]||D_[pt][wt]}Mo(Gu,"ConstantBinder"),Mo(Xu,"PatternConstantBinder"),Mo(Yu,"SourceExpressionBinder"),Mo(Hu,"PatternCompositeBinder"),Mo(Zu,"CompositeExpressionBinder"),Mo(Ku,"ProgramConfiguration",{omit:["_buffers"]}),Mo(Wu,"ProgramConfigurationSet");const k_=xf/Math.PI/2,O_=5,B_=6,F_=16383,N_=64,V_=[N_,32,16],U_=-k_,j_=k_;function hc(ut,pt,wt,Tt=k_){return wt=$e(wt),[ut*Math.sin(wt)*Tt,-pt*Tt,ut*Math.cos(wt)*Tt]}function pc(ut,pt,wt){return hc(Math.cos($e(ut)),Math.sin($e(ut)),pt,wt)}const G_=6371008.8,q_=2*Math.PI*G_;class mc{constructor(ut,pt){if(isNaN(ut)||isNaN(pt))throw new Error(`Invalid LngLat object: (${ut}, ${pt})`);if(this.lng=+ut,this.lat=+pt,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new mc(Je(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(ut){const pt=Math.PI/180,wt=this.lat*pt,Tt=ut.lat*pt,St=Math.sin(wt)*Math.sin(Tt)+Math.cos(wt)*Math.cos(Tt)*Math.cos((ut.lng-this.lng)*pt);return G_*Math.acos(Math.min(St,1))}toBounds(ut=0){const pt=360*ut/40075017,wt=pt/Math.cos(Math.PI/180*this.lat);return new yc({lng:this.lng-wt,lat:this.lat-pt},{lng:this.lng+wt,lat:this.lat+pt})}toEcef(ut){return pc(this.lat,this.lng,k_+ut*k_/G_)}static convert(ut){if(ut instanceof mc)return ut;if(Array.isArray(ut)&&(2===ut.length||3===ut.length))return new mc(Number(ut[0]),Number(ut[1]));if(!Array.isArray(ut)&&"object"==typeof ut&&null!==ut)return new mc(Number("lng"in ut?ut.lng:ut.lon),Number(ut.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class yc{constructor(ut,pt){if(ut)if(pt)this.setSouthWest(ut).setNorthEast(pt);else if(4===ut.length){const pt=ut;this.setSouthWest([pt[0],pt[1]]).setNorthEast([pt[2],pt[3]])}else{const pt=ut;this.setSouthWest(pt[0]).setNorthEast(pt[1])}}setNorthEast(ut){return this._ne=ut instanceof mc?new mc(ut.lng,ut.lat):mc.convert(ut),this}setSouthWest(ut){return this._sw=ut instanceof mc?new mc(ut.lng,ut.lat):mc.convert(ut),this}extend(ut){const pt=this._sw,wt=this._ne;let Tt,St;if(ut instanceof mc)Tt=ut,St=ut;else{if(!(ut instanceof yc))return Array.isArray(ut)?4===ut.length||ut.every(Array.isArray)?this.extend(yc.convert(ut)):this.extend(mc.convert(ut)):"object"==typeof ut&&null!==ut&&ut.hasOwnProperty("lat")&&(ut.hasOwnProperty("lon")||ut.hasOwnProperty("lng"))?this.extend(mc.convert(ut)):this;if(Tt=ut._sw,St=ut._ne,!Tt||!St)return this}return pt||wt?(pt.lng=Math.min(Tt.lng,pt.lng),pt.lat=Math.min(Tt.lat,pt.lat),wt.lng=Math.max(St.lng,wt.lng),wt.lat=Math.max(St.lat,wt.lat)):(this._sw=new mc(Tt.lng,Tt.lat),this._ne=new mc(St.lng,St.lat)),this}getCenter(){return new mc((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new mc(this.getWest(),this.getNorth())}getSouthEast(){return new mc(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(ut){const{lng:pt,lat:wt}=mc.convert(ut);let Tt=this._sw.lng<=pt&&pt<=this._ne.lng;return this._sw.lng>this._ne.lng&&(Tt=this._sw.lng>=pt&&pt>=this._ne.lng),this._sw.lat<=wt&&wt<=this._ne.lat&&Tt}static convert(ut){return!ut||ut instanceof yc?ut:new yc(ut)}}var Z_={};!function(ut,pt){!function(ut){function e(ut,pt,wt){var Tt=r(256*ut,256*(pt=Math.pow(2,wt)-pt-1),wt),St=r(256*(ut+1),256*(pt+1),wt);return Tt[0]+","+Tt[1]+","+St[0]+","+St[1]}function r(ut,pt,wt){var Tt=2*Math.PI*6378137/256/Math.pow(2,wt);return[ut*Tt-2*Math.PI*6378137/2,pt*Tt-2*Math.PI*6378137/2]}ut.getURL=function(ut,pt,wt,Tt,St,It){return It=It||{},ut+"?"+["bbox="+e(wt,Tt,St),"format="+(It.format||"image/png"),"service="+(It.service||"WMS"),"version="+(It.version||"1.1.1"),"request="+(It.request||"GetMap"),"srs="+(It.srs||"EPSG:3857"),"width="+(It.width||256),"height="+(It.height||256),"layers="+pt].join("&")},ut.getTileBBox=e,ut.getMercCoords=r,Object.defineProperty(ut,"__esModule",{value:!0})}(pt)}(0,Z_);var $_=Z_;class bc{constructor(ut,pt,wt){this.z=ut,this.x=pt,this.y=wt,this.key=wc(0,ut,ut,pt,wt)}equals(ut){return this.z===ut.z&&this.x===ut.x&&this.y===ut.y}url(ut,pt){const wt=$_.getTileBBox(this.x,this.y,this.z),Tt=function(ut,pt,wt){let Tt,St="";for(let It=ut;It>0;It--)Tt=1<<It-1,St+=(pt&Tt?1:0)+(wt&Tt?2:0);return St}(this.z,this.x,this.y);return ut[(this.x+this.y)%ut.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===pt?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",Tt).replace("{bbox-epsg-3857}",wt)}toString(){return`${this.z}/${this.x}/${this.y}`}}class vc{constructor(ut,pt){this.wrap=ut,this.canonical=pt,this.key=wc(ut,pt.z,pt.z,pt.x,pt.y)}}class _c{constructor(ut,pt,wt,Tt,St){this.overscaledZ=ut,this.wrap=pt,this.canonical=new bc(wt,+Tt,+St),this.key=0===pt&&ut===wt?this.canonical.key:wc(pt,ut,wt,Tt,St)}equals(ut){return this.overscaledZ===ut.overscaledZ&&this.wrap===ut.wrap&&this.canonical.equals(ut.canonical)}scaledTo(ut){const pt=this.canonical.z-ut;return ut>this.canonical.z?new _c(ut,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new _c(ut,this.wrap,ut,this.canonical.x>>pt,this.canonical.y>>pt)}calculateScaledKey(ut,pt=!0){if(this.overscaledZ===ut&&pt)return this.key;if(ut>this.canonical.z)return wc(this.wrap*+pt,ut,this.canonical.z,this.canonical.x,this.canonical.y);{const wt=this.canonical.z-ut;return wc(this.wrap*+pt,ut,ut,this.canonical.x>>wt,this.canonical.y>>wt)}}isChildOf(ut){if(ut.wrap!==this.wrap)return!1;const pt=this.canonical.z-ut.canonical.z;return 0===ut.overscaledZ||ut.overscaledZ<this.overscaledZ&&ut.canonical.z<this.canonical.z&&ut.canonical.x===this.canonical.x>>pt&&ut.canonical.y===this.canonical.y>>pt}children(ut){if(this.overscaledZ>=ut)return[new _c(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const pt=this.canonical.z+1,wt=2*this.canonical.x,Tt=2*this.canonical.y;return[new _c(pt,this.wrap,pt,wt,Tt),new _c(pt,this.wrap,pt,wt+1,Tt),new _c(pt,this.wrap,pt,wt,Tt+1),new _c(pt,this.wrap,pt,wt+1,Tt+1)]}isLessThan(ut){return this.wrap<ut.wrap||!(this.wrap>ut.wrap)&&(this.overscaledZ<ut.overscaledZ||!(this.overscaledZ>ut.overscaledZ)&&(this.canonical.x<ut.canonical.x||!(this.canonical.x>ut.canonical.x)&&this.canonical.y<ut.canonical.y))}wrapped(){return new _c(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(ut){return new _c(this.overscaledZ,ut,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new vc(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function wc(ut,pt,wt,Tt,St){const It=1<<Math.min(wt,22);let Lt=It*(St%It)+Tt%It;return ut&&wt<22&&(Lt+=It*It*((ut<0?-2*ut-1:2*ut)%(1<<2*(22-wt)))),16*(32*Lt+wt)+(pt-wt)}const W_=[ut=>{let pt=ut.canonical.x-1,wt=ut.wrap;return pt<0&&(pt=(1<<ut.canonical.z)-1,wt--),new _c(ut.overscaledZ,wt,ut.canonical.z,pt,ut.canonical.y)},ut=>{let pt=ut.canonical.x+1,wt=ut.wrap;return pt===1<<ut.canonical.z&&(pt=0,wt++),new _c(ut.overscaledZ,wt,ut.canonical.z,pt,ut.canonical.y)},ut=>new _c(ut.overscaledZ,ut.wrap,ut.canonical.z,ut.canonical.x,(0===ut.canonical.y?1<<ut.canonical.z:ut.canonical.y)-1),ut=>new _c(ut.overscaledZ,ut.wrap,ut.canonical.z,ut.canonical.x,ut.canonical.y===(1<<ut.canonical.z)-1?0:ut.canonical.y+1)];Mo(bc,"CanonicalTileID"),Mo(_c,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const H_=0,X_=25.5;function Ic(ut){return q_*Math.cos(ut*Math.PI/180)}function Tc(ut){return(180+ut)/360}function kc(ut){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+ut*Math.PI/360)))/360}function zc(ut,pt){return ut/Ic(pt)}function Pc(ut){return 360*ut-180}function Ec(ut){return 360/Math.PI*Math.atan(Math.exp((180-360*ut)*Math.PI/180))-90}function Bc(ut,pt){return ut*Ic(Ec(pt))}const Y_=85.051129;function Cc(ut){return Math.cos($e(Ke(ut,-Y_,Y_)))}function Rc(ut,pt){const wt=Ke(pt,H_,X_),Tt=Math.pow(2,wt);return Cc(ut)*q_/(512*Tt)}function Vc(ut){return 1/Math.cos(ut*Math.PI/180)}function Fc(ut,pt=0){const wt=Math.exp(Math.PI*(1-(ut.y+pt/xf)/(1<<ut.z)*2));return 80150034*wt/(wt*wt+1)/xf/(1<<ut.z)}class Lc{constructor(ut,pt,wt=0){this.x=+ut,this.y=+pt,this.z=+wt}static fromLngLat(ut,pt=0){const wt=mc.convert(ut);return new Lc(Tc(wt.lng),kc(wt.lat),zc(pt,wt.lat))}toLngLat(){return new mc(Pc(this.x),Ec(this.y))}toAltitude(){return Bc(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/q_*Vc(Ec(this.y))}}function Oc(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=(pt+Tt)/2,vr=(wt+St)/2,br=new xc(Mi,vr);Xt(br),function(ut,pt,wt,Tt,St,It){const Lt=wt-St,Xt=Tt-It;return Math.abs((Tt-pt)*Lt-(wt-ut)*Xt)/Math.hypot(Lt,Xt)}(br.x,br.y,It.x,It.y,Lt.x,Lt.y)>=Yt?(Oc(ut,pt,wt,Mi,vr,It,br,Xt,Yt),Oc(ut,Mi,vr,Tt,St,br,Lt,Xt,Yt)):ut.push(Lt)}function Uc(ut,pt,wt){let Tt=ut[0],St=Tt.x,It=Tt.y;pt(Tt);const Lt=[Tt];for(let Xt=1;Xt<ut.length;Xt++){const Yt=ut[Xt],{x:Mi,y:vr}=Yt;pt(Yt),Oc(Lt,St,It,Mi,vr,Tt,Yt,pt,wt),St=Mi,It=vr,Tt=Yt}return Lt}function Nc(ut,pt,wt,Tt){if(Tt(pt,wt)){const St=pt.add(wt)._mult(.5);Nc(ut,pt,St,Tt),Nc(ut,St,wt,Tt)}else ut.push(wt)}function jc(ut,pt){let wt=ut[0];const Tt=[wt];for(let St=1;St<ut.length;St++){const It=ut[St];Nc(Tt,wt,It,pt),wt=It}return Tt}const K_=Math.pow(2,14)-1,J_=-K_-1;function Gc(ut,pt){const wt=Math.round(ut.x*pt),Tt=Math.round(ut.y*pt);return ut.x=Ke(wt,J_,K_),ut.y=Ke(Tt,J_,K_),(wt<ut.x||wt>ut.x+1||Tt<ut.y||Tt>ut.y+1)&&fr("Geometry exceeds allowed extent, reduce your vector tile buffer size"),ut}function Xc(ut,pt,wt){const Tt=ut.loadGeometry(),St=ut.extent,It=xf/St;if(pt&&wt&&wt.projection.isReprojectedInTileSpace){const It=1<<pt.z,{scale:Lt,x:Xt,y:Yt,projection:Mi}=wt,c=ut=>{const wt=Pc((pt.x+ut.x/St)/It),Tt=Ec((pt.y+ut.y/St)/It),vr=Mi.project(wt,Tt);ut.x=(vr.x*Lt-Xt)*St,ut.y=(vr.y*Lt-Yt)*St};for(let pt=0;pt<Tt.length;pt++)if(1!==ut.type)Tt[pt]=Uc(Tt[pt],c,1);else{const ut=[];for(const wt of Tt[pt])wt.x<0||wt.x>=St||wt.y<0||wt.y>=St||(c(wt),ut.push(wt));Tt[pt]=ut}}for(const ut of Tt)for(const pt of ut)Gc(pt,It);return Tt}function Yc(ut,pt){return{type:ut.type,id:ut.id,properties:ut.properties,geometry:pt?Xc(ut):[]}}function Zc(ut,pt,wt,Tt,St){ut.emplaceBack(2*pt+(Tt+1)/2,2*wt+(St+1)/2)}function Hc(ut,pt,wt){const Tt=16384;ut.emplaceBack(pt.x,pt.y,pt.z,wt[0]*Tt,wt[1]*Tt,wt[2]*Tt)}class Kc{constructor(ut){this.zoom=ut.zoom,this.overscaling=ut.overscaling,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=ut.index,this.hasPattern=!1,this.projection=ut.projection,this.layoutVertexArray=new Cl,this.indexArray=new Ql,this.segments=new Au,this.programConfigurations=new Wu(ut.layers,{zoom:ut.zoom,lut:ut.lut}),this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id))}updateFootprints(ut,pt){}populate(ut,pt,wt,Tt){const St=this.layers[0],It=[];let Lt=null;"circle"===St.type&&(Lt=St.layout.get("circle-sort-key"));for(const{feature:pt,id:St,index:Xt,sourceLayerIndex:Yt}of ut){const ut=this.layers[0]._featureFilter.needGeometry,Mi=Yc(pt,ut);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Mi,wt))continue;const vr=Lt?Lt.evaluate(Mi,{},wt):void 0,br={id:St,properties:pt.properties,type:pt.type,sourceLayerIndex:Yt,index:Xt,geometry:ut?Mi.geometry:Xc(pt,wt,Tt),patterns:{},sortKey:vr};It.push(br)}Lt&&It.sort(((ut,pt)=>ut.sortKey-pt.sortKey));let Xt=null;"globe"===Tt.projection.name&&(this.globeExtVertexArray=new ql,Xt=Tt.projection);for(const Tt of It){const{geometry:St,index:It,sourceLayerIndex:Lt}=Tt,Yt=ut[It].feature;this.addFeature(Tt,St,It,pt.availableImages,wt,Xt,pt.brightness),pt.featureIndex.insert(Yt,St,It,Lt,this.index)}}update(ut,pt,wt,Tt,St){const It=0!==Object.keys(ut).length;It&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(ut,pt,It?this.stateDependentLayers:this.layers,wt,Tt,St)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(ut){this.uploaded||(this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,M_.members),this.indexBuffer=ut.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=ut.createVertexBuffer(this.globeExtVertexArray,S_.members))),this.programConfigurations.upload(ut),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(ut,pt,wt,Tt,St,It,Lt){for(const wt of pt)for(const pt of wt){const wt=pt.x,Tt=pt.y;if(wt<0||wt>=xf||Tt<0||Tt>=xf)continue;if(It){const ut=It.projectTilePoint(wt,Tt,St),pt=It.upVector(St,wt,Tt),Lt=this.globeExtVertexArray;Hc(Lt,ut,pt),Hc(Lt,ut,pt),Hc(Lt,ut,pt),Hc(Lt,ut,pt)}const Lt=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,ut.sortKey),Xt=Lt.vertexLength;Zc(this.layoutVertexArray,wt,Tt,-1,-1),Zc(this.layoutVertexArray,wt,Tt,1,-1),Zc(this.layoutVertexArray,wt,Tt,1,1),Zc(this.layoutVertexArray,wt,Tt,-1,1),this.indexArray.emplaceBack(Xt,Xt+1,Xt+2),this.indexArray.emplaceBack(Xt,Xt+2,Xt+3),Lt.vertexLength+=4,Lt.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,ut,wt,{},Tt,St,Lt)}}function Wc(ut,pt){for(let wt=0;wt<ut.length;wt++)if(ah(pt,ut[wt]))return!0;for(let wt=0;wt<pt.length;wt++)if(ah(ut,pt[wt]))return!0;return!!eh(ut,pt)}function Jc(ut,pt,wt){return!!ah(ut,pt)||!!nh(pt,ut,wt)}function Qc(ut,pt){if(1===ut.length)return sh(pt,ut[0]);for(let wt=0;wt<pt.length;wt++){const Tt=pt[wt];for(let pt=0;pt<Tt.length;pt++)if(ah(ut,Tt[pt]))return!0}for(let wt=0;wt<ut.length;wt++)if(sh(pt,ut[wt]))return!0;for(let wt=0;wt<pt.length;wt++)if(eh(ut,pt[wt]))return!0;return!1}function th(ut,pt,wt){if(ut.length>1){if(eh(ut,pt))return!0;for(let Tt=0;Tt<pt.length;Tt++)if(nh(pt[Tt],ut,wt))return!0}for(let Tt=0;Tt<ut.length;Tt++)if(nh(ut[Tt],pt,wt))return!0;return!1}function eh(ut,pt){if(0===ut.length||0===pt.length)return!1;for(let wt=0;wt<ut.length-1;wt++){const Tt=ut[wt],St=ut[wt+1];for(let ut=0;ut<pt.length-1;ut++)if(rh(Tt,St,pt[ut],pt[ut+1]))return!0}return!1}function rh(ut,pt,wt,Tt){return dr(ut,wt,Tt)!==dr(pt,wt,Tt)&&dr(ut,pt,wt)!==dr(ut,pt,Tt)}function nh(ut,pt,wt){const Tt=wt*wt;if(1===pt.length)return ut.distSqr(pt[0])<Tt;for(let wt=1;wt<pt.length;wt++)if(ih(ut,pt[wt-1],pt[wt])<Tt)return!0;return!1}function ih(ut,pt,wt){const Tt=pt.distSqr(wt);if(0===Tt)return ut.distSqr(pt);const St=((ut.x-pt.x)*(wt.x-pt.x)+(ut.y-pt.y)*(wt.y-pt.y))/Tt;return ut.distSqr(St<0?pt:St>1?wt:wt.sub(pt)._mult(St)._add(pt))}function sh(ut,pt){let wt,Tt,St,It=!1;for(let Lt=0;Lt<ut.length;Lt++){wt=ut[Lt];for(let ut=0,Lt=wt.length-1;ut<wt.length;Lt=ut++)Tt=wt[ut],St=wt[Lt],Tt.y>pt.y!=St.y>pt.y&&pt.x<(St.x-Tt.x)*(pt.y-Tt.y)/(St.y-Tt.y)+Tt.x&&(It=!It)}return It}function ah(ut,pt){let wt=!1;for(let Tt=0,St=ut.length-1;Tt<ut.length;St=Tt++){const It=ut[Tt],Lt=ut[St];It.y>pt.y!=Lt.y>pt.y&&pt.x<(Lt.x-It.x)*(pt.y-It.y)/(Lt.y-It.y)+It.x&&(wt=!wt)}return wt}function oh(ut,pt,wt,Tt,St){for(const It of ut)if(pt<=It.x&&wt<=It.y&&Tt>=It.x&&St>=It.y)return!0;const It=[new xc(pt,wt),new xc(pt,St),new xc(Tt,St),new xc(Tt,wt)];if(ut.length>2)for(const pt of It)if(ah(ut,pt))return!0;for(let pt=0;pt<ut.length-1;pt++)if(lh(ut[pt],ut[pt+1],It))return!0;return!1}function lh(ut,pt,wt){const Tt=wt[0],St=wt[2];if(ut.x<Tt.x&&pt.x<Tt.x||ut.x>St.x&&pt.x>St.x||ut.y<Tt.y&&pt.y<Tt.y||ut.y>St.y&&pt.y>St.y)return!1;const It=dr(ut,pt,wt[0]);return It!==dr(ut,pt,wt[1])||It!==dr(ut,pt,wt[2])||It!==dr(ut,pt,wt[3])}function uh(ut,pt,wt,Tt,St,It){let Lt=pt.y-ut.y,Xt=ut.x-pt.x;if(It=It||0){const ut=Lt*Lt+Xt*Xt;if(0===ut)return!0;const pt=Math.sqrt(ut);Lt/=pt,Xt/=pt}return!((wt.x-ut.x)*Lt+(wt.y-ut.y)*Xt-It<0||(Tt.x-ut.x)*Lt+(Tt.y-ut.y)*Xt-It<0||(St.x-ut.x)*Lt+(St.y-ut.y)*Xt-It<0)}function ch(ut,pt,wt,Tt,St,It,Lt){return!(uh(ut,pt,Tt,St,It,Lt)||uh(pt,wt,Tt,St,It,Lt)||uh(wt,ut,Tt,St,It,Lt)||uh(Tt,St,ut,pt,wt,Lt)||uh(St,It,ut,pt,wt,Lt)||uh(It,Tt,ut,pt,wt,Lt))}function hh(ut,pt,wt){const Tt=pt.paint.get(ut).value;return"constant"===Tt.kind?Tt.value:wt.programConfigurations.get(pt.id).getMaxValue(ut)}function ph(ut){return Math.sqrt(ut[0]*ut[0]+ut[1]*ut[1])}function fh(ut,pt,wt,Tt,St){if(!pt[0]&&!pt[1])return ut;const It=xc.convert(pt)._mult(St);"viewport"===wt&&It._rotate(-Tt);const Lt=[];for(let pt=0;pt<ut.length;pt++)Lt.push(ut[pt].sub(It));return Lt}function dh(ut,pt,wt,Tt){const St=xc.convert(ut)._mult(Tt);return"viewport"===pt&&St._rotate(-wt),St}Mo(Kc,"CircleBucket",{omit:["layers"]});const Q_=new ol({"circle-sort-key":new sl(x_.layout_circle["circle-sort-key"]),visibility:new il(x_.layout_circle.visibility)});var sg={paint:new ol({"circle-radius":new sl(x_.paint_circle["circle-radius"]),"circle-color":new sl(x_.paint_circle["circle-color"]),"circle-blur":new sl(x_.paint_circle["circle-blur"]),"circle-opacity":new sl(x_.paint_circle["circle-opacity"]),"circle-translate":new il(x_.paint_circle["circle-translate"]),"circle-translate-anchor":new il(x_.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new il(x_.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new il(x_.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new sl(x_.paint_circle["circle-stroke-width"]),"circle-stroke-color":new sl(x_.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new sl(x_.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new il(x_.paint_circle["circle-emissive-strength"])}),layout:Q_};class gh{constructor(ut,pt){this.pos=ut,this.dir=pt}intersectsPlane(pt,wt,Tt){const St=ut._.dot(wt,this.dir);if(Math.abs(St)<1e-6)return!1;const It=((pt[0]-this.pos[0])*wt[0]+(pt[1]-this.pos[1])*wt[1]+(pt[2]-this.pos[2])*wt[2])/St;return Tt[0]=this.pos[0]+this.dir[0]*It,Tt[1]=this.pos[1]+this.dir[1]*It,Tt[2]=this.pos[2]+this.dir[2]*It,!0}closestPointOnSphere(pt,wt,Tt){if(ut._.equals(this.pos,pt)||0===wt)return Tt[0]=Tt[1]=Tt[2]=0,!1;const[St,It,Lt]=this.dir,Xt=this.pos[0]-pt[0],Yt=this.pos[1]-pt[1],Mi=this.pos[2]-pt[2],vr=St*St+It*It+Lt*Lt,br=2*(Xt*St+Yt*It+Mi*Lt),Ar=br*br-4*vr*(Xt*Xt+Yt*Yt+Mi*Mi-wt*wt);if(Ar<0){const ut=Math.max(-br/2,0),pt=Xt+St*ut,vr=Yt+It*ut,Ar=Mi+Lt*ut,Vr=Math.hypot(pt,vr,Ar);return Tt[0]=pt*wt/Vr,Tt[1]=vr*wt/Vr,Tt[2]=Ar*wt/Vr,!1}{const ut=(-br-Math.sqrt(Ar))/(2*vr);if(ut<0){const ut=Math.hypot(Xt,Yt,Mi);return Tt[0]=Xt*wt/ut,Tt[1]=Yt*wt/ut,Tt[2]=Mi*wt/ut,!1}return Tt[0]=Xt+St*ut,Tt[1]=Yt+It*ut,Tt[2]=Mi+Lt*ut,!0}}}class xh{constructor(ut,pt,wt,Tt,St){this.TL=ut,this.TR=pt,this.BR=wt,this.BL=Tt,this.horizon=St}static fromInvProjectionMatrix(pt,wt,Tt){const St=[-1,1,1],It=[1,1,1],Lt=[1,-1,1],Xt=[-1,-1,1],Yt=ut._.transformMat4(St,St,pt),Mi=ut._.transformMat4(It,It,pt),vr=ut._.transformMat4(Lt,Lt,pt),br=ut._.transformMat4(Xt,Xt,pt);return new xh(Yt,Mi,vr,br,wt/Tt)}}function bh(pt,wt,Tt){let St=1/0,It=-1/0;const Lt=[];for(const Xt of pt){ut._.sub(Lt,Xt,wt);const pt=ut._.dot(Lt,Tt);St=Math.min(St,pt),It=Math.max(It,pt)}return[St,It]}function vh(pt,wt){let Tt=!0;for(let St=0;St<pt.planes.length;St++){const It=pt.planes[St];let Lt=0;for(let pt=0;pt<wt.length;pt++)Lt+=ut._.dot(It,wt[pt])+It[3]>=0;if(0===Lt)return 0;Lt!==wt.length&&(Tt=!1)}return Tt?2:1}function _h(ut,pt){for(const wt of ut.projections){const Tt=bh(pt,ut.points[0],wt.axis);if(wt.projection[1]<Tt[0]||wt.projection[0]>Tt[1])return 0}return 1}function wh(pt,wt){let Tt=0;const St=[0,0,0,0];for(let It=0;It<pt.length;It++)St[0]=pt[It][0],St[1]=pt[It][1],St[2]=pt[It][2],St[3]=1,ut.aA.dot(St,wt)>=0&&Tt++;return Tt}class Mh{constructor(pt,wt){this.points=pt||new Array(8).fill([0,0,0]),this.planes=wt||new Array(6).fill([0,0,0,0]),this.bounds=Ah.fromPoints(this.points),this.projections=[],this.frustumEdges=[ut._.sub([],this.points[2],this.points[3]),ut._.sub([],this.points[0],this.points[3]),ut._.sub([],this.points[4],this.points[0]),ut._.sub([],this.points[5],this.points[1]),ut._.sub([],this.points[6],this.points[2]),ut._.sub([],this.points[7],this.points[3])];for(const ut of this.frustumEdges){const pt=[0,-ut[2],ut[1]],wt=[ut[2],0,-ut[0]];this.projections.push({axis:pt,projection:bh(this.points,this.points[0],pt)}),this.projections.push({axis:wt,projection:bh(this.points,this.points[0],wt)})}}static fromInvProjectionMatrix(pt,wt,Tt,St){const It=Math.pow(2,Tt),Lt=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((Tt=>{const Lt=ut.aA.transformMat4([],Tt,pt),Xt=1/Lt[3]/wt*It;return ut.aA.mul(Lt,Lt,[Xt,Xt,St?1/Lt[3]:Xt,Xt])})),Xt=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((pt=>{const wt=ut._.sub([],Lt[pt[0]],Lt[pt[1]]),Tt=ut._.sub([],Lt[pt[2]],Lt[pt[1]]),St=ut._.normalize([],ut._.cross([],wt,Tt)),It=-ut._.dot(St,Lt[pt[1]]);return St.concat(It)})),Yt=[];for(let ut=0;ut<Lt.length;ut++)Yt.push([Lt[ut][0],Lt[ut][1],Lt[ut][2]]);return new Mh(Yt,Xt)}intersectsPrecise(pt,wt,Tt){for(let ut=0;ut<wt.length;ut++)if(!wh(pt,wt[ut]))return 0;for(let ut=0;ut<this.planes.length;ut++)if(!wh(pt,this.planes[ut]))return 0;for(const wt of Tt)for(const Tt of this.frustumEdges){const St=ut._.cross([],wt,Tt),It=ut._.length(St);if(0===It)continue;ut._.scale(St,St,1/It);const Lt=bh(this.points,this.points[0],St),Xt=bh(pt,this.points[0],St);if(Lt[0]>Xt[1]||Xt[0]>Lt[1])return 0}return 1}}class Ah{static fromPoints(pt){const wt=[1/0,1/0,1/0],Tt=[-1/0,-1/0,-1/0];for(const St of pt)ut._.min(wt,wt,St),ut._.max(Tt,Tt,St);return new Ah(wt,Tt)}static fromTileIdAndHeight(ut,pt,wt){const Tt=1<<ut.canonical.z,St=ut.canonical.x,It=ut.canonical.y;return new Ah([St/Tt,It/Tt,pt],[(St+1)/Tt,(It+1)/Tt,wt])}static applyTransform(pt,wt){const Tt=pt.getCorners();for(let pt=0;pt<Tt.length;++pt)ut._.transformMat4(Tt[pt],Tt[pt],wt);return Ah.fromPoints(Tt)}static projectAabbCorners(pt,wt){const Tt=pt.getCorners();for(let pt=0;pt<Tt.length;++pt)ut._.transformMat4(Tt[pt],Tt[pt],wt);return Tt}constructor(pt,wt){this.min=pt,this.max=wt,this.center=ut._.scale([],ut._.add([],this.min,this.max),.5)}quadrant(pt){const wt=[pt%2==0,pt<2],Tt=ut._.clone(this.min),St=ut._.clone(this.max);for(let ut=0;ut<wt.length;ut++)Tt[ut]=wt[ut]?this.min[ut]:this.center[ut],St[ut]=wt[ut]?this.center[ut]:this.max[ut];return St[2]=this.max[2],new Ah(Tt,St)}distanceX(ut){return Math.max(Math.min(this.max[0],ut[0]),this.min[0])-ut[0]}distanceY(ut){return Math.max(Math.min(this.max[1],ut[1]),this.min[1])-ut[1]}distanceZ(ut){return Math.max(Math.min(this.max[2],ut[2]),this.min[2])-ut[2]}getCorners(){const ut=this.min,pt=this.max;return[[ut[0],ut[1],ut[2]],[pt[0],ut[1],ut[2]],[pt[0],pt[1],ut[2]],[ut[0],pt[1],ut[2]],[ut[0],ut[1],pt[2]],[pt[0],ut[1],pt[2]],[pt[0],pt[1],pt[2]],[ut[0],pt[1],pt[2]]]}intersects(ut){return this.intersectsAabb(ut.bounds)?vh(ut,this.getCorners()):0}intersectsFlat(ut){return this.intersectsAabb(ut.bounds)?vh(ut,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(ut,pt){return pt||this.intersects(ut)?_h(ut,this.getCorners()):0}intersectsPreciseFlat(ut,pt){return pt||this.intersectsFlat(ut)?_h(ut,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(ut){for(let pt=0;pt<3;++pt)if(this.min[pt]>ut.max[pt]||ut.min[pt]>this.max[pt])return!1;return!0}intersectsAabbXY(ut){return!(this.min[0]>ut.max[0]||ut.min[0]>this.max[0]||this.min[1]>ut.max[1]||ut.min[1]>this.max[1])}encapsulate(ut){for(let pt=0;pt<3;pt++)this.min[pt]=Math.min(this.min[pt],ut.min[pt]),this.max[pt]=Math.max(this.max[pt],ut.max[pt])}encapsulatePoint(ut){for(let pt=0;pt<3;pt++)this.min[pt]=Math.min(this.min[pt],ut[pt]),this.max[pt]=Math.max(this.max[pt],ut[pt])}closestPoint(ut){return[Math.max(Math.min(this.max[0],ut[0]),this.min[0]),Math.max(Math.min(this.max[1],ut[1]),this.min[1]),Math.max(Math.min(this.max[2],ut[2]),this.min[2])]}}Mo(Ah,"Aabb");const lg=Bl([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:cg}=lg,ug=Bl([{name:"a_pos_3",components:3,type:"Int16"}]);var hg=Bl([{name:"a_pos",type:"Int16",components:2}]);function zh(ut){return ut*k_/G_}const pg=[new Ah([U_,U_,U_],[j_,j_,j_]),new Ah([U_,U_,U_],[0,0,j_]),new Ah([0,U_,U_],[j_,0,j_]),new Ah([U_,0,U_],[0,j_,j_]),new Ah([0,0,U_],[j_,j_,j_])];function Eh(pt,wt,Tt,St=!0){const It=ut._.scale([],pt._camera.position,pt.worldSize),Lt=[wt,Tt,1,1];ut.aA.transformMat4(Lt,Lt,pt.pixelMatrixInverse),ut.aA.scale(Lt,Lt,1/Lt[3]);const Xt=ut._.sub([],Lt,It),Yt=ut._.normalize([],Xt),Mi=pt.globeMatrix,vr=[Mi[12],Mi[13],Mi[14]],br=ut._.sub([],vr,It),Ar=ut._.length(br),Vr=ut._.normalize([],br),nn=pt.worldSize/(2*Math.PI),sn=ut._.dot(Vr,Yt),an=Math.asin(nn/Ar);if(an<Math.acos(sn)){if(!St)return null;const pt=[],wt=[];ut._.scale(pt,Yt,Ar/sn),ut._.normalize(wt,ut._.sub(wt,pt,br)),ut._.normalize(Yt,ut._.add(Yt,br,ut._.scale(Yt,wt,Math.tan(an)*Ar)))}const ln=[];new gh(It,Yt).closestPointOnSphere(vr,nn,ln);const cn=ut._.normalize([],Tr(Mi,0)),un=ut._.normalize([],Tr(Mi,1)),fn=ut._.normalize([],Tr(Mi,2)),_n=ut._.dot(cn,ln),gn=ut._.dot(un,ln),yn=ut._.dot(fn,ln),xn=Ge(Math.asin(-gn/nn));let vn=Ge(Math.atan2(_n,yn));vn=pt.center.lng+function(ut,pt){const wt=(pt-ut+180)%360-180;return wt<-180?wt+360:wt}(pt.center.lng,vn);const bn=Tc(vn),wn=Ke(kc(xn),0,1);return new Lc(bn,wn)}class Bh{constructor(pt,wt,Tt){this.a=ut._.sub([],pt,Tt),this.b=ut._.sub([],wt,Tt),this.center=Tt;const St=ut._.normalize([],this.a),It=ut._.normalize([],this.b);this.angle=Math.acos(ut._.dot(St,It))}}function Dh(ut,pt){if(0===ut.angle)return null;let wt;return wt=0===ut.a[pt]?1/ut.angle*.5*Math.PI:1/ut.angle*Math.atan(ut.b[pt]/ut.a[pt]/Math.sin(ut.angle)-1/Math.tan(ut.angle)),wt<0||wt>1?null:function(ut,pt,wt,Tt){const St=Math.sin(wt);return ut*(Math.sin((1-Tt)*wt)/St)+pt*(Math.sin(Tt*wt)/St)}(ut.a[pt],ut.b[pt],ut.angle,Ke(wt,0,1))+ut.center[pt]}function Ch(ut){if(ut.z<=1)return pg[ut.z+2*ut.y+ut.x];const pt=Uh(Oh(ut));return Ah.fromPoints(pt)}function Rh(pt,wt,Tt){return ut._.scale(pt,pt,1-Tt),ut._.scaleAndAdd(pt,pt,wt,Tt)}function Vh(pt,wt){const Tt=Hh(wt.zoom);if(0===Tt)return Ch(pt);const St=Oh(pt),It=Uh(St),Lt=Tc(St.getWest())*wt.worldSize,Xt=Tc(St.getEast())*wt.worldSize,Yt=kc(St.getNorth())*wt.worldSize,Mi=kc(St.getSouth())*wt.worldSize,vr=[Lt,Yt,0],br=[Xt,Yt,0],Ar=[Lt,Mi,0],Vr=[Xt,Mi,0],nn=ut.ad.invert([],wt.globeMatrix);return ut._.transformMat4(vr,vr,nn),ut._.transformMat4(br,br,nn),ut._.transformMat4(Ar,Ar,nn),ut._.transformMat4(Vr,Vr,nn),It[0]=Rh(It[0],Ar,Tt),It[1]=Rh(It[1],Vr,Tt),It[2]=Rh(It[2],br,Tt),It[3]=Rh(It[3],vr,Tt),Ah.fromPoints(It)}function Fh(pt,wt,Tt){for(const St of pt)ut._.transformMat4(St,St,wt),ut._.scale(St,St,Tt)}function Lh(pt,wt,Tt,St){const It=wt/pt.worldSize,Lt=pt.globeMatrix;if(Tt.z<=1){const ut=Ch(Tt).getCorners();return Fh(ut,Lt,It),Ah.fromPoints(ut)}const Xt=Oh(Tt,St),Yt=Uh(Xt,k_+zh(pt._tileCoverLift));Fh(Yt,Lt,It);const Mi=Number.MAX_VALUE,vr=[-Mi,-Mi,-Mi],br=[Mi,Mi,Mi];if(Xt.contains(pt.center)){for(const pt of Yt)ut._.min(br,br,pt),ut._.max(vr,vr,pt);vr[2]=0;const wt=pt.point,Tt=[wt.x*It,wt.y*It,0];return ut._.min(br,br,Tt),ut._.max(vr,vr,Tt),new Ah(br,vr)}if(pt._tileCoverLift>0){for(const pt of Yt)ut._.min(br,br,pt),ut._.max(vr,vr,pt);return new Ah(br,vr)}const Ar=[Lt[12]*It,Lt[13]*It,Lt[14]*It],Vr=Xt.getCenter(),nn=Ke(pt.center.lat,-Y_,Y_),sn=Ke(Vr.lat,-Y_,Y_),an=Tc(pt.center.lng),ln=kc(nn);let cn=an-Tc(Vr.lng);const un=ln-kc(sn);cn>.5?cn-=1:cn<-.5&&(cn+=1);let fn=0;if(Math.abs(cn)>Math.abs(un))fn=cn>=0?1:3;else{fn=un>=0?0:2;const pt=[Lt[4]*It,Lt[5]*It,Lt[6]*It],wt=-Math.sin($e(un>=0?Xt.getSouth():Xt.getNorth()))*k_;ut._.scaleAndAdd(Ar,Ar,pt,wt)}const _n=Yt[fn],gn=Yt[(fn+1)%4],yn=new Bh(_n,gn,Ar),xn=[Dh(yn,0)||_n[0],Dh(yn,1)||_n[1],Dh(yn,2)||_n[2]],vn=Hh(pt.zoom);if(vn>0){const St=function({x:ut,y:pt,z:wt},Tt,St,It,Lt){const Xt=1/(1<<wt);let Yt=ut*Xt,Mi=Yt+Xt,vr=pt*Xt,br=vr+Xt,Ar=0;const Vr=(Yt+Mi)/2-It;return Vr>.5?Ar=-1:Vr<-.5&&(Ar=1),Yt=((Yt+Ar)*Tt-(It*=Tt))*St+It,Mi=((Mi+Ar)*Tt-It)*St+It,vr=(vr*Tt-(Lt*=Tt))*St+Lt,br=(br*Tt-Lt)*St+Lt,[[Yt,br,0],[Mi,br,0],[Mi,vr,0],[Yt,vr,0]]}(Tt,wt,pt._pixelsPerMercatorPixel,an,ln);for(let ut=0;ut<Yt.length;ut++)Rh(Yt[ut],St[ut],vn);const It=ut._.add([],St[fn],St[(fn+1)%4]);ut._.scale(It,It,.5),Rh(xn,It,vn)}for(const pt of Yt)ut._.min(br,br,pt),ut._.max(vr,vr,pt);return br[2]=Math.min(_n[2],gn[2]),ut._.min(br,br,xn),ut._.max(vr,vr,xn),new Ah(br,vr)}function Oh({x:ut,y:pt,z:wt},Tt=!1){const St=1/(1<<wt),It=new mc(Pc(ut*St),pt===(1<<wt)-1&&Tt?-90:Ec((pt+1)*St)),Lt=new mc(Pc((ut+1)*St),0===pt&&Tt?90:Ec(pt*St));return new yc(It,Lt)}function Uh(ut,pt=k_){const wt=$e(ut.getNorth()),Tt=$e(ut.getSouth()),St=Math.cos(wt),It=Math.cos(Tt),Lt=Math.sin(wt),Xt=Math.sin(Tt),Yt=ut.getWest(),Mi=ut.getEast();return[hc(It,Xt,Yt,pt),hc(It,Xt,Mi,pt),hc(St,Lt,Mi,pt),hc(St,Lt,Yt,pt)]}function Nh(ut,pt,wt,Tt){const St=1<<wt.z,It=(ut/xf+wt.x)/St;return pc(Ec((pt/xf+wt.y)/St),Pc(It),Tt)}function jh({min:ut,max:pt}){return F_/Math.max(pt[0]-ut[0],pt[1]-ut[1],pt[2]-ut[2])}const mg=new Float64Array(16);function $h(pt){const wt=jh(pt),Tt=ut.ad.fromScaling(mg,[wt,wt,wt]);return ut.ad.translate(Tt,Tt,ut._.negate([],pt.min))}function Gh(pt){const wt=ut.ad.fromTranslation(mg,pt.min),Tt=1/jh(pt);return ut.ad.scale(wt,wt,[Tt,Tt,Tt])}function Xh(ut){const pt=xf/(2*Math.PI);return ut/(2*Math.PI)/pt}function Yh(ut,pt){return xf/(512*Math.pow(2,ut))*jh(Ch(pt))}function Zh(pt,wt,Tt,St,It){const Lt=Xh(Tt),Xt=[pt,wt,-Tt/(2*Math.PI)],Yt=ut.ad.identity(new Float64Array(16));return ut.ad.translate(Yt,Yt,Xt),ut.ad.scale(Yt,Yt,[Lt,Lt,Lt]),ut.ad.rotateX(Yt,Yt,$e(-It)),ut.ad.rotateY(Yt,Yt,$e(-St)),Yt}function Hh(ut){return We(O_,B_,ut)}function Kh(pt,wt){const Tt=pc(wt.lat,wt.lng),St=function(pt){const wt=pc(pt._center.lat,pt._center.lng),Tt=ut._.fromValues(0,1,0);let St=ut._.cross([],Tt,wt);const It=ut.ad.fromRotation([],-pt.angle,wt);St=ut._.transformMat4(St,St,It),ut.ad.fromRotation(It,-pt._pitch,St);const Lt=ut._.normalize([],wt);return ut._.scale(Lt,Lt,zh(pt.cameraToCenterDistance/pt.pixelsPerMeter)),ut._.transformMat4(Lt,Lt,It),ut._.add([],wt,Lt)}(pt),It=ut._.subtract([],St,Tt);return ut._.angle(It,Tt)}function Wh(ut,pt){return Kh(ut,pt)>Math.PI/2*1.01}const _g=$e(85),bg=Math.cos(_g),Pg=Math.sin(_g),Rg=ut.ad.create(),rp=ut=>{const pt=[];return"map"===ut.paint.get("circle-pitch-alignment")&&pt.push("PITCH_WITH_MAP"),"map"===ut.paint.get("circle-pitch-scale")&&pt.push("SCALE_WITH_MAP"),pt};function np(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){if(Lt&&pt.queryGeometry.isAboveHorizon)return!1;Lt&&(Mi*=pt.pixelToTileUnitsFactor);const vr=pt.tileID.canonical,br=Tt.projection.upVectorScale(vr,Tt.center.lat,Tt.worldSize).metersToTile;for(const Ar of wt)for(const wt of Ar){const Ar=wt.add(Yt),Vr=It&&Tt.elevation?Tt.elevation.exaggeration()*It.getElevationAt(Ar.x,Ar.y,!0):0,nn=Tt.projection.projectTilePoint(Ar.x,Ar.y,vr);if(Vr>0){const ut=Tt.projection.upVector(vr,Ar.x,Ar.y);nn.x+=ut[0]*br*Vr,nn.y+=ut[1]*br*Vr,nn.z+=ut[2]*br*Vr}const sn=Lt?Ar:ip(nn.x,nn.y,nn.z,St),an=Lt?pt.tilespaceRays.map((ut=>op(ut,Vr))):pt.queryGeometry.screenGeometry,ln=ut.aA.transformMat4([],[nn.x,nn.y,nn.z,1],St);if(!Xt&&Lt?Mi*=ln[3]/Tt.cameraToCenterDistance:Xt&&!Lt&&(Mi*=Tt.cameraToCenterDistance/ln[3]),Lt){const ut=Ec((wt.y/xf+vr.y)/(1<<vr.z));Mi/=Tt.projection.pixelsPerMeter(ut,1)/zc(1,ut)}if(Jc(an,sn,Mi))return!0}return!1}function ip(pt,wt,Tt,St){const It=ut.aA.transformMat4([],[pt,wt,Tt,1],St);return new xc(It[0]/It[3],It[1]/It[3])}const Dg=ut._.fromValues(0,0,0),kg=ut._.fromValues(0,0,1);function op(pt,wt){const Tt=ut._.create();return Dg[2]=wt,pt.intersectsPlane(Dg,kg,Tt),new xc(Tt[0],Tt[1])}class lp extends Kc{}function up(ut,{width:pt,height:wt},Tt,St){if(St){if(St instanceof Uint8ClampedArray)St=new Uint8Array(St.buffer);else if(St.length!==pt*wt*Tt)throw new RangeError("mismatched image size")}else St=new Uint8Array(pt*wt*Tt);return ut.width=pt,ut.height=wt,ut.data=St,ut}function cp(ut,pt,wt){const{width:Tt,height:St}=pt;Tt===ut.width&&St===ut.height||(hp(ut,pt,{x:0,y:0},{x:0,y:0},{width:Math.min(ut.width,Tt),height:Math.min(ut.height,St)},wt,null),ut.width=Tt,ut.height=St,ut.data=pt.data)}function hp(ut,pt,wt,Tt,St,It,Lt,Xt){if(0===St.width||0===St.height)return pt;if(St.width>ut.width||St.height>ut.height||wt.x>ut.width-St.width||wt.y>ut.height-St.height)throw new RangeError("out of range source coordinates for image copy");if(St.width>pt.width||St.height>pt.height||Tt.x>pt.width-St.width||Tt.y>pt.height-St.height)throw new RangeError("out of range destination coordinates for image copy");const Yt=ut.data,Mi=pt.data,vr=4===It&&Xt;for(let Xt=0;Xt<St.height;Xt++){const br=((wt.y+Xt)*ut.width+wt.x)*It,Ar=((Tt.y+Xt)*pt.width+Tt.x)*It;if(vr)for(let ut=0;ut<St.width;ut++){const pt=br+ut*It+3,wt=Ar+ut*It;Mi[wt+0]=255,Mi[wt+1]=255,Mi[wt+2]=255,Mi[wt+3]=Yt[pt]}else if(Lt)for(let ut=0;ut<St.width;ut++){const pt=br+ut*It,wt=Ar+ut*It,Tt=Yt[pt+3],St=new qn(Yt[pt+0]/255*Tt,Yt[pt+1]/255*Tt,Yt[pt+2]/255*Tt,Tt).toRenderColor(Lt).toArray();Mi[wt+0]=St[0],Mi[wt+1]=St[1],Mi[wt+2]=St[2],Mi[wt+3]=St[3]}else for(let ut=0;ut<St.width*It;ut++)Mi[Ar+ut]=Yt[br+ut]}return pt}Mo(lp,"HeatmapBucket",{omit:["layers"]});class pp{constructor(ut,pt){up(this,ut,1,pt)}resize(ut){cp(this,new pp(ut),1)}clone(){return new pp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(ut,pt,wt,Tt,St){hp(ut,pt,wt,Tt,St,1,null)}}class fp{constructor(ut,pt){up(this,ut,4,pt)}resize(ut){cp(this,new fp(ut),4)}replace(ut,pt){pt?this.data.set(ut):this.data=ut instanceof Uint8ClampedArray?new Uint8Array(ut.buffer):ut}clone(){return new fp({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(ut,pt,wt,Tt,St,It,Lt){hp(ut,pt,wt,Tt,St,4,It,Lt)}}class dp{constructor(ut,pt){this.width=ut.width,this.height=ut.height,this.data=pt instanceof Uint8Array?new Float32Array(pt.buffer):pt}}Mo(pp,"AlphaImage"),Mo(fp,"RGBAImage");const Bg=new ol({visibility:new il(x_.layout_heatmap.visibility)});var Vg={paint:new ol({"heatmap-radius":new sl(x_.paint_heatmap["heatmap-radius"]),"heatmap-weight":new sl(x_.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new il(x_.paint_heatmap["heatmap-intensity"]),"heatmap-color":new al(x_.paint_heatmap["heatmap-color"]),"heatmap-opacity":new il(x_.paint_heatmap["heatmap-opacity"])}),layout:Bg};function gp(ut){const pt={},wt=ut.resolution||256,Tt=ut.clips?ut.clips.length:1,St=ut.image||new fp({width:wt,height:Tt}),s=(wt,Tt,It)=>{pt[ut.evaluationKey]=It;const Lt=ut.expression.evaluate(pt);Lt&&(St.data[wt+Tt+0]=Math.floor(255*Lt.r/Lt.a),St.data[wt+Tt+1]=Math.floor(255*Lt.g/Lt.a),St.data[wt+Tt+2]=Math.floor(255*Lt.b/Lt.a),St.data[wt+Tt+3]=Math.floor(255*Lt.a))};if(ut.clips)for(let pt=0,St=0;pt<Tt;++pt,St+=4*wt)for(let Tt=0,It=0;Tt<wt;Tt++,It+=4){const Lt=Tt/(wt-1),{start:Xt,end:Yt}=ut.clips[pt];s(St,It,Xt*(1-Lt)+Yt*Lt)}else for(let ut=0,pt=0;ut<wt;ut++,pt+=4)s(0,pt,ut/(wt-1));return St}const Zg=new ol({visibility:new il(x_.layout_hillshade.visibility)});var Wg={paint:new ol({"hillshade-illumination-direction":new il(x_.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new il(x_.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new il(x_.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new il(x_.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new il(x_.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new il(x_.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new il(x_.paint_hillshade["hillshade-emissive-strength"])}),layout:Zg};const Hg=Bl([{name:"a_pos",components:2,type:"Int16"}],4),{members:Yg}=Hg;function wp(ut,pt,wt=2){const Tt=pt&&pt.length,St=Tt?pt[0]*wt:ut.length;let It=Mp(ut,0,St,wt,!0);const Lt=[];if(!It||It.next===It.prev)return Lt;let Xt,Yt,Mi;if(Tt&&(It=function(ut,pt,wt,Tt){const St=[];for(let wt=0,It=pt.length;wt<It;wt++){const Lt=Mp(ut,pt[wt]*Tt,wt<It-1?pt[wt+1]*Tt:ut.length,Tt,!1);Lt===Lt.next&&(Lt.steiner=!0),St.push(Cp(Lt))}St.sort(Pp);for(let ut=0;ut<St.length;ut++)wt=Ep(St[ut],wt);return wt}(ut,pt,It,wt)),ut.length>80*wt){Xt=1/0,Yt=1/0;let pt=-1/0,Tt=-1/0;for(let It=wt;It<St;It+=wt){const wt=ut[It],St=ut[It+1];wt<Xt&&(Xt=wt),St<Yt&&(Yt=St),wt>pt&&(pt=wt),St>Tt&&(Tt=St)}Mi=Math.max(pt-Xt,Tt-Yt),Mi=0!==Mi?32767/Mi:0}return Sp(It,Lt,wt,Xt,Yt,Mi,0),Lt}function Mp(ut,pt,wt,Tt,St){let It;if(St===function(ut,pt,wt,Tt){let St=0;for(let It=pt,Lt=wt-Tt;It<wt;It+=Tt)St+=(ut[Lt]-ut[It])*(ut[It+1]+ut[Lt+1]),Lt=It;return St}(ut,pt,wt,Tt)>0)for(let St=pt;St<wt;St+=Tt)It=$p(St/Tt|0,ut[St],ut[St+1],It);else for(let St=wt-Tt;St>=pt;St-=Tt)It=$p(St/Tt|0,ut[St],ut[St+1],It);return It&&Lp(It,It.next)&&(Gp(It),It=It.next),It}function Ap(ut,pt){if(!ut)return ut;pt||(pt=ut);let wt,Tt=ut;do{if(wt=!1,Tt.steiner||!Lp(Tt,Tt.next)&&0!==Fp(Tt.prev,Tt,Tt.next))Tt=Tt.next;else{if(Gp(Tt),Tt=pt=Tt.prev,Tt===Tt.next)break;wt=!0}}while(wt||Tt!==pt);return pt}function Sp(ut,pt,wt,Tt,St,It,Lt){if(!ut)return;!Lt&&It&&function(ut,pt,wt,Tt){let St=ut;do{0===St.z&&(St.z=Dp(St.x,St.y,pt,wt,Tt)),St.prevZ=St.prev,St.nextZ=St.next,St=St.next}while(St!==ut);St.prevZ.nextZ=null,St.prevZ=null,function(ut){let pt,wt=1;do{let Tt,St=ut;ut=null;let It=null;for(pt=0;St;){pt++;let Lt=St,Xt=0;for(let ut=0;ut<wt&&(Xt++,Lt=Lt.nextZ,Lt);ut++);let Yt=wt;for(;Xt>0||Yt>0&&Lt;)0!==Xt&&(0===Yt||!Lt||St.z<=Lt.z)?(Tt=St,St=St.nextZ,Xt--):(Tt=Lt,Lt=Lt.nextZ,Yt--),It?It.nextZ=Tt:ut=Tt,Tt.prevZ=It,It=Tt;St=Lt}It.nextZ=null,wt*=2}while(pt>1)}(St)}(ut,Tt,St,It);let Xt=ut;for(;ut.prev!==ut.next;){const Yt=ut.prev,Mi=ut.next;if(It?Tp(ut,Tt,St,It):Ip(ut))pt.push(Yt.i,ut.i,Mi.i),Gp(ut),ut=Mi.next,Xt=Mi.next;else if((ut=Mi)===Xt){Lt?1===Lt?Sp(ut=kp(Ap(ut),pt),pt,wt,Tt,St,It,2):2===Lt&&zp(ut,pt,wt,Tt,St,It):Sp(Ap(ut),pt,wt,Tt,St,It,1);break}}}function Ip(ut){const pt=ut.prev,wt=ut,Tt=ut.next;if(Fp(pt,wt,Tt)>=0)return!1;const St=pt.x,It=wt.x,Lt=Tt.x,Xt=pt.y,Yt=wt.y,Mi=Tt.y,vr=St<It?St<Lt?St:Lt:It<Lt?It:Lt,br=Xt<Yt?Xt<Mi?Xt:Mi:Yt<Mi?Yt:Mi,Ar=St>It?St>Lt?St:Lt:It>Lt?It:Lt,Vr=Xt>Yt?Xt>Mi?Xt:Mi:Yt>Mi?Yt:Mi;let nn=Tt.next;for(;nn!==pt;){if(nn.x>=vr&&nn.x<=Ar&&nn.y>=br&&nn.y<=Vr&&Rp(St,Xt,It,Yt,Lt,Mi,nn.x,nn.y)&&Fp(nn.prev,nn,nn.next)>=0)return!1;nn=nn.next}return!0}function Tp(ut,pt,wt,Tt){const St=ut.prev,It=ut,Lt=ut.next;if(Fp(St,It,Lt)>=0)return!1;const Xt=St.x,Yt=It.x,Mi=Lt.x,vr=St.y,br=It.y,Ar=Lt.y,Vr=Xt<Yt?Xt<Mi?Xt:Mi:Yt<Mi?Yt:Mi,nn=vr<br?vr<Ar?vr:Ar:br<Ar?br:Ar,sn=Xt>Yt?Xt>Mi?Xt:Mi:Yt>Mi?Yt:Mi,an=vr>br?vr>Ar?vr:Ar:br>Ar?br:Ar,ln=Dp(Vr,nn,pt,wt,Tt),cn=Dp(sn,an,pt,wt,Tt);let un=ut.prevZ,fn=ut.nextZ;for(;un&&un.z>=ln&&fn&&fn.z<=cn;){if(un.x>=Vr&&un.x<=sn&&un.y>=nn&&un.y<=an&&un!==St&&un!==Lt&&Rp(Xt,vr,Yt,br,Mi,Ar,un.x,un.y)&&Fp(un.prev,un,un.next)>=0)return!1;if(un=un.prevZ,fn.x>=Vr&&fn.x<=sn&&fn.y>=nn&&fn.y<=an&&fn!==St&&fn!==Lt&&Rp(Xt,vr,Yt,br,Mi,Ar,fn.x,fn.y)&&Fp(fn.prev,fn,fn.next)>=0)return!1;fn=fn.nextZ}for(;un&&un.z>=ln;){if(un.x>=Vr&&un.x<=sn&&un.y>=nn&&un.y<=an&&un!==St&&un!==Lt&&Rp(Xt,vr,Yt,br,Mi,Ar,un.x,un.y)&&Fp(un.prev,un,un.next)>=0)return!1;un=un.prevZ}for(;fn&&fn.z<=cn;){if(fn.x>=Vr&&fn.x<=sn&&fn.y>=nn&&fn.y<=an&&fn!==St&&fn!==Lt&&Rp(Xt,vr,Yt,br,Mi,Ar,fn.x,fn.y)&&Fp(fn.prev,fn,fn.next)>=0)return!1;fn=fn.nextZ}return!0}function kp(ut,pt){let wt=ut;do{const Tt=wt.prev,St=wt.next.next;!Lp(Tt,St)&&Op(Tt,wt,wt.next,St)&&jp(Tt,St)&&jp(St,Tt)&&(pt.push(Tt.i,wt.i,St.i),Gp(wt),Gp(wt.next),wt=ut=St),wt=wt.next}while(wt!==ut);return Ap(wt)}function zp(ut,pt,wt,Tt,St,It){let Lt=ut;do{let ut=Lt.next.next;for(;ut!==Lt.prev;){if(Lt.i!==ut.i&&Vp(Lt,ut)){let Xt=qp(Lt,ut);return Lt=Ap(Lt,Lt.next),Xt=Ap(Xt,Xt.next),Sp(Lt,pt,wt,Tt,St,It,0),void Sp(Xt,pt,wt,Tt,St,It,0)}ut=ut.next}Lt=Lt.next}while(Lt!==ut)}function Pp(ut,pt){return ut.x-pt.x}function Ep(ut,pt){const wt=function(ut,pt){let wt=pt;const Tt=ut.x,St=ut.y;let It,Lt=-1/0;do{if(St<=wt.y&&St>=wt.next.y&&wt.next.y!==wt.y){const ut=wt.x+(St-wt.y)*(wt.next.x-wt.x)/(wt.next.y-wt.y);if(ut<=Tt&&ut>Lt&&(Lt=ut,It=wt.x<wt.next.x?wt:wt.next,ut===Tt))return It}wt=wt.next}while(wt!==pt);if(!It)return null;const Xt=It,Yt=It.x,Mi=It.y;let vr=1/0;wt=It;do{if(Tt>=wt.x&&wt.x>=Yt&&Tt!==wt.x&&Rp(St<Mi?Tt:Lt,St,Yt,Mi,St<Mi?Lt:Tt,St,wt.x,wt.y)){const pt=Math.abs(St-wt.y)/(Tt-wt.x);jp(wt,ut)&&(pt<vr||pt===vr&&(wt.x>It.x||wt.x===It.x&&Bp(It,wt)))&&(It=wt,vr=pt)}wt=wt.next}while(wt!==Xt);return It}(ut,pt);if(!wt)return pt;const Tt=qp(wt,ut);return Ap(Tt,Tt.next),Ap(wt,wt.next)}function Bp(ut,pt){return Fp(ut.prev,ut,pt.prev)<0&&Fp(pt.next,ut,ut.next)<0}function Dp(ut,pt,wt,Tt,St){return(ut=1431655765&((ut=858993459&((ut=252645135&((ut=16711935&((ut=(ut-wt)*St|0)|ut<<8))|ut<<4))|ut<<2))|ut<<1))|(pt=1431655765&((pt=858993459&((pt=252645135&((pt=16711935&((pt=(pt-Tt)*St|0)|pt<<8))|pt<<4))|pt<<2))|pt<<1))<<1}function Cp(ut){let pt=ut,wt=ut;do{(pt.x<wt.x||pt.x===wt.x&&pt.y<wt.y)&&(wt=pt),pt=pt.next}while(pt!==ut);return wt}function Rp(ut,pt,wt,Tt,St,It,Lt,Xt){return(St-Lt)*(pt-Xt)>=(ut-Lt)*(It-Xt)&&(ut-Lt)*(Tt-Xt)>=(wt-Lt)*(pt-Xt)&&(wt-Lt)*(It-Xt)>=(St-Lt)*(Tt-Xt)}function Vp(ut,pt){return ut.next.i!==pt.i&&ut.prev.i!==pt.i&&!function(ut,pt){let wt=ut;do{if(wt.i!==ut.i&&wt.next.i!==ut.i&&wt.i!==pt.i&&wt.next.i!==pt.i&&Op(wt,wt.next,ut,pt))return!0;wt=wt.next}while(wt!==ut);return!1}(ut,pt)&&(jp(ut,pt)&&jp(pt,ut)&&function(ut,pt){let wt=ut,Tt=!1;const St=(ut.x+pt.x)/2,It=(ut.y+pt.y)/2;do{wt.y>It!=wt.next.y>It&&wt.next.y!==wt.y&&St<(wt.next.x-wt.x)*(It-wt.y)/(wt.next.y-wt.y)+wt.x&&(Tt=!Tt),wt=wt.next}while(wt!==ut);return Tt}(ut,pt)&&(Fp(ut.prev,ut,pt.prev)||Fp(ut,pt.prev,pt))||Lp(ut,pt)&&Fp(ut.prev,ut,ut.next)>0&&Fp(pt.prev,pt,pt.next)>0)}function Fp(ut,pt,wt){return(pt.y-ut.y)*(wt.x-pt.x)-(pt.x-ut.x)*(wt.y-pt.y)}function Lp(ut,pt){return ut.x===pt.x&&ut.y===pt.y}function Op(ut,pt,wt,Tt){const St=Np(Fp(ut,pt,wt)),It=Np(Fp(ut,pt,Tt)),Lt=Np(Fp(wt,Tt,ut)),Xt=Np(Fp(wt,Tt,pt));return St!==It&&Lt!==Xt||!(0!==St||!Up(ut,wt,pt))||!(0!==It||!Up(ut,Tt,pt))||!(0!==Lt||!Up(wt,ut,Tt))||!(0!==Xt||!Up(wt,pt,Tt))}function Up(ut,pt,wt){return pt.x<=Math.max(ut.x,wt.x)&&pt.x>=Math.min(ut.x,wt.x)&&pt.y<=Math.max(ut.y,wt.y)&&pt.y>=Math.min(ut.y,wt.y)}function Np(ut){return ut>0?1:ut<0?-1:0}function jp(ut,pt){return Fp(ut.prev,ut,ut.next)<0?Fp(ut,pt,ut.next)>=0&&Fp(ut,ut.prev,pt)>=0:Fp(ut,pt,ut.prev)<0||Fp(ut,ut.next,pt)<0}function qp(ut,pt){const wt=Xp(ut.i,ut.x,ut.y),Tt=Xp(pt.i,pt.x,pt.y),St=ut.next,It=pt.prev;return ut.next=pt,pt.prev=ut,wt.next=St,St.prev=wt,Tt.next=wt,wt.prev=Tt,It.next=Tt,Tt.prev=It,Tt}function $p(ut,pt,wt,Tt){const St=Xp(ut,pt,wt);return Tt?(St.next=Tt.next,St.prev=Tt,Tt.next.prev=St,Tt.next=St):(St.prev=St,St.next=St),St}function Gp(ut){ut.next.prev=ut.prev,ut.prev.next=ut.next,ut.prevZ&&(ut.prevZ.nextZ=ut.nextZ),ut.nextZ&&(ut.nextZ.prevZ=ut.prevZ)}function Xp(ut,pt,wt){return{i:ut,x:pt,y:wt,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Yp(ut,pt){const wt=ut.length;if(wt<=1)return[ut];const Tt=[];let St,It;for(let pt=0;pt<wt;pt++){const wt=mr(ut[pt]);0!==wt&&(ut[pt].area=Math.abs(wt),void 0===It&&(It=wt<0),It===wt<0?(St&&Tt.push(St),St=[ut[pt]]):St.push(ut[pt]))}if(St&&Tt.push(St),pt>1)for(let ut=0;ut<Tt.length;ut++)Tt[ut].length<=pt||(af(Tt[ut],pt,1,Tt[ut].length-1,Zp),Tt[ut]=Tt[ut].slice(0,pt));return Tt}function Zp(ut,pt){return pt.area-ut.area}function Hp(ut,pt,wt){const Tt=wt.patternDependencies;let St=!1;for(const wt of pt){const pt=wt.paint.get(`${ut}-pattern`);pt.isConstant()||(St=!0);const It=pt.constantOr(null);It&&(St=!0,Tt[It]=!0)}return St}function Kp(ut,pt,wt,Tt,St){const It=St.patternDependencies;for(const Lt of pt){const pt=Lt.paint.get(`${ut}-pattern`).value;if("constant"!==pt.kind){let ut=pt.evaluate({zoom:Tt},wt,{},St.availableImages);ut=ut&&ut.name?ut.name:ut,It[ut]=!0,wt.patterns[Lt.id]=ut}}return wt}class Wp{constructor(ut){this.zoom=ut.zoom,this.overscaling=ut.overscaling,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=ut.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Cl,this.indexArray=new Ql,this.indexArray2=new Zl,this.programConfigurations=new Wu(ut.layers,{zoom:ut.zoom,lut:ut.lut}),this.segments=new Au,this.segments2=new Au,this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.projection=ut.projection}updateFootprints(ut,pt){}populate(ut,pt,wt,Tt){this.hasPattern=Hp("fill",this.layers,pt);const St=this.layers[0].layout.get("fill-sort-key"),It=[];for(const{feature:Lt,id:Xt,index:Yt,sourceLayerIndex:Mi}of ut){const ut=this.layers[0]._featureFilter.needGeometry,vr=Yc(Lt,ut);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),vr,wt))continue;const br=St?St.evaluate(vr,{},wt,pt.availableImages):void 0,Ar={id:Xt,properties:Lt.properties,type:Lt.type,sourceLayerIndex:Mi,index:Yt,geometry:ut?vr.geometry:Xc(Lt,wt,Tt),patterns:{},sortKey:br};It.push(Ar)}St&&It.sort(((ut,pt)=>ut.sortKey-pt.sortKey));for(const Tt of It){const{geometry:St,index:It,sourceLayerIndex:Lt}=Tt;if(this.hasPattern){const ut=Kp("fill",this.layers,Tt,this.zoom,pt);this.patternFeatures.push(ut)}else this.addFeature(Tt,St,It,wt,{},pt.availableImages,pt.brightness);pt.featureIndex.insert(ut[It].feature,St,It,Lt,this.index)}}update(ut,pt,wt,Tt,St){const It=0!==Object.keys(ut).length;It&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(ut,pt,It?this.stateDependentLayers:this.layers,wt,Tt,St)}addFeatures(ut,pt,wt,Tt,St,It){for(const ut of this.patternFeatures)this.addFeature(ut,ut.geometry,ut.index,pt,wt,Tt,It)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(ut){this.uploaded||(this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,Yg),this.indexBuffer=ut.createIndexBuffer(this.indexArray),this.indexBuffer2=ut.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(ut),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(ut,pt,wt,Tt,St,It=[],Lt){for(const ut of Yp(pt,500)){let pt=0;for(const wt of ut)pt+=wt.length;const wt=this.segments.prepareSegment(pt,this.layoutVertexArray,this.indexArray),Tt=wt.vertexLength,St=[],It=[];for(const pt of ut){if(0===pt.length)continue;pt!==ut[0]&&It.push(St.length/2);const wt=this.segments2.prepareSegment(pt.length,this.layoutVertexArray,this.indexArray2),Tt=wt.vertexLength;this.layoutVertexArray.emplaceBack(pt[0].x,pt[0].y),this.indexArray2.emplaceBack(Tt+pt.length-1,Tt),St.push(pt[0].x),St.push(pt[0].y);for(let ut=1;ut<pt.length;ut++)this.layoutVertexArray.emplaceBack(pt[ut].x,pt[ut].y),this.indexArray2.emplaceBack(Tt+ut-1,Tt+ut),St.push(pt[ut].x),St.push(pt[ut].y);wt.vertexLength+=pt.length,wt.primitiveLength+=pt.length}const Lt=wp(St,It);for(let ut=0;ut<Lt.length;ut+=3)this.indexArray.emplaceBack(Tt+Lt[ut],Tt+Lt[ut+1],Tt+Lt[ut+2]);wt.vertexLength+=pt,wt.primitiveLength+=Lt.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,ut,wt,St,It,Tt,Lt)}}Mo(Wp,"FillBucket",{omit:["layers","patternFeatures"]});const Kg=new ol({"fill-sort-key":new sl(x_.layout_fill["fill-sort-key"]),visibility:new il(x_.layout_fill.visibility)});var Jg={paint:new ol({"fill-antialias":new il(x_.paint_fill["fill-antialias"]),"fill-opacity":new sl(x_.paint_fill["fill-opacity"]),"fill-color":new sl(x_.paint_fill["fill-color"]),"fill-outline-color":new sl(x_.paint_fill["fill-outline-color"]),"fill-translate":new il(x_.paint_fill["fill-translate"]),"fill-translate-anchor":new il(x_.paint_fill["fill-translate-anchor"]),"fill-pattern":new sl(x_.paint_fill["fill-pattern"]),"fill-emissive-strength":new il(x_.paint_fill["fill-emissive-strength"])}),layout:Kg};class tf{constructor(ut,pt,wt,Tt){if(this.triangleCount=pt.length/3,this.min=new xc(0,0),this.max=new xc(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===ut.length)return;const[St,It]=[ut[0].clone(),ut[0].clone()];for(let pt=1;pt<ut.length;++pt){const wt=ut[pt];St.x=Math.min(St.x,wt.x),St.y=Math.min(St.y,wt.y),It.x=Math.max(It.x,wt.x),It.y=Math.max(It.y,wt.y)}if(Tt){const ut=Math.ceil(Math.max(It.x-St.x,It.y-St.y)/Tt);wt=Math.max(wt,ut)}if(0===wt)return;this.min=St,this.max=It;const Lt=this.max.sub(this.min);Lt.x=Math.max(Lt.x,1),Lt.y=Math.max(Lt.y,1);const Xt=Math.max(Lt.x,Lt.y)/wt;this.cellsX=Math.max(1,Math.ceil(Lt.x/Xt)),this.cellsY=Math.max(1,Math.ceil(Lt.y/Xt)),this.xScale=1/Xt,this.yScale=1/Xt;const Yt=[];for(let wt=0;wt<this.triangleCount;wt++){const Tt=ut[pt[3*wt+0]].sub(this.min),St=ut[pt[3*wt+1]].sub(this.min),It=ut[pt[3*wt+2]].sub(this.min),Lt=ef(Math.floor(Math.min(Tt.x,St.x,It.x)),this.xScale,this.cellsX),Mi=ef(Math.floor(Math.max(Tt.x,St.x,It.x)),this.xScale,this.cellsX),vr=ef(Math.floor(Math.min(Tt.y,St.y,It.y)),this.yScale,this.cellsY),br=ef(Math.floor(Math.max(Tt.y,St.y,It.y)),this.yScale,this.cellsY),Ar=new xc(0,0),Vr=new xc(0,0),nn=new xc(0,0),sn=new xc(0,0);for(let ut=vr;ut<=br;++ut){Ar.y=Vr.y=ut*Xt,nn.y=sn.y=(ut+1)*Xt;for(let pt=Lt;pt<=Mi;++pt)Ar.x=nn.x=pt*Xt,Vr.x=sn.x=(pt+1)*Xt,(ch(Tt,St,It,Ar,Vr,sn)||ch(Tt,St,It,Ar,sn,nn))&&Yt.push({cellIdx:ut*this.cellsX+pt,triIdx:wt})}}if(0===Yt.length)return;Yt.sort(((ut,pt)=>ut.cellIdx-pt.cellIdx||ut.triIdx-pt.triIdx));let Mi=0;for(;Mi<Yt.length;){const ut=Yt[Mi].cellIdx,pt={start:this.payload.length,len:0};for(;Mi<Yt.length&&Yt[Mi].cellIdx===ut;)++pt.len,this.payload.push(Yt[Mi++].triIdx);this.cells[ut]=pt}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(ut,pt){if(0===this.triangleCount||0===this.cells.length)return;if(ut.x>this.max.x||this.min.x>ut.x||ut.y>this.max.y||this.min.y>ut.y)return;const wt=ef(ut.x-this.min.x,this.xScale,this.cellsX),Tt=ef(ut.y-this.min.y,this.yScale,this.cellsY),St=this.cells[Tt*this.cellsX+wt];if(St){this._lazyInitLookup();for(let ut=0;ut<St.len;ut++){const wt=this.payload[St.start+ut],Tt=Math.floor(wt/8),It=1<<wt%8;if(!(this.lookup[Tt]&It)&&(this.lookup[Tt]|=It,pt.push(wt),pt.length===this.triangleCount))return}}}query(ut,pt,wt){if(0===this.triangleCount||0===this.cells.length)return;if(ut.x>this.max.x||this.min.x>pt.x)return;if(ut.y>this.max.y||this.min.y>pt.y)return;this._lazyInitLookup();const Tt=ef(ut.x-this.min.x,this.xScale,this.cellsX),St=ef(pt.x-this.min.x,this.xScale,this.cellsX),It=ef(ut.y-this.min.y,this.yScale,this.cellsY),Lt=ef(pt.y-this.min.y,this.yScale,this.cellsY);for(let ut=It;ut<=Lt;ut++)for(let pt=Tt;pt<=St;pt++){const Tt=this.cells[ut*this.cellsX+pt];if(Tt)for(let ut=0;ut<Tt.len;ut++){const pt=this.payload[Tt.start+ut],St=Math.floor(pt/8),It=1<<pt%8;if(!(this.lookup[St]&It)&&(this.lookup[St]|=It,wt.push(pt),wt.length===this.triangleCount))return}}}}function ef(ut,pt,wt){return Math.max(0,Math.min(wt-1,Math.floor(ut*pt)))}Mo(tf,"TriangleGridIndex");class rf{constructor(ut){this.zoom=ut.zoom,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=ut.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.footprints=[]}updateFootprints(ut,pt){for(const wt of this.footprints)pt.push({footprint:wt,id:ut})}populate(ut,pt,wt,Tt){const St=[];for(const{feature:pt,id:It,index:Lt,sourceLayerIndex:Xt}of ut){const ut=this.layers[0]._featureFilter.needGeometry,Yt=Yc(pt,ut);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Yt,wt))continue;const Mi={id:It,properties:pt.properties,type:pt.type,sourceLayerIndex:Xt,index:Lt,geometry:ut?Yt.geometry:Xc(pt,wt,Tt),patterns:{}};St.push(Mi)}for(const Tt of St){const{geometry:St,index:It,sourceLayerIndex:Lt}=Tt;this.addFeature(Tt,St,It,wt,{},pt.availableImages,pt.brightness),pt.featureIndex.insert(ut[It].feature,St,It,Lt,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(ut){}update(ut,pt,wt,Tt,St){}destroy(){}addFeature(ut,pt,wt,Tt,St,It=[],Lt){for(const ut of Yp(pt,2)){const pt=[],wt=[],Tt=[],St=new xc(1/0,1/0),It=new xc(-1/0,-1/0);for(const Lt of ut)if(0!==Lt.length){Lt!==ut[0]&&Tt.push(wt.length/2);for(let ut=0;ut<Lt.length;ut++)wt.push(Lt[ut].x),wt.push(Lt[ut].y),pt.push(Lt[ut]),St.x=Math.min(St.x,Lt[ut].x),St.y=Math.min(St.y,Lt[ut].y),It.x=Math.max(It.x,Lt[ut].x),It.y=Math.max(It.y,Lt[ut].y)}const Lt=wp(wt,Tt),Xt=new tf(pt,Lt,8,256);this.footprints.push({vertices:pt,indices:Lt,grid:Xt,min:St,max:It})}}}Mo(rf,"ClipBucket",{omit:["layers"]});const ty=new ol({"clip-layer-types":new il(x_.layout_clip["clip-layer-types"])});var iy={paint:new ol({}),layout:ty};const sy=Bl([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Ey=Bl([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Sy=Bl([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Cy=Bl([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),ky=Bl([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:By}=sy;var Gy={},$y=gc,Hy=mf;function mf(ut,wt,Tt,St,It){(this||pt).properties={},(this||pt).extent=Tt,(this||pt).type=0,(this||pt)._pbf=ut,(this||pt)._geometry=-1,(this||pt)._keys=St,(this||pt)._values=It,ut.readFields(yf,this||pt,wt)}function yf(ut,pt,wt){1==ut?pt.id=wt.readVarint():2==ut?function(ut,pt){for(var wt=ut.readVarint()+ut.pos;ut.pos<wt;){var Tt=pt._keys[ut.readVarint()],St=pt._values[ut.readVarint()];pt.properties[Tt]=St}}(wt,pt):3==ut?pt.type=wt.readVarint():4==ut&&(pt._geometry=wt.pos)}function gf(ut){for(var pt,wt,Tt=0,St=0,It=ut.length,Lt=It-1;St<It;Lt=St++)Tt+=((wt=ut[Lt]).x-(pt=ut[St]).x)*(pt.y+wt.y);return Tt}mf.types=["Unknown","Point","LineString","Polygon"],mf.prototype.loadGeometry=function(){var ut=(this||pt)._pbf;ut.pos=(this||pt)._geometry;for(var wt,Tt=ut.readVarint()+ut.pos,St=1,It=0,Lt=0,Xt=0,Yt=[];ut.pos<Tt;){if(It<=0){var Mi=ut.readVarint();St=7&Mi,It=Mi>>3}if(It--,1===St||2===St)Lt+=ut.readSVarint(),Xt+=ut.readSVarint(),1===St&&(wt&&Yt.push(wt),wt=[]),wt.push(new $y(Lt,Xt));else{if(7!==St)throw new Error("unknown command "+St);wt&&wt.push(wt[0].clone())}}return wt&&Yt.push(wt),Yt},mf.prototype.bbox=function(){var ut=(this||pt)._pbf;ut.pos=(this||pt)._geometry;for(var wt=ut.readVarint()+ut.pos,Tt=1,St=0,It=0,Lt=0,Xt=1/0,Yt=-1/0,Mi=1/0,vr=-1/0;ut.pos<wt;){if(St<=0){var br=ut.readVarint();Tt=7&br,St=br>>3}if(St--,1===Tt||2===Tt)(It+=ut.readSVarint())<Xt&&(Xt=It),It>Yt&&(Yt=It),(Lt+=ut.readSVarint())<Mi&&(Mi=Lt),Lt>vr&&(vr=Lt);else if(7!==Tt)throw new Error("unknown command "+Tt)}return[Xt,Mi,Yt,vr]},mf.prototype.toGeoJSON=function(ut,wt,Tt){var St,It,Lt=(this||pt).extent*Math.pow(2,Tt),Xt=(this||pt).extent*ut,Yt=(this||pt).extent*wt,Mi=this.loadGeometry(),vr=mf.types[(this||pt).type];function c(ut){for(var pt=0;pt<ut.length;pt++){var wt=ut[pt];ut[pt]=[360*(wt.x+Xt)/Lt-180,360/Math.PI*Math.atan(Math.exp((180-360*(wt.y+Yt)/Lt)*Math.PI/180))-90]}}switch((this||pt).type){case 1:var br=[];for(St=0;St<Mi.length;St++)br[St]=Mi[St][0];c(Mi=br);break;case 2:for(St=0;St<Mi.length;St++)c(Mi[St]);break;case 3:for(Mi=function(ut){var pt=ut.length;if(pt<=1)return[ut];for(var wt,Tt,St=[],It=0;It<pt;It++){var Lt=gf(ut[It]);0!==Lt&&(void 0===Tt&&(Tt=Lt<0),Tt===Lt<0?(wt&&St.push(wt),wt=[ut[It]]):wt.push(ut[It]))}return wt&&St.push(wt),St}(Mi),St=0;St<Mi.length;St++)for(It=0;It<Mi[St].length;It++)c(Mi[St][It])}1===Mi.length?Mi=Mi[0]:vr="Multi"+vr;var Ar={type:"Feature",geometry:{type:vr,coordinates:Mi},properties:(this||pt).properties};return"id"in(this||pt)&&(Ar.id=(this||pt).id),Ar};var Ky=Hy,ex=vf;function vf(ut,wt){(this||pt).version=1,(this||pt).name=null,(this||pt).extent=4096,(this||pt).length=0,(this||pt)._pbf=ut,(this||pt)._keys=[],(this||pt)._values=[],(this||pt)._features=[],ut.readFields(_f,this||pt,wt),(this||pt).length=(this||pt)._features.length}function _f(ut,pt,wt){15===ut?pt.version=wt.readVarint():1===ut?pt.name=wt.readString():5===ut?pt.extent=wt.readVarint():2===ut?pt._features.push(wt.pos):3===ut?pt._keys.push(wt.readString()):4===ut&&pt._values.push(function(ut){for(var pt=null,wt=ut.readVarint()+ut.pos;ut.pos<wt;){var Tt=ut.readVarint()>>3;pt=1===Tt?ut.readString():2===Tt?ut.readFloat():3===Tt?ut.readDouble():4===Tt?ut.readVarint64():5===Tt?ut.readVarint():6===Tt?ut.readSVarint():7===Tt?ut.readBoolean():null}return pt}(wt))}vf.prototype.feature=function(ut){if(ut<0||ut>=(this||pt)._features.length)throw new Error("feature index out of bounds");(this||pt)._pbf.pos=(this||pt)._features[ut];var wt=(this||pt)._pbf.readVarint()+(this||pt)._pbf.pos;return new Ky((this||pt)._pbf,wt,(this||pt).extent,(this||pt)._keys,(this||pt)._values)};var tx=ex;function Mf(ut,pt,wt){if(3===ut){var Tt=new tx(wt,wt.readVarint()+wt.pos);Tt.length&&(pt[Tt.name]=Tt)}}var ix=Gy.VectorTile=function(ut,wt){(this||pt).layers=ut.readFields(Mf,{},wt)},rx=Gy.VectorTileFeature=Hy;Gy.VectorTileLayer=ex;class If extends xc{constructor(ut,pt,wt){super(ut,pt),this.z=wt}}class Tf extends If{constructor(ut,pt,wt,Tt){super(ut,pt,wt),this.w=Tt}}function kf(ut,pt,wt,Tt){const St=[],It=0===Tt?(ut,pt,wt,Tt,St,It)=>{ut.push(new xc(It,wt+(It-pt)/(Tt-pt)*(St-wt)))}:(ut,pt,wt,Tt,St,It)=>{ut.push(new xc(pt+(It-wt)/(St-wt)*(Tt-pt),It))};for(const Lt of ut){const ut=[];for(const St of Lt){if(St.length<=2)continue;const Lt=[];for(let ut=0;ut<St.length-1;ut++){const Xt=St[ut].x,Yt=St[ut].y,Mi=St[ut+1].x,vr=St[ut+1].y,br=0===Tt?Xt:Yt,Ar=0===Tt?Mi:vr;br<pt?Ar>pt&&It(Lt,Xt,Yt,Mi,vr,pt):br>wt?Ar<wt&&It(Lt,Xt,Yt,Mi,vr,wt):Lt.push(St[ut]),Ar<pt&&br>=pt&&It(Lt,Xt,Yt,Mi,vr,pt),Ar>wt&&br<=wt&&It(Lt,Xt,Yt,Mi,vr,wt)}let Xt=St[St.length-1];const Yt=0===Tt?Xt.x:Xt.y;Yt>=pt&&Yt<=wt&&Lt.push(Xt),Lt.length&&(Xt=Lt[Lt.length-1],Lt[0].x===Xt.x&&Lt[0].y===Xt.y||Lt.push(Lt[0]),ut.push(Lt))}ut.length&&St.push(ut)}return St}function zf(ut,pt,wt,Tt){const St="x"===wt?"y":"x",It=(Tt-ut[wt])/(pt[wt]-ut[wt]);ut[St]=ut[St]+(pt[St]-ut[St])*It,ut[wt]=Tt,ut.hasOwnProperty("z")&&(ut.z=Gn(ut.z,pt.z,It)),ut.hasOwnProperty("w")&&(ut.w=Gn(ut.w,pt.w,It))}function Pf(ut,pt,wt,Tt){const St=wt,It=Tt;for(const wt of["x","y"]){let Tt=ut,Lt=pt;Tt[wt]>=Lt[wt]&&(Tt=pt,Lt=ut),Tt[wt]<St&&Lt[wt]>St&&zf(Tt,Lt,wt,St),Tt[wt]<It&&Lt[wt]>It&&zf(Lt,Tt,wt,It)}}function Ef(ut,pt){return ut.x-pt.x||ut.y-pt.y}function Bf(ut,pt){return 0===Ef(ut.min,pt.min)&&0===Ef(ut.max,pt.max)}function Df(ut,pt){return!(ut.min.x>pt.max.x||ut.max.x<pt.min.x||ut.min.y>pt.max.y||ut.max.y<pt.min.y)}function Cf(ut,pt){if(ut.length!==pt.length)return!1;for(let wt=0;wt<ut.length;wt++)if(ut[wt].sourceId!==pt[wt].sourceId||!Bf(ut[wt],pt[wt])||ut[wt].order!==pt[wt].order||ut[wt].clipMask!==pt[wt].clipMask)return!1;return!0}function Rf(ut,pt,wt){const Tt=1/xf,St=1/(1<<wt.canonical.z),It=(pt.x*Tt+wt.canonical.x)*St+wt.wrap,Lt=(pt.y*Tt+wt.canonical.y)*St;return{min:new xc((ut.x*Tt+wt.canonical.x)*St+wt.wrap,(ut.y*Tt+wt.canonical.y)*St),max:new xc(It,Lt)}}function Vf(ut,pt,wt){const Tt=1<<wt.canonical.z,St=((pt.x-wt.wrap)*Tt-wt.canonical.x)*xf,It=(pt.y*Tt-wt.canonical.y)*xf;return{min:new xc(((ut.x-wt.wrap)*Tt-wt.canonical.x)*xf,(ut.y*Tt-wt.canonical.y)*xf),max:new xc(St,It)}}function Ff(ut,pt,wt,Tt,St,It,Lt){const Xt=ut.indices,Yt=ut.vertices,Mi=[];for(let vr=Tt;vr<Tt+St;vr+=3){const Tt=pt[wt[vr+0]+It],St=pt[wt[vr+1]+It],br=pt[wt[vr+2]+It],Ar=Math.min(Tt.x,St.x,br.x),Vr=Math.max(Tt.x,St.x,br.x),nn=Math.min(Tt.y,St.y,br.y),sn=Math.max(Tt.y,St.y,br.y);Mi.length=0,ut.grid.query(new xc(Ar,nn),new xc(Vr,sn),Mi);for(let ut=0;ut<Mi.length;ut++){const pt=Mi[ut];if(ch(Yt[Xt[3*pt+0]],Yt[Xt[3*pt+1]],Yt[Xt[3*pt+2]],Tt,St,br,Lt))return!0}}return!1}function Lf(ut,pt,wt,Tt){if(!ut||!wt)return!1;let St=ut.vertices;if(!pt.canonical.equals(Tt.canonical)||pt.wrap!==Tt.wrap){if(wt.vertices.length<ut.vertices.length)return Lf(wt,Tt,ut,pt);const It=pt.canonical,Lt=Tt.canonical,Xt=Math.pow(2,Lt.z-It.z);St=ut.vertices.map((ut=>new xc((ut.x+It.x*xf)*Xt-Lt.x*xf,(ut.y+It.y*xf)*Xt-Lt.y*xf)))}return Ff(wt,St,ut.indices,0,ut.indices.length,0,0)}function Of(ut,pt,wt,Tt){const St=Math.pow(2,Tt.z-wt.z);return new xc((ut+wt.x*xf)*St-Tt.x*xf,(pt+wt.y*xf)*St-Tt.y*xf)}function Uf(ut,pt){const wt=[];pt.footprint.grid.queryPoint(ut,wt);const Tt=pt.footprint.indices,St=pt.footprint.vertices;for(let pt=0;pt<wt.length;pt++){const It=wt[pt];if(ah([St[Tt[3*It+0]],St[Tt[3*It+1]],St[Tt[3*It+2]]],ut))return!0}return!1}class Nf{constructor(ut){this.size=ut,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(ut,pt){const wt=this.toIdx(ut,pt);return{min:this.minimums[wt],max:this.maximums[wt]}}isLeaf(ut,pt){return this.leaves[this.toIdx(ut,pt)]}toIdx(ut,pt){return pt*this.size+ut}}function jf(ut,pt,wt,Tt){let St=0,It=Number.MAX_VALUE;for(let Lt=0;Lt<3;Lt++)if(Math.abs(Tt[Lt])<1e-15){if(wt[Lt]<ut[Lt]||wt[Lt]>pt[Lt])return null}else{const Xt=1/Tt[Lt];let Yt=(ut[Lt]-wt[Lt])*Xt,Mi=(pt[Lt]-wt[Lt])*Xt;if(Yt>Mi){const ut=Yt;Yt=Mi,Mi=ut}if(Yt>St&&(St=Yt),Mi<It&&(It=Mi),St>It)return null}return St}function qf(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr){const br=Tt-ut,Ar=St-pt,Vr=It-wt,nn=Lt-ut,sn=Xt-pt,an=Yt-wt,ln=vr[1]*an-vr[2]*sn,cn=vr[2]*nn-vr[0]*an,un=vr[0]*sn-vr[1]*nn,fn=br*ln+Ar*cn+Vr*un;if(Math.abs(fn)<1e-15)return null;const _n=1/fn,gn=Mi[0]-ut,yn=Mi[1]-pt,xn=Mi[2]-wt,vn=(gn*ln+yn*cn+xn*un)*_n;if(vn<0||vn>1)return null;const bn=yn*Vr-xn*Ar,wn=xn*br-gn*Vr,Tn=gn*Ar-yn*br,En=(vr[0]*bn+vr[1]*wn+vr[2]*Tn)*_n;return En<0||vn+En>1?null:(nn*bn+sn*wn+an*Tn)*_n}function $f(ut,pt,wt){return(ut-pt)/(wt-pt)}function Gf(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=1<<wt,vr=It-Tt,br=Lt-St,Ar=(ut+1)/Mi*vr+Tt,Vr=(pt+0)/Mi*br+St,nn=(pt+1)/Mi*br+St;Xt[0]=(ut+0)/Mi*vr+Tt,Xt[1]=Vr,Yt[0]=Ar,Yt[1]=nn}class Xf{constructor(ut){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=ut,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const pt=function(ut){const pt=Math.ceil(Math.log2(ut.dim/8)),wt=[];let Tt=Math.ceil(Math.pow(2,pt));const St=1/Tt,s=(ut,pt,wt,Tt,St)=>{const It=Tt?1:0,Lt=(ut+1)*wt-It,Xt=pt*wt,Yt=(pt+1)*wt-It;St[0]=ut*wt,St[1]=Xt,St[2]=Lt,St[3]=Yt};let It=new Nf(Tt);const Lt=[];for(let pt=0;pt<Tt*Tt;pt++){s(pt%Tt,Math.floor(pt/Tt),St,!1,Lt);const wt=Zf(Lt[0],Lt[1],ut),Xt=Zf(Lt[2],Lt[1],ut),Yt=Zf(Lt[2],Lt[3],ut),Mi=Zf(Lt[0],Lt[3],ut);It.minimums.push(Math.min(wt,Xt,Yt,Mi)),It.maximums.push(Math.max(wt,Xt,Yt,Mi)),It.leaves.push(1)}for(wt.push(It),Tt/=2;Tt>=1;Tt/=2){const ut=wt[wt.length-1];It=new Nf(Tt);for(let pt=0;pt<Tt*Tt;pt++){s(pt%Tt,Math.floor(pt/Tt),2,!0,Lt);const wt=ut.getElevation(Lt[0],Lt[1]),St=ut.getElevation(Lt[2],Lt[1]),Xt=ut.getElevation(Lt[2],Lt[3]),Yt=ut.getElevation(Lt[0],Lt[3]),Mi=ut.isLeaf(Lt[0],Lt[1]),vr=ut.isLeaf(Lt[2],Lt[1]),br=ut.isLeaf(Lt[2],Lt[3]),Ar=ut.isLeaf(Lt[0],Lt[3]),Vr=Math.min(wt.min,St.min,Xt.min,Yt.min),nn=Math.max(wt.max,St.max,Xt.max,Yt.max),sn=Mi&&vr&&br&&Ar;It.maximums.push(nn),It.minimums.push(Vr),It.leaves.push(nn-Vr<=5&&sn?1:0)}wt.push(It)}return wt}(this.dem),wt=pt.length-1,Tt=pt[wt];this._addNode(Tt.minimums[0],Tt.maximums[0],Tt.leaves[0]),this._construct(pt,0,0,wt,0)}raycastRoot(ut,pt,wt,Tt,St,It,Lt=1){return jf([ut,pt,-100],[wt,Tt,this.maximums[0]*Lt],St,It)}raycast(pt,wt,Tt,St,It,Lt,Xt=1){if(!this.nodeCount)return null;const Yt=this.raycastRoot(pt,wt,Tt,St,It,Lt,Xt);if(null==Yt)return null;const Mi=[],vr=[],br=[],Ar=[],Vr=[{idx:0,t:Yt,nodex:0,nodey:0,depth:0}];for(;Vr.length>0;){const{idx:Yt,t:nn,nodex:sn,nodey:an,depth:ln}=Vr.pop();if(this.leaves[Yt]){Gf(sn,an,ln,pt,wt,Tt,St,br,Ar);const Yt=1<<ln,Mi=(sn+0)/Yt,vr=(sn+1)/Yt,Vr=(an+0)/Yt,cn=(an+1)/Yt,un=Zf(Mi,Vr,this.dem)*Xt,fn=Zf(vr,Vr,this.dem)*Xt,_n=Zf(vr,cn,this.dem)*Xt,gn=Zf(Mi,cn,this.dem)*Xt,yn=qf(br[0],br[1],un,Ar[0],br[1],fn,Ar[0],Ar[1],_n,It,Lt),xn=qf(Ar[0],Ar[1],_n,br[0],Ar[1],gn,br[0],br[1],un,It,Lt),vn=Math.min(null!==yn?yn:Number.MAX_VALUE,null!==xn?xn:Number.MAX_VALUE);if(vn!==Number.MAX_VALUE)return vn;{const pt=ut._.scaleAndAdd([],It,Lt,nn);if(Yf(un,fn,gn,_n,$f(pt[0],br[0],Ar[0]),$f(pt[1],br[1],Ar[1]))>=pt[2])return nn}continue}let cn=0;for(let ut=0;ut<this._siblingOffset.length;ut++){Gf((sn<<1)+this._siblingOffset[ut][0],(an<<1)+this._siblingOffset[ut][1],ln+1,pt,wt,Tt,St,br,Ar),br[2]=-100,Ar[2]=this.maximums[this.childOffsets[Yt]+ut]*Xt;const Vr=jf(br,Ar,It,Lt);if(null!=Vr){const pt=Vr;Mi[ut]=pt;let wt=!1;for(let Tt=0;Tt<cn&&!wt;Tt++)pt>=Mi[vr[Tt]]&&(vr.splice(Tt,0,ut),wt=!0);wt||(vr[cn]=ut),cn++}}for(let ut=0;ut<cn;ut++){const pt=vr[ut];Vr.push({idx:this.childOffsets[Yt]+pt,t:Mi[pt],nodex:(sn<<1)+this._siblingOffset[pt][0],nodey:(an<<1)+this._siblingOffset[pt][1],depth:ln+1})}}return null}_addNode(ut,pt,wt){return this.minimums.push(ut),this.maximums.push(pt),this.leaves.push(wt),this.childOffsets.push(0),this.nodeCount++}_construct(ut,pt,wt,Tt,St){if(1===ut[Tt].isLeaf(pt,wt))return;this.childOffsets[St]||(this.childOffsets[St]=this.nodeCount);const It=Tt-1,Lt=ut[It];let Xt=0,Yt=0;for(let ut=0;ut<this._siblingOffset.length;ut++){const Tt=2*pt+this._siblingOffset[ut][0],St=2*wt+this._siblingOffset[ut][1],It=Lt.getElevation(Tt,St),Mi=Lt.isLeaf(Tt,St),vr=this._addNode(It.min,It.max,Mi);Mi&&(Xt|=1<<ut),Yt||(Yt=vr)}for(let Tt=0;Tt<this._siblingOffset.length;Tt++)Xt&1<<Tt||this._construct(ut,2*pt+this._siblingOffset[Tt][0],2*wt+this._siblingOffset[Tt][1],It,Yt+Tt)}}function Yf(ut,pt,wt,Tt,St,It){return Gn(Gn(ut,wt,It),Gn(pt,Tt,It),St)}function Zf(ut,pt,wt){const Tt=wt.dim,St=Ke(ut*Tt-.5,0,Tt-1),It=Ke(pt*Tt-.5,0,Tt-1),Lt=Math.floor(St),Xt=Math.floor(It),Yt=Math.min(Lt+1,Tt-1),Mi=Math.min(Xt+1,Tt-1);return Yf(wt.get(Lt,Xt),wt.get(Yt,Xt),wt.get(Lt,Mi),wt.get(Yt,Mi),St-Lt,It-Xt)}const sx={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Kf(ut,pt,wt){return(256*ut*256+256*pt+wt)/10-1e4}function Wf(ut,pt,wt){return 256*ut+pt+wt/256-32768}class Jf{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(ut,pt,wt,Tt=!1){if(this.uid=ut,pt.height!==pt.width)throw new RangeError("DEM tiles must be square");if(wt&&"mapbox"!==wt&&"terrarium"!==wt)return fr(`"${wt}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=pt.height;const St=this.dim=pt.height-2,It=new Uint32Array(pt.data.buffer);if(this.pixels=new Uint8Array(pt.data.buffer),this.floatView=new Float32Array(pt.data.buffer),this.borderReady=Tt,this._modifiedForSources={},!Tt){for(let ut=0;ut<St;ut++)It[this._idx(-1,ut)]=It[this._idx(0,ut)],It[this._idx(St,ut)]=It[this._idx(St-1,ut)],It[this._idx(ut,-1)]=It[this._idx(ut,0)],It[this._idx(ut,St)]=It[this._idx(ut,St-1)];It[this._idx(-1,-1)]=It[this._idx(0,0)],It[this._idx(St,-1)]=It[this._idx(St-1,0)],It[this._idx(-1,St)]=It[this._idx(0,St-1)],It[this._idx(St,St)]=It[this._idx(St-1,St-1)]}const Lt="terrarium"===wt?Wf:Kf;for(let ut=0;ut<It.length;++ut){const pt=4*ut;this.floatView[ut]=Lt(this.pixels[pt],this.pixels[pt+1],this.pixels[pt+2])}this._timestamp=Ju.now()}_buildQuadTree(){this._tree=new Xf(this)}get(ut,pt,wt=!1){wt&&(ut=Ke(ut,-1,this.dim),pt=Ke(pt,-1,this.dim));const Tt=this._idx(ut,pt);return this.floatView[Tt]}set(ut,pt,wt){const Tt=this._idx(ut,pt),St=this.floatView[Tt];return this.floatView[Tt]=wt,wt-St}static getUnpackVector(ut){return sx[ut]}_idx(ut,pt){if(ut<-1||ut>=this.dim+1||pt<-1||pt>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(pt+1)*this.stride+(ut+1)}static pack(ut,pt){const wt=[0,0,0,0],Tt=Jf.getUnpackVector(pt);let St=Math.floor((ut+Tt[3])/Tt[2]);return wt[2]=St%256,St=Math.floor(St/256),wt[1]=St%256,St=Math.floor(St/256),wt[0]=St,wt}getPixels(){return new dp({width:this.stride,height:this.stride},this.pixels)}backfillBorder(ut,pt,wt){if(this.dim!==ut.dim)throw new Error("dem dimension mismatch");let Tt=pt*this.dim,St=pt*this.dim+this.dim,It=wt*this.dim,Lt=wt*this.dim+this.dim;switch(pt){case-1:Tt=St-1;break;case 1:St=Tt+1}switch(wt){case-1:It=Lt-1;break;case 1:Lt=It+1}const Xt=-pt*this.dim,Yt=-wt*this.dim;for(let pt=It;pt<Lt;pt++)for(let wt=Tt;wt<St;wt++){const Tt=4*this._idx(wt,pt),St=4*this._idx(wt+Xt,pt+Yt);this.pixels[Tt+0]=ut.pixels[St+0],this.pixels[Tt+1]=ut.pixels[St+1],this.pixels[Tt+2]=ut.pixels[St+2],this.pixels[Tt+3]=ut.pixels[St+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Mo(Jf,"DEMData"),Mo(Xf,"DemMinMaxQuadTree",{omit:["dem"]});class Qf{constructor(ut,pt,wt){this._demTile=ut,this._dem=this._demTile.dem,this._scale=pt,this._offset=wt}static create(ut,pt,wt){const Tt=wt||ut.findDEMTileFor(pt);if(!Tt||!Tt.dem)return;const St=Tt.dem,It=Tt.tileID,Lt=1<<pt.canonical.z-It.canonical.z;return new Qf(Tt,St.dim/xf/Lt,[(pt.canonical.x/Lt-It.canonical.x)*St.dim,(pt.canonical.y/Lt-It.canonical.y)*St.dim])}tileCoordToPixel(ut,pt){const wt=pt*this._scale+this._offset[1],Tt=Math.floor(ut*this._scale+this._offset[0]),St=Math.floor(wt);return new xc(Tt,St)}getElevationAt(ut,pt,wt,Tt){const St=ut*this._scale+this._offset[0],It=pt*this._scale+this._offset[1],Lt=Math.floor(St),Xt=Math.floor(It),Yt=this._dem;return Tt=!!Tt,wt?Gn(Gn(Yt.get(Lt,Xt,Tt),Yt.get(Lt,Xt+1,Tt),It-Xt),Gn(Yt.get(Lt+1,Xt,Tt),Yt.get(Lt+1,Xt+1,Tt),It-Xt),St-Lt):Yt.get(Lt,Xt,Tt)}getElevationAtPixel(ut,pt,wt){return this._dem.get(ut,pt,!!wt)}getMeterToDEM(ut){return(1<<this._demTile.tileID.canonical.z)*zc(1,ut)*this._dem.stride}}const hx={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7},dx=rx.types,px=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],fx=["fill-extrusion-flood-light-ground-radius"],mx=Math.pow(2,13),_x=Math.pow(2,15)-1,yx=new xc(0,1),xx=2147483648;function ld(ut,pt,wt,Tt,St,It,Lt,Xt){ut.emplaceBack((pt<<1)+Lt,(wt<<1)+It,(Math.floor(Tt*mx)<<1)+St,Math.round(Xt))}function ud(ut,pt,wt,Tt,St,It){ut.emplaceBack(pt.x,pt.y,(wt.x<<1)+Tt,(wt.y<<1)+St,It)}function cd(ut,pt,wt){const Tt=16384;ut.emplaceBack(pt.x,pt.y,pt.z,wt[0]*Tt,wt[1]*Tt,wt[2]*Tt)}class hd{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class pd{constructor(){this.centroidXY=new xc(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new xc(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new xc(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new xc(this.max.x-this.min.x,this.max.y-this.min.y)}}class fd{constructor(){this.acc=new xc(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(ut,pt){ut.min.x===Number.MAX_VALUE&&(ut.min.x=ut.max.x=pt.x,ut.min.y=ut.max.y=pt.y)}appendEdge(ut,pt,wt){this.accCount++,this.acc._add(pt);let Tt=!!this.borders;pt.x<ut.min.x?(ut.min.x=pt.x,Tt=!0):pt.x>ut.max.x&&(ut.max.x=pt.x,Tt=!0),pt.y<ut.min.y?(ut.min.y=pt.y,Tt=!0):pt.y>ut.max.y&&(ut.max.y=pt.y,Tt=!0),((0===pt.x||pt.x===xf)&&pt.x===wt.x)!=((0===pt.y||pt.y===xf)&&pt.y===wt.y)&&this.processBorderOverlap(pt,wt),Tt&&this.checkBorderIntersection(pt,wt)}checkBorderIntersection(ut,pt){pt.x<0!=ut.x<0&&this.addBorderIntersection(0,Gn(pt.y,ut.y,(0-pt.x)/(ut.x-pt.x))),pt.x>xf!=ut.x>xf&&this.addBorderIntersection(1,Gn(pt.y,ut.y,(xf-pt.x)/(ut.x-pt.x))),pt.y<0!=ut.y<0&&this.addBorderIntersection(2,Gn(pt.x,ut.x,(0-pt.y)/(ut.y-pt.y))),pt.y>xf!=ut.y>xf&&this.addBorderIntersection(3,Gn(pt.x,ut.x,(xf-pt.y)/(ut.y-pt.y)))}addBorderIntersection(ut,pt){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const wt=this.borders[ut];pt<wt[0]&&(wt[0]=pt),pt>wt[1]&&(wt[1]=pt)}processBorderOverlap(ut,pt){if(ut.x===pt.x){if(ut.y===pt.y)return;const wt=0===ut.x?0:1;this.addBorderIntersection(wt,pt.y),this.addBorderIntersection(wt,ut.y)}else{const wt=0===ut.y?2:3;this.addBorderIntersection(wt,pt.x),this.addBorderIntersection(wt,ut.x)}}centroid(){return 0===this.accCount?new xc(0,0):new xc(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((ut,pt)=>ut+ +(pt[0]!==Number.MAX_VALUE)),0):0}}function dd(ut,pt){const wt=ut.add(pt)._unit(),Tt=Ke(ut.x*wt.x+ut.y*wt.y,-1,1);var St,It,Lt;return St=Math.acos(Tt),Math.min(4,Math.max(-4,Math.tan(St)))/4*_x*((It=ut).x*(Lt=pt).y-It.y*Lt.x<0?-1:1)}const vx=[ut=>ut.x<0,ut=>ut.x>xf,ut=>ut.y<0,ut=>ut.y>xf];function yd(ut,pt,wt,Tt){const St=[4];if(0===Tt)return St;wt._mult(Tt);const It=ut.sub(wt),Lt=pt.sub(wt),Xt=[ut,pt,It,Lt];for(let ut=0;ut<4;ut++)for(const pt of Xt)if(vx[ut](pt)){St.push(ut);break}return St}class gd{constructor(ut){this.vertexArray=new Fl,this.indexArray=new Ql,this.programConfigurations=new Wu(ut.layers,{zoom:ut.zoom,lut:ut.lut},(ut=>fx.includes(ut))),this._segments=new Au,this.hiddenByLandmarkVertexArray=new cu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Au}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(ut,pt,wt,Tt=!1){const St=ut.length;if(St>2){let It=Math.max(0,this._segments.get().length-1);const Lt=this._segments._prepareSegment(4*St,this.vertexArray.length,2*this._segmentToGroundQuads[It].length);let Xt;It!==this._segments.get().length-1&&(It++,this._segmentToGroundQuads[It]=[],this._segmentToRegionTriCounts[It]=[0,0,0,0,0]);{const pt=ut[0],wt=ut[1];Xt=dd(pt.sub(ut[St-1])._perp()._unit(),wt.sub(pt)._perp()._unit())}for(let Yt=0;Yt<St;Yt++){const Mi=Yt===St-1?0:Yt+1,vr=ut[Yt],br=ut[Mi],Ar=ut[Mi===St-1?0:Mi+1],Vr=br.sub(vr)._perp()._unit(),nn=dd(Vr,Ar.sub(br)._perp()._unit()),sn=Xt,an=nn;if(wd(vr,br,pt)||Tt&&Md(vr,pt)&&Md(br,pt)){Xt=nn;continue}const ln=Lt.vertexLength;ud(this.vertexArray,vr,br,1,1,sn),ud(this.vertexArray,vr,br,1,0,sn),ud(this.vertexArray,vr,br,0,1,an),ud(this.vertexArray,vr,br,0,0,an),Lt.vertexLength+=4;const cn=yd(vr,br,Vr,wt);for(const ut of cn)this._segmentToGroundQuads[It].push({id:ln,region:ut}),this._segmentToRegionTriCounts[It][ut]+=2,Lt.primitiveLength+=2;Xt=nn}}}prepareBorderSegments(){if(!this.hasData())return;const ut=this._segments.get(),pt=ut.length;for(let ut=0;ut<pt;ut++)this._segmentToGroundQuads[ut].sort(((ut,pt)=>ut.region-pt.region));for(let wt=0;wt<pt;wt++){const pt=this._segmentToGroundQuads[wt],Tt=ut[wt],St=this._segmentToRegionTriCounts[wt];St.reduce(((ut,pt)=>ut+pt),0);let It=0;for(let ut=0;ut<=4;ut++){const pt=St[ut];if(0!==pt){let wt=this.regionSegments[ut];wt||(wt=this.regionSegments[ut]=new Au);const St={vertexOffset:Tt.vertexOffset,primitiveOffset:Tt.primitiveOffset+It,vertexLength:Tt.vertexLength,primitiveLength:pt};wt.get().push(St)}It+=pt}for(let ut=0;ut<pt.length;ut++){const wt=pt[ut].id;this.indexArray.emplaceBack(wt,wt+1,wt+3),this.indexArray.emplaceBack(wt,wt+3,wt+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(ut,pt,wt,Tt,St,It){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,ut,pt,wt,Tt,St,It)}upload(ut){this.hasData()&&(this.vertexBuffer=ut.createVertexBuffer(this.vertexArray,Ey.members),this.indexBuffer=ut.createIndexBuffer(this.indexArray))}uploadPaintProperties(ut){this.hasData()&&this.programConfigurations.upload(ut)}update(ut,pt,wt,Tt,St,It){this.hasData()&&this.programConfigurations.updatePaintArrays(ut,pt,wt,Tt,St,It)}updateHiddenByLandmark(ut){if(!this.hasData())return;const pt=ut.groundVertexCount+ut.groundVertexArrayOffset;if(0===ut.groundVertexCount)return;const wt=ut.flags&xx?1:0;for(let Tt=ut.groundVertexArrayOffset;Tt<pt;++Tt)this.hiddenByLandmarkVertexArray.emplace(Tt,wt);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(ut){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=ut.createVertexBuffer(this.hiddenByLandmarkVertexArray,Cy.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let ut=0;ut<=4;ut++){const pt=this.regionSegments[ut];pt&&pt.destroy()}}}}class xd{constructor(ut){this.zoom=ut.zoom,this.canonical=ut.canonical,this.overscaling=ut.overscaling,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=ut.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=ut.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ql,this.footprintVertices=new Cl,this.footprintSegments=[],this.layoutVertexArray=new Vl,this.centroidVertexArray=new _u,this.indexArray=new Ql,this.programConfigurations=new Wu(ut.layers,{zoom:ut.zoom,lut:ut.lut},(ut=>px.includes(ut))),this.segments=new Au,this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.groundEffect=new gd(ut),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(ut,pt){}populate(ut,pt,wt,Tt){this.features=[],this.hasPattern=Hp("fill-extrusion",this.layers,pt),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Fc(wt),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:St,id:It,index:Lt,sourceLayerIndex:Xt}of ut){const ut=this.layers[0]._featureFilter.needGeometry,Yt=Yc(St,ut);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Yt,wt))continue;const Mi={id:It,sourceLayerIndex:Xt,index:Lt,geometry:ut?Yt.geometry:Xc(St,wt,Tt),properties:St.properties,type:St.type,patterns:{}},vr=this.layoutVertexArray.length;this.hasPattern?this.features.push(Kp("fill-extrusion",this.layers,Mi,this.zoom,pt)):this.addFeature(Mi,Mi.geometry,Lt,wt,{},pt.availableImages,Tt,pt.brightness),pt.featureIndex.insert(St,Mi.geometry,Lt,Xt,this.index,vr)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(ut,pt,wt,Tt,St,It){for(const ut of this.features){const{geometry:Lt}=ut;this.addFeature(ut,Lt,ut.index,pt,wt,Tt,St,It)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(ut,pt,wt,Tt,St){const It=0!==Object.keys(ut).length;if(It&&!this.stateDependentLayers.length)return;const Lt=It?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(ut,pt,Lt,wt,Tt,St),this.groundEffect.update(ut,pt,Lt,wt,Tt,St)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(ut){this.uploaded||(this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,By),this.indexBuffer=ut.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=ut.createVertexBuffer(this.layoutVertexExtArray,ky.members,!0)),this.groundEffect.upload(ut)),this.groundEffect.uploadPaintProperties(ut),this.programConfigurations.upload(ut),this.uploaded=!0}uploadCentroid(ut){this.groundEffect.uploadHiddenByLandmark(ut),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=ut.createVertexBuffer(this.centroidVertexArray,Sy.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(ut,{})/this.tileToMeter,Mi=[new xc(0,0),new xc(xf,xf)],vr=Lt.projection,br="globe"===vr.name,Ar="Polygon"===dx[ut.type],Vr=new fd;Vr.centroidDataIndex=this.centroidData.length;const nn=new pd,sn=this.layers[0].paint.get("fill-extrusion-base").evaluate(ut,{},Tt)<=0,an=this.layers[0].paint.get("fill-extrusion-height").evaluate(ut,{},Tt);nn.height=an,nn.vertexArrayOffset=this.layoutVertexArray.length,nn.groundVertexArrayOffset=this.groundEffect.vertexArray.length,br&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ql);const ln=Yp(pt,500);for(let ut=ln.length-1;ut>=0;ut--){const pt=ln[ut];(0===pt.length||(cn=pt[0]).every((ut=>ut.x<=0))||cn.every((ut=>ut.x>=xf))||cn.every((ut=>ut.y<=0))||cn.every((ut=>ut.y>=xf)))&&ln.splice(ut,1)}var cn;let un;if(br)un=Td(ln,Mi,Tt);else{un=[];for(const ut of ln)un.push({polygon:ut,bounds:Mi})}const fn=Ar?this.edgeRadius:0,_n=fn>0&&this.zoom<17,w=(ut,pt)=>{if(0===ut.length)return!1;const wt=ut[ut.length-1];return pt.x===wt.x&&pt.y===wt.y};for(const{polygon:ut,bounds:pt}of un){let wt=0,St=0;for(const pt of ut)Ar&&!pt[0].equals(pt[pt.length-1])&&pt.push(pt[0]),St+=Ar?pt.length-1:pt.length;const It=this.segments.prepareSegment((Ar?5:4)*St,this.layoutVertexArray,this.indexArray);nn.footprintSegIdx<0&&(nn.footprintSegIdx=this.footprintSegments.length),nn.polygonSegIdx<0&&(nn.polygonSegIdx=this.polygonSegments.length);const Lt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Xt=new hd;if(Xt.vertexOffset=this.footprintVertices.length,Xt.indexOffset=3*this.footprintIndices.length,Xt.ringIndices=[],Ar){const St=[],Lt=[];wt=It.vertexLength;for(let wt=0;wt<ut.length;wt++){const Mi=ut[wt];Mi.length&&0!==wt&&Lt.push(St.length/2);const Ar=[];let Vr,nn;Vr=Mi[1].sub(Mi[0])._perp()._unit(),Xt.ringIndices.push(Mi.length-1);for(let ut=1;ut<Mi.length;ut++){const pt=Mi[ut],wt=Mi[ut===Mi.length-1?1:ut+1],Lt=pt.clone();if(fn){nn=wt.sub(pt)._perp()._unit();const ut=Vr.add(nn)._unit(),Tt=fn*Math.min(4,1/(Vr.x*ut.x+Vr.y*ut.y));Lt.x+=Tt*ut.x,Lt.y+=Tt*ut.y,Lt.x=Math.round(Lt.x),Lt.y=Math.round(Lt.y),Vr=nn}!sn||0!==fn&&!_n||w(Ar,Lt)||Ar.push(Lt),ld(this.layoutVertexArray,Lt.x,Lt.y,0,0,1,1,0),It.vertexLength++,this.footprintVertices.emplaceBack(pt.x,pt.y),St.push(pt.x,pt.y),br&&cd(this.layoutVertexExtArray,vr.projectTilePoint(Lt.x,Lt.y,Tt),vr.upVector(Tt,Lt.x,Lt.y))}sn&&(0===fn||_n)&&(0!==Ar.length&&w(Ar,Ar[0])&&Ar.pop(),this.groundEffect.addData(Ar,pt,Yt))}const Mi=wp(St,Lt);for(let ut=0;ut<Mi.length;ut+=3)this.footprintIndices.emplaceBack(Xt.vertexOffset+Mi[ut+0],Xt.vertexOffset+Mi[ut+1],Xt.vertexOffset+Mi[ut+2]),this.indexArray.emplaceBack(wt+Mi[ut],wt+Mi[ut+2],wt+Mi[ut+1]),It.primitiveLength++;Xt.indexCount+=Mi.length,Xt.vertexCount+=this.footprintVertices.length-Xt.vertexOffset}for(let St=0;St<ut.length;St++){const Lt=ut[St];Vr.startRing(nn,Lt[0]);let Xt=Lt.length>4&&Ad(Lt[Lt.length-2],Lt[0],Lt[1]),Mi=fn?vd(Lt[Lt.length-2],Lt[0],Lt[1],fn):0;const an=[];let ln,cn,un;cn=Lt[1].sub(Lt[0])._perp()._unit();let _n=!0;for(let ut=1,St=0;ut<Lt.length;ut++){let Yt=Lt[ut-1],Ar=Lt[ut];const gn=Lt[ut===Lt.length-1?1:ut+1];if(Vr.appendEdge(nn,Ar,Yt),wd(Ar,Yt,pt)){fn&&(cn=gn.sub(Ar)._perp()._unit(),_n=!_n);continue}const yn=Ar.sub(Yt)._perp(),xn=yn.x/(Math.abs(yn.x)+Math.abs(yn.y)),vn=yn.y>0?1:0,bn=Yt.dist(Ar);if(St+bn>32768&&(St=0),fn){un=gn.sub(Ar)._perp()._unit();let ut=_d(Yt,Ar,gn,bd(cn,un),fn);isNaN(ut)&&(ut=0);const pt=Ar.sub(Yt)._unit();Yt=Yt.add(pt.mult(Mi))._round(),Ar=Ar.add(pt.mult(-ut))._round(),Mi=ut,cn=un,sn&&this.zoom>=17&&(w(an,Yt)||an.push(Yt),w(an,Ar)||an.push(Ar))}const wn=It.vertexLength,Tn=Lt.length>4&&Ad(Yt,Ar,gn);let En=Sd(St,Xt,_n);if(ld(this.layoutVertexArray,Yt.x,Yt.y,xn,vn,0,0,En),ld(this.layoutVertexArray,Yt.x,Yt.y,xn,vn,0,1,En),St+=bn,En=Sd(St,Tn,!_n),Xt=Tn,ld(this.layoutVertexArray,Ar.x,Ar.y,xn,vn,0,0,En),ld(this.layoutVertexArray,Ar.x,Ar.y,xn,vn,0,1,En),It.vertexLength+=4,this.indexArray.emplaceBack(wn+0,wn+1,wn+2),this.indexArray.emplaceBack(wn+1,wn+3,wn+2),It.primitiveLength+=2,fn){const Tt=wt+(1===ut?Lt.length-2:ut-2),St=1===ut?wt:Tt+1;if(this.indexArray.emplaceBack(wn+1,Tt,wn+3),this.indexArray.emplaceBack(Tt,St,wn+3),It.primitiveLength+=2,void 0===ln&&(ln=wn),!wd(gn,Lt[ut],pt)){const pt=ut===Lt.length-1?ln:It.vertexLength;this.indexArray.emplaceBack(wn+2,wn+3,pt),this.indexArray.emplaceBack(wn+3,pt+1,pt),this.indexArray.emplaceBack(wn+3,St,pt+1),It.primitiveLength+=3}_n=!_n}if(br){const ut=this.layoutVertexExtArray,pt=vr.projectTilePoint(Yt.x,Yt.y,Tt),wt=vr.projectTilePoint(Ar.x,Ar.y,Tt),St=vr.upVector(Tt,Yt.x,Yt.y),It=vr.upVector(Tt,Ar.x,Ar.y);cd(ut,pt,St),cd(ut,pt,St),cd(ut,wt,It),cd(ut,wt,It)}}Ar&&(wt+=Lt.length-1),sn&&fn&&this.zoom>=17&&(0!==an.length&&w(an,an[0])&&an.pop(),this.groundEffect.addData(an,pt,Yt,fn>0))}this.footprintSegments.push(Xt),Lt.triangleCount=this.indexArray.length-Lt.triangleArrayOffset,this.polygonSegments.push(Lt),++nn.footprintSegLen,++nn.polygonSegLen}if(nn.vertexCount=this.layoutVertexArray.length-nn.vertexArrayOffset,nn.groundVertexCount=this.groundEffect.vertexArray.length-nn.groundVertexArrayOffset,0!==nn.vertexCount){if(nn.centroidXY=Vr.borders?yx:this.encodeCentroid(Vr,nn),this.centroidData.push(nn),Vr.borders){this.featuresOnBorder.push(Vr);const ut=this.featuresOnBorder.length-1;for(let pt=0;pt<Vr.borders.length;pt++)Vr.borders[pt][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[pt].push(ut)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,ut,wt,St,It,Tt,Xt),this.groundEffect.addPaintPropertiesData(ut,wt,St,It,Tt,Xt),this.maxHeight=Math.max(this.maxHeight,an)}}sortBorders(){for(let ut=0;ut<this.borderFeatureIndices.length;ut++)this.borderFeatureIndices[ut].sort(((pt,wt)=>this.featuresOnBorder[pt].borders[ut][0]-this.featuresOnBorder[wt].borders[ut][0]))}splitToSubtiles(){const ut=[];for(let pt=0;pt<this.centroidData.length;pt++){const wt=this.centroidData[pt],Tt=+(wt.min.y+wt.max.y>xf),St=2*Tt+(+(wt.min.x+wt.max.x>xf)^Tt);for(let Tt=0;Tt<wt.polygonSegLen;Tt++){const It=wt.polygonSegIdx+Tt;ut.push({centroidIdx:pt,subtile:St,polygonSegmentIdx:It,triangleSegmentIdx:this.polygonSegments[It].triangleSegIdx})}}const pt=new Ql;ut.sort(((ut,pt)=>ut.triangleSegmentIdx===pt.triangleSegmentIdx?ut.subtile-pt.subtile:ut.triangleSegmentIdx-pt.triangleSegmentIdx));let wt=0,Tt=0,St=0;for(const pt of ut){if(pt.triangleSegmentIdx!==wt)break;St++}const It=ut.length;for(;Tt!==ut.length;){wt=ut[Tt].triangleSegmentIdx;let Lt=0,Xt=Tt,Yt=Tt;for(let pt=Xt;pt<St&&ut[pt].subtile===Lt;pt++)Yt++;for(;Xt!==St;){const Tt=ut[Xt];Lt=Tt.subtile;const It=this.centroidData[Tt.centroidIdx].min.clone(),Mi=this.centroidData[Tt.centroidIdx].max.clone(),vr={vertexOffset:this.segments.segments[wt].vertexOffset,primitiveOffset:pt.length,vertexLength:this.segments.segments[wt].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let wt=Xt;wt<Yt;wt++){const Tt=ut[wt],St=this.polygonSegments[Tt.polygonSegmentIdx],Lt=this.centroidData[Tt.centroidIdx].min,Xt=this.centroidData[Tt.centroidIdx].max,Yt=this.indexArray.uint16;for(let ut=St.triangleArrayOffset;ut<St.triangleArrayOffset+St.triangleCount;ut++)pt.emplaceBack(Yt[3*ut],Yt[3*ut+1],Yt[3*ut+2]);vr.primitiveLength+=St.triangleCount,It.x=Math.min(It.x,Lt.x),It.y=Math.min(It.y,Lt.y),Mi.x=Math.max(Mi.x,Xt.x),Mi.y=Math.max(Mi.y,Xt.y)}vr.primitiveLength>0&&this.triangleSubSegments.push({segment:vr,min:It,max:Mi}),Xt=Yt;for(let pt=Xt;pt<St&&ut[pt].subtile===ut[Xt].subtile;pt++)Yt++}Tt=St;for(let pt=Tt;pt<It&&ut[pt].triangleSegmentIdx===ut[Tt].triangleSegmentIdx;pt++)St++}pt._trim(),this.indexArray=pt}getVisibleSegments(ut,pt,wt){let Tt=0,St=0;const It=1<<ut.canonical.z;if(pt){const wt=pt.getMinMaxForTile(ut);wt&&(Tt=wt.min,St=wt.max)}St+=this.maxHeight;const Lt=ut.toUnwrapped();let Xt;const Yt=[Lt.canonical.x/It+Lt.wrap,Lt.canonical.y/It],Mi=[(Lt.canonical.x+1)/It+Lt.wrap,(Lt.canonical.y+1)/It],vr=new Au,h=(ut,pt,wt)=>[ut[0]*(1-wt[0])+pt[0]*wt[0],ut[1]*(1-wt[1])+pt[1]*wt[1]],br=[],Ar=[];for(const ut of this.triangleSubSegments){br[0]=ut.min.x/xf,br[1]=ut.min.y/xf,Ar[0]=ut.max.x/xf,Ar[1]=ut.max.y/xf;const pt=h(Yt,Mi,br),It=h(Yt,Mi,Ar);if(0===new Ah([pt[0],pt[1],Tt],[It[0],It[1],St]).intersectsPrecise(wt)){Xt&&(vr.segments.push(Xt),Xt=void 0);continue}const Lt=ut.segment;Xt&&Xt.vertexOffset!==Lt.vertexOffset&&(vr.segments.push(Xt),Xt=void 0),Xt?(Xt.vertexLength+=Lt.vertexLength,Xt.primitiveLength+=Lt.primitiveLength):Xt={vertexOffset:Lt.vertexOffset,primitiveLength:Lt.primitiveLength,vertexLength:Lt.vertexLength,primitiveOffset:Lt.primitiveOffset,sortKey:void 0,vaos:{}}}return Xt&&vr.segments.push(Xt),vr}encodeCentroid(ut,pt){const wt=ut.centroid(),Tt=pt.span(),St=Math.min(7,Math.round(Tt.x*this.tileToMeter/10)),It=Math.min(7,Math.round(Tt.y*this.tileToMeter/10));return new xc(Ke(wt.x,1,xf-1)<<3|St,Ke(wt.y,1,xf-1)<<3|It)}encodeBorderCentroid(ut){if(!ut.borders)return new xc(0,0);const pt=ut.borders,wt=Number.MAX_VALUE;if(pt[0][0]!==wt||pt[1][0]!==wt){const ut=pt[0][0]!==wt?0:1;return new xc(6|(pt[0][0]!==wt?0:65528),(pt[ut][0]+pt[ut][1])/2<<3|6)}{const ut=pt[2][0]!==wt?2:3;return new xc((pt[ut][0]+pt[ut][1])/2<<3|6,6|(pt[2][0]!==wt?0:65528))}}showCentroid(ut){const pt=this.centroidData[ut.centroidDataIndex];pt.flags&=xx,pt.centroidXY.x=0,pt.centroidXY.y=0,this.writeCentroidToBuffer(pt)}writeCentroidToBuffer(ut){this.groundEffect.updateHiddenByLandmark(ut);const pt=ut.vertexArrayOffset,wt=ut.vertexCount+ut.vertexArrayOffset,Tt=ut.flags&xx?yx:ut.centroidXY,St=this.centroidVertexArray.geta_centroid_pos0(pt);if(this.centroidVertexArray.geta_centroid_pos1(pt)!==Tt.y||St!==Tt.x){for(let ut=pt;ut<wt;++ut)this.centroidVertexArray.emplace(ut,Tt.x,Tt.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const ut of this.centroidData)this.writeCentroidToBuffer(ut)}updateReplacement(ut,pt,wt){if(pt.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=pt.updateTime;const Tt=pt.getReplacementRegionsForTile(ut.toUnwrapped());if(Cf(this.activeReplacements,Tt))return;if(this.activeReplacements=Tt,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const ut of this.centroidData)ut.flags&=2147483647;const St=[];for(const pt of this.activeReplacements){if(pt.order<wt)continue;const Tt=Math.pow(2,pt.footprintTileId.canonical.z-ut.canonical.z);for(const wt of this.centroidData)if(!(wt.flags&xx||pt.min.x>wt.max.x||wt.min.x>pt.max.x||pt.min.y>wt.max.y||wt.min.y>pt.max.y))for(let It=0;It<wt.footprintSegLen;It++){const Lt=this.footprintSegments[wt.footprintSegIdx+It];if(St.length=0,kd(this.footprintVertices,Lt.vertexOffset,Lt.vertexCount,pt.footprintTileId.canonical,ut.canonical,St),Ff(pt.footprint,St,this.footprintIndices.uint16,Lt.indexOffset,Lt.indexCount,-Lt.vertexOffset,-Tt)){wt.flags|=xx;break}}}for(const ut of this.centroidData)this.writeCentroidToBuffer(ut);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(ut,pt,wt){let Tt=!1;for(let St=0;St<wt.footprintSegLen;St++){const It=this.footprintSegments[wt.footprintSegIdx+St];let Lt=0;for(const wt of It.ringIndices){for(let St=Lt,Xt=wt+Lt-1;St<wt+Lt;Xt=St++){const wt=this.footprintVertices.int16[2*(St+It.vertexOffset)+0],Lt=this.footprintVertices.int16[2*(St+It.vertexOffset)+1],Yt=this.footprintVertices.int16[2*(Xt+It.vertexOffset)+1];Lt>pt!=Yt>pt&&ut<(this.footprintVertices.int16[2*(Xt+It.vertexOffset)+0]-wt)*(pt-Lt)/(Yt-Lt)+wt&&(Tt=!Tt)}Lt=wt}}return Tt}getHeightAtTileCoord(ut,pt){let wt=Number.NEGATIVE_INFINITY,Tt=!0;const St=4*(ut+xf)*xf+(pt+xf);if(this.partLookup.hasOwnProperty(St)){const ut=this.partLookup[St];return ut?{height:ut.height,hidden:!!(ut.flags&xx)}:void 0}for(const It of this.centroidData)ut>It.max.x||It.min.x>ut||pt>It.max.y||It.min.y>pt||this.footprintContainsPoint(ut,pt,It)&&It&&It.height>wt&&(wt=It.height,this.partLookup[St]=It,Tt=!!(It.flags&xx));if(wt!==Number.NEGATIVE_INFINITY)return{height:wt,hidden:Tt};this.partLookup[St]=void 0}}function bd(ut,pt){const wt=ut.add(pt)._unit();return ut.x*wt.x+ut.y*wt.y}function vd(ut,pt,wt,Tt){const St=pt.sub(ut)._perp()._unit(),It=wt.sub(pt)._perp()._unit();return _d(ut,pt,wt,bd(St,It),Tt)}function _d(ut,pt,wt,Tt,St){const It=Math.sqrt(1-Tt*Tt);return Math.min(ut.dist(pt)/3,pt.dist(wt)/3,St*It/Tt)}function wd(ut,pt,wt){return ut.x<wt[0].x&&pt.x<wt[0].x||ut.x>wt[1].x&&pt.x>wt[1].x||ut.y<wt[0].y&&pt.y<wt[0].y||ut.y>wt[1].y&&pt.y>wt[1].y}function Md(ut,pt){return ut.x<pt[0].x||ut.x>pt[1].x||ut.y<pt[0].y||ut.y>pt[1].y}function Ad(ut,pt,wt){if(ut.x<0||ut.x>=xf||pt.x<0||pt.x>=xf||wt.x<0||wt.x>=xf)return!1;const Tt=wt.sub(pt),St=Tt.perp(),It=ut.sub(pt);return(Tt.x*It.x+Tt.y*It.y)/Math.sqrt((Tt.x*Tt.x+Tt.y*Tt.y)*(It.x*It.x+It.y*It.y))>-.866&&St.x*It.x+St.y*It.y<0}function Sd(ut,pt,wt){const Tt=pt?2|ut:-3&ut;return wt?1|Tt:-2&Tt}function Id(){const ut=Math.PI/32,pt=Math.tan(ut),wt=G_;return wt*Math.sqrt(1+2*pt*pt)-wt}function Td(ut,pt,wt){const Tt=1<<wt.z,St=Pc(wt.x/Tt),It=Pc((wt.x+1)/Tt),Lt=Ec(wt.y/Tt),Xt=Ec((wt.y+1)/Tt);return function(ut,pt,wt,Tt,St=0,It){const Lt=[];if(!ut.length||!wt||!Tt)return Lt;const o=(ut,pt)=>{for(const wt of ut)Lt.push({polygon:wt,bounds:pt})},Xt=Math.ceil(Math.log2(wt)),Yt=Math.ceil(Math.log2(Tt)),Mi=Xt-Yt,vr=[];for(let ut=0;ut<Math.abs(Mi);ut++)vr.push(Mi>0?0:1);for(let ut=0;ut<Math.min(Xt,Yt);ut++)vr.push(0),vr.push(1);let br=ut;if(br=kf(br,pt[0].y-St,pt[1].y+St,1),br=kf(br,pt[0].x-St,pt[1].x+St,0),!br.length)return Lt;const Ar=[];for(vr.length?Ar.push({polygons:br,bounds:pt,depth:0}):o(br,pt);Ar.length;){const ut=Ar.pop(),pt=ut.depth,wt=vr[pt],Tt=ut.bounds[0],Lt=ut.bounds[1],Xt=0===wt?Tt.x:Tt.y,Yt=0===wt?Lt.x:Lt.y,Mi=It?It(wt,Xt,Yt):.5*(Xt+Yt),br=kf(ut.polygons,Xt-St,Mi+St,wt),Vr=kf(ut.polygons,Mi-St,Yt+St,wt);if(br.length){const ut=[Tt,new xc(0===wt?Mi:Lt.x,1===wt?Mi:Lt.y)];vr.length>pt+1?Ar.push({polygons:br,bounds:ut,depth:pt+1}):o(br,ut)}if(Vr.length){const ut=[new xc(0===wt?Mi:Tt.x,1===wt?Mi:Tt.y),Lt];vr.length>pt+1?Ar.push({polygons:Vr,bounds:ut,depth:pt+1}):o(Vr,ut)}}return Lt}(ut,pt,Math.ceil((It-St)/11.25),Math.ceil((Lt-Xt)/11.25),1,((ut,pt,St)=>{if(0===ut)return.5*(pt+St);{const ut=Ec((wt.y+pt/xf)/Tt);return(kc(.5*(Ec((wt.y+St/xf)/Tt)+ut))*Tt-wt.y)*xf}}))}function kd(ut,pt,wt,Tt,St,It){const Lt=Math.pow(2,Tt.z-St.z);for(let Xt=0;Xt<wt;Xt++){let wt=ut.int16[2*(Xt+pt)+0],Yt=ut.int16[2*(Xt+pt)+1];wt=(wt+St.x*xf)*Lt-Tt.x*xf,Yt=(Yt+St.y*xf)*Lt-Tt.y*xf,It.push(new xc(wt,Yt))}}Mo(xd,"FillExtrusionBucket",{omit:["layers","features"]}),Mo(pd,"PartData"),Mo(hd,"FootprintSegment"),Mo(fd,"BorderCentroidData"),Mo(gd,"GroundEffect");const bx=new ol({visibility:new il(x_["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new il(x_["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var wx={paint:new ol({"fill-extrusion-opacity":new il(x_["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new sl(x_["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new il(x_["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new il(x_["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new sl(x_["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new sl(x_["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new sl(x_["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new il(x_["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new il(x_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new il(x_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new il(x_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new il(x_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new il(x_["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new il(x_["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new il(x_["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new sl(x_["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new sl(x_["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new il(x_["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new il(x_["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new il(x_["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new il(x_["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new il(x_["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:bx};function Ed(ut,pt){return ut.x*pt.x+ut.y*pt.y}function Bd(ut,pt){if(1===ut.length){let wt=0;const Tt=pt[wt++];let St;for(;!St||Tt.equals(St);)if(St=pt[wt++],!St)return 1/0;for(;wt<pt.length;wt++){const It=pt[wt],Lt=ut[0],Xt=St.sub(Tt),Yt=It.sub(Tt),Mi=Lt.sub(Tt),vr=Ed(Xt,Xt),br=Ed(Xt,Yt),Ar=Ed(Yt,Yt),Vr=Ed(Mi,Xt),nn=Ed(Mi,Yt),sn=vr*Ar-br*br,an=(Ar*Vr-br*nn)/sn,ln=(vr*nn-br*Vr)/sn,cn=Tt.z*(1-an-ln)+St.z*an+It.z*ln;if(isFinite(cn))return cn}return 1/0}{let ut=1/0;for(const wt of pt)ut=Math.min(ut,wt.z);return ut}}function Dd(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=Lt*St.getElevationAt(ut,pt,!0,!0),Mi=0!==It[0],vr=Mi?0===It[1]?Lt*(It[0]/7-450):Lt*function(ut,pt,wt){const Tt=Math.floor(pt[0]/8),St=Math.floor(pt[1]/8),It=10*(pt[0]-8*Tt),Lt=10*(pt[1]-8*St),Xt=ut.getElevationAt(Tt,St,!0,!0),Yt=ut.getMeterToDEM(wt),Mi=Math.floor(.5*(It*Yt-1)),vr=Math.floor(.5*(Lt*Yt-1)),br=ut.tileCoordToPixel(Tt,St),Ar=2*Mi+1,Vr=2*vr+1,nn=function(ut,pt,wt,Tt,St){return[ut.getElevationAtPixel(pt,wt,!0),ut.getElevationAtPixel(pt+St,wt,!0),ut.getElevationAtPixel(pt,wt+St,!0),ut.getElevationAtPixel(pt+Tt,wt+St,!0)]}(ut,br.x-Mi,br.y-vr,Ar,Vr),sn=Math.abs(nn[0]-nn[1]),an=Math.abs(nn[2]-nn[3]),ln=Math.abs(nn[0]-nn[2])+Math.abs(nn[1]-nn[3]),cn=Math.min(.25,.5*Yt*(sn+an)/Ar),un=Math.min(.25,.5*Yt*ln/Vr);return Xt+Math.max(cn*It,un*Lt)}(St,It,Xt):Yt;return{base:Yt+(0===wt)?-1:wt,top:Mi?Math.max(vr+Tt,Yt+wt+2):Yt+Tt}}const Tx=Bl([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:Mx}=Tx,Ax=Bl([{name:"a_packed",components:4,type:"Float32"}]),{members:Ix}=Ax,zx=Bl([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Lx}=zx,Rx=Bl([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Dx=Bl([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),kx=Bl([{name:"a_projected_pos",components:4,type:"Float32"}],4);Bl([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Ox=Bl([{name:"a_occlusion_query_opacity",components:1,type:"Float32"}],4),Fx=Bl([{name:"a_z_offset",components:1,type:"Float32"}],4),Vx=Bl([{name:"a_texb",components:2,type:"Uint16"}]),Ux=Bl([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Kx=Bl([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Bl([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Jx=Bl([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Qx=Bl([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Bl([{name:"triangle",components:3,type:"Uint16"}]),Bl([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Bl([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Float32",name:"occlusionState"},{type:"Float32",name:"occlusionOpacity"},{type:"Uint8",name:"hasIconTextFit"}]),Bl([{type:"Float32",name:"offsetX"}]),Bl([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);class Kd{constructor(ut,pt){this.width=ut,this.height=pt,this.nextRow=0,this.image=new pp({width:ut,height:pt}),this.positions={},this.uploaded=!1}getDash(ut,pt){const wt=this.getKey(ut,pt);return this.positions[wt]}trim(){const ut=this.width,pt=this.height=sr(this.nextRow);this.image.resize({width:ut,height:pt})}getKey(ut,pt){return ut.join(",")+pt}getDashRanges(ut,pt,wt){const Tt=[];let St=ut.length%2==1?-ut[ut.length-1]*wt:0,It=ut[0]*wt,Lt=!0;Tt.push({left:St,right:It,isDash:Lt,zeroLength:0===ut[0]});let Xt=ut[0];for(let pt=1;pt<ut.length;pt++){Lt=!Lt;const Yt=ut[pt];St=Xt*wt,Xt+=Yt,It=Xt*wt,Tt.push({left:St,right:It,isDash:Lt,zeroLength:0===Yt})}return Tt}addRoundDash(ut,pt,wt){const Tt=pt/2;for(let pt=-wt;pt<=wt;pt++){const St=this.width*(this.nextRow+wt+pt);let It=0,Lt=ut[It];for(let Xt=0;Xt<this.width;Xt++){Xt/Lt.right>1&&(Lt=ut[++It]);const Yt=Math.abs(Xt-Lt.left),Mi=Math.abs(Xt-Lt.right),vr=Math.min(Yt,Mi);let br;const Ar=pt/wt*(Tt+1);if(Lt.isDash){const ut=Tt-Math.abs(Ar);br=Math.sqrt(vr*vr+ut*ut)}else br=Tt-Math.sqrt(vr*vr+Ar*Ar);this.image.data[St+Xt]=Math.max(0,Math.min(255,br+128))}}}addRegularDash(ut,pt){for(let pt=ut.length-1;pt>=0;--pt){const wt=ut[pt],Tt=ut[pt+1];wt.zeroLength?ut.splice(pt,1):Tt&&Tt.isDash===wt.isDash&&(Tt.left=wt.left,ut.splice(pt,1))}const wt=ut[0],Tt=ut[ut.length-1];wt.isDash===Tt.isDash&&(wt.left=Tt.left-this.width,Tt.right=wt.right+this.width);const St=this.width*this.nextRow;let It=0,Lt=ut[It];for(let wt=0;wt<this.width;wt++){wt/Lt.right>1&&(Lt=ut[++It]);const Tt=Math.abs(wt-Lt.left),Xt=Math.abs(wt-Lt.right),Yt=Math.min(Tt,Xt);this.image.data[St+wt]=Math.max(0,Math.min(255,(Lt.isDash?Yt:-Yt)+pt+128))}}addDash(ut,pt){const wt=this.getKey(ut,pt);if(this.positions[wt])return this.positions[wt];const Tt="round"===pt,St=Tt?7:0,It=2*St+1;if(this.nextRow+It>this.height)return fr("LineAtlas out of space"),null;0===ut.length&&ut.push(1);let Lt=0;for(let pt=0;pt<ut.length;pt++)ut[pt]<0&&(fr("Negative value is found in line dasharray, replacing values with 0"),ut[pt]=0),Lt+=ut[pt];if(0!==Lt){const wt=this.width/Lt,It=this.getDashRanges(ut,this.width,wt);Tt?this.addRoundDash(It,wt,St):this.addRegularDash(It,"square"===pt?.5*wt:0)}const Xt=this.nextRow+St;this.nextRow+=It;const Yt={tl:[Xt,St],br:[Lt,0]};return this.positions[wt]=Yt,Yt}}Mo(Kd,"LineAtlas");const iv=rx.types,rv=Math.cos(Math.PI/180*37.5),av=Math.cos(Math.PI/180*5);class tm{constructor(ut){this.zoom=ut.zoom,this.overscaling=ut.overscaling,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=ut.index,this.projection=ut.projection,this.hasPattern=!1,this.hasZOffset=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((ut=>{this.gradients[ut.id]={}})),this.layoutVertexArray=new Ll,this.layoutVertexArray2=new Ol,this.patternVertexArray=new Ul,this.indexArray=new Ql,this.programConfigurations=new Wu(ut.layers,{zoom:ut.zoom,lut:ut.lut}),this.segments=new Au,this.maxLineLength=0,this.zOffsetVertexArray=new Yl,this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.tessellationStep=ut.tessellationStep?ut.tessellationStep:xf/64}updateFootprints(ut,pt){}populate(ut,pt,wt,Tt){this.hasPattern=Hp("line",this.layers,pt);const St=this.layers[0].layout.get("line-sort-key"),It=this.layers[0].layout.get("line-z-offset");this.hasZOffset=!It.isConstant()||!!It.constantOr(0);const Lt=[];for(const{feature:pt,id:It,index:Xt,sourceLayerIndex:Yt}of ut){const ut=this.layers[0]._featureFilter.needGeometry,Mi=Yc(pt,ut);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Mi,wt))continue;const vr=St?St.evaluate(Mi,{},wt):void 0,br={id:It,properties:pt.properties,type:pt.type,sourceLayerIndex:Yt,index:Xt,geometry:ut?Mi.geometry:Xc(pt,wt,Tt),patterns:{},sortKey:vr};Lt.push(br)}St&&Lt.sort(((ut,pt)=>ut.sortKey-pt.sortKey));const{lineAtlas:Xt,featureIndex:Yt}=pt,Mi=this.addConstantDashes(Xt);for(const Tt of Lt){const{geometry:St,index:It,sourceLayerIndex:Lt}=Tt;if(Mi&&this.addFeatureDashes(Tt,Xt),this.hasPattern){const ut=Kp("line",this.layers,Tt,this.zoom,pt);this.patternFeatures.push(ut)}else this.addFeature(Tt,St,It,wt,Xt.positions,pt.availableImages,pt.brightness);Yt.insert(ut[It].feature,St,It,Lt,this.index)}}addConstantDashes(ut){let pt=!1;for(const wt of this.layers){const Tt=wt.paint.get("line-dasharray").value,St=wt.layout.get("line-cap").value;if("constant"!==Tt.kind||"constant"!==St.kind)pt=!0;else{const pt=St.value,wt=Tt.value;if(!wt)continue;ut.addDash(wt,pt)}}return pt}addFeatureDashes(ut,pt){const wt=this.zoom;for(const Tt of this.layers){const St=Tt.paint.get("line-dasharray").value,It=Tt.layout.get("line-cap").value;if("constant"===St.kind&&"constant"===It.kind)continue;let Lt,Xt;if("constant"===St.kind){if(Lt=St.value,!Lt)continue}else Lt=St.evaluate({zoom:wt},ut);Xt="constant"===It.kind?It.value:It.evaluate({zoom:wt},ut),pt.addDash(Lt,Xt),ut.patterns[Tt.id]=pt.getKey(Lt,Xt)}}update(ut,pt,wt,Tt,St){const It=0!==Object.keys(ut).length;It&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(ut,pt,It?this.stateDependentLayers:this.layers,wt,Tt,St)}addFeatures(ut,pt,wt,Tt,St,It){for(const ut of this.patternFeatures)this.addFeature(ut,ut.geometry,ut.index,pt,wt,Tt,It)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(ut){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=ut.createVertexBuffer(this.layoutVertexArray2,Ix)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=ut.createVertexBuffer(this.patternVertexArray,Lx)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=ut.createVertexBuffer(this.zOffsetVertexArray,Fx.members,!0)),this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,Mx),this.indexBuffer=ut.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(ut),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(ut){if(ut.properties&&ut.properties.hasOwnProperty("mapbox_clip_start")&&ut.properties.hasOwnProperty("mapbox_clip_end"))return{start:+ut.properties.mapbox_clip_start,end:+ut.properties.mapbox_clip_end}}addFeature(ut,pt,wt,Tt,St,It,Lt){const Xt=this.layers[0].layout,Yt=Xt.get("line-join").evaluate(ut,{}),Mi=Xt.get("line-cap").evaluate(ut,{}),vr=Xt.get("line-miter-limit"),br=Xt.get("line-round-limit");this.lineClips=this.lineFeatureClips(ut);for(const wt of pt)this.addLine(wt,ut,Tt,Yt,Mi,vr,br);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,ut,wt,St,It,Tt,Lt)}addLine(ut,pt,wt,Tt,St,It,Lt){this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.currentVertex=void 0;const Xt={zoom:this.zoom,lineProgress:void 0},Yt=this.layers[0].layout,Mi="none"===Tt;if(this.patternJoinNone=this.hasPattern&&Mi,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let pt=0;pt<ut.length-1;pt++)this.totalDistance+=ut[pt].dist(ut[pt+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const vr="Polygon"===iv[pt.type];let br=ut.length;for(;br>=2&&ut[br-1].equals(ut[br-2]);)br--;let Ar=0;for(;Ar<br-1&&ut[Ar].equals(ut[Ar+1]);)Ar++;if(br<(vr?3:2))return;"bevel"===Tt&&(It=1.05);const Vr=this.overscaling<=16?15*xf/(512*this.overscaling):0,nn=this.segments.prepareSegment(10*br,this.layoutVertexArray,this.indexArray);let sn,an,ln,cn,un,fn;this.e1=this.e2=-1,vr&&(sn=ut[br-2],un=ut[Ar].sub(sn)._unit()._perp());for(let wt=Ar;wt<br;wt++){if(ln=wt===br-1?vr?ut[Ar+1]:void 0:ut[wt+1],ln&&ut[wt].equals(ln))continue;if(un&&(cn=un),sn&&(an=sn),sn=ut[wt],this.hasZOffset){const ut=Yt.get("line-z-offset").value;if("constant"===ut.kind)fn=ut.value;else{if(this.lineClips){const ut=this.totalDistance/(this.lineClips.end-this.lineClips.start);Xt.lineProgress=(ut*this.lineClips.start+this.distance+(an?an.dist(sn):0))/ut}else fr(`line-z-offset evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`),Xt.lineProgress=0;fn=ut.evaluate(Xt,pt)}fn=fn||0}un=ln?ln.sub(sn)._unit()._perp():cn,cn=cn||un;const _n=an&&ln;let gn=_n?Tt:vr||Mi?"butt":St;const yn=cn.x*un.x+cn.y*un.y;if(Mi){const t=function(ut){if(ut.patternJoinNone){const pt=ut.segmentPoints.length/2,wt=ut.lineSoFar-ut.segmentStart;for(let Tt=0;Tt<pt;++Tt){const pt=ut.segmentPoints[2*Tt+1],St=Math.round(ut.segmentPoints[2*Tt])+.5+.25*pt;ut.patternVertexArray.emplaceBack(St,wt,ut.segmentStart),ut.patternVertexArray.emplaceBack(St,wt,ut.segmentStart)}ut.segmentPoints.length=0}ut.e1=ut.e2=-1};if(_n&&yn<av){this.updateDistance(an,sn),this.addCurrentVertex(sn,cn,1,1,nn,fn),t(this),this.addCurrentVertex(sn,un,-1,-1,nn,fn);continue}if(an){if(!ln){this.updateDistance(an,sn),this.addCurrentVertex(sn,cn,1,1,nn,fn),t(this);continue}gn="miter"}}let xn=cn.add(un);0===xn.x&&0===xn.y||xn._unit();const vn=xn.x*un.x+xn.y*un.y,bn=0!==vn?1/vn:1/0,wn=2*Math.sqrt(2-2*vn),Tn=vn<rv&&an&&ln,En=cn.x*un.y-cn.y*un.x>0;if(Tn&&wt>Ar){const ut=sn.dist(an);if(ut>2*Vr){const pt=sn.sub(sn.sub(an)._mult(Vr/ut)._round());this.updateDistance(an,pt),this.addCurrentVertex(pt,cn,0,0,nn,fn),an=pt}}if(_n&&"round"===gn&&(bn<Lt?gn="miter":bn<=2&&(gn="fakeround")),"miter"===gn&&bn>It&&(gn="bevel"),"bevel"===gn&&(bn>2&&(gn="flipbevel"),bn<It&&(gn="miter")),an&&this.updateDistance(an,sn),"miter"===gn)xn._mult(bn),this.addCurrentVertex(sn,xn,0,0,nn,fn);else if("flipbevel"===gn){if(bn>100)xn=un.mult(-1);else{const ut=bn*cn.add(un).mag()/cn.sub(un).mag();xn._perp()._mult(ut*(En?-1:1))}this.addCurrentVertex(sn,xn,0,0,nn,fn),this.addCurrentVertex(sn,xn.mult(-1),0,0,nn,fn)}else if("bevel"===gn||"fakeround"===gn){const ut=-Math.sqrt(bn*bn-1),pt=En?ut:0,wt=En?0:ut;if(an&&this.addCurrentVertex(sn,cn,pt,wt,nn,fn),"fakeround"===gn){const ut=Math.round(180*wn/Math.PI/20);for(let pt=1;pt<ut;pt++){let wt=pt/ut;if(.5!==wt){const ut=wt-.5;wt+=wt*ut*(wt-1)*((1.0904+yn*(yn*(3.55645-1.43519*yn)-3.2452))*ut*ut+(.848013+yn*(.215638*yn-1.06021)))}const Tt=un.sub(cn)._mult(wt)._add(cn)._unit()._mult(En?-1:1);this.addHalfVertex(sn,Tt.x,Tt.y,!1,En,0,nn,fn)}}ln&&this.addCurrentVertex(sn,un,-pt,-wt,nn,fn)}else"butt"===gn?this.addCurrentVertex(sn,xn,0,0,nn,fn):"square"===gn?(an||this.addCurrentVertex(sn,xn,-1,-1,nn,fn),this.addCurrentVertex(sn,xn,0,0,nn,fn),an&&this.addCurrentVertex(sn,xn,1,1,nn,fn)):"round"===gn&&(an&&(this.addCurrentVertex(sn,cn,0,0,nn,fn),this.addCurrentVertex(sn,cn,1,1,nn,fn,!0)),ln&&(this.addCurrentVertex(sn,un,-1,-1,nn,fn,!0),this.addCurrentVertex(sn,un,0,0,nn,fn)));if(Tn&&wt<br-1){const ut=sn.dist(ln);if(ut>2*Vr){const pt=sn.add(ln.sub(sn)._mult(Vr/ut)._round());this.updateDistance(sn,pt),this.addCurrentVertex(pt,un,0,0,nn,fn),sn=pt}}}}addVerticesTo(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){const vr=(pt.w-ut.w)/this.tessellationStep|0;if(vr>1){this.lineSoFar=ut.w;const br=(pt.x-ut.x)/vr,Ar=(pt.y-ut.y)/vr,Vr=(pt.z-ut.z)/vr,nn=(pt.w-ut.w)/vr;for(let pt=1;pt<vr;++pt)ut.x+=br,ut.y+=Ar,ut.z+=Vr,this.lineSoFar+=nn,this.addHalfVertex(ut,wt,Tt,Mi,!1,Lt,Yt,ut.z),this.addHalfVertex(ut,St,It,Mi,!0,-Xt,Yt,ut.z)}this.lineSoFar=pt.w,this.addHalfVertex(pt,wt,Tt,Mi,!1,Lt,Yt,pt.z),this.addHalfVertex(pt,St,It,Mi,!0,-Xt,Yt,pt.z)}addCurrentVertex(ut,pt,wt,Tt,St,It,Lt=!1){const Xt=pt.x+pt.y*wt,Yt=pt.y-pt.x*wt,Mi=pt.y*Tt-pt.x,vr=-pt.y-pt.x*Tt;if(null!=It){const pt=-10,br=xf+10,Ar=It,Vr=new Tf(ut.x,ut.y,Ar,this.lineSoFar),nn=em(ut,pt,br),sn=this.lineSoFar;if(this.currentVertex)if(nn){const It=this.currentVertexIsOutside,Vr=this.currentVertex,nn=new Tf(ut.x,ut.y,Ar,this.lineSoFar);Pf(Vr,nn,pt,br),em(nn,pt,br)||(It&&(this.e1=this.e2=-1,this.lineSoFar=Vr.w,this.addHalfVertex(Vr,Xt,Yt,Lt,!1,wt,St,Vr.z),this.addHalfVertex(Vr,Mi,vr,Lt,!0,-Tt,St,Vr.z)),this.addVerticesTo(Vr,nn,Xt,Yt,Mi,vr,wt,Tt,St,Lt))}else{const ut=this.currentVertex;this.currentVertexIsOutside&&(Pf(ut,Vr,pt,br),this.e1=this.e2=-1,this.lineSoFar=ut.w,this.addHalfVertex(ut,Xt,Yt,Lt,!1,wt,St,ut.z),this.addHalfVertex(ut,Mi,vr,Lt,!0,-Tt,St,ut.z)),this.addVerticesTo(ut,Vr,Xt,Yt,Mi,vr,wt,Tt,St,Lt)}else nn||(this.addHalfVertex(ut,Xt,Yt,Lt,!1,wt,St,It),this.addHalfVertex(ut,Mi,vr,Lt,!0,-Tt,St,It));this.currentVertex=Vr,this.currentVertexIsOutside=nn,this.lineSoFar=sn}else this.addHalfVertex(ut,Xt,Yt,Lt,!1,wt,St,It),this.addHalfVertex(ut,Mi,vr,Lt,!0,-Tt,St,It)}addHalfVertex({x:ut,y:pt},wt,Tt,St,It,Lt,Xt,Yt){this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),It||this.segmentPoints.push(this.lineSoFar-this.segmentStart,Lt)),this.layoutVertexArray.emplaceBack((ut<<1)+(St?1:0),(pt<<1)+(It?1:0),Math.round(63*wt)+128,Math.round(63*Tt)+128,1+(0===Lt?0:Lt<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const Mi=Xt.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,Mi),Xt.primitiveLength++),It?this.e2=Mi:this.e1=Mi,null!=Yt&&this.zOffsetVertexArray.emplaceBack(Yt)}updateScaledDistance(){if(this.lineClips){const ut=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=ut*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(ut,pt){this.distance+=ut.dist(pt),this.updateScaledDistance()}}function em(ut,pt,wt){return ut.x<pt||ut.x>wt||ut.y<pt||ut.y>wt}Mo(tm,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const lv=new ol({"line-cap":new sl(x_.layout_line["line-cap"]),"line-join":new sl(x_.layout_line["line-join"]),"line-miter-limit":new il(x_.layout_line["line-miter-limit"]),"line-round-limit":new il(x_.layout_line["line-round-limit"]),"line-sort-key":new sl(x_.layout_line["line-sort-key"]),"line-z-offset":new sl(x_.layout_line["line-z-offset"]),visibility:new il(x_.layout_line.visibility)});var cv={paint:new ol({"line-opacity":new sl(x_.paint_line["line-opacity"]),"line-color":new sl(x_.paint_line["line-color"]),"line-translate":new il(x_.paint_line["line-translate"]),"line-translate-anchor":new il(x_.paint_line["line-translate-anchor"]),"line-width":new sl(x_.paint_line["line-width"]),"line-gap-width":new sl(x_.paint_line["line-gap-width"]),"line-offset":new sl(x_.paint_line["line-offset"]),"line-blur":new sl(x_.paint_line["line-blur"]),"line-dasharray":new sl(x_.paint_line["line-dasharray"]),"line-pattern":new sl(x_.paint_line["line-pattern"]),"line-gradient":new al(x_.paint_line["line-gradient"]),"line-trim-offset":new il(x_.paint_line["line-trim-offset"]),"line-trim-fade-range":new il(x_.paint_line["line-trim-fade-range"]),"line-trim-color":new il(x_.paint_line["line-trim-color"]),"line-emissive-strength":new il(x_.paint_line["line-emissive-strength"]),"line-border-width":new sl(x_.paint_line["line-border-width"]),"line-border-color":new sl(x_.paint_line["line-border-color"]),"line-occlusion-opacity":new il(x_.paint_line["line-occlusion-opacity"])}),layout:lv};function im(ut,pt,wt){return pt*(xf/(ut.tileSize*Math.pow(2,wt-ut.tileID.overscaledZ)))}function sm(ut,pt){return 1/im(ut,1,pt.tileZoom)}function am(ut,pt,wt,Tt){return ut.translatePosMatrix(Tt||pt.tileID.projMatrix,pt,wt.paint.get("line-translate"),wt.paint.get("line-translate-anchor"))}const om=ut=>{const pt=[];lm(ut)&&pt.push("RENDER_LINE_DASH"),ut.paint.get("line-gradient")&&pt.push("RENDER_LINE_GRADIENT");const wt=ut.paint.get("line-trim-offset");0===wt[0]&&0===wt[1]||pt.push("RENDER_LINE_TRIM_OFFSET"),0!==ut.paint.get("line-border-width").constantOr(1)&&pt.push("RENDER_LINE_BORDER");const Tt="none"===ut.layout.get("line-join").constantOr("miter"),St=!!ut.paint.get("line-pattern").constantOr(1);return Tt&&St&&pt.push("LINE_JOIN_NONE"),pt};function lm(ut){const pt=ut.paint.get("line-dasharray").value;return pt.value||"constant"!==pt.kind}class um{constructor(ut){this._stringToNumber={},this._numberToString=[];for(let pt=0;pt<ut.length;pt++){const wt=ut[pt];this._stringToNumber[wt]=pt,this._numberToString[pt]=wt}}encode(ut){return this._stringToNumber[ut]}decode(ut){return this._numberToString[ut]}}var uv={read:function(ut,pt,wt,Tt,St){var It,Lt,Xt=8*St-Tt-1,Yt=(1<<Xt)-1,Mi=Yt>>1,vr=-7,br=wt?St-1:0,Ar=wt?-1:1,Vr=ut[pt+br];for(br+=Ar,It=Vr&(1<<-vr)-1,Vr>>=-vr,vr+=Xt;vr>0;It=256*It+ut[pt+br],br+=Ar,vr-=8);for(Lt=It&(1<<-vr)-1,It>>=-vr,vr+=Tt;vr>0;Lt=256*Lt+ut[pt+br],br+=Ar,vr-=8);if(0===It)It=1-Mi;else{if(It===Yt)return Lt?NaN:1/0*(Vr?-1:1);Lt+=Math.pow(2,Tt),It-=Mi}return(Vr?-1:1)*Lt*Math.pow(2,It-Tt)},write:function(ut,pt,wt,Tt,St,It){var Lt,Xt,Yt,Mi=8*It-St-1,vr=(1<<Mi)-1,br=vr>>1,Ar=23===St?Math.pow(2,-24)-Math.pow(2,-77):0,Vr=Tt?0:It-1,nn=Tt?1:-1,sn=pt<0||0===pt&&1/pt<0?1:0;for(pt=Math.abs(pt),isNaN(pt)||pt===1/0?(Xt=isNaN(pt)?1:0,Lt=vr):(Lt=Math.floor(Math.log(pt)/Math.LN2),pt*(Yt=Math.pow(2,-Lt))<1&&(Lt--,Yt*=2),(pt+=Lt+br>=1?Ar/Yt:Ar*Math.pow(2,1-br))*Yt>=2&&(Lt++,Yt/=2),Lt+br>=vr?(Xt=0,Lt=vr):Lt+br>=1?(Xt=(pt*Yt-1)*Math.pow(2,St),Lt+=br):(Xt=pt*Math.pow(2,br-1)*Math.pow(2,St),Lt=0));St>=8;ut[wt+Vr]=255&Xt,Vr+=nn,Xt/=256,St-=8);for(Lt=Lt<<St|Xt,Mi+=St;Mi>0;ut[wt+Vr]=255&Lt,Vr+=nn,Lt/=256,Mi-=8);ut[wt+Vr-nn]|=128*sn}},hv=fm,pv=uv;function fm(ut){(this||pt).buf=ArrayBuffer.isView&&ArrayBuffer.isView(ut)?ut:new Uint8Array(ut||0),(this||pt).pos=0,(this||pt).type=0,(this||pt).length=(this||pt).buf.length}fm.Varint=0,fm.Fixed64=1,fm.Bytes=2,fm.Fixed32=5;var fv=4294967296,gv=1/fv,yv="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function gm(ut){return ut.type===fm.Bytes?ut.readVarint()+ut.pos:ut.pos+1}function xm(ut,pt,wt){return wt?4294967296*pt+(ut>>>0):4294967296*(pt>>>0)+(ut>>>0)}function bm(ut,pt,wt){var Tt=pt<=16383?1:pt<=2097151?2:pt<=268435455?3:Math.floor(Math.log(pt)/(7*Math.LN2));wt.realloc(Tt);for(var St=wt.pos-1;St>=ut;St--)wt.buf[St+Tt]=wt.buf[St]}function vm(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeVarint(ut[wt])}function _m(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeSVarint(ut[wt])}function wm(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeFloat(ut[wt])}function Mm(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeDouble(ut[wt])}function Am(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeBoolean(ut[wt])}function Sm(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeFixed32(ut[wt])}function Im(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeSFixed32(ut[wt])}function Tm(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeFixed64(ut[wt])}function km(ut,pt){for(var wt=0;wt<ut.length;wt++)pt.writeSFixed64(ut[wt])}function zm(ut,pt){return(ut[pt]|ut[pt+1]<<8|ut[pt+2]<<16)+16777216*ut[pt+3]}function Pm(ut,pt,wt){ut[wt]=pt,ut[wt+1]=pt>>>8,ut[wt+2]=pt>>>16,ut[wt+3]=pt>>>24}function Em(ut,pt){return(ut[pt]|ut[pt+1]<<8|ut[pt+2]<<16)+(ut[pt+3]<<24)}fm.prototype={destroy:function(){(this||pt).buf=null},readFields:function(ut,wt,Tt){for(Tt=Tt||(this||pt).length;(this||pt).pos<Tt;){var St=this.readVarint(),It=St>>3,Lt=(this||pt).pos;(this||pt).type=7&St,ut(It,wt,this||pt),(this||pt).pos===Lt&&this.skip(St)}return wt},readMessage:function(ut,wt){return this.readFields(ut,wt,this.readVarint()+(this||pt).pos)},readFixed32:function(){var ut=zm((this||pt).buf,(this||pt).pos);return(this||pt).pos+=4,ut},readSFixed32:function(){var ut=Em((this||pt).buf,(this||pt).pos);return(this||pt).pos+=4,ut},readFixed64:function(){var ut=zm((this||pt).buf,(this||pt).pos)+zm((this||pt).buf,(this||pt).pos+4)*fv;return(this||pt).pos+=8,ut},readSFixed64:function(){var ut=zm((this||pt).buf,(this||pt).pos)+Em((this||pt).buf,(this||pt).pos+4)*fv;return(this||pt).pos+=8,ut},readFloat:function(){var ut=pv.read((this||pt).buf,(this||pt).pos,!0,23,4);return(this||pt).pos+=4,ut},readDouble:function(){var ut=pv.read((this||pt).buf,(this||pt).pos,!0,52,8);return(this||pt).pos+=8,ut},readVarint:function(ut){var wt,Tt,St=(this||pt).buf;return wt=127&(Tt=St[(this||pt).pos++]),Tt<128?wt:(wt|=(127&(Tt=St[(this||pt).pos++]))<<7,Tt<128?wt:(wt|=(127&(Tt=St[(this||pt).pos++]))<<14,Tt<128?wt:(wt|=(127&(Tt=St[(this||pt).pos++]))<<21,Tt<128?wt:function(ut,pt,wt){var Tt,St,It=wt.buf;if(Tt=(112&(St=It[wt.pos++]))>>4,St<128)return xm(ut,Tt,pt);if(Tt|=(127&(St=It[wt.pos++]))<<3,St<128)return xm(ut,Tt,pt);if(Tt|=(127&(St=It[wt.pos++]))<<10,St<128)return xm(ut,Tt,pt);if(Tt|=(127&(St=It[wt.pos++]))<<17,St<128)return xm(ut,Tt,pt);if(Tt|=(127&(St=It[wt.pos++]))<<24,St<128)return xm(ut,Tt,pt);if(Tt|=(1&(St=It[wt.pos++]))<<31,St<128)return xm(ut,Tt,pt);throw new Error("Expected varint not more than 10 bytes")}(wt|=(15&(Tt=St[(this||pt).pos]))<<28,ut,this||pt))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var ut=this.readVarint();return ut%2==1?(ut+1)/-2:ut/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var ut=this.readVarint()+(this||pt).pos,wt=(this||pt).pos;return(this||pt).pos=ut,ut-wt>=12&&yv?function(ut,pt,wt){return yv.decode(ut.subarray(pt,wt))}((this||pt).buf,wt,ut):function(ut,pt,wt){for(var Tt="",St=pt;St<wt;){var It,Lt,Xt,Yt=ut[St],Mi=null,vr=Yt>239?4:Yt>223?3:Yt>191?2:1;if(St+vr>wt)break;1===vr?Yt<128&&(Mi=Yt):2===vr?128==(192&(It=ut[St+1]))&&(Mi=(31&Yt)<<6|63&It)<=127&&(Mi=null):3===vr?(Lt=ut[St+2],128==(192&(It=ut[St+1]))&&128==(192&Lt)&&((Mi=(15&Yt)<<12|(63&It)<<6|63&Lt)<=2047||Mi>=55296&&Mi<=57343)&&(Mi=null)):4===vr&&(Lt=ut[St+2],Xt=ut[St+3],128==(192&(It=ut[St+1]))&&128==(192&Lt)&&128==(192&Xt)&&((Mi=(15&Yt)<<18|(63&It)<<12|(63&Lt)<<6|63&Xt)<=65535||Mi>=1114112)&&(Mi=null)),null===Mi?(Mi=65533,vr=1):Mi>65535&&(Mi-=65536,Tt+=String.fromCharCode(Mi>>>10&1023|55296),Mi=56320|1023&Mi),Tt+=String.fromCharCode(Mi),St+=vr}return Tt}((this||pt).buf,wt,ut)},readBytes:function(){var ut=this.readVarint()+(this||pt).pos,wt=(this||pt).buf.subarray((this||pt).pos,ut);return(this||pt).pos=ut,wt},readPackedVarint:function(ut,wt){if((this||pt).type!==fm.Bytes)return ut.push(this.readVarint(wt));var Tt=gm(this||pt);for(ut=ut||[];(this||pt).pos<Tt;)ut.push(this.readVarint(wt));return ut},readPackedSVarint:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readSVarint());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readSVarint());return ut},readPackedBoolean:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readBoolean());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readBoolean());return ut},readPackedFloat:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readFloat());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readFloat());return ut},readPackedDouble:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readDouble());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readDouble());return ut},readPackedFixed32:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readFixed32());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readFixed32());return ut},readPackedSFixed32:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readSFixed32());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readSFixed32());return ut},readPackedFixed64:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readFixed64());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readFixed64());return ut},readPackedSFixed64:function(ut){if((this||pt).type!==fm.Bytes)return ut.push(this.readSFixed64());var wt=gm(this||pt);for(ut=ut||[];(this||pt).pos<wt;)ut.push(this.readSFixed64());return ut},skip:function(ut){var wt=7&ut;if(wt===fm.Varint)for(;(this||pt).buf[(this||pt).pos++]>127;);else if(wt===fm.Bytes)(this||pt).pos=this.readVarint()+(this||pt).pos;else if(wt===fm.Fixed32)(this||pt).pos+=4;else{if(wt!==fm.Fixed64)throw new Error("Unimplemented type: "+wt);(this||pt).pos+=8}},writeTag:function(ut,pt){this.writeVarint(ut<<3|pt)},realloc:function(ut){for(var wt=(this||pt).length||16;wt<(this||pt).pos+ut;)wt*=2;if(wt!==(this||pt).length){var Tt=new Uint8Array(wt);Tt.set((this||pt).buf),(this||pt).buf=Tt,(this||pt).length=wt}},finish:function(){return(this||pt).length=(this||pt).pos,(this||pt).pos=0,(this||pt).buf.subarray(0,(this||pt).length)},writeFixed32:function(ut){this.realloc(4),Pm((this||pt).buf,ut,(this||pt).pos),(this||pt).pos+=4},writeSFixed32:function(ut){this.realloc(4),Pm((this||pt).buf,ut,(this||pt).pos),(this||pt).pos+=4},writeFixed64:function(ut){this.realloc(8),Pm((this||pt).buf,-1&ut,(this||pt).pos),Pm((this||pt).buf,Math.floor(ut*gv),(this||pt).pos+4),(this||pt).pos+=8},writeSFixed64:function(ut){this.realloc(8),Pm((this||pt).buf,-1&ut,(this||pt).pos),Pm((this||pt).buf,Math.floor(ut*gv),(this||pt).pos+4),(this||pt).pos+=8},writeVarint:function(ut){(ut=+ut||0)>268435455||ut<0?function(ut,pt){var wt,Tt;if(ut>=0?(wt=ut%4294967296|0,Tt=ut/4294967296|0):(Tt=~(-ut/4294967296),4294967295^(wt=~(-ut%4294967296))?wt=wt+1|0:(wt=0,Tt=Tt+1|0)),ut>=0x10000000000000000||ut<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");pt.realloc(10),function(ut,pt,wt){wt.buf[wt.pos++]=127&ut|128,ut>>>=7,wt.buf[wt.pos++]=127&ut|128,ut>>>=7,wt.buf[wt.pos++]=127&ut|128,ut>>>=7,wt.buf[wt.pos++]=127&ut|128,wt.buf[wt.pos]=127&(ut>>>=7)}(wt,0,pt),function(ut,pt){var wt=(7&ut)<<4;pt.buf[pt.pos++]|=wt|((ut>>>=3)?128:0),ut&&(pt.buf[pt.pos++]=127&ut|((ut>>>=7)?128:0),ut&&(pt.buf[pt.pos++]=127&ut|((ut>>>=7)?128:0),ut&&(pt.buf[pt.pos++]=127&ut|((ut>>>=7)?128:0),ut&&(pt.buf[pt.pos++]=127&ut|((ut>>>=7)?128:0),ut&&(pt.buf[pt.pos++]=127&ut)))))}(Tt,pt)}(ut,this||pt):(this.realloc(4),(this||pt).buf[(this||pt).pos++]=127&ut|(ut>127?128:0),ut<=127||((this||pt).buf[(this||pt).pos++]=127&(ut>>>=7)|(ut>127?128:0),ut<=127||((this||pt).buf[(this||pt).pos++]=127&(ut>>>=7)|(ut>127?128:0),ut<=127||((this||pt).buf[(this||pt).pos++]=ut>>>7&127))))},writeSVarint:function(ut){this.writeVarint(ut<0?2*-ut-1:2*ut)},writeBoolean:function(ut){this.writeVarint(Boolean(ut))},writeString:function(ut){ut=String(ut),this.realloc(4*ut.length),(this||pt).pos++;var wt=(this||pt).pos;(this||pt).pos=function(ut,pt,wt){for(var Tt,St,It=0;It<pt.length;It++){if((Tt=pt.charCodeAt(It))>55295&&Tt<57344){if(!St){Tt>56319||It+1===pt.length?(ut[wt++]=239,ut[wt++]=191,ut[wt++]=189):St=Tt;continue}if(Tt<56320){ut[wt++]=239,ut[wt++]=191,ut[wt++]=189,St=Tt;continue}Tt=St-55296<<10|Tt-56320|65536,St=null}else St&&(ut[wt++]=239,ut[wt++]=191,ut[wt++]=189,St=null);Tt<128?ut[wt++]=Tt:(Tt<2048?ut[wt++]=Tt>>6|192:(Tt<65536?ut[wt++]=Tt>>12|224:(ut[wt++]=Tt>>18|240,ut[wt++]=Tt>>12&63|128),ut[wt++]=Tt>>6&63|128),ut[wt++]=63&Tt|128)}return wt}((this||pt).buf,ut,(this||pt).pos);var Tt=(this||pt).pos-wt;Tt>=128&&bm(wt,Tt,this||pt),(this||pt).pos=wt-1,this.writeVarint(Tt),(this||pt).pos+=Tt},writeFloat:function(ut){this.realloc(4),pv.write((this||pt).buf,ut,(this||pt).pos,!0,23,4),(this||pt).pos+=4},writeDouble:function(ut){this.realloc(8),pv.write((this||pt).buf,ut,(this||pt).pos,!0,52,8),(this||pt).pos+=8},writeBytes:function(ut){var wt=ut.length;this.writeVarint(wt),this.realloc(wt);for(var Tt=0;Tt<wt;Tt++)(this||pt).buf[(this||pt).pos++]=ut[Tt]},writeRawMessage:function(ut,wt){(this||pt).pos++;var Tt=(this||pt).pos;ut(wt,this||pt);var St=(this||pt).pos-Tt;St>=128&&bm(Tt,St,this||pt),(this||pt).pos=Tt-1,this.writeVarint(St),(this||pt).pos+=St},writeMessage:function(ut,pt,wt){this.writeTag(ut,fm.Bytes),this.writeRawMessage(pt,wt)},writePackedVarint:function(ut,pt){pt.length&&this.writeMessage(ut,vm,pt)},writePackedSVarint:function(ut,pt){pt.length&&this.writeMessage(ut,_m,pt)},writePackedBoolean:function(ut,pt){pt.length&&this.writeMessage(ut,Am,pt)},writePackedFloat:function(ut,pt){pt.length&&this.writeMessage(ut,wm,pt)},writePackedDouble:function(ut,pt){pt.length&&this.writeMessage(ut,Mm,pt)},writePackedFixed32:function(ut,pt){pt.length&&this.writeMessage(ut,Sm,pt)},writePackedSFixed32:function(ut,pt){pt.length&&this.writeMessage(ut,Im,pt)},writePackedFixed64:function(ut,pt){pt.length&&this.writeMessage(ut,Tm,pt)},writePackedSFixed64:function(ut,pt){pt.length&&this.writeMessage(ut,km,pt)},writeBytesField:function(ut,pt){this.writeTag(ut,fm.Bytes),this.writeBytes(pt)},writeFixed32Field:function(ut,pt){this.writeTag(ut,fm.Fixed32),this.writeFixed32(pt)},writeSFixed32Field:function(ut,pt){this.writeTag(ut,fm.Fixed32),this.writeSFixed32(pt)},writeFixed64Field:function(ut,pt){this.writeTag(ut,fm.Fixed64),this.writeFixed64(pt)},writeSFixed64Field:function(ut,pt){this.writeTag(ut,fm.Fixed64),this.writeSFixed64(pt)},writeVarintField:function(ut,pt){this.writeTag(ut,fm.Varint),this.writeVarint(pt)},writeSVarintField:function(ut,pt){this.writeTag(ut,fm.Varint),this.writeSVarint(pt)},writeStringField:function(ut,pt){this.writeTag(ut,fm.Bytes),this.writeString(pt)},writeFloatField:function(ut,pt){this.writeTag(ut,fm.Fixed32),this.writeFloat(pt)},writeDoubleField:function(ut,pt){this.writeTag(ut,fm.Fixed64),this.writeDouble(pt)},writeBooleanField:function(ut,pt){this.writeVarintField(ut,Boolean(pt))}};var xv=p(hv);const vv=["id","tile","layer","source","sourceLayer","state"];class Cm{constructor(ut,pt,wt,Tt,St){this.type="Feature",this._vectorTileFeature=ut,this._z=pt,this._x=wt,this._y=Tt,this.properties=ut.properties,this.id=St}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(ut){this._geometry=ut}toJSON(){const ut={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const pt of vv)void 0!==this[pt]&&(ut[pt]=this[pt]);return ut}}class Rm{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(ut,pt,wt){const Tt=String(pt);if(this.stateChanges[ut]=this.stateChanges[ut]||{},this.stateChanges[ut][Tt]=this.stateChanges[ut][Tt]||{},er(this.stateChanges[ut][Tt],wt),null===this.deletedStates[ut]){this.deletedStates[ut]={};for(const pt in this.state[ut])pt!==Tt&&(this.deletedStates[ut][pt]=null)}else if(this.deletedStates[ut]&&null===this.deletedStates[ut][Tt]){this.deletedStates[ut][Tt]={};for(const pt in this.state[ut][Tt])wt[pt]||(this.deletedStates[ut][Tt][pt]=null)}else for(const pt in wt)this.deletedStates[ut]&&this.deletedStates[ut][Tt]&&null===this.deletedStates[ut][Tt][pt]&&delete this.deletedStates[ut][Tt][pt]}removeFeatureState(ut,pt,wt){if(null===this.deletedStates[ut])return;const Tt=String(pt);if(this.deletedStates[ut]=this.deletedStates[ut]||{},wt&&void 0!==pt)null!==this.deletedStates[ut][Tt]&&(this.deletedStates[ut][Tt]=this.deletedStates[ut][Tt]||{},this.deletedStates[ut][Tt][wt]=null);else if(void 0!==pt)if(this.stateChanges[ut]&&this.stateChanges[ut][Tt])for(wt in this.deletedStates[ut][Tt]={},this.stateChanges[ut][Tt])this.deletedStates[ut][Tt][wt]=null;else this.deletedStates[ut][Tt]=null;else this.deletedStates[ut]=null}getState(ut,pt){const wt=String(pt),Tt=er({},(this.state[ut]||{})[wt],(this.stateChanges[ut]||{})[wt]);if(null===this.deletedStates[ut])return{};if(this.deletedStates[ut]){const wt=this.deletedStates[ut][pt];if(null===wt)return{};for(const ut in wt)delete Tt[ut]}return Tt}initializeTileState(ut,pt){ut.setFeatureState(this.state,pt)}coalesceChanges(ut,pt){const wt={};for(const ut in this.stateChanges){this.state[ut]=this.state[ut]||{};const pt={};for(const wt in this.stateChanges[ut])this.state[ut][wt]||(this.state[ut][wt]={}),er(this.state[ut][wt],this.stateChanges[ut][wt]),pt[wt]=this.state[ut][wt];wt[ut]=pt}for(const ut in this.deletedStates){this.state[ut]=this.state[ut]||{};const pt={};if(null===this.deletedStates[ut])for(const wt in this.state[ut])pt[wt]={},this.state[ut][wt]={};else for(const wt in this.deletedStates[ut]){if(null===this.deletedStates[ut][wt])this.state[ut][wt]={};else if(this.state[ut][wt])for(const pt of Object.keys(this.deletedStates[ut][wt]))delete this.state[ut][wt][pt];pt[wt]=this.state[ut][wt]}wt[ut]=wt[ut]||{},er(wt[ut],pt)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(wt).length)for(const Tt in ut)ut[Tt].setFeatureState(wt,pt)}}class Vm{constructor(ut,pt){this.tileID=ut,this.x=ut.canonical.x,this.y=ut.canonical.y,this.z=ut.canonical.z,this.grid=new l_(xf,16,0),this.featureIndexArray=new vu,this.promoteId=pt,this.is3DTile=!1}insert(ut,pt,wt,Tt,St,It=0,Lt=0){const Xt=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(wt,Tt,St,It);const Yt=this.grid;for(let ut=0;ut<pt.length;ut++){const wt=pt[ut],Tt=[1/0,1/0,-1/0,-1/0];for(let ut=0;ut<wt.length;ut++){const pt=wt[ut];Tt[0]=Math.min(Tt[0],pt.x),Tt[1]=Math.min(Tt[1],pt.y),Tt[2]=Math.max(Tt[2],pt.x),Tt[3]=Math.max(Tt[3],pt.y)}0!==Lt&&(Tt[0]-=Lt,Tt[1]-=Lt,Tt[2]+=Lt,Tt[3]+=Lt),Tt[0]<xf&&Tt[1]<xf&&Tt[2]>=0&&Tt[3]>=0&&Yt.insert(Xt,Tt[0],Tt[1],Tt[2],Tt[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new ix(new xv(this.rawTileData)).layers,this.sourceLayerCoder=new um(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const ut in this.vtLayers)this.vtFeatures[ut]=[]}return this.vtLayers}query(ut,pt,wt,Tt){this.loadVTLayers();const St=ut.params||{},It=pl(St.filter),Lt=ut.tileResult,Xt=ut.transform,Yt=Lt.bufferedTilespaceBounds,Mi=this.grid.query(Yt.min.x,Yt.min.y,Yt.max.x,Yt.max.y,((ut,pt,wt,Tt)=>oh(Lt.bufferedTilespaceGeometry,ut,pt,wt,Tt)));Mi.sort(Lm);let vr=null;Xt.elevation&&Mi.length>0&&(vr=Qf.create(Xt.elevation,this.tileID));const br={};let Ar;for(let Yt=0;Yt<Mi.length;Yt++){const Vr=Mi[Yt];if(Vr===Ar)continue;Ar=Vr;const nn=this.featureIndexArray.get(Vr);let sn=null;if(this.is3DTile){const ut=this.bucketLayerIDs[0][0],wt=pt[ut];if("model"!==wt.type)continue;const{queryFeature:Tt,intersectionZ:St}=wt.queryIntersectsMatchingFeature(Lt,nn.featureIndex,It,Xt);Tt&&this.appendToResult(br,ut,nn.featureIndex,Tt,St)}else this.loadMatchingFeature(br,nn,It,St.layers,St.availableImages,pt,wt,Tt,((pt,wt,Tt,St=0)=>(sn||(sn=Xc(pt,this.tileID.canonical,ut.tileTransform)),wt.queryIntersectsFeature(Lt,pt,Tt,sn,this.z,ut.transform,ut.pixelPosMatrix,vr,St))))}return br}loadMatchingFeature(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const{featureIndex:Mi,bucketIndex:vr,sourceLayerIndex:br,layoutVertexArrayOffset:Ar}=pt,Vr=this.bucketLayerIDs[vr];if(Tt&&!function(ut,pt){for(let wt=0;wt<ut.length;wt++)if(pt.indexOf(ut[wt])>=0)return!0;return!1}(Tt,Vr))return;const nn=this.sourceLayerCoder.decode(br),sn=this.vtLayers[nn].feature(Mi);if(wt.needGeometry){const ut=Yc(sn,!0);if(!wt.filter(new Ho(this.tileID.overscaledZ),ut,this.tileID.canonical))return}else if(!wt.filter(new Ho(this.tileID.overscaledZ),sn))return;const an=this.getId(sn,nn);for(let pt=0;pt<Vr.length;pt++){const wt=Vr[pt];if(Tt&&Tt.indexOf(wt)<0)continue;const vr=It[wt];if(!vr)continue;let br={};void 0!==an&&Xt&&(br=Xt.getState(vr.sourceLayer||"_geojsonTileLayer",an));const nn=!Yt||Yt(sn,vr,br,Ar);if(!nn)continue;const ln=new Cm(sn,this.z,this.x,this.y,an),cn=er({},Lt[wt]);cn.paint=Fm(cn.paint,vr.paint,sn,br,St),cn.layout=Fm(cn.layout,vr.layout,sn,br,St),ln.layer=cn,this.appendToResult(ut,wt,Mi,ln,nn)}}appendToResult(ut,pt,wt,Tt,St){let It=ut[pt];void 0===It&&(It=ut[pt]=[]),It.push({featureIndex:wt,feature:Tt,intersectionZ:St})}lookupSymbolFeatures(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt={};this.loadVTLayers();const Mi=pl(St);for(const St of ut)this.loadMatchingFeature(Yt,{bucketIndex:wt,sourceLayerIndex:Tt,featureIndex:St,layoutVertexArrayOffset:0},Mi,It,Lt,Xt,pt);return Yt}loadFeature(ut){const{featureIndex:pt,sourceLayerIndex:wt}=ut;this.loadVTLayers();const Tt=this.sourceLayerCoder.decode(wt),St=this.vtFeatures[Tt];if(St[pt])return St[pt];const It=this.vtLayers[Tt].feature(pt);return St[pt]=It,It}hasLayer(ut){for(const pt of this.bucketLayerIDs)for(const wt of pt)if(ut===wt)return!0;return!1}getId(ut,pt){let wt=ut.id;if(this.promoteId){const Tt="string"==typeof this.promoteId?this.promoteId:this.promoteId[pt];null!=Tt&&(wt=ut.properties[Tt]),"boolean"==typeof wt&&(wt=Number(wt))}return wt}}function Fm(ut,pt,wt,Tt,St){return ur(ut,((ut,It)=>{const Lt=pt instanceof nl?pt.get(It):null;return Lt&&Lt.evaluate?Lt.evaluate(wt,Tt,St):Lt}))}function Lm(ut,pt){return pt-ut}Mo(Vm,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});var wv=24;const Sv=128;function Nm(ut,pt){const{expression:wt}=pt;if("constant"===wt.kind)return{kind:"constant",layoutSize:wt.evaluate(new Ho(ut+1))};if("source"===wt.kind)return{kind:"source"};{const{zoomStops:pt,interpolationType:Tt}=wt;let St=0;for(;St<pt.length&&pt[St]<=ut;)St++;St=Math.max(0,St-1);let It=St;for(;It<pt.length&&pt[It]<ut+1;)It++;It=Math.min(pt.length-1,It);const Lt=pt[St],Xt=pt[It];return"composite"===wt.kind?{kind:"composite",minZoom:Lt,maxZoom:Xt,interpolationType:Tt}:{kind:"camera",minZoom:Lt,maxZoom:Xt,minSize:wt.evaluate(new Ho(Lt)),maxSize:wt.evaluate(new Ho(Xt)),interpolationType:Tt}}}function jm(ut,{uSize:pt,uSizeT:wt},{lowerSize:Tt,upperSize:St}){return"source"===ut.kind?Tt/Sv:"composite"===ut.kind?Gn(Tt/Sv,St/Sv,wt):pt}function qm(ut,pt){let wt=0,Tt=0;if("constant"===ut.kind)Tt=ut.layoutSize;else if("source"!==ut.kind){const{interpolationType:St,minZoom:It,maxZoom:Lt}=ut,Xt=St?Ke(va.interpolationFactor(St,pt,It,Lt),0,1):0;"camera"===ut.kind?Tt=Gn(ut.minSize,ut.maxSize,Xt):wt=Xt}return{uSizeT:wt,uSize:Tt}}var Av=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Sv,evaluateSizeForFeature:jm,evaluateSizeForZoom:qm,getSizeData:Nm});function Gm(ut,pt,wt){return ut.sections.forEach((ut=>{ut.text=function(ut,pt,wt){const Tt=pt.layout.get("text-transform").evaluate(wt,{});return"uppercase"===Tt?ut=ut.toLocaleUpperCase():"lowercase"===Tt&&(ut=ut.toLocaleLowerCase()),y_.applyArabicShaping&&(ut=y_.applyArabicShaping(ut)),ut}(ut.text,pt,wt)})),ut}const Nv={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function Ym(ut){return""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut}function Zm(ut){return""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut||""===ut}const jv=3;function Km(ut,pt,wt){pt.glyphs=[],1===ut&&wt.readMessage(Wm,pt)}function Wm(ut,pt,wt){if(3===ut){const{id:ut,bitmap:Tt,width:St,height:It,left:Lt,top:Xt,advance:Yt}=wt.readMessage(Jm,{});pt.glyphs.push({id:ut,bitmap:new pp({width:St+2*jv,height:It+2*jv},Tt),metrics:{width:St,height:It,left:Lt,top:Xt,advance:Yt}})}else 4===ut?pt.ascender=wt.readSVarint():5===ut&&(pt.descender=wt.readSVarint())}function Jm(ut,pt,wt){1===ut?pt.id=wt.readVarint():2===ut?pt.bitmap=wt.readBytes():3===ut?pt.width=wt.readVarint():4===ut?pt.height=wt.readVarint():5===ut?pt.left=wt.readSVarint():6===ut?pt.top=wt.readSVarint():7===ut&&(pt.advance=wt.readVarint())}const Gv=jv,Jv={horizontal:1,vertical:2,horizontalOnly:3};class ey{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(ut,pt){const wt=new ey;return wt.scale=ut||1,wt.fontStack=pt,wt}static forImage(ut){const pt=new ey;return pt.imageName=ut,pt}}class ry{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(ut,pt){const wt=new ry;for(let Tt=0;Tt<ut.sections.length;Tt++){const St=ut.sections[Tt];St.image?wt.addImageSection(St):wt.addTextSection(St,pt)}return wt}length(){return this.text.length}getSection(ut){return this.sections[this.sectionIndex[ut]]}getSections(){return this.sections}getSectionIndex(ut){return this.sectionIndex[ut]}getCodePoint(ut){return this.text.codePointAt(ut)}verticalizePunctuation(ut){this.text=function(ut,pt){let wt="";for(let Tt=0;Tt<ut.length;Tt++){const St=ut.charCodeAt(Tt+1)||null,It=ut.charCodeAt(Tt-1)||null;wt+=!pt&&(St&&Do(St)&&!Nv[ut[Tt+1]]||It&&Do(It)&&!Nv[ut[Tt-1]])||!Nv[ut[Tt]]?ut[Tt]:Nv[ut[Tt]]}return wt}(this.text,ut)}trim(){let ut=0;for(let pt=0;pt<this.text.length&&Qv[this.text.charCodeAt(pt)];pt++)ut++;let pt=this.text.length;for(let wt=this.text.length-1;wt>=0&&wt>=ut&&Qv[this.text.charCodeAt(wt)];wt--)pt--;this.text=this.text.substring(ut,pt),this.sectionIndex=this.sectionIndex.slice(ut,pt)}substring(ut,pt){const wt=new ry;return wt.text=this.text.substring(ut,pt),wt.sectionIndex=this.sectionIndex.slice(ut,pt),wt.sections=this.sections,wt}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((ut,pt)=>Math.max(ut,this.sections[pt].scale)),0)}addTextSection(ut,pt){this.text+=ut.text,this.sections.push(ey.forText(ut.scale,ut.fontStack||pt));const wt=this.sections.length-1;for(let pt=0;pt<ut.text.length;++pt)this.sectionIndex.push(wt)}addImageSection(ut){const pt=ut.image?ut.image.namePrimary:"";if(0===pt.length)return void fr("Can't add FormattedSection with an empty image.");const wt=this.getNextImageSectionCharCode();wt?(this.text+=String.fromCodePoint(wt),this.sections.push(ey.forImage(pt)),this.sectionIndex.push(this.sections.length-1)):fr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function ny(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn){const sn=ry.fromFeature(ut,St);br===Jv.vertical&&sn.verticalizePunctuation(Ar);let an=[];const ln=function(ut,pt,wt,Tt,St,It){if(!ut)return[];const Lt=[],Xt=function(ut,pt,wt,Tt,St,It){let Lt=0;for(let wt=0;wt<ut.length();wt++){const Xt=ut.getSection(wt);Lt+=ay(ut.getCodePoint(wt),Xt,Tt,St,pt,It)}return Lt/Math.max(1,Math.ceil(Lt/wt))}(ut,pt,wt,Tt,St,It),Yt=ut.text.indexOf("")>=0;let Mi=0;for(let wt=0;wt<ut.length();wt++){const br=ut.getSection(wt),Ar=ut.getCodePoint(wt);if(Qv[Ar]||(Mi+=ay(Ar,br,Tt,St,pt,It)),wt<ut.length()-1){const pt=!((vr=Ar)<11904||!(u_["Bopomofo Extended"](vr)||u_.Bopomofo(vr)||u_["CJK Compatibility Forms"](vr)||u_["CJK Compatibility Ideographs"](vr)||u_["CJK Compatibility"](vr)||u_["CJK Radicals Supplement"](vr)||u_["CJK Strokes"](vr)||u_["CJK Symbols and Punctuation"](vr)||u_["CJK Unified Ideographs Extension A"](vr)||u_["CJK Unified Ideographs"](vr)||u_["Enclosed CJK Letters and Months"](vr)||u_["Halfwidth and Fullwidth Forms"](vr)||u_.Hiragana(vr)||u_["Ideographic Description Characters"](vr)||u_["Kangxi Radicals"](vr)||u_["Katakana Phonetic Extensions"](vr)||u_.Katakana(vr)||u_["Vertical Forms"](vr)||u_["Yi Radicals"](vr)||u_["Yi Syllables"](vr)));(ib[Ar]||pt||br.imageName)&&Lt.push(uy(wt+1,Mi,Xt,Lt,ly(Ar,ut.getCodePoint(wt+1),pt&&Yt),!1))}}var vr;return cy(uy(ut.length(),Mi,Xt,Lt,0,!0))}(sn,Mi,It,pt,Tt,Vr),{processBidirectionalText:cn,processStyledBidirectionalText:un}=y_;if(cn&&1===sn.sections.length){const ut=cn(sn.toString(),ln);for(const pt of ut){const ut=new ry;ut.text=pt,ut.sections=sn.sections;for(let wt=0;wt<pt.length;wt++)ut.sectionIndex.push(0);an.push(ut)}}else if(un){const ut=un(sn.text,sn.sectionIndex,ln);for(const pt of ut){const ut=new ry;ut.text=pt[0],ut.sectionIndex=pt[1],ut.sections=sn.sections,an.push(ut)}}else an=function(ut,pt){const wt=[],Tt=ut.text;let St=0;for(const Tt of pt)wt.push(ut.substring(St,Tt)),St=Tt;return St<Tt.length&&wt.push(ut.substring(St,Tt.length)),wt}(sn,ln);const fn=[],_n={positionedLines:fn,text:sn.toString(),top:vr[1],bottom:vr[1],left:vr[0],right:vr[0],writingMode:br,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br){let Ar=0,Vr=0,nn=0;const sn="right"===Xt?1:"left"===Xt?0:.5;let an=!1;for(const ut of St){const wt=ut.getSections();for(const ut of wt){if(ut.imageName)continue;const wt=pt[ut.fontStack];if(wt&&(an=void 0!==wt.ascender&&void 0!==wt.descender,!an))break}if(!an)break}let ln=0;for(const Lt of St){Lt.trim();const St=Lt.getMaxScale(),Xt=(St-1)*wv,un={positionedGlyphs:[],lineOffset:0};ut.positionedLines[ln]=un;const fn=un.positionedGlyphs;let _n=0;if(!Lt.length()){Vr+=It,++ln;continue}let gn=0,yn=0;for(let It=0;It<Lt.length();It++){const Xt=Lt.getSection(It),nn=Lt.getSectionIndex(It),sn=Lt.getCodePoint(It);let ln=Xt.scale,un=null,xn=null,vn=null,bn=wv,wn=0;const Tn=!(Yt===Jv.horizontal||!vr&&!Bo(sn)||vr&&(Qv[sn]||(cn=sn,u_.Arabic(cn)||u_["Arabic Supplement"](cn)||u_["Arabic Extended-A"](cn)||u_["Arabic Presentation Forms-A"](cn)||u_["Arabic Presentation Forms-B"](cn))));if(Xt.imageName){const pt=Tt[Xt.imageName];if(!pt)continue;vn=Xt.imageName,ut.iconsInText=ut.iconsInText||!0,xn=pt.paddedRect;const wt=pt.displaySize;ln=ln*wv/br,un={width:wt[0],height:wt[1],left:0,top:-Gv,advance:Tn?wt[1]:wt[0],localGlyph:!1},wn=an?-un.height*ln:St*wv-17-wt[1]*ln,bn=un.advance;const It=(Tn?wt[0]:wt[1])*ln-wv*St;It>0&&It>_n&&(_n=It)}else{const ut=wt[Xt.fontStack];if(!ut)continue;ut[sn]&&(xn=ut[sn]);const Tt=pt[Xt.fontStack];if(!Tt)continue;const It=Tt.glyphs[sn];if(!It)continue;if(un=It.metrics,bn=8203!==sn?wv:0,an){const ut=void 0!==Tt.ascender?Math.abs(Tt.ascender):0,pt=void 0!==Tt.descender?Math.abs(Tt.descender):0,wt=(ut+pt)*ln;gn<wt&&(gn=wt,yn=(ut-pt)/2*ln),wn=-ut*ln}else wn=(St-ln)*wv-17}Tn?(ut.verticalizable=!0,fn.push({glyph:sn,imageName:vn,x:Ar,y:Vr+wn,vertical:Tn,scale:ln,localGlyph:un.localGlyph,fontStack:Xt.fontStack,sectionIndex:nn,metrics:un,rect:xn}),Ar+=bn*ln+Mi):(fn.push({glyph:sn,imageName:vn,x:Ar,y:Vr+wn,vertical:Tn,scale:ln,localGlyph:un.localGlyph,fontStack:Xt.fontStack,sectionIndex:nn,metrics:un,rect:xn}),Ar+=un.advance*ln+Mi)}0!==fn.length&&(nn=Math.max(Ar-Mi,nn),an?py(fn,sn,_n,yn,It*St/2):py(fn,sn,_n,0,It/2)),Ar=0;const xn=It*St+_n;un.lineOffset=Math.max(_n,Xt),Vr+=xn,++ln}var cn;const un=Vr,{horizontalAlign:fn,verticalAlign:_n}=hy(Lt);(function(ut,pt,wt,Tt,St,It){const Lt=(pt-wt)*St,Xt=-It*Tt;for(const pt of ut)for(const ut of pt.positionedGlyphs)ut.x+=Lt,ut.y+=Xt})(ut.positionedLines,sn,fn,_n,nn,un),ut.top+=-_n*un,ut.bottom=ut.top+un,ut.left+=-fn*nn,ut.right=ut.left+nn,ut.hasBaseline=an}(_n,pt,wt,Tt,an,Lt,Xt,Yt,br,Mi,Ar,nn),!function(ut){for(const pt of ut)if(0!==pt.positionedGlyphs.length)return!1;return!0}(fn)&&_n}const Qv={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ib={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ay(ut,pt,wt,Tt,St,It){if(pt.imageName){const ut=Tt[pt.imageName];return ut?ut.displaySize[0]*pt.scale*wv/It+St:0}{const Tt=wt[pt.fontStack],It=Tt&&Tt.glyphs[ut];return It?It.metrics.advance*pt.scale+St:0}}function oy(ut,pt,wt,Tt){const St=Math.pow(ut-pt,2);return Tt?ut<pt?St/2:2*St:St+Math.abs(wt)*wt}function ly(ut,pt,wt){let Tt=0;return 10===ut&&(Tt-=1e4),wt&&(Tt+=150),40!==ut&&65288!==ut||(Tt+=50),41!==pt&&65289!==pt||(Tt+=50),Tt}function uy(ut,pt,wt,Tt,St,It){let Lt=null,Xt=oy(pt,wt,St,It);for(const ut of Tt){const Tt=oy(pt-ut.x,wt,St,It)+ut.badness;Tt<=Xt&&(Lt=ut,Xt=Tt)}return{index:ut,x:pt,priorBreak:Lt,badness:Xt}}function cy(ut){return ut?cy(ut.priorBreak).concat(ut.index):[]}function hy(ut){let pt=.5,wt=.5;switch(ut){case"right":case"top-right":case"bottom-right":pt=1;break;case"left":case"top-left":case"bottom-left":pt=0}switch(ut){case"bottom":case"bottom-right":case"bottom-left":wt=1;break;case"top":case"top-right":case"top-left":wt=0}return{horizontalAlign:pt,verticalAlign:wt}}function py(ut,pt,wt,Tt,St){if(!(pt||wt||Tt||St))return;const It=ut.length-1,Lt=ut[It],Xt=(Lt.x+Lt.metrics.advance*Lt.scale)*pt;for(let pt=0;pt<=It;pt++)ut[pt].x-=Xt,ut[pt].y+=wt+Tt+St}function fy(ut,pt,wt,Tt){const{horizontalAlign:St,verticalAlign:It}=hy(Tt),Lt=wt[0]-ut.displaySize[0]*St,Xt=wt[1]-ut.displaySize[1]*It;return{imagePrimary:ut,imageSecondary:pt,top:Xt,bottom:Xt+ut.displaySize[1],left:Lt,right:Lt+ut.displaySize[0]}}function dy(ut,pt,wt,Tt,St,It){const Lt=ut.imagePrimary;let Xt;if(Lt.content){const ut=Lt.content,pt=Lt.pixelRatio||1;Xt=[ut[0]/pt,ut[1]/pt,Lt.displaySize[0]-ut[2]/pt,Lt.displaySize[1]-ut[3]/pt]}const Yt=pt.left*It,Mi=pt.right*It;let vr,br,Ar,Vr;"width"===wt||"both"===wt?(Vr=St[0]+Yt-Tt[3],br=St[0]+Mi+Tt[1]):(Vr=St[0]+(Yt+Mi-Lt.displaySize[0])/2,br=Vr+Lt.displaySize[0]);const nn=pt.top*It,sn=pt.bottom*It;return"height"===wt||"both"===wt?(vr=St[1]+nn-Tt[0],Ar=St[1]+sn+Tt[2]):(vr=St[1]+(nn+sn-Lt.displaySize[1])/2,Ar=vr+Lt.displaySize[1]),{imagePrimary:Lt,imageSecondary:void 0,top:vr,right:br,bottom:Ar,left:Vr,collisionPadding:Xt}}class my extends xc{constructor(ut,pt,wt,Tt,St){super(ut,pt),this.angle=Tt,this.z=wt,void 0!==St&&(this.segment=St)}clone(){return new my(this.x,this.y,this.z,this.angle,this.segment)}}function yy(ut,pt,wt,Tt,St){if(void 0===pt.segment)return!0;let It=pt,Lt=pt.segment+1,Xt=0;for(;Xt>-wt/2;){if(Lt--,Lt<0)return!1;Xt-=ut[Lt].dist(It),It=ut[Lt]}Xt+=ut[Lt].dist(ut[Lt+1]),Lt++;const Yt=[];let Mi=0;for(;Xt<wt/2;){const pt=ut[Lt],wt=ut[Lt+1];if(!wt)return!1;let It=ut[Lt-1].angleTo(pt)-pt.angleTo(wt);for(It=Math.abs((It+3*Math.PI)%(2*Math.PI)-Math.PI),Yt.push({distance:Xt,angleDelta:It}),Mi+=It;Xt-Yt[0].distance>Tt;)Mi-=Yt.shift().angleDelta;if(Mi>St)return!1;Lt++,Xt+=pt.dist(wt)}return!0}function gy(ut){let pt=0;for(let wt=0;wt<ut.length-1;wt++)pt+=ut[wt].dist(ut[wt+1]);return pt}function xy(ut,pt,wt){return ut?.6*pt*wt:0}function by(ut,pt){return Math.max(ut?ut.right-ut.left:0,pt?pt.right-pt.left:0)}function vy(ut,pt,wt,Tt,St,It){const Lt=xy(wt,St,It),Xt=by(wt,Tt)*It;let Yt=0;const Mi=gy(ut)/2;for(let wt=0;wt<ut.length-1;wt++){const Tt=ut[wt],St=ut[wt+1],It=Tt.dist(St);if(Yt+It>Mi){const vr=(Mi-Yt)/It,br=Gn(Tt.x,St.x,vr),Ar=Gn(Tt.y,St.y,vr),Vr=new my(br,Ar,0,St.angleTo(Tt),wt);return!Lt||yy(ut,Vr,Xt,Lt,pt)?Vr:void 0}Yt+=It}}function _y(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=xy(Tt,It,Lt),vr=by(Tt,St),br=vr*Lt,Ar=0===ut[0].x||ut[0].x===Yt||0===ut[0].y||ut[0].y===Yt;return pt-br<pt/4&&(pt=br+pt/4),wy(ut,Ar?pt/2*Xt%pt:(vr/2+2*It)*Lt*Xt%pt,pt,Mi,wt,br,Ar,!1,Yt)}function wy(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=It/2,vr=gy(ut);let br=0,Ar=pt-wt,Vr=[];for(let pt=0;pt<ut.length-1;pt++){const Lt=ut[pt],Xt=ut[pt+1],nn=Lt.dist(Xt),sn=Xt.angleTo(Lt);for(;Ar+wt<br+nn;){Ar+=wt;const an=(Ar-br)/nn,ln=Gn(Lt.x,Xt.x,an),cn=Gn(Lt.y,Xt.y,an);if(ln>=0&&ln<Yt&&cn>=0&&cn<Yt&&Ar-Mi>=0&&Ar+Mi<=vr){const wt=new my(ln,cn,0,sn,pt);Tt&&!yy(ut,wt,It,Tt,St)||Vr.push(wt)}}br+=nn}return Xt||Vr.length||Lt||(Vr=wy(ut,br/2,wt,Tt,St,It,Lt,!0,Yt)),Vr}function My(ut,pt,wt,Tt,St){const It=[];for(let Lt=0;Lt<ut.length;Lt++){const Xt=ut[Lt];let Yt;for(let ut=0;ut<Xt.length-1;ut++){let Lt=Xt[ut],Mi=Xt[ut+1];Lt.x<pt&&Mi.x<pt||(Lt.x<pt?Lt=new xc(pt,Lt.y+(pt-Lt.x)/(Mi.x-Lt.x)*(Mi.y-Lt.y))._round():Mi.x<pt&&(Mi=new xc(pt,Lt.y+(pt-Lt.x)/(Mi.x-Lt.x)*(Mi.y-Lt.y))._round()),Lt.y<wt&&Mi.y<wt||(Lt.y<wt?Lt=new xc(Lt.x+(wt-Lt.y)/(Mi.y-Lt.y)*(Mi.x-Lt.x),wt)._round():Mi.y<wt&&(Mi=new xc(Lt.x+(wt-Lt.y)/(Mi.y-Lt.y)*(Mi.x-Lt.x),wt)._round()),Lt.x>=Tt&&Mi.x>=Tt||(Lt.x>=Tt?Lt=new xc(Tt,Lt.y+(Tt-Lt.x)/(Mi.x-Lt.x)*(Mi.y-Lt.y))._round():Mi.x>=Tt&&(Mi=new xc(Tt,Lt.y+(Tt-Lt.x)/(Mi.x-Lt.x)*(Mi.y-Lt.y))._round()),Lt.y>=St&&Mi.y>=St||(Lt.y>=St?Lt=new xc(Lt.x+(St-Lt.y)/(Mi.y-Lt.y)*(Mi.x-Lt.x),St)._round():Mi.y>=St&&(Mi=new xc(Lt.x+(St-Lt.y)/(Mi.y-Lt.y)*(Mi.x-Lt.x),St)._round()),Yt&&Lt.equals(Yt[Yt.length-1])||(Yt=[Lt],It.push(Yt)),Yt.push(Mi)))))}}return It}function Ay(ut){let pt=0,wt=0;for(const Tt of ut)pt+=Tt.w*Tt.h,wt=Math.max(wt,Tt.w);ut.sort(((ut,pt)=>pt.h-ut.h));const Tt=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(pt/.95)),wt),h:1/0}];let St=0,It=0;for(const pt of ut)for(let ut=Tt.length-1;ut>=0;ut--){const wt=Tt[ut];if(!(pt.w>wt.w||pt.h>wt.h)){if(pt.x=wt.x,pt.y=wt.y,It=Math.max(It,pt.y+pt.h),St=Math.max(St,pt.x+pt.w),pt.w===wt.w&&pt.h===wt.h){const pt=Tt.pop();ut<Tt.length&&(Tt[ut]=pt)}else pt.h===wt.h?(wt.x+=pt.w,wt.w-=pt.w):pt.w===wt.w?(wt.y+=pt.h,wt.h-=pt.h):(Tt.push({x:wt.x+pt.w,y:wt.y,w:wt.w-pt.w,h:pt.h}),wt.y+=pt.h,wt.h-=pt.h);break}}return{w:St,h:It,fill:pt/(St*It)||0}}Mo(my,"Anchor");const rb=1;class Iy{constructor(ut,{pixelRatio:pt,version:wt,stretchX:Tt,stretchY:St,content:It}){this.paddedRect=ut,this.pixelRatio=pt,this.stretchX=Tt,this.stretchY=St,this.content=It,this.version=wt}get tl(){return[this.paddedRect.x+rb,this.paddedRect.y+rb]}get br(){return[this.paddedRect.x+this.paddedRect.w-rb,this.paddedRect.y+this.paddedRect.h-rb]}get displaySize(){return[(this.paddedRect.w-2*rb)/this.pixelRatio,(this.paddedRect.h-2*rb)/this.pixelRatio]}}class Ty{constructor(ut,pt,wt){const Tt={},St={};this.haveRenderCallbacks=[];const It=[];this.addImages(ut,Tt,It),this.addImages(pt,St,It);const{w:Lt,h:Xt}=Ay(It),Yt=new fp({width:Lt||1,height:Xt||1});for(const pt in ut){const St=ut[pt],It=Tt[pt].paddedRect;fp.copy(St.data,Yt,{x:0,y:0},{x:It.x+rb,y:It.y+rb},St.data,wt,St.sdf)}for(const ut in pt){const Tt=pt[ut],It=St[ut].paddedRect,Lt=It.x+rb,Xt=It.y+rb,Mi=Tt.data.width,vr=Tt.data.height;fp.copy(Tt.data,Yt,{x:0,y:0},{x:Lt,y:Xt},Tt.data,wt),fp.copy(Tt.data,Yt,{x:0,y:vr-1},{x:Lt,y:Xt-1},{width:Mi,height:1},wt),fp.copy(Tt.data,Yt,{x:0,y:0},{x:Lt,y:Xt+vr},{width:Mi,height:1},wt),fp.copy(Tt.data,Yt,{x:Mi-1,y:0},{x:Lt-1,y:Xt},{width:1,height:vr},wt),fp.copy(Tt.data,Yt,{x:0,y:0},{x:Lt+Mi,y:Xt},{width:1,height:vr},wt)}this.image=Yt,this.iconPositions=Tt,this.patternPositions=St}addImages(ut,pt,wt){for(const Tt in ut){const St=ut[Tt],It={x:0,y:0,w:St.data.width+2*rb,h:St.data.height+2*rb};wt.push(It),pt[Tt]=new Iy(It,St),St.hasRenderCallback&&this.haveRenderCallbacks.push(Tt)}}patchUpdatedImages(ut,pt,wt){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((pt=>ut.hasImage(pt,wt))),ut.dispatchRenderCallbacks(this.haveRenderCallbacks,wt);for(const Tt in ut.getUpdatedImages(wt))this.patchUpdatedImage(this.iconPositions[Tt],ut.getImage(Tt,wt),pt),this.patchUpdatedImage(this.patternPositions[Tt],ut.getImage(Tt,wt),pt)}patchUpdatedImage(ut,pt,wt){if(!ut||!pt)return;if(ut.version===pt.version)return;ut.version=pt.version;const[Tt,St]=ut.tl,It=!!Object.keys(this.patternPositions).length;wt.update(pt.data,{useMipmap:It},{x:Tt,y:St})}}Mo(Iy,"ImagePosition"),Mo(Ty,"ImageAtlas");const nb=1e20;function zy(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){for(let Mi=pt;Mi<pt+Tt;Mi++)Py(ut,wt*It+Mi,It,St,Lt,Xt,Yt);for(let Mi=wt;Mi<wt+St;Mi++)Py(ut,Mi*It+pt,1,Tt,Lt,Xt,Yt)}function Py(ut,pt,wt,Tt,St,It,Lt){It[0]=0,Lt[0]=-nb,Lt[1]=nb,St[0]=ut[pt];for(let Xt=1,Yt=0,Mi=0;Xt<Tt;Xt++){St[Xt]=ut[pt+Xt*wt];const Tt=Xt*Xt;do{const ut=It[Yt];Mi=(St[Xt]-St[ut]+Tt-ut*ut)/(Xt-ut)/2}while(Mi<=Lt[Yt]&&--Yt>-1);Yt++,It[Yt]=Xt,Lt[Yt]=Mi,Lt[Yt+1]=nb}for(let Xt=0,Yt=0;Xt<Tt;Xt++){for(;Lt[Yt+1]<Xt;)Yt++;const Tt=It[Yt],Mi=Xt-Tt;ut[pt+Xt*wt]=St[Tt]+Mi*Mi}}const sb=2,cb={none:0,ideographs:1,all:2};class Dy{constructor(ut,pt,wt){this.requestManager=ut,this.localGlyphMode=pt,this.localFontFamily=wt,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(ut,pt){this.urls[pt]=ut}getGlyphs(ut,pt,wt){const Tt=[],St=this.urls[pt]||It.GLYPHS_URL;for(const pt in ut)for(const wt of ut[pt])Tt.push({stack:pt,id:wt});Qe(Tt,(({stack:ut,id:pt},wt)=>{let Tt=this.entries[ut];Tt||(Tt=this.entries[ut]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let It=Tt.glyphs[pt];if(void 0!==It)return void wt(null,{stack:ut,id:pt,glyph:It});if(It=this._tinySDF(Tt,ut,pt),It)return Tt.glyphs[pt]=It,void wt(null,{stack:ut,id:pt,glyph:It});const Lt=Math.floor(pt/256);if(256*Lt>65535)return void wt(new Error("glyphs > 65535 not supported"));if(Tt.ranges[Lt])return void wt(null,{stack:ut,id:pt,glyph:It});let Xt=Tt.requests[Lt];Xt||(Xt=Tt.requests[Lt]=[],Dy.loadGlyphRange(ut,Lt,St,this.requestManager,((ut,pt)=>{if(pt){Tt.ascender=pt.ascender,Tt.descender=pt.descender;for(const ut in pt.glyphs)this._doesCharSupportLocalGlyph(+ut)||(Tt.glyphs[+ut]=pt.glyphs[+ut]);Tt.ranges[Lt]=!0}for(const wt of Xt)wt(ut,pt);delete Tt.requests[Lt]}))),Xt.push(((Tt,St)=>{Tt?wt(Tt):St&&wt(null,{stack:ut,id:pt,glyph:St.glyphs[pt]||null})}))}),((ut,pt)=>{if(ut)wt(ut);else if(pt){const ut={};for(const{stack:wt,id:Tt,glyph:St}of pt)void 0===ut[wt]&&(ut[wt]={}),void 0===ut[wt].glyphs&&(ut[wt].glyphs={}),ut[wt].glyphs[Tt]=St&&{id:St.id,bitmap:St.bitmap.clone(),metrics:St.metrics},ut[wt].ascender=this.entries[wt].ascender,ut[wt].descender=this.entries[wt].descender;wt(null,ut)}}))}_doesCharSupportLocalGlyph(ut){return this.localGlyphMode!==cb.none&&(this.localGlyphMode===cb.all?!!this.localFontFamily:!!this.localFontFamily&&(u_["CJK Unified Ideographs"](ut)||u_["Hangul Syllables"](ut)||u_.Hiragana(ut)||u_.Katakana(ut)||u_["CJK Symbols and Punctuation"](ut)||u_["CJK Unified Ideographs Extension A"](ut)||u_["CJK Unified Ideographs Extension B"](ut)))}_tinySDF(ut,pt,wt){const Tt=this.localFontFamily;if(!Tt||!this._doesCharSupportLocalGlyph(wt))return;let St=ut.tinySDF;if(!St){let wt="400";/bold/i.test(pt)?wt="900":/medium/i.test(pt)?wt="500":/light/i.test(pt)&&(wt="200"),St=ut.tinySDF=new Dy.TinySDF({fontFamily:Tt,fontWeight:wt,fontSize:24*sb,buffer:3*sb,radius:8*sb}),St.fontWeight=wt}if(this.localGlyphs[St.fontWeight][wt])return this.localGlyphs[St.fontWeight][wt];const It=String.fromCodePoint(wt),{data:Lt,width:Xt,height:Yt,glyphWidth:Mi,glyphHeight:vr,glyphLeft:br,glyphTop:Ar,glyphAdvance:Vr}=St.draw(It);return this.localGlyphs[St.fontWeight][wt]={id:wt,bitmap:new pp({width:Xt,height:Yt},Lt),metrics:{width:Mi/sb,height:vr/sb,left:br/sb,top:Ar/sb-27,advance:Vr/sb,localGlyph:!0}}}}Dy.loadGlyphRange=function(ut,pt,wt,Tt,St){const It=256*pt,Lt=It+255,Xt=Tt.transformRequest(Tt.normalizeGlyphsURL(wt).replace("{fontstack}",ut).replace("{range}",`${It}-${Lt}`),id.Glyphs);en(Xt,((ut,pt)=>{if(ut)St(ut);else if(pt){const ut={},wt=function(ut){return new xv(ut).readFields(Km,{})}(pt);for(const pt of wt.glyphs)ut[pt.id]=pt;St(null,{glyphs:ut,ascender:wt.ascender,descender:wt.descender})}}))},Dy.TinySDF=class{constructor({fontSize:ut=24,buffer:pt=3,radius:wt=8,cutoff:Tt=.25,fontFamily:St="sans-serif",fontWeight:It="normal",fontStyle:Lt="normal"}={}){this.buffer=pt,this.cutoff=Tt,this.radius=wt;const Xt=this.size=ut+4*pt,Yt=this._createCanvas(Xt),Mi=this.ctx=Yt.getContext("2d",{willReadFrequently:!0});Mi.font=`${Lt} ${It} ${ut}px ${St}`,Mi.textBaseline="alphabetic",Mi.textAlign="left",Mi.fillStyle="black",this.gridOuter=new Float64Array(Xt*Xt),this.gridInner=new Float64Array(Xt*Xt),this.f=new Float64Array(Xt),this.z=new Float64Array(Xt+1),this.v=new Uint16Array(Xt)}_createCanvas(ut){const pt=document.createElement("canvas");return pt.width=pt.height=ut,pt}draw(ut){const{width:pt,actualBoundingBoxAscent:wt,actualBoundingBoxDescent:Tt,actualBoundingBoxLeft:St,actualBoundingBoxRight:It}=this.ctx.measureText(ut),Lt=Math.ceil(wt),Xt=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(It-St))),Yt=Math.min(this.size-this.buffer,Lt+Math.ceil(Tt)),Mi=Xt+2*this.buffer,vr=Yt+2*this.buffer,br=Math.max(Mi*vr,0),Ar=new Uint8ClampedArray(br),Vr={data:Ar,width:Mi,height:vr,glyphWidth:Xt,glyphHeight:Yt,glyphTop:Lt,glyphLeft:0,glyphAdvance:pt};if(0===Xt||0===Yt)return Vr;const{ctx:nn,buffer:sn,gridInner:an,gridOuter:ln}=this;nn.clearRect(sn,sn,Xt,Yt),nn.fillText(ut,sn,sn+Lt);const cn=nn.getImageData(sn,sn,Xt,Yt);ln.fill(nb,0,br),an.fill(0,0,br);for(let ut=0;ut<Yt;ut++)for(let pt=0;pt<Xt;pt++){const wt=cn.data[4*(ut*Xt+pt)+3]/255;if(0===wt)continue;const Tt=(ut+sn)*Mi+pt+sn;if(1===wt)ln[Tt]=0,an[Tt]=nb;else{const ut=.5-wt;ln[Tt]=ut>0?ut*ut:0,an[Tt]=ut<0?ut*ut:0}}zy(ln,0,0,Mi,vr,Mi,this.f,this.v,this.z),zy(an,sn,sn,Xt,Yt,Mi,this.f,this.v,this.z);for(let ut=0;ut<br;ut++){const pt=Math.sqrt(ln[ut])-Math.sqrt(an[ut]);Ar[ut]=Math.round(255-255*(pt/this.radius+this.cutoff))}return Vr}};const pb=rb;function Ry(ut,pt,wt,Tt){const St=[],It=ut.imagePrimary,Lt=It.pixelRatio,Xt=It.paddedRect.w-2*pb,Yt=It.paddedRect.h-2*pb,Mi=ut.right-ut.left,vr=ut.bottom-ut.top,br=It.stretchX||[[0,Xt]],Ar=It.stretchY||[[0,Yt]],f=(ut,pt)=>ut+pt[1]-pt[0],Vr=br.reduce(f,0),nn=Ar.reduce(f,0),sn=Xt-Vr,an=Yt-nn;let ln=0,cn=Vr,un=0,fn=nn,_n=0,gn=sn,yn=0,xn=an;if(It.content&&Tt){const ut=It.content;ln=Vy(br,0,ut[0]),un=Vy(Ar,0,ut[1]),cn=Vy(br,ut[0],ut[2]),fn=Vy(Ar,ut[1],ut[3]),_n=ut[0]-ln,yn=ut[1]-un,gn=ut[2]-ut[0]-cn,xn=ut[3]-ut[1]-fn}const I=(Tt,St,Xt,Yt)=>{const br=Ly(Tt.stretch-ln,cn,Mi,ut.left),Ar=Oy(Tt.fixed-_n,gn,Tt.stretch,Vr),sn=Ly(St.stretch-un,fn,vr,ut.top),an=Oy(St.fixed-yn,xn,St.stretch,nn),vn=Ly(Xt.stretch-ln,cn,Mi,ut.left),bn=Oy(Xt.fixed-_n,gn,Xt.stretch,Vr),wn=Ly(Yt.stretch-un,fn,vr,ut.top),Tn=Oy(Yt.fixed-yn,xn,Yt.stretch,nn),En=new xc(br,sn),Mn=new xc(vn,sn),Sn=new xc(vn,wn),An=new xc(br,wn),In=new xc(Ar/Lt,an/Lt),Pn=new xc(bn/Lt,Tn/Lt),zn=pt*Math.PI/180;if(zn){const ut=Math.sin(zn),pt=Math.cos(zn),wt=[pt,-ut,ut,pt];En._matMult(wt),Mn._matMult(wt),An._matMult(wt),Sn._matMult(wt)}const Ln=Tt.stretch+Tt.fixed,kn=Xt.stretch+Xt.fixed,Bn=St.stretch+St.fixed,Wn=Yt.stretch+Yt.fixed,Yn=ut.imageSecondary;return{tl:En,tr:Mn,bl:An,br:Sn,texPrimary:{x:It.paddedRect.x+pb+Ln,y:It.paddedRect.y+pb+Bn,w:kn-Ln,h:Wn-Bn},texSecondary:Yn?{x:Yn.paddedRect.x+pb+Ln,y:Yn.paddedRect.y+pb+Bn,w:kn-Ln,h:Wn-Bn}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:In,pixelOffsetBR:Pn,minFontScaleX:gn/Lt/Mi,minFontScaleY:xn/Lt/vr,isSDF:wt}};if(Tt&&(It.stretchX||It.stretchY)){const ut=Fy(br,sn,Vr),pt=Fy(Ar,an,nn);for(let wt=0;wt<ut.length-1;wt++){const Tt=ut[wt],It=ut[wt+1];for(let ut=0;ut<pt.length-1;ut++)St.push(I(Tt,pt[ut],It,pt[ut+1]))}}else St.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:Xt+1},{fixed:0,stretch:Yt+1}));return St}function Vy(ut,pt,wt){let Tt=0;for(const St of ut)Tt+=Math.max(pt,Math.min(wt,St[1]))-Math.max(pt,Math.min(wt,St[0]));return Tt}function Fy(ut,pt,wt){const Tt=[{fixed:-pb,stretch:0}];for(const[pt,wt]of ut){const ut=Tt[Tt.length-1];Tt.push({fixed:pt-ut.stretch,stretch:ut.stretch}),Tt.push({fixed:pt-ut.stretch,stretch:ut.stretch+(wt-pt)})}return Tt.push({fixed:pt+pb,stretch:wt}),Tt}function Ly(ut,pt,wt,Tt){return ut/pt*wt+Tt}function Oy(ut,pt,wt,Tt){return ut-pt*wt/Tt}function Uy(ut,pt,wt,Tt){const St=pt+ut.positionedLines[Tt].lineOffset;return 0===Tt?wt+St/2:wt+(St+(pt+ut.positionedLines[Tt-1].lineOffset))/2}function Ny(ut,pt=1,wt=!1){let Tt=1/0,St=1/0,It=-1/0,Lt=-1/0;const Xt=ut[0];for(let ut=0;ut<Xt.length;ut++){const pt=Xt[ut];(!ut||pt.x<Tt)&&(Tt=pt.x),(!ut||pt.y<St)&&(St=pt.y),(!ut||pt.x>It)&&(It=pt.x),(!ut||pt.y>Lt)&&(Lt=pt.y)}const Yt=Math.min(It-Tt,Lt-St);let Mi=Yt/2;const vr=new ff([],jy);if(0===Yt)return new xc(Tt,St);for(let pt=Tt;pt<It;pt+=Yt)for(let wt=St;wt<Lt;wt+=Yt)vr.push(new qy(pt+Mi,wt+Mi,Mi,ut));let br=function(ut){let pt=0,wt=0,Tt=0;const St=ut[0];for(let ut=0,It=St.length,Lt=It-1;ut<It;Lt=ut++){const It=St[ut],Xt=St[Lt],Yt=It.x*Xt.y-Xt.x*It.y;wt+=(It.x+Xt.x)*Yt,Tt+=(It.y+Xt.y)*Yt,pt+=3*Yt}return new qy(wt/pt,Tt/pt,0,ut)}(ut),Ar=vr.length;for(;vr.length;){const Tt=vr.pop();(Tt.d>br.d||!br.d)&&(br=Tt,wt&&console.log("found best %d after %d probes",Math.round(1e4*Tt.d)/1e4,Ar)),Tt.max-br.d<=pt||(Mi=Tt.h/2,vr.push(new qy(Tt.p.x-Mi,Tt.p.y-Mi,Mi,ut)),vr.push(new qy(Tt.p.x+Mi,Tt.p.y-Mi,Mi,ut)),vr.push(new qy(Tt.p.x-Mi,Tt.p.y+Mi,Mi,ut)),vr.push(new qy(Tt.p.x+Mi,Tt.p.y+Mi,Mi,ut)),Ar+=4)}return wt&&(console.log(`num probes: ${Ar}`),console.log(`best distance: ${br.d}`)),br.p}function jy(ut,pt){return pt.max-ut.max}class qy{constructor(ut,pt,wt,Tt){this.p=new xc(ut,pt),this.h=wt,this.d=function(ut,pt){let wt=!1,Tt=1/0;for(let St=0;St<pt.length;St++){const It=pt[St];for(let pt=0,St=It.length,Lt=St-1;pt<St;Lt=pt++){const St=It[pt],Xt=It[Lt];St.y>ut.y!=Xt.y>ut.y&&ut.x<(Xt.x-St.x)*(ut.y-St.y)/(Xt.y-St.y)+St.x&&(wt=!wt),Tt=Math.min(Tt,ih(ut,St,Xt))}}return(wt?1:-1)*Math.sqrt(Tt)}(this.p,Tt),this.max=this.d+this.h*Math.SQRT2}}const fb=Number.POSITIVE_INFINITY,gb=Math.sqrt(2);function Xy(ut,[pt,wt]){let Tt=0,St=0;if(wt===fb){pt<0&&(pt=0);const wt=pt/gb;switch(ut){case"top-right":case"top-left":St=wt-7;break;case"bottom-right":case"bottom-left":St=7-wt;break;case"bottom":St=7-pt;break;case"top":St=pt-7}switch(ut){case"top-right":case"bottom-right":Tt=-wt;break;case"top-left":case"bottom-left":Tt=wt;break;case"left":Tt=pt;break;case"right":Tt=-pt}}else{switch(pt=Math.abs(pt),wt=Math.abs(wt),ut){case"top-right":case"top-left":case"top":St=wt-7;break;case"bottom-right":case"bottom-left":case"bottom":St=7-wt}switch(ut){case"top-right":case"bottom-right":case"right":Tt=-pt;break;case"top-left":case"bottom-left":case"left":Tt=pt}}return[Tt,St]}function Yy(ut){switch(ut){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Zy(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn){let sn=It.textMaxSize.evaluate(pt,{},br);void 0===sn&&(sn=Lt);const an=ut.layers[0].layout,ln=an.get("icon-offset").evaluate(pt,{},br),cn=Jy(wt.horizontal)||wt.vertical,un="globe"===Ar.name,fn=wv,_n=Lt/fn,gn=ut.tilePixelRatio*sn/fn,yn=(Sn=ut.overscaling,ut.zoom>18&&Sn>2&&(Sn>>=1),Math.max(xf/(512*Sn),1)*an.get("symbol-spacing")),xn=an.get("text-padding")*ut.tilePixelRatio,vn=an.get("icon-padding")*ut.tilePixelRatio,bn=$e(an.get("text-max-angle")),wn="map"===an.get("text-rotation-alignment")&&"point"!==an.get("symbol-placement"),Tn="map"===an.get("icon-rotation-alignment")&&"point"!==an.get("symbol-placement"),En=an.get("symbol-placement"),Mn=yn/2;var Sn;const An=an.get("icon-text-fit").evaluate(pt,{},br),In=an.get("icon-text-fit-padding").evaluate(pt,{},br),Pn="none"!==An;let zn;!1===ut.hasAnyIconTextFit&&Pn&&(ut.hasAnyIconTextFit=!0),Tt&&Pn&&(ut.allowVerticalPlacement&&wt.vertical&&(zn=dy(Tt,wt.vertical,An,In,ln,_n)),cn&&(Tt=dy(Tt,cn,An,In,ln,_n)));const V=(Lt,Xt,sn)=>{if(Xt.x<0||Xt.x>=xf||Xt.y<0||Xt.y>=xf)return;let an=null;if(un){const{x:ut,y:pt,z:wt}=Ar.projectTilePoint(Xt.x,Xt.y,sn);an={anchor:new my(ut,pt,wt,0,void 0),up:Ar.upVector(sn,Xt.x,Xt.y)}}!function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n,gn,yn,xn,vn,bn){const wn=ut.addToLineVertexArray(pt,Tt);let Tn,En,Mn,Sn,An,In,Pn,zn=0,Ln=0,kn=0,Bn=0,Wn=-1,Yn=-1;const Jn={};let Qn=Yd("");const bo=wt?wt.anchor:pt,ko="none"!==Yt.layout.get("icon-text-fit").evaluate(fn,{},xn);let No=0,Js=0;if(void 0===Yt._unevaluatedLayout.getValue("text-radial-offset")?[No,Js]=Yt.layout.get("text-offset").evaluate(fn,{},xn).map((ut=>ut*wv)):(No=Yt.layout.get("text-radial-offset").evaluate(fn,{},xn)*wv,Js=fb),ut.allowVerticalPlacement&&St.vertical){const ut=St.vertical;if(nn)In=tg(ut),Xt&&(Pn=tg(Xt));else{const wt=Yt.layout.get("text-rotate").evaluate(fn,{},xn)+90;Mn=Qy(Mi,bo,pt,vr,br,Ar,ut,Vr,wt,sn),Xt&&(Sn=Qy(Mi,bo,pt,vr,br,Ar,Xt,ln,wt))}}if(It){const Tt=Yt.layout.get("icon-rotate").evaluate(fn,{},xn),St=Ry(It,Tt,gn,ko),Lt=Xt?Ry(Xt,Tt,gn,ko):void 0;En=Qy(Mi,bo,pt,vr,br,Ar,It,ln,Tt),zn=4*St.length;const Vr=ut.iconSizeData;let nn=null;"source"===Vr.kind?(nn=[Sv*Yt.layout.get("icon-size").evaluate(fn,{},xn)],nn[0]>bb&&fr(`${ut.layerIds[0]}: Value for "icon-size" is >= ${yb}. Reduce your "icon-size".`)):"composite"===Vr.kind&&(nn=[Sv*_n.compositeIconSizes[0].evaluate(fn,{},xn),Sv*_n.compositeIconSizes[1].evaluate(fn,{},xn)],(nn[0]>bb||nn[1]>bb)&&fr(`${ut.layerIds[0]}: Value for "icon-size" is >= ${yb}. Reduce your "icon-size".`)),ut.addSymbols(ut.icon,St,nn,un,cn,fn,!1,wt,pt,wn.lineStartIndex,wn.lineLength,-1,yn,xn,vn,bn),Wn=ut.icon.placedSymbolArray.length-1,Lt&&(Ln=4*Lt.length,ut.addSymbols(ut.icon,Lt,nn,un,cn,fn,Jv.vertical,wt,pt,wn.lineStartIndex,wn.lineLength,-1,yn,xn,vn,bn),Yn=ut.icon.placedSymbolArray.length-1)}for(const Tt in St.horizontal){const It=St.horizontal[Tt];Tn||(Qn=Yd(It.text),nn?An=tg(It):Tn=Qy(Mi,bo,pt,vr,br,Ar,It,Vr,Yt.layout.get("text-rotate").evaluate(fn,{},xn),sn));const Xt=1===It.positionedLines.length;if(kn+=Wy(ut,wt,pt,It,Lt,Yt,nn,fn,sn,wn,St.vertical?Jv.horizontal:Jv.horizontalOnly,Xt?Object.keys(St.horizontal):[Tt],Jn,Wn,_n,yn,xn,vn),Xt)break}St.vertical&&(Bn+=Wy(ut,wt,pt,St.vertical,Lt,Yt,nn,fn,sn,wn,Jv.vertical,["vertical"],Jn,Yn,_n,yn,xn,vn));let ua=-1;const Z=(ut,pt)=>ut?Math.max(ut,pt):pt;ua=Z(An,ua),ua=Z(In,ua),ua=Z(Pn,ua);const ga=ua>-1?1:0;ut.glyphOffsetArray.length>=65535&&fr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==fn.sortKey&&ut.addToSortKeyRanges(ut.symbolInstances.length,fn.sortKey),ut.symbolInstances.emplaceBack(pt.x,pt.y,bo.x,bo.y,bo.z,Jn.right>=0?Jn.right:-1,Jn.center>=0?Jn.center:-1,Jn.left>=0?Jn.left:-1,Jn.vertical>=0?Jn.vertical:-1,Wn,Yn,Qn,void 0!==Tn?Tn:ut.collisionBoxArray.length,void 0!==Tn?Tn+1:ut.collisionBoxArray.length,void 0!==Mn?Mn:ut.collisionBoxArray.length,void 0!==Mn?Mn+1:ut.collisionBoxArray.length,void 0!==En?En:ut.collisionBoxArray.length,void 0!==En?En+1:ut.collisionBoxArray.length,Sn||ut.collisionBoxArray.length,Sn?Sn+1:ut.collisionBoxArray.length,vr,kn,Bn,zn,Ln,ga,0,No,Js,ua,0,1,1,ko?1:0)}(ut,Xt,an,Lt,wt,Tt,St,zn,ut.layers[0],ut.collisionBoxArray,pt.index,pt.sourceLayerIndex,ut.index,xn,wn,Yt,0,vn,Tn,ln,pt,It,Mi,vr,br,Vr,nn)};if("line"===En)for(const St of My(pt.geometry,0,0,xf,xf)){const pt=_y(St,yn,bn,wt.vertical||cn,Tt,fn,gn,ut.overscaling,xf);for(const wt of pt)cn&&eg(ut,cn.text,Mn,wt)||V(St,wt,br)}else if("line-center"===En){for(const ut of pt.geometry)if(ut.length>1){const pt=vy(ut,bn,wt.vertical||cn,Tt,fn,gn);pt&&V(ut,pt,br)}}else if("Polygon"===pt.type)for(const ut of Yp(pt.geometry,0)){const pt=Ny(ut,16);V(ut[0],new my(pt.x,pt.y,0,0,void 0),br)}else if("LineString"===pt.type)for(const ut of pt.geometry)V(ut,new my(ut[0].x,ut[0].y,0,0,void 0),br);else if("Point"===pt.type)for(const ut of pt.geometry)for(const pt of ut)V([pt],new my(pt.x,pt.y,0,0,void 0),br)}const yb=255,bb=yb*Sv;function Wy(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln){const cn=function(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=[];if(0===pt.positionedLines.length)return Yt;const Mi=Tt.layout.get("text-rotate").evaluate(It,{})*Math.PI/180,vr=function(ut){const pt=ut[0],wt=ut[1],Tt=pt*wt;return Tt>0?[pt,-wt]:Tt<0?[-pt,wt]:0===pt?[wt,pt]:[wt,-pt]}(wt);let br=Math.abs(pt.top-pt.bottom);for(const ut of pt.positionedLines)br-=ut.lineOffset;const Ar=pt.positionedLines.length,Vr=br/Ar;let nn=pt.top-wt[1];for(let ut=0;ut<Ar;++ut){const Tt=pt.positionedLines[ut];nn=Uy(pt,Vr,nn,ut);for(const ut of Tt.positionedGlyphs){if(!ut.rect)continue;const Tt=ut.rect||{};let It=Gv+1,br=!0,Ar=1,Vr=0;if(ut.imageName){const pt=Lt[ut.imageName];if(!pt)continue;if(pt.sdf){fr("SDF images are not supported in formatted text and will be ignored.");continue}br=!1,Ar=pt.pixelRatio,It=rb/Ar}const sn=(St||Xt)&&ut.vertical,an=ut.metrics.advance*ut.scale/2,ln=ut.metrics,cn=ut.rect;if(null===cn)continue;Xt&&pt.verticalizable&&(Vr=ut.imageName?an-ut.metrics.width*ut.scale/2:0);const un=St?[ut.x+an,ut.y]:[0,0];let fn=[0,0],_n=[0,0],gn=!1;St||(sn?(_n=[ut.x+an+vr[0],ut.y+vr[1]-Vr],gn=!0):fn=[ut.x+an+wt[0],ut.y+wt[1]-Vr]);const yn=cn.w*ut.scale/(Ar*(ut.localGlyph?sb:1)),xn=cn.h*ut.scale/(Ar*(ut.localGlyph?sb:1));let vn,bn,wn,Tn;if(sn){const pt=ut.y-nn,wt=new xc(-an,an-pt),Tt=-Math.PI/2,St=new xc(..._n);vn=new xc(-an+fn[0],fn[1]),vn._rotateAround(Tt,wt)._add(St),vn.x+=-pt+an,vn.y-=(ln.left-It)*ut.scale;const Lt=ut.imageName?ln.advance*ut.scale:wv*ut.scale,Xt=String.fromCodePoint(ut.glyph);Ym(Xt)?vn.x+=(1-It)*ut.scale:Zm(Xt)?vn.x+=Lt-ln.height*ut.scale+(-It-1)*ut.scale:vn.x+=ut.imageName||ln.width+2*It===cn.w&&ln.height+2*It===cn.h?(Lt-xn)/2:(Lt-(ln.height+2*It)*ut.scale)/2,bn=new xc(vn.x,vn.y-yn),wn=new xc(vn.x+xn,vn.y),Tn=new xc(vn.x+xn,vn.y-yn)}else{const pt=(ln.left-It)*ut.scale-an+fn[0],wt=(-ln.top-It)*ut.scale+fn[1],Tt=pt+yn,St=wt+xn;vn=new xc(pt,wt),bn=new xc(Tt,wt),wn=new xc(pt,St),Tn=new xc(Tt,St)}if(Mi){let ut;ut=St?new xc(0,0):gn?new xc(vr[0],vr[1]):new xc(wt[0],wt[1]),vn._rotateAround(Mi,ut),bn._rotateAround(Mi,ut),wn._rotateAround(Mi,ut),Tn._rotateAround(Mi,ut)}const En=new xc(0,0),Mn=new xc(0,0);Yt.push({tl:vn,tr:bn,bl:wn,br:Tn,texPrimary:Tt,texSecondary:void 0,writingMode:pt.writingMode,glyphOffset:un,sectionIndex:ut.sectionIndex,isSDF:br,pixelOffsetTL:En,pixelOffsetBR:Mn,minFontScaleX:0,minFontScaleY:0})}}return Yt}(0,Tt,Yt,It,Lt,Xt,St,ut.allowVerticalPlacement),un=ut.textSizeData;let fn=null;"source"===un.kind?(fn=[Sv*It.layout.get("text-size").evaluate(Xt,{},an)],fn[0]>bb&&fr(`${ut.layerIds[0]}: Value for "text-size" is >= ${yb}. Reduce your "text-size".`)):"composite"===un.kind&&(fn=[Sv*nn.compositeTextSizes[0].evaluate(Xt,{},an),Sv*nn.compositeTextSizes[1].evaluate(Xt,{},an)],(fn[0]>bb||fn[1]>bb)&&fr(`${ut.layerIds[0]}: Value for "text-size" is >= ${yb}. Reduce your "text-size".`)),ut.addSymbols(ut.text,cn,fn,Yt,Lt,Xt,vr,pt,wt,Mi.lineStartIndex,Mi.lineLength,Vr,sn,an,ln,!1);for(const pt of br)Ar[pt]=ut.text.placedSymbolArray.length-1;return 4*cn.length}function Jy(ut){for(const pt in ut)return ut[pt];return null}function Qy(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){let vr=Lt.top,br=Lt.bottom,Ar=Lt.left,Vr=Lt.right;const nn=Lt.collisionPadding;if(nn&&(Ar-=nn[0],vr-=nn[1],Vr+=nn[2],br+=nn[3]),Yt){const ut=new xc(Ar,vr),pt=new xc(Vr,vr),wt=new xc(Ar,br),Tt=new xc(Vr,br),St=$e(Yt);let It=new xc(0,0);Mi&&(It=new xc(Mi[0],Mi[1])),ut._rotateAround(St,It),pt._rotateAround(St,It),wt._rotateAround(St,It),Tt._rotateAround(St,It),Ar=Math.min(ut.x,pt.x,wt.x,Tt.x),Vr=Math.max(ut.x,pt.x,wt.x,Tt.x),vr=Math.min(ut.y,pt.y,wt.y,Tt.y),br=Math.max(ut.y,pt.y,wt.y,Tt.y)}return ut.emplaceBack(pt.x,pt.y,pt.z,wt.x,wt.y,Ar,vr,Vr,br,Xt,Tt,St,It),ut.length-1}function tg(ut){ut.collisionPadding&&(ut.top-=ut.collisionPadding[1],ut.bottom+=ut.collisionPadding[3]);const pt=ut.bottom-ut.top;return pt>0?Math.max(10,pt):null}function eg(ut,pt,wt,Tt){const St=ut.compareText;if(pt in St){const ut=St[pt];for(let pt=ut.length-1;pt>=0;pt--)if(Tt.dist(ut[pt])<wt)return!0}else St[pt]=[];return St[pt].push(Tt),!1}function rg(ut,pt){const wt=ut.fovAboveCenter,Tt=ut.elevation?ut.elevation.getMinElevationBelowMSL()*pt:0,St=(ut._camera.position[2]*ut.worldSize-Tt)/Math.cos(ut._pitch),It=Math.sin(wt)*St/Math.sin(Math.max(Math.PI/2-ut._pitch-wt,.01)),Lt=Math.sin(ut._pitch)*It+St;return Math.min(1.01*Lt,St*(1/ut._horizonShift))}function ng(ut,pt){if(!pt.isReprojectedInTileSpace)return{scale:1<<ut.z,x:ut.x,y:ut.y,x2:ut.x+1,y2:ut.y+1,projection:pt};const wt=Math.pow(2,-ut.z),Tt=ut.x*wt,St=(ut.x+1)*wt,It=ut.y*wt,Lt=(ut.y+1)*wt,Xt=Pc(Tt),Yt=Pc(St),Mi=Ec(It),vr=Ec(Lt),br=pt.project(Xt,Mi),Ar=pt.project(Yt,Mi),Vr=pt.project(Yt,vr),nn=pt.project(Xt,vr);let sn=Math.min(br.x,Ar.x,Vr.x,nn.x),an=Math.min(br.y,Ar.y,Vr.y,nn.y),ln=Math.max(br.x,Ar.x,Vr.x,nn.x),cn=Math.max(br.y,Ar.y,Vr.y,nn.y);const un=wt/16;function v(ut,wt,Tt,St,It,Lt){const Xt=(Tt+It)/2,Yt=(St+Lt)/2,Mi=pt.project(Pc(Xt),Ec(Yt)),vr=Math.max(0,sn-Mi.x,an-Mi.y,Mi.x-ln,Mi.y-cn);sn=Math.min(sn,Mi.x),ln=Math.max(ln,Mi.x),an=Math.min(an,Mi.y),cn=Math.max(cn,Mi.y),vr>un&&(v(ut,Mi,Tt,St,Xt,Yt),v(Mi,wt,Xt,Yt,It,Lt))}v(br,Ar,Tt,It,St,It),v(Ar,Vr,St,It,St,Lt),v(Vr,nn,St,Lt,Tt,Lt),v(nn,br,Tt,Lt,Tt,It),sn-=un,an-=un,ln+=un,cn+=un;const fn=1/Math.max(ln-sn,cn-an);return{scale:fn,x:sn*fn,y:an*fn,x2:ln*fn,y2:cn*fn,projection:pt}}function ig(ut,{x:pt,y:wt},Tt=0){return new xc(((pt-Tt)*ut.scale-ut.x)*xf,(wt*ut.scale-ut.y)*xf)}const Eb=ut.ad.identity(new Float32Array(16));class ag{constructor(ut){this.spec=ut,this.name=ut.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(ut,pt){return{x:0,y:0,z:0}}unproject(ut,pt){return new mc(0,0)}projectTilePoint(ut,pt,wt){return{x:ut,y:pt,z:0}}locationPoint(ut,pt,wt=!0){return ut._coordinatePoint(ut.locationCoordinate(pt),wt)}pixelsPerMeter(ut,pt){return zc(1,ut)*pt}pixelSpaceConversion(ut,pt,wt){return 1}farthestPixelDistance(ut){return rg(ut,ut.pixelsPerMeter)}pointCoordinate(ut,pt,wt,Tt){const St=ut.horizonLineFromTop(!1),It=new xc(pt,Math.max(St,wt));return ut.rayIntersectionCoordinate(ut.pointRayIntersection(It,Tt))}pointCoordinate3D(ut,pt,wt){const Tt=new xc(pt,wt);if(ut.elevation)return ut.elevation.pointCoordinate(Tt);{const pt=this.pointCoordinate(ut,Tt.x,Tt.y,0);return[pt.x,pt.y,pt.z]}}isPointAboveHorizon(ut,pt){if(ut.elevation&&ut.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(ut,pt.x,pt.y);const wt=ut.horizonLineFromTop();return pt.y<wt}createInversionMatrix(ut,pt){return Eb}createTileMatrix(pt,wt,Tt){let St,It,Lt;const Xt=Tt.canonical,Yt=ut.ad.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const Mi=ng(Xt,this);St=1,It=Mi.x+Tt.wrap*Mi.scale,Lt=Mi.y,ut.ad.scale(Yt,Yt,[St/Mi.scale,St/Mi.scale,pt.pixelsPerMeter/wt])}else St=wt/pt.zoomScale(Xt.z),It=(Xt.x+Math.pow(2,Xt.z)*Tt.wrap)*St,Lt=Xt.y*St;return ut.ad.translate(Yt,Yt,[It,Lt,0]),ut.ad.scale(Yt,Yt,[St/xf,St/xf,1]),Yt}upVector(ut,pt,wt){return[0,0,1]}upVectorScale(ut,pt,wt){return{metersToTile:1}}}class og extends ag{constructor(ut){super(ut),this.range=[4,7],this.center=ut.center||[-96,37.5];const[pt,wt]=this.parallels=ut.parallels||[29.5,45.5],Tt=Math.sin($e(pt));this.n=(Tt+Math.sin($e(wt)))/2,this.c=1+Tt*(2*this.n-Tt),this.r0=Math.sqrt(this.c)/this.n}project(ut,pt){const{n:wt,c:Tt,r0:St}=this,It=$e(ut-this.center[0]),Lt=$e(pt),Xt=Math.sqrt(Tt-2*wt*Math.sin(Lt))/wt;return{x:Xt*Math.sin(It*wt),y:Xt*Math.cos(It*wt)-St,z:0}}unproject(ut,pt){const{n:wt,c:Tt,r0:St}=this,It=St+pt;let Lt=Math.atan2(ut,Math.abs(It))*Math.sign(It);It*wt<0&&(Lt-=Math.PI*Math.sign(ut)*Math.sign(It));const Xt=$e(this.center[0])*wt;Lt=Je(Lt,-Math.PI-Xt,Math.PI-Xt);const Yt=Ke(Ge(Lt/wt)+this.center[0],-180,180),Mi=Math.asin(Ke((Tt-(ut*ut+It*It)*wt*wt)/(2*wt),-1,1)),vr=Ke(Ge(Mi),-Y_,Y_);return new mc(Yt,vr)}}const Mb=1.340264,Cb=-.081106,Pb=893e-6,Rb=.003796,Db=Math.sqrt(3)/2;class fg extends ag{project(ut,pt){pt=pt/180*Math.PI,ut=ut/180*Math.PI;const wt=Math.asin(Db*Math.sin(pt)),Tt=wt*wt,St=Tt*Tt*Tt;return{x:.5*(ut*Math.cos(wt)/(Db*(Mb+3*Cb*Tt+St*(7*Pb+9*Rb*Tt)))/Math.PI+.5),y:1-.5*(wt*(Mb+Cb*Tt+St*(Pb+Rb*Tt))/Math.PI+1),z:0}}unproject(ut,pt){ut=(2*ut-.5)*Math.PI;let wt=pt=(2*(1-pt)-1)*Math.PI,Tt=wt*wt,St=Tt*Tt*Tt;for(let ut,It,Lt,Xt=0;Xt<12&&(It=wt*(Mb+Cb*Tt+St*(Pb+Rb*Tt))-pt,Lt=Mb+3*Cb*Tt+St*(7*Pb+9*Rb*Tt),ut=It/Lt,wt=Ke(wt-ut,-Math.PI/3,Math.PI/3),Tt=wt*wt,St=Tt*Tt*Tt,!(Math.abs(ut)<1e-12));++Xt);const It=Db*ut*(Mb+3*Cb*Tt+St*(7*Pb+9*Rb*Tt))/Math.cos(wt),Lt=Math.asin(Math.sin(wt)/Db),Xt=Ke(180*It/Math.PI,-180,180),Yt=Ke(180*Lt/Math.PI,-Y_,Y_);return new mc(Xt,Yt)}}class dg extends ag{constructor(ut){super(ut),this.wrap=!0,this.supportsWorldCopies=!0}project(ut,pt){return{x:.5+ut/360,y:.5-pt/360,z:0}}unproject(ut,pt){const wt=360*(ut-.5),Tt=Ke(360*(.5-pt),-Y_,Y_);return new mc(wt,Tt)}}const Bb=Math.PI/2;function yg(ut){return Math.tan((Bb+ut)/2)}class gg extends ag{constructor(ut){super(ut),this.center=ut.center||[0,30];const[pt,wt]=this.parallels=ut.parallels||[30,30];let Tt=$e(pt),St=$e(wt);this.southernCenter=Tt+St<0,this.southernCenter&&(Tt=-Tt,St=-St);const It=Math.cos(Tt),Lt=yg(Tt);this.n=Tt===St?Math.sin(Tt):Math.log(It/Math.cos(St))/Math.log(yg(St)/Lt),this.f=It*Math.pow(yg(Tt),this.n)/this.n}project(ut,pt){pt=$e(pt),this.southernCenter&&(pt=-pt),ut=$e(ut-this.center[0]);const wt=1e-6,{n:Tt,f:St}=this;St>0?pt<-Bb+wt&&(pt=-Bb+wt):pt>Bb-wt&&(pt=Bb-wt);const It=St/Math.pow(yg(pt),Tt);let Lt=It*Math.sin(Tt*ut),Xt=St-It*Math.cos(Tt*ut);return Lt=.5*(Lt/Math.PI+.5),Xt=.5*(Xt/Math.PI+.5),{x:Lt,y:this.southernCenter?Xt:1-Xt,z:0}}unproject(ut,pt){ut=(2*ut-.5)*Math.PI,this.southernCenter&&(pt=1-pt),pt=(2*(1-pt)-.5)*Math.PI;const{n:wt,f:Tt}=this,St=Tt-pt,It=Math.sign(St),Lt=Math.sign(wt)*Math.sqrt(ut*ut+St*St);let Xt=Math.atan2(ut,Math.abs(St))*It;St*wt<0&&(Xt-=Math.PI*Math.sign(ut)*It);const Yt=Ke(Ge(Xt/wt)+this.center[0],-180,180),Mi=Ke(Ge(2*Math.atan(Math.pow(Tt/Lt,1/wt))-Bb),-Y_,Y_);return new mc(Yt,this.southernCenter?-Mi:Mi)}}class xg extends ag{constructor(ut){super(ut),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(ut,pt){return{x:Tc(ut),y:kc(pt),z:0}}unproject(ut,pt){const wt=Pc(ut),Tt=Ec(pt);return new mc(wt,Tt)}}const Vb=$e(Y_);class vg extends ag{project(ut,pt){const wt=(pt=$e(pt))*pt,Tt=wt*wt;return{x:.5*((ut=$e(ut))*(.8707-.131979*wt+Tt*(Tt*(.003971*wt-.001529*Tt)-.013791))/Math.PI+.5),y:1-.5*(pt*(1.007226+wt*(.015085+Tt*(.028874*wt-.044475-.005916*Tt)))/Math.PI+1),z:0}}unproject(ut,pt){ut=(2*ut-.5)*Math.PI;let wt=pt=(2*(1-pt)-1)*Math.PI,Tt=25,St=0,It=wt*wt;do{It=wt*wt;const ut=It*It;St=(wt*(1.007226+It*(.015085+ut*(.028874*It-.044475-.005916*ut)))-pt)/(1.007226+It*(.045255+ut*(.259866*It-.311325-.005916*11*ut))),wt=Ke(wt-St,-Vb,Vb)}while(Math.abs(St)>1e-6&&--Tt>0);It=wt*wt;const Lt=Ke(Ge(ut/(.8707+It*(It*(It*It*It*(.003971-.001529*It)-.013791)-.131979))),-180,180),Xt=Ge(wt);return new mc(Lt,Xt)}}const jb=$e(Y_);class wg extends ag{project(ut,pt){pt=$e(pt),ut=$e(ut);const wt=Math.cos(pt),Tt=2/Math.PI,St=Math.acos(wt*Math.cos(ut/2)),It=Math.sin(St)/St,Lt=.5*(ut*Tt+2*wt*Math.sin(ut/2)/It)||0,Xt=.5*(pt+Math.sin(pt)/It)||0;return{x:.5*(Lt/Math.PI+.5),y:1-.5*(Xt/Math.PI+1),z:0}}unproject(ut,pt){let wt=ut=(2*ut-.5)*Math.PI,Tt=pt=(2*(1-pt)-1)*Math.PI,St=25;const It=1e-6;let Lt=0,Xt=0;do{const St=Math.cos(Tt),It=Math.sin(Tt),Yt=2*It*St,Mi=It*It,vr=St*St,br=Math.cos(wt/2),Ar=Math.sin(wt/2),Vr=2*br*Ar,nn=Ar*Ar,sn=1-vr*br*br,an=sn?1/sn:0,ln=sn?Math.acos(St*br)*Math.sqrt(1/sn):0,cn=.5*(2*ln*St*Ar+2*wt/Math.PI)-ut,un=.5*(ln*It+Tt)-pt,fn=.5*an*(vr*nn+ln*St*br*Mi)+1/Math.PI,_n=an*(Vr*Yt/4-ln*It*Ar),gn=.125*an*(Yt*Ar-ln*It*vr*Vr),yn=.5*an*(Mi*br+ln*nn*St)+.5,xn=_n*gn-yn*fn;Lt=(un*_n-cn*yn)/xn,Xt=(cn*gn-un*fn)/xn,wt=Ke(wt-Lt,-Math.PI,Math.PI),Tt=Ke(Tt-Xt,-jb,jb)}while((Math.abs(Lt)>It||Math.abs(Xt)>It)&&--St>0);return new mc(Ge(wt),Ge(Tt))}}class Mg extends ag{constructor(ut){super(ut),this.center=ut.center||[0,0],this.parallels=ut.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos($e(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(ut,pt){const{scale:wt,cosPhi:Tt}=this;return{x:$e(ut)*Tt*wt+.5,y:-Math.sin($e(pt))/Tt*wt+.5,z:0}}unproject(ut,pt){const{scale:wt,cosPhi:Tt}=this,St=-(pt-.5)/wt,It=Ke(Ge((ut-.5)/wt)/Tt,-180,180),Lt=Math.asin(Ke(St*Tt,-1,1)),Xt=Ke(Ge(Lt),-Y_,Y_);return new mc(It,Xt)}}class Ag extends xg{constructor(ut){super(ut),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(pt,wt,Tt){const St=Nh(pt,wt,Tt),It=$h(Ch(Tt));return ut._.transformMat4(St,St,It),{x:St[0],y:St[1],z:St[2]}}locationPoint(pt,wt){const Tt=pc(wt.lat,wt.lng),St=ut._.normalize([],Tt),It=pt.elevation?pt.elevation.getAtPointOrZero(pt.locationCoordinate(wt),pt._centerAltitude):pt._centerAltitude,Lt=zc(1,0)*xf*It;ut._.scaleAndAdd(Tt,Tt,St,Lt);const Xt=ut.ad.identity(new Float64Array(16));return ut.ad.multiply(Xt,pt.pixelMatrix,pt.globeMatrix),ut._.transformMat4(Tt,Tt,Xt),new xc(Tt[0],Tt[1])}pixelsPerMeter(ut,pt){return zc(1,0)*pt}pixelSpaceConversion(ut,pt,wt){const Tt=zc(1,ut)*pt,St=Gn(zc(1,45)*pt,Tt,wt);return this.pixelsPerMeter(ut,pt)/St}createTileMatrix(pt,wt,Tt){const St=Gh(Ch(Tt.canonical));return ut.ad.multiply(new Float64Array(16),pt.globeMatrix,St)}createInversionMatrix(pt,wt){const{center:Tt}=pt,St=$h(Ch(wt));return ut.ad.rotateY(St,St,$e(Tt.lng)),ut.ad.rotateX(St,St,$e(Tt.lat)),ut.ad.scale(St,St,[pt._pixelsPerMercatorPixel,pt._pixelsPerMercatorPixel,1]),Float32Array.from(St)}pointCoordinate(ut,pt,wt,Tt){return Eh(ut,pt,wt,!0)||new Lc(0,0)}pointCoordinate3D(ut,pt,wt){const Tt=this.pointCoordinate(ut,pt,wt,0);return[Tt.x,Tt.y,Tt.z]}isPointAboveHorizon(ut,pt){return!Eh(ut,pt.x,pt.y,!1)}farthestPixelDistance(pt){const wt=function(pt,wt){const Tt=pt.cameraToCenterDistance,St=pt._centerAltitude*wt,It=pt._camera,Lt=pt._camera.forward(),Xt=ut._.add([],ut._.scale([],Lt,-Tt),[0,0,St]),Yt=pt.worldSize/(2*Math.PI),Mi=[0,0,-Yt],vr=pt.width/pt.height,br=Math.tan(pt.fovAboveCenter),Ar=ut._.scale([],It.up(),br),Vr=ut._.scale([],It.right(),br*vr),nn=ut._.normalize([],ut._.add([],ut._.add([],Lt,Ar),Vr)),sn=[];let an;if(new gh(Xt,nn).closestPointOnSphere(Mi,Yt,sn)){const wt=ut._.add([],sn,Mi),Tt=ut._.sub([],wt,Xt);an=Math.cos(pt.fovAboveCenter)*ut._.length(Tt)}else{const pt=ut._.sub([],Xt,Mi),wt=ut._.sub([],Mi,Xt);ut._.normalize(wt,wt);const Tt=ut._.length(pt)-Yt;an=Math.sqrt(Tt*(Tt+2*Yt));const St=Math.acos(an/(Yt+Tt))-Math.acos(ut._.dot(Lt,wt));an*=Math.cos(St)}return 1.01*an}(pt,this.pixelsPerMeter(pt.center.lat,pt.worldSize)),Tt=Hh(pt.zoom);if(Tt>0){const ut=rg(pt,zc(1,pt.center.lat)*pt.worldSize),St=pt.worldSize/(2*Math.PI),It=Math.max(pt.width,pt.height)/pt.worldSize*Math.PI;return Gn(wt,ut+St*(1-Math.cos(It)),Math.pow(Tt,10))}return wt}upVector(ut,pt,wt){return Nh(pt,wt,ut,1)}upVectorScale(ut){return{metersToTile:zh(jh(Ch(ut)))}}}function Sg(ut){const pt=ut.parallels,wt=!!pt&&Math.abs(pt[0]+pt[1])<.01;switch(ut.name){case"mercator":return new xg(ut);case"equirectangular":return new dg(ut);case"naturalEarth":return new vg(ut);case"equalEarth":return new fg(ut);case"winkelTripel":return new wg(ut);case"albers":return wt?new Mg(ut):new og(ut);case"lambertConformalConic":return wt?new Mg(ut):new gg(ut);case"globe":return new Ag(ut)}throw new Error(`Invalid projection name: ${ut.name}`)}class Ig{constructor(ut,pt,wt,Tt){this.id=Ig.uniqueIdxCounter,Ig.uniqueIdxCounter++,this.context=ut;const St=ut.gl;this.buffer=St.createBuffer(),this.dynamicDraw=Boolean(wt),this.context.unbindVAO(),ut.bindElementBuffer.set(this.buffer),St.bufferData(St.ELEMENT_ARRAY_BUFFER,pt.arrayBuffer,this.dynamicDraw?St.DYNAMIC_DRAW:St.STATIC_DRAW),this.dynamicDraw||Tt||pt.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(ut){this.id=Ig.uniqueIdxCounter,Ig.uniqueIdxCounter++;const pt=this.context.gl;this.context.unbindVAO(),this.bind(),pt.bufferSubData(pt.ELEMENT_ARRAY_BUFFER,0,ut.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Ig.uniqueIdxCounter=0;class Tg{constructor(ut,pt,wt){this.func=ut,this.mask=pt,this.range=wt}}Tg.ReadOnly=!1,Tg.ReadWrite=!0,Tg.disabled=new Tg(519,Tg.ReadOnly,[0,1]);const Gb=7680;class zg{constructor(ut,pt,wt,Tt,St,It){this.test=ut,this.ref=pt,this.mask=wt,this.fail=Tt,this.depthFail=St,this.pass=It}}zg.disabled=new zg({func:519,mask:0},0,0,Gb,Gb,Gb);const qb=771;class Eg{constructor(ut,pt,wt,Tt){this.blendFunction=ut,this.blendColor=pt,this.mask=wt,this.blendEquation=Tt}}Eg.Replace=[1,0,1,0],Eg.disabled=new Eg(Eg.Replace,qn.transparent,[!1,!1,!1,!1]),Eg.unblended=new Eg(Eg.Replace,qn.transparent,[!0,!0,!0,!0]),Eg.alphaBlended=new Eg([1,qb,1,qb],qn.transparent,[!0,!0,!0,!0]),Eg.alphaBlendedNonPremultiplied=new Eg([770,qb,770,qb],qn.transparent,[!0,!0,!0,!0]),Eg.multiply=new Eg([774,0,774,0],qn.transparent,[!0,!0,!0,!0]);const $b=1029,ew=2305;class Cg{constructor(ut,pt,wt){this.enable=ut,this.mode=pt,this.frontFace=wt}}Cg.disabled=new Cg(!1,$b,ew),Cg.backCCW=new Cg(!0,$b,ew),Cg.backCW=new Cg(!0,$b,2304),Cg.frontCW=new Cg(!0,1028,2304),Cg.frontCCW=new Cg(!0,1028,ew);const tw=rx.types,iw=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Fg(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar){const Vr=Xt?Math.min(bb,Math.round(Xt[0])):0,nn=Xt?Math.min(bb,Math.round(Xt[1])):0;ut.emplaceBack(pt,wt,Math.round(32*Tt),Math.round(32*St),It,Lt,(Vr<<1)+(Yt?1:0),nn,16*Mi,16*vr,256*br,256*Ar)}function Lg(ut,pt,wt){ut.emplaceBack(pt,wt)}function Og(ut,pt,wt,Tt,St,It,Lt){ut.emplaceBack(pt,wt,Tt,St,It,Lt)}function Ug(ut,pt,wt,Tt,St){ut.emplaceBack(pt,wt,Tt,St),ut.emplaceBack(pt,wt,Tt,St),ut.emplaceBack(pt,wt,Tt,St),ut.emplaceBack(pt,wt,Tt,St)}function Ng(ut){for(const pt of ut.sections)if(Vo(pt.text))return!0;return!1}class jg{constructor(ut){this.layoutVertexArray=new $l,this.indexArray=new Ql,this.programConfigurations=ut,this.segments=new Au,this.dynamicLayoutVertexArray=new Ol,this.opacityVertexArray=new Xl,this.occlusionQueryOpacityVertexArray=new Yl,this.placedSymbolArray=new du,this.iconTransitioningVertexArray=new Zl,this.globeExtVertexArray=new Gl,this.zOffsetVertexArray=new Yl}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(ut,pt,wt,Tt,St){this.isEmpty()||(wt&&(this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,Rx.members),this.indexBuffer=ut.createIndexBuffer(this.indexArray,pt),this.dynamicLayoutVertexBuffer=ut.createVertexBuffer(this.dynamicLayoutVertexArray,kx.members,!0),this.opacityVertexBuffer=ut.createVertexBuffer(this.opacityVertexArray,iw,!0),this.occlusionQueryOpacityVertexBuffer=ut.createVertexBuffer(this.occlusionQueryOpacityVertexArray,Ox.members,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=ut.createVertexBuffer(this.iconTransitioningVertexArray,Vx.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=ut.createVertexBuffer(this.globeExtVertexArray,Dx.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||St)&&(this.zOffsetVertexBuffer=ut.createVertexBuffer(this.zOffsetVertexArray,Fx.members,!0)),this.opacityVertexBuffer.itemSize=1),(wt||Tt)&&this.programConfigurations.upload(ut))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.occlusionQueryOpacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Mo(jg,"SymbolBuffers");class qg{constructor(ut,pt,wt){this.layoutVertexArray=new ut,this.layoutAttributes=pt,this.indexArray=new wt,this.segments=new Au,this.collisionVertexArray=new Jl,this.collisionVertexArrayExt=new Ol}upload(ut){this.layoutVertexBuffer=ut.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=ut.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=ut.createVertexBuffer(this.collisionVertexArray,Ux.members,!0),this.collisionVertexBufferExt=ut.createVertexBuffer(this.collisionVertexArrayExt,Kx.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Mo(qg,"CollisionBuffers");class $g{constructor(pt){this.queries=new Map,this.collisionBoxArray=pt.collisionBoxArray,this.zoom=pt.zoom,this.lut=pt.lut,this.overscaling=pt.overscaling,this.layers=pt.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.index=pt.index,this.pixelRatio=pt.pixelRatio,this.sourceLayerIndex=pt.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ut.ad.identity([]),this.placementViewportMatrix=ut.ad.identity([]);const wt=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Nm(this.zoom,wt["text-size"]),this.iconSizeData=Nm(this.zoom,wt["icon-size"]);const Tt=this.layers[0].layout,St=Tt.get("symbol-sort-key"),It=Tt.get("symbol-z-order");this.canOverlap=Tt.get("text-allow-overlap")||Tt.get("icon-allow-overlap")||Tt.get("text-ignore-placement")||Tt.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==It&&void 0!==St.constantOr(1),this.sortFeaturesByY=("viewport-y"===It||"auto"===It&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=Tt.get("text-writing-mode").map((ut=>Jv[ut])),this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.sourceID=pt.sourceID,this.projection=pt.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=Tt.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new jg(new Wu(this.layers,{zoom:this.zoom,lut:this.lut},(ut=>/^text/.test(ut)))),this.icon=new jg(new Wu(this.layers,{zoom:this.zoom,lut:this.lut},(ut=>/^icon/.test(ut)))),this.glyphOffsetArray=new gu,this.lineVertexArray=new xu,this.symbolInstances=new yu}calculateGlyphDependencies(ut,pt,wt,Tt,St){for(let wt=0;wt<ut.length;wt++){const It=ut.codePointAt(wt);if(void 0===It)break;if(pt[It]=!0,Tt&&St&&It<=65535){const Tt=Nv[ut.charAt(wt)];Tt&&(pt[Tt.charCodeAt(0)]=!0)}}}updateFootprints(ut,pt){}updateReplacement(ut,pt){if(pt.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=pt.updateTime;const wt=pt.getReplacementRegionsForTile(ut.toUnwrapped(),!0);return!Cf(this.activeReplacements,wt)&&(this.activeReplacements=wt,!0)}populate(pt,wt,Tt,St){const It=this.layers[0],Lt=It.layout,Xt="globe"===this.projection.name,Yt=Lt.get("text-font"),Mi=Lt.get("text-field"),vr=Lt.get("icon-image"),br=("constant"!==Mi.value.kind||Mi.value.value instanceof mi&&!Mi.value.value.isEmpty()||Mi.value.value.toString().length>0)&&("constant"!==Yt.value.kind||Yt.value.value.length>0),Ar="constant"!==vr.value.kind||!!vr.value.value||Object.keys(vr.parameters).length>0,Vr=Lt.get("symbol-sort-key");if(this.features=[],!br&&!Ar)return;const nn=wt.iconDependencies,sn=wt.glyphDependencies,an=wt.availableImages,ln=new Ho(this.zoom);for(const{feature:wt,id:Mi,index:vr,sourceLayerIndex:cn}of pt){const pt=It._featureFilter.needGeometry,un=Yc(wt,pt);if(!It._featureFilter.filter(ln,un,Tt))continue;if(pt||(un.geometry=Xc(wt,Tt,St)),Xt&&1!==wt.type&&Tt.z<=5){const pt=un.geometry,wt=.98078528056,i=(pt,St)=>{const It=Nh(pt.x,pt.y,Tt,1),Lt=Nh(St.x,St.y,Tt,1);return ut._.dot(It,Lt)<wt};for(let ut=0;ut<pt.length;ut++)pt[ut]=jc(pt[ut],i)}let fn,_n;if(br){const ut=It.getValueAndResolveTokens("text-field",un,Tt,an),pt=mi.factory(ut);Ng(pt)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Xo()||this.hasRTLText&&y_.isParsed())&&(fn=Gm(pt,It,un))}if(Ar){const ut=It.getValueAndResolveTokens("icon-image",un,Tt,an);_n=ut instanceof yi?ut:yi.fromString(ut)}if(!fn&&!_n)continue;const gn=this.sortFeaturesByKey?Vr.evaluate(un,{},Tt):void 0;if(this.features.push({id:Mi,text:fn,icon:_n,index:vr,sourceLayerIndex:cn,geometry:un.geometry,properties:wt.properties,type:tw[wt.type],sortKey:gn}),_n&&(nn[_n.namePrimary]=!0,_n.nameSecondary&&(nn[_n.nameSecondary]=!0)),fn){const ut=Yt.evaluate(un,{},Tt).join(","),pt="map"===Lt.get("text-rotation-alignment")&&"point"!==Lt.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Jv.vertical)>=0;for(const wt of fn.sections)if(wt.image)nn[wt.image.namePrimary]=!0;else{const Tt=zo(fn.toString()),St=wt.fontStack||ut,It=sn[St]=sn[St]||{};this.calculateGlyphDependencies(wt.text,It,pt,this.allowVerticalPlacement,Tt)}}}"line"===Lt.get("symbol-placement")&&(this.features=function(ut){const pt={},wt={},Tt=[];let St=0;function s(pt){Tt.push(ut[pt]),St++}function a(ut,pt,St){const It=wt[ut];return delete wt[ut],wt[pt]=It,Tt[It].geometry[0].pop(),Tt[It].geometry[0]=Tt[It].geometry[0].concat(St[0]),It}function o(ut,wt,St){const It=pt[wt];return delete pt[wt],pt[ut]=It,Tt[It].geometry[0].shift(),Tt[It].geometry[0]=St[0].concat(Tt[It].geometry[0]),It}function l(ut,pt,wt){const Tt=wt?pt[0][pt[0].length-1]:pt[0][0];return`${ut}:${Tt.x}:${Tt.y}`}for(let It=0;It<ut.length;It++){const Lt=ut[It],Xt=Lt.geometry,Yt=Lt.text?Lt.text.toString():null;if(!Yt){s(It);continue}const Mi=l(Yt,Xt),vr=l(Yt,Xt,!0);if(Mi in wt&&vr in pt&&wt[Mi]!==pt[vr]){const ut=o(Mi,vr,Xt),St=a(Mi,vr,Tt[ut].geometry);delete pt[Mi],delete wt[vr],wt[l(Yt,Tt[St].geometry,!0)]=St,Tt[ut].geometry=null}else Mi in wt?a(Mi,vr,Xt):vr in pt?o(Mi,vr,Xt):(s(It),pt[Mi]=St-1,wt[vr]=St-1)}return Tt.filter((ut=>ut.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((ut,pt)=>ut.sortKey-pt.sortKey))}update(ut,pt,wt,Tt,St){const It=0!==Object.keys(ut).length;if(It&&!this.stateDependentLayers.length)return;const Lt=It?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(ut,pt,Lt,wt,Tt,St),this.icon.programConfigurations.updatePaintArrays(ut,pt,Lt,wt,Tt,St)}updateOcclusionOpacities(ut,pt,wt){if(!pt.useOcclusionQueries)return!1;const Tt=this;if("globe"===Tt.projection.name)return!1;let St=!1;Tt.hasTextData()&&(St=St||0!==Tt.text.occlusionQueryOpacityVertexArray.length),Tt.hasIconData()&&(St=St||0!==Tt.icon.occlusionQueryOpacityVertexArray.length);const It=Tt.layers[0].paint,Lt=It.get("icon-occlusion-opacity").constantOr(0),Xt=It.get("text-occlusion-opacity").constantOr(0);if(!Tt.layers[0].hasInitialOcclusionOpacityProperties||1===Lt&&1===Xt)return!1;let Yt=!St;for(let ut=0;ut<Tt.symbolInstances.length;ut++){const St=Tt.symbolInstances.get(ut),It=St.occlusionOpacity;St.occlusionOpacity+=(St.occlusionState>.5?1:-1)*pt.fadeSpeed*wt*.001,St.occlusionOpacity=Ke(St.occlusionOpacity,0,1),Yt=Yt||St.occlusionOpacity!==It}if(!Yt)return!1;let Mi=0,vr=0;const h=(ut,pt,wt,Tt)=>{let St=0,It=0;wt?(St=vr,vr+=Tt,It=vr):(St=Mi,Mi+=Tt,It=Mi),It>pt.occlusionQueryOpacityVertexArray.length&&pt.occlusionQueryOpacityVertexArray.resize(It);const Lt=ut.occlusionOpacity;for(let ut=0;ut<Tt;ut++)pt.occlusionQueryOpacityVertexArray.emplace(ut+St,Lt)};for(let ut=0;ut<Tt.symbolInstances.length;ut++){const pt=Tt.symbolInstances.get(ut),{numHorizontalGlyphVertices:wt,numVerticalGlyphVertices:St,numIconVertices:It}=pt,Lt=It>0;if((wt>0||St>0)&&(h(pt,Tt.text,!1,wt),h(pt,Tt.text,!1,St)),Lt){const{placedIconSymbolIndex:ut,verticalPlacedIconSymbolIndex:wt}=pt;ut>=0&&h(pt,Tt.icon,!0,It),wt>=0&&h(pt,Tt.icon,!0,pt.numVerticalIconVertices)}}return Tt.hasTextData()&&Tt.text.occlusionQueryOpacityVertexBuffer&&(Tt.text.occlusionQueryOpacityVertexBuffer.length<Tt.text.occlusionQueryOpacityVertexArray.length?Tt.text.occlusionQueryOpacityVertexBuffer=ut.createVertexBuffer(Tt.text.occlusionQueryOpacityVertexArray,Ox.members,!0):Tt.text.occlusionQueryOpacityVertexBuffer.updateData(Tt.text.occlusionQueryOpacityVertexArray)),Tt.hasIconData()&&Tt.icon.occlusionQueryOpacityVertexBuffer&&(Tt.icon.occlusionQueryOpacityVertexBuffer.length<Tt.icon.occlusionQueryOpacityVertexArray.length?Tt.icon.occlusionQueryOpacityVertexBuffer=ut.createVertexBuffer(Tt.icon.occlusionQueryOpacityVertexArray,Ox.members,!0):Tt.icon.occlusionQueryOpacityVertexBuffer.updateData(Tt.icon.occlusionQueryOpacityVertexArray)),!0}updateZOffset(){const t=(pt,wt,Tt)=>{ut+=wt,ut>pt.length&&pt.resize(ut);for(let St=-wt;St<0;St++)pt.emplace(St+ut,Tt)},e=(ut,wt,Tt)=>{pt+=wt,pt>ut.length&&ut.resize(pt);for(let St=-wt;St<0;St++)ut.emplace(St+pt,Tt)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let ut=0,pt=0;for(let ut=0;ut<this.symbolInstances.length;ut++){const pt=this.symbolInstances.get(ut),{numHorizontalGlyphVertices:wt,numVerticalGlyphVertices:Tt,numIconVertices:St}=pt,It=pt.zOffset,Lt=St>0;if((wt>0||Tt>0)&&(t(this.text.zOffsetVertexArray,wt,It),t(this.text.zOffsetVertexArray,Tt,It)),Lt){const{placedIconSymbolIndex:ut,verticalPlacedIconSymbolIndex:wt}=pt;ut>=0&&e(this.icon.zOffsetVertexArray,St,It),wt>=0&&e(this.icon.zOffsetVertexArray,pt.numVerticalIconVertices,It)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(ut){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(ut),this.iconCollisionBox.upload(ut)),this.text.upload(ut,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(ut,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Sg(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData();for(const ut of this.queries.values())ut.destroy()}addToLineVertexArray(ut,pt){const wt=this.lineVertexArray.length;if(void 0!==ut.segment)for(const{x:ut,y:wt}of pt)this.lineVertexArray.emplaceBack(ut,wt);return{lineStartIndex:wt,lineLength:this.lineVertexArray.length-wt}}addSymbols(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){const an=ut.indexArray,ln=ut.layoutVertexArray,cn=ut.globeExtVertexArray,un=ut.segments.prepareSegment(4*pt.length,ln,an,this.canOverlap?It.sortKey:void 0),fn=this.glyphOffsetArray.length,_n=un.vertexLength,gn=this.allowVerticalPlacement&&Lt===Jv.vertical?Math.PI/2:0,yn=It.text&&It.text.sections;for(let Tt=0;Tt<pt.length;Tt++){const{tl:St,tr:Lt,bl:Mi,br:vr,texPrimary:br,texSecondary:fn,pixelOffsetTL:_n,pixelOffsetBR:xn,minFontScaleX:vn,minFontScaleY:bn,glyphOffset:wn,isSDF:Tn,sectionIndex:En}=pt[Tt],Mn=un.vertexLength,Sn=wn[1];if(Fg(ln,Yt.x,Yt.y,St.x,Sn+St.y,br.x,br.y,wt,Tn,_n.x,_n.y,vn,bn),Fg(ln,Yt.x,Yt.y,Lt.x,Sn+Lt.y,br.x+br.w,br.y,wt,Tn,xn.x,_n.y,vn,bn),Fg(ln,Yt.x,Yt.y,Mi.x,Sn+Mi.y,br.x,br.y+br.h,wt,Tn,_n.x,xn.y,vn,bn),Fg(ln,Yt.x,Yt.y,vr.x,Sn+vr.y,br.x+br.w,br.y+br.h,wt,Tn,xn.x,xn.y,vn,bn),Xt){const{x:pt,y:wt,z:Tt}=Xt.anchor,[St,It,Lt]=Xt.up;Og(cn,pt,wt,Tt,St,It,Lt),Og(cn,pt,wt,Tt,St,It,Lt),Og(cn,pt,wt,Tt,St,It,Lt),Og(cn,pt,wt,Tt,St,It,Lt),Ug(ut.dynamicLayoutVertexArray,pt,wt,Tt,gn)}else Ug(ut.dynamicLayoutVertexArray,Yt.x,Yt.y,Yt.z,gn);if(sn){const pt=fn||br;Lg(ut.iconTransitioningVertexArray,pt.x,pt.y),Lg(ut.iconTransitioningVertexArray,pt.x+pt.w,pt.y),Lg(ut.iconTransitioningVertexArray,pt.x,pt.y+pt.h),Lg(ut.iconTransitioningVertexArray,pt.x+pt.w,pt.y+pt.h)}an.emplaceBack(Mn,Mn+1,Mn+2),an.emplaceBack(Mn+1,Mn+2,Mn+3),un.vertexLength+=4,un.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(wn[0]),Tt!==pt.length-1&&En===pt[Tt+1].sectionIndex||ut.programConfigurations.populatePaintArrays(ln.length,It,It.index,{},Ar,Vr,nn,yn&&yn[En])}const xn=Xt?Xt.anchor:Yt;ut.placedSymbolArray.emplaceBack(xn.x,xn.y,xn.z,Yt.x,Yt.y,fn,this.glyphOffsetArray.length-fn,_n,Mi,vr,Yt.segment,wt?wt[0]:0,wt?wt[1]:0,Tt[0],Tt[1],Lt,0,!1,0,br,0)}_commitLayoutVertex(ut,pt,wt,Tt,St,It,Lt){ut.emplaceBack(pt,wt,Tt,St,It,Math.round(Lt.x),Math.round(Lt.y))}_addCollisionDebugVertices(ut,pt,wt,Tt,St,It,Lt){const Xt=wt.segments.prepareSegment(4,wt.layoutVertexArray,wt.indexArray),Yt=Xt.vertexLength,Mi=Lt.tileAnchorX,vr=Lt.tileAnchorY;for(let ut=0;ut<4;ut++)wt.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(wt.collisionVertexArrayExt,pt,ut.padding,Lt.zOffset),this._commitLayoutVertex(wt.layoutVertexArray,Tt,St,It,Mi,vr,new xc(ut.x1,ut.y1)),this._commitLayoutVertex(wt.layoutVertexArray,Tt,St,It,Mi,vr,new xc(ut.x2,ut.y1)),this._commitLayoutVertex(wt.layoutVertexArray,Tt,St,It,Mi,vr,new xc(ut.x2,ut.y2)),this._commitLayoutVertex(wt.layoutVertexArray,Tt,St,It,Mi,vr,new xc(ut.x1,ut.y2)),Xt.vertexLength+=4;const br=wt.indexArray;br.emplaceBack(Yt,Yt+1),br.emplaceBack(Yt+1,Yt+2),br.emplaceBack(Yt+2,Yt+3),br.emplaceBack(Yt+3,Yt),Xt.primitiveLength+=4}_addTextDebugCollisionBoxes(ut,pt,wt,Tt,St,It){for(let Lt=Tt;Lt<St;Lt++){const Tt=wt.get(Lt),St=this.getSymbolInstanceTextSize(ut,It,pt,Lt);this._addCollisionDebugVertices(Tt,St,this.textCollisionBox,Tt.projectedAnchorX,Tt.projectedAnchorY,Tt.projectedAnchorZ,It)}}_addIconDebugCollisionBoxes(ut,pt,wt,Tt,St,It){for(let Lt=Tt;Lt<St;Lt++){const Tt=wt.get(Lt),St=this.getSymbolInstanceIconSize(ut,pt,It.placedIconSymbolIndex);this._addCollisionDebugVertices(Tt,St,this.iconCollisionBox,Tt.projectedAnchorX,Tt.projectedAnchorY,Tt.projectedAnchorZ,It)}}generateCollisionDebugBuffers(ut,pt){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new qg(Kl,Jx.members,Zl),this.iconCollisionBox=new qg(Kl,Jx.members,Zl);const wt=qm(this.iconSizeData,ut),Tt=qm(this.textSizeData,ut);for(let St=0;St<this.symbolInstances.length;St++){const It=this.symbolInstances.get(St);this._addTextDebugCollisionBoxes(Tt,ut,pt,It.textBoxStartIndex,It.textBoxEndIndex,It),this._addTextDebugCollisionBoxes(Tt,ut,pt,It.verticalTextBoxStartIndex,It.verticalTextBoxEndIndex,It),this._addIconDebugCollisionBoxes(wt,ut,pt,It.iconBoxStartIndex,It.iconBoxEndIndex,It),this._addIconDebugCollisionBoxes(wt,ut,pt,It.verticalIconBoxStartIndex,It.verticalIconBoxEndIndex,It)}}getSymbolInstanceTextSize(ut,pt,wt,Tt){const St=this.text.placedSymbolArray.get(pt.rightJustifiedTextSymbolIndex>=0?pt.rightJustifiedTextSymbolIndex:pt.centerJustifiedTextSymbolIndex>=0?pt.centerJustifiedTextSymbolIndex:pt.leftJustifiedTextSymbolIndex>=0?pt.leftJustifiedTextSymbolIndex:pt.verticalPlacedTextSymbolIndex>=0?pt.verticalPlacedTextSymbolIndex:Tt),It=jm(this.textSizeData,ut,St)/wv;return this.tilePixelRatio*It}getSymbolInstanceIconSize(ut,pt,wt){const Tt=this.icon.placedSymbolArray.get(wt),St=jm(this.iconSizeData,ut,Tt);return this.tilePixelRatio*St}_commitDebugCollisionVertexUpdate(ut,pt,wt,Tt){ut.emplaceBack(pt,-wt,-wt,Tt),ut.emplaceBack(pt,wt,-wt,Tt),ut.emplaceBack(pt,wt,wt,Tt),ut.emplaceBack(pt,-wt,wt,Tt)}_updateTextDebugCollisionBoxes(ut,pt,wt,Tt,St,It){for(let Lt=Tt;Lt<St;Lt++){const Tt=wt.get(Lt),St=this.getSymbolInstanceTextSize(ut,It,pt,Lt);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,St,Tt.padding,It.zOffset)}}_updateIconDebugCollisionBoxes(ut,pt,wt,Tt,St,It){for(let Lt=Tt;Lt<St;Lt++){const Tt=wt.get(Lt),St=this.getSymbolInstanceIconSize(ut,pt,It.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,St,Tt.padding,It.zOffset)}}updateCollisionDebugBuffers(ut,pt){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const wt=qm(this.iconSizeData,ut),Tt=qm(this.textSizeData,ut);for(let St=0;St<this.symbolInstances.length;St++){const It=this.symbolInstances.get(St);this._updateTextDebugCollisionBoxes(Tt,ut,pt,It.textBoxStartIndex,It.textBoxEndIndex,It),this._updateTextDebugCollisionBoxes(Tt,ut,pt,It.verticalTextBoxStartIndex,It.verticalTextBoxEndIndex,It),this._updateIconDebugCollisionBoxes(wt,ut,pt,It.iconBoxStartIndex,It.iconBoxEndIndex,It),this._updateIconDebugCollisionBoxes(wt,ut,pt,It.verticalIconBoxStartIndex,It.verticalIconBoxEndIndex,It)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi={};if(pt<wt){const{x1:wt,y1:Tt,x2:St,y2:It,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar,featureIndex:Vr}=ut.get(pt);Mi.textBox={x1:wt,y1:Tt,x2:St,y2:It,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar},Mi.textFeatureIndex=Vr}if(Tt<St){const{x1:pt,y1:wt,x2:St,y2:It,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar,featureIndex:Vr}=ut.get(Tt);Mi.verticalTextBox={x1:pt,y1:wt,x2:St,y2:It,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar},Mi.verticalTextFeatureIndex=Vr}if(It<Lt){const{x1:pt,y1:wt,x2:Tt,y2:St,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar,featureIndex:Vr}=ut.get(It);Mi.iconBox={x1:pt,y1:wt,x2:Tt,y2:St,padding:Lt,projectedAnchorX:Xt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar},Mi.iconFeatureIndex=Vr}if(Xt<Yt){const{x1:pt,y1:wt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar,featureIndex:Vr}=ut.get(Xt);Mi.verticalIconBox={x1:pt,y1:wt,x2:Tt,y2:St,padding:It,projectedAnchorX:Lt,projectedAnchorY:Yt,projectedAnchorZ:vr,tileAnchorX:br,tileAnchorY:Ar},Mi.verticalIconFeatureIndex=Vr}return Mi}deserializeCollisionBoxes(ut){this.collisionArrays=[];for(let pt=0;pt<this.symbolInstances.length;pt++){const wt=this.symbolInstances.get(pt);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(ut,wt.textBoxStartIndex,wt.textBoxEndIndex,wt.verticalTextBoxStartIndex,wt.verticalTextBoxEndIndex,wt.iconBoxStartIndex,wt.iconBoxEndIndex,wt.verticalIconBoxStartIndex,wt.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(ut,pt){const wt=ut.placedSymbolArray.get(pt),Tt=wt.vertexStartIndex+4*wt.numGlyphs;for(let pt=wt.vertexStartIndex;pt<Tt;pt+=4)ut.indexArray.emplaceBack(pt,pt+1,pt+2),ut.indexArray.emplaceBack(pt+1,pt+2,pt+3)}getSortedSymbolIndexes(ut){if(this.sortedAngle===ut&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const pt=Math.sin(ut),wt=Math.cos(ut),Tt=[],St=[],It=[];for(let ut=0;ut<this.symbolInstances.length;++ut){It.push(ut);const Lt=this.symbolInstances.get(ut);Tt.push(0|Math.round(pt*Lt.tileAnchorX+wt*Lt.tileAnchorY)),St.push(Lt.featureIndex)}return It.sort(((ut,pt)=>Tt[ut]-Tt[pt]||St[pt]-St[ut])),It}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let ut=0;ut<this.symbolInstances.length;++ut)this.symbolInstanceIndexesSortedZOffset.push(ut)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((ut,pt)=>this.symbolInstances.get(pt).zOffset-this.symbolInstances.get(ut).zOffset))}addToSortKeyRanges(ut,pt){const wt=this.sortKeyRanges[this.sortKeyRanges.length-1];wt&&wt.sortKey===pt?wt.symbolInstanceEnd=ut+1:this.sortKeyRanges.push({sortKey:pt,symbolInstanceStart:ut,symbolInstanceEnd:ut+1})}sortFeatures(ut){if(this.sortFeaturesByY&&this.sortedAngle!==ut&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(ut),this.sortedAngle=ut,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const ut of this.symbolInstanceIndexes){const pt=this.symbolInstances.get(ut);this.featureSortOrder.push(pt.featureIndex);const{rightJustifiedTextSymbolIndex:wt,centerJustifiedTextSymbolIndex:Tt,leftJustifiedTextSymbolIndex:St,verticalPlacedTextSymbolIndex:It,placedIconSymbolIndex:Lt,verticalPlacedIconSymbolIndex:Xt}=pt;wt>=0&&this.addIndicesForPlacedSymbol(this.text,wt),Tt>=0&&Tt!==wt&&this.addIndicesForPlacedSymbol(this.text,Tt),St>=0&&St!==Tt&&St!==wt&&this.addIndicesForPlacedSymbol(this.text,St),It>=0&&this.addIndicesForPlacedSymbol(this.text,It),Lt>=0&&this.addIndicesForPlacedSymbol(this.icon,Lt),Xt>=0&&this.addIndicesForPlacedSymbol(this.icon,Xt)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Mo($g,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),$g.addDynamicAttributes=Ug;class Gg{constructor(ut,pt,wt,Tt){this.context=ut,this.format=wt,this.texture=ut.gl.createTexture(),this.update(pt,Tt)}update(ut,pt,wt){const{width:Tt,height:St}=ut,{context:It}=this,{gl:Lt}=It;if(Lt.bindTexture(Lt.TEXTURE_2D,this.texture),It.pixelStoreUnpackFlipY.set(!1),It.pixelStoreUnpack.set(1),It.pixelStoreUnpackPremultiplyAlpha.set(this.format===Lt.RGBA&&(!pt||!1!==pt.premultiply)),wt||this.size&&this.size[0]===Tt&&this.size[1]===St){const{x:pt,y:It}=wt||{x:0,y:0};if(ut instanceof HTMLImageElement||ut instanceof HTMLCanvasElement||ut instanceof HTMLVideoElement||ut instanceof ImageData||ImageBitmap&&ut instanceof ImageBitmap)Lt.texSubImage2D(Lt.TEXTURE_2D,0,pt,It,Lt.RGBA,Lt.UNSIGNED_BYTE,ut);else{let wt=this.format,Xt=Lt.UNSIGNED_BYTE;this.format===Lt.R32F&&(wt=Lt.RED,Xt=Lt.FLOAT),Lt.texSubImage2D(Lt.TEXTURE_2D,0,pt,It,Tt,St,wt,Xt,ut.data)}}else if(this.size=[Tt,St],ut instanceof HTMLImageElement||ut instanceof HTMLCanvasElement||ut instanceof HTMLVideoElement||ut instanceof ImageData||ImageBitmap&&ut instanceof ImageBitmap){let pt=this.format;this.format===Lt.R8&&(pt=Lt.RED),Lt.texImage2D(Lt.TEXTURE_2D,0,this.format,pt,Lt.UNSIGNED_BYTE,ut)}else{let pt=this.format,wt=this.format,It=Lt.UNSIGNED_BYTE;this.format===Lt.DEPTH_COMPONENT&&(pt=Lt.DEPTH_COMPONENT16,It=Lt.UNSIGNED_SHORT),this.format===Lt.R8&&(wt=Lt.RED),this.format===Lt.R32F&&(It=Lt.FLOAT,wt=Lt.RED),Lt.texImage2D(Lt.TEXTURE_2D,0,pt,Tt,St,0,wt,It,ut.data)}this.useMipmap=Boolean(pt&&pt.useMipmap),this.useMipmap&&Lt.generateMipmap(Lt.TEXTURE_2D)}bind(ut,pt,wt=!1){const{context:Tt}=this,{gl:St}=Tt;St.bindTexture(St.TEXTURE_2D,this.texture),ut!==this.minFilter&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MAG_FILTER,ut),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MIN_FILTER,this.useMipmap&&!wt?ut===St.NEAREST?St.NEAREST_MIPMAP_NEAREST:St.LINEAR_MIPMAP_LINEAR:ut),this.minFilter=ut),pt!==this.wrapS&&(St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_S,pt),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_T,pt),this.wrapS=pt)}bindExtraParam(ut,pt,wt,Tt){const{context:St}=this,{gl:It}=St;It.bindTexture(It.TEXTURE_2D,this.texture),pt!==this.magFilter&&(It.texParameteri(It.TEXTURE_2D,It.TEXTURE_MAG_FILTER,pt),this.magFilter=pt),ut!==this.minFilter&&(It.texParameteri(It.TEXTURE_2D,It.TEXTURE_MIN_FILTER,this.useMipmap?ut===It.NEAREST?It.NEAREST_MIPMAP_NEAREST:It.LINEAR_MIPMAP_LINEAR:ut),this.minFilter=ut),wt!==this.wrapS&&(It.texParameteri(It.TEXTURE_2D,It.TEXTURE_WRAP_S,wt),this.wrapS=wt),Tt!==this.wrapT&&(It.texParameteri(It.TEXTURE_2D,It.TEXTURE_WRAP_T,Tt),this.wrapT=Tt)}destroy(){const{gl:ut}=this.context;ut.deleteTexture(this.texture),this.texture=null}}class Xg{constructor(ut,pt){this.context=ut,this.texture=pt}bind(ut,pt){const{context:wt}=this,{gl:Tt}=wt;Tt.bindTexture(Tt.TEXTURE_2D,this.texture),ut!==this.minFilter&&(Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MAG_FILTER,ut),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_MIN_FILTER,ut),this.minFilter=ut),pt!==this.wrapS&&(Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_S,pt),Tt.texParameteri(Tt.TEXTURE_2D,Tt.TEXTURE_WRAP_T,pt),this.wrapS=pt)}}const rw=32,nw=33,ow=new Uint16Array(8184);for(let ut=0;ut<2046;ut++){let pt=ut+2,wt=0,Tt=0,St=0,It=0,Lt=0,Xt=0;for(1&pt?St=It=Lt=rw:wt=Tt=Xt=rw;(pt>>=1)>1;){const ut=wt+St>>1,Yt=Tt+It>>1;1&pt?(St=wt,It=Tt,wt=Lt,Tt=Xt):(wt=St,Tt=It,St=Lt,It=Xt),Lt=ut,Xt=Yt}const Yt=4*ut;ow[Yt+0]=wt,ow[Yt+1]=Tt,ow[Yt+2]=St,ow[Yt+3]=It}const sw=new Uint16Array(2178),aw=new Uint8Array(1089),lw=new Uint16Array(1089);function Qg(ut){return 0===ut?-.03125:32===ut?.03125:0}var cw=Bl([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]),uw=Bl([{name:"a_index",type:"Int16",components:1}]);const hw=(()=>({type:2,extent:xf,loadGeometry:()=>[[new xc(0,0),new xc(xf+1,0),new xc(xf+1,xf+1),new xc(0,xf+1),new xc(0,0)]]}))();class nx{constructor(ut,pt,wt,Tt,St){this.tileID=ut,this.uid=nr(),this.uses=0,this.tileSize=pt,this.tileZoom=wt,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=St,Tt&&Tt.style&&(this._lastUpdatedBrightness=Tt.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",Tt&&Tt.transform&&(this.projection=Tt.transform.projection)}registerFadeDuration(ut){const pt=ut+this.timeAdded;pt<Ju.now()||this.fadeEndTime&&pt<this.fadeEndTime||(this.fadeEndTime=pt)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=ng(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(ut,pt,wt){if(this.unloadVectorData(),this.state="loaded",ut){ut.featureIndex&&(this.latestFeatureIndex=ut.featureIndex,ut.rawTileData?(this.latestRawTileData=ut.rawTileData,this.latestFeatureIndex.rawTileData=ut.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=ut.collisionBoxArray,this.buckets=function(ut,pt){const wt={};if(!pt)return wt;for(const Tt of ut){const ut=Tt.layerIds.map((ut=>pt.getLayer(ut))).filter(Boolean);if(0!==ut.length){Tt.layers=ut,Tt.stateDependentLayerIds&&(Tt.stateDependentLayers=Tt.stateDependentLayerIds.map((pt=>ut.filter((ut=>ut.id===pt))[0])));for(const pt of ut)wt[pt.fqid]=Tt}}return wt}(ut.buckets,pt.style),this.hasSymbolBuckets=!1;for(const ut in this.buckets){const pt=this.buckets[ut];if(pt instanceof $g){if(this.hasSymbolBuckets=!0,!wt)break;pt.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const ut in this.buckets){const pt=this.buckets[ut];if(pt instanceof $g&&pt.hasRTLText){this.hasRTLText=!0,y_.isLoading()||y_.isLoaded()||"deferred"!==Xo()||Yo();break}}this.queryPadding=0;for(const ut in this.buckets){const wt=this.buckets[ut],Tt=pt.style.getOwnLayer(ut);if(!Tt)continue;const St=Tt.queryRadius(wt);this.queryPadding=Math.max(this.queryPadding,St)}ut.imageAtlas&&(this.imageAtlas=ut.imageAtlas),ut.glyphAtlasImage&&(this.glyphAtlasImage=ut.glyphAtlasImage),ut.lineAtlas&&(this.lineAtlas=ut.lineAtlas),this._lastUpdatedBrightness=ut.brightness}else this.collisionBoxArray=new pu}unloadVectorData(){if(this.hasData()){for(const ut in this.buckets)this.buckets[ut].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(ut){return this.buckets[ut.fqid]}upload(ut){for(const pt in this.buckets){const wt=this.buckets[pt];wt.uploadPending()&&wt.upload(ut)}const pt=ut.gl,wt=this.imageAtlas;if(wt&&!wt.uploaded){const Tt=!!Object.keys(wt.patternPositions).length;this.imageAtlasTexture=new Gg(ut,wt.image,pt.RGBA,{useMipmap:Tt}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new Gg(ut,this.glyphAtlasImage,pt.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new Gg(ut,this.lineAtlas.image,pt.R8),this.lineAtlas.uploaded=!0)}prepare(ut,pt,wt){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(ut,this.imageAtlasTexture,wt),!pt||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const Tt=pt.style.getBrightness();(this._lastUpdatedBrightness||Tt)&&(this._lastUpdatedBrightness&&Tt&&Math.abs(this._lastUpdatedBrightness-Tt)<.001||(this._lastUpdatedBrightness=Tt,this.updateBuckets(void 0,pt)))}queryRenderedFeatures(ut,pt,wt,Tt,St,It,Lt,Xt){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:Tt,pixelPosMatrix:Lt,transform:It,params:St,tileTransform:this.tileTransform},ut,pt,wt):{}}querySourceFeatures(ut,pt){const wt=this.latestFeatureIndex;if(!wt||!wt.rawTileData)return;const Tt=wt.loadVTLayers(),St=pt?pt.sourceLayer:"",It=Tt._geojsonTileLayer||Tt[St];if(!It)return;const Lt=pl(pt&&pt.filter),{z:Xt,x:Yt,y:Mi}=this.tileID.canonical,vr={z:Xt,x:Yt,y:Mi};for(let pt=0;pt<It.length;pt++){const Tt=It.feature(pt);if(Lt.needGeometry){const ut=Yc(Tt,!0);if(!Lt.filter(new Ho(this.tileID.overscaledZ),ut,this.tileID.canonical))continue}else if(!Lt.filter(new Ho(this.tileID.overscaledZ),Tt))continue;const br=wt.getId(Tt,St),Ar=new Cm(Tt,Xt,Yt,Mi,br);Ar.tile=vr,ut.push(Ar)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const ut in this.buckets)if(this.buckets[ut].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(ut){const pt=this.expirationTime;if(ut.cacheControl){const pt=xr(ut.cacheControl);pt["max-age"]&&(this.expirationTime=Date.now()+1e3*pt["max-age"])}else ut.expires&&(this.expirationTime=new Date(ut.expires).getTime());if(this.expirationTime){const ut=Date.now();let wt=!1;if(this.expirationTime>ut)wt=!1;else if(pt)if(this.expirationTime<pt)wt=!0;else{const Tt=this.expirationTime-pt;Tt?this.expirationTime=ut+Math.max(Tt,3e4):wt=!0}else wt=!0;wt?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(ut,pt){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(ut).length&&pt&&this.updateBuckets(ut,pt)}updateBuckets(ut,pt){if(!this.latestFeatureIndex)return;const wt=this.latestFeatureIndex.loadVTLayers(),Tt=pt.style.listImages(),St=pt.style.getBrightness();for(const It in this.buckets){if(!pt.style.hasLayer(It))continue;const Lt=this.buckets[It],Xt=Lt.layers[0].sourceLayer||"_geojsonTileLayer",Yt=wt[Xt];let Mi={};if(ut&&(Mi=ut[Xt],!Yt||!Mi||0===Object.keys(Mi).length))continue;if(Lt.update(Mi,Yt,Tt,this.imageAtlas&&this.imageAtlas.patternPositions||{},St),Lt instanceof tm||Lt instanceof Wp){const ut=pt.style.getOwnSourceCache(Lt.layers[0].source);pt._terrain&&pt._terrain.enabled&&ut&&Lt.programConfigurations.needsUpload&&pt._terrain._clearRenderCacheForTile(ut.id,this.tileID)}const vr=pt&&pt.style&&pt.style.getOwnLayer(It);vr&&(this.queryPadding=Math.max(this.queryPadding,vr.queryRadius(Lt)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Ju.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(ut){this.symbolFadeHoldUntil=Ju.now()+ut}setTexture(ut,pt){const wt=pt.context,Tt=wt.gl;this.texture=this.texture||pt.getTileTexture(ut.width),this.texture&&this.texture instanceof Gg?this.texture.update(ut,{useMipmap:!0}):(this.texture=new Gg(wt,ut,Tt.RGBA,{useMipmap:!0}),this.texture.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE))}setDependencies(ut,pt){const wt={};for(const ut of pt)wt[ut]=!0;this.dependencies[ut]=wt}hasDependency(ut,pt){for(const wt of ut){const ut=this.dependencies[wt];if(ut)for(const wt of pt)if(ut[wt])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(ut,pt){if(!pt||"mercator"===pt.name||this._tileDebugBuffer)return;const wt=Xc(hw,this.tileID.canonical,this.tileTransform)[0],Tt=new Cl,St=new au;for(let ut=0;ut<wt.length;ut++){const{x:pt,y:It}=wt[ut];Tt.emplaceBack(pt,It),St.emplaceBack(ut)}St.emplaceBack(0),this._tileDebugIndexBuffer=ut.createIndexBuffer(St),this._tileDebugBuffer=ut.createVertexBuffer(Tt,hg.members),this._tileDebugSegments=Au.simpleSegment(0,0,Tt.length,St.length)}_makeTileBoundsBuffers(ut,pt){if(this._tileBoundsBuffer||!pt||"mercator"===pt.name)return;const wt=Xc(hw,this.tileID.canonical,this.tileTransform)[0];let Tt,St;if(this.isRaster){const ut=function(ut,pt){const wt=ng(ut,pt),Tt=Math.pow(2,ut.z);for(let St=0;St<nw;St++)for(let It=0;It<nw;It++){const Lt=Pc((ut.x+(It+Qg(It))/rw)/Tt),Xt=Ec((ut.y+(St+Qg(St))/rw)/Tt),Yt=pt.project(Lt,Xt),Mi=St*nw+It;sw[2*Mi+0]=Math.round((Yt.x*wt.scale-wt.x)*xf),sw[2*Mi+1]=Math.round((Yt.y*wt.scale-wt.y)*xf)}aw.fill(0),lw.fill(0);for(let ut=2045;ut>=0;ut--){const pt=4*ut,wt=ow[pt+0],Tt=ow[pt+1],St=ow[pt+2],It=ow[pt+3],Lt=wt+St>>1,Xt=Tt+It>>1,Yt=Lt+Xt-Tt,Mi=Xt+wt-Lt,vr=Tt*nw+wt,br=It*nw+St,Ar=Xt*nw+Lt,Vr=Math.hypot((sw[2*vr+0]+sw[2*br+0])/2-sw[2*Ar+0],(sw[2*vr+1]+sw[2*br+1])/2-sw[2*Ar+1])>=16;aw[Ar]=aw[Ar]||(Vr?1:0),ut<1022&&(aw[Ar]=aw[Ar]||aw[(Tt+Mi>>1)*nw+(wt+Yt>>1)]||aw[(It+Mi>>1)*nw+(St+Yt>>1)])}const St=new Vl,It=new Ql;let Lt=0;function o(ut,pt){const wt=pt*nw+ut;return 0===lw[wt]&&(St.emplaceBack(sw[2*wt+0],sw[2*wt+1],ut*xf/rw,pt*xf/rw),lw[wt]=++Lt),lw[wt]-1}function l(ut,pt,wt,Tt,St,Lt){const Xt=ut+wt>>1,Yt=pt+Tt>>1;if(Math.abs(ut-St)+Math.abs(pt-Lt)>1&&aw[Yt*nw+Xt])l(St,Lt,ut,pt,Xt,Yt),l(wt,Tt,St,Lt,Xt,Yt);else{const Xt=o(ut,pt),Yt=o(wt,Tt),Mi=o(St,Lt);It.emplaceBack(Xt,Yt,Mi)}}return l(0,0,rw,rw,rw,0),l(rw,rw,0,0,0,rw),{vertices:St,indices:It}}(this.tileID.canonical,pt);Tt=ut.vertices,St=ut.indices}else{Tt=new Vl,St=new Ql;for(const{x:ut,y:pt}of wt)Tt.emplaceBack(ut,pt,0,0);const ut=wp(Tt.int16,void 0,4);for(let pt=0;pt<ut.length;pt+=3)St.emplaceBack(ut[pt],ut[pt+1],ut[pt+2])}this._tileBoundsBuffer=ut.createVertexBuffer(Tt,cw.members),this._tileBoundsIndexBuffer=ut.createIndexBuffer(St),this._tileBoundsSegments=Au.simpleSegment(0,0,Tt.length,St.length)}_makeGlobeTileDebugBuffers(pt,wt){const Tt=wt.projection;if(!Tt||"globe"!==Tt.name||wt.freezeTileCoverage)return;const St=this.tileID.canonical,It=$h(Vh(St,wt)),Lt=Hh(wt.zoom);let Xt;Lt>0&&(Xt=ut.ad.invert(new Float64Array(16),wt.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(pt,St,wt,It,Xt,Lt),this._makeGlobeTileDebugTextBuffer(pt,St,wt,It,Xt,Lt)}_globePoint(pt,wt,Tt,St,It,Lt,Xt){let Yt=Nh(pt,wt,Tt);if(Lt){const It=1<<Tt.z,Mi=Tc(St.center.lng),vr=kc(St.center.lat),br=(Tt.x+.5)/It-Mi;let Ar=0;br>.5?Ar=-1:br<-.5&&(Ar=1);let Vr=(pt/xf+Tt.x)/It+Ar,nn=(wt/xf+Tt.y)/It;Vr=(Vr-Mi)*St._pixelsPerMercatorPixel+Mi,nn=(nn-vr)*St._pixelsPerMercatorPixel+vr;const sn=[Vr*St.worldSize,nn*St.worldSize,0];ut._.transformMat4(sn,sn,Lt),Yt=Rh(Yt,sn,Xt)}return ut._.transformMat4(Yt,Yt,It)}_makeGlobeTileDebugBorderBuffer(ut,pt,wt,Tt,St,It){const Lt=new Cl,Xt=new au,Yt=new Rl,u=(ut,Mi,vr,br,Ar)=>{const Vr=(vr-ut)/(Ar-1),nn=(br-Mi)/(Ar-1),sn=Lt.length;for(let vr=0;vr<Ar;vr++){const br=ut+vr*Vr,Ar=Mi+vr*nn;Lt.emplaceBack(br,Ar);const an=this._globePoint(br,Ar,pt,wt,Tt,St,It);Yt.emplaceBack(an[0],an[1],an[2]),Xt.emplaceBack(sn+vr)}},Mi=xf;u(0,0,Mi,0,16),u(Mi,0,Mi,Mi,16),u(Mi,Mi,0,Mi,16),u(0,Mi,0,0,16),this._tileDebugIndexBuffer=ut.createIndexBuffer(Xt),this._tileDebugBuffer=ut.createVertexBuffer(Lt,hg.members),this._globeTileDebugBorderBuffer=ut.createVertexBuffer(Yt,ug.members),this._tileDebugSegments=Au.simpleSegment(0,0,Lt.length,Xt.length)}_makeGlobeTileDebugTextBuffer(ut,pt,wt,Tt,St,It){const Lt=xf/4,Xt=new Cl,Yt=new Ql,Mi=new Rl,vr=25;Yt.reserve(32),Xt.reserve(vr),Mi.reserve(vr);const h=(ut,pt)=>vr*ut+pt;for(let ut=0;ut<vr;ut++){const Yt=ut*Lt;for(let ut=0;ut<vr;ut++){const vr=ut*Lt;Xt.emplaceBack(vr,Yt);const br=this._globePoint(vr,Yt,pt,wt,Tt,St,It);Mi.emplaceBack(br[0],br[1],br[2])}}for(let ut=0;ut<4;ut++)for(let pt=0;pt<4;pt++){const wt=h(ut,pt),Tt=h(ut,pt+1),St=h(ut+1,pt),It=h(ut+1,pt+1);Yt.emplaceBack(wt,Tt,St),Yt.emplaceBack(St,Tt,It)}this._tileDebugTextIndexBuffer=ut.createIndexBuffer(Yt),this._tileDebugTextBuffer=ut.createVertexBuffer(Xt,hg.members),this._globeTileDebugTextBuffer=ut.createVertexBuffer(Mi,ug.members),this._tileDebugTextSegments=Au.simpleSegment(0,0,vr,32)}destroy(ut=!1){for(const ut in this.buckets)this.buckets[ut].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!ut&&this.texture&&this.texture instanceof Gg&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}const dw={read:function(ut,pt){return ut.readFields(dw._readField,{header_length:0,x:0,y:0,z:0,layers:[]},pt)},_readField:function(ut,pt,wt){1===ut?pt.header_length=wt.readFixed32():2===ut?pt.x=wt.readVarint():3===ut?pt.y=wt.readVarint():4===ut?pt.z=wt.readVarint():5===ut&&pt.layers.push(dw.Layer.read(wt,wt.readVarint()+wt.pos))},PixelFormat:{PIXEL_FORMAT_UNKNOWN:{value:0,options:{}},PIXEL_FORMAT_UINT32:{value:1,options:{}},PIXEL_FORMAT_UINT16:{value:2,options:{}},PIXEL_FORMAT_UINT8:{value:3,options:{}}},Filter:{}};dw.Filter.read=function(ut,pt){return ut.readFields(dw.Filter._readField,{delta_filter:null,filter:null,zigzag_filter:null,bitshuffle_filter:null,byteshuffle_filter:null},pt)},dw.Filter._readField=function(ut,pt,wt){1===ut?(pt.delta_filter=dw.Filter.Delta.read(wt,wt.readVarint()+wt.pos),pt.filter="delta_filter"):2===ut?(pt.zigzag_filter=dw.Filter.Zigzag.read(wt,wt.readVarint()+wt.pos),pt.filter="zigzag_filter"):3===ut?(pt.bitshuffle_filter=dw.Filter.BitShuffle.read(wt,wt.readVarint()+wt.pos),pt.filter="bitshuffle_filter"):4===ut&&(pt.byteshuffle_filter=dw.Filter.ByteShuffle.read(wt,wt.readVarint()+wt.pos),pt.filter="byteshuffle_filter")},dw.Filter.Delta={},dw.Filter.Delta.read=function(ut,pt){return ut.readFields(dw.Filter.Delta._readField,{block_size:0},pt)},dw.Filter.Delta._readField=function(ut,pt,wt){1===ut&&(pt.block_size=wt.readVarint())},dw.Filter.Zigzag={},dw.Filter.Zigzag.read=function(ut,pt){return ut.readFields(dw.Filter.Zigzag._readField,{},pt)},dw.Filter.Zigzag._readField=function(ut,pt,wt){},dw.Filter.BitShuffle={},dw.Filter.BitShuffle.read=function(ut,pt){return ut.readFields(dw.Filter.BitShuffle._readField,{},pt)},dw.Filter.BitShuffle._readField=function(ut,pt,wt){},dw.Filter.ByteShuffle={},dw.Filter.ByteShuffle.read=function(ut,pt){return ut.readFields(dw.Filter.ByteShuffle._readField,{},pt)},dw.Filter.ByteShuffle._readField=function(ut,pt,wt){},dw.Codec={},dw.Codec.read=function(ut,pt){return ut.readFields(dw.Codec._readField,{gzip_data:null,codec:null,jpeg_image:null,webp_image:null,png_image:null},pt)},dw.Codec._readField=function(ut,pt,wt){1===ut?(pt.gzip_data=dw.Codec.GzipData.read(wt,wt.readVarint()+wt.pos),pt.codec="gzip_data"):2===ut?(pt.jpeg_image=dw.Codec.JpegImage.read(wt,wt.readVarint()+wt.pos),pt.codec="jpeg_image"):3===ut?(pt.webp_image=dw.Codec.WebpImage.read(wt,wt.readVarint()+wt.pos),pt.codec="webp_image"):4===ut&&(pt.png_image=dw.Codec.PngImage.read(wt,wt.readVarint()+wt.pos),pt.codec="png_image")},dw.Codec.GzipData={},dw.Codec.GzipData.read=function(ut,pt){return ut.readFields(dw.Codec.GzipData._readField,{},pt)},dw.Codec.GzipData._readField=function(ut,pt,wt){},dw.Codec.JpegImage={},dw.Codec.JpegImage.read=function(ut,pt){return ut.readFields(dw.Codec.JpegImage._readField,{},pt)},dw.Codec.JpegImage._readField=function(ut,pt,wt){},dw.Codec.WebpImage={},dw.Codec.WebpImage.read=function(ut,pt){return ut.readFields(dw.Codec.WebpImage._readField,{},pt)},dw.Codec.WebpImage._readField=function(ut,pt,wt){},dw.Codec.PngImage={},dw.Codec.PngImage.read=function(ut,pt){return ut.readFields(dw.Codec.PngImage._readField,{},pt)},dw.Codec.PngImage._readField=function(ut,pt,wt){},dw.DataIndexEntry={},dw.DataIndexEntry.read=function(ut,pt){return ut.readFields(dw.DataIndexEntry._readField,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},pt)},dw.DataIndexEntry._readField=function(ut,pt,wt){1===ut?pt.first_byte=wt.readFixed64():2===ut?pt.last_byte=wt.readFixed64():3===ut?pt.filters.push(dw.Filter.read(wt,wt.readVarint()+wt.pos)):4===ut?pt.codec=dw.Codec.read(wt,wt.readVarint()+wt.pos):5===ut?pt.offset=wt.readFloat():6===ut?pt.scale=wt.readFloat():7===ut&&pt.bands.push(wt.readString())},dw.Layer={},dw.Layer.read=function(ut,pt){return ut.readFields(dw.Layer._readField,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},pt)},dw.Layer._readField=function(ut,pt,wt){1===ut?pt.version=wt.readVarint():2===ut?pt.name=wt.readString():3===ut?pt.units=wt.readString():4===ut?pt.tilesize=wt.readVarint():5===ut?pt.buffer=wt.readVarint():6===ut?pt.pixel_format=wt.readVarint():7===ut&&pt.data_index.push(dw.DataIndexEntry.read(wt,wt.readVarint()+wt.pos))};const pw={read:function(ut,pt){return ut.readFields(pw._readField,{uint32_values:null,values:null,fixed32_values:null},pt)},_readField:function(ut,pt,wt){2===ut?(pt.uint32_values=pw.Uint32Values.read(wt,wt.readVarint()+wt.pos),pt.values="uint32_values"):3===ut&&(pt.fixed32_values=pw.Fixed32Values.read(wt,wt.readVarint()+wt.pos),pt.values="fixed32_values")},Uint32Values:{}};pw.Uint32Values.read=function(ut,pt){return ut.readFields(pw.Uint32Values._readField,{values:[]},pt)},pw.Uint32Values._readField=function(ut,pt,wt){1===ut&&(pt.readValuesInto=function(ut){if(2!==ut.type)throw new Error(`Unsupported pbf type "${ut.type}"`);const pt=function(ut){return 2===ut.type?ut.readVarint()+ut.pos:ut.pos+1}(ut),wt=ut.pos;return ut.pos=pt,function(Tt){ut.pos=wt;let St=0;for(;ut.pos<pt;){const pt=ut.readVarint();Tt[St++]=pt}return Tt}}(wt))},pw.Fixed32Values={},pw.Fixed32Values.read=function(ut,pt){return ut.readFields(pw.Fixed32Values._readField,{values:[]},pt)},pw.Fixed32Values._readField=function(ut,pt,wt){throw new Error("Not implemented")};
/**
     * tiny-lru
     *
     * @copyright 2024 Jason Mulligan <jason.mulligan@avoidwork.com>
     * @license BSD-3-Clause
     * @version 11.2.6
     */class ax{constructor(ut=0,pt=0,wt=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=ut,this.resetTtl=wt,this.size=0,this.ttl=pt}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(ut){if(this.has(ut)){const pt=this.items[ut];delete this.items[ut],this.size--,null!==pt.prev&&(pt.prev.next=pt.next),null!==pt.next&&(pt.next.prev=pt.prev),this.first===pt&&(this.first=pt.next),this.last===pt&&(this.last=pt.prev)}return this}entries(ut=this.keys()){return ut.map((ut=>[ut,this.get(ut)]))}evict(ut=!1){if(ut||this.size>0){const ut=this.first;delete this.items[ut.key],0==--this.size?(this.first=null,this.last=null):(this.first=ut.next,this.first.prev=null)}return this}expiresAt(ut){let pt;return this.has(ut)&&(pt=this.items[ut].expiry),pt}get(ut){let pt;if(this.has(ut)){const wt=this.items[ut];this.ttl>0&&wt.expiry<=Date.now()?this.delete(ut):(pt=wt.value,this.set(ut,pt,!0))}return pt}has(ut){return ut in this.items}keys(){const ut=[];let pt=this.first;for(;null!==pt;)ut.push(pt.key),pt=pt.next;return ut}set(ut,pt,wt=!1,Tt=this.resetTtl){let St;if(wt||this.has(ut)){if(St=this.items[ut],St.value=pt,!1===wt&&Tt&&(St.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==St){const ut=this.last,pt=St.next,wt=St.prev;this.first===St&&(this.first=St.next),St.next=null,St.prev=this.last,ut.next=St,null!==wt&&(wt.next=pt),null!==pt&&(pt.prev=wt)}}else this.max>0&&this.size===this.max&&this.evict(!0),St=this.items[ut]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:ut,prev:this.last,next:null,value:pt},1==++this.size?this.first=St:this.last.next=St;return this.last=St,this}values(ut=this.keys()){return ut.map((ut=>this.get(ut)))}}function ox(ut,pt){if(4!==pt.length)throw new Error(`Expected data of dimension 4 but got ${pt.length}.`);let wt=pt[3];for(let Tt=2;Tt>=1;Tt--){const St=1===Tt?1:0,It=2===Tt?1:0;for(let Tt=0;Tt<pt[0];Tt++){const Lt=pt[1]*Tt;for(let Tt=St;Tt<pt[1];Tt++){const St=pt[2]*(Tt+Lt);for(let Tt=It;Tt<pt[2];Tt++){const It=pt[3]*(Tt+St);for(let Tt=0;Tt<pt[3];Tt++){const pt=It+Tt;ut[pt]+=ut[pt-wt]}}}}wt*=pt[Tt]}return ut}function lx(ut){for(let pt=0,wt=ut.length;pt<wt;pt++)ut[pt]=ut[pt]>>>1^-(1&ut[pt]);return ut}function ux(ut,pt){switch(pt){case"uint32":return ut;case"uint16":for(let pt=0;pt<ut.length;pt+=2){const wt=ut[pt],Tt=ut[pt+1];ut[pt]=(240&wt)>>4|(61440&wt)>>8|(240&Tt)<<4|61440&Tt,ut[pt+1]=15&wt|(3840&wt)>>4|(15&Tt)<<8|(3840&Tt)<<4}return ut;case"uint8":for(let pt=0;pt<ut.length;pt+=4){const wt=ut[pt],Tt=ut[pt+1],St=ut[pt+2],It=ut[pt+3];ut[pt+0]=(192&wt)>>6|(192&Tt)>>4|(192&St)>>2|192&It,ut[pt+1]=(48&wt)>>4|(48&Tt)>>2|48&St|(48&It)<<2,ut[pt+2]=(12&wt)>>2|12&Tt|(12&St)<<2|(12&It)<<4,ut[pt+3]=3&wt|(3&Tt)<<2|(3&St)<<4|(3&It)<<6}return ut;default:throw new Error(`Invalid pixel format, "${pt}"`)}}class cx extends Error{constructor(ut){super(ut),this.name="MRTError"}}var fw=Uint8Array,mw=Uint16Array,_w=Int32Array,gw=new fw([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),yw=new fw([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),xw=new fw([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),gx=function(ut,pt){for(var wt=new mw(31),Tt=0;Tt<31;++Tt)wt[Tt]=pt+=1<<ut[Tt-1];var St=new _w(wt[30]);for(Tt=1;Tt<30;++Tt)for(var It=wt[Tt];It<wt[Tt+1];++It)St[It]=It-wt[Tt]<<5|Tt;return{b:wt,r:St}},vw=gx(gw,2),bw=vw.b,ww=vw.r;bw[28]=258,ww[258]=28;for(var Tw=gx(yw,0).b,Ew=new mw(32768),Mw=0;Mw<32768;++Mw){var Sw=(43690&Mw)>>1|(21845&Mw)<<1;Ew[Mw]=((65280&(Sw=(61680&(Sw=(52428&Sw)>>2|(13107&Sw)<<2))>>4|(3855&Sw)<<4))>>8|(255&Sw)<<8)>>1}var Sx=function(ut,pt,wt){for(var Tt=ut.length,St=0,It=new mw(pt);St<Tt;++St)ut[St]&&++It[ut[St]-1];var Lt,Xt=new mw(pt);for(St=1;St<pt;++St)Xt[St]=Xt[St-1]+It[St-1]<<1;if(wt){Lt=new mw(1<<pt);var Yt=15-pt;for(St=0;St<Tt;++St)if(ut[St])for(var Mi=St<<4|ut[St],vr=pt-ut[St],br=Xt[ut[St]-1]++<<vr,Ar=br|(1<<vr)-1;br<=Ar;++br)Lt[Ew[br]>>Yt]=Mi}else for(Lt=new mw(Tt),St=0;St<Tt;++St)ut[St]&&(Lt[St]=Ew[Xt[ut[St]-1]++]>>15-ut[St]);return Lt},Aw=new fw(288);for(Mw=0;Mw<144;++Mw)Aw[Mw]=8;for(Mw=144;Mw<256;++Mw)Aw[Mw]=9;for(Mw=256;Mw<280;++Mw)Aw[Mw]=7;for(Mw=280;Mw<288;++Mw)Aw[Mw]=8;var Iw=new fw(32);for(Mw=0;Mw<32;++Mw)Iw[Mw]=5;var Cw=Sx(Aw,9,1),Pw=Sx(Iw,5,1),Px=function(ut){for(var pt=ut[0],wt=1;wt<ut.length;++wt)ut[wt]>pt&&(pt=ut[wt]);return pt},Ex=function(ut,pt,wt){var Tt=pt/8|0;return(ut[Tt]|ut[Tt+1]<<8)>>(7&pt)&wt},Bx=function(ut,pt){var wt=pt/8|0;return(ut[wt]|ut[wt+1]<<8|ut[wt+2]<<16)>>(7&pt)},zw=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Cx=function(ut,pt,wt){var Tt=new Error(pt||zw[ut]);if(Tt.code=ut,Error.captureStackTrace&&Error.captureStackTrace(Tt,Cx),!wt)throw Tt;return Tt},Lw=new fw(0),Rw="undefined"!=typeof TextDecoder&&new TextDecoder;try{Rw.decode(Lw,{stream:!0})}catch(ut){}const Dw={gzip_data:"gzip"};const kw={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Ow={uint32:1,uint16:2,uint8:4},Bw={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class Nx{constructor(ut=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=ut}getLayer(ut){return this.layers[ut]}getHeaderLength(ut){const pt=new Uint8Array(ut),wt=new DataView(ut);if(13!==pt[0])throw new cx("File is not a valid MRT.");return wt.getUint32(1,!0)}parseHeader(ut){const pt=new Uint8Array(ut),wt=this.getHeaderLength(ut);if(pt.length<wt)throw new cx(`Expected header with length >= ${wt} but got buffer of length ${pt.length}`);const Tt=new xv(pt.subarray(0,wt)),St=dw.read(Tt);if(!isNaN(this.x)&&(this.x!==St.x||this.y!==St.y||this.z!==St.z))throw new cx(`Invalid attempt to parse header ${St.z}/${St.x}/${St.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=St.x,this.y=St.y,this.z=St.z;for(const ut of St.layers)this.layers[ut.name]=new jx(ut,{cacheSize:this._cacheSize});return this}createDecodingTask(ut){const pt=[],wt=this.getLayer(ut.layerName);for(let Tt=0;Tt<wt.dataIndex.length;Tt++){const St=wt.dataIndex[Tt],It=St.first_byte-ut.firstByte,Lt=St.last_byte+1-ut.firstByte;if(Tt<ut.firstBlock||Tt>ut.lastBlock)continue;if(wt._blocksInProgress.has(Tt))continue;const Xt={layerName:wt.name,firstByte:It,lastByte:Lt,pixelFormat:wt.pixelFormat,blockIndex:Tt,blockShape:[St.bands.length].concat(wt.bandShape),buffer:wt.buffer,codec:St.codec.codec,filters:St.filters.map((ut=>ut.filter))};wt._blocksInProgress.add(Tt),pt.push(Xt)}return new qx(pt,(()=>{pt.forEach((ut=>wt._blocksInProgress.delete(ut.blockIndex)))}),((ut,Tt)=>{if(pt.forEach((ut=>wt._blocksInProgress.delete(ut.blockIndex))),ut)throw ut;Tt.forEach((ut=>{this.getLayer(ut.layerName).processDecodedData(ut)}))}))}}class jx{constructor({version:ut,name:pt,units:wt,tilesize:Tt,pixel_format:St,buffer:It,data_index:Lt},Xt){if(this.version=ut,1!==this.version)throw new cx(`Cannot parse raster layer encoded with MRT version ${ut}`);this.name=pt,this.units=wt,this.tileSize=Tt,this.buffer=It,this.pixelFormat=kw[St],this.dataIndex=Lt,this.bandShape=[Tt+2*It,Tt+2*It,Ow[this.pixelFormat]],this._decodedBlocks=function(ut=1e3,pt=0,wt=!1){if(isNaN(ut)||ut<0)throw new TypeError("Invalid max value");if(isNaN(pt)||pt<0)throw new TypeError("Invalid ttl value");if("boolean"!=typeof wt)throw new TypeError("Invalid resetTtl value");return new ax(ut,pt,wt)}(Xt?Xt.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(ut){const pt=ut.blockIndex.toString();this._decodedBlocks.get(pt)||this._decodedBlocks.set(pt,ut.data)}getBlockForBand(ut){let pt=0;switch(typeof ut){case"string":for(const[wt,Tt]of this.dataIndex.entries()){for(const[St,It]of Tt.bands.entries())if(It===ut)return{bandIndex:pt+St,blockIndex:wt,blockBandIndex:St};pt+=Tt.bands.length}break;case"number":for(const[wt,Tt]of this.dataIndex.entries()){if(ut>=pt&&ut<pt+Tt.bands.length)return{bandIndex:ut,blockIndex:wt,blockBandIndex:ut-pt};pt+=Tt.bands.length}break;default:throw new cx(`Invalid band \`${JSON.stringify(ut)}\`. Expected string or integer.`)}throw new cx(`Band not found: ${JSON.stringify(ut)}`)}getDataRange(ut){let pt=1/0,wt=-1/0,Tt=1/0,St=-1/0;for(const It of ut){const{blockIndex:ut}=this.getBlockForBand(It);if(ut<0)throw new cx(`Invalid band: ${JSON.stringify(It)}`);const Lt=this.dataIndex[ut];Tt=Math.min(Tt,ut),St=Math.max(St,ut),pt=Math.min(pt,Lt.first_byte),wt=Math.max(wt,Lt.last_byte)}return{layerName:this.name,firstByte:pt,lastByte:wt,firstBlock:Tt,lastBlock:St}}hasBand(ut){const{blockIndex:pt}=this.getBlockForBand(ut);return pt>=0}hasDataForBand(ut){const{blockIndex:pt}=this.getBlockForBand(ut);return pt>=0&&!!this._decodedBlocks.get(pt.toString())}getBandView(ut){const{blockIndex:pt,blockBandIndex:wt}=this.getBlockForBand(ut),Tt=this._decodedBlocks.get(pt.toString());if(!Tt)throw new cx(`Data for band ${JSON.stringify(ut)} of layer "${this.name}" not decoded.`);const St=this.dataIndex[pt],It=this.bandShape.reduce(((ut,pt)=>ut*pt),1),Lt=wt*It,Xt=Tt.subarray(Lt,Lt+It);return{data:Xt,bytes:new Uint8Array(Xt.buffer).subarray(Xt.byteOffset,Xt.byteOffset+Xt.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:St.offset,scale:St.scale}}}class qx{constructor(ut,pt,wt){this.tasks=ut,this._onCancel=pt,this._onComplete=wt,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(ut,pt){this._finalized||(this._onComplete(ut,pt),this._finalized=!0)}}Nx.performDecoding=function(ut,pt){return Promise.all(pt.tasks.map((pt=>{const{layerName:wt,firstByte:Tt,lastByte:St,pixelFormat:It,blockShape:Lt,blockIndex:Xt,filters:Yt,codec:Mi}=pt,vr=new Uint8Array(ut).subarray(Tt,St+1),br=new Uint32Array(Lt[0]*Lt[1]*Lt[2]);let Ar;if("gzip_data"!==Mi)throw new Error(`Unhandled codec: ${Mi}`);return Ar=function(ut,pt){if(!globalThis.DecompressionStream&&"gzip_data"===pt)return Promise.resolve(((It=function(ut){31==ut[0]&&139==ut[1]&&8==ut[2]||Cx(6,"invalid gzip data");var pt=ut[3],wt=10;4&pt&&(wt+=2+(ut[10]|ut[11]<<8));for(var Tt=(pt>>3&1)+(pt>>4&1);Tt>0;Tt-=!ut[wt++]);return wt+(2&pt)}(St=ut))+8>St.length&&Cx(6,"invalid gzip data"),function(ut,pt,wt,Tt){var St=ut.length;if(!St||pt.f&&!pt.l)return wt||new fw(0);var It=!wt,Lt=It||2!=pt.i,Xt=pt.i;It&&(wt=new fw(3*St));var Yt,Mi,c=function(ut){var pt=wt.length;if(ut>pt){var Tt=new fw(Math.max(2*pt,ut));Tt.set(wt),wt=Tt}},vr=pt.f||0,br=pt.p||0,Ar=pt.b||0,Vr=pt.l,nn=pt.d,sn=pt.m,an=pt.n,ln=8*St;do{if(!Vr){vr=Ex(ut,br,1);var cn=Ex(ut,br+1,3);if(br+=3,!cn){var un=ut[(Mn=4+((br+7)/8|0))-4]|ut[Mn-3]<<8,fn=Mn+un;if(fn>St){Xt&&Cx(0);break}Lt&&c(Ar+un),wt.set(ut.subarray(Mn,fn),Ar),pt.b=Ar+=un,pt.p=br=8*fn,pt.f=vr;continue}if(1==cn)Vr=Cw,nn=Pw,sn=9,an=5;else if(2==cn){var _n=Ex(ut,br,31)+257,gn=Ex(ut,br+10,15)+4,yn=_n+Ex(ut,br+5,31)+1;br+=14;for(var xn=new fw(yn),vn=new fw(19),bn=0;bn<gn;++bn)vn[xw[bn]]=Ex(ut,br+3*bn,7);br+=3*gn;var wn=Px(vn),Tn=(1<<wn)-1,En=Sx(vn,wn,1);for(bn=0;bn<yn;){var Mn,Sn=En[Ex(ut,br,Tn)];if(br+=15&Sn,(Mn=Sn>>4)<16)xn[bn++]=Mn;else{var An=0,In=0;for(16==Mn?(In=3+Ex(ut,br,3),br+=2,An=xn[bn-1]):17==Mn?(In=3+Ex(ut,br,7),br+=3):18==Mn&&(In=11+Ex(ut,br,127),br+=7);In--;)xn[bn++]=An}}var Pn=xn.subarray(0,_n),zn=xn.subarray(_n);sn=Px(Pn),an=Px(zn),Vr=Sx(Pn,sn,1),nn=Sx(zn,an,1)}else Cx(1);if(br>ln){Xt&&Cx(0);break}}Lt&&c(Ar+131072);for(var Ln=(1<<sn)-1,kn=(1<<an)-1,Bn=br;;Bn=br){var Wn=(An=Vr[Bx(ut,br)&Ln])>>4;if((br+=15&An)>ln){Xt&&Cx(0);break}if(An||Cx(2),Wn<256)wt[Ar++]=Wn;else{if(256==Wn){Bn=br,Vr=null;break}var Yn=Wn-254;Wn>264&&(Yn=Ex(ut,br,(1<<(bo=gw[bn=Wn-257]))-1)+bw[bn],br+=bo);var Jn=nn[Bx(ut,br)&kn],Qn=Jn>>4;if(Jn||Cx(3),br+=15&Jn,zn=Tw[Qn],Qn>3){var bo=yw[Qn];zn+=Bx(ut,br)&(1<<bo)-1,br+=bo}if(br>ln){Xt&&Cx(0);break}Lt&&c(Ar+131072);var ko=Ar+Yn;if(Ar<zn){var No=0-zn,Js=Math.min(zn,ko);for(No+Ar<0&&Cx(3);Ar<Js;++Ar)wt[Ar]=(void 0)[No+Ar]}for(;Ar<ko;++Ar)wt[Ar]=wt[Ar-zn]}}pt.l=Vr,pt.p=Bn,pt.b=Ar,pt.f=vr,Vr&&(vr=1,pt.m=sn,pt.d=nn,pt.n=an)}while(!vr);return Ar!=wt.length&&It?(Yt=wt,(null==(Mi=Ar)||Mi>Yt.length)&&(Mi=Yt.length),new fw(Yt.subarray(0,Mi))):wt.subarray(0,Ar)}(St.subarray(It,-8),{i:2},new fw(((wt=St)[(Tt=wt.length)-4]|wt[Tt-3]<<8|wt[Tt-2]<<16|wt[Tt-1]<<24)>>>0))));var wt,Tt,St,It;const Lt=Dw[pt];if(!Lt)throw new Error(`Unhandled codec: ${pt}`);const Xt=new globalThis.DecompressionStream(Lt);return new Response(new Blob([ut]).stream().pipeThrough(Xt)).arrayBuffer().then((ut=>new Uint8Array(ut)))}(vr,Mi).then((ut=>{const pt=pw.read(new xv(ut));if("uint32_values"===pt.values)return pt.uint32_values.readValuesInto(br),new(0,Bw[It])(br.buffer);throw new Error(`Unhandled numeric data "${pt.values}"`)})),Ar.then((ut=>{for(let pt=Yt.length-1;pt>=0;pt--)switch(Yt[pt]){case"delta_filter":ox(ut,Lt);break;case"zigzag_filter":lx(ut);break;case"bitshuffle_filter":ux(ut,It);break;default:throw new Error(`Unhandled filter "${Yt[pt]}"`)}return{layerName:wt,blockIndex:Xt,data:ut}})).catch((ut=>{throw ut}))})))};class $x extends nx{constructor(ut,pt,wt,Tt,St){super(ut,pt,wt,Tt,St),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(ut,pt){const wt=pt.context,Tt=wt.gl;this.texture=this.texture||pt.getTileTexture(ut.width),this.texture&&this.texture instanceof Gg?this.texture.update(ut,{useMipmap:!1,premultiply:!1}):this.texture=new Gg(wt,ut,Tt.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(ut=16384,pt){const wt=this._mrt=new Nx(30),Tt=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(ut-1)}});return this.entireBuffer=null,this.request=en(Tt,((Tt,St,It,Lt)=>{if(Tt)pt(Tt);else try{const Tt=wt.getHeaderLength(St);if(Tt>ut)return void(this.request=this.fetchHeader(Tt,pt));wt.parseHeader(St),this._isHeaderLoaded=!0;let Xt=0;for(const ut of Object.values(wt.layers))Xt=Math.max(Xt,ut.dataIndex[ut.dataIndex.length-1].last_byte);St.byteLength>=Xt&&(this.entireBuffer=St),pt(null,this.entireBuffer||St,It,Lt)}catch(ut){pt(ut)}})),this.request}fetchBand(ut,pt,wt){const Tt=this._mrt;if(!this._isHeaderLoaded||!Tt)return void wt(new Error("Tile header is not ready"));const St=this.actor;if(!St)return void wt(new Error("Can't fetch tile band without an actor"));let It;const a=(Tt,St)=>{It.complete(Tt,St),Tt?wt(Tt):(this.updateTextureDescriptor(ut,pt),wt(null,this.textureDescriptor&&this.textureDescriptor.img))},o=(ut,pt)=>{if(ut)return wt(ut);const Tt=St.send("decodeRasterArray",{buffer:pt,task:It},a,void 0,!0);this._workQueue.push((()=>{Tt&&Tt.cancel(),It.cancel()}))},Lt=Tt.getLayer(ut);if(!Lt)return void wt(new Error(`Unknown sourceLayer "${ut}"`));if(Lt.hasDataForBand(pt))return this.updateTextureDescriptor(ut,pt),void wt(null,this.textureDescriptor?this.textureDescriptor.img:null);const Xt=Lt.getDataRange([pt]);if(It=Tt.createDecodingTask(Xt),!It||It.tasks.length)if(this.flushQueues(),this.entireBuffer)o(null,this.entireBuffer.slice(Xt.firstByte,Xt.lastByte+1));else{const ut=Object.assign({},this.requestParams,{headers:{Range:`bytes=${Xt.firstByte}-${Xt.lastByte}`}}),pt=en(ut,o);this._fetchQueue.push((()=>{pt.cancel(),It.cancel()}))}else wt(null)}updateNeeded(ut,pt){return(!this.textureDescriptor||this.textureDescriptor.band!==pt||this.textureDescriptor.layer!==ut)&&"errored"!==this.state}updateTextureDescriptor(ut,pt){if(!this._mrt)return;const wt=this._mrt.getLayer(ut);if(!wt||!wt.hasBand(pt)||!wt.hasDataForBand(pt))return;const{bytes:Tt,tileSize:St,buffer:It,offset:Lt,scale:Xt}=wt.getBandView(pt),Yt=St+2*It,Mi={data:Tt,width:Yt,height:Yt},vr=this.texture;vr&&vr instanceof Gg&&vr.update(Mi,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:ut,band:pt,img:Mi,buffer:It,offset:Lt,tileSize:St,format:wt.pixelFormat,mix:[Xt,256*Xt,65536*Xt,16777216*Xt]}}}class Gx{constructor(ut,pt){this.max=ut,this.onRemove=pt,this.reset()}reset(){for(const ut in this.data)for(const pt of this.data[ut])pt.timeout&&clearTimeout(pt.timeout),this.onRemove(pt.value);return this.data={},this.order=[],this}add(ut,pt,wt){const Tt=ut.wrapped().key;void 0===this.data[Tt]&&(this.data[Tt]=[]);const St={value:pt,timeout:void 0};if(void 0!==wt&&(St.timeout=setTimeout((()=>{this.remove(ut,St)}),wt)),this.data[Tt].push(St),this.order.push(Tt),this.order.length>this.max){const ut=this._getAndRemoveByKey(this.order[0]);ut&&this.onRemove(ut)}return this}has(ut){return ut.wrapped().key in this.data}getAndRemove(ut){return this.has(ut)?this._getAndRemoveByKey(ut.wrapped().key):null}_getAndRemoveByKey(ut){const pt=this.data[ut].shift();return pt.timeout&&clearTimeout(pt.timeout),0===this.data[ut].length&&delete this.data[ut],this.order.splice(this.order.indexOf(ut),1),pt.value}getByKey(ut){const pt=this.data[ut];return pt?pt[0].value:null}get(ut){return this.has(ut)?this.data[ut.wrapped().key][0].value:null}remove(ut,pt){if(!this.has(ut))return this;const wt=ut.wrapped().key,Tt=void 0===pt?0:this.data[wt].indexOf(pt),St=this.data[wt][Tt];return this.data[wt].splice(Tt,1),St.timeout&&clearTimeout(St.timeout),0===this.data[wt].length&&delete this.data[wt],this.onRemove(St.value),this.order.splice(this.order.indexOf(wt),1),this}setMaxSize(ut){for(this.max=ut;this.order.length>this.max;){const ut=this._getAndRemoveByKey(this.order[0]);ut&&this.onRemove(ut)}return this}filter(ut){const pt=[];for(const wt in this.data)for(const Tt of this.data[wt])ut(Tt.value)||pt.push(Tt);for(const ut of pt)this.remove(ut.value.tileID,ut)}}class Xx extends Fn{constructor(ut,pt,wt){super(),this.id=ut,this._onlySymbols=wt,pt.on("data",(ut=>{"source"===ut.dataType&&"metadata"===ut.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===ut.dataType&&"content"===ut.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),pt.on("error",(()=>{this._sourceErrored=!0})),this._source=pt,this._tiles={},this._cache=new Gx(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=pt.minTileCacheSize,this._maxTileCacheSize=pt.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Rm,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(ut){this.map=ut,this._minTileCacheSize=void 0===this._minTileCacheSize&&ut?ut._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&ut?ut._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const ut in this._tiles){const pt=this._tiles[ut];if("errored"!==pt.state&&("loaded"!==pt.state||!pt.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const ut=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,ut&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(ut,pt){return ut.isSymbolTile=this._onlySymbols,ut.isExtraShadowCaster=this._shadowCasterTiles[ut.tileID.key],this._source.loadTile(ut,pt)}_unloadTile(ut){if(this._source.unloadTile)return this._source.unloadTile(ut)}_abortTile(ut){if(this._source.abortTile)return this._source.abortTile(ut)}serialize(){return this._source.serialize()}prepare(ut){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const pt in this._tiles){const wt=this._tiles[pt];wt.upload(ut),wt.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return tr(this._tiles).map((ut=>ut.tileID)).sort(Yx).map((ut=>ut.key))}getRenderableIds(ut,pt){const wt=[];for(const Tt in this._tiles)this._isIdRenderable(+Tt,ut,pt)&&wt.push(this._tiles[Tt]);return ut?wt.sort(((ut,pt)=>{const wt=ut.tileID,Tt=pt.tileID,St=new xc(wt.canonical.x,wt.canonical.y)._rotate(this.transform.angle),It=new xc(Tt.canonical.x,Tt.canonical.y)._rotate(this.transform.angle);return wt.overscaledZ-Tt.overscaledZ||It.y-St.y||It.x-St.x})).map((ut=>ut.tileID.key)):wt.map((ut=>ut.tileID)).sort(Yx).map((ut=>ut.key))}hasRenderableParent(ut){const pt=this.findLoadedParent(ut,0);return!!pt&&this._isIdRenderable(pt.tileID.key)}_isIdRenderable(ut,pt,wt){return this._tiles[ut]&&this._tiles[ut].hasData()&&!this._coveredTiles[ut]&&(pt||!this._tiles[ut].holdingForFade())&&(wt||!this._shadowCasterTiles[ut])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const ut in this._tiles)"errored"!==this._tiles[ut].state&&this._reloadTile(+ut,"reloading")}}_reloadTile(ut,pt){const wt=this._tiles[ut];wt&&("loading"!==wt.state&&(wt.state=pt),this._loadTile(wt,this._tileLoaded.bind(this,wt,ut,pt)))}_tileLoaded(ut,pt,wt,Tt){if(Tt)if(ut.state="errored",404!==Tt.status)this._source.fire(new Vn(Tt,{tile:ut}));else{if(!(ut.tileID.key in this._loadedParentTiles))return void this._source.fire(new Rn("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const ut=this.map.painter.terrain;this.update(this.transform,ut.getScaledDemTileSize(),!0),ut.resetTileLookupCache(this.id)}else this.update(this.transform)}else ut.timeAdded=Ju.now(),"expired"===wt&&(ut.refreshedUponExpiration=!0),this._setTileReloadTimer(pt,ut),"raster-dem"===this._source.type&&ut.dem&&this._backfillDEM(ut),this._state.initializeTileState(ut,this.map?this.map.painter:null),this._source.fire(new Rn("data",{dataType:"source",tile:ut,coord:ut.tileID,sourceCacheId:this.id}))}_backfillDEM(ut){const pt=this.getRenderableIds();for(let wt=0;wt<pt.length;wt++){const Tt=pt[wt];if(ut.neighboringTiles&&ut.neighboringTiles[Tt]){const pt=this.getTileByID(Tt);r(ut,pt),r(pt,ut)}}function r(ut,pt){if(!ut.dem||ut.dem.borderReady)return;ut.needsHillshadePrepare=!0,ut.needsDEMTextureUpload=!0;let wt=pt.tileID.canonical.x-ut.tileID.canonical.x;const Tt=pt.tileID.canonical.y-ut.tileID.canonical.y,St=Math.pow(2,ut.tileID.canonical.z),It=pt.tileID.key;0===wt&&0===Tt||Math.abs(Tt)>1||(Math.abs(wt)>1&&(1===Math.abs(wt+St)?wt+=St:1===Math.abs(wt-St)&&(wt-=St)),pt.dem&&ut.dem&&(ut.dem.backfillBorder(pt.dem,wt,Tt),ut.neighboringTiles&&ut.neighboringTiles[It]&&(ut.neighboringTiles[It].backfilled=!0)))}}getTile(ut){return this.getTileByID(ut.key)}getTileByID(ut){return this._tiles[ut]}_retainLoadedChildren(ut,pt,wt,Tt){for(const St in this._tiles){let It=this._tiles[St];if(Tt[St]||!It.hasData()||It.tileID.overscaledZ<=pt||It.tileID.overscaledZ>wt)continue;let Lt=It.tileID;for(;It&&It.tileID.overscaledZ>pt+1;){const ut=It.tileID.scaledTo(It.tileID.overscaledZ-1);It=this._tiles[ut.key],It&&It.hasData()&&(Lt=ut)}let Xt=Lt;for(;Xt.overscaledZ>pt;)if(Xt=Xt.scaledTo(Xt.overscaledZ-1),ut[Xt.key]){Tt[Lt.key]=Lt;break}}}findLoadedParent(ut,pt){if(ut.key in this._loadedParentTiles){const wt=this._loadedParentTiles[ut.key];return wt&&wt.tileID.overscaledZ>=pt?wt:null}for(let wt=ut.overscaledZ-1;wt>=pt;wt--){const pt=ut.scaledTo(wt),Tt=this._getLoadedTile(pt);if(Tt)return Tt}}_getLoadedTile(ut){const pt=this._tiles[ut.key];return pt&&pt.hasData()?pt:this._cache.getByKey(this._source.reparseOverscaled?ut.wrapped().key:ut.canonical.key)}updateCacheSize(ut,pt){pt=pt||this._source.tileSize;const wt=Math.ceil(ut.width/pt)+1,Tt=Math.ceil(ut.height/pt)+1,St=Math.floor(wt*Tt*5),It="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,St):St,Lt="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,It):It;this._cache.setMaxSize(Lt)}handleWrapJump(ut){const pt=Math.round((ut-(void 0===this._prevLng?ut:this._prevLng))/360);if(this._prevLng=ut,pt){const ut={};for(const wt in this._tiles){const Tt=this._tiles[wt];Tt.tileID=Tt.tileID.unwrapTo(Tt.tileID.wrap+pt),ut[Tt.tileID.key]=Tt}this._tiles=ut;for(const ut in this._timers)clearTimeout(this._timers[ut]),delete this._timers[ut];for(const ut in this._tiles)this._setTileReloadTimer(+ut,this._tiles[ut])}}update(ut,pt,wt,Tt){if(this.transform=ut,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!wt)return;let St;if(this.updateCacheSize(ut,pt),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain){if(this._source.tileID)St=ut.getVisibleUnwrappedCoordinates(this._source.tileID).map((ut=>new _c(ut.canonical.z,ut.wrap,ut.canonical.z,ut.canonical.x,ut.canonical.y)));else if(0!==this.tileCoverLift){const Tt=ut.clone();Tt.tileCoverLift=this.tileCoverLift,St=Tt.coveringTiles({tileSize:pt||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!wt,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&"globe"===ut.projection.name&&(St.push(new _c(1,0,1,0,0)),St.push(new _c(1,0,1,1,0)),St.push(new _c(1,0,1,0,1)),St.push(new _c(1,0,1,1,1)))}else if(St=ut.coveringTiles({tileSize:pt||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!wt,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile){const ut=this._source.hasTile.bind(this._source);St=St.filter((pt=>ut(pt)))}}else St=[];if(St.length>0&&this.castsShadows&&Tt&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!Zx(this._source.type)){const It=ut.coveringZoomLevel({tileSize:pt||this._source.tileSize,roundZoom:this._source.roundZoom&&!wt}),Lt=Math.min(It,this._source.maxzoom),Xt=ut.extendTileCoverForShadows(St,Tt,Lt);for(const ut of Xt)this._shadowCasterTiles[ut.key]=!0,St.push(ut)}const It=this._updateRetainedTiles(St);if(Zx(this._source.type)&&0!==St.length){const ut={},pt={},wt=Object.keys(It);for(const Tt of wt){const wt=It[Tt],St=this._tiles[Tt];if(!St||St.fadeEndTime&&St.fadeEndTime<=Ju.now())continue;const Lt=this.findLoadedParent(wt,Math.max(wt.overscaledZ-Xx.maxOverzooming,this._source.minzoom));Lt&&(this._addTile(Lt.tileID),ut[Lt.tileID.key]=Lt.tileID),pt[Tt]=wt}const Tt=St[St.length-1].overscaledZ;for(const ut in this._tiles){const wt=this._tiles[ut];if(It[ut]||!wt.hasData())continue;let St=wt.tileID;for(;St.overscaledZ>Tt;){St=St.scaledTo(St.overscaledZ-1);const Tt=this._tiles[St.key];if(Tt&&Tt.hasData()&&pt[St.key]){It[ut]=wt.tileID;break}}}for(const pt in ut)It[pt]||(this._coveredTiles[pt]=!0,It[pt]=ut[pt])}for(const ut in It)this._tiles[ut].clearFadeHold();const Lt=function(ut,pt){const wt=[];for(const Tt in ut)Tt in pt||wt.push(Tt);return wt}(this._tiles,It);for(const ut of Lt){const pt=this._tiles[ut];pt.hasSymbolBuckets&&!pt.holdingForFade()?pt.setHoldDuration(this.map._fadeDuration):pt.hasSymbolBuckets&&!pt.symbolFadeFinished()||this._removeTile(+ut)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const ut in this._tiles)this._tiles[ut].holdingForFade()&&this._removeTile(+ut)}_updateRetainedTiles(ut){const pt={};if(0===ut.length)return pt;const wt={},Tt=ut.reduce(((ut,pt)=>Math.min(ut,pt.overscaledZ)),1/0),St=ut[0].overscaledZ,It=Math.max(St-Xx.maxOverzooming,this._source.minzoom),Lt=Math.max(St+Xx.maxUnderzooming,this._source.minzoom),Xt={};for(const wt of ut){const ut=this._addTile(wt);pt[wt.key]=wt,ut.hasData()||Tt<this._source.maxzoom&&(Xt[wt.key]=wt)}this._retainLoadedChildren(Xt,Tt,Lt,pt);for(const Tt of ut){let ut=this._tiles[Tt.key];if(ut.hasData())continue;if(Tt.canonical.z>=this._source.maxzoom){const ut=Tt.children(this._source.maxzoom)[0],wt=this.getTile(ut);if(wt&&wt.hasData()){pt[ut.key]=ut;continue}}else{const ut=Tt.children(this._source.maxzoom);if(pt[ut[0].key]&&pt[ut[1].key]&&pt[ut[2].key]&&pt[ut[3].key])continue}let St=ut.wasRequested();for(let Lt=Tt.overscaledZ-1;Lt>=It;--Lt){const It=Tt.scaledTo(Lt);if(wt[It.key])break;if(wt[It.key]=!0,ut=this.getTile(It),!ut&&St&&(ut=this._addTile(It)),ut&&(pt[It.key]=It,St=ut.wasRequested(),ut.hasData()))break}}return pt}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const ut in this._tiles){const pt=[];let wt,Tt=this._tiles[ut].tileID;for(;Tt.overscaledZ>0;){if(Tt.key in this._loadedParentTiles){wt=this._loadedParentTiles[Tt.key];break}pt.push(Tt.key);const ut=Tt.scaledTo(Tt.overscaledZ-1);if(wt=this._getLoadedTile(ut),wt)break;Tt=ut}for(const ut of pt)this._loadedParentTiles[ut]=wt}}_addTile(ut){let pt=this._tiles[ut.key];if(pt)return!0!==pt.isExtraShadowCaster||!!this._shadowCasterTiles[ut.key]||this._reloadTile(ut.key,"reloading"),pt;pt=this._cache.getAndRemove(ut),pt&&(this._setTileReloadTimer(ut.key,pt),pt.tileID=ut,this._state.initializeTileState(pt,this.map?this.map.painter:null),this._cacheTimers[ut.key]&&(clearTimeout(this._cacheTimers[ut.key]),delete this._cacheTimers[ut.key],this._setTileReloadTimer(ut.key,pt)));const wt=Boolean(pt);if(!wt){const wt=this.map?this.map.painter:null,Tt=this._source.tileSize*ut.overscaleFactor();pt="raster-array"===this._source.type?new $x(ut,Tt,this.transform.tileZoom,wt,this._isRaster):new nx(ut,Tt,this.transform.tileZoom,wt,this._isRaster),this._loadTile(pt,this._tileLoaded.bind(this,pt,ut.key,pt.state))}return pt?(pt.uses++,this._tiles[ut.key]=pt,wt||this._source.fire(new Rn("dataloading",{tile:pt,coord:pt.tileID,dataType:"source"})),pt):null}_setTileReloadTimer(ut,pt){ut in this._timers&&(clearTimeout(this._timers[ut]),delete this._timers[ut]);const wt=pt.getExpiryTimeout();wt&&(this._timers[ut]=setTimeout((()=>{this._reloadTile(ut,"expired"),delete this._timers[ut]}),wt))}_removeTile(ut){const pt=this._tiles[ut];pt&&(pt.uses--,delete this._tiles[ut],this._timers[ut]&&(clearTimeout(this._timers[ut]),delete this._timers[ut]),pt.uses>0||(pt.hasData()&&"reloading"!==pt.state||"empty"===pt.state?this._cache.add(pt.tileID,pt,pt.getExpiryTimeout()):(pt.aborted=!0,this._abortTile(pt),this._unloadTile(pt))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const ut in this._tiles)this._removeTile(+ut);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(ut,pt,wt){const Tt=[],St=this.transform;if(!St)return Tt;const It="globe"===St.projection.name,Lt=Tc(St.center.lng);for(const Xt in this._tiles){const Yt=this._tiles[Xt];if(wt&&Yt.clearQueryDebugViz(),Yt.holdingForFade())continue;let Mi;if(It){const ut=Yt.tileID.canonical;if(0===ut.z){const pt=[Math.abs(Ke(Lt,...Hx(ut,-1))-Lt),Math.abs(Ke(Lt,...Hx(ut,1))-Lt)];Mi=[0,2*pt.indexOf(Math.min(...pt))-1]}else{const pt=[Math.abs(Ke(Lt,...Hx(ut,-1))-Lt),Math.abs(Ke(Lt,...Hx(ut,0))-Lt),Math.abs(Ke(Lt,...Hx(ut,1))-Lt)];Mi=[pt.indexOf(Math.min(...pt))-1]}}else Mi=[0];for(const wt of Mi){const It=ut.containsTile(Yt,St,pt,wt);It&&Tt.push(It)}}return Tt}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(ut){return this._getRenderableCoordinates(ut)}_getRenderableCoordinates(ut,pt){const wt=this.getRenderableIds(ut,pt).map((ut=>this._tiles[ut].tileID)),Tt="globe"===this.transform.projection.name;for(const ut of wt)ut.projMatrix=this.transform.calculateProjMatrix(ut.toUnwrapped()),ut.expandedProjMatrix=Tt?this.transform.calculateProjMatrix(ut.toUnwrapped(),!1,!0):ut.projMatrix;return wt}sortCoordinatesByDistance(ut){const pt=ut.slice(),wt=this.transform._camera.position,Tt=this.transform._camera.forward(),St={};for(const ut of pt){const pt=1/(1<<ut.canonical.z);St[ut.key]=((ut.canonical.x+.5)*pt+ut.wrap-wt[0])*Tt[0]+((ut.canonical.y+.5)*pt-wt[1])*Tt[1]-wt[2]*Tt[2]}return pt.sort(((ut,pt)=>St[ut.key]-St[pt.key])),pt}hasTransition(){if(this._source.hasTransition())return!0;if(Zx(this._source.type))for(const ut in this._tiles){const pt=this._tiles[ut];if(void 0!==pt.fadeEndTime&&pt.fadeEndTime>=Ju.now())return!0}return!1}setFeatureState(ut,pt,wt){this._state.updateState(ut=ut||"_geojsonTileLayer",pt,wt)}removeFeatureState(ut,pt,wt){this._state.removeFeatureState(ut=ut||"_geojsonTileLayer",pt,wt)}getFeatureState(ut,pt){return this._state.getState(ut=ut||"_geojsonTileLayer",pt)}setDependencies(ut,pt,wt){const Tt=this._tiles[ut];Tt&&Tt.setDependencies(pt,wt)}reloadTilesForDependencies(ut,pt){for(const wt in this._tiles)this._tiles[wt].hasDependency(ut,pt)&&this._reloadTile(+wt,"reloading");this._cache.filter((wt=>!wt.hasDependency(ut,pt)))}_preloadTiles(ut,pt){if(!this._sourceLoaded){const r=()=>{this._sourceLoaded&&(this._source.off("data",r),this._preloadTiles(ut,pt))};return void this._source.on("data",r)}const wt=new Map,Tt=Array.isArray(ut)?ut:[ut],St=this.map.painter.terrain,It=this.usedForTerrain&&St?St.getScaledDemTileSize():this._source.tileSize;for(const ut of Tt){const pt=ut.coveringTiles({tileSize:It,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const ut of pt)wt.set(ut.key,ut);this.usedForTerrain&&ut.updateElevation(!1)}Qe(Array.from(wt.values()),((ut,pt)=>{const wt=new nx(ut,this._source.tileSize*ut.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(wt,(ut=>{"raster-dem"===this._source.type&&wt.dem&&this._backfillDEM(wt),pt(ut,wt)}))}),pt)}}function Yx(ut,pt){const wt=Math.abs(2*ut.wrap)-+(ut.wrap<0),Tt=Math.abs(2*pt.wrap)-+(pt.wrap<0);return ut.overscaledZ-pt.overscaledZ||Tt-wt||pt.canonical.y-ut.canonical.y||pt.canonical.x-ut.canonical.x}function Zx(ut){return"raster"===ut||"image"===ut||"video"===ut||"custom"===ut}function Hx(ut,pt){const wt=1<<ut.z;return[ut.x/wt+pt,(ut.x+1)/wt+pt]}Xx.maxOverzooming=10,Xx.maxUnderzooming=3;const Fw=new class extends sl{possiblyEvaluate(ut,pt){return pt=new Ho(Math.floor(pt.zoom),{now:pt.now,fadeDuration:pt.fadeDuration,transition:pt.transition}),super.possiblyEvaluate(ut,pt)}evaluate(ut,pt,wt,Tt){return pt=er({},pt,{zoom:Math.floor(pt.zoom)}),super.evaluate(ut,pt,wt,Tt)}}(cv.paint.properties["line-width"].specification);function Wx(ut,pt){return pt>0?pt+2*ut:ut}Fw.useIntegerZoom=!0;const Nw=new ol({"symbol-placement":new il(x_.layout_symbol["symbol-placement"]),"symbol-spacing":new il(x_.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new il(x_.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new sl(x_.layout_symbol["symbol-sort-key"]),"symbol-z-order":new il(x_.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new il(x_.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new il(x_.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new il(x_.layout_symbol["icon-ignore-placement"]),"icon-optional":new il(x_.layout_symbol["icon-optional"]),"icon-rotation-alignment":new il(x_.layout_symbol["icon-rotation-alignment"]),"icon-size":new sl(x_.layout_symbol["icon-size"]),"icon-text-fit":new sl(x_.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new sl(x_.layout_symbol["icon-text-fit-padding"]),"icon-image":new sl(x_.layout_symbol["icon-image"]),"icon-rotate":new sl(x_.layout_symbol["icon-rotate"]),"icon-padding":new il(x_.layout_symbol["icon-padding"]),"icon-keep-upright":new il(x_.layout_symbol["icon-keep-upright"]),"icon-offset":new sl(x_.layout_symbol["icon-offset"]),"icon-anchor":new sl(x_.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new il(x_.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new il(x_.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new il(x_.layout_symbol["text-rotation-alignment"]),"text-field":new sl(x_.layout_symbol["text-field"]),"text-font":new sl(x_.layout_symbol["text-font"]),"text-size":new sl(x_.layout_symbol["text-size"]),"text-max-width":new sl(x_.layout_symbol["text-max-width"]),"text-line-height":new sl(x_.layout_symbol["text-line-height"]),"text-letter-spacing":new sl(x_.layout_symbol["text-letter-spacing"]),"text-justify":new sl(x_.layout_symbol["text-justify"]),"text-radial-offset":new sl(x_.layout_symbol["text-radial-offset"]),"text-variable-anchor":new il(x_.layout_symbol["text-variable-anchor"]),"text-anchor":new sl(x_.layout_symbol["text-anchor"]),"text-max-angle":new il(x_.layout_symbol["text-max-angle"]),"text-writing-mode":new il(x_.layout_symbol["text-writing-mode"]),"text-rotate":new sl(x_.layout_symbol["text-rotate"]),"text-padding":new il(x_.layout_symbol["text-padding"]),"text-keep-upright":new il(x_.layout_symbol["text-keep-upright"]),"text-transform":new sl(x_.layout_symbol["text-transform"]),"text-offset":new sl(x_.layout_symbol["text-offset"]),"text-allow-overlap":new il(x_.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new il(x_.layout_symbol["text-ignore-placement"]),"text-optional":new il(x_.layout_symbol["text-optional"]),visibility:new il(x_.layout_symbol.visibility)});var Vw={paint:new ol({"icon-opacity":new sl(x_.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new sl(x_.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new sl(x_.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new sl(x_.paint_symbol["text-emissive-strength"]),"icon-color":new sl(x_.paint_symbol["icon-color"]),"icon-halo-color":new sl(x_.paint_symbol["icon-halo-color"]),"icon-halo-width":new sl(x_.paint_symbol["icon-halo-width"]),"icon-halo-blur":new sl(x_.paint_symbol["icon-halo-blur"]),"icon-translate":new il(x_.paint_symbol["icon-translate"]),"icon-translate-anchor":new il(x_.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new sl(x_.paint_symbol["icon-image-cross-fade"]),"text-opacity":new sl(x_.paint_symbol["text-opacity"]),"text-occlusion-opacity":new sl(x_.paint_symbol["text-occlusion-opacity"]),"text-color":new sl(x_.paint_symbol["text-color"],{runtimeType:mp,getOverride:ut=>ut.textColor,hasOverride:ut=>!!ut.textColor}),"text-halo-color":new sl(x_.paint_symbol["text-halo-color"]),"text-halo-width":new sl(x_.paint_symbol["text-halo-width"]),"text-halo-blur":new sl(x_.paint_symbol["text-halo-blur"]),"text-translate":new il(x_.paint_symbol["text-translate"]),"text-translate-anchor":new il(x_.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new il(x_.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new il(x_.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new il(x_.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new il(x_.paint_symbol["icon-color-brightness-max"])}),layout:Nw};class tb{constructor(ut){this.type=ut.property.overrides?ut.property.overrides.runtimeType:ep,this.defaultValue=ut}evaluate(ut){if(ut.formattedSection){const pt=this.defaultValue.property.overrides;if(pt&&pt.hasOverride(ut.formattedSection))return pt.getOverride(ut.formattedSection)}return ut.feature&&ut.featureState?this.defaultValue.evaluate(ut.feature,ut.featureState):this.defaultValue.property.specification.default}eachChild(ut){this.defaultValue.isConstant()||ut(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Mo(tb,"FormatSectionOverride",{omit:["defaultValue"]});class eb extends kl{constructor(pt,wt,Tt,St){super(pt,Vw,wt,Tt,St),this._colorAdjustmentMatrix=ut.ad.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==pt.paint&&("icon-occlusion-opacity"in pt.paint||"text-occlusion-opacity"in pt.paint)}recalculate(ut,pt){super.recalculate(ut,pt),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const wt=this.layout.get("text-writing-mode");if(wt){const ut=[];for(const pt of wt)ut.indexOf(pt)<0&&ut.push(pt);this.layout._values["text-writing-mode"]=ut}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(pt,wt,Tt,St){return this._saturation===pt&&this._contrast===wt&&this._brightnessMin===Tt&&this._brightnessMax===St||(this._colorAdjustmentMatrix=function(pt,wt,Tt,St){pt=Er(pt),wt=Pr(wt);const It=ut.ad.create(),Lt=pt/3,Xt=1-2*Lt,Yt=[Xt,Lt,Lt,0,Lt,Xt,Lt,0,Lt,Lt,Xt,0,0,0,0,1],Mi=.5-.5*wt,vr=St-Tt;return ut.ad.multiply(It,[vr,0,0,0,0,vr,0,0,0,0,vr,0,Tt,Tt,Tt,1],[wt,0,0,0,0,wt,0,0,0,0,wt,0,Mi,Mi,Mi,1]),ut.ad.multiply(It,It,Yt),It}(pt,wt,Tt,St),this._saturation=pt,this._contrast=wt,this._brightnessMin=Tt,this._brightnessMax=St),this._colorAdjustmentMatrix}getValueAndResolveTokens(ut,pt,wt,Tt){const St=this.layout.get(ut).evaluate(pt,{},wt,Tt),It=this._unevaluatedLayout._values[ut];return It.isDataDriven()||co(It.value)||!St?St:function(ut,pt){return pt.replace(/{([^{}]+)}/g,((pt,wt)=>wt in ut?String(ut[wt]):""))}(pt.properties,St)}createBucket(ut){return new $g(ut)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const ut of Vw.paint.overridableProperties){if(!eb.hasPaintOverride(this.layout,ut))continue;const pt=this.paint.get(ut),wt=new tb(pt),Tt=new uo(wt,pt.property.specification,this.scope,this.options);let St=null;St="constant"===pt.value.kind||"source"===pt.value.kind?new po("source",Tt):new fo("composite",Tt,pt.value.zoomStops,pt.value._interpolationType),this.paint._values[ut]=new rl(pt.property,St,pt.parameters)}}_handleOverridablePaintPropertyUpdate(ut,pt,wt){return!(!this.layout||pt.isDataDriven()||wt.isDataDriven())&&eb.hasPaintOverride(this.layout,ut)}static hasPaintOverride(ut,pt){const wt=ut.get("text-field"),Tt=Vw.paint.properties[pt];let St=!1;const s=ut=>{for(const pt of ut)if(Tt.overrides&&Tt.overrides.hasOverride(pt))return void(St=!0)};if("constant"===wt.value.kind&&wt.value.value instanceof mi)s(wt.value.value.sections);else if("source"===wt.value.kind){const t=ut=>{St||(ut instanceof _i&&bi(ut.value)===vp?s(ut.value.sections):ut instanceof Si?s(ut.sections):ut.eachChild(t))},ut=wt.value;ut._styleExpression&&t(ut._styleExpression.expression)}return St}getProgramIds(){const ut=0!==this.paint.get("icon-opacity").constantOr(1),pt=0!==this.paint.get("text-opacity").constantOr(1),wt=[];return ut&&wt.push("symbolIcon"),pt&&wt.push("symbolSDF"),wt}getDefaultProgramParams(ut,pt,wt){return{config:new Ku(this,{zoom:pt,lut:wt}),overrideFog:!1}}}const Uw=new ol({visibility:new il(x_.layout_background.visibility)});var jw={paint:new ol({"background-color":new il(x_.paint_background["background-color"]),"background-pattern":new il(x_.paint_background["background-pattern"]),"background-opacity":new il(x_.paint_background["background-opacity"]),"background-emissive-strength":new il(x_.paint_background["background-emissive-strength"])}),layout:Uw};const Gw=new ol({visibility:new il(x_.layout_raster.visibility)});var qw={paint:new ol({"raster-opacity":new il(x_.paint_raster["raster-opacity"]),"raster-color":new al(x_.paint_raster["raster-color"]),"raster-color-mix":new il(x_.paint_raster["raster-color-mix"]),"raster-color-range":new il(x_.paint_raster["raster-color-range"]),"raster-hue-rotate":new il(x_.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new il(x_.paint_raster["raster-brightness-min"]),"raster-brightness-max":new il(x_.paint_raster["raster-brightness-max"]),"raster-saturation":new il(x_.paint_raster["raster-saturation"]),"raster-contrast":new il(x_.paint_raster["raster-contrast"]),"raster-resampling":new il(x_.paint_raster["raster-resampling"]),"raster-fade-duration":new il(x_.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new il(x_.paint_raster["raster-emissive-strength"]),"raster-array-band":new il(x_.paint_raster["raster-array-band"]),"raster-elevation":new il(x_.paint_raster["raster-elevation"])}),layout:Gw};function ab(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=[pt,wt,1,Tt,St,1,It,Lt,1],vr=[Xt,Yt,1],br=ut.bC.adjoint([],Mi),[Ar,Vr,nn]=ut._.transformMat3(vr,vr,br);return ut.bC.multiply(Mi,Mi,[Ar,0,0,0,Vr,0,0,0,nn])}function ob(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=function(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=ab(0,0,1,0,1,1,0,1),vr=ab(pt,wt,Tt,St,It,Lt,Xt,Yt),br=ut.bC.adjoint([],Mi);return ut.bC.multiply(vr,vr,br)}(pt,wt,Tt,St,It,Lt,Xt,Yt);return[Mi[2]/Mi[8]/xf,Mi[5]/Mi[8]/xf]}function lb(ut){return[ut[0],Math.min(Math.max(ut[1],-Y_),Y_)]}class ub extends Fn{constructor(ut,pt,wt,Tt){super(),this.id=ut,this.dispatcher=wt,this.coordinates=pt.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(Tt),this.options=pt,this._dirty=!1}load(ut,pt){if(this._loaded=pt||!1,this.fire(new Rn("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return ut&&(this.coordinates=ut),this._loaded=!0,void this._finishLoading();this._imageRequest=on(this.map._requestManager.transformRequest(this.url,id.Image),((pt,wt)=>{this._imageRequest=null,this._loaded=!0,pt?this.fire(new Vn(pt)):wt&&(this.image=wt instanceof HTMLImageElement?Ju.getImageData(wt):wt,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,ut&&(this.coordinates=ut),this._finishLoading())}))}loaded(){return this._loaded}updateImage(ut){return ut.url?(this._imageRequest&&ut.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=ut.url,this.load(ut.coordinates,this._loaded),this):this}setTexture(ut){if(!(ut.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Xg(this.map.painter.context,ut.handle),this.width=ut.dimensions[0],this.height=ut.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Rn("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(ut){this.map=ut,this.load()}onRemove(ut){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Xg||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(ut){if(this.coordinates=ut,this._boundsArray=void 0,this._unsupportedCoords=!1,!ut.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let pt=ut[0][1],wt=ut[0][1];for(const Tt of ut)Tt[1]>wt&&(wt=Tt[1]),Tt[1]<pt&&(pt=Tt[1]);const Tt=(wt+pt)/2;if(Tt>Y_?this.onNorthPole=!0:Tt<-Y_&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const pt=ut.map(Lc.fromLngLat);this.tileID=function(ut){let pt=1/0,wt=1/0,Tt=-1/0,St=-1/0;for(const It of ut)pt=Math.min(pt,It.x),wt=Math.min(wt,It.y),Tt=Math.max(Tt,It.x),St=Math.max(St,It.y);const It=Math.max(Tt-pt,St-wt),Lt=Math.max(0,Math.floor(-Math.log(It)/Math.LN2)),Xt=Math.pow(2,Lt);let Yt=Math.floor((pt+Tt)/2*Xt);return Yt>1&&(Yt-=1),new bc(Lt,Yt,Math.floor((wt+St)/2*Xt))}(pt),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Rn("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(pt){for(const ut in this.tiles){const pt=this.tiles[ut];"loaded"!==pt.state&&(pt.state="loaded",pt.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const wt=ng(new bc(0,0,0),this.map.transform.projection),Tt=[wt.projection.project(this.coordinates[0][0],this.coordinates[0][1]),wt.projection.project(this.coordinates[1][0],this.coordinates[1][1]),wt.projection.project(this.coordinates[2][0],this.coordinates[2][1]),wt.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(ut){const pt=ut[1].x-ut[0].x,wt=ut[1].y-ut[0].y,Tt=ut[2].x-ut[1].x,St=ut[2].y-ut[1].y,It=ut[3].x-ut[2].x,Lt=ut[3].y-ut[2].y,Xt=ut[0].x-ut[3].x,Yt=ut[0].y-ut[3].y,Mi=pt*St-Tt*wt,vr=Tt*Lt-It*St,br=It*Yt-Xt*Lt,Ar=Xt*wt-pt*Yt;return Mi>0&&vr>0&&br>0&&Ar>0||Mi<0&&vr<0&&br<0&&Ar<0}(Tt))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const St=ng(this.tileID,this.map.transform.projection),[It,Lt,Xt,Yt]=this.coordinates.map((ut=>{const pt=St.projection.project(ut[0],ut[1]);return ig(St,pt)._round()}));this.perspectiveTransform=ob(It.x,It.y,Lt.x,Lt.y,Xt.x,Xt.y,Yt.x,Yt.y);const Mi=this._boundsArray=new Vl;Mi.emplaceBack(It.x,It.y,0,0),Mi.emplaceBack(Lt.x,Lt.y,xf,0),Mi.emplaceBack(Yt.x,Yt.y,0,xf),Mi.emplaceBack(Xt.x,Xt.y,xf,xf),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=pt.createVertexBuffer(Mi,cw.members),this.boundsSegments=Au.simpleSegment(0,0,4,2);const vr=[],br=function(ut){return[lb(ut[0]),lb(ut[1]),lb(ut[2]),lb(ut[3])]}(this.coordinates),[Ar,Vr,nn,sn]=function(ut){let pt=ut[0][0],wt=pt,Tt=ut[0][1],St=Tt;for(let It=1;It<ut.length;It++)ut[It][0]<pt?pt=ut[It][0]:ut[It][0]>wt&&(wt=ut[It][0]),ut[It][1]<Tt?Tt=ut[It][1]:ut[It][1]>St&&(St=ut[It][1]);return[pt,Tt,wt-pt,St-Tt]}(br);{const St=new Vl,[It,Lt,Xt,Yt]=function(ut){let pt=ut[0].x,wt=pt,Tt=ut[0].y,St=Tt;for(let It=1;It<ut.length;It++)ut[It].x<pt?pt=ut[It].x:ut[It].x>wt&&(wt=ut[It].x),ut[It].y<Tt?Tt=ut[It].y:ut[It].y>St&&(St=ut[It].y);return[pt,Tt,wt-pt,St-Tt]}(Tt),u=ut=>[(ut.x-It)/Xt,(ut.y-Lt)/Yt],[Mi,br,an,ln]=Tt.map(u),cn=function(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=ab(0,0,1,0,1,1,0,1),vr=ab(pt,wt,Tt,St,It,Lt,Xt,Yt),br=ut.bC.adjoint([],vr);return ut.bC.multiply(Mi,Mi,br)}(Mi[0],Mi[1],br[0],br[1],an[0],an[1],ln[0],ln[1]);this.elevatedGlobePerspectiveTransform=ob(Mi[0],Mi[1],br[0],br[1],an[0],an[1],ln[0],ln[1]);const v=(pt,wt)=>{vr.push(pt.lng);const Tt=Math.round((pt.lng-Ar)/nn*xf),It=Math.round((pt.lat-Vr)/sn*xf),Lt=u(wt),Xt=ut._.transformMat3([],[Lt[0],Lt[1],1],cn),Yt=Math.round(Xt[0]/Xt[2]*xf),Mi=Math.round(Xt[1]/Xt[2]*xf);St.emplaceBack(Tt,It,Yt,Mi)},un=Tt[3].x-Tt[0].x,fn=Tt[3].y-Tt[0].y,_n=Tt[2].x-Tt[1].x,gn=Tt[2].y-Tt[1].y;for(let ut=0;ut<65;ut++){const pt=ut/64,St=[Tt[0].x+pt*un,Tt[0].y+pt*fn],It=[Tt[1].x+pt*_n,Tt[1].y+pt*gn],Lt=It[0]-St[0],Xt=It[1]-St[1];for(let ut=0;ut<65;ut++){const pt=ut/64,Tt={x:St[0]+Lt*pt,y:St[1]+Xt*pt,z:0};v(wt.projection.unproject(Tt.x,Tt.y),Tt)}}this.elevatedGlobeVertexBuffer=pt.createVertexBuffer(St,cw.members)}{this.maxLongitudeTriangleSize=0;let ut=[],wt=new Ql;const n=(pt,Tt,St)=>{wt.emplaceBack(pt,Tt,St);const It=vr[pt],Lt=vr[Tt],Xt=vr[St],Yt=Math.min(Math.min(It,Lt),Xt),Mi=Math.max(Math.max(It,Lt),Xt)-Yt;Mi>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Mi),ut.push(Yt+Mi/2)};for(let ut=0;ut<64;ut++)for(let pt=0;pt<64;pt++){const wt=65*ut+pt,Tt=wt+1,St=wt+65,It=St+1;n(wt,St,Tt),n(Tt,St,It)}[ut,wt]=function(ut,pt){const wt=Array.from({length:ut.length},((ut,pt)=>pt));wt.sort(((pt,wt)=>ut[pt]-ut[wt]));const Tt=[],St=new Ql;for(let It=0;It<wt.length;It++){const Lt=wt[It];Tt.push(ut[Lt]);const Xt=3*Lt,Yt=Xt+1;St.emplaceBack(pt.uint16[Xt],pt.uint16[Yt],pt.uint16[Yt+1])}return[Tt,St]}(ut,wt),this.elevatedGlobeTrianglesCenterLongitudes=ut,this.elevatedGlobeIndexBuffer=pt.createIndexBuffer(wt)}this.elevatedGlobeSegments=Au.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,nn/xf,0,sn/xf,0,0,Vr,Ar,0])}prepare(){const ut=0!==Object.keys(this.tiles).length;if(this.tileID&&!ut)return;const pt=this.map.painter.context,wt=pt.gl;!this._dirty||this.texture instanceof Xg||(this.texture?this.texture.update(this.image):(this.texture=new Gg(pt,this.image,wt.RGBA),this.texture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE)),this._dirty=!1),ut&&this._prepareData(pt)}loadTile(ut,pt){this.tileID&&this.tileID.equals(ut.tileID.canonical)?(this.tiles[String(ut.tileID.wrap)]=ut,ut.buckets={},pt(null)):(ut.state="errored",pt(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(ut){const pt=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!pt)return null;const wt=this.elevatedGlobeTrianglesCenterLongitudes;let Tt=(St=ut+180)+360*Math.round((wt[0]-St)/360);var St;const It=new Au,a=(ut,wt)=>{It.segments.push({vertexOffset:0,primitiveOffset:ut,vertexLength:pt.segments[0].vertexLength,primitiveLength:wt,sortKey:void 0,vaos:{}})},Lt=.51*this.maxLongitudeTriangleSize;if(Math.abs(wt[0]-Tt)<=Lt){const ut=zr(wt,0,wt.length,Tt+Lt);return ut===wt.length||a(ut,kr(wt,ut+1,wt.length,Tt+360-Lt)-ut),It}Tt<wt[0]&&(Tt+=360);const Xt=kr(wt,0,wt.length,Tt-Lt);if(Xt===wt.length)return a(0,wt.length),It;a(0,Xt-0);const Yt=zr(wt,Xt+1,wt.length,Tt+Lt);return Yt!==wt.length&&a(Yt,wt.length-Yt),It}}const Zw=(Math.pow(256,2)-1)/16907520;class hb extends kl{constructor(ut,pt,wt,Tt){super(ut,qw,pt,wt,Tt),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(ut){return!(ut&&ut._source instanceof ub&&(ut._source.onNorthPole||ut._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(ut){"raster-color"!==ut&&"raster-color-range"!==ut||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(ut){if(!this.hasColorMap())return;if(!this._curRampRange)return;const pt=this._transitionablePaint._values["raster-color"].value.expression,[wt,Tt]=ut||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(wt)&&isNaN(Tt)||wt===this._curRampRange[0]&&Tt===this._curRampRange[1]||(this.colorRamp=gp({expression:pt,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:wt,end:Tt}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[wt,Tt])}}const $w=new ol({visibility:new il(x_["layout_raster-particle"].visibility)});var Ww={paint:new ol({"raster-particle-array-band":new il(x_["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new il(x_["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new al(x_["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new il(x_["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new il(x_["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new il(x_["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new il(x_["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:$w};class db extends kl{constructor(ut,pt,wt,Tt){super(ut,Ww,pt,wt,Tt),this._updateColorRamp(),this.lastInvalidatedAt=Ju.now()}onRemove(ut){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(ut){return!1}_handleSpecialPaintPropertyUpdate(ut){"raster-particle-color"!==ut&&"raster-particle-max-speed"!==ut||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===ut&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const ut=this._transitionablePaint._values["raster-particle-color"].value.expression,pt=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=gp({expression:ut,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:pt}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Ju.now()}}class mb extends kl{constructor(ut,pt){super(ut,{},pt,null),this.implementation=ut,ut.slot&&(this.slot=ut.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(ut){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(ut){this.implementation.onAdd&&this.implementation.onAdd(ut,ut.painter.context.gl)}onRemove(ut){this.implementation.onRemove&&this.implementation.onRemove(ut,ut.painter.context.gl)}}const Hw=new ol({visibility:new il(x_.layout_sky.visibility)});var Xw={paint:new ol({"sky-type":new il(x_.paint_sky["sky-type"]),"sky-atmosphere-sun":new il(x_.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new il(x_.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new il(x_.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new il(x_.paint_sky["sky-gradient-radius"]),"sky-gradient":new al(x_.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new il(x_.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new il(x_.paint_sky["sky-atmosphere-color"]),"sky-opacity":new il(x_.paint_sky["sky-opacity"])}),layout:Hw};function xb(pt,wt,Tt){const St=[0,0,1],It=ut.av.identity([]);return ut.av.rotateY(It,It,Tt?-$e(pt)+Math.PI:$e(pt)),ut.av.rotateX(It,It,-$e(wt)),ut._.transformQuat(St,St,It),ut._.normalize(St,St)}var Yw={paint:new ol({})};function vb(pt,wt){const Tt=wb(pt.projection,pt.zoom,pt.width,pt.height),St=function(pt,wt,Tt,St,It){const Lt=new mc(Tt.lng-180*Kw,Tt.lat),Xt=new mc(Tt.lng+180*Kw,Tt.lat),Yt=pt.project(Lt.lng,Lt.lat),Mi=pt.project(Xt.lng,Xt.lat),vr=-Math.atan2(Mi.y-Yt.y,Mi.x-Yt.x),br=Lc.fromLngLat(Tt);br.y=Ke(br.y,-1+Kw,1-Kw);const Ar=br.toLngLat(),Vr=pt.project(Ar.lng,Ar.lat),nn=Lc.fromLngLat(Ar);nn.x+=Kw;const sn=nn.toLngLat(),an=pt.project(sn.lng,sn.lat),ln=Sb(an.x-Vr.x,an.y-Vr.y,vr),cn=Lc.fromLngLat(Ar);cn.y+=Kw;const un=cn.toLngLat(),fn=pt.project(un.lng,un.lat),_n=Sb(fn.x-Vr.x,fn.y-Vr.y,vr),gn=Math.abs(ln.x)/Math.abs(_n.y),yn=ut.ad.identity([]);ut.ad.rotateZ(yn,yn,-vr*(1-(It?0:St)));const xn=ut.ad.identity([]);return ut.ad.scale(xn,xn,[1,1-(1-gn)*St,1]),xn[4]=-_n.x/_n.y*St,ut.ad.rotateZ(xn,xn,vr),ut.ad.multiply(xn,yn,xn),xn}(pt.projection,0,pt.center,Tt,wt),It=_b(pt);return ut.ad.scale(St,St,[It,It,1]),St}function _b(ut){const pt=ut.projection,wt=wb(ut.projection,ut.zoom,ut.width,ut.height),Tt=Ab(pt,ut.center),St=Ab(pt,mc.convert(pt.center));return Math.pow(2,Tt*wt+(1-wt)*St)}function wb(ut,pt,wt,Tt,St=1/0){const It=ut.range;if(!It)return 0;const Lt=Math.min(St,Math.max(wt,Tt)),Xt=Math.log(Lt/1024)/Math.LN2;return We(It[0]+Xt,It[1]+Xt,pt)}const Kw=1/4e4;function Ab(ut,pt){const wt=Ke(pt.lat,-Y_,Y_),Tt=new mc(pt.lng-180*Kw,wt),St=new mc(pt.lng+180*Kw,wt),It=ut.project(Tt.lng,wt),Lt=ut.project(St.lng,wt),Xt=Lc.fromLngLat(Tt),Yt=Lc.fromLngLat(St),Mi=Lt.x-It.x,vr=Lt.y-It.y,br=Yt.x-Xt.x,Ar=Yt.y-Xt.y,Vr=Math.sqrt((br*br+Ar*Ar)/(Mi*Mi+vr*vr));return Math.log(Vr)/Math.LN2}function Sb(ut,pt,wt){const Tt=Math.cos(wt),St=Math.sin(wt);return{x:ut*Tt-pt*St,y:ut*St+pt*Tt}}function Ib(pt,wt,Tt){ut.ad.identity(pt),ut.ad.rotateZ(pt,pt,$e(wt[2])),ut.ad.rotateX(pt,pt,$e(wt[0])),ut.ad.rotateY(pt,pt,$e(wt[1])),ut.ad.scale(pt,pt,Tt),ut.ad.multiply(pt,pt,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Tb(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=[Tt[0]-wt[0],Tt[1]-wt[1],0],vr=[St[0]-wt[0],St[1]-wt[1],0];if(ut._.length(Mi)<1e-12||ut._.length(vr)<1e-12)return ut.av.identity(pt);const br=ut._.cross([],Mi,vr);ut._.normalize(br,br),ut._.subtract(vr,St,wt),Mi[2]=(Lt-It)*Yt,vr[2]=(Xt-It)*Yt;const Ar=Mi;return ut._.cross(Ar,Mi,vr),ut._.normalize(Ar,Ar),ut.av.rotationTo(pt,br,Ar)}function kb(pt,wt,Tt=!1){const St=Hh(wt.zoom),It=function(pt,wt,Tt){const St=wt.worldSize,It=[pt[12],pt[13],pt[14]],Lt=Ec(It[1]/St),Xt=Pc(It[0]/St),Yt=ut.ad.identity([]),Mi=zc(1,Lt)*St,vr=zc(1,0)*St*Rc(Lt,wt.zoom),br=1/Xh(St);let Ar=vr*br;if(Tt){const ut=wb(wt.projection,wt.zoom,wt.width,wt.height,1024);Ar=br*wt.projection.pixelSpaceConversion(wt.center.lat,St,ut)}const Vr=pc(Lt,Xt);ut._.add(Vr,Vr,ut._.scale([],ut._.normalize([],Vr),Mi*Ar*It[2]));const nn=function(pt){const wt=[pt[0],pt[1],pt[2]];let Tt=[0,1,0];const St=ut._.cross([],Tt,wt);return ut._.cross(Tt,wt,St),0===ut._.squaredLength(Tt)&&(Tt=[0,1,0],ut._.cross(St,wt,Tt)),ut._.normalize(St,St),ut._.normalize(Tt,Tt),ut._.normalize(wt,wt),[St[0],St[1],St[2],0,Tt[0],Tt[1],Tt[2],0,wt[0],wt[1],wt[2],0,pt[0],pt[1],pt[2],1]}(Vr);ut.ad.scale(Yt,Yt,[Ar,Ar,Ar*Mi]),ut.ad.translate(Yt,Yt,[-It[0],-It[1],-It[2]]);const sn=ut.ad.multiply([],wt.globeMatrix,nn);return ut.ad.multiply(sn,sn,Yt),ut.ad.multiply(sn,sn,pt),sn}(pt,wt,Tt);if(St>0){const Tt=function(pt,wt){const Tt=wt.worldSize,St=zc(1,0)*Tt*Rc(wt.center.lat,wt.zoom)/Xh(Tt),It=zc(1,wt.center.lat)*Tt,Lt=ut.ad.identity([]);return ut.ad.rotateY(Lt,Lt,$e(wt.center.lng)),ut.ad.rotateX(Lt,Lt,$e(wt.center.lat)),ut.ad.translate(Lt,Lt,[0,0,k_]),ut.ad.scale(Lt,Lt,[St,St,St*It]),ut.ad.translate(Lt,Lt,[wt.point.x-.5*Tt,wt.point.y-.5*Tt,0]),ut.ad.multiply(Lt,Lt,pt),ut.ad.multiply(Lt,wt.globeMatrix,Lt)}(pt,wt);return function(pt,wt,Tt){const i=(pt,wt,Tt)=>{const St=ut._.length(pt),It=ut._.length(wt),Lt=Rh(pt,wt,Tt);return ut._.scale(Lt,Lt,1/ut._.length(Lt)*Gn(St,It,Tt))},St=i([pt[0],pt[1],pt[2]],[wt[0],wt[1],wt[2]],Tt),It=i([pt[4],pt[5],pt[6]],[wt[4],wt[5],wt[6]],Tt),Lt=i([pt[8],pt[9],pt[10]],[wt[8],wt[9],wt[10]],Tt),Xt=Rh([pt[12],pt[13],pt[14]],[wt[12],wt[13],wt[14]],Tt);return[St[0],St[1],St[2],0,It[0],It[1],It[2],0,Lt[0],Lt[1],Lt[2],0,Xt[0],Xt[1],Xt[2],1]}(It,Tt,St)}return It}function zb(ut,pt,wt,Tt){const St=Ah.projectAabbCorners(Tt,wt);let It=Number.MAX_VALUE,Lt=-1;for(let ut=0;ut<St.length;++ut){const wt=St[ut];wt[0]=(.5*wt[0]+.5)*pt.width,wt[1]=(.5-.5*wt[1])*pt.height,wt[2]<It&&(Lt=ut,It=wt[2])}const o=ut=>new xc(St[ut][0],St[ut][1]);let Xt;switch(Lt){case 0:case 6:Xt=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:Xt=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:Xt=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:Xt=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Wc(ut,Xt))return It}const Jw=Bl([{name:"a_pos_3f",components:3,type:"Float32"}]),Qw=Bl([{name:"a_color_3f",components:3,type:"Float32"}]),eT=Bl([{name:"a_color_4f",components:4,type:"Float32"}]),tT=Bl([{name:"a_uv_2f",components:2,type:"Float32"}]),iT=Bl([{name:"a_normal_3f",components:3,type:"Float32"}]),rT=Bl([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),nT=Bl([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Fb{constructor(ut,pt,wt,Tt){this.message=(ut?`${ut}: `:"")+wt,Tt&&(this.identifier=Tt),null!=pt&&pt.__line__&&(this.line=pt.__line__)}}function Lb(ut,pt){const wt=-1===ut.indexOf("://");try{return new URL(ut,wt&&pt?"http://example.com":void 0),!0}catch(ut){return!1}}class Ob{constructor(ut,pt){this.feature=ut,this.instancedDataOffset=pt,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Ub{constructor(){this.instancedDataArray=new ou,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Nb{constructor(ut){this.zoom=ut.zoom,this.canonical=ut.canonical,this.layers=ut.layers,this.layerIds=this.layers.map((ut=>ut.fqid)),this.projection=ut.projection,this.index=ut.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((ut=>ut.isStateDependent())).map((ut=>ut.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(ut,pt){}populate(ut,pt,wt,Tt){this.tileToMeter=Fc(wt);const St=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:It,id:Lt,index:Xt,sourceLayerIndex:Yt}of ut){const ut=null!=Lt?Lt:It.properties&&It.properties.hasOwnProperty("id")?It.properties.id:void 0,Mi=Yc(It,St);if(!this.layers[0]._featureFilter.filter(new Ho(this.zoom),Mi,wt))continue;const vr={id:ut,sourceLayerIndex:Yt,index:Xt,geometry:St?Mi.geometry:Xc(It,wt,Tt),properties:It.properties,type:It.type,patterns:{}},br=this.addFeature(vr,vr.geometry,Mi);br&&pt.featureIndex.insert(It,vr.geometry,Xt,Yt,this.index,this.instancesPerModel[br].instancedDataArray.length,xf/32)}this.lookup=null}update(ut,pt,wt,Tt){for(const pt in this.instancesPerModel){const wt=this.instancesPerModel[pt];for(const pt in ut)wt.idToFeaturesIndex.hasOwnProperty(pt)&&(this.evaluate(wt.features[wt.idToFeaturesIndex[pt]],ut[pt],wt,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let pt=!1;for(const wt in this.instancesPerModel){const Tt=this.instancesPerModel[wt];for(const wt of Tt.features){const St=this.layers[0],It=wt.feature,Lt=this.canonical,Xt=St.paint.get("model-rotation").evaluate(It,{},Lt),Yt=St.paint.get("model-scale").evaluate(It,{},Lt),Mi=St.paint.get("model-translation").evaluate(It,{},Lt);ut._.exactEquals(wt.rotation,Xt)&&ut._.exactEquals(wt.scale,Yt)&&ut._.exactEquals(wt.translation,Mi)||(this.evaluate(wt,wt.featureStates,Tt,!0),pt=!0)}}return pt}updateReplacement(ut,pt,wt){if(pt.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=pt.updateTime;const Tt=pt.getReplacementRegionsForTile(ut.toUnwrapped(),!0);if(Cf(this.activeReplacements,Tt))return!1;this.activeReplacements=Tt;let St=!1;for(const pt in this.instancesPerModel){const Tt=this.instancesPerModel[pt],It=Tt.instancedDataArray;for(const pt of Tt.features){const Tt=pt.instancedDataOffset,Lt=pt.instancedDataCount;for(let pt=0;pt<Lt;pt++){const Lt=16*(pt+Tt);let Xt=It.float32[Lt+0];Xt=Xt>xf?Xt-xf:Xt;const Yt=Math.floor(Xt),Mi=It.float32[Lt+1];let vr=!1;for(const pt of this.activeReplacements)if(!(pt.order<wt||pt.order===1/0)&&pt.clipMask&hx.Model&&!(pt.min.x>Yt||Yt>pt.max.x||pt.min.y>Mi||Mi>pt.max.y)&&(vr=Uf(Of(Yt,Mi,ut.canonical,pt.footprintTileId.canonical),pt),vr))break;It.float32[Lt]=vr?Xt+xf:Xt,St=St||vr}}}return St}isEmpty(){for(const ut in this.instancesPerModel)if(0!==this.instancesPerModel[ut].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(ut){if(!this.uploaded)for(const pt in this.instancesPerModel){const wt=this.instancesPerModel[pt];wt.instancedDataArray.length<0||0===wt.instancedDataArray.length||(wt.instancedDataBuffer?wt.instancedDataBuffer.updateData(wt.instancedDataArray):wt.instancedDataBuffer=ut.createVertexBuffer(wt.instancedDataArray,rT.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const ut in this.instancesPerModel){const pt=this.instancesPerModel[ut];0!==pt.instancedDataArray.length&&pt.instancedDataBuffer&&pt.instancedDataBuffer.destroy()}const ut=this.layers[0].modelManager;if(ut&&this.modelUris)for(const pt of this.modelUris)ut.removeModel(pt,"")}addFeature(ut,pt,wt){const Tt=this.layers[0],St=Tt.layout.get("model-id").evaluate(wt,{},this.canonical);if(!St)return fr(`modelId is not evaluated for layer ${Tt.id} and it is not going to get rendered.`),St;Lb(St,!1)&&(this.modelUris.includes(St)||this.modelUris.push(St)),this.instancesPerModel[St]||(this.instancesPerModel[St]=new Ub);const It=this.instancesPerModel[St],Lt=It.instancedDataArray,Xt=new Ob(wt,Lt.length);for(const ut of pt)for(const pt of ut){if(pt.x<0||pt.x>=xf||pt.y<0||pt.y>=xf)continue;const ut=(this.lookupDim-1)/xf,wt=this.lookupDim*(pt.y*ut|0)+pt.x*ut|0;if(this.lookup){if(0!==this.lookup[wt])continue;this.lookup[wt]=1}this.instanceCount++;const Tt=Lt.length;Lt.resize(Tt+1),It.instancesEvaluatedElevation.push(0),Lt.float32[16*Tt]=pt.x,Lt.float32[16*Tt+1]=pt.y}return Xt.instancedDataCount=It.instancedDataArray.length-Xt.instancedDataOffset,Xt.instancedDataCount>0&&(ut.id&&(It.idToFeaturesIndex[ut.id]=It.features.length),It.features.push(Xt),this.evaluate(Xt,{},It,!1)),St}getModelUris(){return this.modelUris}evaluate(ut,pt,wt,Tt){const St=this.layers[0],It=ut.feature,Lt=this.canonical,Xt=ut.rotation=St.paint.get("model-rotation").evaluate(It,pt,Lt),Yt=ut.scale=St.paint.get("model-scale").evaluate(It,pt,Lt),Mi=ut.translation=St.paint.get("model-translation").evaluate(It,pt,Lt),vr=St.paint.get("model-color").evaluate(It,pt,Lt);vr.a=St.paint.get("model-color-mix-intensity").evaluate(It,pt,Lt);const br=[];this.maxVerticalOffset<Mi[2]&&(this.maxVerticalOffset=Mi[2]),this.maxScale=Math.max(Math.max(this.maxScale,Yt[0]),Math.max(Yt[1],Yt[2])),Ib(br,Xt,Yt);const Ar=Math.round(100*vr.a)+vr.b/1.05;for(let pt=0;pt<ut.instancedDataCount;++pt){const St=ut.instancedDataOffset+pt,It=16*St,Xt=wt.instancedDataArray.float32;let Yt=0;Tt&&(Yt=Xt[It+6]-wt.instancesEvaluatedElevation[St]);const Vr=0|Xt[It+1];Xt[It]=(0|Xt[It])+vr.r/1.05,Xt[It+1]=Vr+vr.g/1.05,Xt[It+2]=Ar,Xt[It+3]=1/(Lt.z>10?this.tileToMeter:Fc(Lt,Vr)),Xt[It+4]=Mi[0],Xt[It+5]=Mi[1],Xt[It+6]=Mi[2]+Yt,Xt[It+7]=br[0],Xt[It+8]=br[1],Xt[It+9]=br[2],Xt[It+10]=br[4],Xt[It+11]=br[5],Xt[It+12]=br[6],Xt[It+13]=br[8],Xt[It+14]=br[9],Xt[It+15]=br[10],wt.instancesEvaluatedElevation[St]=Mi[2]}}}Mo(Nb,"ModelBucket",{omit:["layers"]}),Mo(Ub,"PerModelAttributes"),Mo(Ob,"ModelFeature");const oT=new ol({visibility:new il(x_.layout_model.visibility),"model-id":new sl(x_.layout_model["model-id"])});var sT={paint:new ol({"model-opacity":new il(x_.paint_model["model-opacity"]),"model-rotation":new sl(x_.paint_model["model-rotation"]),"model-scale":new sl(x_.paint_model["model-scale"]),"model-translation":new sl(x_.paint_model["model-translation"]),"model-color":new sl(x_.paint_model["model-color"]),"model-color-mix-intensity":new sl(x_.paint_model["model-color-mix-intensity"]),"model-type":new il(x_.paint_model["model-type"]),"model-cast-shadows":new il(x_.paint_model["model-cast-shadows"]),"model-receive-shadows":new il(x_.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new il(x_.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new sl(x_.paint_model["model-emissive-strength"]),"model-roughness":new sl(x_.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new sl(x_.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new il(x_.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new il(x_.paint_model["model-front-cutoff"])}),layout:oT};const aT=64,lT={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Xb(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr=!1){const br=Tt.zoom,Ar=Tt.project(St),Vr=Rc(St.lat,br),nn=1/Vr;ut.ad.identity(pt),ut.ad.translate(pt,pt,[Ar.x+Xt[0]*nn,Ar.y+Xt[1]*nn,Xt[2]]);let sn=1,an=1;const ln=Tt.worldSize;if(vr){if("mercator"===Tt.projection.name){let pt=0;Tt.elevation&&(pt=Tt.elevation.getAtPointOrZero(new Lc(Ar.x/ln,Ar.y/ln),0));const wt=ut.aA.transformMat4([],[Ar.x,Ar.y,pt,1],Tt.projMatrix)[3]/Tt.cameraToCenterDistance;sn=wt,an=wt*Rc(Tt.center.lat,br)}else if("globe"===Tt.projection.name){const wt=kb(pt,Tt),It=ut.ad.multiply([],Tt.projMatrix,wt),Lt=[0,0,0,1];ut.aA.transformMat4(Lt,Lt,It);const Xt=Lt[3]/Tt.cameraToCenterDistance,Yt=Hh(br),Mi=Tt.projection.pixelsPerMeter(St.lat,ln)*Rc(St.lat,br),vr=Tt.projection.pixelsPerMeter(Tt.center.lat,ln)*Rc(Tt.center.lat,br);sn=Xt/Gn(Mi,Cc(Tt.center.lat),Yt),an=Xt*Vr/Mi,sn*=vr,an*=vr}}else sn=nn;ut.ad.scale(pt,pt,[sn,sn,an]);const cn=[...pt],un=wt.orientation,fn=[];if(Ib(fn,[un[0]+It[0],un[1]+It[1],un[2]+It[2]],Lt),ut.ad.multiply(pt,cn,fn),Yt&&Tt.elevation){let It=0;const Lt=[];if(Mi&&Tt.elevation){It=function(pt,wt,Tt,St,It){const Lt=wt.elevation;if(!Lt)return 0;const Xt=Ah.projectAabbCorners(Tt,St),Yt=zc(1,It.lat)*wt.worldSize,Mi=function(pt,wt){const Tt=[0,0,1],St=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const It of St){const St=pt[It.corners[0]],Lt=pt[It.corners[1]],Xt=pt[It.corners[2]],Yt=[Lt[0]-St[0],Lt[1]-St[1],wt*(Lt[2]-St[2])],Mi=ut._.cross(Yt,Yt,[Xt[0]-St[0],Xt[1]-St[1],wt*(Xt[2]-St[2])]);ut._.normalize(Mi,Mi),It.dotProductWithUp=ut._.dot(Mi,Tt)}return St.sort(((ut,pt)=>ut.dotProductWithUp-pt.dotProductWithUp)),St[0].corners}(Xt,Yt),vr=Xt[Mi[0]],br=Xt[Mi[1]],Ar=Xt[Mi[2]],Vr=Xt[Mi[3]],nn=Lt.getAtPointOrZero(new Lc(vr[0]/wt.worldSize,vr[1]/wt.worldSize),0),sn=Lt.getAtPointOrZero(new Lc(br[0]/wt.worldSize,br[1]/wt.worldSize),0),an=Lt.getAtPointOrZero(new Lc(Ar[0]/wt.worldSize,Ar[1]/wt.worldSize),0),ln=Lt.getAtPointOrZero(new Lc(Vr[0]/wt.worldSize,Vr[1]/wt.worldSize),0),cn=(nn+ln)/2,un=(sn+an)/2;return cn>un?sn<an?Tb(pt,br,Vr,vr,sn,ln,nn,Yt):Tb(pt,Ar,vr,Vr,an,nn,ln,Yt):nn<ln?Tb(pt,vr,br,Ar,nn,sn,an,Yt):Tb(pt,Vr,Ar,br,ln,an,sn,Yt),Math.max(cn,un)}(Lt,Tt,wt.aabb,pt,St);const Xt=ut.ad.fromQuat([],Lt),Yt=ut.ad.multiply([],Xt,fn);ut.ad.multiply(pt,cn,Yt)}else It=Tt.elevation.getAtPointOrZero(new Lc(Ar.x/ln,Ar.y/ln),0);0!==It&&(pt[14]+=It)}}function Yb(ut,pt,wt=!1){ut.uploaded||(ut.gfxTexture=new Gg(pt,ut.image,wt?pt.gl.R8:pt.gl.RGBA,{useMipmap:ut.sampler.minFilter>=pt.gl.NEAREST_MIPMAP_NEAREST}),ut.uploaded=!0,ut.image=null)}function Zb(ut,pt,wt){ut.indexBuffer=pt.createIndexBuffer(ut.indexArray,!1,!0),ut.vertexBuffer=pt.createVertexBuffer(ut.vertexArray,Jw.members,!1,!0),ut.normalArray&&(ut.normalBuffer=pt.createVertexBuffer(ut.normalArray,iT.members,!1,!0)),ut.texcoordArray&&(ut.texcoordBuffer=pt.createVertexBuffer(ut.texcoordArray,tT.members,!1,!0)),ut.colorArray&&(ut.colorBuffer=pt.createVertexBuffer(ut.colorArray,(12===ut.colorArray.bytesPerElement?Qw:eT).members,!1,!0)),ut.featureArray&&(ut.pbrBuffer=pt.createVertexBuffer(ut.featureArray,nT.members,!0)),ut.segments=Au.simpleSegment(0,0,ut.vertexArray.length,ut.indexArray.length);const Tt=ut.material;Tt.pbrMetallicRoughness.baseColorTexture&&Yb(Tt.pbrMetallicRoughness.baseColorTexture,pt),Tt.pbrMetallicRoughness.metallicRoughnessTexture&&Yb(Tt.pbrMetallicRoughness.metallicRoughnessTexture,pt),Tt.normalTexture&&Yb(Tt.normalTexture,pt),Tt.occlusionTexture&&Yb(Tt.occlusionTexture,pt,wt),Tt.emissionTexture&&Yb(Tt.emissionTexture,pt)}function Hb(ut,pt,wt){if(ut.meshes)for(const Tt of ut.meshes)Zb(Tt,pt,wt);if(ut.children)for(const Tt of ut.children)Hb(Tt,pt,wt)}function Kb(ut){if(ut.meshes)for(const pt of ut.meshes)pt.indexArray.destroy(),pt.vertexArray.destroy(),pt.colorArray&&pt.colorArray.destroy(),pt.normalArray&&pt.normalArray.destroy(),pt.texcoordArray&&pt.texcoordArray.destroy(),pt.featureArray&&pt.featureArray.destroy();if(ut.children)for(const pt of ut.children)Kb(pt)}function Wb(ut){if(ut.meshes)for(const wt of ut.meshes)wt.vertexBuffer&&(wt.vertexBuffer.destroy(),wt.indexBuffer.destroy(),wt.normalBuffer&&wt.normalBuffer.destroy(),wt.texcoordBuffer&&wt.texcoordBuffer.destroy(),wt.colorBuffer&&wt.colorBuffer.destroy(),wt.pbrBuffer&&wt.pbrBuffer.destroy(),wt.segments.destroy(),wt.material&&((pt=wt.material).pbrMetallicRoughness.baseColorTexture&&pt.pbrMetallicRoughness.baseColorTexture.gfxTexture&&pt.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),pt.pbrMetallicRoughness.metallicRoughnessTexture&&pt.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&pt.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),pt.normalTexture&&pt.normalTexture.gfxTexture&&pt.normalTexture.gfxTexture.destroy(),pt.emissionTexture&&pt.emissionTexture.gfxTexture&&pt.emissionTexture.gfxTexture.destroy(),pt.occlusionTexture&&pt.occlusionTexture.gfxTexture&&pt.occlusionTexture.gfxTexture.destroy()));var pt;if(ut.children)for(const pt of ut.children)Wb(pt)}class Jb{constructor(ut){this._callback=ut,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Qb{constructor(){this.tasks={},this.taskQueue=[],or(["process"],this),this.invoker=new Jb(this.process),this.nextId=0}add(ut,pt){const wt=this.nextId++,Tt=function({type:ut,isSymbolTile:pt,zoom:wt}){return wt=wt||0,"message"===ut?0:"maybePrepare"!==ut||pt?"parseTile"!==ut||pt?"parseTile"===ut&&pt?300-wt:"maybePrepare"===ut&&pt?400-wt:500:200-wt:100-wt}(pt);if(0===Tt){try{ut()}finally{}return null}return this.tasks[wt]={fn:ut,metadata:pt,priority:Tt,id:wt},this.taskQueue.push(wt),this.invoker.trigger(),{cancel:()=>{delete this.tasks[wt]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((ut=>!!this.tasks[ut])),!this.taskQueue.length)return;const ut=this.pick();if(null===ut)return;const pt=this.tasks[ut];if(delete this.tasks[ut],this.taskQueue.length&&this.invoker.trigger(),!pt)return;pt.fn()}finally{}}pick(){let ut=null,pt=1/0;for(let wt=0;wt<this.taskQueue.length;wt++){const Tt=this.tasks[this.taskQueue[wt]];Tt.priority<pt&&(pt=Tt.priority,ut=wt)}if(null===ut)return null;const wt=this.taskQueue[ut];return this.taskQueue.splice(ut,1),wt}remove(){this.invoker.remove()}}class tv{constructor(ut,pt,wt){this.target=ut,this.parent=pt,this.mapId=wt,this.callbacks={},this.cancelCallbacks={},or(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Qb}send(ut,pt,wt,Tt,St=!1,It){const Lt=Math.round(1e18*Math.random()).toString(36).substring(0,10);wt&&(wt.metadata=It,this.callbacks[Lt]=wt);const Xt=new Set;return this.target.postMessage({id:Lt,type:ut,hasCallback:!!wt,targetMapId:Tt,mustQueue:St,sourceMapId:this.mapId,data:Io(pt,Xt)},Xt),{cancel:()=>{wt&&delete this.callbacks[Lt],this.target.postMessage({id:Lt,type:"<cancel>",targetMapId:Tt,sourceMapId:this.mapId})}}}receive(ut){const pt=ut.data,wt=pt.id;if(wt&&(!pt.targetMapId||this.mapId===pt.targetMapId))if("<cancel>"===pt.type){const ut=this.cancelCallbacks[wt];delete this.cancelCallbacks[wt],ut&&ut.cancel()}else if(pt.mustQueue||gr()){const ut=this.callbacks[wt],Tt=this.scheduler.add((()=>this.processTask(wt,pt)),ut&&ut.metadata||{type:"message"});Tt&&(this.cancelCallbacks[wt]=Tt)}else this.processTask(wt,pt)}processTask(ut,pt){if(delete this.cancelCallbacks[ut],"<response>"===pt.type){const wt=this.callbacks[ut];delete this.callbacks[ut],wt&&(pt.error?wt(To(pt.error)):wt(null,To(pt.data)))}else{const wt=new Set,Tt=pt.hasCallback?(pt,Tt)=>{this.target.postMessage({id:ut,type:"<response>",sourceMapId:this.mapId,error:pt?Io(pt):null,data:Io(Tt,wt)},wt)}:ut=>{},St=To(pt.data);if(this.parent[pt.type])this.parent[pt.type](pt.sourceMapId,St,Tt);else if(this.parent.getWorkerSource){const ut=pt.type.split(".");this.parent.getWorkerSource(pt.sourceMapId,ut[0],St.source,St.scope)[ut[1]](St,Tt)}else Tt(new Error(`Could not find function ${pt.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class ev{constructor(ut,pt){this.workerPool=ut,this.actors=[],this.currentActor=0,this.id=nr();const wt=this.workerPool.acquire(this.id);for(let ut=0;ut<wt.length;ut++){const Tt=new ev.Actor(wt[ut],pt,this.id);Tt.name=`Worker ${ut}`,this.actors.push(Tt)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(ut,pt,wt){Qe(this.actors,((wt,Tt)=>{wt.send(ut,pt,Tt)}),wt=wt||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((ut=>{ut.remove()})),this.actors=[],this.workerPool.release(this.id)}}ev.Actor=tv;var cT={workerUrl:"",workerClass:null,workerParams:void 0};function nv(){return null!=cT.workerClass?new cT.workerClass:new self.Worker(cT.workerUrl,cT.workerParams)}const uT="mapboxgl_preloaded_worker_pool";class sv{constructor(){this.active={}}acquire(ut){if(!this.workers)for(this.workers=[];this.workers.length<sv.workerCount;)this.workers.push(new nv);return this.active[ut]=!0,this.workers.slice()}release(ut){delete this.active[ut],this.workers&&0===this.numActive()&&(this.workers.forEach((ut=>{ut.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[uT]}numActive(){return Object.keys(this.active).length}}let hT;function ov(){return hT||(hT=new sv),hT}sv.workerCount=2;let dT,pT,fT,mT,_T,gT=null;function dv(){return gr()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:pT||It.DRACO_URL}function mv(){if(gr()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(mT)return mT;const ut=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return mT=WebAssembly.validate(ut)?It.MESHOPT_SIMD_URL:It.MESHOPT_URL,mT}const yT={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},xT={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},vT={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function bv(ut,pt,wt){const Tt=wt.json.bufferViews.length,St=wt.buffers.length;pt.bufferView=Tt,wt.json.bufferViews[Tt]={buffer:St,byteLength:ut.byteLength},wt.buffers[St]=ut}const bT="KHR_draco_mesh_compression";function _v(ut,pt){const wt=ut.extensions&&ut.extensions[bT];if(!wt)return;const Tt=new fT.Decoder,St=kv(pt,wt.bufferView),It=new fT.Mesh;if(!Tt.DecodeArrayToMesh(St,St.byteLength,It))throw new Error("Failed to decode Draco mesh");const Lt=pt.json.accessors[ut.indices],Xt=yT[Lt.componentType],Yt=Lt.count*Xt.BYTES_PER_ELEMENT,Mi=fT._malloc(Yt);Xt===Uint16Array?Tt.GetTrianglesUInt16Array(It,Yt,Mi):Tt.GetTrianglesUInt32Array(It,Yt,Mi),bv(fT.memory.buffer.slice(Mi,Mi+Yt),Lt,pt),fT._free(Mi);for(const St of Object.keys(wt.attributes)){const Lt=Tt.GetAttributeByUniqueId(It,wt.attributes[St]),Xt=pt.json.accessors[ut.attributes[St]],Yt=xT[Xt.componentType],Mi=Xt.count*vT[Xt.type]*yT[Xt.componentType].BYTES_PER_ELEMENT,vr=fT._malloc(Mi);Tt.GetAttributeDataArrayForAllPoints(It,Lt,fT[Yt],Mi,vr),bv(fT.memory.buffer.slice(vr,vr+Mi),Xt,pt),fT._free(vr)}Tt.destroy(),It.destroy(),delete ut.extensions[bT]}const wT="EXT_meshopt_compression";function Mv(ut,pt){if(!ut.extensions||!ut.extensions[wT])return;const wt=ut.extensions[wT],Tt=new Uint8Array(pt.buffers[wt.buffer],wt.byteOffset||0,wt.byteLength||0),St=new Uint8Array(wt.count*wt.byteStride);_T.decodeGltfBuffer(St,wt.count,wt.byteStride,Tt,wt.mode,wt.filter),ut.buffer=pt.buffers.length,ut.byteOffset=0,pt.buffers[ut.buffer]=St.buffer,delete ut.extensions[wT]}const TT=1179937895,ET=new TextDecoder("utf8");function Iv(ut,pt){return new URL(ut,pt).href}function Tv(ut,pt,wt,Tt){return fetch(Iv(ut.uri,Tt)).then((ut=>ut.arrayBuffer())).then((ut=>{pt.buffers[wt]=ut}))}function kv(ut,pt){const wt=ut.json.bufferViews[pt];return new Uint8Array(ut.buffers[wt.buffer],wt.byteOffset||0,wt.byteLength)}function zv(ut,pt,wt,Tt){if(ut.uri){const St=Iv(ut.uri,Tt);return fetch(St).then((ut=>ut.blob())).then((ut=>createImageBitmap(ut))).then((ut=>{pt.images[wt]=ut}))}if(void 0!==ut.bufferView){const Tt=kv(pt,ut.bufferView),St=new Blob([Tt],{type:ut.mimeType});return createImageBitmap(St).then((ut=>{pt.images[wt]=ut}))}}function Pv(ut,pt=0,wt){const Tt={json:null,images:[],buffers:[]};if(new Uint32Array(ut,pt,1)[0]===TT){const wt=new Uint32Array(ut,pt);let St=2;const It=(wt[St++]>>2)-3,Lt=wt[St++]>>2;if(St++,Tt.json=JSON.parse(ET.decode(wt.subarray(St,St+Lt))),St+=Lt,St<It){const It=wt[St++];St++;const Lt=pt+(St<<2);Tt.buffers[0]=ut.slice(Lt,Lt+It)}}else Tt.json=JSON.parse(ET.decode(new Uint8Array(ut,pt)));const{buffers:St,images:It,meshes:Lt,extensionsUsed:Xt,bufferViews:Yt}=Tt.json;let Mi=Promise.resolve();if(St){const ut=[];for(let pt=0;pt<St.length;pt++){const It=St[pt];It.uri?ut.push(Tv(It,Tt,pt,wt)):Tt.buffers[pt]||(Tt.buffers[pt]=null)}Mi=Promise.all(ut)}return Mi.then((()=>{const ut=[],pt=Xt&&Xt.includes(bT),St=Xt&&Xt.includes(wT);if(pt&&ut.push(function(){if(!fT)return dT||(dT=function(ut){let pt,wt=null;function n(){pt=new Uint8Array(wt.buffer)}function i(){throw new Error("Unexpected Draco error.")}const Tt={a:{a:i,d:function(ut,wt,Tt){return pt.copyWithin(ut,wt,wt+Tt)},c:function(ut){const Tt=pt.length,St=Math.max(ut>>>0,Math.ceil(1.2*Tt)),It=Math.ceil((St-Tt)/65536);try{return wt.grow(It),n(),!0}catch(ut){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(ut,Tt):ut.then((ut=>ut.arrayBuffer())).then((ut=>WebAssembly.instantiate(ut,Tt)))).then((ut=>{const{Rb:Tt,Qb:St,P:It,T:Lt,X:Xt,Ja:Yt,La:Mi,Qa:vr,Va:br,Wa:Ar,eb:Vr,jb:nn,f:sn,e:an,yb:ln,zb:cn,Ab:un,Bb:fn,Db:_n,Gb:gn}=ut.instance.exports;wt=an;const yn=(()=>{let ut=0,wt=0,It=0,Lt=0;return Xt=>{It&&(Tt(Lt),Tt(ut),wt+=It,It=ut=0),ut||(wt+=128,ut=St(wt));const Yt=Xt.length+7&-8;let Mi=ut;Yt>=wt&&(It=Yt,Mi=Lt=St(Yt));for(let ut=0;ut<Xt.length;ut++)pt[Mi+ut]=Xt[ut];return Mi}})();return n(),sn(),{memory:an,_free:Tt,_malloc:St,Mesh:class{constructor(){this.ptr=It()}destroy(){Lt(this.ptr)}},Decoder:class{constructor(){this.ptr=Yt()}destroy(){nn(this.ptr)}DecodeArrayToMesh(ut,pt,wt){const Tt=yn(ut),St=Mi(this.ptr,Tt,pt,wt.ptr);return!!Xt(St)}GetAttributeByUniqueId(ut,pt){return{ptr:vr(this.ptr,ut.ptr,pt)}}GetTrianglesUInt16Array(ut,pt,wt){br(this.ptr,ut.ptr,pt,wt)}GetTrianglesUInt32Array(ut,pt,wt){Ar(this.ptr,ut.ptr,pt,wt)}GetAttributeDataArrayForAllPoints(ut,pt,wt,Tt,St){Vr(this.ptr,ut.ptr,pt.ptr,wt,Tt,St)}},DT_INT8:ln(),DT_UINT8:cn(),DT_INT16:un(),DT_UINT16:fn(),DT_UINT32:_n(),DT_FLOAT32:gn()}}))}(fetch(dv())),dT.then((ut=>{fT=ut,dT=void 0})))}()),St&&ut.push(function(){if(_T)return;const ut=function(ut){let pt;const wt=WebAssembly.instantiateStreaming(ut,{}).then((ut=>{pt=ut.instance,pt.exports.__wasm_call_ctors()})),Tt={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},St={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:wt,supported:!0,decodeGltfBuffer(ut,wt,It,Lt,Xt,Yt){!function(ut,pt,wt,Tt,St,It,Lt){const Xt=ut.exports.sbrk,Yt=Tt+3&-4,Mi=Xt(Yt*St),vr=Xt(It.length),br=new Uint8Array(ut.exports.memory.buffer);br.set(It,vr);const Ar=pt(Mi,Tt,St,vr,It.length);if(0===Ar&&Lt&&Lt(Mi,Yt,St),wt.set(br.subarray(Mi,Mi+Tt*St)),Xt(Mi-Xt(0)),0!==Ar)throw new Error(`Malformed buffer data: ${Ar}`)}(pt,pt.exports[St[Xt]],ut,wt,It,Lt,pt.exports[Tt[Yt]])}}}(fetch(mv()));return ut.ready.then((()=>{_T=ut}))}()),It)for(let pt=0;pt<It.length;pt++)ut.push(zv(It[pt],Tt,pt,wt));return(ut.length?Promise.all(ut):Promise.resolve()).then((()=>{if(pt&&Lt)for(const{primitives:ut}of Lt)for(const pt of ut)_v(pt,Tt);if(St&&Lt&&Yt)for(const ut of Yt)Mv(ut,Tt);return Tt}))}))}function Ev(ut,pt){const wt=ut.json.bufferViews[pt.bufferView],Tt=yT[pt.componentType];return new Tt(ut.buffers[wt.buffer],(pt.byteOffset||0)+(wt.byteOffset||0),pt.count*(wt.byteStride&&wt.byteStride!==vT[pt.type]*Tt.BYTES_PER_ELEMENT?wt.byteStride/Tt.BYTES_PER_ELEMENT:vT[pt.type]))}function Bv(ut,pt,wt,Tt){const St=yT[pt.componentType],It=function(ut){switch(ut){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(St),Lt=ut.json.bufferViews[pt.bufferView],Xt=Lt.byteStride?Lt.byteStride/St.BYTES_PER_ELEMENT:vT[pt.type],Yt=wt.float32,Mi=Yt.length/wt.capacity;for(let ut=0,wt=0;ut<pt.count*Xt;ut+=Xt,wt+=Mi)for(let pt=0;pt<Mi;pt++)Yt[wt+pt]=Tt[ut+pt]*It;wt._trim()}function Dv(ut,pt,wt){const Tt=ut.indices,St=ut.attributes,It={};It.indexArray=new Ql;const Lt=pt.json.accessors[Tt],Xt=Lt.count/3;It.indexArray.reserve(Xt);const Yt=Ev(pt,Lt);for(let ut=0;ut<Xt;ut++)It.indexArray.emplaceBack(Yt[3*ut],Yt[3*ut+1],Yt[3*ut+2]);It.indexArray._trim(),It.vertexArray=new Ul;const Mi=pt.json.accessors[St.POSITION];It.vertexArray.reserve(Mi.count);const vr=Ev(pt,Mi);for(let ut=0;ut<Mi.count;ut++)It.vertexArray.emplaceBack(vr[3*ut],vr[3*ut+1],vr[3*ut+2]);if(It.vertexArray._trim(),It.aabb=new Ah(Mi.min,Mi.max),It.centroid=function(ut,pt){const wt=[0,0,0],Tt=ut.length;if(Tt>0){for(let St=0;St<Tt;St++){const Tt=3*ut[St];wt[0]+=pt[Tt],wt[1]+=pt[Tt+1],wt[2]+=pt[Tt+2]}wt[0]/=Tt,wt[1]/=Tt,wt[2]/=Tt}return wt}(Yt,vr),void 0!==St.COLOR_0){const ut=pt.json.accessors[St.COLOR_0],wt=vT[ut.type],Tt=Ev(pt,ut);It.colorArray=3===wt?new Ul:new Ol,It.colorArray.resize(ut.count),Bv(pt,ut,It.colorArray,Tt)}if(void 0!==St.NORMAL){It.normalArray=new Ul;const ut=pt.json.accessors[St.NORMAL];It.normalArray.resize(ut.count);const wt=Ev(pt,ut);Bv(pt,ut,It.normalArray,wt)}if(void 0!==St.TEXCOORD_0&&wt.length>0){It.texcoordArray=new iu;const ut=pt.json.accessors[St.TEXCOORD_0];It.texcoordArray.resize(ut.count);const wt=Ev(pt,ut);Bv(pt,ut,It.texcoordArray,wt)}if(void 0!==St._FEATURE_ID_RGBA4444){const ut=pt.json.accessors[St._FEATURE_ID_RGBA4444];pt.json.extensionsUsed&&pt.json.extensionsUsed.includes("EXT_meshopt_compression")&&(It.featureData=Ev(pt,ut))}void 0!==St._FEATURE_RGBA4444&&(It.featureData=new Uint32Array(Ev(pt,pt.json.accessors[St._FEATURE_RGBA4444]).buffer));const br=ut.material;return It.material=function(ut,pt){const{emissiveFactor:wt=[0,0,0],alphaMode:Tt="OPAQUE",alphaCutoff:St=.5,normalTexture:It,occlusionTexture:Lt,emissiveTexture:Xt,doubleSided:Yt}=ut,{baseColorFactor:Mi=[1,1,1,1],metallicFactor:vr=1,roughnessFactor:br=1,baseColorTexture:Ar,metallicRoughnessTexture:Vr}=ut.pbrMetallicRoughness||{},nn=Lt?pt[Lt.index]:void 0;if(Lt&&Lt.extensions&&Lt.extensions.KHR_texture_transform&&nn){const ut=Lt.extensions.KHR_texture_transform;nn.offsetScale=[ut.offset[0],ut.offset[1],ut.scale[0],ut.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new qn(...Mi),metallicFactor:vr,roughnessFactor:br,baseColorTexture:Ar?pt[Ar.index]:void 0,metallicRoughnessTexture:Vr?pt[Vr.index]:void 0},doubleSided:Yt,emissiveFactor:wt,alphaMode:Tt,alphaCutoff:St,normalTexture:It?pt[It.index]:void 0,occlusionTexture:nn,emissionTexture:Xt?pt[Xt.index]:void 0,defined:void 0===ut.defined}}(void 0!==br?pt.json.materials[br]:{defined:!1},wt),It}function Cv(pt,wt,Tt){const{matrix:St,rotation:It,translation:Lt,scale:Xt,mesh:Yt,extras:Mi,children:vr}=pt,br={};if(br.matrix=St||ut.ad.fromRotationTranslationScale([],It||[0,0,0,1],Lt||[0,0,0],Xt||[1,1,1]),void 0!==Yt){br.meshes=Tt[Yt];const ut=br.anchor=[0,0];for(const pt of br.meshes){const{min:wt,max:Tt}=pt.aabb;ut[0]+=wt[0]+Tt[0],ut[1]+=wt[1]+Tt[1]}ut[0]=Math.floor(ut[0]/br.meshes.length/2),ut[1]=Math.floor(ut[1]/br.meshes.length/2)}if(Mi&&(Mi.id&&(br.id=Mi.id),Mi.lights&&(br.lights=function(ut){if(!ut.length)return[];const pt=function(ut){const pt=atob(ut),wt=new Uint8Array(pt.length);for(let ut=0;ut<pt.length;ut++)wt[ut]=pt.codePointAt(ut);return wt}(ut),wt=[],Tt=pt.length/24,St=new Uint16Array(pt.buffer),It=new Float32Array(pt.buffer);for(let ut=0;ut<Tt;ut++){const pt=St[2*ut*6]/30,Tt=St[2*ut*6+1]/30,Lt=St[2*ut*6+10]/100,Xt=It[6*ut+1],Yt=It[6*ut+2],Mi=It[6*ut+3],vr=It[6*ut+4],br=Mi-Xt,Ar=vr-Yt,Vr=Math.hypot(br,Ar);wt.push({pos:[Xt+.5*br,Yt+.5*Ar,Tt],normal:[Ar/Vr,-br/Vr,0],width:Vr,height:pt,depth:Lt,points:[Xt,Yt,Mi,vr]})}return wt}(Mi.lights))),vr){const ut=[];for(const pt of vr)ut.push(Cv(wt.json.nodes[pt],wt,Tt));br.children=ut}return br}function Rv(ut){if(0===ut.vertices.length||0===ut.indices.length)return null;const pt=new tf(ut.vertices,ut.indices,8,256),[wt,Tt]=[pt.min.clone(),pt.max.clone()];return{vertices:ut.vertices,indices:ut.indices,grid:pt,min:wt,max:Tt}}function Vv(ut){if(!ut.extras||!ut.extras.ground)return null;const pt=ut.extras.ground;if(!pt||!Array.isArray(pt)||0===pt.length)return null;const wt=pt[0];if(!wt||!Array.isArray(wt)||0===wt.length)return null;const Tt=[];for(const ut of wt){if(!Array.isArray(ut)||2!==ut.length)continue;const pt=ut[0],wt=ut[1];"number"==typeof pt&&"number"==typeof wt&&Tt.push(new xc(pt,wt))}if(Tt.length<3)return null;Tt.length>1&&Tt[Tt.length-1].equals(Tt[0])&&Tt.pop();let St=0;for(let ut=0;ut<Tt.length;ut++){const pt=Tt[ut],wt=Tt[(ut+1)%Tt.length],It=Tt[(ut+2)%Tt.length];St+=(pt.x-wt.x)*(It.y-wt.y)-(It.x-wt.x)*(pt.y-wt.y)}St>0&&Tt.reverse();const It=wp(Tt.flatMap((ut=>[ut.x,ut.y])),[]);return 0===It.length?null:{vertices:Tt,indices:It}}function Fv(pt,wt){const Tt=[],St=[];let It=0;const Lt=[];for(const Xt of pt){It=Tt.length;const pt=Xt.vertexArray.float32,Yt=Xt.indexArray.uint16;for(let St=0;St<Xt.vertexArray.length;St++)Lt[0]=pt[3*St+0],Lt[1]=pt[3*St+1],Lt[2]=pt[3*St+2],ut._.transformMat4(Lt,Lt,wt),Tt.push(new xc(Lt[0],Lt[1]));for(let ut=0;ut<3*Xt.indexArray.length;ut++)St.push(Yt[ut]+It)}if(St.length%3!=0)return null;for(let ut=0;ut<St.length;ut+=3){const pt=Tt[St[ut+0]],wt=Tt[St[ut+1]],It=Tt[St[ut+2]];(pt.x-wt.x)*(It.y-wt.y)-(It.x-wt.x)*(pt.y-wt.y)>0&&([St[ut+1],St[ut+2]]=[St[ut+2],St[ut+1]])}return{vertices:Tt,indices:St}}function Lv(ut){const pt=function(ut,pt){const wt=[],Tt=WebGL2RenderingContext;if(ut.json.textures)for(const St of ut.json.textures){const It={magFilter:Tt.LINEAR,minFilter:Tt.NEAREST,wrapS:Tt.REPEAT,wrapT:Tt.REPEAT};void 0!==St.sampler&&Object.assign(It,ut.json.samplers[St.sampler]),wt.push({image:pt[St.source],sampler:It,uploaded:!1})}return wt}(ut,ut.images),wt=function(ut,pt){const wt=[];for(const Tt of ut.json.meshes){const St=[];for(const wt of Tt.primitives)St.push(Dv(wt,ut,pt));wt.push(St)}return wt}(ut,pt),{scenes:Tt,scene:St,nodes:It}=ut.json,Lt=Tt?Tt[St||0].nodes:It,Xt=[];for(const pt of Lt)Xt.push(Cv(It[pt],ut,wt));return function(ut,pt,wt){const Tt={},St=new Set;for(let It=0;It<ut.length;It++){const ut=wt[pt[It]];if(!ut.extras)continue;const Lt=ut.extras["mapbox:footprint:version"],Xt=ut.extras["mapbox:footprint:id"];(Lt||Xt)&&St.add(It),"1.0.0"===Lt&&Xt&&(Tt[Xt]=It)}for(let It=0;It<ut.length;It++){if(St.has(It))continue;const Lt=ut[It],Xt=wt[pt[It]];if(!Xt.extras)continue;let Yt=null;Lt.id in Tt&&(Yt=Fv(ut[Tt[Lt.id]].meshes,Lt.matrix)),Yt||(Yt=Vv(Xt)),Yt&&(Lt.footprint=Rv(Yt))}if(St.size>0){const pt=Array.from(St.values()).sort(((ut,pt)=>ut-pt));for(let wt=pt.length-1;wt>=0;wt--)ut.splice(pt[wt],1)}}(Xt,Lt,ut.json.nodes),Xt}function Ov(ut){ut.heightmap=new Float32Array(4096),ut.heightmap.fill(-1);const pt=ut.vertexArray.float32,wt=ut.aabb.min[0]-1,Tt=ut.aabb.min[1]-1,St=aT/(ut.aabb.max[0]-wt+2),It=aT/(ut.aabb.max[1]-Tt+2);for(let Lt=0;Lt<pt.length;Lt+=3){const Xt=pt[Lt+2],Yt=(pt[Lt+0]-wt)*St|0,Mi=(pt[Lt+1]-Tt)*It|0;Xt>ut.heightmap[Mi*aT+Yt]&&(ut.heightmap[Mi*aT+Yt]=Xt)}}function Uv(pt,wt){const Tt={};Tt.indexArray=new Ql,Tt.indexArray.reserve(4*pt.length),Tt.vertexArray=new Ul,Tt.vertexArray.reserve(10*pt.length),Tt.colorArray=new Ol,Tt.vertexArray.reserve(10*pt.length);let St=0;for(const It of pt){const pt=Math.min(10,Math.max(4,1.3*It.height))*wt,Lt=[-It.normal[1],It.normal[0],0],Xt=Math.min(.29,.1*It.width/It.depth),Yt=It.width-2*It.depth*wt*(Xt+.01),Mi=ut._.scaleAndAdd([],It.pos,Lt,Yt/2),vr=ut._.scaleAndAdd([],It.pos,Lt,-Yt/2),br=[Mi[0],Mi[1],Mi[2]+It.height],Ar=[vr[0],vr[1],vr[2]+It.height],Vr=ut._.scaleAndAdd([],It.normal,Lt,Xt);ut._.scale(Vr,Vr,pt);const nn=ut._.scaleAndAdd([],It.normal,Lt,-Xt);ut._.scale(nn,nn,pt),ut._.add(Vr,Mi,Vr),ut._.add(nn,vr,nn),Mi[2]+=.1,vr[2]+=.1,Tt.vertexArray.emplaceBack(Vr[0],Vr[1],Vr[2]),Tt.vertexArray.emplaceBack(nn[0],nn[1],nn[2]),Tt.vertexArray.emplaceBack(Mi[0],Mi[1],Mi[2]),Tt.vertexArray.emplaceBack(vr[0],vr[1],vr[2]),Tt.vertexArray.emplaceBack(br[0],br[1],br[2]),Tt.vertexArray.emplaceBack(Ar[0],Ar[1],Ar[2]),Tt.vertexArray.emplaceBack(Mi[0],Mi[1],Mi[2]),Tt.vertexArray.emplaceBack(vr[0],vr[1],vr[2]),Tt.vertexArray.emplaceBack(Vr[0],Vr[1],Vr[2]),Tt.vertexArray.emplaceBack(nn[0],nn[1],nn[2]);const sn=Yt/pt/2;Tt.colorArray.emplaceBack(-sn-Xt,-1,sn,.8),Tt.colorArray.emplaceBack(sn+Xt,-1,sn,.8),Tt.colorArray.emplaceBack(-sn,0,sn,1.3),Tt.colorArray.emplaceBack(sn,0,sn,1.3),Tt.colorArray.emplaceBack(sn+Xt,-.8,sn,.7),Tt.colorArray.emplaceBack(sn+Xt,-.8,sn,.7),Tt.colorArray.emplaceBack(0,0,sn,1.3),Tt.colorArray.emplaceBack(0,0,sn,1.3),Tt.colorArray.emplaceBack(sn+Xt,-1.2,sn,.8),Tt.colorArray.emplaceBack(sn+Xt,-1.2,sn,.8),Tt.indexArray.emplaceBack(6+St,4+St,8+St),Tt.indexArray.emplaceBack(7+St,9+St,5+St),Tt.indexArray.emplaceBack(0+St,1+St,2+St),Tt.indexArray.emplaceBack(1+St,3+St,2+St),St+=10}const It={defined:!0,emissiveFactor:[0,0,0]},Lt={};return Lt.baseColorFactor=qn.white,It.pbrMetallicRoughness=Lt,Tt.material=It,Tt.aabb=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Tt}const MT=new Float32Array(262144),ST=new Uint8Array(262144);function qv(ut){let pt=0;if(ut.meshes)for(const wt of ut.meshes)pt=Math.max(pt,wt.aabb.max[2]);if(ut.children)for(const wt of ut.children)pt=Math.max(pt,qv(wt));return pt}function $v(ut,pt,wt){if(ut.meshes)for(const Tt of ut.meshes)Tt.aabb.min[0]!==1/0&&wt.insert(pt,Tt.aabb.min[0],Tt.aabb.min[1],Tt.aabb.max[0],Tt.aabb.max[1]);if(ut.children)for(const Tt of ut.children)$v(Tt,pt,wt)}const AT=["","wall","door","roof","window","lamp","logo"];class Xv{constructor(ut){this.node=ut,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:ut.id,geometry:[],properties:{height:qv(ut)}},this.aabb=this._getLocalBounds()}_getLocalBounds(){if(!this.node.meshes)return new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let ut=0;const pt=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const wt of this.node.meshes)this.node.lightMeshIndex!==ut&&(wt.transformedAabb=Ah.applyTransform(wt.aabb,this.node.matrix),pt.encapsulate(wt.transformedAabb)),ut++;this.aabb=pt}return this.aabb}}class Yv{constructor(ut,pt,wt,Tt,St,It){this.id=pt,this.modelTraits|=lT.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,wt&&(this.modelTraits|=lT.HasMapboxMeshFeatures),Tt&&(this.modelTraits|=lT.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=St,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const pt of ut)this.nodesInfo.push(new Xv(pt)),$v(pt,It.featureIndexArray.length,It.grid),It.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,It.bucketLayerIDs.length-1,0)}updateFootprints(ut,pt){for(const wt of this.getNodesInfo()){const Tt=wt.node;Tt.footprint&&pt.push({footprint:Tt.footprint,id:ut})}}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(ut){if(!this.needsUpload)return;const pt=this.getNodesInfo();for(const wt of pt){const pt=wt.node;this.uploaded?this.updatePbrBuffer(pt):Hb(pt,ut,!0)}for(const ut of pt)Kb(ut.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(ut){let pt=!1;if(!ut.meshes)return pt;for(const wt of ut.meshes)wt.pbrBuffer&&(wt.pbrBuffer.updateData(wt.featureArray),pt=!0);return pt}needsReEvaluation(ut,pt,wt){const Tt=ut.transform.projectionOptions,St=ut.style.getBrightness(),It=this.brightness!==St;return!!(!this.uploaded||this.dirty||Tt.name!==this.projection.name||Zv(wt.paint.get("model-color").value,It)||Zv(wt.paint.get("model-color-mix-intensity").value,It)||Zv(wt.paint.get("model-roughness").value,It)||Zv(wt.paint.get("model-emissive-strength").value,It)||Zv(wt.paint.get("model-height-based-emissive-strength-multiplier").value,It))&&(this.projection=Tt,this.brightness=St,!0)}evaluateScale(ut,pt){if(ut.transform.zoom===this.zoom)return;this.zoom=ut.transform.zoom;const wt=this.getNodesInfo(),Tt=this.id.canonical;for(const ut of wt){const wt=ut.feature;ut.evaluatedScale=pt.paint.get("model-scale").evaluate(wt,{},Tt)}}evaluate(ut){const pt=this.getNodesInfo();for(const wt of pt){if(!wt.node.meshes)continue;const pt=wt.feature,Tt=wt.node.meshes&&wt.node.meshes[0].featureData,St=wt.evaluatedColor[2],It=wt.evaluatedRMEA[2],Lt=this.id.canonical;if(wt.hasTranslucentParts=!1,Tt){for(let Tt=0;Tt<AT.length;Tt++){const St=AT[Tt];St.length&&(pt.properties.part=St);const It=ut.paint.get("model-color").evaluate(pt,{},Lt).toRenderColor(null),Xt=ut.paint.get("model-color-mix-intensity").evaluate(pt,{},Lt);wt.evaluatedColor[Tt]=[It.r,It.g,It.b,Xt],wt.evaluatedRMEA[Tt][0]=ut.paint.get("model-roughness").evaluate(pt,{},Lt),wt.evaluatedRMEA[Tt][2]=ut.paint.get("model-emissive-strength").evaluate(pt,{},Lt),wt.evaluatedRMEA[Tt][3]=It.a,wt.emissionHeightBasedParams[Tt]=ut.paint.get("model-height-based-emissive-strength-multiplier").evaluate(pt,{},Lt),!wt.hasTranslucentParts&&It.a<1&&(wt.hasTranslucentParts=!0)}delete pt.properties.part,Kv(wt,St!==wt.evaluatedColor[2]||It!==wt.evaluatedRMEA[2],this.modelTraits)}else wt.evaluatedRMEA[0][2]=ut.paint.get("model-emissive-strength").evaluate(pt,{},Lt);wt.evaluatedScale=ut.paint.get("model-scale").evaluate(pt,{},Lt),this.updatePbrBuffer(wt.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(ut,pt,wt,Tt){const St=ut.findDEMTileFor(wt);if(St&&(St.tileID.canonical!==this.terrainTile||pt!==this.terrainExaggeration)){if(St.dem&&St.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=St.tileID.overscaledZ;const pt=Qf.create(ut,wt,St);if(!pt)return;this.modelTraits&lT.HasMapboxMeshFeatures&&this.updateDEM(ut,pt,wt,Tt);for(const ut of this.getNodesInfo()){const wt=ut.node;if(!wt.footprint||!wt.footprint.vertices||!wt.footprint.vertices.length)continue;const Tt=wt.footprint.vertices;let St=pt.getElevationAt(Tt[0].x,Tt[0].y,!0,!0);for(let ut=1;ut<Tt.length;ut++)St=Math.min(St,pt.getElevationAt(Tt[ut].x,Tt[ut].y,!0,!0));wt.elevation=St}}this.terrainTile=St.tileID.canonical,this.terrainExaggeration=pt}}updateDEM(ut,pt,wt,Tt){let St=pt._dem._modifiedForSources[Tt];if(void 0===St&&(pt._dem._modifiedForSources[Tt]=[],St=pt._dem._modifiedForSources[Tt]),St.includes(wt.canonical))return;const It=pt._dem.dim;St.push(wt.canonical);let Lt=!1;for(const ut of this.getNodesInfo()){const wt=ut.node;if(!wt.footprint||!wt.footprint.grid)continue;const Tt=wt.footprint.grid,St=pt.tileCoordToPixel(Tt.min.x,Tt.min.y),Xt=pt.tileCoordToPixel(Tt.max.x,Tt.max.y),Yt=Math.min(Math.min(It-Xt.y,St.x),Math.min(St.y,It-Xt.x));if(Yt<0)continue;const Mi=Ke(Yt,2,5);let vr=Math.max(0,St.x-Mi),br=Math.max(0,St.y-Mi),Ar=Math.min(Xt.x+Mi,It-1),Vr=Math.min(Xt.y+Mi,It-1);for(let ut=br;ut<=Vr;++ut)for(let pt=vr;pt<=Ar;++pt)ST[ut*It+pt]=255;let nn=0,sn=0;for(let ut=0;ut<Tt.cellsY;++ut)for(let wt=0;wt<Tt.cellsX;++wt){if(!Tt.cells[ut*Tt.cellsX+wt])continue;const St=pt.tileCoordToPixel(Tt.min.x+wt/Tt.xScale,Tt.min.y+ut/Tt.yScale),Lt=pt.tileCoordToPixel(Tt.min.x+(wt+1)/Tt.xScale,Tt.min.y+(ut+1)/Tt.yScale);for(let ut=St.y;ut<=Math.min(Lt.y+1,It-1);++ut)for(let wt=St.x;wt<=Math.min(Lt.x+1,It-1);++wt)255===ST[ut*It+wt]&&(ST[ut*It+wt]=0,nn+=pt.getElevationAtPixel(wt,ut),sn++)}const an=nn/sn;vr=Math.max(1,St.x-Mi),br=Math.max(1,St.y-Mi),Ar=Math.min(Xt.x+Mi,It-2),Vr=Math.min(Xt.y+Mi,It-2),Lt=!0;for(let ut=br;ut<=Vr;++ut)for(let wt=vr;wt<=Ar;++wt)0===ST[ut*It+wt]&&(MT[ut*It+wt]=pt._dem.set(wt,ut,an));for(let ut=1;ut<Mi;++ut){vr=Math.max(1,St.x-ut),br=Math.max(1,St.y-ut),Ar=Math.min(Xt.x+ut,It-2),Vr=Math.min(Xt.y+ut,It-2);for(let wt=br;wt<=Vr;++wt)for(let Tt=vr;Tt<=Ar;++Tt){const St=wt*It+Tt;if(255===ST[St]){let Lt=0,Xt=0,Yt=-1,vr=-1;for(let pt=-1;pt<=1;++pt)for(let St=-1;St<=1;++St){const Mi=(wt+pt)*It+Tt+St;if(ST[Mi]>=ut)continue;const br=MT[Mi],Ar=Math.abs(br);Ar>Xt&&(Lt=br,Xt=Ar,Yt=St,vr=pt)}if(Xt>.1){const It=1-(ut+.5*Math.abs(Yt*vr))/Mi;let Xt=pt._dem.get(Tt,wt)+Lt*It;const br=pt._dem.get(Tt+Yt,wt+vr),Ar=pt._dem.get(Tt-Yt,wt-vr,!0);(Xt-br)*(Xt-Ar)>0&&(Xt=(br+Ar)/2),MT[St]=pt._dem.set(Tt,wt,Xt),ST[St]=ut}}}}}Lt&&(pt._demTile.needsDEMTextureUpload=!0,pt._dem._timestamp=Ju.now())}getNodesInfo(){return this.nodesInfo}destroy(){const ut=this.getNodesInfo();for(const pt of ut)Kb(pt.node),Wb(pt.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(ut,pt){if(pt.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=pt.updateTime;const wt=pt.getReplacementRegionsForTile(ut.toUnwrapped()),Tt=this.getNodesInfo();for(let ut=0;ut<this.nodesInfo.length;ut++){const pt=Tt[ut].node;Tt[ut].hiddenByReplacement=!!pt.footprint&&!wt.find((ut=>ut.footprint===pt.footprint))}}getHeightAtTileCoord(pt,wt){const Tt=this.getNodesInfo(),St=[],It=[0,0,0],Lt=ut.ad.identity([]);for(let Xt=0;Xt<this.nodesInfo.length;Xt++){const Yt=Tt[Xt],Mi=Yt.node.meshes[0],vr=Mi.transformedAabb;if(pt<vr.min[0]||wt<vr.min[1]||pt>vr.max[0]||wt>vr.max[1])continue;if(!0===Yt.node.hidden)return{height:0,maxHeight:Yt.feature.properties.height,hidden:!1,verticalScale:Yt.evaluatedScale[2]};ut.ad.invert(Lt,Yt.node.matrix),It[0]=pt,It[1]=wt,ut._.transformMat4(It,It,Lt);const br=(It[0]-Mi.aabb.min[0])/(Mi.aabb.max[0]-Mi.aabb.min[0])*aT|0,Ar=Math.min(63,(It[1]-Mi.aabb.min[1])/(Mi.aabb.max[1]-Mi.aabb.min[1])*aT|0)*aT+Math.min(63,br),Vr=Mi.heightmap[Ar];if(!(Vr<0&&Yt.node.footprint)){if(Yt.hiddenByReplacement)return;return{height:Vr,maxHeight:Yt.feature.properties.height,hidden:!1,verticalScale:Yt.evaluatedScale[2]}}if(Yt.node.footprint.grid.query(new xc(pt,wt),new xc(pt,wt),St),St.length>0)return{height:void 0,maxHeight:Yt.feature.properties.height,hidden:Yt.hiddenByReplacement,verticalScale:Yt.evaluatedScale[2]}}}}function Zv(ut,pt){return!ut.isLightConstant&&pt}function Hv(ut,pt,wt,Tt,St,It,Lt,Xt){let Yt=(61440&pt|(61440&pt)>>4)>>8,Mi=(3840&pt|(3840&pt)>>4)>>4,vr=240&pt|(240&pt)>>4;wt[3]>0&&(Yt=Gn(Yt,255*wt[0],wt[3]),Mi=Gn(Mi,255*wt[1],wt[3]),vr=Gn(vr,255*wt[2],wt[3]));const br=Yt<<8|Mi,Ar=vr<<8|Math.floor(255*Tt[3]),Vr=function(ut){const pt=Ke(ut,0,2);return Math.min(Math.round(.5*pt*255),255)}(Tt[2])<<8|15*Tt[0]<<4|15*Tt[1],nn=Ke(St[0],0,1),sn=Ke(St[1],0,1),an=Ke(St[2],0,1),ln=Ke(St[3],0,1);let cn,un,fn,_n;if(nn!==sn&&Lt!==It&&sn!==nn){const ut=Lt-It;un=1/(ut*(sn-nn)),fn=-(It+ut*nn)/(ut*(sn-nn));const pt=Ke(St[4],-1,1);_n=Math.pow(10,pt),cn=255*an<<8|255*ln}else cn=65535,un=0,fn=1,_n=1;if(ut.emplaceBack(br,Ar,Vr,cn,un,fn,_n),Xt){const ut=Xt.length;Xt.clear();for(let pt=0;pt<ut;pt++)Xt.emplaceBack(br,Ar,Vr,cn,un,fn,_n)}}function Kv(ut,pt,wt){const Tt=ut.node;let St=0;const It=wt&lT.HasMeshoptCompression;for(const wt of Tt.meshes){if(Tt.lights&&Tt.lightMeshIndex===St)continue;if(!wt.featureData)continue;wt.featureArray=new lu,wt.featureArray.reserve(wt.featureData.length);let Lt=pt;for(const pt of wt.featureData){const St=It?65535&pt:pt>>16&65535,Xt=It?pt>>16&65535:65535&pt,Yt=(15&Xt)<8?15&Xt:0,Mi=ut.evaluatedRMEA[Yt],vr=ut.evaluatedColor[Yt],br=ut.emissionHeightBasedParams[Yt];let Ar;if(Lt&&2===Yt&&Tt.lights&&(Ar=new lu,Ar.resize(10*Tt.lights.length)),Hv(wt.featureArray,St,vr,Mi,br,wt.aabb.min[2],wt.aabb.max[2],Ar),Ar&&Lt){Lt=!1;const ut=Tt.meshes[Tt.lightMeshIndex];ut.featureArray=Ar,ut.featureArray._trim()}}wt.featureArray._trim(),St++}}function Wv(ut,pt,wt,Tt){const St=1<<ut.z;pt.lat=Ec((Tt/xf+ut.y)/St),pt.lng=Pc((wt/xf+ut.x)/St)}Mo(Yv,"Tiled3dModelBucket",{omit:["layers"]}),Mo(Xv,"Tiled3dModelFeature");const IT={circle:class extends kl{constructor(ut,pt,wt,Tt){super(ut,sg,pt,wt,Tt)}createBucket(ut){return new Kc(ut)}queryRadius(ut){const pt=ut;return hh("circle-radius",this,pt)+hh("circle-stroke-width",this,pt)+ph(this.paint.get("circle-translate"))}queryIntersectsFeature(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=dh(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),It.angle,ut.pixelToTileUnitsFactor),Mi=this.paint.get("circle-radius").evaluate(pt,wt)+this.paint.get("circle-stroke-width").evaluate(pt,wt);return np(ut,Tt,It,Lt,Xt,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),Yt,Mi)}getProgramIds(){return["circle"]}getDefaultProgramParams(ut,pt,wt){const Tt=rp(this);return{config:new Ku(this,{zoom:pt,lut:wt}),defines:Tt,overrideFog:!1}}},heatmap:class extends kl{createBucket(ut){return new lp(ut)}constructor(ut,pt,wt,Tt){super(ut,Vg,pt,wt,Tt),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(ut){"heatmap-color"===ut&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=gp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(ut){return hh("heatmap-radius",this,ut)}queryIntersectsFeature(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=this.paint.get("heatmap-radius").evaluate(pt,wt);return np(ut,Tt,It,Lt,Xt,!0,!0,new xc(0,0),Yt)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(ut,pt,wt){return"heatmap"===ut?{config:new Ku(this,{zoom:pt,lut:wt}),overrideFog:!1}:{}}},hillshade:class extends kl{constructor(ut,pt,wt,Tt){super(ut,Wg,pt,wt,Tt)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(ut,pt,wt){return{overrideFog:!1}}},fill:class extends kl{constructor(ut,pt,wt,Tt){super(ut,Jg,pt,wt,Tt)}getProgramIds(){const ut=this.paint.get("fill-pattern"),pt=ut&&ut.constantOr(1),wt=[pt?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&wt.push(pt&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),wt}getDefaultProgramParams(ut,pt,wt){return{config:new Ku(this,{zoom:pt,lut:wt}),overrideFog:!1}}recalculate(ut,pt){super.recalculate(ut,pt);const wt=this.paint._values["fill-outline-color"];"constant"===wt.value.kind&&void 0===wt.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(ut){return new Wp(ut)}queryRadius(){return ph(this.paint.get("fill-translate"))}queryIntersectsFeature(ut,pt,wt,Tt,St,It){return!ut.queryGeometry.isAboveHorizon&&Qc(fh(ut.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),It.angle,ut.pixelToTileUnitsFactor),Tt)}isTileClipped(){return!0}},"fill-extrusion":class extends kl{constructor(ut,pt,wt,Tt){super(ut,wx,pt,wt,Tt),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(ut){return new xd(ut)}queryRadius(){return ph(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){const vr=dh(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),Lt.angle,pt.pixelToTileUnitsFactor),br=this.paint.get("fill-extrusion-height").evaluate(wt,Tt),Ar=this.paint.get("fill-extrusion-base").evaluate(wt,Tt),Vr=[0,0],nn=Yt&&Lt.elevation,sn=Lt.elevation?Lt.elevation.exaggeration():1,an=pt.tile.getBucket(this);if(nn&&an instanceof xd){const ut=an.centroidVertexArray,pt=Mi+1;pt<ut.length&&(Vr[0]=ut.geta_centroid_pos0(pt),Vr[1]=ut.geta_centroid_pos1(pt))}if(0===Vr[0]&&1===Vr[1])return!1;"globe"===Lt.projection.name&&(St=Td([St],[new xc(0,0),new xc(xf,xf)],pt.tileID.canonical).map((ut=>ut.polygon)).flat());const ln=nn?Yt:null,[cn,un]=function(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br){return"globe"===pt.projection.name?function(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br){const Ar=[],Vr=[],nn=pt.projection.upVectorScale(br,pt.center.lat,pt.worldSize).metersToTile,sn=[0,0,0,1],an=[0,0,0,1],g=(ut,pt,wt,Tt)=>{ut[0]=pt,ut[1]=wt,ut[2]=Tt,ut[3]=1},ln=Id();Tt>0&&(Tt+=ln),St+=ln;for(const ln of wt){const wt=[],cn=[];for(const Ar of ln){const Vr=Ar.x+It.x,ln=Ar.y+It.y,un=pt.projection.projectTilePoint(Vr,ln,br),fn=pt.projection.upVector(br,Ar.x,Ar.y);let _n=Tt,gn=St;if(Xt){const ut=Dd(Vr,ln,Tt,St,Xt,Yt,Mi,vr);_n+=ut.base,gn+=ut.top}0!==Tt?g(sn,un.x+fn[0]*nn*_n,un.y+fn[1]*nn*_n,un.z+fn[2]*nn*_n):g(sn,un.x,un.y,un.z),g(an,un.x+fn[0]*nn*gn,un.y+fn[1]*nn*gn,un.z+fn[2]*nn*gn),ut._.transformMat4(sn,sn,Lt),ut._.transformMat4(an,an,Lt),wt.push(new If(sn[0],sn[1],sn[2])),cn.push(new If(an[0],an[1],an[2]))}Ar.push(wt),Vr.push(cn)}return[Ar,Vr]}(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br):Xt?function(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){const vr=[],br=[],Ar=[0,0,0,1];for(const Vr of pt){const pt=[],nn=[];for(const vr of Vr){const br=vr.x+St.x,Vr=vr.y+St.y,sn=Dd(br,Vr,wt,Tt,Lt,Xt,Yt,Mi);Ar[0]=br,Ar[1]=Vr,Ar[2]=sn.base,Ar[3]=1,ut.aA.transformMat4(Ar,Ar,It),Ar[3]=Math.max(Ar[3],1e-5);const an=new If(Ar[0]/Ar[3],Ar[1]/Ar[3],Ar[2]/Ar[3]);Ar[0]=br,Ar[1]=Vr,Ar[2]=sn.top,Ar[3]=1,ut.aA.transformMat4(Ar,Ar,It),Ar[3]=Math.max(Ar[3],1e-5);const ln=new If(Ar[0]/Ar[3],Ar[1]/Ar[3],Ar[2]/Ar[3]);pt.push(an),nn.push(ln)}vr.push(pt),br.push(nn)}return[vr,br]}(wt,Tt,St,It,Lt,Xt,Yt,Mi,vr):function(ut,pt,wt,Tt,St){const It=[],Lt=[],Xt=St[8]*pt,Yt=St[9]*pt,Mi=St[10]*pt,vr=St[11]*pt,br=St[8]*wt,Ar=St[9]*wt,Vr=St[10]*wt,nn=St[11]*wt;for(const pt of ut){const ut=[],wt=[];for(const It of pt){const pt=It.x+Tt.x,Lt=It.y+Tt.y,sn=St[0]*pt+St[4]*Lt+St[12],an=St[1]*pt+St[5]*Lt+St[13],ln=St[2]*pt+St[6]*Lt+St[14],cn=St[3]*pt+St[7]*Lt+St[15],un=sn+Xt,fn=an+Yt,_n=ln+Mi,gn=Math.max(cn+vr,1e-5),yn=sn+br,xn=an+Ar,vn=ln+Vr,bn=Math.max(cn+nn,1e-5);ut.push(new If(un/gn,fn/gn,_n/gn)),wt.push(new If(yn/bn,xn/bn,vn/bn))}It.push(ut),Lt.push(wt)}return[It,Lt]}(wt,Tt,St,It,Lt)}(Lt,St,Ar,br,vr,Xt,ln,Vr,sn,Lt.center.lat,pt.tileID.canonical),fn=pt.queryGeometry;return function(ut,pt,wt){let Tt=1/0;Qc(wt,pt)&&(Tt=Bd(wt,pt[0]));for(let St=0;St<pt.length;St++){const It=pt[St],Lt=ut[St];for(let ut=0;ut<It.length-1;ut++){const pt=It[ut],St=[pt,It[ut+1],Lt[ut+1],Lt[ut],pt];Wc(wt,St)&&(Tt=Math.min(Tt,Bd(wt,St)))}}return Tt!==1/0&&Tt}(cn,un,fn.isPointQuery()?fn.screenBounds:fn.screenGeometry)}},line:class extends kl{constructor(ut,pt,wt,Tt){super(ut,cv,pt,wt,Tt),cv.layout&&(this.layout=new nl(cv.layout)),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(ut){if("line-gradient"===ut){const ut=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=ut._styleExpression&&ut._styleExpression.expression instanceof ea,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(ut,pt){super.recalculate(ut,pt),this.paint._values["line-floorwidth"]=Fw.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,ut)}createBucket(ut){return new tm(ut)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(ut,pt,wt){const Tt=om(this);return{config:new Ku(this,{zoom:pt,lut:wt}),defines:Tt,overrideFog:!1}}queryRadius(ut){const pt=ut,wt=Wx(hh("line-width",this,pt),hh("line-gap-width",this,pt)),Tt=hh("line-offset",this,pt);return wt/2+Math.abs(Tt)+ph(this.paint.get("line-translate"))}queryIntersectsFeature(ut,pt,wt,Tt,St,It){if(ut.queryGeometry.isAboveHorizon)return!1;const Lt=fh(ut.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),It.angle,ut.pixelToTileUnitsFactor),Xt=ut.pixelToTileUnitsFactor/2*Wx(this.paint.get("line-width").evaluate(pt,wt),this.paint.get("line-gap-width").evaluate(pt,wt)),Yt=this.paint.get("line-offset").evaluate(pt,wt);return Yt&&(Tt=function(ut,pt){const wt=[],Tt=new xc(0,0);for(let St=0;St<ut.length;St++){const It=ut[St],Lt=[];for(let ut=0;ut<It.length;ut++){const wt=It[ut],St=It[ut+1],Xt=0===ut?Tt:wt.sub(It[ut-1])._unit()._perp(),Yt=ut===It.length-1?Tt:St.sub(wt)._unit()._perp(),Mi=Xt._add(Yt)._unit();Mi._mult(1/(Mi.x*Yt.x+Mi.y*Yt.y)),Lt.push(Mi._mult(pt)._add(wt))}wt.push(Lt)}return wt}(Tt,Yt*ut.pixelToTileUnitsFactor)),function(ut,pt,wt){for(let Tt=0;Tt<pt.length;Tt++){const St=pt[Tt];if(ut.length>=3)for(let pt=0;pt<St.length;pt++)if(ah(ut,St[pt]))return!0;if(th(ut,St,wt))return!0}return!1}(Lt,Tt,Xt)}isTileClipped(){return!0}isDraped(ut){const pt=this.layout.get("line-z-offset");return pt.isConstant()&&!pt.constantOr(0)}},symbol:eb,background:class extends kl{constructor(ut,pt,wt,Tt){super(ut,jw,pt,wt,Tt)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(ut,pt,wt){return{overrideFog:!1}}},raster:hb,"raster-particle":db,sky:class extends kl{constructor(ut,pt,wt,Tt){super(ut,Xw,pt,wt,Tt),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(ut){"sky-gradient"===ut?this._updateColorRamp():"sky-atmosphere-sun"!==ut&&"sky-atmosphere-halo-color"!==ut&&"sky-atmosphere-color"!==ut&&"sky-atmosphere-sun-intensity"!==ut||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=gp({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(ut){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const pt=ut.style.light.properties.get("position");return this._lightPosition.azimuthal!==pt.azimuthal||this._lightPosition.polar!==pt.polar}return!1}getCenter(ut,pt){if("atmosphere"===this.paint.get("sky-type")){const wt=this.paint.get("sky-atmosphere-sun"),Tt=!wt,St=ut.style.light,It=St.properties.get("position");return Tt&&"viewport"===St.properties.get("anchor")&&fr("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),Tt?xb(It.azimuthal,90-It.polar,pt):xb(wt[0],90-wt[1],pt)}const wt=this.paint.get("sky-gradient-center");return xb(wt[0],90-wt[1],pt)}isSky(){return!0}markSkyboxValid(ut){this._skyboxInvalidated=!1,this._lightPosition=ut.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const ut=this.paint.get("sky-type");return"atmosphere"===ut?["skyboxCapture","skybox"]:"gradient"===ut?["skyboxGradient"]:null}},slot:class extends kl{constructor(ut,pt,wt,Tt){super(ut,Yw,pt,null)}},model:class extends kl{constructor(ut,pt,wt,Tt){super(ut,sT,pt,wt,Tt),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(ut){return new Nb(ut)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(ut){return ut instanceof Yv?xf-1:0}queryIntersectsFeature(pt,wt,Tt,St,It,Lt){if(!this.modelManager)return!1;const Xt=this.modelManager,Yt=pt.tile.getBucket(this);if(!(Yt&&Yt instanceof Nb))return!1;const Mi=Yt;for(const Tt in Mi.instancesPerModel){const St=Mi.instancesPerModel[Tt],It=void 0!==wt.id?wt.id:wt.properties&&wt.properties.hasOwnProperty("id")?wt.properties.id:void 0;if(St.idToFeaturesIndex.hasOwnProperty(It)){const wt=St.features[St.idToFeaturesIndex[It]],Yt=Xt.getModel(Tt,this.scope);if(!Yt)return!1;let vr=ut.ad.create();const br=new mc(0,0),Ar=Mi.canonical;let Vr=Number.MAX_VALUE;for(let Tt=0;Tt<wt.instancedDataCount;++Tt){const It=16*(wt.instancedDataOffset+Tt),Xt=St.instancedDataArray.float32,Mi=[Xt[It+4],Xt[It+5],Xt[It+6]];Wv(Ar,br,Xt[It],0|Xt[It+1]),Xb(vr,Yt,Lt,br,wt.rotation,wt.scale,Mi,!1,!1,!1),"globe"===Lt.projection.name&&(vr=kb(vr,Lt));const nn=ut.ad.multiply([],Lt.projMatrix,vr),sn=pt.queryGeometry,an=zb(sn.isPointQuery()?sn.screenBounds:sn.screenGeometry,Lt,nn,Yt.aabb);null!=an&&(Vr=Math.min(an,Vr))}return Vr!==Number.MAX_VALUE&&Vr}}return!1}_handleOverridablePaintPropertyUpdate(ut,pt,wt){return!(!this.layout||pt.isDataDriven()||wt.isDataDriven()||"model-color"!==ut&&"model-color-mix-intensity"!==ut&&"model-rotation"!==ut&&"model-scale"!==ut&&"model-translation"!==ut&&"model-emissive-strength"!==ut)}_isPropertyZoomDependent(ut){const pt=this._transitionablePaint._values[ut];return null!=pt&&null!=pt.value&&null!=pt.value.expression&&pt.value.expression instanceof fo}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(pt,wt,Tt,St){const It=pt.tile,Lt=It.getBucket(this);let Xt=null,Yt=Number.MAX_VALUE;if(!(Lt&&Lt instanceof Yv))return{queryFeature:Xt,intersectionZ:Yt};const Mi=Lt.getNodesInfo()[wt];if(Mi.hiddenByReplacement||!Mi.node.meshes||!Tt.filter(new Ho(It.tileID.overscaledZ),Mi.feature,It.tileID.canonical))return{queryFeature:Xt,intersectionZ:Yt};const vr=Mi.node,br=St.calculatePosMatrix(It.tileID.toUnwrapped(),St.worldSize),Ar=Mi.evaluatedScale;let Vr=0;St.elevation&&vr.elevation&&(Vr=vr.elevation*St.elevation.exaggeration()),ut.ad.translate(br,br,[(vr.anchor?vr.anchor[0]:0)*(Ar[0]-1),(vr.anchor?vr.anchor[1]:0)*(Ar[1]-1),Vr]),ut.ad.scale(br,br,Ar),ut.ad.multiply(br,br,vr.matrix);const nn=pt.queryGeometry,sn=nn.isPointQuery()?nn.screenBounds:nn.screenGeometry,y=function(pt){const wt=ut.ad.multiply([],br,pt.matrix),Tt=ut.ad.multiply(wt,St.expandedFarZProjMatrix,wt);for(let ut=0;ut<pt.meshes.length;++ut){const wt=pt.meshes[ut];if(ut===pt.lightMeshIndex)continue;const It=zb(sn,St,Tt,wt.aabb);null!=It&&(Yt=Math.min(It,Yt))}if(pt.children)for(const ut of pt.children)y(ut)};if(y(vr),Yt===Number.MAX_VALUE)return{queryFeature:Xt,intersectionZ:Yt};const an=new mc(0,0);return Wv(It.tileID.canonical,an,Mi.node.anchor[0],Mi.node.anchor[1]),Xt={type:"Feature",geometry:{type:"Point",coordinates:[an.lng,an.lat]},properties:Mi.feature.properties,id:Mi.feature.id,state:{},layer:this.serialize()},{queryFeature:Xt,intersectionZ:Yt}}},clip:class extends kl{constructor(ut,pt,wt,Tt){super(ut,iy,pt,wt,Tt)}recalculate(ut,pt){super.recalculate(ut,pt)}createBucket(ut){return new rf(ut)}isTileClipped(){return!0}is3D(){return!0}}};Mo(qx,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const CT=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class t_{static from(ut){if(!(ut instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[pt,wt]=new Uint8Array(ut,0,2);if(219!==pt)throw new Error("Data does not appear to be in a KDBush format.");const Tt=wt>>4;if(1!==Tt)throw new Error(`Got v${Tt} data when expected v1.`);const St=CT[15&wt];if(!St)throw new Error("Unrecognized array type.");const[It]=new Uint16Array(ut,2,1),[Lt]=new Uint32Array(ut,4,1);return new t_(Lt,It,St,ut)}constructor(ut,pt=64,wt=Float64Array,Tt){if(isNaN(ut)||ut<0)throw new Error(`Unpexpected numItems value: ${ut}.`);this.numItems=+ut,this.nodeSize=Math.min(Math.max(+pt,2),65535),this.ArrayType=wt,this.IndexArrayType=ut<65536?Uint16Array:Uint32Array;const St=CT.indexOf(this.ArrayType),It=2*ut*this.ArrayType.BYTES_PER_ELEMENT,Lt=ut*this.IndexArrayType.BYTES_PER_ELEMENT,Xt=(8-Lt%8)%8;if(St<0)throw new Error(`Unexpected typed array class: ${wt}.`);Tt&&Tt instanceof ArrayBuffer?(this.data=Tt,this.ids=new this.IndexArrayType(this.data,8,ut),this.coords=new this.ArrayType(this.data,8+Lt+Xt,2*ut),this._pos=2*ut,this._finished=!0):(this.data=new ArrayBuffer(8+It+Lt+Xt),this.ids=new this.IndexArrayType(this.data,8,ut),this.coords=new this.ArrayType(this.data,8+Lt+Xt,2*ut),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+St]),new Uint16Array(this.data,2,1)[0]=pt,new Uint32Array(this.data,4,1)[0]=ut)}add(ut,pt){const wt=this._pos>>1;return this.ids[wt]=wt,this.coords[this._pos++]=ut,this.coords[this._pos++]=pt,wt}finish(){const ut=this._pos>>1;if(ut!==this.numItems)throw new Error(`Added ${ut} items when expected ${this.numItems}.`);return e_(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(ut,pt,wt,Tt){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:St,coords:It,nodeSize:Lt}=this,Xt=[0,St.length-1,0],Yt=[];for(;Xt.length;){const Mi=Xt.pop()||0,vr=Xt.pop()||0,br=Xt.pop()||0;if(vr-br<=Lt){for(let Lt=br;Lt<=vr;Lt++){const Xt=It[2*Lt],Mi=It[2*Lt+1];Xt>=ut&&Xt<=wt&&Mi>=pt&&Mi<=Tt&&Yt.push(St[Lt])}continue}const Ar=br+vr>>1,Vr=It[2*Ar],nn=It[2*Ar+1];Vr>=ut&&Vr<=wt&&nn>=pt&&nn<=Tt&&Yt.push(St[Ar]),(0===Mi?ut<=Vr:pt<=nn)&&(Xt.push(br),Xt.push(Ar-1),Xt.push(1-Mi)),(0===Mi?wt>=Vr:Tt>=nn)&&(Xt.push(Ar+1),Xt.push(vr),Xt.push(1-Mi))}return Yt}within(ut,pt,wt){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Tt,coords:St,nodeSize:It}=this,Lt=[0,Tt.length-1,0],Xt=[],Yt=wt*wt;for(;Lt.length;){const Mi=Lt.pop()||0,vr=Lt.pop()||0,br=Lt.pop()||0;if(vr-br<=It){for(let wt=br;wt<=vr;wt++)s_(St[2*wt],St[2*wt+1],ut,pt)<=Yt&&Xt.push(Tt[wt]);continue}const Ar=br+vr>>1,Vr=St[2*Ar],nn=St[2*Ar+1];s_(Vr,nn,ut,pt)<=Yt&&Xt.push(Tt[Ar]),(0===Mi?ut-wt<=Vr:pt-wt<=nn)&&(Lt.push(br),Lt.push(Ar-1),Lt.push(1-Mi)),(0===Mi?ut+wt>=Vr:pt+wt>=nn)&&(Lt.push(Ar+1),Lt.push(vr),Lt.push(1-Mi))}return Xt}}function e_(ut,pt,wt,Tt,St,It){if(St-Tt<=wt)return;const Lt=Tt+St>>1;r_(ut,pt,Lt,Tt,St,It),e_(ut,pt,wt,Tt,Lt-1,1-It),e_(ut,pt,wt,Lt+1,St,1-It)}function r_(ut,pt,wt,Tt,St,It){for(;St>Tt;){if(St-Tt>600){const Lt=St-Tt+1,Xt=wt-Tt+1,Yt=Math.log(Lt),Mi=.5*Math.exp(2*Yt/3),vr=.5*Math.sqrt(Yt*Mi*(Lt-Mi)/Lt)*(Xt-Lt/2<0?-1:1);r_(ut,pt,wt,Math.max(Tt,Math.floor(wt-Xt*Mi/Lt+vr)),Math.min(St,Math.floor(wt+(Lt-Xt)*Mi/Lt+vr)),It)}const Lt=pt[2*wt+It];let Xt=Tt,Yt=St;for(n_(ut,pt,Tt,wt),pt[2*St+It]>Lt&&n_(ut,pt,Tt,St);Xt<Yt;){for(n_(ut,pt,Xt,Yt),Xt++,Yt--;pt[2*Xt+It]<Lt;)Xt++;for(;pt[2*Yt+It]>Lt;)Yt--}pt[2*Tt+It]===Lt?n_(ut,pt,Tt,Yt):(Yt++,n_(ut,pt,Yt,St)),Yt<=wt&&(Tt=Yt+1),wt<=Yt&&(St=Yt-1)}}function n_(ut,pt,wt,Tt){i_(ut,wt,Tt),i_(pt,2*wt,2*Tt),i_(pt,2*wt+1,2*Tt+1)}function i_(ut,pt,wt){const Tt=ut[pt];ut[pt]=ut[wt],ut[wt]=Tt}function s_(ut,pt,wt,Tt){const St=ut-wt,It=pt-Tt;return St*St+It*It}ut.$=We,ut.A=Hs,ut.B=Xs,ut.C=qn,ut.D=Bi,ut.E=Fn,ut.G=hl,ut.H=eo,ut.I=Ig,ut.J=Ja,ut.K=function(ut){const pt=ut.value;let wt=[];if(!pt)return wt;const Tt=Ti(pt);return"string"!==Tt?(wt=wt.concat([new Fb(ut.key,pt,`string expected, "${Tt}" found`)]),wt):(Lb(pt,!0)||(wt=wt.concat([new Fb(ut.key,pt,`invalid url "${pt}"`)])),wt)},ut.L=x_,ut.M=class{constructor(ut,pt,wt,Tt){this.id=ut,this.position=null!=pt?new mc(pt[0],pt[1]):new mc(0,0),this.orientation=null!=wt?wt:[0,0,0],this.nodes=Tt,this.uploaded=!1,this.aabb=new Ah([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(pt,wt){if(ut.ad.multiply(pt.matrix,wt,pt.matrix),pt.meshes)for(const ut of pt.meshes){const wt=Ah.applyTransform(ut.aabb,pt.matrix);this.aabb.encapsulate(wt)}if(pt.children)for(const ut of pt.children)this._applyTransformations(ut,pt.matrix)}computeBoundsAndApplyParent(){const pt=ut.ad.identity([]);for(const ut of this.nodes)this._applyTransformations(ut,pt)}computeModelMatrix(ut,pt,wt,Tt,St,It,Lt=!1){Xb(this.matrix,this,ut.transform,this.position,pt,wt,Tt,St,It,Lt)}upload(ut){if(!this.uploaded){for(const pt of this.nodes)Hb(pt,ut);for(const ut of this.nodes)Kb(ut);this.uploaded=!0}}destroy(){for(const ut of this.nodes)Wb(ut)}},ut.N=ol,ut.O=il,ut.P=xc,ut.Q=class{constructor(ut){this.specification=ut}possiblyEvaluate(ut,pt){return yr(ut.expression.evaluate(pt))}interpolate(ut,pt,wt){return{x:Gn(ut.x,pt.x,wt),y:Gn(ut.y,pt.y,wt),z:Gn(ut.z,pt.z,wt),azimuthal:Gn(ut.azimuthal,pt.azimuthal,wt),polar:Gn(ut.polar,pt.polar,wt)}}},ut.R=id,ut.S=uu,ut.T=Gg,ut.U=Jo,ut.V=Fb,ut.W=er,ut.X=Ho,ut.Y=Lc,ut.Z=fo,ut.a=Eg,ut.a$=function(ut){const{x:pt,y:wt}=ut.point,{lng:Tt,lat:St}=ut._center;return Zh(pt,wt,ut.worldSize,Tt,St)},ut.a0=nl,ut.a1=Hh,ut.a2=Gn,ut.a3=xf,ut.a4=Xn,ut.a5=class{constructor(ut){this.specification=ut}possiblyEvaluate(ut,pt){return function([ut,pt]){const wt=yr([1,ut,pt]);return{x:wt.x,y:wt.y,z:wt.z}}(ut.expression.evaluate(pt))}interpolate(ut,pt,wt){return{x:Gn(ut.x,pt.x,wt),y:Gn(ut.y,pt.y,wt),z:Gn(ut.z,pt.z,wt)}}},ut.a6=Uu,ut.a7=Du,ut.a8=Ru,ut.a9=Lu,ut.aB=function(pt,wt){const{x:Tt,y:St}=pt.point,It=Zh(Tt,St,pt.worldSize/pt._pixelsPerMercatorPixel,0,0);return ut.ad.multiply(It,It,Gh(Ch(wt)))},ut.aD=qm,ut.aE=Jv,ut.aF=jm,ut.aG=function(ut,pt,wt,Tt,St){const It=5*pt+2;ut.float32[It+0]=wt,ut.float32[It+1]=Tt,ut.float32[It+2]=St},ut.aH=Ug,ut.aI=mc,ut.aJ=Sg,ut.aK=vc,ut.aL=_c,ut.aM=Mh,ut.aN=_b,ut.aO=bc,ut.aP=Lh,ut.aQ=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){if("globe"===Yt.name)return Lh(ut,pt,new bc(wt,Tt,St),!1);const Mi=ng({z:wt,x:Tt,y:St},Yt);return new Ah([(It+Mi.x/Mi.scale)*pt,pt*(Mi.y/Mi.scale),Lt],[(It+Mi.x2/Mi.scale)*pt,pt*(Mi.y2/Mi.scale),Xt])},ut.aR=function(ut,pt,wt){let Tt=0;for(let wt=0;wt<2;++wt){const St=0;ut[wt]>St&&(Tt+=(ut[wt]-St)*(ut[wt]-St)),pt[wt]<St&&(Tt+=(St-pt[wt])*(St-pt[wt]))}return Tt},ut.aS=Y_,ut.aT=gh,ut.aU=B_,ut.aV=function(pt){const wt=ut.ad.identity(new Float64Array(16));ut.ad.multiply(wt,pt.pixelMatrix,pt.globeMatrix);const Tt=[0,U_,0],St=[0,j_,0];return ut._.transformMat4(Tt,Tt,wt),ut._.transformMat4(St,St,wt),[Tt[0]>0&&Tt[0]<=pt.width&&Tt[1]>0&&Tt[1]<=pt.height&&!Wh(pt,new mc(pt.center.lat,90)),St[0]>0&&St[0]<=pt.width&&St[1]>0&&St[1]<=pt.height&&!Wh(pt,new mc(pt.center.lat,-90))]},ut.aW=function(pt,wt){const{scale:Tt}=pt.tileTransform,St=Tt*xf/(pt.tileSize*Math.pow(2,wt.zoom-pt.tileID.overscaledZ+pt.tileID.canonical.z));return ut.aC.scale(new Float32Array(4),wt.inverseAdjustmentMatrix,[St,St])},ut.aX=wb,ut.aY=vb,ut.aZ=function(pt){const wt=vb(pt,!0);return ut.aC.invert([],[wt[0],wt[1],wt[4],wt[5]])},ut.a_=xh,ut.aa=Cu,ut.ab=$e,ut.ac=function(ut,pt,wt){const Tt=Math.sqrt(ut*ut+pt*pt+wt*wt),St=Tt>0?Math.acos(wt/Tt)*Sc:0;let It=0!==ut||0!==pt?Math.atan2(-pt,-ut)*Sc+90:0;return It<0&&(It+=360),[Tt,It,St]},ut.ae=Tg,ut.af=Cg,ut.ag=zg,ut.ah=function(ut,pt){const wt={};for(let Tt=0;Tt<pt.length;Tt++){const St=pt[Tt];St in ut&&(wt[St]=ut[St])}return wt},ut.ai=yc,ut.aj=Tc,ut.ak=kc,ut.al=Sl,ut.am=function(ut){Ph++,Ph>Th&&(ut.getActor().send("enforceCacheSizeLimit",yh),Ph=0)},ut.an=Ld,ut.ao=class{constructor(ut){this.entries={},this.scheduler=ut}request(ut,pt,wt,Tt){const St=this.entries[ut]=this.entries[ut]||{callbacks:[]};if(St.result){const[ut,wt]=St.result;return this.scheduler?this.scheduler.add((()=>{Tt(ut,wt)}),pt):Tt(ut,wt),()=>{}}return St.callbacks.push(Tt),St.cancel||(St.cancel=wt(((wt,Tt)=>{St.result=[wt,Tt];for(const ut of St.callbacks)this.scheduler?this.scheduler.add((()=>{ut(wt,Tt)}),pt):ut(wt,Tt);setTimeout((()=>delete this.entries[ut]),3e3)}))),()=>{St.result||(St.callbacks=St.callbacks.filter((ut=>ut!==Tt)),St.callbacks.length||(St.cancel(),delete this.entries[ut]))}}},ut.ap=function(ut,wt,Tt){const St=JSON.stringify(ut.request);return ut.data&&((this||pt).deduped.entries[St]={result:[null,ut.data]}),(this||pt).deduped.request(St,{type:"parseTile",isSymbolTile:ut.isSymbolTile,zoom:ut.tileZoom},(pt=>{const wt=en(ut.request,((ut,wt,St,It)=>{ut?pt(ut):wt&&pt(null,{vectorTile:Tt?void 0:new ix(new xv(wt)),rawData:wt,cacheControl:St,expires:It})}));return()=>{wt.cancel(),pt()}}),wt)},ut.aq=Vu,ut.ar=class extends Bu{constructor(ut){super(ut),this.current=P_}set(ut,pt,wt){if(this.fetchUniformLocation(ut,pt))for(let ut=0;ut<9;ut++)if(wt[ut]!==this.current[ut]){this.current=wt,this.gl.uniformMatrix3fv(this.location,!1,wt);break}}},ut.as=Fu,ut.at=Ke,ut.au=Je,ut.aw=Tr,ut.ax=zc,ut.ay=Ec,ut.az=function(ut,pt,wt){ut[4*pt+0]=wt[0],ut[4*pt+1]=wt[1],ut[4*pt+2]=wt[2],ut[4*pt+3]=wt[3]},ut.b=Au,ut.b$=xx,ut.b0=Ge,ut.b1=O_,ut.b2=function(ut){const pt=Math.round((ut+45+360)%360/90)%4;return Ac[pt]},ut.b3=45,ut.b4=Ic,ut.b5=Fc,ut.b6=Ah,ut.b7=yr,ut.b8=function(ut){return[Math.pow(ut[0],1/2.2),Math.pow(ut[1],1/2.2),Math.pow(ut[2],1/2.2)]},ut.b9=Ye,ut.bA=function(ut,pt){return[Math.pow(ut[0],2.2)*pt,Math.pow(ut[1],2.2)*pt,Math.pow(ut[2],2.2)*pt]},ut.bB=im,ut.bD=Yh,ut.bE=Er,ut.bF=Pr,ut.bG=256,ut.bH=function(pt,wt){const Tt=[0,0,0],St=$h(Ch(wt.canonical));return ut._.transformMat4(Tt,Tt,St),ut._.transformMat4(Tt,Tt,pt),Tt},ut.bI=ut=>({u_camera_to_center_distance:new Cu(ut),u_extrude_scale:new qu(ut),u_device_pixel_ratio:new Cu(ut),u_matrix:new Uu(ut),u_inv_rot_matrix:new Uu(ut),u_merc_center:new Ru(ut),u_tile_id:new Vu(ut),u_zoom_transition:new Cu(ut),u_up_dir:new Vu(ut),u_emissive_strength:new Cu(ut)}),ut.bJ=ut=>({u_matrix:new Uu(ut),u_pixels_to_tile_units:new qu(ut),u_device_pixel_ratio:new Cu(ut),u_units_to_pixels:new Ru(ut),u_dash_image:new Du(ut),u_gradient_image:new Du(ut),u_image_height:new Cu(ut),u_texsize:new Ru(ut),u_tile_units_to_pixels:new Cu(ut),u_alpha_discard_threshold:new Cu(ut),u_trim_offset:new Ru(ut),u_trim_fade_range:new Ru(ut),u_trim_color:new Fu(ut),u_emissive_strength:new Cu(ut)}),ut.bK=ut=>({u_matrix:new Uu(ut),u_texsize:new Ru(ut),u_pixels_to_tile_units:new qu(ut),u_device_pixel_ratio:new Cu(ut),u_image:new Du(ut),u_units_to_pixels:new Ru(ut),u_tile_units_to_pixels:new Cu(ut),u_alpha_discard_threshold:new Cu(ut),u_trim_offset:new Ru(ut)}),ut.bL=Wl,ut.bM=Qx,ut.bN=wv,ut.bO=Av,ut.bP=Xy,ut.bQ=hy,ut.bR=rp,ut.bS=(ut,pt,wt,Tt,St,It)=>{const Lt=ut.transform,Xt="globe"===Lt.projection.name;let Yt;if("map"===It.paint.get("circle-pitch-alignment"))if(Xt){const ut=Yh(Lt.zoom,pt.canonical)*Lt._pixelsPerMercatorPixel;Yt=Float32Array.from([ut,0,0,ut])}else Yt=Lt.calculatePixelsToTileUnitsMatrix(wt);else Yt=new Float32Array([Lt.pixelsToGLUnits[0],0,0,Lt.pixelsToGLUnits[1]]);const Mi={u_camera_to_center_distance:ut.transform.getCameraToCenterDistance(Lt.projection),u_matrix:ut.translatePosMatrix(pt.projMatrix,wt,It.paint.get("circle-translate"),It.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Ju.devicePixelRatio,u_extrude_scale:Yt,u_inv_rot_matrix:Rg,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:It.paint.get("circle-emissive-strength")};if(Xt){Mi.u_inv_rot_matrix=Tt,Mi.u_merc_center=St,Mi.u_tile_id=[pt.canonical.x,pt.canonical.y,1<<pt.canonical.z],Mi.u_zoom_transition=Hh(Lt.zoom);const ut=St[0]*xf,wt=St[1]*xf;Mi.u_up_dir=Lt.projection.upVector(new bc(0,0,0),ut,wt)}return Mi},ut.bT=om,ut.bU=(ut,pt,wt,Tt,St,It)=>{const Lt=ut.transform;return{u_matrix:am(ut,pt,wt,Tt),u_texsize:pt.imageAtlasTexture?pt.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:Lt.calculatePixelsToTileUnitsMatrix(pt),u_device_pixel_ratio:St,u_image:0,u_tile_units_to_pixels:sm(pt,Lt),u_units_to_pixels:[1/Lt.pixelsToGLUnits[0],1/Lt.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:It}},ut.bV=(ut,pt,wt,Tt,St,It,Lt)=>{const Xt=ut.transform,Yt=Xt.calculatePixelsToTileUnitsMatrix(pt);return{u_matrix:am(ut,pt,wt,Tt),u_pixels_to_tile_units:Yt,u_device_pixel_ratio:It,u_units_to_pixels:[1/Xt.pixelsToGLUnits[0],1/Xt.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:St,u_texsize:lm(wt)&&pt.lineAtlasTexture?pt.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:sm(pt,ut.transform),u_alpha_discard_threshold:0,u_trim_offset:Lt,u_trim_fade_range:wt.paint.get("line-trim-fade-range"),u_trim_color:wt.paint.get("line-trim-color").toRenderColor(wt.lut).toArray01(),u_emissive_strength:wt.paint.get("line-emissive-strength")}},ut.bW=sr,ut.bX=gp,ut.bY=Id,ut.bZ=W_,ut.b_=xd,ut.ba=function(ut,pt,wt){const Tt=Hh(wt.zoom),St=ut.style.map._antialias,It=pt.options.extStandardDerivativesForceOff||ut.terrain&&ut.terrain.exaggeration()>0;return 0===Tt&&!St&&!It},ut.bb=function(pt){const wt=pt.pixelsPerMeter,Tt=wt/zc(1,pt.center.lat),St=ut.ad.identity(new Float64Array(16));return ut.ad.translate(St,St,[pt.point.x,pt.point.y,0]),ut.ad.scale(St,St,[Tt,Tt,wt]),Float32Array.from(St)},ut.bc=Oh,ut.bd=function(ut){const pt=Y_-5;ut=Ke(ut,-pt,pt)/pt*90;const wt=Math.pow(Math.abs(Math.sin($e(ut))),3);return Math.round(wt*(V_.length-1))},ut.be=function(pt,wt,Tt,St){const It=wt.getNorth(),Lt=wt.getSouth(),Xt=wt.getWest(),Yt=wt.getEast(),Mi=1<<pt.z,vr=Yt-Xt,br=It-Lt,Ar=vr/N_,Vr=-br/V_[Tt],nn=[0,Ar,0,Vr,0,0,It,Xt,0];if(pt.z>0){const pt=180/St;ut.bC.multiply(nn,nn,[pt/vr+1,0,0,0,pt/br+1,0,-.5*pt/Ar,.5*pt/Vr,1])}return nn[2]=Mi,nn[5]=pt.x,nn[8]=pt.y,nn},ut.bf=$h,ut.bg=Ch,ut.bh=function(pt,wt,Tt){const St=ut.ad.identity(new Float64Array(16)),It=(wt/(1<<pt)-.5)*Math.PI*2;return ut.ad.rotateY(St,Tt.globeMatrix,It),Float32Array.from(St)},ut.bi=Br,ut.bj=function(ut){return ut<=1?1:Math.pow(2,Math.floor(Math.log(ut)/Math.LN2))},ut.bk=hb,ut.bl=db,ut.bm=ub,ut.bn=function(ut,pt){const wt=document.createElement("video");wt.muted=!0,wt.onloadstart=function(){pt(null,wt)};for(let pt=0;pt<ut.length;pt++){const Tt=document.createElement("source");rn(ut[pt])||(wt.crossOrigin="Anonymous"),Tt.src=ut[pt],wt.appendChild(Tt)}return{cancel:()=>{}}},ut.bo=Xg,ut.bp=or,ut.bq=class{isDataAvailableAtPoint(ut){const pt=this._source();if(this.isUsingMockSource()||!pt||ut.y<0||ut.y>1)return!1;const wt=pt.getSource().maxzoom,Tt=1<<wt,St=Math.floor(ut.x),It=Math.floor((ut.x-St)*Tt),Lt=Math.floor(ut.y*Tt),Xt=this.findDEMTileFor(new _c(wt,St,wt,It,Lt));return!(!Xt||!Xt.dem)}getAtPointOrZero(ut,pt=0){return this.getAtPoint(ut,pt)||0}getAtPoint(ut,pt,wt=!0){if(this.isUsingMockSource())return null;null==pt&&(pt=null);const Tt=this._source();if(!Tt)return pt;if(ut.y<0||ut.y>1)return pt;const St=Tt.getSource().maxzoom,It=1<<St,Lt=Math.floor(ut.x),Xt=ut.x-Lt,Yt=new _c(St,Lt,St,Math.floor(Xt*It),Math.floor(ut.y*It)),Mi=this.findDEMTileFor(Yt);if(!Mi||!Mi.dem)return pt;const vr=Mi.dem,br=1<<Mi.tileID.canonical.z,Ar=(Xt*br-Mi.tileID.canonical.x)*vr.dim,Vr=(ut.y*br-Mi.tileID.canonical.y)*vr.dim,nn=Math.floor(Ar),sn=Math.floor(Vr);return(wt?this.exaggeration():1)*Gn(Gn(vr.get(nn,sn),vr.get(nn,sn+1),Vr-sn),Gn(vr.get(nn+1,sn),vr.get(nn+1,sn+1),Vr-sn),Ar-nn)}getAtTileOffset(ut,pt,wt){const Tt=1<<ut.canonical.z;return this.getAtPointOrZero(new Lc(ut.wrap+(ut.canonical.x+pt/xf)/Tt,(ut.canonical.y+wt/xf)/Tt))}getAtTileOffsetFunc(pt,wt,Tt,St){return It=>{const Lt=this.getAtTileOffset(pt,It.x,It.y),Xt=St.upVector(pt.canonical,It.x,It.y),Yt=St.upVectorScale(pt.canonical,wt,Tt).metersToTile;return ut._.scale(Xt,Xt,Lt*Yt),Xt}}getForTilePoints(ut,pt,wt,Tt){if(this.isUsingMockSource())return!1;const St=Qf.create(this,ut,Tt);return!!St&&(pt.forEach((ut=>{ut[2]=this.exaggeration()*St.getElevationAt(ut[0],ut[1],wt)})),!0)}getMinMaxForTile(ut){if(this.isUsingMockSource())return null;const pt=this.findDEMTileFor(ut);if(!pt||!pt.dem)return null;const wt=pt.dem.tree,Tt=pt.tileID,St=1<<ut.canonical.z-Tt.canonical.z;let It=ut.canonical.x/St-Tt.canonical.x,Lt=ut.canonical.y/St-Tt.canonical.y,Xt=0;for(let pt=0;pt<ut.canonical.z-Tt.canonical.z&&!wt.leaves[Xt];pt++){It*=2,Lt*=2;const ut=2*Math.floor(Lt)+Math.floor(It);Xt=wt.childOffsets[Xt]+ut,It%=1,Lt%=1}return{min:this.exaggeration()*wt.minimums[Xt],max:this.exaggeration()*wt.maximums[Xt]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(ut,pt,wt){throw new Error("Pure virtual method called.")}pointCoordinate(ut){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(ut){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const ut=this.visibleDemTiles;if(0===ut.length)return null;let pt=!1,wt=Number.MAX_VALUE,Tt=Number.MIN_VALUE;for(const St of ut){const ut=this.getMinMaxForTile(St.tileID);ut&&(wt=Math.min(wt,ut.min),Tt=Math.max(Tt,ut.max),pt=!0)}return pt?{min:wt,max:Tt}:null}},ut.br=hg,ut.bs=zh,ut.bt=Cl,ut.bu=Ql,ut.bv=Xx,ut.bw=ev,ut.bx=ov,ut.by=nx,ut.bz=dp,ut.c=Lv,ut.c$=tn,ut.c0=450,ut.c1=7,ut.c2=Zw,ut.c3=$x,ut.c4=256,ut.c5=Vh,ut.c6=Gh,ut.c7=Bl,ut.c8=Ul,ut.c9=ru,ut.cA=function(ut){let pt=1/0,wt=1/0,Tt=-1/0,St=-1/0;for(const It of ut)pt=Math.min(pt,It.x),wt=Math.min(wt,It.y),Tt=Math.max(Tt,It.x),St=Math.max(St,It.y);return{min:new xc(pt,wt),max:new xc(Tt,St)}},ut.cB=ah,ut.cC=Uc,ut.cD=k_,ut.cE=["type","source","source-layer","minzoom","maxzoom","filter","layout"],ut.cF=My,ut.cG=Wc,ut.cH=Of,ut.cI=Uf,ut.cJ=Yy,ut.cK=t_,ut.cL=function(ut){return ut({pluginStatus:m_,pluginURL:__}),g_.on("pluginStateChange",ut),ut},ut.cM=Dy,ut.cN=cb,ut.cO=rd,ut.cP=qo,ut.cQ=s,ut.cR=Rr,ut.cS=Yd,ut.cT=hr,ut.cU=function(ut){const pt=ut.indexOf(b_);return pt>=0?ut.slice(0,pt):ut},ut.cV=function(ut){return ut.indexOf(b_)>=0},ut.cW=function(ut){const pt=ut.indexOf(b_);return pt>=0?ut.slice(pt+1):""},ut.cX=function(ut){const pt=[],wt=ut.id;return void 0===wt&&pt.push({message:`layers.${wt}: missing required property "id"`}),void 0===ut.render&&pt.push({message:`layers.${wt}: missing required method "render"`}),ut.renderingMode&&"2d"!==ut.renderingMode&&"3d"!==ut.renderingMode&&pt.push({message:`layers.${wt}: property "renderingMode" must be either "2d" or "3d"`}),pt},ut.cY=function(ut,pt,wt,Tt){return"custom"===ut.type?new mb(ut,pt):new IT[ut.type](ut,pt,wt,Tt)},ut.cZ=cr,ut.c_=g_,ut.ca=1,ut.cb=qb,ut.cc=0,ut.cd=nu,ut.ce=function(ut,pt,wt,Tt,St){return Ke((ut-pt)/(wt-pt)*(St-Tt)+Tt,Tt,St)},ut.cf=Na,ut.cg=Rc,ut.ch=class{constructor(ut,pt,wt,Tt){this.context=ut,this.format=Tt,this.size=wt,this.texture=ut.gl.createTexture();const[St,It,Lt]=this.size,{gl:Xt}=ut;Xt.bindTexture(Xt.TEXTURE_3D,this.texture),ut.pixelStoreUnpackFlipY.set(!1),ut.pixelStoreUnpack.set(1),ut.pixelStoreUnpackPremultiplyAlpha.set(!1);let Yt=this.format,Mi=Xt.UNSIGNED_BYTE;this.format===Xt.DEPTH_COMPONENT&&(Yt=Xt.DEPTH_COMPONENT16,Mi=Xt.UNSIGNED_SHORT),this.format===Xt.R8&&(Tt=Xt.RED),this.format===Xt.R32F&&(Mi=Xt.FLOAT,Tt=Xt.RED),Xt.texImage3D(Xt.TEXTURE_3D,0,Yt,St,It,Lt,0,Tt,Mi,pt.data)}bind(ut,pt){const{context:wt}=this,{gl:Tt}=wt;Tt.bindTexture(Tt.TEXTURE_3D,this.texture),ut!==this.minFilter&&(Tt.texParameteri(Tt.TEXTURE_3D,Tt.TEXTURE_MAG_FILTER,ut),Tt.texParameteri(Tt.TEXTURE_3D,Tt.TEXTURE_MIN_FILTER,ut),this.minFilter=ut),pt!==this.wrapS&&(Tt.texParameteri(Tt.TEXTURE_3D,Tt.TEXTURE_WRAP_S,pt),Tt.texParameteri(Tt.TEXTURE_3D,Tt.TEXTURE_WRAP_T,pt),this.wrapS=pt)}destroy(){const{gl:ut}=this.context;ut.deleteTexture(this.texture),this.texture=null}},ut.ci=kb,ut.cj=[1,1,1],ut.ck=Qf,ut.cl=lT,ut.cm=Zl,ut.cn=iu,ut.co=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new xc(1/0,1/0),max:new xc(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(ut,pt=!1){const wt=Rf(new xc(0,0),new xc(xf,xf),ut),Tt=[];if(pt&&!Df(wt,this._globalClipBounds))return Tt;for(const pt of this._activeRegions){if(pt.hiddenByOverlap)continue;if(!Df(wt,pt))continue;const St=Vf(pt.min,pt.max,ut);Tt.push({min:St.min,max:St.max,sourceId:this._sourceIds[pt.priority],footprint:pt.footprint,footprintTileId:pt.tileId,order:pt.order,clipMask:pt.clipMask})}return Tt}setSources(ut){this._setSources(ut.map((ut=>({getSourceId:()=>ut.cache.id,getFootprints:()=>{const pt=[];for(const wt of ut.cache.getVisibleCoordinates()){const Tt=ut.cache.getTile(wt).buckets[ut.layer];Tt&&Tt.updateFootprints(wt.toUnwrapped(),pt)}return pt},getOrder:()=>ut.order,getClipMask:()=>ut.clipMask}))))}_addSource(ut){const pt=ut.getFootprints();if(0===pt.length)return;const wt=ut.getOrder(),Tt=ut.getClipMask();for(const ut of pt){if(!ut.footprint)continue;const pt=Rf(ut.footprint.min,ut.footprint.max,ut.id);this._activeRegions.push({min:pt.min,max:pt.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:ut.id,footprint:ut.footprint,order:wt,clipMask:Tt})}this._sourceIds.push(ut.getSourceId())}_computeReplacement(){this._activeRegions.sort(((ut,pt)=>ut.priority-pt.priority||Ef(ut.min,pt.min)||Ef(ut.max,pt.max)));let ut=this._activeRegions.length!==this._prevRegions.length;if(!ut){let pt=0;for(;!ut&&pt!==this._activeRegions.length;){const wt=this._activeRegions[pt],Tt=this._prevRegions[pt];ut=wt.priority!==Tt.priority||!Bf(wt,Tt)||wt.order!==Tt.order||wt.clipMask!==Tt.clipMask,++pt}}if(ut){++this._updateTime;for(const ut of this._activeRegions)ut.order!==1/0&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,ut.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,ut.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,ut.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,ut.max.y));const t=ut=>{const pt=this._activeRegions;if(ut>=pt.length)return ut;const wt=pt[ut].priority;for(;ut<pt.length&&pt[ut].priority===wt;)++ut;return ut};if(this._sourceIds.length>1){let ut=0,pt=t(ut);for(;ut!==pt;){let wt=ut;const Tt=ut;for(;wt!==pt;){const ut=this._activeRegions[wt];ut.hiddenByOverlap=!1;for(let pt=0;pt<Tt;pt++){const wt=this._activeRegions[pt];if(!wt.hiddenByOverlap&&ut.order===1/0&&Df(ut,wt)&&(ut.hiddenByOverlap=Lf(ut.footprint,ut.tileId,wt.footprint,wt.tileId),ut.hiddenByOverlap))break}++wt}ut=pt,pt=t(ut)}}}}_setSources(ut){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let pt=ut.length-1;pt>=0;pt--)this._addSource(ut[pt]);this._computeReplacement()}},ut.cp=Vl,ut.cq=cw,ut.cr=au,ut.cs=class{constructor(ut){this._createGrid(ut),this._createPoles(ut)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const ut of this._poleSegments)ut.destroy();for(const ut of this._gridSegments)ut.withSkirts.destroy(),ut.withoutSkirts.destroy()}_fillGridMeshWithLods(ut,pt){const wt=new Cl,Tt=new Ql,St=[],It=ut+1+2,Lt=pt[0]+1,Xt=pt[0]+1+(1+pt.length),l=(ut,pt,wt)=>{let Tt=ut===It-1?ut-2:0===ut?ut:ut-1;return Tt+=wt?24575:0,[Tt,pt]};for(let ut=0;ut<It;++ut)wt.emplaceBack(...l(ut,0,!0));for(let ut=0;ut<Lt;++ut)for(let pt=0;pt<It;++pt)wt.emplaceBack(...l(pt,ut,(0===pt||pt===It-1)&&!0));for(let ut=0;ut<pt.length;++ut){const Tt=pt[ut];for(let ut=0;ut<It;++ut)wt.emplaceBack(...l(ut,Tt,!0))}for(let ut=0;ut<pt.length;++ut){const Lt=Tt.length,Yt=pt[ut]+1+2,Mi=new Ql;for(let wt=0;wt<Yt-1;wt++){const St=wt===Yt-2,Lt=St?It*(Xt-pt.length+ut-wt):It;for(let ut=0;ut<It-1;ut++){const pt=wt*It+ut;0===wt||St||0===ut||ut===It-2?(Mi.emplaceBack(pt+1,pt,pt+Lt),Mi.emplaceBack(pt+Lt,pt+Lt+1,pt+1)):(Tt.emplaceBack(pt+1,pt,pt+Lt),Tt.emplaceBack(pt+Lt,pt+Lt+1,pt+1))}}const vr=Au.simpleSegment(0,Lt,wt.length,Tt.length-Lt);for(let ut=0;ut<Mi.uint16.length;ut+=3)Tt.emplaceBack(Mi.uint16[ut],Mi.uint16[ut+1],Mi.uint16[ut+2]);const br=Au.simpleSegment(0,Lt,wt.length,Tt.length-Lt);St.push({withoutSkirts:vr,withSkirts:br})}return{vertices:wt,indices:Tt,segments:St}}_createGrid(ut){const pt=this._fillGridMeshWithLods(N_,V_);this._gridSegments=pt.segments,this._gridBuffer=ut.createVertexBuffer(pt.vertices,hg.members),this._gridIndexBuffer=ut.createIndexBuffer(pt.indices,!0)}_createPoles(ut){const pt=new Ql;for(let ut=0;ut<=N_;ut++)pt.emplaceBack(0,ut+1,ut+2);this._poleIndexBuffer=ut.createIndexBuffer(pt,!0);const wt=new ru,Tt=new ru,St=new ru,It=new ru;this._poleSegments=[];for(let ut=0,pt=0;ut<O_;ut++){const Lt=360/(1<<ut);wt.emplaceBack(0,-k_,0,.5,0),Tt.emplaceBack(0,-k_,0,.5,1),St.emplaceBack(0,-k_,0,.5,.5),It.emplaceBack(0,-k_,0,.5,.5);for(let ut=0;ut<=N_;ut++){let pt=ut/N_,Xt=0;const Yt=Gn(0,Lt,pt),[Mi,vr,br]=hc(bg,Pg,Yt,k_);wt.emplaceBack(Mi,vr,br,pt,Xt),Tt.emplaceBack(Mi,vr,br,pt,1-Xt);const Ar=$e(Yt);pt=.5+.5*Math.sin(Ar),Xt=.5+.5*Math.cos(Ar),St.emplaceBack(Mi,vr,br,pt,Xt),It.emplaceBack(Mi,vr,br,pt,1-Xt)}this._poleSegments.push(Au.simpleSegment(pt,0,66,64)),pt+=66}this._poleNorthVertexBuffer=ut.createVertexBuffer(wt,cg,!1),this._poleSouthVertexBuffer=ut.createVertexBuffer(Tt,cg,!1),this._texturedPoleNorthVertexBuffer=ut.createVertexBuffer(St,cg,!1),this._texturedPoleSouthVertexBuffer=ut.createVertexBuffer(It,cg,!1)}getGridBuffers(ut,pt){return[this._gridBuffer,this._gridIndexBuffer,pt?this._gridSegments[ut].withSkirts:this._gridSegments[ut].withoutSkirts]}getPoleBuffers(ut,pt){return[pt?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,pt?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[ut]]}},ut.ct=function(ut){return qd.has(ut)},ut.cu=hx,ut.cv=function(ut,pt,wt=0,Tt=!0){const St=new xc(wt,wt),It=ut.sub(St),Lt=pt.add(St),Xt=[It,new xc(Lt.x,It.y),Lt,new xc(It.x,Lt.y)];return Tt&&Xt.push(It.clone()),Xt},ut.cw=function(ut,pt){const wt=[];for(let Tt=0;Tt<ut.length;Tt++){const St=Je(Tt-1,-1,ut.length-1),It=Je(Tt+1,-1,ut.length-1),Lt=ut[Tt],Xt=ut[It],Yt=ut[St].sub(Lt).unit(),Mi=Xt.sub(Lt).unit(),vr=Mi.angleWithSep(Yt.x,Yt.y),br=Yt.add(Mi).unit().mult(-1*pt/Math.sin(vr/2));wt.push(Lt.add(br))}return wt},ut.cx=ig,ut.cy=oh,ut.cz=function(pt,wt,Tt=0){return ut._.fromValues(((wt.x-Tt)*pt.scale-pt.x)*xf,(wt.y*pt.scale-pt.y)*xf,Bc(wt.z,wt.y))},ut.d=Vn,ut.d$=gc,ut.d0=Ze,ut.d1=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},ut.d2=Dc,ut.d3=Vc,ut.d4=pc,ut.d5=function([ut,pt,wt]){const Tt=Math.hypot(ut,pt,wt),St=Math.atan2(ut,wt),It=.5*Math.PI-Math.acos(-pt/Tt);return new mc(Ge(St),Ge(It))},ut.d6=Pc,ut.d7=G_,ut.d8=It,ut.d9=Wh,ut.dA=function(ut){const pt=Nr();if(!pt)return;const wt=pt.delete(mh);ut&&wt.catch(ut).then((()=>ut()))},ut.dB=cT,ut.dC=dv,ut.dD=function(ut){pT=Ju.resolveURL(ut),gT||(gT=new ev(ov(),new Fn)),gT.broadcast("setDracoUrl",pT)},ut.dE=mv,ut.dF=function(ut){mT=Ju.resolveURL(ut),gT||(gT=new ev(ov(),new Fn)),gT.broadcast("setMeshoptUrl",mT)},ut.dG=tr,ut.dH=Mo,ut.dI=pp,ut.dJ=sb,ut.dK=ng,ut.dL=pu,ut.dM=um,ut.dN=Vm,ut.dO=Kd,ut.dP=ur,ut.dQ=Ty,ut.dR=$g,ut.dS=function(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr){ut.createArrays(),ut.tilePixelRatio=xf/(512*ut.overscaling),ut.compareText={},ut.iconsNeedLinear=!1;const br=ut.layers[0].layout,Ar=ut.layers[0]._unevaluatedLayout._values,Vr={};if("composite"===ut.textSizeData.kind){const{minZoom:pt,maxZoom:wt}=ut.textSizeData;Vr.compositeTextSizes=[Ar["text-size"].possiblyEvaluate(new Ho(pt),Xt),Ar["text-size"].possiblyEvaluate(new Ho(wt),Xt)]}if("composite"===ut.iconSizeData.kind){const{minZoom:pt,maxZoom:wt}=ut.iconSizeData;Vr.compositeIconSizes=[Ar["icon-size"].possiblyEvaluate(new Ho(pt),Xt),Ar["icon-size"].possiblyEvaluate(new Ho(wt),Xt)]}Vr.layoutTextSize=Ar["text-size"].possiblyEvaluate(new Ho(Yt+1),Xt),Vr.layoutIconSize=Ar["icon-size"].possiblyEvaluate(new Ho(Yt+1),Xt),Vr.textMaxSize=Ar["text-size"].possiblyEvaluate(new Ho(18),Xt);const nn="map"===br.get("text-rotation-alignment")&&"point"!==br.get("symbol-placement"),sn=br.get("text-size");let an=!1;for(const pt of ut.features)if(pt.icon&&pt.icon.nameSecondary){an=!0;break}for(const It of ut.features){const Yt=br.get("text-font").evaluate(It,{},Xt).join(","),Ar=sn.evaluate(It,{},Xt),ln=Vr.layoutTextSize.evaluate(It,{},Xt),cn=(Vr.layoutIconSize.evaluate(It,{},Xt),{horizontal:{},vertical:void 0}),un=It.text;let fn,_n=[0,0];if(un){const Tt=un.toString(),Lt=br.get("text-letter-spacing").evaluate(It,{},Xt)*wv,Mi=br.get("text-line-height").evaluate(It,{},Xt)*wv,vr=Po(Tt)?Lt:0,Vr=br.get("text-anchor").evaluate(It,{},Xt),sn=br.get("text-variable-anchor");if(!sn){const ut=br.get("text-radial-offset").evaluate(It,{},Xt);_n=ut?Xy(Vr,[ut*wv,fb]):br.get("text-offset").evaluate(It,{},Xt).map((ut=>ut*wv))}let an=nn?"center":br.get("text-justify").evaluate(It,{},Xt);const fn="point"===br.get("symbol-placement"),gn=fn?br.get("text-max-width").evaluate(It,{},Xt)*wv:1/0,M=It=>{ut.allowVerticalPlacement&&zo(Tt)&&(cn.vertical=ny(un,pt,wt,St,Yt,gn,Mi,Vr,It,vr,_n,Jv.vertical,!0,ln,Ar))};if(!nn&&sn){const ut="auto"===an?sn.map((ut=>Yy(ut))):[an];let Tt=!1;for(let It=0;It<ut.length;It++){const Lt=ut[It];if(!cn.horizontal[Lt])if(Tt)cn.horizontal[Lt]=cn.horizontal[0];else{const ut=ny(un,pt,wt,St,Yt,gn,Mi,"center",Lt,vr,_n,Jv.horizontal,!1,ln,Ar);ut&&(cn.horizontal[Lt]=ut,Tt=1===ut.positionedLines.length)}}M("left")}else{if("auto"===an&&(an=Yy(Vr)),fn||br.get("text-writing-mode").indexOf("horizontal")>=0||!zo(Tt)){const ut=ny(un,pt,wt,St,Yt,gn,Mi,Vr,an,vr,_n,Jv.horizontal,!1,ln,Ar);ut&&(cn.horizontal[an]=ut)}M(fn?"left":an)}}let gn=!1;if(It.icon&&It.icon.namePrimary){const pt=Tt[It.icon.namePrimary];pt&&(fn=fy(St[It.icon.namePrimary],It.icon.nameSecondary?St[It.icon.nameSecondary]:void 0,br.get("icon-offset").evaluate(It,{},Xt),br.get("icon-anchor").evaluate(It,{},Xt)),gn=pt.sdf,void 0===ut.sdfIcons?ut.sdfIcons=pt.sdf:ut.sdfIcons!==pt.sdf&&fr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(pt.pixelRatio!==ut.pixelRatio||0!==br.get("icon-rotate").constantOr(1))&&(ut.iconsNeedLinear=!0))}const yn=Jy(cn.horizontal)||cn.vertical;ut.iconsInText||(ut.iconsInText=!!yn&&yn.iconsInText),(yn||fn)&&Zy(ut,It,cn,fn,Tt,Vr,ln,0,_n,gn,Lt,Xt,Mi,vr,an)}It&&ut.generateCollisionDebugBuffers(Yt,ut.collisionBoxArray)},ut.dT=tm,ut.dU=Wp,ut.dV=ix,ut.dW=xv,ut.dX=Jf,ut.dY=Nx,ut.dZ=rx,ut.d_=Gy,ut.da=Kh,ut.db=function(pt){const wt=[0,0,0],Tt=ut.ad.identity(new Float64Array(16));return ut.ad.multiply(Tt,pt.pixelMatrix,pt.globeMatrix),ut._.transformMat4(wt,wt,Tt),new xc(wt[0],wt[1])},ut.dc=Xt,ut.dd=Lt,ut.de=function(ut){const pt=ut.navigator?ut.navigator.userAgent:null;return!!function(ut){if(null==ju){const pt=ut.navigator?ut.navigator.userAgent:null;ju=!!ut.safari||!(!pt||!(/\b(iPad|iPhone|iPod)\b/.test(pt)||pt.match("Safari")&&!pt.match("Chrome")))}return ju}(ut)&&pt&&(pt.match("Version/15.4")||pt.match("Version/15.5")||pt.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},ut.df=nr,ut.dg=class{constructor(ut,pt,wt){this._transformRequestFn=ut,this._customAccessToken=pt,this._silenceAuthErrors=!!wt,this._createSkuToken()}_createSkuToken(){const ut=function(){let ut="";for(let pt=0;pt<10;pt++)ut+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",ad,ut].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=ut.token,this._skuTokenExpiresAt=ut.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(ut,pt){return this._transformRequestFn&&this._transformRequestFn(ut,pt)||{url:ut}}normalizeStyleURL(ut,pt){if(!s(ut))return ut;const Tt=hn(ut);return Tt.params.push(`sdk=js-${wt}`),Tt.path=`/styles/v1${Tt.path}`,this._makeAPIURL(Tt,this._customAccessToken||pt)}normalizeGlyphsURL(ut,pt){if(!s(ut))return ut;const wt=hn(ut);return wt.path=`/fonts/v1${wt.path}`,this._makeAPIURL(wt,this._customAccessToken||pt)}normalizeModelURL(ut,pt){if(!s(ut))return ut;const wt=hn(ut);return wt.path=`/models/v1${wt.path}`,this._makeAPIURL(wt,this._customAccessToken||pt)}normalizeSourceURL(ut,pt,wt,Tt){if(!s(ut))return ut;const St=hn(ut);return St.path=`/v4/${St.authority}.json`,St.params.push("secure"),wt&&St.params.push(`language=${wt}`),Tt&&St.params.push(`worldview=${Tt}`),this._makeAPIURL(St,this._customAccessToken||pt)}normalizeSpriteURL(ut,pt,wt,Tt){const St=hn(ut);return s(ut)?(St.path=`/styles/v1${St.path}/sprite${pt}${wt}`,this._makeAPIURL(St,this._customAccessToken||Tt)):(St.path+=`${pt}${wt}`,pn(St))}normalizeTileURL(ut,pt,wt){if(this._isSkuTokenExpired()&&this._createSkuToken(),ut&&!s(ut))return ut;const Tt=hn(ut);Tt.path=Tt.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${pt||wt&&"raster"!==Tt.authority&&512===wt?"@2x":""}${kh.supported?".webp":"$1"}`),"raster"===Tt.authority?Tt.path=`/${It.RASTER_URL_PREFIX}${Tt.path}`:"rasterarrays"===Tt.authority?Tt.path=`/${It.RASTERARRAYS_URL_PREFIX}${Tt.path}`:"3dtiles"===Tt.authority?Tt.path=`/${It.TILES3D_URL_PREFIX}${Tt.path}`:(Tt.path=Tt.path.replace(/^.+\/v4\//,"/"),Tt.path=`/${It.TILE_URL_VERSION}${Tt.path}`);const St=this._customAccessToken||function(ut){for(const pt of ut){const ut=pt.match(/^access_token=(.*)$/);if(ut)return ut[1]}return null}(Tt.params)||It.ACCESS_TOKEN;return It.REQUIRE_ACCESS_TOKEN&&St&&this._skuToken&&Tt.params.push(`sku=${this._skuToken}`),this._makeAPIURL(Tt,St)}canonicalizeTileURL(ut,pt){const wt=hn(ut);if(!wt.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!wt.path.match(/\.[\w]+$/))return ut;let Tt="mapbox://";wt.path.match(/^\/raster\/v1\//)?Tt+=`raster/${wt.path.replace(`/${It.RASTER_URL_PREFIX}/`,"")}`:wt.path.match(/^\/rasterarrays\/v1\//)?Tt+=`rasterarrays/${wt.path.replace(`/${It.RASTERARRAYS_URL_PREFIX}/`,"")}`:Tt+=`tiles/${wt.path.replace(`/${It.TILE_URL_VERSION}/`,"")}`;let St=wt.params;return pt&&(St=St.filter((ut=>!ut.match(/^access_token=/)))),St.length&&(Tt+=`?${St.join("&")}`),Tt}canonicalizeTileset(ut,pt){const wt=!!pt&&s(pt),Tt=[];for(const pt of ut.tiles||[])i(pt)?Tt.push(this.canonicalizeTileURL(pt,wt)):Tt.push(pt);return Tt}_makeAPIURL(ut,pt){const wt="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",Tt=hn(It.API_URL);if(ut.protocol=Tt.protocol,ut.authority=Tt.authority,"http"===ut.protocol){const pt=ut.params.indexOf("secure");pt>=0&&ut.params.splice(pt,1)}if("/"!==Tt.path&&(ut.path=`${Tt.path}${ut.path}`),!It.REQUIRE_ACCESS_TOKEN)return pn(ut);if(pt=pt||It.ACCESS_TOKEN,!this._silenceAuthErrors){if(!pt)throw new Error(`An API access token is required to use Mapbox GL. ${wt}`);if("s"===pt[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${wt}`)}return ut.params=ut.params.filter((ut=>-1===ut.indexOf("access_token"))),ut.params.push(`access_token=${pt||""}`),pn(ut)}},ut.dh=function(ut,pt){pt?qd.add(ut):qd.delete(ut)},ut.di=kh,ut.dj=Ud,ut.dk=Gd,ut.dl=md,ut.dm=Od,ut.dn=Nd,ut.dp=function(ut){qd.delete(ut)},ut.dq=jd,ut.dr=Rd,ut.ds=Qe,ut.dt=wt,ut.du=function(ut,pt){yh=ut,Th=pt},ut.dv=function(ut,pt,wt=!1){if(m_===h_||m_===d_||m_===p_)throw new Error("setRTLTextPlugin cannot be called multiple times.");__=Ju.resolveURL(ut),m_=h_,f_=pt,$o(),wt||Yo()},ut.dw=Xo,ut.dx=function(){ov().acquire(uT)},ut.dy=function(){const ut=hT;ut&&(ut.isPreloaded()&&1===ut.numActive()?(ut.release(uT),hT=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},ut.dz=sv,ut.e=Ju,ut.e0=hv,ut.e1=p,ut.e2=en,ut.e3=function(ut){let pt=0;if(new Uint32Array(ut,0,1)[0]!==TT){const wt=new Uint32Array(ut,0,7),[,,Tt,St,It,Lt]=wt;pt=wt.byteLength+St+It+Lt+It,(Tt!==ut.byteLength||pt>=ut.byteLength)&&fr("Invalid b3dm header information.")}return Pv(ut,pt)},ut.e4=function(ut,pt){const wt=Lv(ut);for(const ut of wt){for(const pt of ut.meshes)Ov(pt);ut.lights&&(ut.lightMeshIndex=ut.meshes.length,ut.meshes.push(Uv(ut.lights,pt)))}return wt},ut.e5=Yv,ut.e6=tv,ut.e7=y_,ut.e8=function(ut){jr(),Sh&&Sh.then((pt=>{pt.keys().then((wt=>{for(let Tt=0;Tt<wt.length-ut;Tt++)pt.delete(wt[Tt])}))}))},ut.f=Rn,ut.g=function(ut,pt){return tn(er(ut,{type:"json"}),pt)},ut.h=on,ut.i=fp,ut.j=Ay,ut.k=Iy,ut.l=function(ut){return fetch(ut).then((ut=>ut.arrayBuffer())).then((pt=>Pv(pt,0,ut)))},ut.m=class extends Fb{},ut.n=Ti,ut.o=Zn,ut.p=uw,ut.q=Wa,ut.r=Qa,ut.s=to,ut.t=co,ut.u=ul,ut.v=cl,ut.w=fr,ut.x=mo,ut.y=ho,ut.z=Ys}));define(["./shared"],(function(ut){function t(ut){const pt=ut?ut.url.toString():void 0;return pt?performance.getEntriesByName(pt):[]}function s(ut){if("number"==typeof ut||"boolean"==typeof ut||"string"==typeof ut||null==ut)return JSON.stringify(ut);if(Array.isArray(ut)){let pt="[";for(const wt of ut)pt+=`${s(wt)},`;return`${pt}]`}let pt="{";for(const wt of Object.keys(ut).sort())pt+=`${wt}:${s(ut[wt])},`;return`${pt}}`}function o(pt){let wt="";for(const Tt of ut.cE)wt+=`/${s(pt[Tt])}`;return wt}class i{constructor(ut){this.keyCache={},this._layers={},this._layerConfigs={},ut&&this.replace(ut)}replace(ut,pt){this._layerConfigs={},this._layers={},this.update(ut,[],pt)}update(pt,wt,Tt){this._options=Tt;for(const wt of pt)this._layerConfigs[wt.id]=wt,(this._layers[wt.id]=ut.cY(wt,this.scope,null,this._options)).compileFilter(),this.keyCache[wt.id]&&delete this.keyCache[wt.id];for(const ut of wt)delete this.keyCache[ut],delete this._layerConfigs[ut],delete this._layers[ut];this.familiesBySource={};const St=function(ut,pt){const wt={};for(let Tt=0;Tt<ut.length;Tt++){const St=pt&&pt[ut[Tt].id]||o(ut[Tt]);pt&&(pt[ut[Tt].id]=St);let It=wt[St];It||(It=wt[St]=[]),It.push(ut[Tt])}const Tt=[];for(const ut in wt)Tt.push(wt[ut]);return Tt}(ut.dG(this._layerConfigs),this.keyCache);for(const ut of St){const pt=ut.map((ut=>this._layers[ut.id])),wt=pt[0];if("none"===wt.visibility)continue;const Tt=wt.source||"";let St=this.familiesBySource[Tt];St||(St=this.familiesBySource[Tt]={});const It=wt.sourceLayer||"_geojsonTileLayer";let Lt=St[It];Lt||(Lt=St[It]=[]),Lt.push(pt)}}}const wt=1*ut.dJ;class r{constructor(pt){const Tt={},St=[];for(const ut in pt){const It=pt[ut],Lt=Tt[ut]={};for(const ut in It.glyphs){const pt=It.glyphs[+ut];if(!pt||0===pt.bitmap.width||0===pt.bitmap.height)continue;const Tt=pt.metrics.localGlyph?wt:1,Xt={x:0,y:0,w:pt.bitmap.width+2*Tt,h:pt.bitmap.height+2*Tt};St.push(Xt),Lt[ut]=Xt}}const{w:It,h:Lt}=ut.j(St),Xt=new ut.dI({width:It||1,height:Lt||1});for(const St in pt){const It=pt[St];for(const pt in It.glyphs){const Lt=It.glyphs[+pt];if(!Lt||0===Lt.bitmap.width||0===Lt.bitmap.height)continue;const Yt=Tt[St][pt],Mi=Lt.metrics.localGlyph?wt:1;ut.dI.copy(Lt.bitmap,Xt,{x:0,y:0},{x:Yt.x+Mi,y:Yt.y+Mi},Lt.bitmap)}}this.image=Xt,this.positions=Tt}}ut.dH(r,"GlyphAtlas");class a{constructor(pt){this.tileID=new ut.aL(pt.tileID.overscaledZ,pt.tileID.wrap,pt.tileID.canonical.z,pt.tileID.canonical.x,pt.tileID.canonical.y),this.tileZoom=pt.tileZoom,this.uid=pt.uid,this.zoom=pt.zoom,this.lut=pt.lut,this.canonical=pt.tileID.canonical,this.pixelRatio=pt.pixelRatio,this.tileSize=pt.tileSize,this.source=pt.source,this.scope=pt.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=pt.showCollisionBoxes,this.collectResourceTiming=!!pt.collectResourceTiming,this.promoteId=pt.promoteId,this.isSymbolTile=pt.isSymbolTile,this.tileTransform=ut.dK(pt.tileID.canonical,pt.projection),this.projection=pt.projection,this.brightness=pt.brightness,this.extraShadowCaster=!!pt.extraShadowCaster,this.tessellationStep=pt.tessellationStep}parse(pt,wt,Tt,St,It){this.status="parsing",this.data=pt,this.collisionBoxArray=new ut.dL;const Lt=new ut.dM(Object.keys(pt.layers).sort()),Xt=new ut.dN(this.tileID,this.promoteId);Xt.bucketLayerIDs=[];const Yt={},Mi=new ut.dO(256,256),vr={featureIndex:Xt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Mi,availableImages:Tt,brightness:this.brightness},br=wt.familiesBySource[this.source];for(const wt in br){const St=pt.layers[wt];if(!St)continue;let It=!1,Mi=!1,Ar=!1;for(const ut of br[wt])"symbol"===ut[0].type?It=!0:Mi=!0,ut[0].is3D()&&"model"!==ut[0].type&&(Ar=!0);if(this.extraShadowCaster&&!Ar)continue;if(!0===this.isSymbolTile&&!It)continue;if(!1===this.isSymbolTile&&!Mi)continue;1===St.version&&ut.w(`Vector tile source "${this.source}" layer "${wt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Vr=Lt.encode(wt),nn=[];for(let ut=0;ut<St.length;ut++){const pt=St.feature(ut),Tt=Xt.getId(pt,wt);nn.push({feature:pt,id:Tt,index:ut,sourceLayerIndex:Vr})}for(const ut of br[wt]){const pt=ut[0];(!this.extraShadowCaster||pt.is3D()&&"model"!==pt.type)&&(void 0!==this.isSymbolTile&&"symbol"===pt.type!==this.isSymbolTile||pt.minzoom&&this.zoom<Math.floor(pt.minzoom)||pt.maxzoom&&this.zoom>=pt.maxzoom||"none"!==pt.visibility&&(l(ut,this.zoom,vr.brightness,Tt),(Yt[pt.id]=pt.createBucket({index:Xt.bucketLayerIDs.length,layers:ut,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Vr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(nn,vr,this.tileID.canonical,this.tileTransform),Xt.bucketLayerIDs.push(ut.map((ut=>ut.id)))))}}let Ar,Vr,nn,sn;Mi.trim();const an={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},w=()=>{if(Ar)return this.status="done",It(Ar);if(this.extraShadowCaster)this.status="done",It(null,{buckets:ut.dG(Yt).filter((ut=>!ut.isEmpty())),featureIndex:Xt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:vr.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Vr&&nn&&sn){const pt=new r(Vr),wt=new ut.dQ(nn,sn,this.lut);for(const St in Yt){const It=Yt[St];It instanceof ut.dR?(l(It.layers,this.zoom,vr.brightness,Tt),ut.dS(It,Vr,pt.positions,nn,wt.iconPositions,this.showCollisionBoxes,Tt,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):It.hasPattern&&(It instanceof ut.dT||It instanceof ut.dU||It instanceof ut.b_)&&(l(It.layers,this.zoom,vr.brightness,Tt),It.addFeatures(vr,this.tileID.canonical,wt.patternPositions,Tt,this.tileTransform,this.brightness))}this.status="done",It(null,{buckets:ut.dG(Yt).filter((ut=>!ut.isEmpty())),featureIndex:Xt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:pt.image,lineAtlas:Mi,imageAtlas:wt,brightness:vr.brightness})}};if(!this.extraShadowCaster){const pt=ut.dP(vr.glyphDependencies,(ut=>Object.keys(ut).map(Number)));Object.keys(pt).length?St.send("getGlyphs",{uid:this.uid,stacks:pt,scope:this.scope},((ut,pt)=>{Ar||(Ar=ut,Vr=pt,w())}),void 0,!1,an):Vr={};const wt=Object.keys(vr.iconDependencies);wt.length?St.send("getImages",{icons:wt,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((ut,pt)=>{Ar||(Ar=ut,nn=pt,w())}),void 0,!1,an):nn={};const Tt=Object.keys(vr.patternDependencies);Tt.length?St.send("getImages",{icons:Tt,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((ut,pt)=>{Ar||(Ar=ut,sn=pt,w())}),void 0,!1,an):sn={}}w()}}function l(pt,wt,Tt,St){const It=new ut.X(wt,{brightness:Tt});for(const ut of pt)ut.recalculate(It,St)}class c extends ut.E{constructor(pt,wt,Tt,St,It,Lt){super(),this.actor=pt,this.layerIndex=wt,this.availableImages=Tt,this.loadVectorData=It||ut.ap,this.loading={},this.loaded={},this.deduped=new ut.ao(pt.scheduler),this.isSpriteLoaded=St,this.scheduler=pt.scheduler,this.brightness=Lt}loadTile(pt,wt){const Tt=pt.uid,St=pt&&pt.request,It=St&&St.collectResourceTiming,Lt=this.loading[Tt]=new a(pt);Lt.abort=this.loadVectorData(pt,((Xt,Yt)=>{const Mi=!this.loading[Tt];if(delete this.loading[Tt],Mi||Xt||!Yt)return Lt.status="done",Mi||(this.loaded[Tt]=Lt),wt(Xt);const vr=Yt.rawData,br={};Yt.expires&&(br.expires=Yt.expires),Yt.cacheControl&&(br.cacheControl=Yt.cacheControl),Lt.vectorTile=Yt.vectorTile||new ut.dV(new ut.dW(vr));const f=()=>{Lt.parse(Lt.vectorTile,this.layerIndex,this.availableImages,this.actor,((pt,Tt)=>{if(pt||!Tt)return wt(pt);const Lt={};if(It){const ut=t(St);ut.length>0&&(Lt.resourceTiming=JSON.parse(JSON.stringify(ut)))}wt(null,ut.W({rawTileData:vr.slice(0)},Tt,br,Lt))}))};this.isSpriteLoaded?f():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(f,{type:"parseTile",isSymbolTile:pt.isSymbolTile,zoom:pt.tileZoom}):f()})),this.loaded=this.loaded||{},this.loaded[Tt]=Lt}))}reloadTile(pt,wt){const Tt=this.loaded,St=pt.uid;if(Tt&&Tt[St]){const It=Tt[St];It.showCollisionBoxes=pt.showCollisionBoxes,It.projection=pt.projection,It.brightness=pt.brightness,It.tileTransform=ut.dK(pt.tileID.canonical,pt.projection),It.extraShadowCaster=pt.extraShadowCaster,It.lut=pt.lut;const r=(ut,pt)=>{const Tt=It.reloadCallback;Tt&&(delete It.reloadCallback,It.parse(It.vectorTile,this.layerIndex,this.availableImages,this.actor,Tt)),wt(ut,pt)};"parsing"===It.status?It.reloadCallback=r:"done"===It.status&&(It.vectorTile?It.parse(It.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else wt(null,void 0)}abortTile(ut,pt){const wt=ut.uid,Tt=this.loading[wt];Tt&&(Tt.abort&&Tt.abort(),delete this.loading[wt]),pt()}removeTile(ut,pt){const wt=this.loaded,Tt=ut.uid;wt&&wt[Tt]&&delete wt[Tt],pt()}}class h{loadTile(pt,wt){const{uid:Tt,encoding:St,rawImageData:It,padding:Lt}=pt,Xt=ImageBitmap&&It instanceof ImageBitmap?this.getImageData(It,Lt):It;wt(null,new ut.dX(Tt,Xt,St,Lt<1))}getImageData(ut,pt){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(ut.width,ut.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=ut.width,this.offscreenCanvas.height=ut.height,this.offscreenCanvasContext.drawImage(ut,0,0,ut.width,ut.height);const wt=this.offscreenCanvasContext.getImageData(-pt,-pt,ut.width+2*pt,ut.height+2*pt);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),wt}}class u{decodeRasterArray({task:pt,buffer:wt},Tt){ut.dY.performDecoding(wt,pt).then((ut=>{Tt(null,ut)}),(ut=>{Tt(ut)}))}}const Tt=ut.dZ.prototype.toGeoJSON;let St=class{constructor(pt){this._feature=pt,this.extent=ut.a3,this.type=pt.type,this.properties=pt.tags,"id"in pt&&!isNaN(pt.id)&&(this.id=parseInt(pt.id,10))}loadGeometry(){if(1===this._feature.type){const pt=[];for(const wt of this._feature.geometry)pt.push([new ut.P(wt[0],wt[1])]);return pt}{const pt=[];for(const wt of this._feature.geometry){const Tt=[];for(const pt of wt)Tt.push(new ut.P(pt[0],pt[1]));pt.push(Tt)}return pt}}toGeoJSON(ut,pt,wt){return Tt.call(this,ut,pt,wt)}},It=class{constructor(pt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=ut.a3,this.length=pt.length,this._features=pt}feature(ut){return new St(this._features[ut])}};const Lt=64/4096;class m{constructor(){this.features=new Map}clear(){this.features.clear()}load(ut=[],pt){for(const wt of ut){const ut=wt.id;if(null==ut)continue;let Tt=this.features.get(ut);Tt&&this.updateCache(Tt,pt),wt.geometry?(Tt=x(wt),this.updateCache(Tt,pt),this.features.set(ut,Tt)):this.features.delete(ut),this.updateCache(Tt,pt)}}updateCache(ut,pt){for(const{canonical:wt,uid:Tt}of Object.values(pt)){const{z:St,x:It,y:Lt}=wt;y(ut,Math.pow(2,St),It,Lt)&&delete pt[Tt]}}getTile(ut,pt,wt){const Tt=Math.pow(2,ut),St=[];for(const ut of this.features.values())y(ut,Tt,pt,wt)&&St.push(v(ut,Tt,pt,wt));return{features:St}}getFeatures(){return[...this.features.values()]}}function y({minX:ut,minY:pt,maxX:wt,maxY:Tt},St,It,Xt){return ut<(It+1+Lt)/St&&pt<(Xt+1+Lt)/St&&wt>(It-Lt)/St&&Tt>(Xt-Lt)/St}function x(ut){const{id:pt,geometry:wt,properties:Tt}=ut;if(!wt)return;if("GeometryCollection"===wt.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:St,coordinates:It}=wt,Lt={id:pt,type:1,geometry:[],tags:Tt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Xt=Lt.geometry;if("Point"===St)w(It,Xt,Lt);else if("MultiPoint"===St)for(const ut of It)w(ut,Xt,Lt);else if("LineString"===St)Lt.type=2,S(It,Xt,Lt);else if("MultiLineString"===St)Lt.type=2,b(It,Xt,Lt);else if("Polygon"===St)Lt.type=3,b(It,Xt,Lt,!0);else{if("MultiPolygon"!==St)throw new Error("Input data is not a valid GeoJSON object.");Lt.type=3;for(const ut of It)b(ut,Xt,Lt,!0)}return Lt}function w([pt,wt],Tt,St){const It=ut.aj(pt);let Lt=ut.ak(wt);Lt=Lt<0?0:Lt>1?1:Lt,Tt.push(It,Lt),St.minX=Math.min(St.minX,It),St.minY=Math.min(St.minY,Lt),St.maxX=Math.max(St.maxX,It),St.maxY=Math.max(St.maxY,Lt)}function S(ut,pt,wt,Tt=!1,St=!1){const It=[];for(const pt of ut)w(pt,It,wt);pt.push(It),Tt&&function(ut,pt){let wt=0;for(let pt=0,Tt=ut.length,St=Tt-2;pt<Tt;St=pt,pt+=2)wt+=(ut[pt]-ut[St])*(ut[pt+1]+ut[St+1]);if(wt>0===pt)for(let pt=0,wt=ut.length;pt<wt/2;pt+=2){const Tt=ut[pt],St=ut[pt+1];ut[pt]=ut[wt-2-pt],ut[pt+1]=ut[wt-1-pt],ut[wt-2-pt]=Tt,ut[wt-1-pt]=St}}(It,St)}function b(ut,pt,wt,Tt=!1){for(let St=0;St<ut.length;St++)S(ut[St],pt,wt,Tt,0===St)}function v(ut,pt,wt,Tt){const{id:St,type:It,geometry:Lt,tags:Xt}=ut,Yt=[];if(1===It)I(Lt,pt,wt,Tt,Yt);else for(const ut of Lt)Yt.push(I(ut,pt,wt,Tt));return{id:St,type:It,geometry:Yt,tags:Xt}}function I(ut,pt,wt,Tt,St=[]){for(let It=0;It<ut.length;It+=2)St.push(M(ut[It],ut[It+1],pt,wt,Tt));return St}function M(pt,wt,Tt,St,It){return[Math.round(ut.a3*(pt*Tt-St)),Math.round(ut.a3*(wt*Tt-It))]}var Xt={exports:{}},Yt=ut.d$,Mi=ut.d_.VectorTileFeature,vr=_;function _(ut,wt){(this||pt).options=wt||{},(this||pt).features=ut,(this||pt).length=ut.length}function L(ut,wt){(this||pt).id="number"==typeof ut.id?ut.id:void 0,(this||pt).type=ut.type,(this||pt).rawGeometry=1===ut.type?[ut.geometry]:ut.geometry,(this||pt).properties=ut.tags,(this||pt).extent=wt||4096}_.prototype.feature=function(ut){return new L((this||pt).features[ut],(this||pt).options.extent)},L.prototype.loadGeometry=function(){var ut=(this||pt).rawGeometry;(this||pt).geometry=[];for(var wt=0;wt<ut.length;wt++){for(var Tt=ut[wt],St=[],It=0;It<Tt.length;It++)St.push(new Yt(Tt[It][0],Tt[It][1]));(this||pt).geometry.push(St)}return(this||pt).geometry},L.prototype.bbox=function(){(this||pt).geometry||this.loadGeometry();for(var ut=(this||pt).geometry,wt=1/0,Tt=-1/0,St=1/0,It=-1/0,Lt=0;Lt<ut.length;Lt++)for(var Xt=ut[Lt],Yt=0;Yt<Xt.length;Yt++){var Mi=Xt[Yt];wt=Math.min(wt,Mi.x),Tt=Math.max(Tt,Mi.x),St=Math.min(St,Mi.y),It=Math.max(It,Mi.y)}return[wt,St,Tt,It]},L.prototype.toGeoJSON=Mi.prototype.toGeoJSON;var br=ut.e0,Ar=vr;function O(ut){var pt=new br;return function(ut,pt){for(var wt in ut.layers)pt.writeMessage(3,z,ut.layers[wt])}(ut,pt),pt.finish()}function z(ut,pt){var wt;pt.writeVarintField(15,ut.version||1),pt.writeStringField(1,ut.name||""),pt.writeVarintField(5,ut.extent||4096);var Tt={keys:[],values:[],keycache:{},valuecache:{}};for(wt=0;wt<ut.length;wt++)Tt.feature=ut.feature(wt),pt.writeMessage(2,Z,Tt);var St=Tt.keys;for(wt=0;wt<St.length;wt++)pt.writeStringField(3,St[wt]);var It=Tt.values;for(wt=0;wt<It.length;wt++)pt.writeMessage(4,Y,It[wt])}function Z(ut,pt){var wt=ut.feature;void 0!==wt.id&&pt.writeVarintField(1,wt.id),pt.writeMessage(2,E,ut),pt.writeVarintField(3,wt.type),pt.writeMessage(4,X,wt)}function E(ut,pt){var wt=ut.feature,Tt=ut.keys,St=ut.values,It=ut.keycache,Lt=ut.valuecache;for(var Xt in wt.properties){var Yt=wt.properties[Xt],Mi=It[Xt];if(null!==Yt){void 0===Mi&&(Tt.push(Xt),It[Xt]=Mi=Tt.length-1),pt.writeVarint(Mi);var vr=typeof Yt;"string"!==vr&&"boolean"!==vr&&"number"!==vr&&(Yt=JSON.stringify(Yt));var br=vr+":"+Yt,Ar=Lt[br];void 0===Ar&&(St.push(Yt),Lt[br]=Ar=St.length-1),pt.writeVarint(Ar)}}}function A(ut,pt){return(pt<<3)+(7&ut)}function N(ut){return ut<<1^ut>>31}function X(ut,pt){for(var wt=ut.loadGeometry(),Tt=ut.type,St=0,It=0,Lt=wt.length,Xt=0;Xt<Lt;Xt++){var Yt=wt[Xt],Mi=1;1===Tt&&(Mi=Yt.length),pt.writeVarint(A(1,Mi));for(var vr=3===Tt?Yt.length-1:Yt.length,br=0;br<vr;br++){1===br&&1!==Tt&&pt.writeVarint(A(2,vr-1));var Ar=Yt[br].x-St,Vr=Yt[br].y-It;pt.writeVarint(N(Ar)),pt.writeVarint(N(Vr)),St+=Ar,It+=Vr}3===Tt&&pt.writeVarint(A(7,1))}}function Y(ut,pt){var wt=typeof ut;"string"===wt?pt.writeStringField(1,ut):"boolean"===wt?pt.writeBooleanField(7,ut):"number"===wt&&(ut%1!=0?pt.writeDoubleField(3,ut):ut<0?pt.writeSVarintField(6,ut):pt.writeVarintField(5,ut))}Xt.exports=O,Xt.exports.fromVectorTileJs=O,Xt.exports.fromGeojsonVt=function(ut,pt){pt=pt||{};var wt={};for(var Tt in ut)wt[Tt]=new Ar(ut[Tt].features,pt),wt[Tt].name=Tt,wt[Tt].version=pt.version,wt[Tt].extent=pt.extent;return O({layers:wt})},Xt.exports.GeoJSONWrapper=Ar;var Vr=ut.e1(Xt.exports);const nn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ut=>ut},sn=Math.fround||(an=new Float32Array(1),ut=>(an[0]=+ut,an[0]));var an;const ln=3,cn=5,un=6;class ${constructor(ut){this.options=Object.assign(Object.create(nn),ut),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(ut){const{log:pt,minZoom:wt,maxZoom:Tt}=this.options;pt&&console.time("total time");const St=`prepare ${ut.length} points`;pt&&console.time(St),this.points=ut;const It=[];for(let pt=0;pt<ut.length;pt++){const wt=ut[pt];if(!wt.geometry)continue;const[Tt,St]=wt.geometry.coordinates,Lt=sn(K(Tt)),Xt=sn(H(St));It.push(Lt,Xt,1/0,pt,-1,1),this.options.reduce&&It.push(0)}let Lt=this.trees[Tt+1]=this._createTree(It);pt&&console.timeEnd(St);for(let ut=Tt;ut>=wt;ut--){const wt=+Date.now();Lt=this.trees[ut]=this._createTree(this._cluster(Lt,ut)),pt&&console.log("z%d: %d clusters in %dms",ut,Lt.numItems,+Date.now()-wt)}return pt&&console.timeEnd("total time"),this}getClusters(ut,pt){let wt=((ut[0]+180)%360+360)%360-180;const Tt=Math.max(-90,Math.min(90,ut[1]));let St=180===ut[2]?180:((ut[2]+180)%360+360)%360-180;const It=Math.max(-90,Math.min(90,ut[3]));if(ut[2]-ut[0]>=360)wt=-180,St=180;else if(wt>St){const ut=this.getClusters([wt,Tt,180,It],pt),Lt=this.getClusters([-180,Tt,St,It],pt);return ut.concat(Lt)}const Lt=this.trees[this._limitZoom(pt)],Xt=Lt.range(K(wt),H(It),K(St),H(Tt)),Yt=Lt.data,Mi=[];for(const ut of Xt){const pt=this.stride*ut;Mi.push(Yt[pt+cn]>1?U(Yt,pt,this.clusterProps):this.points[Yt[pt+ln]])}return Mi}getChildren(ut){const pt=this._getOriginId(ut),wt=this._getOriginZoom(ut),Tt="No cluster with the specified id.",St=this.trees[wt];if(!St)throw new Error(Tt);const It=St.data;if(pt*this.stride>=It.length)throw new Error(Tt);const Lt=this.options.radius/(this.options.extent*Math.pow(2,wt-1)),Xt=St.within(It[pt*this.stride],It[pt*this.stride+1],Lt),Yt=[];for(const pt of Xt){const wt=pt*this.stride;It[wt+4]===ut&&Yt.push(It[wt+cn]>1?U(It,wt,this.clusterProps):this.points[It[wt+ln]])}if(0===Yt.length)throw new Error(Tt);return Yt}getLeaves(ut,pt,wt){const Tt=[];return this._appendLeaves(Tt,ut,pt=pt||10,wt=wt||0,0),Tt}getTile(ut,pt,wt){const Tt=this.trees[this._limitZoom(ut)],St=Math.pow(2,ut),{extent:It,radius:Lt}=this.options,Xt=Lt/It,Yt=(wt-Xt)/St,Mi=(wt+1+Xt)/St,vr={features:[]};return this._addTileFeatures(Tt.range((pt-Xt)/St,Yt,(pt+1+Xt)/St,Mi),Tt.data,pt,wt,St,vr),0===pt&&this._addTileFeatures(Tt.range(1-Xt/St,Yt,1,Mi),Tt.data,St,wt,St,vr),pt===St-1&&this._addTileFeatures(Tt.range(0,Yt,Xt/St,Mi),Tt.data,-1,wt,St,vr),vr.features.length?vr:null}getClusterExpansionZoom(ut){let pt=this._getOriginZoom(ut)-1;for(;pt<=this.options.maxZoom;){const wt=this.getChildren(ut);if(pt++,1!==wt.length)break;ut=wt[0].properties.cluster_id}return pt}_appendLeaves(ut,pt,wt,Tt,St){const It=this.getChildren(pt);for(const pt of It){const It=pt.properties;if(It&&It.cluster?St+It.point_count<=Tt?St+=It.point_count:St=this._appendLeaves(ut,It.cluster_id,wt,Tt,St):St<Tt?St++:ut.push(pt),ut.length===wt)break}return St}_createTree(pt){const wt=new ut.cK(pt.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ut=0;ut<pt.length;ut+=this.stride)wt.add(pt[ut],pt[ut+1]);return wt.finish(),wt.data=pt,wt}_addTileFeatures(ut,pt,wt,Tt,St,It){for(const Lt of ut){const ut=Lt*this.stride,Xt=pt[ut+cn]>1;let Yt,Mi,vr;if(Xt)Yt=q(pt,ut,this.clusterProps),Mi=pt[ut],vr=pt[ut+1];else{const wt=this.points[pt[ut+ln]];Yt=wt.properties;const[Tt,St]=wt.geometry.coordinates;Mi=K(Tt),vr=H(St)}const br={type:1,geometry:[[Math.round(this.options.extent*(Mi*St-wt)),Math.round(this.options.extent*(vr*St-Tt))]],tags:Yt};let Ar;Ar=Xt||this.options.generateId?pt[ut+ln]:this.points[pt[ut+ln]].id,void 0!==Ar&&(br.id=Ar),It.features.push(br)}}_limitZoom(ut){return Math.max(this.options.minZoom,Math.min(Math.floor(+ut),this.options.maxZoom+1))}_cluster(ut,pt){const{radius:wt,extent:Tt,reduce:St,minPoints:It}=this.options,Lt=wt/(Tt*Math.pow(2,pt)),Xt=ut.data,Yt=[],Mi=this.stride;for(let wt=0;wt<Xt.length;wt+=Mi){if(Xt[wt+2]<=pt)continue;Xt[wt+2]=pt;const Tt=Xt[wt],vr=Xt[wt+1],br=ut.within(Xt[wt],Xt[wt+1],Lt),Ar=Xt[wt+cn];let Vr=Ar;for(const ut of br){const wt=ut*Mi;Xt[wt+2]>pt&&(Vr+=Xt[wt+cn])}if(Vr>Ar&&Vr>=It){let ut,It=Tt*Ar,Lt=vr*Ar,nn=-1;const sn=(wt/Mi<<5)+(pt+1)+this.points.length;for(const Tt of br){const Yt=Tt*Mi;if(Xt[Yt+2]<=pt)continue;Xt[Yt+2]=pt;const vr=Xt[Yt+cn];It+=Xt[Yt]*vr,Lt+=Xt[Yt+1]*vr,Xt[Yt+4]=sn,St&&(ut||(ut=this._map(Xt,wt,!0),nn=this.clusterProps.length,this.clusterProps.push(ut)),St(ut,this._map(Xt,Yt)))}Xt[wt+4]=sn,Yt.push(It/Vr,Lt/Vr,1/0,sn,-1,Vr),St&&Yt.push(nn)}else{for(let ut=0;ut<Mi;ut++)Yt.push(Xt[wt+ut]);if(Vr>1)for(const ut of br){const wt=ut*Mi;if(!(Xt[wt+2]<=pt)){Xt[wt+2]=pt;for(let ut=0;ut<Mi;ut++)Yt.push(Xt[wt+ut])}}}}return Yt}_getOriginId(ut){return ut-this.points.length>>5}_getOriginZoom(ut){return(ut-this.points.length)%32}_map(ut,pt,wt){if(ut[pt+cn]>1){const Tt=this.clusterProps[ut[pt+un]];return wt?Object.assign({},Tt):Tt}const Tt=this.points[ut[pt+ln]].properties,St=this.options.map(Tt);return wt&&St===Tt?Object.assign({},St):St}}function U(ut,pt,wt){return{type:"Feature",id:ut[pt+ln],properties:q(ut,pt,wt),geometry:{type:"Point",coordinates:[(Tt=ut[pt],360*(Tt-.5)),Q(ut[pt+1])]}};var Tt}function q(ut,pt,wt){const Tt=ut[pt+cn],St=Tt>=1e4?`${Math.round(Tt/1e3)}k`:Tt>=1e3?Math.round(Tt/100)/10+"k":Tt,It=ut[pt+un],Lt=-1===It?{}:Object.assign({},wt[It]);return Object.assign(Lt,{cluster:!0,cluster_id:ut[pt+ln],point_count:Tt,point_count_abbreviated:St})}function K(ut){return ut/360+.5}function H(ut){const pt=Math.sin(ut*Math.PI/180),wt=.5-.25*Math.log((1+pt)/(1-pt))/Math.PI;return wt<0?0:wt>1?1:wt}function Q(ut){const pt=(180-360*ut)*Math.PI/180;return 360*Math.atan(Math.exp(pt))/Math.PI-90}function ee(ut,pt,wt,Tt){let St=Tt;const It=pt+(wt-pt>>1);let Lt,Xt=wt-pt;const Yt=ut[pt],Mi=ut[pt+1],vr=ut[wt],br=ut[wt+1];for(let Tt=pt+3;Tt<wt;Tt+=3){const pt=te(ut[Tt],ut[Tt+1],Yt,Mi,vr,br);if(pt>St)Lt=Tt,St=pt;else if(pt===St){const ut=Math.abs(Tt-It);ut<Xt&&(Lt=Tt,Xt=ut)}}St>Tt&&(Lt-pt>3&&ee(ut,pt,Lt,Tt),ut[Lt+2]=St,wt-Lt>3&&ee(ut,Lt,wt,Tt))}function te(ut,pt,wt,Tt,St,It){let Lt=St-wt,Xt=It-Tt;if(0!==Lt||0!==Xt){const Yt=((ut-wt)*Lt+(pt-Tt)*Xt)/(Lt*Lt+Xt*Xt);Yt>1?(wt=St,Tt=It):Yt>0&&(wt+=Lt*Yt,Tt+=Xt*Yt)}return Lt=ut-wt,Xt=pt-Tt,Lt*Lt+Xt*Xt}function se(ut,pt,wt,Tt){const St={id:ut??null,type:pt,geometry:wt,tags:Tt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===pt||"MultiPoint"===pt||"LineString"===pt)oe(St,wt);else if("Polygon"===pt)oe(St,wt[0]);else if("MultiLineString"===pt)for(const ut of wt)oe(St,ut);else if("MultiPolygon"===pt)for(const ut of wt)oe(St,ut[0]);return St}function oe(ut,pt){for(let wt=0;wt<pt.length;wt+=3)ut.minX=Math.min(ut.minX,pt[wt]),ut.minY=Math.min(ut.minY,pt[wt+1]),ut.maxX=Math.max(ut.maxX,pt[wt]),ut.maxY=Math.max(ut.maxY,pt[wt+1])}function ie(ut,pt,wt,Tt){if(!pt.geometry)return;const St=pt.geometry.coordinates;if(St&&0===St.length)return;const It=pt.geometry.type,Lt=Math.pow(wt.tolerance/((1<<wt.maxZoom)*wt.extent),2);let Xt=[],Yt=pt.id;if(wt.promoteId?Yt=pt.properties[wt.promoteId]:wt.generateId&&(Yt=Tt||0),"Point"===It)ne(St,Xt);else if("MultiPoint"===It)for(const ut of St)ne(ut,Xt);else if("LineString"===It)re(St,Xt,Lt,!1);else if("MultiLineString"===It){if(wt.lineMetrics){for(const wt of St)Xt=[],re(wt,Xt,Lt,!1),ut.push(se(Yt,"LineString",Xt,pt.properties));return}ae(St,Xt,Lt,!1)}else if("Polygon"===It)ae(St,Xt,Lt,!0);else{if("MultiPolygon"!==It){if("GeometryCollection"===It){for(const St of pt.geometry.geometries)ie(ut,{id:Yt,geometry:St,properties:pt.properties},wt,Tt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const ut of St){const pt=[];ae(ut,pt,Lt,!0),Xt.push(pt)}}ut.push(se(Yt,It,Xt,pt.properties))}function ne(ut,pt){pt.push(le(ut[0]),ce(ut[1]),0)}function re(ut,pt,wt,Tt){let St,It,Lt=0;for(let wt=0;wt<ut.length;wt++){const Xt=le(ut[wt][0]),Yt=ce(ut[wt][1]);pt.push(Xt,Yt,0),wt>0&&(Lt+=Tt?(St*Yt-Xt*It)/2:Math.sqrt(Math.pow(Xt-St,2)+Math.pow(Yt-It,2))),St=Xt,It=Yt}const Xt=pt.length-3;pt[2]=1,ee(pt,0,Xt,wt),pt[Xt+2]=1,pt.size=Math.abs(Lt),pt.start=0,pt.end=pt.size}function ae(ut,pt,wt,Tt){for(let St=0;St<ut.length;St++){const It=[];re(ut[St],It,wt,Tt),pt.push(It)}}function le(ut){return ut/360+.5}function ce(ut){const pt=Math.sin(ut*Math.PI/180),wt=.5-.25*Math.log((1+pt)/(1-pt))/Math.PI;return wt<0?0:wt>1?1:wt}function he(ut,pt,wt,Tt,St,It,Lt,Xt){if(Tt/=pt,It>=(wt/=pt)&&Lt<Tt)return ut;if(Lt<wt||It>=Tt)return null;const Yt=[];for(const pt of ut){const ut=pt.geometry;let It=pt.type;const Lt=0===St?pt.minX:pt.minY,Mi=0===St?pt.maxX:pt.maxY;if(Lt>=wt&&Mi<Tt){Yt.push(pt);continue}if(Mi<wt||Lt>=Tt)continue;let vr=[];if("Point"===It||"MultiPoint"===It)ue(ut,vr,wt,Tt,St);else if("LineString"===It)de(ut,vr,wt,Tt,St,!1,Xt.lineMetrics);else if("MultiLineString"===It)pe(ut,vr,wt,Tt,St,!1);else if("Polygon"===It)pe(ut,vr,wt,Tt,St,!0);else if("MultiPolygon"===It)for(const pt of ut){const ut=[];pe(pt,ut,wt,Tt,St,!0),ut.length&&vr.push(ut)}if(vr.length){if(Xt.lineMetrics&&"LineString"===It){for(const ut of vr)Yt.push(se(pt.id,It,ut,pt.tags));continue}"LineString"!==It&&"MultiLineString"!==It||(1===vr.length?(It="LineString",vr=vr[0]):It="MultiLineString"),"Point"!==It&&"MultiPoint"!==It||(It=3===vr.length?"Point":"MultiPoint"),Yt.push(se(pt.id,It,vr,pt.tags))}}return Yt.length?Yt:null}function ue(ut,pt,wt,Tt,St){for(let It=0;It<ut.length;It+=3){const Lt=ut[It+St];Lt>=wt&&Lt<=Tt&&ge(pt,ut[It],ut[It+1],ut[It+2])}}function de(ut,pt,wt,Tt,St,It,Lt){let Xt=fe(ut);const Yt=0===St?me:ye;let Mi,vr,br=ut.start;for(let Ar=0;Ar<ut.length-3;Ar+=3){const Vr=ut[Ar],nn=ut[Ar+1],sn=ut[Ar+2],an=ut[Ar+3],ln=ut[Ar+4],cn=0===St?Vr:nn,un=0===St?an:ln;let fn=!1;Lt&&(Mi=Math.sqrt(Math.pow(Vr-an,2)+Math.pow(nn-ln,2))),cn<wt?un>wt&&(vr=Yt(Xt,Vr,nn,an,ln,wt),Lt&&(Xt.start=br+Mi*vr)):cn>Tt?un<Tt&&(vr=Yt(Xt,Vr,nn,an,ln,Tt),Lt&&(Xt.start=br+Mi*vr)):ge(Xt,Vr,nn,sn),un<wt&&cn>=wt&&(vr=Yt(Xt,Vr,nn,an,ln,wt),fn=!0),un>Tt&&cn<=Tt&&(vr=Yt(Xt,Vr,nn,an,ln,Tt),fn=!0),!It&&fn&&(Lt&&(Xt.end=br+Mi*vr),pt.push(Xt),Xt=fe(ut)),Lt&&(br+=Mi)}let Ar=ut.length-3;const Vr=ut[Ar],nn=ut[Ar+1],sn=0===St?Vr:nn;sn>=wt&&sn<=Tt&&ge(Xt,Vr,nn,ut[Ar+2]),Ar=Xt.length-3,It&&Ar>=3&&(Xt[Ar]!==Xt[0]||Xt[Ar+1]!==Xt[1])&&ge(Xt,Xt[0],Xt[1],Xt[2]),Xt.length&&pt.push(Xt)}function fe(ut){const pt=[];return pt.size=ut.size,pt.start=ut.start,pt.end=ut.end,pt}function pe(ut,pt,wt,Tt,St,It){for(const Lt of ut)de(Lt,pt,wt,Tt,St,It,!1)}function ge(ut,pt,wt,Tt){ut.push(pt,wt,Tt)}function me(ut,pt,wt,Tt,St,It){const Lt=(It-pt)/(Tt-pt);return ge(ut,It,wt+(St-wt)*Lt,1),Lt}function ye(ut,pt,wt,Tt,St,It){const Lt=(It-wt)/(St-wt);return ge(ut,pt+(Tt-pt)*Lt,It,1),Lt}function xe(ut,pt){const wt=[];for(let Tt=0;Tt<ut.length;Tt++){const St=ut[Tt],It=St.type;let Lt;if("Point"===It||"MultiPoint"===It||"LineString"===It)Lt=we(St.geometry,pt);else if("MultiLineString"===It||"Polygon"===It){Lt=[];for(const ut of St.geometry)Lt.push(we(ut,pt))}else if("MultiPolygon"===It){Lt=[];for(const ut of St.geometry){const wt=[];for(const Tt of ut)wt.push(we(Tt,pt));Lt.push(wt)}}wt.push(se(St.id,It,Lt,St.tags))}return wt}function we(ut,pt){const wt=[];wt.size=ut.size,void 0!==ut.start&&(wt.start=ut.start,wt.end=ut.end);for(let Tt=0;Tt<ut.length;Tt+=3)wt.push(ut[Tt]+pt,ut[Tt+1],ut[Tt+2]);return wt}function Se(ut,pt){if(ut.transformed)return ut;const wt=1<<ut.z,Tt=ut.x,St=ut.y;for(const It of ut.features){const ut=It.geometry,Lt=It.type;if(It.geometry=[],1===Lt)for(let Lt=0;Lt<ut.length;Lt+=2)It.geometry.push(be(ut[Lt],ut[Lt+1],pt,wt,Tt,St));else for(let Lt=0;Lt<ut.length;Lt++){const Xt=[];for(let It=0;It<ut[Lt].length;It+=2)Xt.push(be(ut[Lt][It],ut[Lt][It+1],pt,wt,Tt,St));It.geometry.push(Xt)}}return ut.transformed=!0,ut}function be(ut,pt,wt,Tt,St,It){return[Math.round(wt*(ut*Tt-St)),Math.round(wt*(pt*Tt-It))]}function ve(ut,pt,wt,Tt,St){const It=pt===St.maxZoom?0:St.tolerance/((1<<pt)*St.extent),Lt={features:[],numPoints:0,numSimplified:0,numFeatures:ut.length,source:null,x:wt,y:Tt,z:pt,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const pt of ut)Ie(Lt,pt,It,St);return Lt}function Ie(ut,pt,wt,Tt){const St=pt.geometry,It=pt.type,Lt=[];if(ut.minX=Math.min(ut.minX,pt.minX),ut.minY=Math.min(ut.minY,pt.minY),ut.maxX=Math.max(ut.maxX,pt.maxX),ut.maxY=Math.max(ut.maxY,pt.maxY),"Point"===It||"MultiPoint"===It)for(let pt=0;pt<St.length;pt+=3)Lt.push(St[pt],St[pt+1]),ut.numPoints++,ut.numSimplified++;else if("LineString"===It)Me(Lt,St,ut,wt,!1,!1);else if("MultiLineString"===It||"Polygon"===It)for(let pt=0;pt<St.length;pt++)Me(Lt,St[pt],ut,wt,"Polygon"===It,0===pt);else if("MultiPolygon"===It)for(let pt=0;pt<St.length;pt++){const Tt=St[pt];for(let pt=0;pt<Tt.length;pt++)Me(Lt,Tt[pt],ut,wt,!0,0===pt)}if(Lt.length){let wt=pt.tags||null;if("LineString"===It&&Tt.lineMetrics){wt={};for(const ut in pt.tags)wt[ut]=pt.tags[ut];wt.mapbox_clip_start=St.start/St.size,wt.mapbox_clip_end=St.end/St.size}const Xt={geometry:Lt,type:"Polygon"===It||"MultiPolygon"===It?3:"LineString"===It||"MultiLineString"===It?2:1,tags:wt};null!==pt.id&&(Xt.id=pt.id),ut.features.push(Xt)}}function Me(ut,pt,wt,Tt,St,It){const Lt=Tt*Tt;if(Tt>0&&pt.size<(St?Lt:Tt))return void(wt.numPoints+=pt.length/3);const Xt=[];for(let ut=0;ut<pt.length;ut+=3)(0===Tt||pt[ut+2]>Lt)&&(wt.numSimplified++,Xt.push(pt[ut],pt[ut+1])),wt.numPoints++;St&&function(ut,pt){let wt=0;for(let pt=0,Tt=ut.length,St=Tt-2;pt<Tt;St=pt,pt+=2)wt+=(ut[pt]-ut[St])*(ut[pt+1]+ut[St+1]);if(wt>0===pt)for(let pt=0,wt=ut.length;pt<wt/2;pt+=2){const Tt=ut[pt],St=ut[pt+1];ut[pt]=ut[wt-2-pt],ut[pt+1]=ut[wt-1-pt],ut[wt-2-pt]=Tt,ut[wt-1-pt]=St}}(Xt,It),ut.push(Xt)}const fn={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Te{constructor(ut,pt){const wt=(pt=this.options=function(ut,pt){for(const wt in pt)ut[wt]=pt[wt];return ut}(Object.create(fn),pt)).debug;if(wt&&console.time("preprocess data"),pt.maxZoom<0||pt.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(pt.promoteId&&pt.generateId)throw new Error("promoteId and generateId cannot be used together.");let Tt=function(ut,pt){const wt=[];if("FeatureCollection"===ut.type)for(let Tt=0;Tt<ut.features.length;Tt++)ie(wt,ut.features[Tt],pt,Tt);else ie(wt,"Feature"===ut.type?ut:{geometry:ut},pt);return wt}(ut,pt);this.tiles={},this.tileCoords=[],wt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",pt.indexMaxZoom,pt.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Tt=function(ut,pt){const wt=pt.buffer/pt.extent;let Tt=ut;const St=he(ut,1,-1-wt,wt,0,-1,2,pt),It=he(ut,1,1-wt,2+wt,0,-1,2,pt);return(St||It)&&(Tt=he(ut,1,-wt,1+wt,0,-1,2,pt)||[],St&&(Tt=xe(St,1).concat(Tt)),It&&(Tt=Tt.concat(xe(It,-1)))),Tt}(Tt,pt),Tt.length&&this.splitTile(Tt,0,0,0),wt&&(Tt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(ut,pt,wt,Tt,St,It,Lt){const Xt=[ut,pt,wt,Tt],Yt=this.options,Mi=Yt.debug;for(;Xt.length;){Tt=Xt.pop(),wt=Xt.pop(),pt=Xt.pop(),ut=Xt.pop();const vr=1<<pt,br=Pe(pt,wt,Tt);let Ar=this.tiles[br];if(!Ar&&(Mi>1&&console.time("creation"),Ar=this.tiles[br]=ve(ut,pt,wt,Tt,Yt),this.tileCoords.push({z:pt,x:wt,y:Tt}),Mi)){Mi>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",pt,wt,Tt,Ar.numFeatures,Ar.numPoints,Ar.numSimplified),console.timeEnd("creation"));const ut=`z${pt}`;this.stats[ut]=(this.stats[ut]||0)+1,this.total++}if(Ar.source=ut,null==St){if(pt===Yt.indexMaxZoom||Ar.numPoints<=Yt.indexMaxPoints)continue}else{if(pt===Yt.maxZoom||pt===St)continue;if(null!=St){const ut=St-pt;if(wt!==It>>ut||Tt!==Lt>>ut)continue}}if(Ar.source=null,0===ut.length)continue;Mi>1&&console.time("clipping");const Vr=.5*Yt.buffer/Yt.extent,nn=.5-Vr,sn=.5+Vr,an=1+Vr;let ln=null,cn=null,un=null,fn=null,_n=he(ut,vr,wt-Vr,wt+sn,0,Ar.minX,Ar.maxX,Yt),gn=he(ut,vr,wt+nn,wt+an,0,Ar.minX,Ar.maxX,Yt);ut=null,_n&&(ln=he(_n,vr,Tt-Vr,Tt+sn,1,Ar.minY,Ar.maxY,Yt),cn=he(_n,vr,Tt+nn,Tt+an,1,Ar.minY,Ar.maxY,Yt),_n=null),gn&&(un=he(gn,vr,Tt-Vr,Tt+sn,1,Ar.minY,Ar.maxY,Yt),fn=he(gn,vr,Tt+nn,Tt+an,1,Ar.minY,Ar.maxY,Yt),gn=null),Mi>1&&console.timeEnd("clipping"),Xt.push(ln||[],pt+1,2*wt,2*Tt),Xt.push(cn||[],pt+1,2*wt,2*Tt+1),Xt.push(un||[],pt+1,2*wt+1,2*Tt),Xt.push(fn||[],pt+1,2*wt+1,2*Tt+1)}}getTile(ut,pt,wt){ut=+ut,pt=+pt,wt=+wt;const Tt=this.options,{extent:St,debug:It}=Tt;if(ut<0||ut>24)return null;const Lt=1<<ut,Xt=Pe(ut,pt=pt+Lt&Lt-1,wt);if(this.tiles[Xt])return Se(this.tiles[Xt],St);It>1&&console.log("drilling down to z%d-%d-%d",ut,pt,wt);let Yt,Mi=ut,vr=pt,br=wt;for(;!Yt&&Mi>0;)Mi--,vr>>=1,br>>=1,Yt=this.tiles[Pe(Mi,vr,br)];return Yt&&Yt.source?(It>1&&(console.log("found parent tile z%d-%d-%d",Mi,vr,br),console.time("drilling down")),this.splitTile(Yt.source,Mi,vr,br,ut,pt,wt),It>1&&console.timeEnd("drilling down"),this.tiles[Xt]?Se(this.tiles[Xt],St):null):null}}function Pe(ut,pt,wt){return 32*((1<<ut)*wt+pt)+ut}function Ce(ut,wt){const Tt=ut.tileID.canonical;if(!(this||pt)._geoJSONIndex)return wt(null,null);const St=(this||pt)._geoJSONIndex.getTile(Tt.z,Tt.x,Tt.y);if(!St)return wt(null,null);const Lt=new It(St.features);let Xt=Vr(Lt);0===Xt.byteOffset&&Xt.byteLength===Xt.buffer.byteLength||(Xt=new Uint8Array(Xt)),wt(null,{vectorTile:Lt,rawData:Xt.buffer})}class _e extends c{constructor(ut,pt,wt,Tt,St,It){super(ut,pt,wt,Tt,Ce,It),St&&(this.loadGeoJSON=St),this._dynamicIndex=new m}loadData(pt,wt){const Tt=pt&&pt.request,St=Tt&&Tt.collectResourceTiming;this.loadGeoJSON(pt,((It,Lt)=>{if(It||!Lt)return wt(It);if("object"!=typeof Lt)return wt(new Error(`Input data given to '${pt.source}' is not a valid GeoJSON object.`));{try{if(pt.filter){const wt=ut.y(pt.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===wt.result)throw new Error(wt.value.map((ut=>`${ut.key}: ${ut.message}`)).join(", "));Lt.features=Lt.features.filter((ut=>wt.value.evaluate({zoom:0},ut)))}pt.dynamic?("Feature"===Lt.type&&(Lt={type:"FeatureCollection",features:[Lt]}),pt.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Lt.features,this.loaded),pt.cluster&&(Lt.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=pt.cluster?new $(function({superclusterOptions:pt,clusterProperties:wt}){if(!wt||!pt)return pt;const Tt={},St={},It={accumulated:null,zoom:0},Lt={properties:null},Xt=Object.keys(wt);for(const pt of Xt){const[It,Lt]=wt[pt],Xt=ut.y(Lt),Yt=ut.y("string"==typeof It?[It,["accumulated"],["get",pt]]:It);Tt[pt]=Xt.value,St[pt]=Yt.value}return pt.map=ut=>{Lt.properties=ut;const pt={};for(const ut of Xt)pt[ut]=Tt[ut].evaluate(It,Lt);return pt},pt.reduce=(ut,pt)=>{Lt.properties=pt;for(const pt of Xt)It.accumulated=ut[pt],ut[pt]=St[pt].evaluate(It,Lt)},pt}(pt)).load(Lt.features):pt.dynamic?this._dynamicIndex:function(ut,pt){return new Te(ut,pt)}(Lt,pt.geojsonVtOptions)}catch(ut){return wt(ut)}const It={};if(St){const ut=t(Tt);ut&&(It.resourceTiming={},It.resourceTiming[pt.source]=JSON.parse(JSON.stringify(ut)))}wt(null,It)}}))}reloadTile(ut,pt){const wt=this.loaded;return wt&&wt[ut.uid]?ut.partial?pt(null,void 0):super.reloadTile(ut,pt):this.loadTile(ut,pt)}loadGeoJSON(pt,wt){if(pt.request)ut.g(pt.request,wt);else{if("string"!=typeof pt.data)return wt(new Error(`Input data given to '${pt.source}' is not a valid GeoJSON object.`));try{return wt(null,JSON.parse(pt.data))}catch(ut){return wt(new Error(`Input data given to '${pt.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(ut,pt){try{pt(null,this._geoJSONIndex.getClusterExpansionZoom(ut.clusterId))}catch(ut){pt(ut)}}getClusterChildren(ut,pt){try{pt(null,this._geoJSONIndex.getChildren(ut.clusterId))}catch(ut){pt(ut)}}getClusterLeaves(ut,pt){try{pt(null,this._geoJSONIndex.getLeaves(ut.clusterId,ut.limit,ut.offset))}catch(ut){pt(ut)}}}class Le{constructor(pt,wt){this.tileID=new ut.aL(pt.tileID.overscaledZ,pt.tileID.wrap,pt.tileID.canonical.z,pt.tileID.canonical.x,pt.tileID.canonical.y),this.tileZoom=pt.tileZoom,this.uid=pt.uid,this.zoom=pt.zoom,this.canonical=pt.tileID.canonical,this.pixelRatio=pt.pixelRatio,this.tileSize=pt.tileSize,this.source=pt.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=pt.projection,this.brightness=wt}parse(pt,wt,Tt,St){this.status="parsing";const It=new ut.aL(Tt.tileID.overscaledZ,Tt.tileID.wrap,Tt.tileID.canonical.z,Tt.tileID.canonical.x,Tt.tileID.canonical.y),Lt={},Xt=wt.familiesBySource[Tt.source],Yt=new ut.dN(It,Tt.promoteId);return Yt.bucketLayerIDs=[],Yt.is3DTile=!0,ut.e3(pt).then((pt=>{if(!pt)return St(new Error("Could not parse tile"));const wt=ut.e4(pt,1/ut.b5(Tt.tileID.canonical)),Mi=pt.json.extensionsUsed&&pt.json.extensionsUsed.includes("MAPBOX_mesh_features")||pt.json.asset.extras&&pt.json.asset.extras.MAPBOX_mesh_features,vr=pt.json.extensionsUsed&&pt.json.extensionsUsed.includes("EXT_meshopt_compression"),br=new ut.X(this.zoom,{brightness:this.brightness});for(const pt in Xt)for(const Tt of Xt[pt]){const pt=Tt[0];Yt.bucketLayerIDs.push(Tt.map((ut=>ut.id))),pt.recalculate(br,[]);const St=new ut.e5(wt,It,Mi,vr,this.brightness,Yt);Mi||(St.needsUpload=!0),Lt[pt.fqid]=St,St.evaluate(pt)}this.status="done",St(null,{buckets:Lt,featureIndex:Yt})})).catch((ut=>St(new Error(ut.message))))}}class De{constructor(ut,pt,wt,Tt,St,It){this.actor=ut,this.layerIndex=pt,this.brightness=It,this.loading={},this.loaded={}}loadTile(pt,wt){const Tt=pt.uid,St=this.loading[Tt]=new Le(pt,this.brightness);ut.e2(pt.request,((ut,It)=>{const Lt=!this.loading[Tt];return delete this.loading[Tt],Lt||ut?(St.status="done",Lt||(this.loaded[Tt]=St),wt(ut)):It&&0!==It.byteLength?void St.parse(It,this.layerIndex,pt,((ut,pt)=>{St.status="done",this.loaded=this.loaded||{},this.loaded[Tt]=St,ut||!pt?wt(ut):wt(null,pt)})):(St.status="done",this.loaded[Tt]=St,wt())}))}reloadTile(ut,pt){const wt=this.loaded,Tt=ut.uid;if(wt&&wt[Tt]){const St=wt[Tt];St.projection=ut.projection,St.brightness=ut.brightness;const n=(wt,Tt)=>{St.reloadCallback&&(delete St.reloadCallback,this.loadTile(ut,pt)),pt(wt,Tt)};"parsing"===St.status?St.reloadCallback=n:"done"===St.status&&this.loadTile(ut,pt)}}abortTile(ut,pt){const wt=ut.uid;this.loading[wt]&&delete this.loading[wt],pt()}removeTile(ut,pt){const wt=this.loaded,Tt=ut.uid;wt&&wt[Tt]&&delete wt[Tt],pt()}}class je{constructor(pt){this.self=pt,this.actor=new ut.e6(pt,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=ut.aJ({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:_e,"batched-model":De},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(ut,pt)=>{if(this.workerSourceTypes[ut])throw new Error(`Worker source with name "${ut}" already registered.`);this.workerSourceTypes[ut]=pt},this.self.registerRTLTextPlugin=pt=>{if(ut.e7.isParsed())throw new Error("RTL text plugin already registered.");ut.e7.applyArabicShaping=pt.applyArabicShaping,ut.e7.processBidirectionalText=pt.processBidirectionalText,ut.e7.processStyledBidirectionalText=pt.processStyledBidirectionalText}}clearCaches(ut,pt,wt){delete this.layerIndexes[ut],delete this.availableImages[ut],delete this.workerSources[ut],delete this.demWorkerSources[ut],delete this.rasterArrayWorkerSource,wt()}checkIfReady(ut,pt,wt){wt()}setReferrer(ut,pt){this.referrer=pt}spriteLoaded(pt,{scope:wt,isLoaded:Tt}){if(this.isSpriteLoaded[pt]||(this.isSpriteLoaded[pt]={}),this.isSpriteLoaded[pt][wt]=Tt,this.workerSources[pt]&&this.workerSources[pt][wt])for(const St in this.workerSources[pt][wt]){const It=this.workerSources[pt][wt][St];for(const pt in It){const wt=It[pt];wt instanceof c&&(wt.isSpriteLoaded=Tt,wt.fire(new ut.f("isSpriteLoaded")))}}}setImages(ut,{scope:pt,images:wt},Tt){if(this.availableImages[ut]||(this.availableImages[ut]={}),this.availableImages[ut][pt]=wt,this.workerSources[ut]&&this.workerSources[ut][pt]){for(const Tt in this.workerSources[ut][pt]){const St=this.workerSources[ut][pt][Tt];for(const ut in St)St[ut].availableImages=wt}Tt()}else Tt()}setProjection(pt,wt){this.projections[pt]=ut.aJ(wt)}setBrightness(ut,pt,wt){this.brightness=pt,wt()}setLayers(ut,pt,wt){this.getLayerIndex(ut,pt.scope).replace(pt.layers,pt.options),wt()}updateLayers(ut,pt,wt){this.getLayerIndex(ut,pt.scope).update(pt.layers,pt.removedIds,pt.options),wt()}loadTile(ut,pt,wt){pt.projection=this.projections[ut]||this.defaultProjection,this.getWorkerSource(ut,pt.type,pt.source,pt.scope).loadTile(pt,wt)}loadDEMTile(ut,pt,wt){this.getDEMWorkerSource(ut,pt.source,pt.scope).loadTile(pt,wt)}decodeRasterArray(ut,pt,wt){this.getRasterArrayWorkerSource().decodeRasterArray(pt,wt)}reloadTile(ut,pt,wt){pt.projection=this.projections[ut]||this.defaultProjection,this.getWorkerSource(ut,pt.type,pt.source,pt.scope).reloadTile(pt,wt)}abortTile(ut,pt,wt){this.getWorkerSource(ut,pt.type,pt.source,pt.scope).abortTile(pt,wt)}removeTile(ut,pt,wt){this.getWorkerSource(ut,pt.type,pt.source,pt.scope).removeTile(pt,wt)}removeSource(ut,pt,wt){if(!(this.workerSources[ut]&&this.workerSources[ut][pt.scope]&&this.workerSources[ut][pt.scope][pt.type]&&this.workerSources[ut][pt.scope][pt.type][pt.source]))return;const Tt=this.workerSources[ut][pt.scope][pt.type][pt.source];delete this.workerSources[ut][pt.scope][pt.type][pt.source],void 0!==Tt.removeSource?Tt.removeSource(pt,wt):wt()}loadWorkerSource(ut,pt,wt){try{this.self.importScripts(pt.url),wt()}catch(ut){wt(ut.toString())}}syncRTLPluginState(pt,wt,Tt){try{ut.e7.setState(wt);const pt=ut.e7.getPluginURL();if(ut.e7.isLoaded()&&!ut.e7.isParsed()&&null!=pt){this.self.importScripts(pt);const wt=ut.e7.isParsed();Tt(wt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${pt}`),wt)}}catch(ut){Tt(ut.toString())}}setDracoUrl(ut,pt){this.dracoUrl=pt}getAvailableImages(ut,pt){this.availableImages[ut]||(this.availableImages[ut]={});let wt=this.availableImages[ut][pt];return wt||(wt=[]),wt}getLayerIndex(ut,pt){this.layerIndexes[ut]||(this.layerIndexes[ut]={});let wt=this.layerIndexes[ut][pt];return wt||(wt=this.layerIndexes[ut][pt]=new i,wt.scope=pt),wt}getWorkerSource(ut,pt,wt,Tt){return this.workerSources[ut]||(this.workerSources[ut]={}),this.workerSources[ut][Tt]||(this.workerSources[ut][Tt]={}),this.workerSources[ut][Tt][pt]||(this.workerSources[ut][Tt][pt]={}),this.isSpriteLoaded[ut]||(this.isSpriteLoaded[ut]={}),this.workerSources[ut][Tt][pt][wt]||(this.workerSources[ut][Tt][pt][wt]=new this.workerSourceTypes[pt]({send:(pt,wt,Tt,St,It,Lt)=>{this.actor.send(pt,wt,Tt,ut,It,Lt)},scheduler:this.actor.scheduler},this.getLayerIndex(ut,Tt),this.getAvailableImages(ut,Tt),this.isSpriteLoaded[ut][Tt],void 0,this.brightness)),this.workerSources[ut][Tt][pt][wt]}getDEMWorkerSource(ut,pt,wt){return this.demWorkerSources[ut]||(this.demWorkerSources[ut]={}),this.demWorkerSources[ut][wt]||(this.demWorkerSources[ut][wt]={}),this.demWorkerSources[ut][wt][pt]||(this.demWorkerSources[ut][wt][pt]=new h),this.demWorkerSources[ut][wt][pt]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new u),this.rasterArrayWorkerSource}enforceCacheSizeLimit(pt,wt){ut.e8(wt)}getWorkerPerformanceMetrics(ut,pt,wt){wt(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new je(self)),je}));define(["./shared"],(function(ut){function t(ut,pt){if(Array.isArray(ut)){if(!Array.isArray(pt)||ut.length!==pt.length)return!1;for(let wt=0;wt<ut.length;wt++)if(!t(ut[wt],pt[wt]))return!1;return!0}if("object"==typeof ut&&null!==ut&&null!==pt){if("object"!=typeof pt)return!1;if(Object.keys(ut).length!==Object.keys(pt).length)return!1;for(const wt in ut)if(!t(ut[wt],pt[wt]))return!1;return!0}return ut===pt}var pt=o;function o(ut){return!function(ut){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var ut,pt,wt=new Blob([""],{type:"text/javascript"}),Tt=URL.createObjectURL(wt);try{pt=new Worker(Tt),ut=!0}catch(pt){ut=!1}return pt&&pt.terminate(),URL.revokeObjectURL(Tt),ut}()?function(){var ut=document.createElement("canvas");ut.width=ut.height=1;var pt=ut.getContext("2d");if(!pt)return!1;var wt=pt.getImageData(0,0,1,1);return wt&&wt.width===ut.width}()?(void 0===wt[pt=ut&&ut.failIfMajorPerformanceCaveat]&&(wt[pt]=function(ut){var pt,wt=function(ut){var pt=document.createElement("canvas"),wt=Object.create(o.webGLContextAttributes);return wt.failIfMajorPerformanceCaveat=ut,pt.getContext("webgl2",wt)}(ut);if(!wt)return!1;try{pt=wt.createShader(wt.VERTEX_SHADER)}catch(ut){return!1}return!(!pt||wt.isContextLost())&&(wt.shaderSource(pt,"void main() {}"),wt.compileShader(pt),!0===wt.getShaderParameter(pt,wt.COMPILE_STATUS))}(pt)),wt[pt]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var pt}(ut)}var wt={};function a(ut,pt,wt){const Tt=document.createElement(ut);return null!=pt&&(Tt.className=pt),wt&&wt.appendChild(Tt),Tt}function s(ut,pt,wt){const Tt=document.createElementNS("http://www.w3.org/2000/svg",ut);for(const ut of Object.keys(pt))Tt.setAttributeNS(null,ut,String(pt[ut]));return wt&&wt.appendChild(Tt),Tt}o.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const Tt="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,St=Tt&&void 0!==Tt.userSelect?"userSelect":"WebkitUserSelect";let It;function h(){Tt&&St&&(It=Tt[St],Tt[St]="none")}function u(){Tt&&St&&(Tt[St]=It)}function _(ut){ut.preventDefault(),ut.stopPropagation(),window.removeEventListener("click",_,!0)}function d(){window.addEventListener("click",_,!0),window.setTimeout((()=>{window.removeEventListener("click",_,!0)}),0)}function p(ut,pt){const wt=ut.getBoundingClientRect();return g(ut,wt,pt)}function f(ut,pt){const wt=ut.getBoundingClientRect(),Tt=[];for(let St=0;St<pt.length;St++)Tt.push(g(ut,wt,pt[St]));return Tt}function m(ut){return void 0!==window.InstallTrigger&&2===ut.button&&ut.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:ut.button}function g(pt,wt,Tt){const St=pt.offsetWidth===wt.width?1:pt.offsetWidth/wt.width;return new ut.P((Tt.clientX-wt.left)*St,(Tt.clientY-wt.top)*St)}class v{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(ut,pt){this._updatedSourceCaches[ut]=pt,this.setDirty()}discardSourceCacheUpdate(ut){delete this._updatedSourceCaches[ut]}updateLayer(ut){const pt=ut.scope;this._updatedLayers[pt]=this._updatedLayers[pt]||new Set,this._updatedLayers[pt].add(ut.id),this.setDirty()}removeLayer(ut){const pt=ut.scope;this._removedLayers[pt]=this._removedLayers[pt]||{},this._updatedLayers[pt]=this._updatedLayers[pt]||new Set,this._removedLayers[pt][ut.id]=ut,this._updatedLayers[pt].delete(ut.id),this._updatedPaintProps.delete(ut.fqid),this.setDirty()}getRemovedLayer(ut){return this._removedLayers[ut.scope]?this._removedLayers[ut.scope][ut.id]:null}discardLayerRemoval(ut){this._removedLayers[ut.scope]&&delete this._removedLayers[ut.scope][ut.id]}getLayerUpdatesByScope(){const ut={};for(const pt in this._updatedLayers)ut[pt]=ut[pt]||{},ut[pt].updatedIds=Array.from(this._updatedLayers[pt].values());for(const pt in this._removedLayers)ut[pt]=ut[pt]||{},ut[pt].removedIds=Object.keys(this._removedLayers[pt]);return ut}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(ut){this._updatedPaintProps.add(ut.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(ut){this._updatedImages.add(ut),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const Lt={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class y{constructor(ut,pt,wt,Tt,St,It){this.length=pt.length,this.attributes=wt,this.itemSize=pt.bytesPerElement,this.dynamicDraw=Tt,this.instanceCount=It,this.context=ut;const Lt=ut.gl;this.buffer=Lt.createBuffer(),ut.bindVertexBuffer.set(this.buffer),Lt.bufferData(Lt.ARRAY_BUFFER,pt.arrayBuffer,this.dynamicDraw?Lt.DYNAMIC_DRAW:Lt.STATIC_DRAW),this.dynamicDraw||St||pt.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(ut){const pt=this.context.gl;this.bind(),pt.bufferSubData(pt.ARRAY_BUFFER,0,ut.arrayBuffer)}enableAttributes(ut,pt){for(let wt=0;wt<this.attributes.length;wt++){const Tt=pt.attributes[this.attributes[wt].name];void 0!==Tt&&ut.enableVertexAttribArray(Tt)}}setVertexAttribPointers(ut,pt,wt){for(let Tt=0;Tt<this.attributes.length;Tt++){const St=this.attributes[Tt],It=pt.attributes[St.name];void 0!==It&&ut.vertexAttribPointer(It,St.components,ut[Lt[St.type]],!1,this.itemSize,St.offset+this.itemSize*(wt||0))}}setVertexAttribDivisor(ut,pt,wt){for(let Tt=0;Tt<this.attributes.length;Tt++){const St=pt.attributes[this.attributes[Tt].name];void 0!==St&&this.instanceCount&&this.instanceCount>0&&ut.vertexAttribDivisor(St,wt)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class b{constructor(ut){this.gl=ut.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(ut){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class w extends b{getDefault(){return ut.C.transparent}set(ut){const pt=this.current;(ut.r!==pt.r||ut.g!==pt.g||ut.b!==pt.b||ut.a!==pt.a||this.dirty)&&(this.gl.clearColor(ut.r,ut.g,ut.b,ut.a),this.current=ut,this.dirty=!1)}}class T extends b{getDefault(){return 1}set(ut){(ut!==this.current||this.dirty)&&(this.gl.clearDepth(ut),this.current=ut,this.dirty=!1)}}class E extends b{getDefault(){return 0}set(ut){(ut!==this.current||this.dirty)&&(this.gl.clearStencil(ut),this.current=ut,this.dirty=!1)}}class C extends b{getDefault(){return[!0,!0,!0,!0]}set(ut){const pt=this.current;(ut[0]!==pt[0]||ut[1]!==pt[1]||ut[2]!==pt[2]||ut[3]!==pt[3]||this.dirty)&&(this.gl.colorMask(ut[0],ut[1],ut[2],ut[3]),this.current=ut,this.dirty=!1)}}class S extends b{getDefault(){return!0}set(ut){(ut!==this.current||this.dirty)&&(this.gl.depthMask(ut),this.current=ut,this.dirty=!1)}}class I extends b{getDefault(){return 255}set(ut){(ut!==this.current||this.dirty)&&(this.gl.stencilMask(ut),this.current=ut,this.dirty=!1)}}class L extends b{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(ut){const pt=this.current;(ut.func!==pt.func||ut.ref!==pt.ref||ut.mask!==pt.mask||this.dirty)&&(this.gl.stencilFunc(ut.func,ut.ref,ut.mask),this.current=ut,this.dirty=!1)}}class P extends b{getDefault(){const ut=this.gl;return[ut.KEEP,ut.KEEP,ut.KEEP]}set(ut){const pt=this.current;(ut[0]!==pt[0]||ut[1]!==pt[1]||ut[2]!==pt[2]||this.dirty)&&(this.gl.stencilOp(ut[0],ut[1],ut[2]),this.current=ut,this.dirty=!1)}}class A extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;ut?pt.enable(pt.STENCIL_TEST):pt.disable(pt.STENCIL_TEST),this.current=ut,this.dirty=!1}}class R extends b{getDefault(){return[0,1]}set(ut){const pt=this.current;(ut[0]!==pt[0]||ut[1]!==pt[1]||this.dirty)&&(this.gl.depthRange(ut[0],ut[1]),this.current=ut,this.dirty=!1)}}class D extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;ut?pt.enable(pt.DEPTH_TEST):pt.disable(pt.DEPTH_TEST),this.current=ut,this.dirty=!1}}class M extends b{getDefault(){return this.gl.LESS}set(ut){(ut!==this.current||this.dirty)&&(this.gl.depthFunc(ut),this.current=ut,this.dirty=!1)}}class z extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;ut?pt.enable(pt.BLEND):pt.disable(pt.BLEND),this.current=ut,this.dirty=!1}}class O extends b{getDefault(){const ut=this.gl;return[ut.ONE,ut.ZERO,ut.ONE,ut.ZERO]}set(ut){const pt=this.current;(ut[0]!==pt[0]||ut[1]!==pt[1]||ut[2]!==pt[2]||ut[3]!==pt[3]||this.dirty)&&(this.gl.blendFuncSeparate(ut[0],ut[1],ut[2],ut[3]),this.current=ut,this.dirty=!1)}}class F extends b{getDefault(){return ut.C.transparent}set(ut){const pt=this.current;(ut.r!==pt.r||ut.g!==pt.g||ut.b!==pt.b||ut.a!==pt.a||this.dirty)&&(this.gl.blendColor(ut.r,ut.g,ut.b,ut.a),this.current=ut,this.dirty=!1)}}class B extends b{getDefault(){return this.gl.FUNC_ADD}set(ut){(ut!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(ut,ut),this.current=ut,this.dirty=!1)}}class k extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;ut?pt.enable(pt.CULL_FACE):pt.disable(pt.CULL_FACE),this.current=ut,this.dirty=!1}}class N extends b{getDefault(){return this.gl.BACK}set(ut){(ut!==this.current||this.dirty)&&(this.gl.cullFace(ut),this.current=ut,this.dirty=!1)}}class U extends b{getDefault(){return this.gl.CCW}set(ut){(ut!==this.current||this.dirty)&&(this.gl.frontFace(ut),this.current=ut,this.dirty=!1)}}let Xt=class extends b{getDefault(){return null}set(ut){(ut!==this.current||this.dirty)&&(this.gl.useProgram(ut),this.current=ut,this.dirty=!1)}};class j extends b{getDefault(){return this.gl.TEXTURE0}set(ut){(ut!==this.current||this.dirty)&&(this.gl.activeTexture(ut),this.current=ut,this.dirty=!1)}}class V extends b{getDefault(){const ut=this.gl;return[0,0,ut.drawingBufferWidth,ut.drawingBufferHeight]}set(ut){const pt=this.current;(ut[0]!==pt[0]||ut[1]!==pt[1]||ut[2]!==pt[2]||ut[3]!==pt[3]||this.dirty)&&(this.gl.viewport(ut[0],ut[1],ut[2],ut[3]),this.current=ut,this.dirty=!1)}}class W extends b{getDefault(){return null}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.bindFramebuffer(pt.FRAMEBUFFER,ut),this.current=ut,this.dirty=!1}}class Z extends b{getDefault(){return null}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.bindRenderbuffer(pt.RENDERBUFFER,ut),this.current=ut,this.dirty=!1}}class q extends b{getDefault(){return null}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.bindTexture(pt.TEXTURE_2D,ut),this.current=ut,this.dirty=!1}}class H extends b{getDefault(){return null}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.bindBuffer(pt.ARRAY_BUFFER,ut),this.current=ut,this.dirty=!1}}class $ extends b{getDefault(){return null}set(ut){const pt=this.gl;pt.bindBuffer(pt.ELEMENT_ARRAY_BUFFER,ut),this.current=ut,this.dirty=!1}}class X extends b{getDefault(){return null}set(ut){this.gl&&(ut!==this.current||this.dirty)&&(this.gl.bindVertexArray(ut),this.current=ut,this.dirty=!1)}}class Y extends b{getDefault(){return 4}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.pixelStorei(pt.UNPACK_ALIGNMENT,ut),this.current=ut,this.dirty=!1}}class K extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.pixelStorei(pt.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ut),this.current=ut,this.dirty=!1}}class Q extends b{getDefault(){return!1}set(ut){if(ut===this.current&&!this.dirty)return;const pt=this.gl;pt.pixelStorei(pt.UNPACK_FLIP_Y_WEBGL,ut),this.current=ut,this.dirty=!1}}class J extends b{constructor(ut,pt){super(ut),this.context=ut,this.parent=pt}getDefault(){return null}}class ee extends J{setDirty(){this.dirty=!0}set(ut){if(ut===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const pt=this.gl;pt.framebufferTexture2D(pt.FRAMEBUFFER,pt.COLOR_ATTACHMENT0,pt.TEXTURE_2D,ut,0),this.current=ut,this.dirty=!1}}class te extends J{attachment(){return this.gl.DEPTH_ATTACHMENT}set(ut){if(ut===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const pt=this.gl;pt.framebufferRenderbuffer(pt.FRAMEBUFFER,this.attachment(),pt.RENDERBUFFER,ut),this.current=ut,this.dirty=!1}}class ie extends J{attachment(){return this.gl.DEPTH_ATTACHMENT}set(ut){if(ut===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const pt=this.gl;pt.framebufferTexture2D(pt.FRAMEBUFFER,this.attachment(),pt.TEXTURE_2D,ut,0),this.current=ut,this.dirty=!1}}class oe extends te{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class re{constructor(ut,pt,wt,Tt,St){this.context=ut,this.width=pt,this.height=wt;const It=this.framebuffer=ut.gl.createFramebuffer();Tt&&(this.colorAttachment=new ee(ut,It)),St&&(this.depthAttachmentType=St,this.depthAttachment="renderbuffer"===St?new te(ut,It):new ie(ut,It))}destroy(){const ut=this.context.gl;if(this.colorAttachment){const pt=this.colorAttachment.get();pt&&ut.deleteTexture(pt)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const pt=this.depthAttachment.get();pt&&ut.deleteRenderbuffer(pt)}else{const pt=this.depthAttachment.get();pt&&ut.deleteTexture(pt)}ut.deleteFramebuffer(this.framebuffer)}}class ae{constructor(ut,pt){this.gl=ut,this.clearColor=new w(this),this.clearDepth=new T(this),this.clearStencil=new E(this),this.colorMask=new C(this),this.depthMask=new S(this),this.stencilMask=new I(this),this.stencilFunc=new L(this),this.stencilOp=new P(this),this.stencilTest=new A(this),this.depthRange=new R(this),this.depthTest=new D(this),this.depthFunc=new M(this),this.blend=new z(this),this.blendFunc=new O(this),this.blendColor=new F(this),this.blendEquation=new B(this),this.cullFace=new k(this),this.cullFaceSide=new N(this),this.frontFace=new U(this),this.program=new Xt(this),this.activeTexture=new j(this),this.viewport=new V(this),this.bindFramebuffer=new W(this),this.bindRenderbuffer=new Z(this),this.bindTexture=new q(this),this.bindVertexBuffer=new H(this),this.bindElementBuffer=new $(this),this.bindVertexArrayOES=new X(this),this.pixelStoreUnpack=new Y(this),this.pixelStoreUnpackPremultiplyAlpha=new K(this),this.pixelStoreUnpackFlipY=new Q(this),this.options=pt?{...pt}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=ut.getExtension("EXT_texture_filter_anisotropic")||ut.getExtension("MOZ_EXT_texture_filter_anisotropic")||ut.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=ut.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=ut.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=ut.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=ut.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=ut.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=ut.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=ut.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=ut.getParameter(ut.MAX_TEXTURE_SIZE),this.maxPointSize=ut.getParameter(ut.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(pt,wt,Tt){return new ut.I(this,pt,wt,Tt)}createVertexBuffer(ut,pt,wt,Tt,St){return new y(this,ut,pt,wt,Tt,St)}createRenderbuffer(ut,pt,wt){const Tt=this.gl,St=Tt.createRenderbuffer();return this.bindRenderbuffer.set(St),Tt.renderbufferStorage(Tt.RENDERBUFFER,ut,pt,wt),this.bindRenderbuffer.set(null),St}createFramebuffer(ut,pt,wt,Tt){return new re(this,ut,pt,wt,Tt)}clear({color:ut,depth:pt,stencil:wt,colorMask:Tt}){const St=this.gl;let It=0;ut&&(It|=St.COLOR_BUFFER_BIT,this.clearColor.set(ut),this.colorMask.set(Tt||[!0,!0,!0,!0])),void 0!==pt&&(It|=St.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(pt),this.depthMask.set(!0)),void 0!==wt&&(It|=St.STENCIL_BUFFER_BIT,this.clearStencil.set(wt),this.stencilMask.set(255)),St.clear(It)}setCullFace(ut){!1===ut.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(ut.mode),this.frontFace.set(ut.frontFace))}setDepthMode(ut){ut.func!==this.gl.ALWAYS||ut.mask?(this.depthTest.set(!0),this.depthFunc.set(ut.func),this.depthMask.set(ut.mask),this.depthRange.set(ut.range)):this.depthTest.set(!1)}setStencilMode(ut){ut.test.func!==this.gl.ALWAYS||ut.mask?(this.stencilTest.set(!0),this.stencilMask.set(ut.mask),this.stencilOp.set([ut.fail,ut.depthFail,ut.pass]),this.stencilFunc.set({func:ut.test.func,ref:ut.ref,mask:ut.test.mask})):this.stencilTest.set(!1)}setColorMode(pt){t(pt.blendFunction,ut.a.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(pt.blendFunction),this.blendColor.set(pt.blendColor),pt.blendEquation?this.blendEquation.set(pt.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(pt.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class se{constructor(ut){this._gl=ut.gl,this._query=this._gl.createQuery(),this._isFree=!0}begin(){this._gl.beginQuery(this._gl.ANY_SAMPLES_PASSED,this._query),this._isFree=!1}end(){this._gl.endQuery(this._gl.ANY_SAMPLES_PASSED)}isResultAvailable(){return this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE)}consumeResult(){const ut=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT);return this._isFree=!0,ut}isFree(){return this._isFree}destroy(){this._gl.deleteQuery(this._query)}}class ne{constructor(ut){this.useOcclusionQueries=!0,this.visualizeOcclusions="none",this.occlusionQueryFrameWindow=5,this.occluderSize=32,this.fadeSpeed=7,this.depthOffset=-1e-4,ut.registerParameter(this,["Symbols"],"useOcclusionQueries"),ut.registerParameter(this,["Symbols"],"visualizeOcclusions",{options:{none:"none",zPass:"zPass",zTest:"zTest"}}),ut.registerParameter(this,["Symbols"],"occlusionQueryFrameWindow",{min:1,max:30,step:1}),ut.registerParameter(this,["Symbols"],"occluderSize",{min:1,max:100,step:1}),ut.registerParameter(this,["Symbols"],"fadeSpeed",{min:.1,max:50,step:.1}),ut.registerParameter(this,["Symbols"],"depthOffset",{min:-.001,max:0,step:1e-4})}}class le{constructor(pt,wt,Tt,St){const It={width:Tt[0],height:Tt[1],data:null},Lt=pt.gl;this.targetColorTexture=new ut.T(pt,It,Lt.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new ut.T(pt,It,Lt.RGBA,{useMipmap:!1}),this.context=pt,this.updateParticleTexture(wt,St),this.lastInvalidatedAt=0}updateParticleTexture(pt,wt){if(this.particleTextureDimension===wt.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const Tt=this.context.gl,St=wt.width*wt.height;this.particleTexture0=new ut.T(this.context,wt,Tt.RGBA,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new ut.T(this.context,wt,Tt.RGBA,{premultiply:!1,useMipmap:!1});const It=new ut.S;It.reserve(St);for(let ut=0;ut<St;ut++)It.emplaceBack(ut);this.particleIndexBuffer=this.context.createVertexBuffer(It,ut.p.members,!0),this.particleSegment=ut.b.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=wt.width}update(pt){return!(this.lastInvalidatedAt<pt&&(this.lastInvalidatedAt=ut.e.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}class ce extends ut.E{constructor(ut){super(),this.requestManager=ut,this.models={"":{}},this.numModelsLoading={}}loadModel(pt,wt){return ut.l(this.requestManager.transformRequest(wt,ut.R.Model).url).then((wt=>{if(!wt)return;const Tt=ut.c(wt),St=new ut.M(pt,void 0,void 0,Tt);return St.computeBoundsAndApplyParent(),St})).catch((Tt=>{if(Tt&&404===Tt.status)return null;this.fire(new ut.d(new Error(`Could not load model ${pt} from ${wt}: ${Tt.message}`)))}))}load(pt,wt){this.models[wt]||(this.models[wt]={});const Tt=Object.keys(pt);this.numModelsLoading[wt]=(this.numModelsLoading[wt]||0)+Tt.length;const St=[];for(const ut of Tt)St.push(this.loadModel(ut,pt[ut]));Promise.allSettled(St).then((pt=>{for(let ut=0;ut<pt.length;ut++){const{status:St,value:It}=pt[ut];"fulfilled"===St&&It&&(this.models[wt][Tt[ut]]={model:It,numReferences:1})}this.numModelsLoading[wt]-=Tt.length,this.fire(new ut.f("data",{dataType:"style"}))})).catch((pt=>{this.fire(new ut.d(new Error(`Could not load models: ${pt.message}`)))}))}isLoaded(){for(const ut in this.numModelsLoading)if(this.numModelsLoading[ut]>0)return!1;return!0}hasModel(ut,pt){return!!this.getModel(ut,pt)}getModel(ut,pt){return this.models[pt]||(this.models[pt]={}),this.models[pt][ut]?this.models[pt][ut].model:void 0}addModel(ut,pt,wt){this.models[wt]||(this.models[wt]={}),this.hasModel(ut,wt)&&this.models[wt][ut].numReferences++,this.load({[ut]:this.requestManager.normalizeModelURL(pt)},wt)}addModels(ut,pt){this.models[pt]||(this.models[pt]={});const wt={};for(const Tt in ut)this.models[pt][Tt]={},wt[Tt]=this.requestManager.normalizeModelURL(ut[Tt]);this.load(wt,pt)}addModelsFromBucket(ut,pt){this.models[pt]||(this.models[pt]={});const wt={};for(const Tt of ut)this.hasModel(Tt,pt)?this.models[pt][Tt].numReferences++:wt[Tt]=this.requestManager.normalizeModelURL(Tt);this.load(wt,pt)}removeModel(ut,pt){if(this.models[pt]&&this.models[pt][ut]&&(this.models[pt][ut].numReferences--,0===this.models[pt][ut].numReferences)){const wt=this.models[pt][ut].model;delete this.models[pt][ut],wt.destroy()}}listModels(ut){return this.models[ut]||(this.models[ut]={}),Object.keys(this.models[ut])}upload(ut,pt){this.models[pt]||(this.models[pt]={});for(const wt in this.models[pt])this.models[pt][wt].model&&this.models[pt][wt].model.upload(ut.context)}}function he(ut){const{userImage:pt}=ut;return!!(pt&&pt.render&&pt.render())&&(ut.data.replace(new Uint8Array(pt.data.buffer)),!0)}class ue extends ut.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(pt){this.images[pt]={},this.loaded[pt]=!1,this.updatedImages[pt]={},this.patterns[pt]={},this.callbackDispatchedThisFrame[pt]={},this.atlasImage[pt]=new ut.i({width:1,height:1})}isLoaded(){for(const ut in this.loaded)if(!this.loaded[ut])return!1;return!0}setLoaded(ut,pt){if(this.loaded[pt]!==ut&&(this.loaded[pt]=ut,ut)){for(const{ids:ut,callback:wt}of this.requestors)this._notify(ut,pt,wt);this.requestors=[]}}hasImage(ut,pt){return!!this.getImage(ut,pt)}getImage(ut,pt){return this.images[pt][ut]}addImage(ut,pt,wt){this._validate(ut,wt)&&(this.images[pt][ut]=wt)}_validate(pt,wt){let Tt=!0;return this._validateStretch(wt.stretchX,wt.data&&wt.data.width)||(this.fire(new ut.d(new Error(`Image "${pt}" has invalid "stretchX" value`))),Tt=!1),this._validateStretch(wt.stretchY,wt.data&&wt.data.height)||(this.fire(new ut.d(new Error(`Image "${pt}" has invalid "stretchY" value`))),Tt=!1),this._validateContent(wt.content,wt)||(this.fire(new ut.d(new Error(`Image "${pt}" has invalid "content" value`))),Tt=!1),Tt}_validateStretch(ut,pt){if(!ut)return!0;let wt=0;for(const Tt of ut){if(Tt[0]<wt||Tt[1]<Tt[0]||pt<Tt[1])return!1;wt=Tt[1]}return!0}_validateContent(ut,pt){return!(ut&&(4!==ut.length||ut[0]<0||pt.data.width<ut[0]||ut[1]<0||pt.data.height<ut[1]||ut[2]<0||pt.data.width<ut[2]||ut[3]<0||pt.data.height<ut[3]||ut[2]<ut[0]||ut[3]<ut[1]))}updateImage(ut,pt,wt){wt.version=this.images[pt][ut].version+1,this.images[pt][ut]=wt,this.updatedImages[pt][ut]=!0}removeImage(ut,pt){const wt=this.images[pt][ut];delete this.images[pt][ut],delete this.patterns[pt][ut],wt.userImage&&wt.userImage.onRemove&&wt.userImage.onRemove()}listImages(ut){return Object.keys(this.images[ut])}getImages(ut,pt,wt){let Tt=!0;const St=!!this.loaded[pt];if(!St)for(const wt of ut)this.images[pt][wt]||(Tt=!1);St||Tt?this._notify(ut,pt,wt):this.requestors.push({ids:ut,scope:pt,callback:wt})}getUpdatedImages(ut){return this.updatedImages[ut]}_notify(pt,wt,Tt){const St={};for(const Tt of pt){this.images[wt][Tt]||this.fire(new ut.f("styleimagemissing",{id:Tt}));const pt=this.images[wt][Tt];pt?St[Tt]={data:pt.data.clone(),pixelRatio:pt.pixelRatio,sdf:pt.sdf,version:pt.version,stretchX:pt.stretchX,stretchY:pt.stretchY,content:pt.content,hasRenderCallback:Boolean(pt.userImage&&pt.userImage.render)}:ut.w(`Image "${Tt}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}Tt(null,St)}getPixelSize(ut){const{width:pt,height:wt}=this.atlasImage[ut];return{width:pt,height:wt}}getPattern(pt,wt,Tt){const St=this.patterns[wt][pt],It=this.getImage(pt,wt);if(!It)return null;if(St&&St.position.version===It.version)return St.position;if(St)St.position.version=It.version;else{const Tt={w:It.data.width+2,h:It.data.height+2,x:0,y:0},St=new ut.k(Tt,It);this.patterns[wt][pt]={bin:Tt,position:St}}return this._updatePatternAtlas(wt,Tt),this.patterns[wt][pt].position}bind(pt,wt){const Tt=pt.gl;let St=this.atlasTexture[wt];St?this.dirty&&(St.update(this.atlasImage[wt]),this.dirty=!1):(St=new ut.T(pt,this.atlasImage[wt],Tt.RGBA),this.atlasTexture[wt]=St),St.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE)}_updatePatternAtlas(pt,wt){const Tt=[];for(const ut in this.patterns[pt])Tt.push(this.patterns[pt][ut].bin);const{w:St,h:It}=ut.j(Tt),Lt=this.atlasImage[pt];Lt.resize({width:St||1,height:It||1});for(const Tt in this.patterns[pt]){const{bin:St}=this.patterns[pt][Tt],It=St.x+1,Xt=St.y+1,Yt=this.images[pt][Tt].data,Mi=Yt.width,vr=Yt.height;ut.i.copy(Yt,Lt,{x:0,y:0},{x:It,y:Xt},{width:Mi,height:vr},wt),ut.i.copy(Yt,Lt,{x:0,y:vr-1},{x:It,y:Xt-1},{width:Mi,height:1},wt),ut.i.copy(Yt,Lt,{x:0,y:0},{x:It,y:Xt+vr},{width:Mi,height:1},wt),ut.i.copy(Yt,Lt,{x:Mi-1,y:0},{x:It-1,y:Xt},{width:1,height:vr},wt),ut.i.copy(Yt,Lt,{x:0,y:0},{x:It+Mi,y:Xt},{width:1,height:vr},wt)}this.dirty=!0}beginFrame(){for(const ut in this.images)this.callbackDispatchedThisFrame[ut]={}}dispatchRenderCallbacks(ut,pt){for(const wt of ut){if(this.callbackDispatchedThisFrame[pt][wt])continue;this.callbackDispatchedThisFrame[pt][wt]=!0;const ut=this.images[pt][wt];he(ut)&&this.updateImage(wt,pt,ut)}}}function _e(pt){const wt=pt.key,Tt=pt.value,St=pt.valueSpec||{},It=pt.objectElementValidators||{},Lt=pt.style,Xt=pt.styleSpec;let Yt=[];const Mi=ut.n(Tt);if("object"!==Mi)return[new ut.V(wt,Tt,`object expected, ${Mi} found`)];for(const pt in Tt){const Mi=pt.split(".")[0];let vr;It[Mi]?vr=It[Mi]:St[Mi]?vr=ze:It["*"]?vr=It["*"]:St["*"]&&(vr=ze),vr?Yt=Yt.concat(vr({key:(wt?`${wt}.`:wt)+pt,value:Tt[pt],valueSpec:St[Mi]||St["*"],style:Lt,styleSpec:Xt,object:Tt,objectKey:pt},Tt)):Yt.push(new ut.m(wt,Tt[pt],`unknown property "${pt}"`))}for(const pt in St)It[pt]||St[pt].required&&void 0===St[pt].default&&void 0===Tt[pt]&&Yt.push(new ut.V(wt,Tt,`missing required property "${pt}"`));return Yt}function de(pt){const wt=pt.value,Tt=pt.valueSpec,St=pt.style,It=pt.styleSpec,Lt=pt.key,Xt=pt.arrayElementValidator||ze;if("array"!==ut.n(wt))return[new ut.V(Lt,wt,`array expected, ${ut.n(wt)} found`)];if(Tt.length&&wt.length!==Tt.length)return[new ut.V(Lt,wt,`array length ${Tt.length} expected, length ${wt.length} found`)];if(Tt["min-length"]&&wt.length<Tt["min-length"])return[new ut.V(Lt,wt,`array length at least ${Tt["min-length"]} expected, length ${wt.length} found`)];let Yt={type:Tt.value,values:Tt.values,minimum:Tt.minimum,maximum:Tt.maximum,function:void 0};It.$version<7&&(Yt.function=Tt.function),"object"===ut.n(Tt.value)&&(Yt=Tt.value);let Mi=[];for(let ut=0;ut<wt.length;ut++)Mi=Mi.concat(Xt({array:wt,arrayIndex:ut,value:wt[ut],valueSpec:Yt,style:St,styleSpec:It,key:`${Lt}[${ut}]`},!0));return Mi}function pe(pt){const wt=pt.key,Tt=pt.value,St=pt.valueSpec;let It=ut.n(Tt);if("number"===It&&Tt!=Tt&&(It="NaN"),"number"!==It)return[new ut.V(wt,Tt,`number expected, ${It} found`)];if("minimum"in St){let It=St.minimum;if("array"===ut.n(St.minimum)&&(It=St.minimum[pt.arrayIndex]),Tt<It)return[new ut.V(wt,Tt,`${Tt} is less than the minimum value ${It}`)]}if("maximum"in St){let It=St.maximum;if("array"===ut.n(St.maximum)&&(It=St.maximum[pt.arrayIndex]),Tt>It)return[new ut.V(wt,Tt,`${Tt} is greater than the maximum value ${It}`)]}return[]}function fe(pt){const wt=pt.valueSpec,Tt=ut.u(pt.value.type);let St,It,Lt,Xt={};const Yt="categorical"!==Tt&&void 0===pt.value.property,Mi=!Yt,vr="array"===ut.n(pt.value.stops)&&"array"===ut.n(pt.value.stops[0])&&"object"===ut.n(pt.value.stops[0][0]),br=_e({key:pt.key,value:pt.value,valueSpec:pt.styleSpec.function,style:pt.style,styleSpec:pt.styleSpec,objectElementValidators:{stops:function(pt){if("identity"===Tt)return[new ut.V(pt.key,pt.value,'identity function may not have a "stops" property')];let wt=[];const St=pt.value;return wt=wt.concat(de({key:pt.key,value:St,valueSpec:pt.valueSpec,style:pt.style,styleSpec:pt.styleSpec,arrayElementValidator:_})),"array"===ut.n(St)&&0===St.length&&wt.push(new ut.V(pt.key,St,"array must have at least one stop")),wt},default:function(ut){return ze({key:ut.key,value:ut.value,valueSpec:wt,style:ut.style,styleSpec:ut.styleSpec})}}});return"identity"===Tt&&Yt&&br.push(new ut.V(pt.key,pt.value,'missing required property "property"')),"identity"===Tt||pt.value.stops||br.push(new ut.V(pt.key,pt.value,'missing required property "stops"')),"exponential"===Tt&&pt.valueSpec.expression&&!ut.s(pt.valueSpec)&&br.push(new ut.V(pt.key,pt.value,"exponential functions not supported")),pt.styleSpec.$version>=8&&(Mi&&!ut.q(pt.valueSpec)?br.push(new ut.V(pt.key,pt.value,"property functions not supported")):Yt&&!ut.r(pt.valueSpec)&&br.push(new ut.V(pt.key,pt.value,"zoom functions not supported"))),"categorical"!==Tt&&!vr||void 0!==pt.value.property||br.push(new ut.V(pt.key,pt.value,'"property" property is required')),br;function _(pt){let Tt=[];const St=pt.value,Yt=pt.key;if("array"!==ut.n(St))return[new ut.V(Yt,St,`array expected, ${ut.n(St)} found`)];if(2!==St.length)return[new ut.V(Yt,St,`array length 2 expected, length ${St.length} found`)];if(vr){if("object"!==ut.n(St[0]))return[new ut.V(Yt,St,`object expected, ${ut.n(St[0])} found`)];if(void 0===St[0].zoom)return[new ut.V(Yt,St,"object stop key must have zoom")];if(void 0===St[0].value)return[new ut.V(Yt,St,"object stop key must have value")];const wt=ut.u(St[0].zoom);if("number"!=typeof wt)return[new ut.V(Yt,St[0].zoom,"stop zoom values must be numbers")];if(Lt&&Lt>wt)return[new ut.V(Yt,St[0].zoom,"stop zoom values must appear in ascending order")];wt!==Lt&&(Lt=wt,It=void 0,Xt={}),Tt=Tt.concat(_e({key:`${Yt}[0]`,value:St[0],valueSpec:{zoom:{}},style:pt.style,styleSpec:pt.styleSpec,objectElementValidators:{zoom:pe,value:d}}))}else Tt=Tt.concat(d({key:`${Yt}[0]`,value:St[0],valueSpec:{},style:pt.style,styleSpec:pt.styleSpec},St));return ut.t(ut.v(St[1]))?Tt.concat([new ut.V(`${Yt}[1]`,St[1],"expressions are not allowed in function stops.")]):Tt.concat(ze({key:`${Yt}[1]`,value:St[1],valueSpec:wt,style:pt.style,styleSpec:pt.styleSpec}))}function d(pt,Lt){const Yt=ut.n(pt.value),Mi=ut.u(pt.value),vr=null!==pt.value?pt.value:Lt;if(St){if(Yt!==St)return[new ut.V(pt.key,vr,`${Yt} stop domain type must match previous stop domain type ${St}`)]}else St=Yt;if("number"!==Yt&&"string"!==Yt&&"boolean"!==Yt&&"number"!=typeof Mi&&"string"!=typeof Mi&&"boolean"!=typeof Mi)return[new ut.V(pt.key,vr,"stop domain value must be a number, string, or boolean")];if("number"!==Yt&&"categorical"!==Tt){let St=`number expected, ${Yt} found`;return ut.q(wt)&&void 0===Tt&&(St+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ut.V(pt.key,vr,St)]}return"categorical"!==Tt||"number"!==Yt||"number"==typeof Mi&&isFinite(Mi)&&Math.floor(Mi)===Mi?"categorical"!==Tt&&"number"===Yt&&"number"==typeof Mi&&"number"==typeof It&&void 0!==It&&Mi<It?[new ut.V(pt.key,vr,"stop domain values must appear in ascending order")]:(It=Mi,"categorical"===Tt&&Mi in Xt?[new ut.V(pt.key,vr,"stop domain values must be unique")]:(Xt[Mi]=!0,[])):[new ut.V(pt.key,vr,`integer expected, found ${String(Mi)}`)]}}function me(pt){const wt=("property"===pt.expressionContext?ut.x:ut.y)(ut.v(pt.value),pt.valueSpec);if("error"===wt.result)return wt.value.map((wt=>new ut.V(`${pt.key}${wt.key}`,pt.value,wt.message)));const Tt=wt.value.expression||wt.value._styleExpression.expression;if("property"===pt.expressionContext&&"text-font"===pt.propertyKey&&!Tt.outputDefined())return[new ut.V(pt.key,pt.value,`Invalid data expression for "${pt.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===pt.expressionContext&&"layout"===pt.propertyType&&!ut.z(Tt))return[new ut.V(pt.key,pt.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===pt.expressionContext)return ge(Tt,pt);if(pt.expressionContext&&0===pt.expressionContext.indexOf("cluster")){if(!ut.A(Tt,["zoom","feature-state"]))return[new ut.V(pt.key,pt.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===pt.expressionContext&&!ut.B(Tt))return[new ut.V(pt.key,pt.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ge(pt,wt){const Tt=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(wt.valueSpec&&wt.valueSpec.expression)for(const ut of wt.valueSpec.expression.parameters)Tt.delete(ut);if(0===Tt.size)return[];const St=[];return pt instanceof ut.D&&Tt.has(pt.name)?[new ut.V(wt.key,wt.value,`["${pt.name}"] expression is not supported in a filter for a ${wt.object.type} layer with id: ${wt.object.id}`)]:(pt.eachChild((ut=>{St.push(...ge(ut,wt))})),St)}function ve(pt){const wt=pt.key,Tt=pt.value,St=pt.valueSpec,It=[];return Array.isArray(St.values)?-1===St.values.indexOf(ut.u(Tt))&&It.push(new ut.V(wt,Tt,`expected one of [${St.values.join(", ")}], ${JSON.stringify(Tt)} found`)):-1===Object.keys(St.values).indexOf(ut.u(Tt))&&It.push(new ut.V(wt,Tt,`expected one of [${Object.keys(St.values).join(", ")}], ${JSON.stringify(Tt)} found`)),It}function xe(pt){return ut.G(ut.v(pt.value))?me(ut.o({},pt,{expressionContext:"filter",valueSpec:pt.styleSpec[`filter_${pt.layerType||"fill"}`]})):ye(pt)}function ye(pt){const wt=pt.value,Tt=pt.key;if("array"!==ut.n(wt))return[new ut.V(Tt,wt,`array expected, ${ut.n(wt)} found`)];const St=pt.styleSpec;let It,Lt=[];if(wt.length<1)return[new ut.V(Tt,wt,"filter array must have at least 1 element")];switch(Lt=Lt.concat(ve({key:`${Tt}[0]`,value:wt[0],valueSpec:St.filter_operator,style:pt.style,styleSpec:pt.styleSpec})),ut.u(wt[0])){case"<":case"<=":case">":case">=":wt.length>=2&&"$type"===ut.u(wt[1])&&Lt.push(new ut.V(Tt,wt,`"$type" cannot be use with operator "${wt[0]}"`));case"==":case"!=":3!==wt.length&&Lt.push(new ut.V(Tt,wt,`filter array for operator "${wt[0]}" must have 3 elements`));case"in":case"!in":wt.length>=2&&(It=ut.n(wt[1]),"string"!==It&&Lt.push(new ut.V(`${Tt}[1]`,wt[1],`string expected, ${It} found`)));for(let Xt=2;Xt<wt.length;Xt++)It=ut.n(wt[Xt]),"$type"===ut.u(wt[1])?Lt=Lt.concat(ve({key:`${Tt}[${Xt}]`,value:wt[Xt],valueSpec:St.geometry_type,style:pt.style,styleSpec:pt.styleSpec})):"string"!==It&&"number"!==It&&"boolean"!==It&&Lt.push(new ut.V(`${Tt}[${Xt}]`,wt[Xt],`string, number, or boolean expected, ${It} found`));break;case"any":case"all":case"none":for(let ut=1;ut<wt.length;ut++)Lt=Lt.concat(ye({key:`${Tt}[${ut}]`,value:wt[ut],style:pt.style,styleSpec:pt.styleSpec}));break;case"has":case"!has":It=ut.n(wt[1]),2!==wt.length?Lt.push(new ut.V(Tt,wt,`filter array for "${wt[0]}" operator must have 2 elements`)):"string"!==It&&Lt.push(new ut.V(`${Tt}[1]`,wt[1],`string expected, ${It} found`))}return Lt}function be(pt,wt){const Tt=pt.key,St=pt.style,It=pt.layer,Lt=pt.styleSpec,Xt=pt.value,Yt=pt.objectKey,Mi=Lt[`${wt}_${pt.layerType}`];if(!Mi)return[];const vr=Yt.match(/^(.*)-transition$/);if("paint"===wt&&vr&&Mi[vr[1]]&&Mi[vr[1]].transition)return ze({key:Tt,value:Xt,valueSpec:Lt.transition,style:St,styleSpec:Lt});const br=pt.valueSpec||Mi[Yt];if(!br)return[new ut.m(Tt,Xt,`unknown property "${Yt}"`)];let Ar;if("string"===ut.n(Xt)&&ut.q(br)&&!br.tokens&&(Ar=/^{([^}]+)}$/.exec(Xt))){const pt=`\`{ "type": "identity", "property": ${Ar?JSON.stringify(Ar[1]):'"_"'} }\``;return[new ut.V(Tt,Xt,`"${Yt}" does not support interpolation syntax\nUse an identity property function instead: ${pt}.`)]}const Vr=[];if("symbol"===pt.layerType)"text-field"!==Yt||!St||St.glyphs||St.imports||Vr.push(new ut.V(Tt,Xt,'use of "text-field" requires a style "glyphs" property')),"text-font"===Yt&&ut.H(ut.v(Xt))&&"identity"===ut.u(Xt.type)&&Vr.push(new ut.V(Tt,Xt,'"text-font" does not support identity functions'));else if("model"===pt.layerType&&"paint"===wt&&It&&It.layout&&It.layout.hasOwnProperty("model-id")&&ut.q(br)&&(ut.J(br)||ut.r(br))){const pt=ut.x(ut.v(Xt),br),wt=pt.value.expression||pt.value._styleExpression.expression;wt&&!ut.A(wt,["measure-light"])&&("model-emissive-strength"===Yt&&ut.B(wt)&&ut.z(wt)||Vr.push(new ut.V(Tt,Xt,`${Yt} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return Vr.concat(ze({key:pt.key,value:Xt,valueSpec:br,style:St,styleSpec:Lt,expressionContext:"property",propertyType:wt,propertyKey:Yt}))}function we(ut){return be(ut,"paint")}function Te(ut){return be(ut,"layout")}function Ee(pt){let wt=[];const Tt=pt.value,St=pt.key,It=pt.style,Lt=pt.styleSpec;Tt.type||Tt.ref||wt.push(new ut.V(St,Tt,'either "type" or "ref" is required'));let Xt=ut.u(Tt.type);const Yt=ut.u(Tt.ref);if(Tt.id){const Lt=ut.u(Tt.id);for(let Xt=0;Xt<pt.arrayIndex;Xt++){const pt=It.layers[Xt];ut.u(pt.id)===Lt&&wt.push(new ut.V(St,Tt.id,`duplicate layer id "${Tt.id}", previously used at line ${pt.id.__line__}`))}}if("ref"in Tt){let pt;["type","source","source-layer","filter","layout"].forEach((pt=>{pt in Tt&&wt.push(new ut.V(St,Tt[pt],`"${pt}" is prohibited for ref layers`))})),It.layers.forEach((wt=>{ut.u(wt.id)===Yt&&(pt=wt)})),pt?pt.ref?wt.push(new ut.V(St,Tt.ref,"ref cannot reference another ref layer")):Xt=ut.u(pt.type):"string"==typeof Yt&&wt.push(new ut.V(St,Tt.ref,`ref layer "${Yt}" not found`))}else if("background"!==Xt&&"sky"!==Xt&&"slot"!==Xt)if(Tt.source){const pt=It.sources&&It.sources[Tt.source],Lt=pt&&ut.u(pt.type);pt?"vector"===Lt&&"raster"===Xt?wt.push(new ut.V(St,Tt.source,`layer "${Tt.id}" requires a raster source`)):"raster"===Lt&&"raster"!==Xt?wt.push(new ut.V(St,Tt.source,`layer "${Tt.id}" requires a vector source`)):"vector"!==Lt||Tt["source-layer"]?"raster-dem"===Lt&&"hillshade"!==Xt?wt.push(new ut.V(St,Tt.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==Lt||["raster","raster-particle"].includes(Xt)?"line"!==Xt||!Tt.paint||!Tt.paint["line-gradient"]&&!Tt.paint["line-trim-offset"]||"geojson"===Lt&&pt.lineMetrics?"raster-particle"===Xt&&"raster-array"!==Lt&&wt.push(new ut.V(St,Tt.source,`layer "${Tt.id}" requires a 'raster-array' source.`)):wt.push(new ut.V(St,Tt,`layer "${Tt.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):wt.push(new ut.V(St,Tt.source,"raster-array source can only be used with layer type 'raster'.")):wt.push(new ut.V(St,Tt,`layer "${Tt.id}" must specify a "source-layer"`)):wt.push(new ut.V(St,Tt.source,`source "${Tt.source}" not found`))}else wt.push(new ut.V(St,Tt,'missing required property "source"'));return wt=wt.concat(_e({key:St,value:Tt,valueSpec:Lt.layer,style:pt.style,styleSpec:pt.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ze({key:`${St}.type`,value:Tt.type,valueSpec:Lt.layer.type,style:pt.style,styleSpec:pt.styleSpec,object:Tt,objectKey:"type"}),filter:pt=>xe(ut.o({layerType:Xt},pt)),layout:pt=>_e({layer:Tt,key:pt.key,value:pt.value,valueSpec:{},style:pt.style,styleSpec:pt.styleSpec,objectElementValidators:{"*":pt=>Te(ut.o({layerType:Xt},pt))}}),paint:pt=>_e({layer:Tt,key:pt.key,value:pt.value,valueSpec:{},style:pt.style,styleSpec:pt.styleSpec,objectElementValidators:{"*":pt=>we(ut.o({layerType:Xt,layer:Tt},pt))}})}})),wt}function Ce(pt){const wt=pt.value,Tt=pt.key,St=ut.n(wt);return"string"!==St?[new ut.V(Tt,wt,`string expected, ${St} found`)]:[]}const Yt={promoteId:function({key:pt,value:wt}){if("string"===ut.n(wt))return Ce({key:pt,value:wt});{const ut=[];for(const Tt in wt)ut.push(...Ce({key:`${pt}.${Tt}`,value:wt[Tt]}));return ut}}};function Ie(pt){const wt=pt.value,Tt=pt.key,St=pt.styleSpec,It=pt.style;if(!wt.type)return[new ut.V(Tt,wt,'"type" is required')];const Lt=ut.u(wt.type);let Xt=[];switch(["vector","raster","raster-dem","raster-array"].includes(Lt)&&(wt.url||wt.tiles||Xt.push(new ut.m(Tt,wt,'Either "url" or "tiles" is required.'))),Lt){case"vector":case"raster":case"raster-dem":case"raster-array":return Xt=Xt.concat(_e({key:Tt,value:wt,valueSpec:St[`source_${Lt.replace("-","_")}`],style:pt.style,styleSpec:St,objectElementValidators:Yt})),Xt;case"geojson":if(Xt=_e({key:Tt,value:wt,valueSpec:St.source_geojson,style:It,styleSpec:St,objectElementValidators:Yt}),wt.cluster)for(const ut in wt.clusterProperties){const[pt,St]=wt.clusterProperties[ut],It="string"==typeof pt?[pt,["accumulated"],["get",ut]]:pt;Xt.push(...me({key:`${Tt}.${ut}.map`,value:St,expressionContext:"cluster-map"})),Xt.push(...me({key:`${Tt}.${ut}.reduce`,value:It,expressionContext:"cluster-reduce"}))}return Xt;case"video":return _e({key:Tt,value:wt,valueSpec:St.source_video,style:It,styleSpec:St});case"image":return _e({key:Tt,value:wt,valueSpec:St.source_image,style:It,styleSpec:St});case"canvas":return[new ut.V(Tt,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ve({key:`${Tt}.type`,value:wt.type,valueSpec:{values:Le(St)},style:It,styleSpec:St})}}function Le(ut){return ut.source.reduce(((pt,wt)=>{const Tt=ut[wt];return"enum"===Tt.type.type&&(pt=pt.concat(Object.keys(Tt.type.values))),pt}),[])}function Pe(pt){const wt=pt.value,Tt=pt.styleSpec,St=Tt.light,It=pt.style;let Lt=[];const Xt=ut.n(wt);if(void 0===wt)return Lt;if("object"!==Xt)return Lt=Lt.concat([new ut.V("light",wt,`object expected, ${Xt} found`)]),Lt;for(const pt in wt){const Xt=pt.match(/^(.*)-transition$/);Lt=Lt.concat(Xt&&St[Xt[1]]&&St[Xt[1]].transition?ze({key:pt,value:wt[pt],valueSpec:Tt.transition,style:It,styleSpec:Tt}):St[pt]?ze({key:pt,value:wt[pt],valueSpec:St[pt],style:It,styleSpec:Tt}):[new ut.V(pt,wt[pt],`unknown property "${pt}"`)])}return Lt}function Ae(pt){const wt=pt.value;let Tt=[];if(!wt)return Tt;const St=ut.n(wt);if("object"!==St)return Tt=Tt.concat([new ut.V("light-3d",wt,`object expected, ${St} found`)]),Tt;const It=pt.styleSpec,Lt=It["light-3d"],Xt=pt.key,Yt=pt.style,Mi=pt.style.lights;for(const pt of["type","id"])if(!(pt in wt))return Tt=Tt.concat([new ut.V("light-3d",wt,`missing property ${pt} on light`)]),Tt;if(wt.type&&Mi)for(let St=0;St<pt.arrayIndex;St++){const pt=ut.u(wt.type),It=Mi[St];ut.u(It.type)===pt&&Tt.push(new ut.V(Xt,wt.id,`duplicate light type "${wt.type}", previously defined at line ${It.id.__line__}`))}const vr=`properties_light_${wt.type}`;if(!(vr in It))return Tt=Tt.concat([new ut.V("light-3d",wt,`Invalid light type ${wt.type}`)]),Tt;const br=It[vr];for(const St in wt)if("properties"===St){const Lt=wt[St],Xt=ut.n(Lt);if("object"!==Xt)return Tt=Tt.concat([new ut.V("properties",Lt,`object expected, ${Xt} found`)]),Tt;for(const wt in Lt)Tt=Tt.concat(br[wt]?ze({key:wt,value:Lt[wt],valueSpec:br[wt],style:Yt,styleSpec:It}):[new ut.m(pt.key,Lt[wt],`unknown property "${wt}"`)])}else{const pt=St.match(/^(.*)-transition$/);Tt=Tt.concat(pt&&Lt[pt[1]]&&Lt[pt[1]].transition?ze({key:St,value:wt[St],valueSpec:It.transition,style:Yt,styleSpec:It}):Lt[St]?ze({key:St,value:wt[St],valueSpec:Lt[St],style:Yt,styleSpec:It}):[new ut.m(St,wt[St],`unknown property "${St}"`)])}return Tt}function Re(pt){const wt=pt.value,Tt=pt.key,St=pt.style,It=pt.styleSpec,Lt=It.terrain;let Xt=[];const Yt=ut.n(wt);if(void 0===wt)return Xt;if("null"===Yt)return Xt;if("object"!==Yt)return Xt=Xt.concat([new ut.V("terrain",wt,`object expected, ${Yt} found`)]),Xt;for(const pt in wt){const Tt=pt.match(/^(.*)-transition$/);Xt=Xt.concat(Tt&&Lt[Tt[1]]&&Lt[Tt[1]].transition?ze({key:pt,value:wt[pt],valueSpec:It.transition,style:St,styleSpec:It}):Lt[pt]?ze({key:pt,value:wt[pt],valueSpec:Lt[pt],style:St,styleSpec:It}):[new ut.m(pt,wt[pt],`unknown property "${pt}"`)])}if(wt.source){const pt=St.sources&&St.sources[wt.source],It=pt&&ut.u(pt.type);pt?"raster-dem"!==It&&Xt.push(new ut.V(Tt,wt.source,`terrain cannot be used with a source of type ${String(It)}, it only be used with a "raster-dem" source type`)):Xt.push(new ut.V(Tt,wt.source,`source "${wt.source}" not found`))}else Xt.push(new ut.V(Tt,wt,'terrain is missing required property "source"'));return Xt}function De(pt){const wt=pt.value,Tt=pt.style,St=pt.styleSpec,It=St.fog;let Lt=[];const Xt=ut.n(wt);if(void 0===wt)return Lt;if("object"!==Xt)return Lt=Lt.concat([new ut.V("fog",wt,`object expected, ${Xt} found`)]),Lt;for(const pt in wt){const Xt=pt.match(/^(.*)-transition$/);Lt=Lt.concat(Xt&&It[Xt[1]]&&It[Xt[1]].transition?ze({key:pt,value:wt[pt],valueSpec:St.transition,style:Tt,styleSpec:St}):It[pt]?ze({key:pt,value:wt[pt],valueSpec:It[pt],style:Tt,styleSpec:St}):[new ut.m(pt,wt[pt],`unknown property "${pt}"`)])}return Lt}const Mi={"*":()=>[],array:de,boolean:function(pt){const wt=pt.value,Tt=pt.key,St=ut.n(wt);return"boolean"!==St?[new ut.V(Tt,wt,`boolean expected, ${St} found`)]:[]},number:pe,color:function(pt){const wt=pt.key,Tt=pt.value,St=ut.n(Tt);return"string"!==St?[new ut.V(wt,Tt,`color expected, ${St} found`)]:null===ut.F(Tt)?[new ut.V(wt,Tt,`color expected, "${Tt}" found`)]:[]},enum:ve,filter:xe,function:fe,layer:Ee,object:_e,source:Ie,model:ut.K,light:Pe,"light-3d":Ae,terrain:Re,fog:De,string:Ce,formatted:function(ut){return 0===Ce(ut).length?[]:me(ut)},resolvedImage:function(ut){return 0===Ce(ut).length?[]:me(ut)},projection:function(pt){const wt=pt.value,Tt=pt.styleSpec,St=Tt.projection,It=pt.style;let Lt=[];const Xt=ut.n(wt);if("object"===Xt)for(const ut in wt)Lt=Lt.concat(ze({key:ut,value:wt[ut],valueSpec:St[ut],style:It,styleSpec:Tt}));else"string"!==Xt&&(Lt=Lt.concat([new ut.V("projection",wt,`object or string expected, ${Xt} found`)]));return Lt},import:function(pt){const{value:wt,styleSpec:Tt}=pt,{data:St,...It}=wt;Object.defineProperty(It,"__line__",{value:wt.__line__,enumerable:!1});let Lt=_e(ut.o({},pt,{value:It,valueSpec:Tt.import}));return""===ut.u(It.id)&&Lt.push(new ut.V(`${pt.key}.id`,It,"import id can't be an empty string")),St&&(Lt=Lt.concat(Fe(St,Tt,{key:`${pt.key}.data`}))),Lt}};function ze(pt,wt=!1){const Tt=pt.value,St=pt.valueSpec,It=pt.styleSpec;if(St.expression&&ut.H(ut.u(Tt)))return fe(pt);if(St.expression&&ut.t(ut.v(Tt)))return me(pt);if(St.type&&Mi[St.type]){const Tt=Mi[St.type](pt);return!0===wt&&Tt.length>0&&"array"===ut.n(pt.value)?me(pt):Tt}return _e(ut.o({},pt,{valueSpec:St.type?It[St.type]:St}))}function Oe(pt){const wt=pt.value,Tt=pt.key,St=Ce(pt);return St.length||(-1===wt.indexOf("{fontstack}")&&St.push(new ut.V(Tt,wt,'"glyphs" url must include a "{fontstack}" token')),-1===wt.indexOf("{range}")&&St.push(new ut.V(Tt,wt,'"glyphs" url must include a "{range}" token'))),St}function Fe(pt,wt=ut.L,Tt={}){return ze({key:Tt.key||"",value:pt,valueSpec:wt.$root,styleSpec:wt,style:pt,objectElementValidators:{glyphs:Oe,"*":()=>[]}})}function Be(pt,wt=ut.L){return $e(Fe(pt,wt))}const ke=ut=>$e(Ie(ut)),Ne=ut=>$e(Pe(ut)),Ue=ut=>$e(Ae(ut)),Ge=ut=>$e(Re(ut)),je=ut=>$e(De(ut)),Ve=ut=>$e(Ee(ut)),We=ut=>$e(xe(ut)),Ze=ut=>$e(we(ut)),qe=ut=>$e(Te(ut)),He=pt=>$e(ut.K(pt));function $e(ut){return ut.slice().sort(((ut,pt)=>ut.line&&pt.line?ut.line-pt.line:0))}function Xe(pt,wt){let Tt=!1;if(wt&&wt.length)for(const St of wt)St instanceof ut.m?ut.w(St.message):(pt.fire(new ut.d(new Error(St.message))),Tt=!0);return Tt}const vr=new ut.N({anchor:new ut.O(ut.L.light.anchor),position:new ut.Q(ut.L.light.position),color:new ut.O(ut.L.light.color),intensity:new ut.O(ut.L.light.intensity)});class Ke extends ut.E{constructor(pt,wt="flat"){super(),this._transitionable=new ut.U(vr),this.setLight(pt,wt),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(ut,pt,wt={}){this._validate(Ne,ut,wt)||(this._transitionable.setTransitionOrValue(ut),this.id=pt)}updateTransitions(ut){this._transitioning=this._transitionable.transitioned(ut,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(ut){this.properties=this._transitioning.possiblyEvaluate(ut)}_validate(pt,wt,Tt){return(!Tt||!1!==Tt.validate)&&Xe(this,pt.call(Be,ut.W({value:wt,style:{glyphs:!0,sprite:!0},styleSpec:ut.L})))}}const br=new ut.N({source:new ut.O(ut.L.terrain.source),exaggeration:new ut.O(ut.L.terrain.exaggeration)});let Ar=class extends ut.E{constructor(pt,wt,Tt,St){super(),this.scope=Tt,this._transitionable=new ut.U(br,Tt,St),this._transitionable.setTransitionOrValue(pt,St),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=wt}get(){return this._transitionable.serialize()}set(ut,pt){this._transitionable.setTransitionOrValue(ut,pt)}updateTransitions(ut){this._transitioning=this._transitionable.transitioned(ut,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(ut){this.properties=this._transitioning.possiblyEvaluate(ut)}getExaggeration(pt){return this._transitioning.possiblyEvaluate(new ut.X(pt)).get("exaggeration")}isZoomDependent(){const pt=this._transitionable._values.exaggeration;return null!=pt&&null!=pt.value&&null!=pt.value.expression&&pt.value.expression instanceof ut.Z}};const Vr=45,nn=65,sn=.05;function ot(pt,wt,Tt,St){const It=ut.$(Vr,nn,Tt),[Lt,Xt]=rt(pt,St);let Yt=1-Math.min(1,Math.exp((wt-Lt)/(Xt-Lt)*-6));return Yt*=Yt*Yt,Yt=Math.min(1,1.00747*Yt),Yt*It*pt.alpha}function rt(ut,pt){const wt=.5/Math.tan(.5*pt);return[ut.range[0]+wt,ut.range[1]+wt]}function at(pt,wt,Tt,St,It){const Lt=ut._.transformMat4([],[wt,Tt,St],It.mercatorFogMatrix);return ot(pt,ut._.length(Lt),It.pitch,It._fov)}function st(pt,wt,Tt,St,It,Lt,Xt){const Yt=[[Tt,St,0],[It,St,0],[It,Lt,0],[Tt,Lt,0]];let Mi=Number.MAX_VALUE,vr=-Number.MAX_VALUE;for(const pt of Yt){const Tt=ut._.transformMat4([],pt,wt),St=ut._.length(Tt);Mi=Math.min(Mi,St),vr=Math.max(vr,St)}return[ot(pt,Mi,Xt.pitch,Xt._fov),ot(pt,vr,Xt.pitch,Xt._fov)]}const an=new ut.N({range:new ut.O(ut.L.fog.range),color:new ut.O(ut.L.fog.color),"high-color":new ut.O(ut.L.fog["high-color"]),"space-color":new ut.O(ut.L.fog["space-color"]),"horizon-blend":new ut.O(ut.L.fog["horizon-blend"]),"star-intensity":new ut.O(ut.L.fog["star-intensity"]),"vertical-range":new ut.O(ut.L.fog["vertical-range"])});class lt extends ut.E{constructor(pt,wt,Tt,St){super(),this._transitionable=new ut.U(an,Tt,new Map(St)),this.set(pt,St),this._transitioning=this._transitionable.untransitioned(),this._transform=wt,this.properties=new ut.a0(an),this.scope=Tt}get state(){const pt=this._transform,wt="globe"===pt.projection.name,Tt=ut.a1(pt.zoom),St=this.properties.get("range"),It=[.5,3];return{range:wt?[ut.a2(It[0],St[0],Tt),ut.a2(It[1],St[1],Tt)]:St,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(pt,wt,Tt={}){if(this._validate(je,pt,Tt))return;const St=ut.W({},pt);for(const pt of Object.keys(ut.L.fog))void 0===St[pt]&&(St[pt]=ut.L.fog[pt].default);this._options=St,this._transitionable.setTransitionOrValue(this._options,wt)}getOpacity(pt){if(!this._transform.projection.supportsFog)return 0;const wt=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:ut.$(Vr,nn,pt))*wt.a}getOpacityAtLatLng(pt,wt){return this._transform.projection.supportsFog?function(pt,wt,Tt){const St=ut.Y.fromLngLat(wt),It=Tt.elevation?Tt.elevation.getAtPointOrZero(St):0;return at(pt,St.x,St.y,It,Tt)}(this.state,pt,wt):0}getOpacityForTile(pt){if(!this._transform.projection.supportsFog)return[1,1];const wt=this._transform.calculateFogTileMatrix(pt.toUnwrapped());return st(this.state,wt,0,0,ut.a3,ut.a3,this._transform)}getOpacityForBounds(ut,pt,wt,Tt,St){return this._transform.projection.supportsFog?st(this.state,ut,pt,wt,Tt,St,this._transform):[1,1]}getFovAdjustedRange(ut){return this._transform.projection.supportsFog?rt(this.state,ut):[0,1]}isVisibleOnFrustum(pt){if(!this._transform.projection.supportsFog)return!1;const wt=[4,5,6,7];for(const Tt of wt){const wt=pt.points[Tt];let St;if(wt[2]>=0)St=wt;else{const It=pt.points[Tt-4];St=ut.a4(It,wt,It[2]/(It[2]-wt[2]))}if(at(this.state,St[0],St[1],0,this._transform)>=sn)return!0}return!1}updateConfig(ut){this._transitionable.setTransitionOrValue(this._options,new Map(ut))}updateTransitions(ut){this._transitioning=this._transitionable.transitioned(ut,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(ut){this.properties=this._transitioning.possiblyEvaluate(ut)}_validate(pt,wt,Tt){return(!Tt||!1!==Tt.validate)&&Xe(this,pt.call(Be,ut.W({value:wt,style:{glyphs:!0,sprite:!0},styleSpec:ut.L})))}}class ct extends ut.E{constructor(pt,wt,Tt,St){super(),this.scope=Tt,this._options=pt,this.properties=new ut.a0(wt),this._transitionable=new ut.U(wt,Tt,new Map(St)),this._transitionable.setTransitionOrValue(pt.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(ut){this._transitionable.setTransitionOrValue(this._options.properties,new Map(ut))}updateTransitions(ut){this._transitioning=this._transitionable.transitioned(ut,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(ut){this.properties=this._transitioning.possiblyEvaluate(ut)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(ut,pt){this._options=ut,this._transitionable.setTransitionOrValue(ut.properties,pt)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const ln=new ut.N({color:new ut.O(ut.L.properties_light_ambient.color),intensity:new ut.O(ut.L.properties_light_ambient.intensity)}),cn=new ut.N({direction:new ut.a5(ut.L.properties_light_directional.direction),color:new ut.O(ut.L.properties_light_directional.color),intensity:new ut.O(ut.L.properties_light_directional.intensity),"cast-shadows":new ut.O(ut.L.properties_light_directional["cast-shadows"]),"shadow-intensity":new ut.O(ut.L.properties_light_directional["shadow-intensity"])});var un="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",fn="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",_n="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",gn="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",yn="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",xn="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",vn="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",bn="#ifdef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",wn="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec4 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=vec2(u_data_offset+dot(t.rg,u_data_scale.yx),-(u_data_offset+dot(t.ba,u_data_scale.yx)));velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Tn="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",En="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef NATIVE\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Mn=[];Pt(un,Mn),Pt(_n,Mn),Pt(fn,Mn);const Sn={"_prelude_fog.vertex.glsl":xn,"_prelude_terrain.vertex.glsl":yn,"_prelude_shadow.vertex.glsl":Tn,"_prelude_fog.fragment.glsl":vn,"_prelude_shadow.fragment.glsl":En,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":bn,"_prelude_raster_particle.glsl":wn},An={};At("",yn),At(vn,xn),At(En,Tn),At(bn,""),At(wn,"");const In=At(fn,_n),Pn=un;var zn={background:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:At("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:At('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:At("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:At("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:At("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:At("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nuniform float u_emissive_strength;in float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=max(0.01,cutoff_opacity(u_cutoff_params,ground.z));if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff < 0.01 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:At("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nout vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:At('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:At("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:At("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform lowp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/clamp(u_trim_fade_range[0],1e-4,1.0)));float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/clamp(u_trim_fade_range[1],1e-4,1.0)));float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=out_color.a;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trim_alpha,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED)\nin float a_z_offset;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);\n#if defined(ELEVATED)\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);\n#else\ngl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 v_uv;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}\n#endif\n#ifdef LINE_JOIN_NONE\nfloat pattern_len=pattern_size/aspect;float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED)\nin float a_z_offset;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec4 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec4 v_uv;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);\n#if defined(ELEVATED)\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 halfCellProgress=normal.yx*32.0;float ele0=elevation(pos);float ele_line=max(ele0,max(elevation(pos+halfCellProgress),elevation(pos-halfCellProgress)));float ele1=elevation(pos+offsetTile);float ele2=elevation(pos-offsetTile);float ele_max=max(ele_line,0.5*(ele1+ele2));float ele=ele_max-ele0+ele1+a_z_offset ;gl_Position=u_matrix*vec4(pos+offsetTile,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*0.1*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);\n#else\ngl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nfloat a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef LINE_JOIN_NONE\nv_width=floorwidth+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:At("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-vec2(1.0),0.0,1.0);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:At("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:At('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp float speed=velocity==INVALID_VELOCITY ? 0.0 : length(velocity);highp float reset_rate_bump=speed*u_reset_rate;highp vec2 particle_pos_min=-u_particle_pos_offset;highp vec2 particle_pos_max=vec2(1.0)+u_particle_pos_offset;highp vec2 pos_drop_rate=vec2(1.0)-step(particle_pos_min,pos)+step(particle_pos_max,pos);highp float drop_rate=max(u_reset_rate+reset_rate_bump,length(pos_drop_rate));highp float drop=step(1.0-drop_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbolIcon:At('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nin float v_fade_opacity;in vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\nout_color*=alpha;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nfloat projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);v_fade_opacity*=occludedFadeMultiplier;\n#endif\n}'),symbolSDF:At('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nfloat projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:At('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=globe_occlusion_fade;\n#ifdef SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH\nocclusion_fade*=occlusionFade(projected_point);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+ xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:At("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:At('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',gn),skyboxGradient:At('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',gn),skyboxCapture:At("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:At('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:At('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#else\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:At("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:At("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),occlusion:At("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Pt(ut,pt){const wt=ut.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let ut of wt)if(ut=ut.trim(),"#"===ut[0]&&ut.includes("if")&&!ut.includes("endif")){ut=ut.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const wt=ut.split(" ");for(const ut of wt)pt.includes(ut)||pt.push(ut)}}function At(ut,pt){const wt=/#include\s+"([^"]+)"/g,Tt=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let St=pt.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);St&&(St=St.map((ut=>{const pt=ut.split(" ");return pt[pt.length-1]})),St=[...new Set(St)]);const It={},Lt=[],Xt=[];if(ut=ut.replace(wt,((ut,pt)=>(Xt.push(pt),""))),(pt=pt.replace(wt,((ut,pt)=>(Lt.push(pt),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let Yt=[...Mn];Pt(ut,Yt),Pt(pt,Yt);for(const ut of[...Lt,...Xt])Sn[ut]||console.error(`Undefined include: ${ut}`),An[ut]||(An[ut]=[],Pt(Sn[ut],An[ut])),Yt=[...Yt,...An[ut]];return{fragmentSource:ut=ut.replace(Tt,((ut,pt,wt,Tt,St)=>(It[St]=!0,"define"===pt?`\n#ifndef HAS_UNIFORM_u_${St}\nin ${wt} ${Tt} ${St};\n#else\nuniform ${wt} ${Tt} u_${St};\n#endif\n`:"initialize"===pt?`\n#ifdef HAS_UNIFORM_u_${St}\n    ${wt} ${Tt} ${St} = u_${St};\n#endif\n`:"define-attribute"===pt?`\n#ifdef HAS_ATTRIBUTE_a_${St}\n    in ${wt} ${Tt} ${St};\n#endif\n`:"initialize-attribute"===pt?"":void 0))),vertexSource:pt=pt.replace(Tt,((ut,pt,wt,Tt,St)=>{const Lt="float"===Tt?"vec2":Tt,Xt=St.match(/color/)?"color":Lt;return"define-attribute-vertex-shader-only"===pt?`\n#ifdef HAS_ATTRIBUTE_a_${St}\nin ${wt} ${Tt} a_${St};\n#endif\n`:It[St]?"define"===pt?`\n#ifndef HAS_UNIFORM_u_${St}\nuniform lowp float u_${St}_t;\nin ${wt} ${Lt} a_${St};\nout ${wt} ${Tt} ${St};\n#else\nuniform ${wt} ${Tt} u_${St};\n#endif\n`:"initialize"===pt?"vec4"===Xt?`\n#ifndef HAS_UNIFORM_u_${St}\n    ${St} = a_${St};\n#else\n    ${wt} ${Tt} ${St} = u_${St};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${St}\n    ${St} = unpack_mix_${Xt}(a_${St}, u_${St}_t);\n#else\n    ${wt} ${Tt} ${St} = u_${St};\n#endif\n`:"define-attribute"===pt?`\n#ifdef HAS_ATTRIBUTE_a_${St}\n    in ${wt} ${Tt} a_${St};\n    out ${wt} ${Tt} ${St};\n#endif\n`:"initialize-attribute"===pt?`\n#ifdef HAS_ATTRIBUTE_a_${St}\n    ${St} = a_${St};\n#endif\n`:void 0:"define"===pt?`\n#ifndef HAS_UNIFORM_u_${St}\nuniform lowp float u_${St}_t;\nin ${wt} ${Lt} a_${St};\n#else\nuniform ${wt} ${Tt} u_${St};\n#endif\n`:"define-instanced"===pt?"mat4"===Xt?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${St}0;\nin vec4 a_${St}1;\nin vec4 a_${St}2;\nin vec4 a_${St}3;\n#else\nuniform ${wt} ${Tt} u_${St};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${wt} ${Lt} a_${St};\n#else\nuniform ${wt} ${Tt} u_${St};\n#endif\n`:"initialize-attribute-custom"===pt?`\n#ifdef HAS_ATTRIBUTE_a_${St}\n    ${wt} ${Tt} ${St} = a_${St};\n#endif\n`:"vec4"===Xt?`\n#ifndef HAS_UNIFORM_u_${St}\n    ${wt} ${Tt} ${St} = a_${St};\n#else\n    ${wt} ${Tt} ${St} = u_${St};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${St}\n    ${wt} ${Tt} ${St} = unpack_mix_${Xt}(a_${St}, u_${St}_t);\n#else\n    ${wt} ${Tt} ${St} = u_${St};\n#endif\n`})),staticAttributes:St,usedDefines:Yt,vertexIncludes:Lt,fragmentIncludes:Xt}}class Rt{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(ut,pt,wt,Tt,St,It,Lt,Xt){this.context=ut;let Yt=this.boundPaintVertexBuffers.length!==Tt.length;for(let ut=0;!Yt&&ut<Tt.length;ut++)this.boundPaintVertexBuffers[ut]!==Tt[ut]&&(Yt=!0);let Mi=this.boundDynamicVertexBuffers.length!==Lt.length;for(let ut=0;!Mi&&ut<Lt.length;ut++)this.boundDynamicVertexBuffers[ut]!==Lt[ut]&&(Mi=!0);if(!this.vao||this.boundProgram!==pt||this.boundLayoutVertexBuffer!==wt||Yt||Mi||this.boundIndexBuffer!==St||this.boundVertexOffset!==It)this.freshBind(pt,wt,Tt,St,It,Lt,Xt);else{ut.bindVertexArrayOES.set(this.vao);for(const wt of Lt)wt&&(wt.bind(),Xt&&wt.instanceCount&&wt.setVertexAttribDivisor(ut.gl,pt,Xt));St&&St.dynamicDraw&&St.bind()}}freshBind(ut,pt,wt,Tt,St,It,Lt){const Xt=ut.numAttributes,Yt=this.context,Mi=Yt.gl;this.vao&&this.destroy(),this.vao=Yt.gl.createVertexArray(),Yt.bindVertexArrayOES.set(this.vao),this.boundProgram=ut,this.boundLayoutVertexBuffer=pt,this.boundPaintVertexBuffers=wt,this.boundIndexBuffer=Tt,this.boundVertexOffset=St,this.boundDynamicVertexBuffers=It,pt.enableAttributes(Mi,ut),pt.bind(),pt.setVertexAttribPointers(Mi,ut,St);for(const pt of wt)pt.enableAttributes(Mi,ut),pt.bind(),pt.setVertexAttribPointers(Mi,ut,St);for(const pt of It)pt&&(pt.enableAttributes(Mi,ut),pt.bind(),pt.setVertexAttribPointers(Mi,ut,St),Lt&&pt.instanceCount&&pt.setVertexAttribDivisor(Mi,ut,Lt));Tt&&Tt.bind(),Yt.currentNumAttributes=Xt}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Dt(pt,wt){const Tt=Math.pow(2,wt.canonical.z),St=wt.canonical.y;return[new ut.Y(0,St/Tt).toLngLat().lat,new ut.Y(0,(St+1)/Tt).toLngLat().lat]}function Mt(pt,wt,Tt,St,It,Lt,Xt){const Yt=pt.context,Mi=Yt.gl,vr=Tt.hillshadeFBO;if(!vr)return;pt.prepareDrawTile();const br=pt.isTileAffectedByFog(wt),Ar=pt.getOrCreateProgram("hillshade",{overrideFog:br});Yt.activeTexture.set(Mi.TEXTURE0),Mi.bindTexture(Mi.TEXTURE_2D,vr.colorAttachment.get());const Vr=((pt,wt,Tt,St)=>{const It=Tt.paint.get("hillshade-shadow-color"),Lt=Tt.paint.get("hillshade-highlight-color"),Xt=Tt.paint.get("hillshade-accent-color"),Yt=Tt.paint.get("hillshade-emissive-strength");let Mi=ut.ab(Tt.paint.get("hillshade-illumination-direction"));if("viewport"===Tt.paint.get("hillshade-illumination-anchor"))Mi-=pt.transform.angle;else if(pt.style&&pt.style.enable3dLights()&&pt.style.directionalLight){const wt=pt.style.directionalLight.properties.get("direction"),Tt=ut.ac(wt.x,wt.y,wt.z);Mi=ut.ab(Tt[1])}const vr=!pt.options.moving;return{u_matrix:St||pt.transform.calculateProjMatrix(wt.tileID.toUnwrapped(),vr),u_image:0,u_latrange:Dt(0,wt.tileID),u_light:[Tt.paint.get("hillshade-exaggeration"),Mi],u_shadow:It.toRenderColor(Tt.lut),u_highlight:Lt.toRenderColor(Tt.lut),u_emissive_strength:Yt,u_accent:Xt.toRenderColor(Tt.lut)}})(pt,Tt,St,pt.terrain?wt.projMatrix:null);pt.uploadCommonUniforms(Yt,Ar,wt.toUnwrapped());const{tileBoundsBuffer:nn,tileBoundsIndexBuffer:sn,tileBoundsSegments:an}=pt.getTileBoundsBuffers(Tt);Ar.draw(pt,Mi.TRIANGLES,It,Lt,Xt,ut.af.disabled,Vr,St.id,nn,sn,an)}function zt(pt,wt,Tt){if(!wt.needsDEMTextureUpload)return;const St=pt.context,It=St.gl;St.pixelStoreUnpackPremultiplyAlpha.set(!1),wt.demTexture=wt.demTexture||pt.getTileTexture(Tt.stride);const Lt=Tt.getPixels();wt.demTexture?wt.demTexture.update(Lt,{premultiply:!1}):wt.demTexture=new ut.T(St,Lt,It.R32F,{premultiply:!1}),wt.needsDEMTextureUpload=!1}function Ot(pt,wt,Tt){const St=pt.context,It=St.gl;if(!wt.dem)return;const Lt=wt.dem;if(St.activeTexture.set(It.TEXTURE1),zt(pt,wt,Lt),!wt.demTexture)return;wt.demTexture.bind(It.NEAREST,It.CLAMP_TO_EDGE);const Xt=Lt.dim;St.activeTexture.set(It.TEXTURE0);let Yt=wt.hillshadeFBO;if(!Yt){const pt=new ut.T(St,{width:Xt,height:Xt,data:null},It.RGBA);pt.bind(It.LINEAR,It.CLAMP_TO_EDGE),Yt=wt.hillshadeFBO=St.createFramebuffer(Xt,Xt,!0,"renderbuffer"),Yt.colorAttachment.set(pt.texture)}St.bindFramebuffer.set(Yt.framebuffer),St.viewport.set([0,0,Xt,Xt]);const{tileBoundsBuffer:Mi,tileBoundsIndexBuffer:vr,tileBoundsSegments:br}=pt.getMercatorTileBoundsBuffers(),Ar=[];pt.linearFloatFilteringSupported()&&Ar.push("TERRAIN_DEM_FLOAT_FORMAT"),pt.getOrCreateProgram("hillshadePrepare",{defines:Ar}).draw(pt,It.TRIANGLES,ut.ae.disabled,ut.ag.disabled,ut.a.unblended,ut.af.disabled,((pt,wt)=>{const Tt=wt.stride,St=ut.ad.create();return ut.ad.ortho(St,0,ut.a3,-ut.a3,0,0,1),ut.ad.translate(St,St,[0,-ut.a3,0]),{u_matrix:St,u_image:1,u_dimension:[Tt,Tt],u_zoom:pt.overscaledZ}})(wt.tileID,Lt),Tt.id,Mi,vr,br),wt.needsHillshadePrepare=!1}function Ft(pt,wt,Tt,St,It){const s=function(Tt,St){if(Tt)return It(Tt);if(St){if(pt.url&&St.tiles&&pt.tiles&&delete pt.tiles,St.variants){if(!Array.isArray(St.variants))return It(new Error("variants must be an array"));for(const pt of St.variants){if(null==pt||"object"!=typeof pt||pt.constructor!==Object)return It(new Error("variant must be an object"));if(!Array.isArray(pt.capabilities))return It(new Error("capabilities must be an array"));if(1===pt.capabilities.length&&"meshopt"===pt.capabilities[0]){St=ut.W(St,pt);break}}}const Tt=ut.ah(ut.W(St,pt),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);St.vector_layers&&(Tt.vectorLayers=St.vector_layers,Tt.vectorLayerIds=Tt.vectorLayers.map((ut=>ut.id))),St.raster_layers&&(Tt.rasterLayers=St.raster_layers,Tt.rasterLayerIds=Tt.rasterLayers.map((ut=>ut.id))),Tt.tiles=wt.canonicalizeTileset(Tt,pt.url),It(null,Tt)}};return pt.url?ut.g(wt.transformRequest(wt.normalizeSourceURL(pt.url,null,Tt,St),ut.R.Source),s):ut.e.frame((()=>s(null,pt)))}class Bt{constructor(pt,wt,Tt){this.bounds=ut.ai.convert(this.validateBounds(pt)),this.minzoom=wt||0,this.maxzoom=Tt||24}validateBounds(ut){return Array.isArray(ut)&&4===ut.length?[Math.max(-180,ut[0]),Math.max(-90,ut[1]),Math.min(180,ut[2]),Math.min(90,ut[3])]:[-180,-90,180,90]}contains(pt){const wt=Math.pow(2,pt.z),Tt=Math.floor(ut.aj(this.bounds.getWest())*wt),St=Math.floor(ut.ak(this.bounds.getNorth())*wt),It=Math.ceil(ut.aj(this.bounds.getEast())*wt),Lt=Math.ceil(ut.ak(this.bounds.getSouth())*wt);return pt.x>=Tt&&pt.x<It&&pt.y>=St&&pt.y<Lt}}class kt extends ut.E{constructor(pt,wt,Tt,St){super(),this.id=pt,this.dispatcher=Tt,this.setEventedParent(St),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=ut.W({type:"raster"},wt),ut.W(this,ut.ah(wt,["url","scheme","tileSize"]))}load(pt){this._loaded=!1,this.fire(new ut.f("dataloading",{dataType:"source"})),this._tileJSONRequest=Ft(this._options,this.map._requestManager,null,null,((wt,Tt)=>{this._tileJSONRequest=null,this._loaded=!0,wt?this.fire(new ut.d(wt)):Tt&&(ut.W(this,Tt),Tt.bounds&&(this.tileBounds=new Bt(Tt.bounds,this.minzoom,this.maxzoom)),ut.an(Tt.tiles),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"content"}))),pt&&pt(wt)}))}loaded(){return this._loaded}onAdd(ut){this.map=ut,this.load()}reload(){this.cancelTileJSONRequest();const pt=ut.al(this.id,this.scope);this.load((()=>this.map.style.clearSource(pt)))}setTiles(ut){return this._options.tiles=ut,this.reload(),this}setUrl(ut){return this.url=ut,this._options.url=ut,this.reload(),this}onRemove(ut){this.cancelTileJSONRequest()}serialize(){return ut.W({},this._options)}hasTile(ut){return!this.tileBounds||this.tileBounds.contains(ut.canonical)}loadTile(pt,wt){const Tt=ut.e.devicePixelRatio>=2,St=this.map._requestManager.normalizeTileURL(pt.tileID.canonical.url(this.tiles,this.scheme),Tt,this.tileSize);pt.request=ut.h(this.map._requestManager.transformRequest(St,ut.R.Tile),((Tt,St,It,Lt)=>(delete pt.request,pt.aborted?(pt.state="unloaded",wt(null)):Tt?(pt.state="errored",wt(Tt)):St?(this.map._refreshExpiredTiles&&pt.setExpiryData({cacheControl:It,expires:Lt}),pt.setTexture(St,this.map.painter),pt.state="loaded",ut.am(this.dispatcher),void wt(null)):wt(null))))}abortTile(ut,pt){ut.request&&(ut.request.cancel(),delete ut.request),pt&&pt()}unloadTile(pt,wt){pt.texture&&pt.texture instanceof ut.T?(pt.destroy(!0),pt.texture&&pt.texture instanceof ut.T&&this.map.painter.saveTileTexture(pt.texture)):pt.destroy(),wt&&wt()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Nt extends ut.E{constructor(pt,wt,Tt,St){if(super(),this.id=pt,this.dispatcher=Tt,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,ut.W(this,ut.ah(wt,["url","scheme","tileSize","promoteId"])),this._options=ut.W({type:"vector"},wt),this._collectResourceTiming=!!wt.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(St),this._tileWorkers={},this._deduped=new ut.ao}load(pt){this._loaded=!1,this.fire(new ut.f("dataloading",{dataType:"source"}));const wt=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Tt=this.map._worldview;this._tileJSONRequest=Ft(this._options,this.map._requestManager,wt,Tt,((St,It)=>{this._tileJSONRequest=null,this._loaded=!0,St?(wt&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${wt}`),Tt&&2!==Tt.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Tt}`),this.fire(new ut.d(St))):It&&(ut.W(this,It),It.bounds&&(this.tileBounds=new Bt(It.bounds,this.minzoom,this.maxzoom)),ut.an(It.tiles,this.map._requestManager._customAccessToken),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"content"}))),pt&&pt(St)}))}loaded(){return this._loaded}hasTile(ut){return!this.tileBounds||this.tileBounds.contains(ut.canonical)}onAdd(ut){this.map=ut,this.load()}reload(){this.cancelTileJSONRequest();const pt=ut.al(this.id,this.scope);this.load((()=>this.map.style.clearSource(pt)))}setTiles(ut){return this._options.tiles=ut,this.reload(),this}setUrl(ut){return this.url=ut,this._options.url=ut,this.reload(),this}onRemove(ut){this.cancelTileJSONRequest()}serialize(){return ut.W({},this._options)}loadTile(pt,wt){const Tt=this.map._requestManager.normalizeTileURL(pt.tileID.canonical.url(this.tiles,this.scheme)),St=this.map._requestManager.transformRequest(Tt,ut.R.Tile),It=this.map.style?this.map.style.getLut(this.scope):null,Lt={request:St,data:void 0,uid:pt.uid,tileID:pt.tileID,tileZoom:pt.tileZoom,zoom:pt.tileID.overscaledZ,lut:It?{image:It.image.clone()}:null,tileSize:this.tileSize*pt.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:ut.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:pt.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:pt.isExtraShadowCaster,tessellationStep:this.map._tessellationStep};if(Lt.request.collectResourceTiming=this._collectResourceTiming,pt.actor&&"expired"!==pt.state)"loading"===pt.state?pt.reloadCallback=wt:pt.request=pt.actor.send("reloadTile",Lt,n.bind(this));else if(pt.actor=this._tileWorkers[Tt]=this._tileWorkers[Tt]||this.dispatcher.getActor(),this.dispatcher.ready)pt.request=pt.actor.send("loadTile",Lt,n.bind(this),void 0,!0);else{const wt=ut.ap.call({deduped:this._deduped},Lt,((ut,wt)=>{ut||!wt?n.call(this,ut):(Lt.data={cacheControl:wt.cacheControl,expires:wt.expires,rawData:wt.rawData.slice(0)},pt.actor&&pt.actor.send("loadTile",Lt,n.bind(this),void 0,!0))}),!0);pt.request={cancel:wt}}function n(Tt,St){return delete pt.request,pt.aborted?wt(null):Tt&&404!==Tt.status?wt(Tt):(St&&St.resourceTiming&&(pt.resourceTiming=St.resourceTiming),this.map._refreshExpiredTiles&&St&&pt.setExpiryData(St),pt.loadVectorData(St,this.map.painter),ut.am(this.dispatcher),wt(null),void(pt.reloadCallback&&(this.loadTile(pt,pt.reloadCallback),pt.reloadCallback=null)))}}abortTile(ut){ut.request&&(ut.request.cancel(),delete ut.request),ut.actor&&ut.actor.send("abortTile",{uid:ut.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(ut,pt){ut.actor&&ut.actor.send("removeTile",{uid:ut.uid,type:this.type,source:this.id,scope:this.scope}),ut.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}const Ut=pt=>({u_matrix:new ut.a6(pt),u_image0:new ut.a7(pt),u_skirt_height:new ut.aa(pt),u_ground_shadow_factor:new ut.aq(pt)}),Gt=(ut,pt,wt)=>({u_matrix:ut,u_image0:0,u_skirt_height:pt,u_ground_shadow_factor:wt}),jt=(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn)=>({u_proj_matrix:Float32Array.from(ut),u_globe_matrix:pt,u_normalize_matrix:Float32Array.from(Tt),u_merc_matrix:wt,u_zoom_transition:St,u_merc_center:It,u_image0:0,u_frustum_tl:Lt,u_frustum_tr:Xt,u_frustum_br:Yt,u_frustum_bl:Mi,u_globe_pos:vr,u_globe_radius:br,u_viewport:Ar,u_grid_matrix:sn?Float32Array.from(sn):new Float32Array(9),u_skirt_height:Vr,u_far_z_cutoff:nn});class Vt{constructor(ut=0,pt=0,wt=0,Tt=0){if(isNaN(ut)||ut<0||isNaN(pt)||pt<0||isNaN(wt)||wt<0||isNaN(Tt)||Tt<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=ut,this.bottom=pt,this.left=wt,this.right=Tt}interpolate(pt,wt,Tt){return null!=wt.top&&null!=pt.top&&(this.top=ut.a2(pt.top,wt.top,Tt)),null!=wt.bottom&&null!=pt.bottom&&(this.bottom=ut.a2(pt.bottom,wt.bottom,Tt)),null!=wt.left&&null!=pt.left&&(this.left=ut.a2(pt.left,wt.left,Tt)),null!=wt.right&&null!=pt.right&&(this.right=ut.a2(pt.right,wt.right,Tt)),this}getCenter(pt,wt){const Tt=ut.at((this.left+pt-this.right)/2,0,pt),St=ut.at((this.top+wt-this.bottom)/2,0,wt);return new ut.P(Tt,St)}equals(ut){return this.top===ut.top&&this.bottom===ut.bottom&&this.left===ut.left&&this.right===ut.right}clone(){return new Vt(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Wt(pt,wt){const Tt=ut.aw(pt,3);ut.ad.fromQuat(pt,wt),ut.az(pt,3,Tt)}function Zt(pt,wt){const Tt=ut.av.identity([]);return ut.av.rotateZ(Tt,Tt,-wt),ut.av.rotateX(Tt,Tt,-pt),Tt}function qt(pt,wt){const Tt=[pt[0],pt[1],0],St=[wt[0],wt[1],0];if(ut._.length(Tt)>=1e-15){const pt=ut._.normalize([],Tt);ut._.scale(St,pt,ut._.dot(St,pt)),wt[0]=St[0],wt[1]=St[1]}const It=ut._.cross([],wt,pt);if(ut._.len(It)<1e-15)return null;const Lt=Math.atan2(-It[1],It[0]);return Zt(Math.atan2(Math.sqrt(pt[0]*pt[0]+pt[1]*pt[1]),-pt[2]),Lt)}class Ht{constructor(ut,pt){this.position=ut,this.orientation=pt}get position(){return this._position}set position(pt){if(pt){const wt=pt instanceof ut.Y?pt:new ut.Y(pt[0],pt[1],pt[2]);this._renderWorldCopies&&(wt.x=ut.au(wt.x,0,1)),this._position=wt}else this._position=null}lookAtPoint(pt,wt){if(this.orientation=null,!this.position)return;const Tt=this.position,St=this._elevation?this._elevation.getAtPointOrZero(ut.Y.fromLngLat(pt)):0,It=ut.Y.fromLngLat(pt,St),Lt=[It.x-Tt.x,It.y-Tt.y,It.z-Tt.z];wt||(wt=[0,0,1]),wt[2]=Math.abs(wt[2]),this.orientation=qt(Lt,wt)}setPitchBearing(pt,wt){this.orientation=Zt(ut.ab(pt),ut.ab(-wt))}}class $t{constructor(pt,wt){this._transform=ut.ad.identity([]),this.orientation=wt,this.position=pt}get mercatorPosition(){const pt=this.position;return new ut.Y(pt[0],pt[1],pt[2])}get position(){const pt=ut.aw(this._transform,3);return[pt[0],pt[1],pt[2]]}set position(pt){var wt;pt&&ut.az(this._transform,3,[(wt=pt)[0],wt[1],wt[2],1])}get orientation(){return this._orientation}set orientation(pt){this._orientation=pt||ut.av.identity([]),pt&&Wt(this._transform,this._orientation)}getPitchBearing(){const ut=this.forward(),pt=this.right();return{bearing:Math.atan2(-pt[1],pt[0]),pitch:Math.atan2(Math.sqrt(ut[0]*ut[0]+ut[1]*ut[1]),-ut[2])}}setPitchBearing(ut,pt){this._orientation=Zt(ut,pt),Wt(this._transform,this._orientation)}forward(){const pt=ut.aw(this._transform,2);return[-pt[0],-pt[1],-pt[2]]}up(){const pt=ut.aw(this._transform,1);return[-pt[0],-pt[1],-pt[2]]}right(){const pt=ut.aw(this._transform,0);return[pt[0],pt[1],pt[2]]}getCameraToWorld(pt,wt){const Tt=new Float64Array(16);return ut.ad.invert(Tt,this.getWorldToCamera(pt,wt)),Tt}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(pt,wt,Tt){const St=this.position;ut._.scale(St,St,-pt);const It=new Float64Array(16);return ut.ad.fromScaling(It,[Tt,Tt,Tt]),ut.ad.translate(It,It,St),It[10]*=wt,It}getWorldToCamera(pt,wt){const Tt=new Float64Array(16),St=new Float64Array(4),It=this.position;return ut.av.conjugate(St,this._orientation),ut._.scale(It,It,-pt),ut.ad.fromQuat(Tt,St),ut.ad.translate(Tt,Tt,It),Tt[1]*=-1,Tt[5]*=-1,Tt[9]*=-1,Tt[13]*=-1,Tt[8]*=wt,Tt[9]*=wt,Tt[10]*=wt,Tt[11]*=wt,Tt}getCameraToClipPerspective(pt,wt,Tt,St){const It=new Float64Array(16);return ut.ad.perspective(It,pt,wt,Tt,St),It}getCameraToClipOrthographic(pt,wt,Tt,St,It,Lt){const Xt=new Float64Array(16);return ut.ad.ortho(Xt,pt,wt,Tt,St,It,Lt),Xt}getDistanceToElevation(pt,wt=!1){const Tt=0===pt?0:ut.ax(pt,wt?ut.ay(this.position[1]):this.position[1]),St=this.forward();return(Tt-this.position[2])/St[2]}clone(){return new $t([...this.position],[...this.orientation])}}const Ln={unknown:0,flipRequired:1,flipNotRequired:2},kn=Math.tan(85*Math.PI/180);function Kt(pt,wt,Tt,St,It,Lt,Xt){const Yt=ut.ad.create();if(Tt)if("globe"===Lt.name){const pt=ut.aB(It,wt);ut.ad.multiply(Yt,Yt,pt)}else{const pt=ut.aC.invert([],Xt);Yt[0]=pt[0],Yt[1]=pt[1],Yt[4]=pt[2],Yt[5]=pt[3],St||ut.ad.rotateZ(Yt,Yt,It.angle)}else ut.ad.multiply(Yt,It.labelPlaneMatrix,pt);return Yt}function Qt(ut,pt,wt,Tt,St,It,Lt){const Xt=Kt(ut,pt,wt,Tt,St,It,Lt);return"globe"===It.name&&wt||(Xt[2]=Xt[6]=Xt[10]=Xt[14]=0),Xt}function Jt(pt,wt,Tt,St,It,Lt,Xt){if(Tt){if("globe"===Lt.name){const Yt=Kt(pt,wt,Tt,St,It,Lt,Xt);return ut.ad.invert(Yt,Yt),ut.ad.multiply(Yt,pt,Yt),Yt}{const wt=ut.ad.clone(pt),Tt=ut.ad.identity([]);return Tt[0]=Xt[0],Tt[1]=Xt[1],Tt[4]=Xt[2],Tt[5]=Xt[3],ut.ad.multiply(wt,wt,Tt),St||ut.ad.rotateZ(wt,wt,-It.angle),wt}}return It.glCoordMatrix}function ei(pt,wt,Tt,St){const It=[pt,wt,Tt,1];Tt?ut.aA.transformMat4(It,It,St):ui(It,It,St);const Lt=It[3];return It[0]/=Lt,It[1]/=Lt,It[2]/=Lt,It}function ti(ut,pt){return Math.min(.5+ut/pt*.5,1.5)}function ii(ut,pt){const wt=ut[0]/ut[3],Tt=ut[1]/ut[3];return wt>=-pt[0]&&wt<=pt[0]&&Tt>=-pt[1]&&Tt<=pt[1]}function oi(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr){const br=Tt.transform,Ar=St?pt.textSizeData:pt.iconSizeData,Vr=ut.aD(Ar,Tt.transform.zoom),nn="globe"===br.projection.name,sn=[256/Tt.width*2+1,256/Tt.height*2+1],an=St?pt.text.dynamicLayoutVertexArray:pt.icon.dynamicLayoutVertexArray;an.clear();let ln=null;nn&&(ln=St?pt.text.globeExtVertexArray:pt.icon.globeExtVertexArray);const cn=pt.lineVertexArray,un=St?pt.text.placedSymbolArray:pt.icon.placedSymbolArray,fn=Tt.transform.width/Tt.transform.height;let _n,gn=!1;for(let St=0;St<un.length;St++){const nn=un.get(St),{numGlyphs:yn,writingMode:xn}=nn;if(xn!==ut.aE.vertical||gn||_n===ut.aE.horizontal||(gn=!0),_n=xn,(nn.hidden||xn===ut.aE.vertical)&&!gn){hi(yn,an);continue}gn=!1;const vn=new ut.P(nn.tileAnchorX,nn.tileAnchorY);let{x:bn,y:wn,z:Tn}=br.projection.projectTilePoint(vn.x,vn.y,vr.canonical);if(Mi){const[ut,pt,wt]=Mi(vn);bn+=ut,wn+=pt,Tn+=wt}const En=[bn,wn,Tn,1];if(ut.aA.transformMat4(En,En,wt),!ii(En,sn)){hi(yn,an);continue}const Mn=En[3],Sn=ti(Tt.transform.getCameraToCenterDistance(br.projection),Mn),An=ut.aF(Ar,Vr,nn),In=Xt?An/Sn:An*Sn,Pn=ei(bn,wn,Tn,It);if(Pn[3]<=0){hi(yn,an);continue}let zn={};const Ln=Xt?null:Mi,kn=si(nn,In,!1,Yt,wt,It,Lt,pt.glyphOffsetArray,cn,an,ln,Pn,vn,zn,fn,Ln,br.projection,vr,Xt);gn=kn.useVertical,Ln&&kn.needsFlipping&&(zn={}),(kn.notEnoughRoom||gn||kn.needsFlipping&&si(nn,In,!0,Yt,wt,It,Lt,pt.glyphOffsetArray,cn,an,ln,Pn,vn,zn,fn,Ln,br.projection,vr,Xt).notEnoughRoom)&&hi(yn,an)}St?(pt.text.dynamicLayoutVertexBuffer.updateData(an),ln&&pt.text.globeExtVertexBuffer&&pt.text.globeExtVertexBuffer.updateData(ln)):(pt.icon.dynamicLayoutVertexBuffer.updateData(an),ln&&pt.icon.globeExtVertexBuffer&&pt.icon.globeExtVertexBuffer.updateData(ln))}function ri(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){const{lineStartIndex:an,glyphStartIndex:ln,segment:cn}=Xt,un=ln+Xt.numGlyphs,fn=an+Xt.lineLength,_n=pt.getoffsetX(ln),gn=pt.getoffsetX(un-1),yn=ci(ut*_n,wt,Tt,St,It,Lt,cn,an,fn,Yt,Mi,vr,br,Ar,!0,Vr,nn,sn);if(!yn)return null;const xn=ci(ut*gn,wt,Tt,St,It,Lt,cn,an,fn,Yt,Mi,vr,br,Ar,!0,Vr,nn,sn);return xn?{first:yn,last:xn}:null}function ai(pt,wt,Tt,St){return pt===ut.aE.horizontal&&Math.abs(St)>Math.abs(Tt)?{useVertical:!0}:pt===ut.aE.vertical?St>0?{needsFlipping:!0}:null:wt!==Ln.unknown&&function(ut,pt){return 0===ut||Math.abs(pt/ut)>kn}(Tt,St)?wt===Ln.flipRequired?{needsFlipping:!0}:null:Tt<0?{needsFlipping:!0}:null}function si(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un){const fn=wt/24,_n=pt.lineOffsetX*fn,gn=pt.lineOffsetY*fn,{lineStartIndex:yn,glyphStartIndex:xn,numGlyphs:vn,segment:bn,writingMode:wn,flipState:Tn}=pt,En=yn+pt.lineLength,A=pt=>{if(br){const[wt,Tt,St]=pt.up,It=vr.length;ut.aG(br,It+0,wt,Tt,St),ut.aG(br,It+1,wt,Tt,St),ut.aG(br,It+2,wt,Tt,St),ut.aG(br,It+3,wt,Tt,St)}const[wt,Tt,St]=pt.point;ut.aH(vr,wt,Tt,St,pt.angle)};if(vn>1){const ut=ri(fn,Yt,_n,gn,Tt,Ar,Vr,pt,Mi,Lt,nn,an,!1,ln,cn,un);if(!ut)return{notEnoughRoom:!0};if(St&&!Tt){let[wt,Tt,St]=ut.first.point,[It,Lt,Yt]=ut.last.point;[wt,Tt]=ei(wt,Tt,St,Xt),[It,Lt]=ei(It,Lt,Yt,Xt);const Mi=ai(wn,Tn,(It-wt)*sn,Lt-Tt);if(pt.flipState=Mi&&Mi.needsFlipping?Ln.flipRequired:Ln.flipNotRequired,Mi)return Mi}A(ut.first);for(let ut=xn+1;ut<xn+vn-1;ut++){const pt=ci(fn*Yt.getoffsetX(ut),_n,gn,Tt,Ar,Vr,bn,yn,En,Mi,Lt,nn,an,!1,!1,ln,cn,un);if(!pt)return vr.length-=4*(ut-xn),{notEnoughRoom:!0};A(pt)}A(ut.last)}else{if(St&&!Tt){const wt=ei(Vr.x,Vr.y,0,It),Tt=yn+bn+1,St=new ut.P(Mi.getx(Tt),Mi.gety(Tt)),Lt=ei(St.x,St.y,0,It),Xt=Lt[3]>0?Lt:li(Vr,St,wt,1,It,void 0,ln,cn.canonical),Yt=ai(wn,Tn,(Xt[0]-wt[0])*sn,Xt[1]-wt[1]);if(pt.flipState=Yt&&Yt.needsFlipping?Ln.flipRequired:Ln.flipNotRequired,Yt)return Yt}const wt=ci(fn*Yt.getoffsetX(xn),_n,gn,Tt,Ar,Vr,bn,yn,En,Mi,Lt,nn,an,!1,!1,ln,cn,un);if(!wt)return{notEnoughRoom:!0};A(wt)}return{}}function ni(ut,pt,wt,Tt,St){const{x:It,y:Lt,z:Xt}=Tt.projectTilePoint(ut.x,ut.y,pt);if(!St)return ei(It,Lt,Xt,wt);const[Yt,Mi,vr]=St(ut);return ei(It+Yt,Lt+Mi,Xt+vr,wt)}function li(pt,wt,Tt,St,It,Lt,Xt,Yt){const Mi=ni(pt.sub(wt)._unit()._add(pt),Yt,It,Xt,Lt);return ut._.sub(Mi,Tt,Mi),ut._.normalize(Mi,Mi),ut._.scaleAndAdd(Mi,Tt,Mi,St)}function ci(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn){const un=St?pt-wt:pt+wt;let fn=un>0?1:-1,_n=0;St&&(fn*=-1,_n=Math.PI),fn<0&&(_n+=Math.PI);let gn=Yt+Xt+(fn>0?0:1)|0,yn=It,xn=It,vn=0,bn=0;const wn=Math.abs(un),Tn=[],En=[];let Mn=Lt,Sn=Mn;const D=()=>li(Sn,Mn,xn,wn-vn+1,br,Vr,an,ln.canonical);for(;vn+bn<=wn;){if(gn+=fn,gn<Yt||gn>=Mi)return null;if(xn=yn,Sn=Mn,Tn.push(xn),nn&&En.push(Sn),Mn=new ut.P(vr.getx(gn),vr.gety(gn)),yn=Ar[gn],!yn){const ut=ni(Mn,ln.canonical,br,an,Vr);yn=ut[3]>0?Ar[gn]=ut:D()}vn+=bn,bn=ut._.distance(xn,yn)}sn&&Vr&&(Ar[gn]&&(yn=D(),bn=ut._.distance(xn,yn)),Ar[gn]=yn);const An=(wn-vn)/bn,In=Mn.sub(Sn)._mult(An)._add(Sn),Pn=ut._.sub([],yn,xn),zn=ut._.scaleAndAdd([],xn,Pn,An);let Ln=[0,0,1],kn=Pn[0],Bn=Pn[1];if(cn&&(Ln=an.upVector(ln.canonical,In.x,In.y),0!==Ln[0]||0!==Ln[1]||1!==Ln[2])){const pt=[Ln[2],0,-Ln[0]],wt=ut._.cross([],Ln,pt);ut._.normalize(pt,pt),ut._.normalize(wt,wt),kn=ut._.dot(Pn,pt),Bn=ut._.dot(Pn,wt)}if(Tt){const pt=ut._.cross([],Ln,Pn);ut._.normalize(pt,pt),ut._.scaleAndAdd(zn,zn,pt,Tt*fn)}const Wn=_n+Math.atan2(Bn,kn);return Tn.push(zn),nn&&En.push(In),{point:zn,angle:Wn,path:Tn,tilePath:En,up:Ln}}function hi(ut,pt){const wt=pt.length,Tt=wt+4*ut;pt.resize(Tt),pt.float32.fill(-1/0,4*wt,4*Tt)}function ui(ut,pt,wt){const Tt=pt[0],St=pt[1];return ut[0]=wt[0]*Tt+wt[4]*St+wt[12],ut[1]=wt[1]*Tt+wt[5]*St+wt[13],ut[3]=wt[3]*Tt+wt[7]*St+wt[15],ut}const _i=(ut,pt,wt)=>(1-wt)*ut+wt*pt,di=ut=>ut*ut*ut*ut*ut;class pi{constructor(pt,wt,Tt,St,It,Lt,Xt){this.tileSize=512,this._renderWorldCopies=void 0===It||It,this._minZoom=pt||0,this._maxZoom=wt||22,this._minPitch=Tt??0,this._maxPitch=St??60,this.setProjection(Lt),this.setMaxBounds(Xt),this.width=0,this.height=0,this._center=new ut.aI(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Vt,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $t,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const ut=new pi(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return ut._elevation=this._elevation,ut._centerAltitude=this._centerAltitude,ut._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,ut.tileSize=this.tileSize,ut.mercatorFromTransition=this.mercatorFromTransition,ut.width=this.width,ut.height=this.height,ut.cameraElevationReference=this.cameraElevationReference,ut._center=this._center,ut._setZoom(this.zoom),ut._seaLevelZoom=this._seaLevelZoom,ut.angle=this.angle,ut._fov=this._fov,ut._pitch=this._pitch,ut._nearZ=this._nearZ,ut._farZ=this._farZ,ut._averageElevation=this._averageElevation,ut._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,ut._unmodified=this._unmodified,ut._edgeInsets=this._edgeInsets.clone(),ut._camera=this._camera.clone(),ut._calcMatrices(),ut.freezeTileCoverage=this.freezeTileCoverage,ut.frustumCorners=this.frustumCorners,ut}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(ut){this._elevation!==ut&&(this._elevation=ut,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(ut,pt=!1){const wt=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||wt)&&this._updateCameraOnTerrain(),(ut||wt)&&this._constrainCamera(pt),this._calcMatrices()}getProjection(){return ut.ah(this.projection,["name","center","parallels"])}setProjection(pt){this.projectionOptions=pt||{name:"mercator"};const wt=this.projection?this.getProjection():void 0;this.projection=ut.aJ(this.projectionOptions);const Tt=!t(wt,this.getProjection());return Tt&&this._calcMatrices(),this.mercatorFromTransition=!1,Tt}setOrthographicProjectionAtLowPitch(ut){return this._orthographicProjectionAtLowPitch!==ut&&(this._orthographicProjectionAtLowPitch=ut,this._calcMatrices(),!0)}setMercatorFromTransition(){const pt=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=ut.aJ({name:"mercator"});const wt=pt!==this.projection.name;return wt&&this._calcMatrices(),wt}get minZoom(){return this._minZoom}set minZoom(ut){this._minZoom!==ut&&(this._minZoom=ut,this.zoom=Math.max(this.zoom,ut))}get maxZoom(){return this._maxZoom}set maxZoom(ut){this._maxZoom!==ut&&(this._maxZoom=ut,this.zoom=Math.min(this.zoom,ut))}get minPitch(){return this._minPitch}set minPitch(ut){this._minPitch!==ut&&(this._minPitch=ut,this.pitch=Math.max(this.pitch,ut))}get maxPitch(){return this._maxPitch}set maxPitch(ut){this._maxPitch!==ut&&(this._maxPitch=ut,this.pitch=Math.min(this.pitch,ut))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(ut){void 0===ut?ut=!0:null===ut&&(ut=!1),this._renderWorldCopies=ut}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const ut=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(ut))}get cameraWorldSize(){const ut=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(ut))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return ut.ax(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new ut.P(this.width,this.height)}get bearing(){return ut.au(this.rotation,-180,180)}set bearing(ut){this.rotation=ut}get rotation(){return-this.angle/Math.PI*180}set rotation(pt){const wt=-pt*Math.PI/180;this.angle!==wt&&(this._unmodified=!1,this.angle=wt,this._calcMatrices(),this.rotationMatrix=ut.aC.create(),ut.aC.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(pt){const wt=ut.at(pt,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==wt&&(this._unmodified=!1,this._pitch=wt,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const ut=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/ut)}set fov(pt){pt=Math.max(.01,Math.min(60,pt)),this._fov!==pt&&(this._unmodified=!1,this._fov=ut.ab(pt),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(ut){this._averageElevation=ut,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(ut){const pt=Math.min(Math.max(ut,this.minZoom),this.maxZoom);this._zoom!==pt&&(this._unmodified=!1,this._setZoom(pt),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(ut){this._zoom=ut,this.scale=this.zoomScale(ut),this.tileZoom=Math.floor(ut),this.zoomFraction=ut-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(ut){this._tileCoverLift!==ut&&(this._tileCoverLift=ut)}_updateCameraOnTerrain(){const ut=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,pt=this.elevation&&ut===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||ut===Number.NEGATIVE_INFINITY&&(!pt||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const wt=this._elevation;pt||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&wt.exaggeration()&&this._centerAltitudeValidForExaggeration!==wt.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*wt.exaggeration(),this._centerAltitudeValidForExaggeration=wt.exaggeration()):(this._centerAltitude=ut||0,this._centerAltitudeValidForExaggeration=wt.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const pt=this._elevation,wt=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],Tt=this.horizonLineFromTop();let St=0,It=0;for(let Lt=0;Lt<wt.length;Lt++){const Xt=new ut.P(wt[Lt][0]*this.width,Tt+wt[Lt][1]*(this.height-Tt)),Yt=pt.pointCoordinate(Xt);if(!Yt)continue;const Mi=1/Math.hypot(Yt[0]-this._camera.position[0],Yt[1]-this._camera.position[1]);St+=Yt[3]*Mi,It+=Mi}return 0===It?NaN:St/It}get center(){return this._center}set center(ut){ut.lat===this._center.lat&&ut.lng===this._center.lng||(this._unmodified=!1,this._center=ut,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const ut=this._seaLevelZoom,pt=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),wt=this.pixelsPerMeter/this.worldSize*pt,Tt=this._mercatorZfromZoom(ut),St=this._mercatorZfromZoom(this._maxZoom),It=Math.max(Tt-wt,St);this._setZoom(this._zoomFromMercatorZ(It))}get padding(){return this._edgeInsets.toJSON()}set padding(ut){this._edgeInsets.equals(ut)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,ut,1),this._calcMatrices())}computeZoomRelativeTo(pt){const wt=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,pt.toAltitude()));let Tt;Tt=pt.z<this._camera.position[2]?[wt.x,wt.y,wt.z]:[pt.x,pt.y,pt.z];const St=ut._.length(ut._.sub([],this._camera.position,Tt));return ut.at(this._zoomFromMercatorZ(St),this._minZoom,this._maxZoom)}setFreeCameraOptions(pt){if(!this.height)return;if(!pt.position&&!pt.orientation)return;this._updateCameraState();let wt=!1;if(pt.orientation&&!ut.av.exactEquals(pt.orientation,this._camera.orientation)&&(wt=this._setCameraOrientation(pt.orientation)),pt.position){const Tt=[pt.position.x,pt.position.y,pt.position.z];ut._.exactEquals(Tt,this._camera.position)||(this._setCameraPosition(Tt),wt=!0)}wt&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const pt=this._camera.position,wt=new Ht;return wt.position=new ut.Y(pt[0],pt[1],pt[2]),wt.orientation=this._camera.orientation,wt._elevation=this.elevation,wt._renderWorldCopies=this.renderWorldCopies,wt}_setCameraOrientation(pt){if(!ut.av.length(pt))return!1;ut.av.normalize(pt,pt);const wt=ut._.transformQuat([],[0,0,-1],pt),Tt=ut._.transformQuat([],[0,-1,0],pt);if(Tt[2]<0)return!1;const St=qt(wt,Tt);return!!St&&(this._camera.orientation=St,!0)}_setCameraPosition(pt){const wt=this.zoomScale(this.minZoom)*this.tileSize,Tt=this.zoomScale(this.maxZoom)*this.tileSize,St=this.cameraToCenterDistance;pt[2]=ut.at(pt[2],St/Tt,St/wt),this._camera.position=pt}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(ut){return this._edgeInsets.equals(ut)}interpolatePadding(ut,pt,wt){this._unmodified=!1,this._edgeInsets.interpolate(ut,pt,wt),this._constrain(),this._calcMatrices()}coveringZoomLevel(ut){const pt=(ut.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/ut.tileSize));return Math.max(0,pt)}getVisibleUnwrappedCoordinates(pt){const wt=[new ut.aK(0,pt)];if(this.renderWorldCopies){const Tt=this.pointCoordinate(new ut.P(0,0)),St=this.pointCoordinate(new ut.P(this.width,0)),It=this.pointCoordinate(new ut.P(this.width,this.height)),Lt=this.pointCoordinate(new ut.P(0,this.height)),Xt=Math.floor(Math.min(Tt.x,St.x,It.x,Lt.x)),Yt=Math.floor(Math.max(Tt.x,St.x,It.x,Lt.x)),Mi=1;for(let Tt=Xt-Mi;Tt<=Yt+Mi;Tt++)0!==Tt&&wt.push(new ut.aK(Tt,pt))}return wt}isLODDisabled(ut){return(!ut||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(pt,wt,Tt){let St=[];if(0===wt[0]&&0===wt[1])return St;for(const Tt of pt){const pt=Tt.canonical,It=Tt.overscaledZ,Lt=Tt.wrap,Xt=1<<pt.z,Yt=pt.x+1<Xt,Mi=pt.x>0,vr=pt.y+1<Xt,br=pt.y>0,Ar=Tt.wrap-(Mi?0:1),Vr=Tt.wrap+(Yt?0:1),nn=Mi?pt.x-1:Xt-1,sn=Yt?pt.x+1:0;wt[0]<0?(St.push(new ut.aL(It,Vr,pt.z,sn,pt.y)),wt[1]<0&&vr&&(St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y+1)),St.push(new ut.aL(It,Vr,pt.z,sn,pt.y+1))),wt[1]>0&&br&&(St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y-1)),St.push(new ut.aL(It,Vr,pt.z,sn,pt.y-1)))):wt[0]>0?(St.push(new ut.aL(It,Ar,pt.z,nn,pt.y)),wt[1]<0&&vr&&(St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y+1)),St.push(new ut.aL(It,Ar,pt.z,nn,pt.y+1))),wt[1]>0&&br&&(St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y-1)),St.push(new ut.aL(It,Ar,pt.z,nn,pt.y-1)))):wt[1]<0&&vr?St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y+1)):br&&St.push(new ut.aL(It,Lt,pt.z,pt.x,pt.y-1))}if(St.length>1){St.sort(((ut,pt)=>ut.overscaledZ-pt.overscaledZ||ut.wrap-pt.wrap||ut.canonical.z-pt.canonical.z||ut.canonical.x-pt.canonical.x||ut.canonical.y-pt.canonical.y));let ut=0,pt=0;for(;pt<St.length;)St[pt].equals(St[ut])?++pt:St[++ut]=St[pt++];St.length=ut+1}const It=[];for(const ut of St)St.some((pt=>ut.isChildOf(pt)))||It.push(ut);return St=It.filter((ut=>!pt.some((pt=>!!(ut.overscaledZ<Tt&&pt.isChildOf(ut))||ut.equals(pt)||ut.isChildOf(pt))))),St}coveringTiles(pt){let wt=this.coveringZoomLevel(pt);const Tt=wt,St=this.elevation&&this.elevation.exaggeration(),It=St&&!pt.isTerrainDEM,Lt="mercator"===this.projection.name;if(void 0!==pt.minzoom&&wt<pt.minzoom)return[];void 0!==pt.maxzoom&&wt>pt.maxzoom&&(wt=pt.maxzoom);const Xt=this.locationCoordinate(this.center),Yt=this.center.lat,Mi=1<<wt,vr=[Mi*Xt.x,Mi*Xt.y,0],br="globe"===this.projection.name,Ar=!br,Vr=ut.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,wt,Ar),nn=br?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),sn=Mi*ut.ax(1,this.center.lat),an=this._camera.position[2]/ut.ax(1,this.center.lat),ln=[Mi*nn.x,Mi*nn.y,an*(Ar?1:sn)],cn=br||St,un=this.cameraToCenterDistance/pt.tileSize*(pt.roundZoom?1:.502),fn=this.isLODDisabled(!0)?wt:0;let _n;if(this._elevation&&pt.isTerrainDEM)_n=1e4*this._elevation.exaggeration();else if(this._elevation){const ut=this._elevation.getMinMaxForVisibleTiles();_n=ut?ut.max:this._centerAltitude}else _n=this._centerAltitude;const gn=pt.isTerrainDEM?-_n:this._elevation?this._elevation.getMinElevationBelowMSL():0,yn=this.projection.isReprojectedInTileSpace?ut.aN(this):1,E=pt=>{const wt=1/4e4,Tt=new ut.Y(pt.x+wt,pt.y,pt.z),St=new ut.Y(pt.x,pt.y+wt,pt.z),It=pt.toLngLat(),Lt=Tt.toLngLat(),Xt=St.toLngLat(),Yt=this.locationCoordinate(It),Mi=this.locationCoordinate(Lt),vr=this.locationCoordinate(Xt),br=Math.hypot(Mi.x-Yt.x,Mi.y-Yt.y),Ar=Math.hypot(vr.x-Yt.x,vr.y-Yt.y);return Math.sqrt(br*Ar)*yn/wt},C=pt=>{const wt=_n,Tt=gn;return{aabb:ut.aQ(this,Mi,0,0,0,pt,Tt,wt,this.projection),zoom:0,x:0,y:0,minZ:Tt,maxZ:wt,wrap:pt,fullyVisible:!1}},xn=[];let vn=[];const bn=wt,wn=pt.reparseOverscaled?Tt:wt,A=ut=>ut*ut,Tn=A((an-this._centerAltitude)*sn),D=ut=>{if(!this._elevation||!ut.tileID||!Lt)return;const pt=this._elevation.getMinMaxForTile(ut.tileID),wt=ut.aabb;pt?(wt.min[2]=pt.min,wt.max[2]=pt.max,wt.center[2]=(wt.min[2]+wt.max[2])/2):(ut.shouldSplit=M(ut),ut.shouldSplit||(wt.min[2]=wt.max[2]=wt.center[2]=this._centerAltitude))},M=pt=>{if(pt.zoom<fn)return!0;if(pt.zoom===bn)return!1;if(null!=pt.shouldSplit)return pt.shouldSplit;const wt=pt.aabb.distanceX(ln),St=pt.aabb.distanceY(ln);let Lt=Tn,Xt=1;if(br){Lt=A(pt.aabb.distanceZ(ln));const wt=Math.pow(2,pt.zoom),Tt=ut.ay((pt.y+1)/wt),St=ut.ay(pt.y/wt),It=Math.min(Math.max(Yt,Tt),St),Mi=ut.b4(It)/ut.b4(Yt);if(Xt=It===Yt?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Mi/this._mercatorScaleRatio),this.zoom<=ut.b1&&pt.zoom===bn-1&&Mi>=.9)return!0}else if(It&&(Lt=A(pt.aabb.distanceZ(ln)*sn)),this.projection.isReprojectedInTileSpace&&Tt<=5){const wt=Math.pow(2,pt.zoom),Tt=E(new ut.Y((pt.x+.5)/wt,(pt.y+.5)/wt));Xt=Tt>.85?1:Tt}const Mi=wt*wt+St*St+Lt,vr=A((1<<bn-pt.zoom)*un*Xt*((ut,pt)=>{if(pt*A(.707)<ut)return 1;const wt=Math.sqrt(pt/ut);return wt/(1.4144271570014144+(Math.pow(1.1,wt-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(Lt,Tn),Mi));return Mi<vr};if(this.renderWorldCopies)for(let ut=1;ut<=3;ut++)xn.push(C(-ut)),xn.push(C(ut));for(xn.push(C(0));xn.length>0;){const Tt=xn.pop(),St=Tt.x,Xt=Tt.y;let Yt=Tt.fullyVisible;const _=()=>"globe"===this.projection.name&&(0===Tt.y||Tt.y===(1<<Tt.zoom)-1);if(!Yt){let pt=cn?Tt.aabb.intersects(Vr):Tt.aabb.intersectsFlat(Vr);if(0===pt&&_()){const wt=new ut.aO(Tt.zoom,St,Xt);pt=ut.aP(this,Mi,wt,!0).intersects(Vr)}if(0===pt)continue;Yt=2===pt}if(Tt.zoom!==bn&&M(Tt))for(let pt=0;pt<4;pt++){const wt=(St<<1)+pt%2,vr=(Xt<<1)+(pt>>1),Ar={aabb:Lt?Tt.aabb.quadrant(pt):ut.aQ(this,Mi,Tt.zoom+1,wt,vr,Tt.wrap,Tt.minZ,Tt.maxZ,this.projection),zoom:Tt.zoom+1,x:wt,y:vr,wrap:Tt.wrap,fullyVisible:Yt,tileID:void 0,shouldSplit:void 0,minZ:Tt.minZ,maxZ:Tt.maxZ};It&&!br&&(Ar.tileID=new ut.aL(Tt.zoom+1===bn?wn:Tt.zoom+1,Tt.wrap,Tt.zoom+1,wt,vr),D(Ar)),xn.push(Ar)}else{const It=Tt.zoom===bn?wn:Tt.zoom;if(pt.minzoom&&pt.minzoom>It)continue;if(!Yt){let pt=cn?Tt.aabb.intersectsPrecise(Vr):Tt.aabb.intersectsPreciseFlat(Vr);if(0===pt&&_()){const wt=new ut.aO(Tt.zoom,St,Xt);pt=ut.aP(this,Mi,wt,!0).intersectsPrecise(Vr)}if(0===pt)continue}const Lt=vr[0]-(.5+St+(Tt.wrap<<Tt.zoom))*(1<<wt-Tt.zoom),br=vr[1]-.5-Xt,Ar=Tt.tileID?Tt.tileID:new ut.aL(It,Tt.wrap,Tt.zoom,St,Xt);vn.push({tileID:Ar,distanceSq:Lt*Lt+br*br})}}if(this.fogCullDistSq){const wt=this.fogCullDistSq,Tt=this.horizonLineFromTop();vn=vn.filter((St=>{const It=[0,0,0,1],Lt=[ut.a3,ut.a3,0,1],Xt=this.calculateFogTileMatrix(St.tileID.toUnwrapped());ut.aA.transformMat4(It,It,Xt),ut.aA.transformMat4(Lt,Lt,Xt);const Yt=ut.aA.min([],It,Lt),Mi=ut.aA.max([],It,Lt),vr=ut.aR(Yt,Mi);if(0===vr)return!0;let br=!1;const Ar=this._elevation;if(Ar&&vr>wt&&0!==Tt){const wt=this.calculateProjMatrix(St.tileID.toUnwrapped());let It;pt.isTerrainDEM||(It=Ar.getMinMaxForTile(St.tileID)),It||(It={min:gn,max:_n});const Lt=ut.b2(this.rotation),Xt=[Lt[0]*ut.a3,Lt[1]*ut.a3,It.max];ut._.transformMat4(Xt,Xt,wt),br=(1-Xt[1])*this.height*.5<Tt}return vr<wt||br}))}return vn.sort(((ut,pt)=>ut.distanceSq-pt.distanceSq)).map((ut=>ut.tileID))}resize(ut,pt){this.width=ut,this.height=pt,this.pixelsToGLUnits=[2/ut,-2/pt],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(ut){return Math.pow(2,ut)}scaleZoom(ut){return Math.log(ut)/Math.LN2}project(pt){const wt=ut.at(pt.lat,-ut.aS,ut.aS),Tt=this.projection.project(pt.lng,wt);return new ut.P(Tt.x*this.worldSize,Tt.y*this.worldSize)}unproject(ut){return this.projection.unproject(ut.x/this.worldSize,ut.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/ut.ax(1,this.center.lat)/this.worldSize}setLocationAtPoint(pt,wt){let Tt,St;const It=this.centerPoint;if("globe"===this.projection.name){const ut=this.worldSize;Tt=(wt.x-It.x)/ut,St=(wt.y-It.y)/ut}else{const ut=this.pointCoordinate(wt),pt=this.pointCoordinate(It);Tt=ut.x-pt.x,St=ut.y-pt.y}const Lt=this.locationCoordinate(pt);this.setLocation(new ut.Y(Lt.x-Tt,Lt.y-St))}setLocation(ut){this.center=this.coordinateLocation(ut),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(ut){return this.projection.locationPoint(this,ut)}locationPoint3D(ut){return this.projection.locationPoint(this,ut,!0)}pointLocation(ut){return this.coordinateLocation(this.pointCoordinate(ut))}pointLocation3D(ut){return this.coordinateLocation(this.pointCoordinate3D(ut))}locationCoordinate(pt,wt){const Tt=wt?ut.ax(wt,pt.lat):void 0,St=this.projection.project(pt.lng,pt.lat);return new ut.Y(St.x,St.y,Tt)}coordinateLocation(ut){return this.projection.unproject(ut.x,ut.y)}pointRayIntersection(pt,wt){const Tt=null!=wt?wt:this._centerAltitude,St=[pt.x,pt.y,0,1],It=[pt.x,pt.y,1,1];ut.aA.transformMat4(St,St,this.pixelMatrixInverse),ut.aA.transformMat4(It,It,this.pixelMatrixInverse);const Lt=It[3];ut.aA.scale(St,St,1/St[3]),ut.aA.scale(It,It,1/Lt);const Xt=St[2],Yt=It[2];return{p0:St,p1:It,t:Xt===Yt?0:(Tt-Xt)/(Yt-Xt)}}screenPointToMercatorRay(pt){const wt=[pt.x,pt.y,0,1],Tt=[pt.x,pt.y,1,1];return ut.aA.transformMat4(wt,wt,this.pixelMatrixInverse),ut.aA.transformMat4(Tt,Tt,this.pixelMatrixInverse),ut.aA.scale(wt,wt,1/wt[3]),ut.aA.scale(Tt,Tt,1/Tt[3]),wt[2]=ut.ax(wt[2],this._center.lat)*this.worldSize,Tt[2]=ut.ax(Tt[2],this._center.lat)*this.worldSize,ut.aA.scale(wt,wt,1/this.worldSize),ut.aA.scale(Tt,Tt,1/this.worldSize),new ut.aT([wt[0],wt[1],wt[2]],ut._.normalize([],ut._.sub([],Tt,wt)))}rayIntersectionCoordinate(pt){const{p0:wt,p1:Tt,t:St}=pt,It=ut.ax(wt[2],this._center.lat),Lt=ut.ax(Tt[2],this._center.lat);return new ut.Y(ut.a2(wt[0],Tt[0],St)/this.worldSize,ut.a2(wt[1],Tt[1],St)/this.worldSize,ut.a2(It,Lt,St))}pointCoordinate(ut,pt=this._centerAltitude){return this.projection.pointCoordinate(this,ut.x,ut.y,pt)}pointCoordinate3D(pt){if(!this.elevation)return this.pointCoordinate(pt);let wt=this.projection.pointCoordinate3D(this,pt.x,pt.y);if(wt)return new ut.Y(wt[0],wt[1],wt[2]);let Tt=0,St=this.horizonLineFromTop();if(pt.y>St)return this.pointCoordinate(pt);const It=.02*St,Lt=pt.clone();for(let pt=0;pt<10&&St-Tt>It;pt++){Lt.y=ut.a2(Tt,St,.66);const pt=this.projection.pointCoordinate3D(this,Lt.x,Lt.y);pt?(St=Lt.y,wt=pt):Tt=Lt.y}return wt?new ut.Y(wt[0],wt[1],wt[2]):this.pointCoordinate(pt)}isPointAboveHorizon(ut){return this.projection.isPointAboveHorizon(this,ut)}isPointOnSurface(pt){if(pt.y<0||pt.y>this.height||pt.x<0||pt.x>this.width)return!1;if(this.elevation||this.zoom>=ut.aU)return!this.isPointAboveHorizon(pt);const wt=this.pointCoordinate(pt);return wt.y>=0&&wt.y<=1}_coordinatePoint(pt,wt){const Tt=wt&&this.elevation?this.elevation.getAtPointOrZero(pt,this._centerAltitude):this._centerAltitude,St=[pt.x*this.worldSize,pt.y*this.worldSize,Tt+pt.toAltitude(),1];return ut.aA.transformMat4(St,St,this.pixelMatrix),St[3]>0?new ut.P(St[0]/St[3],St[1]/St[3]):new ut.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:pt,left:wt}=this._edgeInsets,Tt=this.height-this._edgeInsets.bottom,St=this.width-this._edgeInsets.right,It=this.pointLocation3D(new ut.P(wt,pt)),Lt=this.pointLocation3D(new ut.P(St,pt)),Xt=this.pointLocation3D(new ut.P(St,Tt)),Yt=this.pointLocation3D(new ut.P(wt,Tt));let Mi=Math.min(It.lng,Lt.lng,Xt.lng,Yt.lng),vr=Math.max(It.lng,Lt.lng,Xt.lng,Yt.lng),br=Math.min(It.lat,Lt.lat,Xt.lat,Yt.lat),Ar=Math.max(It.lat,Lt.lat,Xt.lat,Yt.lat);const Vr=Math.pow(2,-this.zoom)/16*270,nn="globe"===this.projection.name?1:4,f=(pt,wt,Tt,St,It)=>{const Lt=(pt+Tt)/2,Xt=(wt+St)/2,Yt=new ut.P(Lt,Xt),{lng:sn,lat:an}=this.pointLocation3D(Yt),ln=Math.max(0,Mi-sn,br-an,sn-vr,an-Ar);Mi=Math.min(Mi,sn),vr=Math.max(vr,sn),br=Math.min(br,an),Ar=Math.max(Ar,an),(It<nn||ln>Vr)&&(f(pt,wt,Lt,Xt,It+1),f(Lt,Xt,Tt,St,It+1))};if(f(wt,pt,St,pt,1),f(St,pt,St,Tt,1),f(St,Tt,wt,Tt,1),f(wt,Tt,wt,pt,1),"globe"===this.projection.name){const[pt,wt]=ut.aV(this);pt?(Ar=90,vr=180,Mi=-180):wt&&(br=-90,vr=180,Mi=-180)}return new ut.ai(new ut.aI(Mi,br),new ut.aI(vr,Ar))}_getBoundsRectangular(pt,wt){const{top:Tt,left:St}=this._edgeInsets,It=this.height-this._edgeInsets.bottom,Lt=this.width-this._edgeInsets.right,Xt=new ut.P(St,Tt),Yt=new ut.P(Lt,Tt),Mi=new ut.P(Lt,It),vr=new ut.P(St,It);let br=this.pointCoordinate(Xt,pt),Ar=this.pointCoordinate(Yt,pt);const Vr=this.pointCoordinate(Mi,wt),nn=this.pointCoordinate(vr,wt),f=(ut,pt)=>(pt.y-ut.y)/(pt.x-ut.x);return br.y>1&&Ar.y>=0?br=new ut.Y((1-nn.y)/f(nn,br)+nn.x,1):br.y<0&&Ar.y<=1&&(br=new ut.Y(-nn.y/f(nn,br)+nn.x,0)),Ar.y>1&&br.y>=0?Ar=new ut.Y((1-Vr.y)/f(Vr,Ar)+Vr.x,1):Ar.y<0&&br.y<=1&&(Ar=new ut.Y(-Vr.y/f(Vr,Ar)+Vr.x,0)),(new ut.ai).extend(this.coordinateLocation(br)).extend(this.coordinateLocation(Ar)).extend(this.coordinateLocation(nn)).extend(this.coordinateLocation(Vr))}_getBoundsRectangularTerrain(){const ut=this.elevation;if(!ut.visibleDemTiles.length||ut.isUsingMockSource())return this._getBoundsRectangular(0,0);const pt=ut.visibleDemTiles.reduce(((ut,pt)=>{if(pt.dem){const wt=pt.dem.tree;ut.min=Math.min(ut.min,wt.minimums[0]),ut.max=Math.max(ut.max,wt.maximums[0])}return ut}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(pt.min*ut.exaggeration(),pt.max*ut.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(ut=!0){const pt=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,wt=this.height/2-pt*(1-this._horizonShift);return ut?Math.max(0,wt):wt}getMaxBounds(){return this.maxBounds}setMaxBounds(pt){this.maxBounds=pt,this.minLat=-ut.aS,this.maxLat=ut.aS,this.minLng=-180,this.maxLng=180,pt&&(this.minLat=pt.getSouth(),this.maxLat=pt.getNorth(),this.minLng=pt.getWest(),this.maxLng=pt.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=ut.aj(this.minLng)*this.tileSize,this.worldMaxX=ut.aj(this.maxLng)*this.tileSize,this.worldMinY=ut.ak(this.maxLat)*this.tileSize,this.worldMaxY=ut.ak(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(ut,pt){return this.projection.createTileMatrix(this,pt,ut)}calculateDistanceTileData(pt){const wt=pt.key,Tt=this._distanceTileDataCache;if(Tt[wt])return Tt[wt];const St=pt.canonical,It=1/this.height,Lt=this.cameraWorldSize,Xt=Lt/this.zoomScale(St.z),Yt=(St.x+Math.pow(2,St.z)*pt.wrap)*Xt,Mi=St.y*Xt,vr=this.point;vr.x*=Lt/this.worldSize,vr.y*=Lt/this.worldSize;const br=this.angle,Ar=Math.sin(-br),Vr=-Math.cos(-br);return Tt[wt]={bearing:[Ar,Vr],center:[(vr.x-Yt)*It,(vr.y-Mi)*It],scale:Xt/ut.a3*It},Tt[wt]}calculateFogTileMatrix(pt){const wt=pt.key,Tt=this._fogTileMatrixCache;if(Tt[wt])return Tt[wt];const St=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,pt);return ut.ad.multiply(St,this.worldToFogMatrix,St),Tt[wt]=new Float32Array(St),Tt[wt]}calculateProjMatrix(pt,wt=!1,Tt=!1){const St=pt.key;let It;if(It=Tt?this._expandedProjMatrixCache:wt?this._alignedProjMatrixCache:this._projMatrixCache,It[St])return It[St];const Lt=this.calculatePosMatrix(pt,this.worldSize);let Xt;return Xt=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:Tt?this.expandedFarZProjMatrix:wt?this.alignedProjMatrix:this.projMatrix,ut.ad.multiply(Lt,Xt,Lt),It[St]=new Float32Array(Lt),It[St]}calculatePixelsToTileUnitsMatrix(pt){const wt=pt.tileID.key,Tt=this._pixelsToTileUnitsCache;if(Tt[wt])return Tt[wt];const St=ut.aW(pt,this);return Tt[wt]=St,Tt[wt]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const pt=1/this.worldSize,wt=ut.ad.fromScaling([],[pt,pt,pt]);return ut.ad.multiply(wt,wt,this.globeMatrix),wt}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const pt=this._elevation;this._updateCameraState();const wt=ut.ax(1,this._center.lat)*this.worldSize,Tt=this._computeCameraPosition(wt),St=this._camera.forward(),It=ut.ax(1,this._center.lat);Tt[2]/=It,St[2]/=It,ut._.normalize(St,St);const Lt=pt.raycast(Tt,St,pt.exaggeration());if(Lt){const pt=ut._.scaleAndAdd([],Tt,St,Lt),wt=new ut.Y(pt[0],pt[1],ut.ax(pt[2],ut.ay(pt[1]))),Xt=(wt.z+ut._.length([wt.x-Tt[0],wt.y-Tt[1],wt.z-Tt[2]*It]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(Xt),this._centerAltitude=wt.toAltitude(),this._center=this.coordinateLocation(wt),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(pt=!1){if(!this._elevation)return;const wt=this._elevation,Tt=ut.ax(1,this._center.lat)*this.worldSize,St=this._computeCameraPosition(Tt),It=wt.getAtPointOrZero(new ut.Y(...St)),Lt=this.pixelsPerMeter/this.worldSize*It,Xt=this._minimumHeightOverTerrain(),Yt=St[2]-Lt;if(Yt<=Xt)if(Yt<0||pt){const pt=this.locationCoordinate(this._center,this._centerAltitude),wt=[St[0],St[1],pt.z-St[2]],Tt=ut._.length(wt);wt[2]-=(Xt-Yt)/this._pixelsPerMercatorPixel;const It=ut._.length(wt);if(0===It)return;ut._.scale(wt,wt,Tt/It*this._pixelsPerMercatorPixel),this._camera.position=[St[0],St[1],pt.z*this._pixelsPerMercatorPixel-wt[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const pt="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||pt){const wt=this.center;return wt.lat=ut.at(wt.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!pt)&&(wt.lng=ut.at(wt.lng,this.minLng,this.maxLng)),this.center=wt,void(this._constraining=!1)}const wt=this._unmodified,{x:Tt,y:St}=this.point;let It=0,Lt=Tt,Xt=St;const Yt=this.width/2,Mi=this.height/2,vr=this.worldMinY*this.scale,br=this.worldMaxY*this.scale;if(St-Mi<vr&&(Xt=vr+Mi),St+Mi>br&&(Xt=br-Mi),br-vr<this.height&&(It=Math.max(It,this.height/(br-vr)),Xt=(br+vr)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const ut=this.worldMinX*this.scale,pt=this.worldMaxX*this.scale,wt=this.worldSize/2-(ut+pt)/2;Lt=(Tt+wt+this.worldSize)%this.worldSize-wt,Lt-Yt<ut&&(Lt=ut+Yt),Lt+Yt>pt&&(Lt=pt-Yt),pt-ut<this.width&&(It=Math.max(It,this.width/(pt-ut)),Lt=(pt+ut)/2)}Lt===Tt&&Xt===St||(this.center=this.unproject(new ut.P(Lt,Xt))),It&&(this.zoom+=this.scaleZoom(It)),this._constrainCamera(),this._unmodified=wt,this._constraining=!1}_minZoomForBounds(){let ut=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(ut=Math.max(ut,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),ut}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const pt=this.centerOffset,wt="globe"===this.projection.name,Tt=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=ut.ax(1,this.center.lat)/ut.ax(1,ut.b3));const St=ut.aX(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,St),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const It="meters"===this.projection.zAxisUnit?Tt:1,Lt=this._camera.getWorldToCamera(this.worldSize,It);let Xt;const Yt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(Yt[8]=2*-pt.x/this.width,Yt[9]=2*pt.y/this.height,this.isOrthographic){let ut=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),wt=ut*this.aspect,Tt=-wt,St=-ut;wt-=pt.x,Tt-=pt.x,ut+=pt.y,St+=pt.y,Xt=this._camera.getCameraToClipOrthographic(Tt,wt,St,ut,this._nearZ,this._farZ),((ut,pt,wt,Tt)=>{for(let St=0;St<16;St++)ut[St]=_i(pt[St],wt[St],Tt)})(Xt,Xt,Yt,di(this.pitch>=15?1:this.pitch/15))}else Xt=Yt;const Mi=ut.ad.mul([],Yt,Lt);let vr=ut.ad.mul([],Xt,Lt);if(this.projection.isReprojectedInTileSpace){const pt=this.locationCoordinate(this.center),wt=ut.ad.identity([]);ut.ad.translate(wt,wt,[pt.x*this.worldSize,pt.y*this.worldSize,0]),ut.ad.multiply(wt,wt,ut.aY(this)),ut.ad.translate(wt,wt,[-pt.x*this.worldSize,-pt.y*this.worldSize,0]),ut.ad.multiply(vr,vr,wt),ut.ad.multiply(Mi,Mi,wt),this.inverseAdjustmentMatrix=ut.aZ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=ut.ad.scale([],vr,[this.worldSize,this.worldSize,this.worldSize/It,1]),this.projMatrix=vr,this.invProjMatrix=ut.ad.invert(new Float64Array(16),this.projMatrix),wt){const wt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);wt[8]=2*-pt.x/this.width,wt[9]=2*pt.y/this.height,this.expandedFarZProjMatrix=ut.ad.mul([],wt,Lt)}else this.expandedFarZProjMatrix=this.projMatrix;const br=ut.ad.invert([],Xt);this.frustumCorners=ut.a_.fromInvProjectionMatrix(br,this.horizonLineFromTop(),this.height),this.cameraFrustum=ut.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!wt);const Ar=new Float32Array(16);ut.ad.identity(Ar),ut.ad.scale(Ar,Ar,[1,-1,1]),ut.ad.rotateX(Ar,Ar,this._pitch),ut.ad.rotateZ(Ar,Ar,this.angle);const Vr=ut.ad.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=ut.ad.clone(Vr);const nn=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;Vr[8]=2*-pt.x/this.width,Vr[9]=2*(pt.y+nn)/this.height,this.skyboxMatrix=ut.ad.multiply(Ar,Vr,Ar);const sn=this.point,an=sn.x,ln=sn.y,cn=this.width%2/2,un=this.height%2/2,fn=Math.cos(this.angle),_n=Math.sin(this.angle),gn=an-Math.round(an)+fn*cn+_n*un,yn=ln-Math.round(ln)+fn*un+_n*cn,xn=new Float64Array(vr);if(ut.ad.translate(xn,xn,[gn>.5?gn-1:gn,yn>.5?yn-1:yn,0]),this.alignedProjMatrix=xn,vr=ut.ad.create(),ut.ad.scale(vr,vr,[this.width/2,-this.height/2,1]),ut.ad.translate(vr,vr,[1,-1,0]),this.labelPlaneMatrix=vr,vr=ut.ad.create(),ut.ad.scale(vr,vr,[1,-1,1]),ut.ad.translate(vr,vr,[-1,-1,0]),ut.ad.scale(vr,vr,[2/this.width,2/this.height,1]),this.glCoordMatrix=vr,this.pixelMatrix=ut.ad.multiply(new Float64Array(16),this.labelPlaneMatrix,Mi),this._calcFogMatrices(),this._distanceTileDataCache={},vr=ut.ad.invert(new Float64Array(16),this.pixelMatrix),!vr)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=vr,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=ut.a$(this);const pt=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=ut._.transformMat4(pt,pt,Lt),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=vr;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const pt=this.cameraWorldSizeForFog,wt=this.cameraPixelsPerMeter,Tt=this._camera.position,St=1/this.height/this._pixelsPerMercatorPixel,It=[pt,pt,wt];ut._.scale(It,It,St),ut._.scale(Tt,Tt,-1),ut._.multiply(Tt,Tt,It);const Lt=ut.ad.create();ut.ad.translate(Lt,Lt,Tt),ut.ad.scale(Lt,Lt,It),this.mercatorFogMatrix=Lt,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(pt,wt,St)}_computeCameraPosition(ut){const pt=(ut=ut||this.pixelsPerMeter)/this.pixelsPerMeter,wt=this._camera.forward(),Tt=this.point,St=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*pt-ut/this.worldSize*this._centerAltitude;return[Tt.x/this.worldSize-wt[0]*St,Tt.y/this.worldSize-wt[1]*St,ut/this.worldSize*this._centerAltitude-wt[2]*St]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(pt){const wt=this._maxCameraBoundsDistance()*Math.cos(this._pitch),Tt=this._camera.position[2],St=pt[2];let It=1;this.projection.wrap&&(this.center=this.center.wrap()),St>0&&(It=Math.min((wt-Tt)/St,1)),this._camera.position=ut._.scaleAndAdd([],this._camera.position,pt,It),this._updateStateFromCamera()}_updateStateFromCamera(){const pt=this._camera.position,wt=this._camera.forward(),{pitch:Tt,bearing:St}=this._camera.getPitchBearing(),It=ut.ax(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,Lt=this._mercatorZfromZoom(this._maxZoom)*Math.cos(ut.ab(this._maxPitch)),Xt=Math.max((pt[2]-It)/Math.cos(Tt),Lt),Yt=this._zoomFromMercatorZ(Xt);ut._.scaleAndAdd(pt,pt,wt,Xt),this._pitch=ut.at(Tt,ut.ab(this.minPitch),ut.ab(this.maxPitch)),this.angle=ut.au(St,-Math.PI,Math.PI),this._setZoom(ut.at(Yt,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new ut.Y(pt[0],pt[1],pt[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(ut){return Math.pow(2,ut)*this.tileSize}_mercatorZfromZoom(ut){return this.cameraToCenterDistance/this._worldSizeFromZoom(ut)}_minimumHeightOverTerrain(){const ut=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(ut)}_zoomFromMercatorZ(ut){return this.scaleZoom(this.cameraToCenterDistance/(ut*this.tileSize))}zoomFromMercatorZAdjusted(pt){let wt=0,Tt=ut.aU,St=0,It=1/0;for(;Tt-wt>1e-6&&Tt>wt;){const ut=wt+.5*(Tt-wt),Lt=this.tileSize*Math.pow(2,ut),Xt=this.getCameraToCenterDistance(this.projection,ut,Lt),Yt=this.scaleZoom(Xt/(pt*this.tileSize)),Mi=Math.abs(ut-Yt);Mi<It&&(It=Mi,St=ut),ut<Yt?wt=ut:Tt=ut}return St}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(ut.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(pt,wt){const Tt=Math.min(pt.x,wt.x),St=Math.max(pt.x,wt.x),It=Math.min(pt.y,wt.y),Lt=Math.max(pt.y,wt.y);if(It<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const Xt=[new ut.P(Tt,It),new ut.P(St,Lt),new ut.P(Tt,Lt),new ut.P(St,It)],Yt=this.renderWorldCopies?-3:0,Mi=this.renderWorldCopies?4:1;for(const ut of Xt){const pt=this.pointRayIntersection(ut);if(pt.t<0)return!0;const wt=this.rayIntersectionCoordinate(pt);if(wt.x<Yt||wt.y<0||wt.x>Mi||wt.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+ut.b0(this.fovAboveCenter)>88||this.anyCornerOffEdge(new ut.P(0,0),new ut.P(this.width,this.height))}zoomDeltaToMovement(pt,wt){const Tt=ut._.length(ut._.sub([],this._camera.position,pt)),St=this._zoomFromMercatorZ(Tt)+wt;return Tt-this._mercatorZfromZoom(St)}getCameraPoint(){if("globe"===this.projection.name){const pt=function([pt,wt,Tt],St){const It=[pt,wt,Tt,1];ut.aA.transformMat4(It,It,St);const Lt=It[3]=Math.max(It[3],1e-6);return It[0]/=Lt,It[1]/=Lt,It[2]/=Lt,It}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new ut.P(pt[0],pt[1])}{const pt=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new ut.P(0,pt))}}getCameraToCenterDistance(pt,wt=this.zoom,Tt=this.worldSize){const St=ut.aX(pt,wt,this.width,this.height,1024),It=pt.pixelSpaceConversion(this.center.lat,Tt,St);let Lt=.5/Math.tan(.5*this._fov)*this.height*It;return this.isOrthographic&&(Lt=_i(1,Lt,di(this.pitch>=15?1:this.pitch/15))),Lt}getWorldToCameraMatrix(){const pt=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&ut.ad.multiply(pt,pt,this.globeMatrix),pt}getFrustum(pt){return ut.aM.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,pt,"meters"===this.projection.zAxisUnit)}}const Bn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11},mi=(pt,wt)=>{if(wt>0&&pt.terrain&&ut.w("Cutoff is currently disabled on terrain"),wt<=0||pt.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const Tt=pt.transform,St=Math.max(Math.abs(Tt._zoom-(pt.minCutoffZoom-1)),1),It=Tt.isLODDisabled(!1)?ut.$(60,45,Tt.pitch):ut.$(30,15,Tt.pitch),Lt=Tt._farZ-Tt._nearZ,Xt=wt*Tt.height,Yt=((1-(Mi=It))*Tt.cameraToCenterDistance+Mi*(Tt._farZ+Xt))*St;var Mi;return{shouldRenderCutoff:It<1,uniformValues:{u_cutoff_params:[Tt._nearZ,Tt._farZ,(Yt-Tt._nearZ)/Lt,(Yt-Xt-Tt._nearZ)/Lt]}}},Wn={cascadeCount:2,shadowMapResolution:2048};class vi{constructor(ut,pt){this.aabb=ut,this.lastCascade=pt}}class xi{add(ut,pt){const wt=this.receivers[ut.key];void 0!==wt?(wt.aabb.min[0]=Math.min(wt.aabb.min[0],pt.min[0]),wt.aabb.min[1]=Math.min(wt.aabb.min[1],pt.min[1]),wt.aabb.min[2]=Math.min(wt.aabb.min[2],pt.min[2]),wt.aabb.max[0]=Math.max(wt.aabb.max[0],pt.max[0]),wt.aabb.max[1]=Math.max(wt.aabb.max[1],pt.max[1]),wt.aabb.max[2]=Math.max(wt.aabb.max[2],pt.max[2])):this.receivers[ut.key]=new vi(pt,null)}clear(){this.receivers={}}get(ut){return this.receivers[ut.key]}computeRequiredCascades(pt,wt,Tt){const St=ut.b6.fromPoints(pt.points);let It=0;for(const pt in this.receivers){const Lt=this.receivers[pt];if(!Lt)continue;if(!St.intersectsAabb(Lt.aabb))continue;Lt.aabb.min=St.closestPoint(Lt.aabb.min),Lt.aabb.max=St.closestPoint(Lt.aabb.max);const Xt=Lt.aabb.getCorners();for(let pt=0;pt<Tt.length;pt++){let St=!0;for(const It of Xt){const Lt=[It[0]*wt,It[1]*wt,It[2]];if(ut._.transformMat4(Lt,Lt,Tt[pt].matrix),Lt[0]<-1||Lt[0]>1||Lt[1]<-1||Lt[1]>1){St=!1;break}}if(Lt.lastCascade=pt,It=Math.max(It,pt),St)break}}return It+1}}class yi{constructor(pt){this.painter=pt,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new xi,this._depthMode=new ut.ae(pt.context.gl.LEQUAL,ut.ae.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,pt.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),pt.tp.registerParameter(Wn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),pt.tp.registerParameter(Wn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),pt.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const ut of this._cascades)ut.texture.destroy(),ut.framebuffer.destroy();this._cascades=[]}updateShadowParameters(pt,wt){const Tt=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!wt||!wt.properties)return;const St=wt.properties.get("shadow-intensity");if(!wt.shadowsEnabled()||St<=0)return;if(this._shadowLayerCount=Tt.style.order.reduce(((ut,wt)=>{const St=Tt.style._mergedLayers[wt];return ut+(St.hasShadowPass()&&!St.isHidden(pt.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const It=Tt.context,Lt=Wn.shadowMapResolution,Xt=Wn.shadowMapResolution;if(0===this._cascades.length||Wn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let pt=0;pt<Wn.cascadeCount;++pt){const pt=Tt._shadowMapDebug,wt=It.gl,St=It.createFramebuffer(Lt,Xt,pt,"texture"),Yt=new ut.T(It,{width:Lt,height:Xt,data:null},wt.DEPTH_COMPONENT);if(St.depthAttachment.set(Yt.texture),pt){const pt=new ut.T(It,{width:Lt,height:Xt,data:null},wt.RGBA);St.colorAttachment.set(pt.texture)}this._cascades.push({framebuffer:St,texture:Yt,matrix:[],far:0,boundingSphereRadius:0,frustum:new ut.aM,scale:0})}}this.shadowDirection=wi(wt);let Yt=0;if(pt.elevation){const ut=pt.elevation,wt=[1e4,-1e4];ut.visibleDemTiles.filter((ut=>ut.dem)).forEach((ut=>{const pt=ut.dem.tree;wt[0]=Math.min(wt[0],pt.minimums[0]),wt[1]=Math.max(wt[1],pt.maximums[0])})),1e4!==wt[0]&&(Yt=(wt[1]-wt[0])*ut.exaggeration())}const Mi=1.5*pt.cameraToCenterDistance,vr=3*Mi,br=new Float64Array(16);for(let wt=0;wt<this._cascades.length;++wt){const Tt=this._cascades[wt];let St=pt.height/50,It=1;1===Wn.cascadeCount?It=vr:0===wt?It=Mi:(St=Mi,It=vr);const[Lt,Xt]=Ei(pt,this.shadowDirection,St,It,Wn.shadowMapResolution,Yt);Tt.scale=pt.scale,Tt.matrix=Lt,Tt.boundingSphereRadius=Xt,ut.ad.invert(br,Tt.matrix),Tt.frustum=ut.aM.fromInvProjectionMatrix(br,1,0,!0),Tt.far=It}const Ar=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[Ar].far,this._cascades[Ar].far],this._uniformValues.u_shadow_intensity=St,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Wn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Wn.shadowMapResolution,this._uniformValues.u_shadowmap_0=Bn.ShadowMap0,this._uniformValues.u_shadowmap_1=Bn.ShadowMap0+1,this._groundShadowTiles=Tt.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const Vr=Tt.transform.elevation;for(const ut of this._groundShadowTiles){let pt={min:0,max:0};if(Vr){const wt=Vr.getMinMaxForTile(ut);wt&&(pt=wt)}this.addShadowReceiver(ut.toUnwrapped(),pt.min,pt.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(ut){this._enabled=ut}drawShadowPass(pt,wt){if(!this.enabled)return;const Tt=this.painter,St=Tt.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(Tt.transform.getFrustum(0),Tt.transform.worldSize,this._cascades),St.viewport.set([0,0,Wn.shadowMapResolution,Wn.shadowMapResolution]);for(let It=0;It<this._numCascadesToRender;++It){Tt.currentShadowCascade=It,St.bindFramebuffer.set(this._cascades[It].framebuffer.framebuffer),St.clear({color:ut.C.white,depth:1});for(const ut of pt.order){const St=pt._mergedLayers[ut];if(!St.hasShadowPass()||St.isHidden(Tt.transform.zoom))continue;const It=pt.getLayerSourceCache(St),Lt=It?wt[It.id]:void 0;("model"===St.type||Lt&&Lt.length)&&Tt.renderLayer(Tt,It,St,Lt)}}Tt.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const pt=this.painter,wt=pt.style,Tt=pt.context,St=wt.directionalLight,It=wt.ambientLight;if(!St||!It)return;const Lt=[],Xt=mi(pt,pt.longestCutoffRange);Xt.shouldRenderCutoff&&Lt.push("RENDER_CUTOFF");const Yt=Ti(wt,St,It),Mi=new ut.ae(Tt.gl.LEQUAL,ut.ae.ReadOnly,pt.depthRangeFor3D);for(const wt of this._groundShadowTiles){const St=wt.toUnwrapped(),It=pt.isTileAffectedByFog(wt),vr=pt.getOrCreateProgram("groundShadow",{defines:Lt,overrideFog:It});this.setupShadows(St,vr),pt.uploadCommonUniforms(Tt,vr,St,null,Xt);const br={u_matrix:pt.transform.calculateProjMatrix(St),u_ground_shadow_factor:Yt};vr.draw(pt,Tt.gl.TRIANGLES,Mi,ut.ag.disabled,ut.a.multiply,ut.af.disabled,br,"ground_shadow",pt.tileExtentBuffer,pt.quadTriangleIndexBuffer,pt.tileExtentSegments,{},pt.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ut.a.unblended:ut.a.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(pt){const wt=this.painter.transform,Tt=wt.calculatePosMatrix(pt,wt.worldSize);return ut.ad.multiply(Tt,this._cascades[this.painter.currentShadowCascade].matrix,Tt),Float32Array.from(Tt)}calculateShadowPassMatrixFromMatrix(pt){return ut.ad.multiply(pt,this._cascades[this.painter.currentShadowCascade].matrix,pt),Float32Array.from(pt)}setupShadows(pt,wt,Tt,St=0){if(!this.enabled)return;const It=this.painter.transform,Lt=this.painter.context,Xt=Lt.gl,Yt=this._uniformValues,Mi=new Float64Array(16),vr=It.calculatePosMatrix(pt,It.worldSize);for(let pt=0;pt<this._cascades.length;pt++)ut.ad.multiply(Mi,this._cascades[pt].matrix,vr),Yt[0===pt?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Mi),Lt.activeTexture.set(Xt.TEXTURE0+Bn.ShadowMap0+pt),this._cascades[pt].texture.bind(Xt.NEAREST,Xt.CLAMP_TO_EDGE);if(this.useNormalOffset=!!Tt,this.useNormalOffset){const wt=ut.b5(pt.canonical),Lt=2/It.tileSize*ut.a3/Wn.shadowMapResolution,Xt=Lt*this._cascades[0].boundingSphereRadius,Mi=Lt*this._cascades[this._cascades.length-1].boundingSphereRadius,vr=("vector-tile"===Tt?1:3)/Math.pow(2,St-pt.canonical.z-(1-It.zoom+Math.floor(It.zoom)));Yt.u_shadow_normal_offset=[wt,Xt*vr,Mi*vr],Yt.u_shadow_bias=[6e-5,.0012,.012]}else Yt.u_shadow_bias=[36e-5,.0012,.012];wt.setShadowUniformValues(Lt,Yt)}setupShadowsFromMatrix(pt,wt,Tt=!1){if(!this.enabled)return;const St=this.painter.context,It=St.gl,Lt=this._uniformValues,Xt=new Float64Array(16);for(let wt=0;wt<Wn.cascadeCount;wt++)ut.ad.multiply(Xt,this._cascades[wt].matrix,pt),Lt[0===wt?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Xt),St.activeTexture.set(It.TEXTURE0+Bn.ShadowMap0+wt),this._cascades[wt].texture.bind(It.NEAREST,It.CLAMP_TO_EDGE);if(this.useNormalOffset=Tt,Tt){const ut=5;Lt.u_shadow_normal_offset=[1,ut,ut],Lt.u_shadow_bias=[6e-5,.0012,.012]}else Lt.u_shadow_bias=[36e-5,.0012,.012];wt.setShadowUniformValues(St,Lt)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(pt,wt,Tt,St){if(St[2]>=0)return{};const It=function(pt,wt,Tt){const St=Tt/(1<<pt.canonical.z);return new ut.b6([pt.canonical.x*St+pt.wrap*Tt,pt.canonical.y*St+pt.wrap*Tt,0],[(pt.canonical.x+1)*St+pt.wrap*Tt,(pt.canonical.y+1)*St+pt.wrap*Tt,wt])}(pt,wt,Tt).getCorners(),Lt=wt/-St[2];St[0]<0?(ut._.add(It[0],It[0],[St[0]*Lt,0,0]),ut._.add(It[3],It[3],[St[0]*Lt,0,0])):St[0]>0&&(ut._.add(It[1],It[1],[St[0]*Lt,0,0]),ut._.add(It[2],It[2],[St[0]*Lt,0,0])),St[1]<0?(ut._.add(It[0],It[0],[0,St[1]*Lt,0]),ut._.add(It[1],It[1],[0,St[1]*Lt,0])):St[1]>0&&(ut._.add(It[2],It[2],[0,St[1]*Lt,0]),ut._.add(It[3],It[3],[0,St[1]*Lt,0]));const Xt={};return Xt.vertices=It,Xt.planes=[bi(It[1],It[0],It[4]),bi(It[2],It[1],It[5]),bi(It[3],It[2],It[6]),bi(It[0],It[3],It[7])],Xt}addShadowReceiver(pt,wt,Tt){this._receivers.add(pt,ut.b6.fromTileIdAndHeight(pt,wt,Tt))}getMaxCascadeForTile(ut){const pt=this._receivers.get(ut);return pt&&pt.lastCascade?pt.lastCascade:0}}function bi(pt,wt,Tt){const St=ut._.sub([],Tt,wt),It=ut._.sub([],pt,wt),Lt=ut._.cross([],St,It),Xt=ut._.length(Lt);return 0===Xt?[0,0,1,0]:(ut._.scale(Lt,Lt,1/Xt),[Lt[0],Lt[1],Lt[2],-ut._.dot(Lt,wt)])}function wi(pt){const wt=pt.properties.get("direction"),Tt=ut.ac(wt.x,wt.y,wt.z);Tt[2]=ut.at(Tt[2],0,75);const St=ut.b7([Tt[0],Tt[1],Tt[2]]);return ut._.fromValues(St.x,St.y,St.z)}function Ti(pt,wt,Tt){const St=wt.properties.get("color"),It=wt.properties.get("intensity"),Lt=wt.properties.get("direction"),Xt=[Lt.x,Lt.y,Lt.z],Yt=Tt.properties.get("color"),Mi=Tt.properties.get("intensity"),vr=Math.max(ut._.dot([0,0,1],Xt),0),br=[0,0,0];ut._.scale(br,Yt.toRenderColor(pt.getLut(wt.scope)).toArray01Linear().slice(0,3),Mi);const Ar=[0,0,0];return ut._.scale(Ar,St.toRenderColor(pt.getLut(Tt.scope)).toArray01Linear().slice(0,3),vr*It),ut.b8([br[0]>0?br[0]/(br[0]+Ar[0]):0,br[1]>0?br[1]/(br[1]+Ar[1]):0,br[2]>0?br[2]/(br[2]+Ar[2]):0])}function Ei(pt,wt,Tt,St,It,Lt){const Xt=pt.zoom,Yt=pt.scale,Mi=pt.worldSize,vr=1/Mi,br=pt.aspect,Ar=Math.sqrt(1+br*br)*Math.tan(.5*pt.fovX),Vr=Ar*Ar,nn=St-Tt,sn=St+Tt;let an,ln;Vr>nn/sn?(an=St,ln=St*Ar):(an=.5*sn*(1+Vr),ln=.5*Math.sqrt(nn*nn+2*(St*St+Tt*Tt)*Vr+sn*sn*Vr*Vr));const cn=pt.projection.pixelsPerMeter(pt.center.lat,Mi),un=pt._camera.getCameraToWorldMercator(),fn=[0,0,-an*vr];ut._.transformMat4(fn,fn,un);let _n=ln*vr;const gn=pt._edgeInsets;if(!(0===gn.left&&0===gn.top&&0===gn.right&&0===gn.bottom||gn.left===gn.right&&gn.top===gn.bottom)){const wt=pt._camera.getWorldToCamera(pt.worldSize,"meters"===pt.projection.zAxisUnit?cn:1),It=pt._camera.getCameraToClipPerspective(pt._fov,pt.width/pt.height,Tt,St);It[8]=2*-pt.centerOffset.x/pt.width,It[9]=2*pt.centerOffset.y/pt.height;const Lt=new Float64Array(16);ut.ad.mul(Lt,It,wt);const vr=new Float64Array(16);ut.ad.invert(vr,Lt);const br=ut.aM.fromInvProjectionMatrix(vr,Mi,Xt,!0);for(const wt of br.points){const Tt=((yn=wt)[0]/=Yt,yn[1]/=Yt,yn[2]=ut.ax(yn[2],pt._center.lat),yn);_n=Math.max(_n,ut._.len(ut._.subtract([],fn,Tt)))}}var yn;_n*=It/(It-1);const xn=Math.acos(wt[2]),vn=Math.atan2(-wt[0],-wt[1]),bn=new $t;bn.position=fn,bn.setPitchBearing(xn,vn);const wn=bn.getWorldToCamera(Mi,cn),Tn=_n*Mi,En=Math.min(pt._mercatorZfromZoom(17)*Mi*-2,-2*Tn),Mn=bn.getCameraToClipOrthographic(-Tn,Tn,-Tn,Tn,En,(Tn+Lt*cn)/wt[2]),Sn=new Float64Array(16);ut.ad.multiply(Sn,Mn,wn);const An=ut._.fromValues(Math.floor(1e6*fn[0])/1e6*Mi,Math.floor(1e6*fn[1])/1e6*Mi,0),In=.5*It,Pn=[0,0,0];ut._.transformMat4(Pn,An,Sn),ut._.scale(Pn,Pn,In);const zn=[Math.floor(Pn[0]),Math.floor(Pn[1]),Math.floor(Pn[2])],Ln=[0,0,0];ut._.sub(Ln,Pn,zn),ut._.scale(Ln,Ln,-1/In);const kn=new Float64Array(16);return ut.ad.identity(kn),ut.ad.translate(kn,kn,Ln),ut.ad.multiply(Sn,kn,Sn),[Sn,Tn]}function Ci(ut,pt){return null!=ut&&null!=pt&&!(!ut.hasData()||!pt.hasData())&&null!=ut.demTexture&&null!=pt.demTexture&&ut.tileID.key!==pt.tileID.key}const Yn=new class{constructor(){this.operations={}}newMorphing(ut,pt,wt,Tt,St){if(ut in this.operations){const pt=this.operations[ut];pt.to.tileID.key!==wt.tileID.key&&(pt.queued=wt)}else this.operations[ut]={startTime:Tt,phase:0,duration:St,from:pt,to:wt,queued:null}}getMorphValuesForProxy(ut){if(!(ut in this.operations))return null;const pt=this.operations[ut];return{from:pt.from,to:pt.to,phase:pt.phase}}update(ut){for(const pt in this.operations){const wt=this.operations[pt];for(wt.phase=(ut-wt.startTime)/wt.duration;wt.phase>=1||!this._validOp(wt);)if(!this._nextOp(wt,ut)){delete this.operations[pt];break}}}_nextOp(ut,pt){return!!ut.queued&&(ut.from=ut.to,ut.to=ut.queued,ut.queued=null,ut.phase=0,ut.startTime=pt,!0)}_validOp(ut){return ut.from.hasData()&&ut.to.hasData()}},Jn={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Li(ut,pt,wt){if(0===pt)return 0;const Tt=pt<1&&514===wt?.25/pt:1;return 6*Math.pow(1.5,22-ut)*Math.max(pt,1)*Tt}function Pi(ut,pt){const wt=1<<ut.z;return!pt&&(0===ut.x||ut.x===wt-1)||0===ut.y||ut.y===wt-1}const Ai=ut=>({u_matrix:ut});function Ri(pt,wt,Tt,St,It){if(It>0){const Lt=ut.e.now(),Xt=(Lt-pt.timeAdded)/It,Yt=wt?(Lt-wt.timeAdded)/It:-1,Mi=Tt.getSource(),vr=St.coveringZoomLevel({tileSize:Mi.tileSize,roundZoom:Mi.roundZoom}),br=!wt||Math.abs(wt.tileID.overscaledZ-vr)>Math.abs(pt.tileID.overscaledZ-vr),Ar=br&&pt.refreshedUponExpiration?1:ut.at(br?Xt:1-Yt,0,1);return pt.refreshedUponExpiration&&Xt>=1&&(pt.refreshedUponExpiration=!1),wt?{opacity:1,mix:1-Ar}:{opacity:Ar,mix:0}}return{opacity:1,mix:0}}class Di extends kt{constructor(pt,wt,Tt,St){super(pt,wt,Tt,St),this.type="raster-array",this.maxzoom=22,this._options=ut.W({type:"raster-array"},wt)}triggerRepaint(ut){const pt=this.map.painter._terrain,wt=this.map.style.getSourceCache(this.id);pt&&pt.enabled&&wt&&pt._clearRenderCacheForTile(wt.id,ut.tileID),this.map.triggerRepaint()}loadTile(pt,wt){const Tt=this.map._requestManager.normalizeTileURL(pt.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),St=this.map._requestManager.transformRequest(Tt,ut.R.Tile);pt.requestParams=St,pt.actor||(pt.actor=this.dispatcher.getActor()),pt.request=pt.fetchHeader(void 0,((ut,Tt,St,It)=>{if(delete pt.request,pt.aborted)return pt.state="unloaded",wt(null);if(ut){if(20===ut.code)return;return pt.state="errored",wt(ut)}this.map._refreshExpiredTiles&&pt.setExpiryData({cacheControl:St,expires:It}),pt.state="empty",wt(null)}))}unloadTile(pt,wt){const Tt=pt.texture;Tt&&Tt instanceof ut.T?(pt.destroy(!0),this.map.painter.saveTileTexture(Tt)):(pt.destroy(),pt.flushQueues(),pt._isHeaderLoaded=!1,delete pt._mrt,delete pt.textureDescriptor),pt.fbo&&(pt.fbo.destroy(),delete pt.fbo),delete pt.request,delete pt.requestParams,delete pt.neighboringTiles,pt.state="unloaded"}prepareTile(pt,wt,Tt){pt._isHeaderLoaded&&("empty"!==pt.state&&(pt.state="reloading"),pt.fetchBand(wt,Tt,((wt,Tt)=>{if(wt)return pt.state="errored",this.fire(new ut.d(wt)),void this.triggerRepaint(pt);Tt&&(pt.setTexture(Tt,this.map.painter),pt.state="loaded",this.triggerRepaint(pt))})))}getInitialBand(ut){if(!this.rasterLayers)return 0;const pt=this.rasterLayers.find((({id:pt})=>pt===ut)),wt=pt&&pt.fields,Tt=wt&&wt.bands&&wt.bands;return Tt?Tt[0]:0}getTextureDescriptor(pt,wt,Tt){if(!pt)return;const St=wt.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!St)return;let It=null;wt instanceof ut.bk?It=wt.paint.get("raster-array-band"):wt instanceof ut.bl&&(It=wt.paint.get("raster-particle-array-band"));const Lt=It||this.getInitialBand(St);if(null!=Lt)if(pt.textureDescriptor){if(!pt.updateNeeded(St,Lt)||Tt)return Object.assign({},pt.textureDescriptor,{texture:pt.texture})}else this.prepareTile(pt,St,Lt)}}const Qn={vector:Nt,raster:kt,"raster-dem":class extends kt{constructor(pt,wt,Tt,St){super(pt,wt,Tt,St),this.type="raster-dem",this.maxzoom=22,this._options=ut.W({type:"raster-dem"},wt),this.encoding=wt.encoding||"mapbox"}loadTile(pt,wt){const Tt=this.map._requestManager.normalizeTileURL(pt.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(ut,Tt){ut&&(pt.state="errored",wt(ut)),Tt&&(pt.dem=Tt,pt.dem.onDeserialize(),pt.needsHillshadePrepare=!0,pt.needsDEMTextureUpload=!0,pt.state="loaded",wt(null))}pt.request=ut.h(this.map._requestManager.transformRequest(Tt,ut.R.Tile),function(Tt,St,It,Lt){if(delete pt.request,pt.aborted)pt.state="unloaded",wt(null);else if(Tt)pt.state="errored",wt(Tt);else if(St){this.map._refreshExpiredTiles&&pt.setExpiryData({cacheControl:It,expires:Lt});const wt=ImageBitmap&&St instanceof ImageBitmap&&ut.bi(),Tt=1-(St.width-ut.bj(St.width))/2;Tt<1||pt.neighboringTiles||(pt.neighboringTiles=this._getNeighboringTiles(pt.tileID));const Xt=wt?St:ut.e.getImageData(St,Tt),Yt={uid:pt.uid,coord:pt.tileID,source:this.id,scope:this.scope,rawImageData:Xt,encoding:this.encoding,padding:Tt};pt.actor&&"expired"!==pt.state||(pt.actor=this.dispatcher.getActor(),pt.actor.send("loadDEMTile",Yt,r.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(pt){const wt=pt.canonical,Tt=Math.pow(2,wt.z),St=(wt.x-1+Tt)%Tt,It=0===wt.x?pt.wrap-1:pt.wrap,Lt=(wt.x+1+Tt)%Tt,Xt=wt.x+1===Tt?pt.wrap+1:pt.wrap,Yt={};return Yt[new ut.aL(pt.overscaledZ,It,wt.z,St,wt.y).key]={backfilled:!1},Yt[new ut.aL(pt.overscaledZ,Xt,wt.z,Lt,wt.y).key]={backfilled:!1},wt.y>0&&(Yt[new ut.aL(pt.overscaledZ,It,wt.z,St,wt.y-1).key]={backfilled:!1},Yt[new ut.aL(pt.overscaledZ,pt.wrap,wt.z,wt.x,wt.y-1).key]={backfilled:!1},Yt[new ut.aL(pt.overscaledZ,Xt,wt.z,Lt,wt.y-1).key]={backfilled:!1}),wt.y+1<Tt&&(Yt[new ut.aL(pt.overscaledZ,It,wt.z,St,wt.y+1).key]={backfilled:!1},Yt[new ut.aL(pt.overscaledZ,pt.wrap,wt.z,wt.x,wt.y+1).key]={backfilled:!1},Yt[new ut.aL(pt.overscaledZ,Xt,wt.z,Lt,wt.y+1).key]={backfilled:!1}),Yt}},"raster-array":Di,geojson:class extends ut.E{constructor(pt,wt,Tt,St){super(),this.id=pt,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=Tt.getActor(),this.setEventedParent(St),this._data=wt.data,this._options=ut.W({},wt),this._collectResourceTiming=wt.collectResourceTiming,void 0!==wt.maxzoom&&(this.maxzoom=wt.maxzoom),void 0!==wt.minzoom&&(this.minzoom=wt.minzoom),wt.type&&(this.type=wt.type),wt.attribution&&(this.attribution=wt.attribution),this.promoteId=wt.promoteId;const It=ut.a3/this.tileSize;this.workerOptions=ut.W({source:this.id,scope:this.scope,cluster:wt.cluster||!1,geojsonVtOptions:{buffer:(void 0!==wt.buffer?wt.buffer:128)*It,tolerance:(void 0!==wt.tolerance?wt.tolerance:.375)*It,extent:ut.a3,maxZoom:this.maxzoom,lineMetrics:wt.lineMetrics||!1,generateId:wt.generateId||!1},superclusterOptions:{maxZoom:void 0!==wt.clusterMaxZoom?wt.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,wt.clusterMinPoints||2),extent:ut.a3,radius:(void 0!==wt.clusterRadius?wt.clusterRadius:50)*It,log:!1,generateId:wt.generateId||!1},clusterProperties:wt.clusterProperties,filter:wt.filter,dynamic:wt.dynamic},wt.workerOptions)}onAdd(ut){this.map=ut,this.setData(this._data)}setData(ut){return this._data=ut,this._updateWorkerData(),this}updateData(pt){return this._options.dynamic?"string"!=typeof pt&&("Feature"===pt.type&&(pt={type:"FeatureCollection",features:[pt]}),"FeatureCollection"!==pt.type)?this.fire(new ut.d(new Error("Data to update should be a feature or a feature collection."))):(this._coalesce&&"string"!=typeof pt&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type?this._data.features.push(...pt.features):this._data=pt,this._updateWorkerData(!0),this):this.fire(new ut.d(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")))}getClusterExpansionZoom(ut,pt){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:ut,source:this.id,scope:this.scope},pt),this}getClusterChildren(ut,pt){return this.actor.send("geojson.getClusterChildren",{clusterId:ut,source:this.id,scope:this.scope},pt),this}getClusterLeaves(ut,pt,wt,Tt){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:ut,limit:pt,offset:wt},Tt),this}_updateWorkerData(pt=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new ut.f("dataloading",{dataType:"source"})),this._loaded=!1;const wt=ut.W({append:pt},this.workerOptions);wt.scope=this.scope;const Tt=this._data;"string"==typeof Tt?(wt.request=this.map._requestManager.transformRequest(ut.e.resolveURL(Tt),ut.R.Source),wt.request.collectResourceTiming=this._collectResourceTiming):wt.data=JSON.stringify(Tt),this._pendingLoad=this.actor.send(`${this.type}.loadData`,wt,((wt,Tt)=>{if(this._loaded=!0,this._pendingLoad=null,wt)this.fire(new ut.d(wt));else{const wt={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&Tt&&Tt.resourceTiming&&Tt.resourceTiming[this.id]&&(wt.resourceTiming=Tt.resourceTiming[this.id]),pt&&(this._partialReload=!0),this.fire(new ut.f("data",wt)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(pt),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(pt,wt){const Tt=pt.actor?"reloadTile":"loadTile";pt.actor=this.actor;const St=this.map.style?this.map.style.getLut(this.scope):null,It=this._partialReload,Lt={type:this.type,uid:pt.uid,tileID:pt.tileID,tileZoom:pt.tileZoom,zoom:pt.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:St?{image:St.image.clone()}:null,scope:this.scope,pixelRatio:ut.e.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,partial:It};pt.request=this.actor.send(Tt,Lt,((ut,St)=>It&&!St?(pt.state="loaded",wt(null)):(delete pt.request,pt.destroy(),pt.aborted?wt(null):ut?wt(ut):(pt.loadVectorData(St,this.map.painter,"reloadTile"===Tt),wt(null)))),void 0,"loadTile"===Tt)}abortTile(ut){ut.request&&(ut.request.cancel(),delete ut.request),ut.aborted=!0}unloadTile(ut,pt){this.actor.send("removeTile",{uid:ut.uid,type:this.type,source:this.id,scope:this.scope}),ut.destroy()}onRemove(ut){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return ut.W({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends ut.bm{constructor(ut,pt,wt,Tt){super(ut,pt,wt,Tt),this.roundZoom=!0,this.type="video",this.options=pt}load(){this._loaded=!1;const pt=this.options;this.urls=[];for(const wt of pt.urls)this.urls.push(this.map._requestManager.transformRequest(wt,ut.R.Source).url);ut.bn(this.urls,((pt,wt)=>{this._loaded=!0,pt?this.fire(new ut.d(pt)):wt&&(this.video=wt,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(pt){if(this.video){const wt=this.video.seekable;pt<wt.start(0)||pt>wt.end(0)?this.fire(new ut.d(new ut.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${wt.start(0)} and ${wt.end(0)}-second mark.`))):this.video.currentTime=pt}}getVideo(){return this.video}onAdd(ut){this.map||(this.map=ut,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const pt=this.map.painter.context,wt=pt.gl;this.texture?this.video.paused||(this.texture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE),wt.texSubImage2D(wt.TEXTURE_2D,0,0,0,wt.RGBA,wt.UNSIGNED_BYTE,this.video)):(this.texture=new ut.T(pt,this.video,wt.RGBA),this.texture.bind(wt.LINEAR,wt.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(pt)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:ut.bm,model:class extends ut.E{constructor(ut,pt,wt,Tt){super(),this.id=ut,this.type="model",this.models=[],this._loaded=!1,this._options=pt}load(){const pt=[];for(const wt in this._options.models){const Tt=this._options.models[wt],St=ut.l(this.map._requestManager.transformRequest(Tt.uri,ut.R.Model).url).then((pt=>{if(!pt)return;const St=ut.c(pt),It=new ut.M(wt,Tt.position,Tt.orientation,St);It.computeBoundsAndApplyParent(),this.models.push(It)})).catch((pt=>{this.fire(new ut.d(new Error(`Could not load model ${wt} from ${Tt.uri}: ${pt.message}`)))}));pt.push(St)}return Promise.allSettled(pt).then((()=>{this._loaded=!0,this.fire(new ut.f("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((pt=>{this.fire(new ut.d(new Error(`Could not load models: ${pt.message}`)))}))}onAdd(ut){this.map=ut,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(ut,pt){}serialize(){return{type:"model"}}},"batched-model":class extends ut.E{constructor(ut,pt,wt,Tt){super(),this.type="batched-model",this.id=ut,this.tileSize=512,this._options=pt,this.tiles=this._options.tiles,this.maxzoom=pt.maxzoom||19,this.minzoom=pt.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=wt,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(Tt)}onAdd(ut){this.map=ut,this.load()}load(pt){this._loaded=!1,this.fire(new ut.f("dataloading",{dataType:"source"}));const wt=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Tt=this.map._worldview;this._tileJSONRequest=Ft(this._options,this.map._requestManager,wt,Tt,((St,It)=>{this._tileJSONRequest=null,this._loaded=!0,St?(wt&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${wt}`),Tt&&2!==Tt.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Tt}`),this.fire(new ut.d(St))):It&&(ut.W(this,It),It.bounds&&(this.tileBounds=new Bt(It.bounds,this.minzoom,this.maxzoom)),ut.an(It.tiles,this.map._requestManager._customAccessToken),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"content"}))),pt&&pt(St)}))}hasTransition(){return!1}hasTile(ut){return!this.tileBounds||this.tileBounds.contains(ut.canonical)}loaded(){return this._loaded}loadTile(pt,wt){const Tt=this.map._requestManager.normalizeTileURL(pt.tileID.canonical.url(this.tiles,this.scheme)),St={request:this.map._requestManager.transformRequest(Tt,ut.R.Tile),data:void 0,uid:pt.uid,tileID:pt.tileID,tileZoom:pt.tileZoom,zoom:pt.tileID.overscaledZ,tileSize:this.tileSize*pt.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:pt.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(pt.actor&&"expired"!==pt.state)if("loading"===pt.state)pt.reloadCallback=wt;else{if(pt.buckets){const ut=Object.values(pt.buckets);for(const pt of ut)pt.dirty=!0;return void(pt.state="loaded")}pt.request=pt.actor.send("reloadTile",St,a.bind(this))}else pt.actor=this.dispatcher.getActor(),pt.request=pt.actor.send("loadTile",St,a.bind(this),void 0,!0);function a(ut,Tt){return pt.aborted?wt(null):ut&&404!==ut.status?wt(ut):(Tt&&(Tt.resourceTiming&&(pt.resourceTiming=Tt.resourceTiming),this.map._refreshExpiredTiles&&pt.setExpiryData(Tt),pt.buckets={...pt.buckets,...Tt.buckets},Tt.featureIndex&&(pt.latestFeatureIndex=Tt.featureIndex)),pt.state="loaded",void wt(null))}}serialize(){return ut.W({},this._options)}},canvas:class extends ut.bm{constructor(pt,wt,Tt,St){super(pt,wt,Tt,St),wt.coordinates?Array.isArray(wt.coordinates)&&4===wt.coordinates.length&&!wt.coordinates.some((ut=>!Array.isArray(ut)||2!==ut.length||ut.some((ut=>"number"!=typeof ut))))||this.fire(new ut.d(new ut.V(`sources.${pt}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new ut.d(new ut.V(`sources.${pt}`,null,'missing required property "coordinates"'))),wt.animate&&"boolean"!=typeof wt.animate&&this.fire(new ut.d(new ut.V(`sources.${pt}`,null,'optional "animate" property must be a boolean value'))),wt.canvas?"string"==typeof wt.canvas||wt.canvas instanceof HTMLCanvasElement||this.fire(new ut.d(new ut.V(`sources.${pt}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new ut.d(new ut.V(`sources.${pt}`,null,'missing required property "canvas"'))),this.options=wt,this.animate=void 0===wt.animate||wt.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new ut.d(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(ut){this.map=ut,this.load(),this.canvas&&this.animate&&this.play()}onRemove(ut){this.pause()}prepare(){let pt=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,pt=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,pt=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const wt=this.map.painter.context;this.texture?!pt&&!this._playing||this.texture instanceof ut.bo||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new ut.T(wt,this.canvas,wt.gl.RGBA,{premultiply:!0}),this._prepareData(wt)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const ut of[this.canvas.width,this.canvas.height])if(isNaN(ut)||ut<=0)return!0;return!1}},custom:class extends ut.E{constructor(pt,wt,Tt,St){super(),this.id=pt,this.type="custom",this._dataType="raster",this._dispatcher=Tt,this._implementation=wt,this.setEventedParent(St),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new ut.d(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new ut.d(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Bt(this._implementation.bounds,this.minzoom,this.maxzoom)),wt.update=this._update.bind(this),wt.clearTiles=this._clearTiles.bind(this),wt.coveringTiles=this._coveringTiles.bind(this),ut.W(this,ut.ah(wt,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return ut.ah(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new ut.f("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new ut.f("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(pt){this._map=pt,this._loaded=!1,this.fire(new ut.f("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(pt),this.load()}onRemove(ut){this._implementation.onRemove&&this._implementation.onRemove(ut)}hasTile(ut){if(this._implementation.hasTile){const{x:pt,y:wt,z:Tt}=ut.canonical;return this._implementation.hasTile({x:pt,y:wt,z:Tt})}return!this.tileBounds||this.tileBounds.contains(ut.canonical)}loadTile(ut,pt){const{x:wt,y:Tt,z:St}=ut.tileID.canonical,It=new AbortController;ut.request=Promise.resolve(this._implementation.loadTile({x:wt,y:Tt,z:St},{signal:It.signal})).then(function(wt){return delete ut.request,ut.aborted?(ut.state="unloaded",pt(null)):void 0===wt?(ut.state="errored",pt(null)):null===wt?(this.loadTileData(ut,{width:this.tileSize,height:this.tileSize,data:null}),ut.state="loaded",pt(null)):function(ut){return ut instanceof ImageData||ut instanceof HTMLCanvasElement||ut instanceof ImageBitmap||ut instanceof HTMLImageElement}(wt)?(this.loadTileData(ut,wt),ut.state="loaded",void pt(null)):(ut.state="errored",pt(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((wt=>{20!==wt.code&&(ut.state="errored",pt(wt))})),ut.request.cancel=()=>It.abort()}loadTileData(ut,pt){ut.setTexture(pt,this._map.painter)}unloadTile(pt,wt){if(pt.texture&&pt.texture instanceof ut.T?(pt.destroy(!0),pt.texture&&pt.texture instanceof ut.T&&this._map.painter.saveTileTexture(pt.texture)):pt.destroy(),this._implementation.unloadTile){const{x:ut,y:wt,z:Tt}=pt.tileID.canonical;this._implementation.unloadTile({x:ut,y:wt,z:Tt})}wt&&wt()}abortTile(ut,pt){ut.request&&ut.request.cancel&&(ut.request.cancel(),delete ut.request),pt&&pt()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((ut=>({x:ut.canonical.x,y:ut.canonical.y,z:ut.canonical.z})))}_clearTiles(){const pt=ut.al(this.id,this.scope);this._map.style.clearSource(pt)}_update(){this.fire(new ut.f("data",{dataType:"source",sourceDataType:"content"}))}}},zi=function(pt,wt,Tt,St){const It=new Qn[wt.type](pt,wt,Tt,St);if(It.id!==pt)throw new Error(`Expected Source id to be ${pt} instead of ${It.id}`);return ut.bp(["load","abort","unload","serialize","prepare"],It),It};class Oi extends ut.bv{constructor(pt){const wt={type:"raster-dem",maxzoom:pt.transform.maxZoom},Tt=new ut.bw(ut.bx(),null),St=zi("mock-dem",wt,Tt,pt.style);super("mock-dem",St,!1),St.setEventedParent(this),this._sourceLoaded=!0}_loadTile(ut,pt){ut.state="loaded",pt(null)}}class Fi extends ut.bv{constructor(pt){const wt=zi("proxy",{type:"geojson",maxzoom:pt.transform.maxZoom},new ut.bw(ut.bx(),null),pt.style);super("proxy",wt,!1),wt.setEventedParent(this),this.map=this.getSource().map=pt,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(pt,wt,Tt){if(pt.freezeTileCoverage)return;this.transform=pt;const St=pt.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((wt,Tt)=>{if(wt[Tt.key]="",!this._tiles[Tt.key]){const wt=new ut.by(Tt,this._source.tileSize*Tt.overscaleFactor(),pt.tileZoom);wt.state="loaded",this._tiles[Tt.key]=wt}return wt}),{});for(const ut in this._tiles)ut in St||(this.freeFBO(ut),this._tiles[ut].unloadVectorData(),delete this._tiles[ut])}freeFBO(ut){const pt=this.proxyCachedFBO[ut];if(void 0!==pt){const wt=Object.values(pt);this.renderCachePool.push(...wt),delete this.proxyCachedFBO[ut]}}deallocRenderCache(){this.renderCache.forEach((ut=>ut.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Bi extends ut.aL{constructor(ut,pt,wt){super(ut.overscaledZ,ut.wrap,ut.canonical.z,ut.canonical.x,ut.canonical.y),this.proxyTileKey=pt,this.projMatrix=wt}}class ki extends ut.bq{constructor(pt,wt){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},pt.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),pt.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),pt.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=pt,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[Tt,St,It]=function(pt){const wt=new ut.bt,Tt=new ut.bu,St=131;wt.reserve(17161),Tt.reserve(33800);const It=ut.a3/128,Lt=ut.a3+It/2,Xt=Lt+It;for(let pt=-It;pt<Xt;pt+=It)for(let Tt=-It;Tt<Xt;Tt+=It){const St=Tt<0||Tt>Lt||pt<0||pt>Lt?24575:0,It=ut.at(Math.round(Tt),0,ut.a3),Xt=ut.at(Math.round(pt),0,ut.a3);wt.emplaceBack(It+St,Xt)}const l=(ut,pt)=>{const wt=pt*St+ut;Tt.emplaceBack(wt+1,wt,wt+St),Tt.emplaceBack(wt+St,wt+St+1,wt+1)};for(let ut=1;ut<129;ut++)for(let pt=1;pt<129;pt++)l(pt,ut);return[0,129].forEach((ut=>{for(let pt=0;pt<130;pt++)l(pt,ut),l(ut,pt)})),[wt,Tt,32768]}(),Lt=pt.context;this.gridBuffer=Lt.createVertexBuffer(Tt,ut.br.members),this.gridIndexBuffer=Lt.createIndexBuffer(St),this.gridSegments=ut.b.simpleSegment(0,0,Tt.length,St.length),this.gridNoSkirtSegments=ut.b.simpleSegment(0,0,Tt.length,It),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Fi(wt.map),this.orthoMatrix=ut.ad.create(),ut.ad.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,ut.a3,0,ut.a3,0,1);const Xt=Lt.gl;this._overlapStencilMode=new ut.ag({func:Xt.GEQUAL,mask:255},0,255,Xt.KEEP,Xt.KEEP,Xt.REPLACE),this._previousZoom=pt.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=wt,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Oi(wt.map),this._pendingGroundEffectLayers=[]}set style(ut){ut.on("data",this._onStyleDataEvent.bind(this)),this._style=ut,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(pt,wt,Tt){if(pt&&pt.terrain){this._style!==pt&&(this.style=pt,this._evaluationZoom=void 0);const St=pt.terrain.properties,It=0===pt.terrain.drapeRenderMode,Lt=pt.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=ut.e.now();const Xt=pt.terrain&&pt.terrain.scope,Yt=St.get("source"),Mi=It?this._mockSourceCache:pt.getSourceCache(Yt,Xt);if(!Mi)return void ut.w(`Couldn't find terrain source "${Yt}".`);if(this.sourceCache=Mi,this._exaggeration=Lt?this.calculateExaggeration(wt):St.get("exaggeration"),!wt.projection.requiresDraping&&Lt&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&ut.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const pt=this.getScaledDemTileSize();this.sourceCache.update(wt,pt,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),wt.updateElevation(!0,Tt),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(wt),this._emptyDEMTextureDirty=!0,this._previousZoom=wt.zoom}else this._disable()}calculateExaggeration(pt){const wt=this._previousCameraAltitude,Tt=pt.getFreeCameraOptions().position.z/pt.pixelsPerMeter*pt.worldSize;this._previousCameraAltitude=Tt;const St=null!=wt?Tt-wt:Number.MAX_VALUE;if(Math.abs(St)<2)return this._exaggeration;const It=pt.zoom,Lt=this._style.terrain;if(!this._previousUpdateTimestamp)return Lt.getExaggeration(It);let Xt=It-this._previousZoom;const Yt=this._previousUpdateTimestamp;let Mi=It;null!=this._evaluationZoom&&(Mi=this._evaluationZoom,Math.abs(It-Mi)>.5&&(Xt=.5*(It-Mi+Xt)),Xt*St<0&&(Mi+=Xt)),this._evaluationZoom=Mi;const vr=Lt.getExaggeration(Mi),br=vr===Lt.getExaggeration(Math.max(0,Mi-.1));if(br&&Math.abs(vr-this._exaggeration)<.01)return vr;let Ar=Math.min(.1,.00375*(this._updateTimestamp-Yt));return(br||vr<.1||Math.abs(Xt)<1e-4)&&(Ar=Math.min(.2,4*Ar)),ut.a2(this._exaggeration,vr,Ar)}resetTileLookupCache(ut){this._findCoveringTileCache[ut]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(ut){ut.coord&&"source"===ut.dataType?this._clearRenderCacheForTile(ut.sourceCacheId,ut.coord):"style"===ut.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const ut in this._style._mergedSourceCaches)this._style._mergedSourceCaches[ut].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach((ut=>ut.fb.destroy())),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const ut=2*this.proxySourceCache.getSource().tileSize;return[ut,ut]}set useVertexMorphing(ut){this._useVertexMorphing=ut}updateTileBinding(pt){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const wt=this.proxySourceCache,Tt=this.painter.transform;this._initializing&&(this._initializing=0===Tt._centerAltitude&&-1===this.getAtPointOrZero(ut.Y.fromLngLat(Tt.center),-1),this._emptyDEMTextureDirty=!this._initializing);const St=this.proxyCoords=wt.getIds().map((ut=>{const pt=wt.getTileByID(ut).tileID;return pt.projMatrix=Tt.calculateProjMatrix(pt.toUnwrapped()),pt}));!function(pt,wt){const Tt=wt.transform.pointCoordinate(wt.transform.getCameraPoint()),St=new ut.P(Tt.x,Tt.y);pt.sort(((pt,wt)=>{if(wt.overscaledZ-pt.overscaledZ)return wt.overscaledZ-pt.overscaledZ;const Tt=new ut.P(pt.canonical.x+(1<<pt.canonical.z)*pt.wrap,pt.canonical.y),It=new ut.P(wt.canonical.x+(1<<wt.canonical.z)*wt.wrap,wt.canonical.y),Lt=St.mult(1<<pt.canonical.z);return Lt.x-=.5,Lt.y-=.5,Lt.distSqr(Tt)-Lt.distSqr(It)}))}(St,this.painter);const It=this.proxyToSource||{};this.proxyToSource={},St.forEach((ut=>{this.proxyToSource[ut.key]={}})),this.terrainTileForTile={};const Lt=this._style._mergedSourceCaches;for(const ut in Lt){const wt=Lt[ut];if(!wt.used)continue;if(wt!==this.sourceCache&&this.resetTileLookupCache(wt.id),this._setupProxiedCoordsForOrtho(wt,pt[ut],It),wt.usedForTerrain)continue;const Tt=pt[ut];wt.getSource().reparseOverscaled&&this._assignTerrainTiles(Tt)}this.proxiedCoords[wt.id]=St.map((ut=>new Bi(ut,ut.key,this.orthoMatrix))),this._assignTerrainTiles(St),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(It),this.renderingToTexture=!1;const Xt={};this._visibleDemTiles=[];for(const ut of this.proxyCoords){const pt=this.terrainTileForTile[ut.key];if(!pt)continue;const wt=pt.tileID.key;wt in Xt||(this._visibleDemTiles.push(pt),Xt[wt]=wt)}}_assignTerrainTiles(ut){this._initializing||ut.forEach((ut=>{if(this.terrainTileForTile[ut.key])return;const pt=this._findTileCoveringTileID(ut,this.sourceCache);pt&&(this.terrainTileForTile[ut.key]=pt)}))}_prepareDEMTextures(){const ut=this.painter.context,pt=ut.gl;for(const wt in this.terrainTileForTile){const Tt=this.terrainTileForTile[wt],St=Tt.dem;!St||Tt.demTexture&&!Tt.needsDEMTextureUpload||(ut.activeTexture.set(pt.TEXTURE1),zt(this.painter,Tt,St))}}_prepareDemTileUniforms(ut,pt,wt,Tt){if(!pt||null==pt.demTexture)return!1;const St=ut.tileID.canonical,It=Math.pow(2,pt.tileID.canonical.z-St.z),Lt=Tt||"";return wt[`u_dem_tl${Lt}`]=[St.x*It%1,St.y*It%1],wt[`u_dem_scale${Lt}`]=It,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const pt=this.painter.context,wt=pt.gl;if(!this._emptyDepthBufferTexture){const Tt=new ut.i({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new ut.T(pt,Tt,wt.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let ut=0;const pt=this._visibleDemTiles.reduce(((pt,wt)=>{if(!wt.dem)return pt;const Tt=wt.dem.tree.minimums[0];return Tt>0&&ut++,pt+Tt}),0);return ut?pt/ut:0}_updateEmptyDEMTexture(){const pt=this.painter.context,wt=pt.gl;pt.activeTexture.set(wt.TEXTURE2);const Tt=this._getLoadedAreaMinimum(),[St,It]=(()=>{const pt=new ut.bz({width:1,height:1},new Float32Array([Tt]));return[wt.R32F,pt]})();this._emptyDEMTextureDirty=!1;let Lt=this._emptyDEMTexture;return Lt?Lt.update(It,{premultiply:!1}):Lt=this._emptyDEMTexture=new ut.T(pt,It,St,{premultiply:!1}),Lt}setupElevationDraw(pt,wt,Tt){const St=this.painter.context,It=St.gl,Lt={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};Lt.u_exaggeration=this.exaggeration();let Xt=null,Yt=null,Mi=1;if(Tt&&Tt.morphing&&this._useVertexMorphing){const ut=Tt.morphing.srcDemTile,wt=Tt.morphing.dstDemTile;Mi=Tt.morphing.phase,ut&&wt&&(this._prepareDemTileUniforms(pt,ut,Lt,"_prev")&&(Yt=ut),this._prepareDemTileUniforms(pt,wt,Lt)&&(Xt=wt))}const h=ut=>ut&&ut.demTexture&&this.painter.linearFloatFilteringSupported()?It.LINEAR:It.NEAREST;let vr=null;var br;if(this.enabled?Yt&&Xt?(vr=Xt.demTexture,St.activeTexture.set(It.TEXTURE4),Yt.demTexture.bind(h(Yt),It.CLAMP_TO_EDGE),Lt.u_dem_lerp=Mi):(Xt=this.terrainTileForTile[pt.tileID.key],vr=this._prepareDemTileUniforms(pt,Xt,Lt)?Xt.demTexture:this.emptyDEMTexture):vr=this.emptyDEMTexture,St.activeTexture.set(It.TEXTURE2),vr&&(Lt.u_dem_size=1===(br=vr).size[0]?1:br.size[0]-2,vr.bind(h(Xt),It.CLAMP_TO_EDGE)),St.activeTexture.set(It.TEXTURE3),Tt&&Tt.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(It.NEAREST,It.CLAMP_TO_EDGE),this._depthFBO&&(Lt.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(It.NEAREST,It.CLAMP_TO_EDGE),Lt.u_depth_size_inv=[1,1]),Tt&&Tt.useMeterToDem&&Xt){const pt=(1<<Xt.tileID.canonical.z)*ut.ax(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;Lt.u_meter_to_dem=pt}if(Tt&&Tt.labelPlaneMatrixInv&&(Lt.u_label_plane_matrix_inv=Tt.labelPlaneMatrixInv),wt.setTerrainUniformValues(St,Lt),"globe"===this.painter.transform.projection.name){const ut=this.globeUniformValues(this.painter.transform,pt.tileID.canonical,Tt&&Tt.useDenormalizedUpVectorScale);wt.setGlobeUniformValues(St,ut)}}globeUniformValues(pt,wt,Tt){const St=pt.projection;return{u_tile_tl_up:St.upVector(wt,0,0),u_tile_tr_up:St.upVector(wt,ut.a3,0),u_tile_br_up:St.upVector(wt,ut.a3,ut.a3),u_tile_bl_up:St.upVector(wt,0,ut.a3),u_tile_up_scale:Tt?ut.bs(1):St.upVectorScale(wt,pt.center.lat,pt.worldSize).metersToTile}}renderToBackBuffer(pt){const wt=this.painter,Tt=this.painter.context;0!==pt.length&&(Tt.bindFramebuffer.set(null),Tt.viewport.set([0,0,wt.width,wt.height]),wt.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(pt,wt,Tt,St,It){if("globe"===pt.transform.projection.name)!function(pt,wt,Tt,St,It){const Lt=pt.context,Xt=Lt.gl;let Yt,Mi;const vr=pt.transform,br=ut.ba(pt,Lt,vr),_=(ut,wt)=>{if(Mi===wt)return;const Tt=[Jn[wt],"PROJECTION_GLOBE_VIEW"];br&&Tt.push("CUSTOM_ANTIALIASING");const St=pt.isTileAffectedByFog(ut);Yt=pt.getOrCreateProgram("globeRaster",{defines:Tt,overrideFog:St}),Mi=wt},Ar=pt.colorModeForRenderPass(),Vr=new ut.ae(Xt.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D);Yn.update(It);const nn=ut.bb(vr),sn=[ut.aj(vr.center.lng),ut.ak(vr.center.lat)],an=pt.globeSharedBuffers,ln=[vr.width*ut.e.devicePixelRatio,vr.height*ut.e.devicePixelRatio],cn=Float32Array.from(vr.globeMatrix),un={useDenormalizedUpVectorScale:!0};{const vr=pt.transform,br=Li(vr.zoom,wt.exaggeration(),wt.sourceCache._source.tileSize);Mi=-1;const fn=Xt.TRIANGLES;for(const Mi of St){const St=Tt.getTile(Mi),_n=ut.ag.disabled,gn=wt.prevTerrainTileForTile[Mi.key],yn=wt.terrainTileForTile[Mi.key];Ci(gn,yn)&&Yn.newMorphing(Mi.key,gn,yn,It,250),Lt.activeTexture.set(Xt.TEXTURE0),St.texture&&St.texture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE);const xn=Yn.getMorphValuesForProxy(Mi.key),vn=xn?1:0;xn&&ut.o(un,{morphing:{srcDemTile:xn.from,dstDemTile:xn.to,phase:ut.b9(xn.phase)}});const bn=ut.bc(Mi.canonical),wn=ut.bd(bn.getCenter().lat),Tn=ut.be(Mi.canonical,bn,wn,vr.worldSize/vr._pixelsPerMercatorPixel),En=ut.bf(ut.bg(Mi.canonical)),Mn=jt(vr.expandedFarZProjMatrix,cn,nn,En,ut.a1(vr.zoom),sn,vr.frustumCorners.TL,vr.frustumCorners.TR,vr.frustumCorners.BR,vr.frustumCorners.BL,vr.globeCenterInViewSpace,vr.globeRadius,ln,br,vr._farZ,Tn);if(_(Mi,vn),Yt&&(wt.setupElevationDraw(St,Yt,un),pt.uploadCommonUniforms(Lt,Yt,Mi.toUnwrapped()),an)){const[wt,Tt,St]=an.getGridBuffers(wn,0!==br);Yt.draw(pt,fn,Vr,_n,Ar,ut.af.backCCW,Mn,"globe_raster",wt,Tt,St)}}}if(an&&(pt.renderDefaultNorthPole||pt.renderDefaultSouthPole)){const It=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];br&&It.push("CUSTOM_ANTIALIASING"),Yt=pt.getOrCreateProgram("globeRaster",{defines:It});for(const It of St){const{x:St,y:Mi,z:br}=It.canonical,nn=0===Mi,cn=Mi===(1<<br)-1,[fn,_n,gn,yn]=an.getPoleBuffers(br,!1);if(yn&&(nn||cn)){const Mi=Tt.getTile(It);Lt.activeTexture.set(Xt.TEXTURE0),Mi.texture&&Mi.texture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE);let an=ut.bh(br,St,vr);const xn=ut.bf(ut.bg(It.canonical)),C=(wt,Tt)=>wt.draw(pt,Xt.TRIANGLES,Vr,ut.ag.disabled,Ar,ut.af.disabled,jt(vr.expandedFarZProjMatrix,an,an,xn,0,sn,vr.frustumCorners.TL,vr.frustumCorners.TR,vr.frustumCorners.BR,vr.frustumCorners.BL,vr.globeCenterInViewSpace,vr.globeRadius,ln,0,vr._farZ),"globe_pole_raster",Tt,gn,yn);wt.setupElevationDraw(Mi,Yt,un),pt.uploadCommonUniforms(Lt,Yt,It.toUnwrapped()),nn&&pt.renderDefaultNorthPole&&C(Yt,fn),cn&&pt.renderDefaultSouthPole&&(an=ut.ad.scale(ut.ad.create(),an,[1,-1,1]),C(Yt,_n))}}}}(pt,wt,Tt,St,It);else{const Lt=pt.context,Xt=Lt.gl;let Yt,Mi;const vr=pt.shadowRenderer,br=mi(pt,pt.longestCutoffRange),_=ut=>{if(Mi===ut)return;const wt=[];wt.push(Jn[ut]),br.shouldRenderCutoff&&wt.push("RENDER_CUTOFF"),Yt=pt.getOrCreateProgram("terrainRaster",{defines:wt}),Mi=ut},Ar=pt.colorModeForRenderPass(),Vr=new ut.ae(Xt.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D);Yn.update(It);const nn=pt.transform,sn=Li(nn.zoom,wt.exaggeration(),wt.sourceCache._source.tileSize);let an=[0,0,0];if(vr){const ut=pt.style.directionalLight,wt=pt.style.ambientLight;ut&&wt&&(an=Ti(pt.style,ut,wt))}{Mi=-1;const ln=Xt.TRIANGLES,[cn,un]=[wt.gridIndexBuffer,wt.gridSegments];for(const Mi of St){const St=Tt.getTile(Mi),fn=ut.ag.disabled,_n=wt.prevTerrainTileForTile[Mi.key],gn=wt.terrainTileForTile[Mi.key];Ci(_n,gn)&&Yn.newMorphing(Mi.key,_n,gn,It,250),Lt.activeTexture.set(Xt.TEXTURE0),St.texture&&St.texture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE);const yn=Yn.getMorphValuesForProxy(Mi.key),xn=yn?1:0;let vn;yn&&(vn={morphing:{srcDemTile:yn.from,dstDemTile:yn.to,phase:ut.b9(yn.phase)}});const bn=Gt(Mi.projMatrix,Pi(Mi.canonical,nn.renderWorldCopies)?sn/10:sn,an);if(_(xn),!Yt)continue;wt.setupElevationDraw(St,Yt,vn);const wn=Mi.toUnwrapped();vr&&vr.setupShadows(wn,Yt),pt.uploadCommonUniforms(Lt,Yt,wn,null,br),Yt.draw(pt,ln,Vr,fn,Ar,ut.af.backCCW,bn,"terrain_raster",wt.gridBuffer,cn,un)}}}}(wt,this,this.proxySourceCache,pt,this._updateTimestamp),this.renderingToTexture=!0,wt.gpuTimingDeferredRenderEnd(),pt.splice(0,pt.length))}renderBatch(pt){if(0===this._drapedRenderBatches.length)return pt+1;this.renderingToTexture=!0;const wt=this.painter,Tt=this.painter.context,St=this.proxySourceCache,It=this.proxiedCoords[St.id],Lt=this._drapedRenderBatches.shift(),Xt=wt.style.order,Yt=[];let Mi=0;for(const vr of It){const It=St.getTileByID(vr.proxyTileKey),br=St.proxyCachedFBO[vr.key]?St.proxyCachedFBO[vr.key][pt]:void 0,Ar=void 0!==br?St.renderCache[br]:this.pool[Mi++],Vr=void 0!==br;if(It.texture=Ar.tex,Vr&&!Ar.dirty){Yt.push(It.tileID);continue}let nn;Tt.bindFramebuffer.set(Ar.fb.framebuffer),this.renderedToTile=!1,Ar.dirty&&(Tt.clear({color:ut.C.transparent,stencil:0}),Ar.dirty=!1);for(let ut=Lt.start;ut<=Lt.end;++ut){const pt=wt.style._mergedLayers[Xt[ut]];if(pt.isHidden(wt.transform.zoom))continue;const St=wt.style.getLayerSourceCache(pt),It=St?this.proxyToSource[vr.key][St.id]:[vr];if(!It)continue;const Lt=It;Tt.viewport.set([0,0,Ar.fb.width,Ar.fb.height]),nn!==(St?St.id:null)&&(this._setupStencil(Ar,It,pt,St),nn=St?St.id:null),wt.renderLayer(wt,St,pt,Lt)}if(0===this._drapedRenderBatches.length)for(const ut of this._pendingGroundEffectLayers){const pt=wt.style._mergedLayers[Xt[ut]];if(pt.isHidden(wt.transform.zoom))continue;const St=wt.style.getLayerSourceCache(pt),It=St?this.proxyToSource[vr.key][St.id]:[vr];if(!It)continue;const Lt=It;Tt.viewport.set([0,0,Ar.fb.width,Ar.fb.height]),nn!==(St?St.id:null)&&(this._setupStencil(Ar,It,pt,St),nn=St?St.id:null),wt.renderLayer(wt,St,pt,Lt)}this.renderedToTile?(Ar.dirty=!0,Yt.push(It.tileID)):Vr||--Mi,5===Mi&&(Mi=0,this.renderToBackBuffer(Yt))}return this.renderToBackBuffer(Yt),this.renderingToTexture=!1,Tt.bindFramebuffer.set(null),Tt.viewport.set([0,0,wt.width,wt.height]),Lt.end+1}postRender(){}isLayerOrderingCorrect(ut){const pt=ut.order.length;let wt=-1,Tt=pt;for(let St=0;St<pt;++St)this._style.isLayerDraped(ut._mergedLayers[ut.order[St]])?wt=Math.max(wt,St):Tt=Math.min(Tt,St);return Tt>wt}getMinElevationBelowMSL(){let ut=0;return this._visibleDemTiles.filter((ut=>ut.dem)).forEach((pt=>{ut=Math.min(ut,pt.dem.tree.minimums[0])})),0===ut?ut:(ut-30)*this._exaggeration}raycast(ut,pt,wt){if(!this._visibleDemTiles)return null;const Tt=this._visibleDemTiles.filter((ut=>ut.dem)).map((Tt=>{const St=Tt.tileID,It=1<<St.overscaledZ,{x:Lt,y:Xt}=St.canonical,Yt=Lt/It,Mi=(Lt+1)/It,vr=Xt/It,br=(Xt+1)/It;return{minx:Yt,miny:vr,maxx:Mi,maxy:br,t:Tt.dem.tree.raycastRoot(Yt,vr,Mi,br,ut,pt,wt),tile:Tt}}));Tt.sort(((ut,pt)=>(null!==ut.t?ut.t:Number.MAX_VALUE)-(null!==pt.t?pt.t:Number.MAX_VALUE)));for(const St of Tt){if(null==St.t)return null;const Tt=St.tile.dem.tree.raycast(St.minx,St.miny,St.maxx,St.maxy,ut,pt,wt);if(null!=Tt)return Tt}return null}_createFBO(){const pt=this.painter.context,wt=pt.gl,Tt=this.drapeBufferSize;pt.activeTexture.set(wt.TEXTURE0);const St=new ut.T(pt,{width:Tt[0],height:Tt[1],data:null},wt.RGBA);St.bind(wt.LINEAR,wt.CLAMP_TO_EDGE);const It=pt.createFramebuffer(Tt[0],Tt[1],!0,null);return It.colorAttachment.set(St.texture),It.depthAttachment=new oe(pt,It.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=pt.createRenderbuffer(pt.gl.DEPTH_STENCIL,Tt[0],Tt[1]),this._stencilRef=0,It.depthAttachment.set(this._sharedDepthStencil),pt.clear({stencil:0})):It.depthAttachment.set(this._sharedDepthStencil),pt.extTextureFilterAnisotropic&&wt.texParameterf(wt.TEXTURE_2D,pt.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,pt.extTextureFilterAnisotropicMax),{fb:It,tex:St,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const ut in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[ut].hasTransition())return!0;return this._style.order.some((ut=>{const pt=this._style._mergedLayers[ut],wt=pt.isHidden(this.painter.transform.zoom);return"custom"===pt.type?!wt&&pt.shouldRedrape():!wt&&pt.hasTransition()}))}_clearLineLayersFromRenderCache(){let pt=!1;for(const ut of this._style.getSources())if(ut instanceof Nt){pt=!0;break}if(!pt)return;const wt={};for(let pt=0;pt<this._style.order.length;++pt){const Tt=this._style._mergedLayers[this._style.order[pt]],St=this._style.getLayerSourceCache(Tt);if(St&&!wt[St.id]&&!Tt.isHidden(this.painter.transform.zoom)&&"line"===Tt.type&&Tt.widthExpression()instanceof ut.Z){wt[St.id]=!0;for(const ut of this.proxyCoords){const pt=this.proxyToSource[ut.key][St.id];if(pt)for(const ut of pt)this._clearRenderCacheForTile(St.id,ut)}}}}_clearRasterLayersFromRenderCache(){let ut=!1;for(const pt in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[pt]._source instanceof kt){ut=!0;break}if(!ut)return;const pt={};for(let ut=0;ut<this._style.order.length;++ut){const wt=this._style._mergedLayers[this._style.order[ut]],Tt=this._style.getLayerSourceCache(wt);if(!Tt||pt[Tt.id])continue;if(wt.isHidden(this.painter.transform.zoom)||"raster"!==wt.type)continue;const St=wt.paint.get("raster-fade-duration");for(const ut of this.proxyCoords){const pt=this.proxyToSource[ut.key][Tt.id];if(pt)for(const ut of pt){const pt=Ri(Tt.getTile(ut),Tt.findLoadedParent(ut,0),Tt,this.painter.transform,St);(1!==pt.opacity||0!==pt.mix)&&this._clearRenderCacheForTile(Tt.id,ut)}}}}_setupDrapedRenderBatches(){const pt=this._style.order,wt=pt.length;if(0===wt)return;const Tt=[];this._pendingGroundEffectLayers=[];let St,It=0,Lt=this._style._mergedLayers[pt[It]];for(;!this._style.isLayerDraped(Lt)&&Lt.isHidden(this.painter.transform.zoom)&&++It<wt;)Lt=this._style._mergedLayers[pt[It]];for(;It<wt;++It){const ut=this._style._mergedLayers[pt[It]];ut.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(ut)?void 0===St&&(St=It):("fill-extrusion"===ut.type&&this._pendingGroundEffectLayers.push(It),void 0!==St&&(Tt.push({start:St,end:It-1}),St=void 0)))}if(void 0!==St&&Tt.push({start:St,end:It-1}),0!==Tt.length){const pt=Tt[Tt.length-1];this._pendingGroundEffectLayers.every((ut=>ut>pt.end))||ut.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=Tt}_setupRenderCache(ut){const pt=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,pt.renderCache.length>pt.renderCachePool.length){const ut=Object.values(pt.proxyCachedFBO);pt.proxyCachedFBO={};for(let wt=0;wt<ut.length;++wt){const Tt=Object.values(ut[wt]);pt.renderCachePool.push(...Tt)}}return}this._clearRasterLayersFromRenderCache();const wt=this.proxyCoords,Tt=this._tilesDirty;for(let St=wt.length-1;St>=0;St--){const It=wt[St];if(pt.getTileByID(It.key),void 0!==pt.proxyCachedFBO[It.key]){const wt=ut[It.key],St=this.proxyToSource[It.key];let Lt=0;for(const ut in St){const pt=St[ut],It=wt[ut];if(!It||It.length!==pt.length||pt.some(((pt,wt)=>pt!==It[wt]||Tt[ut]&&Tt[ut].hasOwnProperty(pt.key)))){Lt=-1;break}++Lt}for(const ut in pt.proxyCachedFBO[It.key])pt.renderCache[pt.proxyCachedFBO[It.key][ut]].dirty=Lt<0||Lt!==Object.values(wt).length}}const St=[...this._drapedRenderBatches];St.sort(((ut,pt)=>pt.end-pt.start-(ut.end-ut.start)));for(const ut of St)for(const Tt of wt){if(pt.proxyCachedFBO[Tt.key])continue;let wt=pt.renderCachePool.pop();void 0===wt&&pt.renderCache.length<50&&(wt=pt.renderCache.length,pt.renderCache.push(this._createFBO())),void 0!==wt&&(pt.proxyCachedFBO[Tt.key]={},pt.proxyCachedFBO[Tt.key][ut.start]=wt,pt.renderCache[wt].dirty=!0)}this._tilesDirty={}}_setupStencil(ut,pt,wt,Tt){if(!Tt||!this._sourceTilesOverlap[Tt.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const St=this.painter.context,It=St.gl;if(pt.length<=1)return void(this._overlapStencilType=!1);let Lt;if(wt.isTileClipped())Lt=pt.length,this._overlapStencilMode.test={func:It.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(pt[0].overscaledZ>pt[pt.length-1].overscaledZ))return void(this._overlapStencilType=!1);Lt=1,this._overlapStencilMode.test={func:It.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+Lt>255&&(St.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=Lt,this._overlapStencilMode.ref=this._stencilRef,wt.isTileClipped()&&this._renderTileClippingMasks(pt,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(pt){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[pt.key]),this._overlapStencilMode):ut.ag.disabled}_renderTileClippingMasks(pt,wt){const Tt=this.painter,St=this.painter.context,It=St.gl;Tt._tileClippingMaskIDs={},St.setColorMode(ut.a.disabled),St.setDepthMode(ut.ae.disabled);const Lt=Tt.getOrCreateProgram("clippingMask");for(const St of pt){const pt=Tt._tileClippingMaskIDs[St.key]=--wt;Lt.draw(Tt,It.TRIANGLES,ut.ae.disabled,new ut.ag({func:It.ALWAYS,mask:0},pt,255,It.KEEP,It.KEEP,It.REPLACE),ut.a.disabled,ut.af.disabled,Ai(St.projMatrix),"$clipping",Tt.tileExtentBuffer,Tt.quadTriangleIndexBuffer,Tt.tileExtentSegments)}}pointCoordinate(pt){const wt=this.painter.transform;if(pt.x<0||pt.x>wt.width||pt.y<0||pt.y>wt.height)return null;const Tt=[pt.x,pt.y,1,1];ut.aA.transformMat4(Tt,Tt,wt.pixelMatrixInverse),ut.aA.scale(Tt,Tt,1/Tt[3]),Tt[0]/=wt.worldSize,Tt[1]/=wt.worldSize;const St=wt._camera.position,It=ut.ax(1,wt.center.lat),Lt=[St[0],St[1],St[2]/It,0],Xt=ut._.subtract([],Tt.slice(0,3),Lt);ut._.normalize(Xt,Xt);const Yt=this.raycast(Lt,Xt,this._exaggeration);return null!==Yt&&Yt?(ut._.scaleAndAdd(Lt,Lt,Xt,Yt),Lt[3]=Lt[2],Lt[2]*=It,Lt):null}drawDepth(){const pt=this.painter,wt=pt.context,Tt=this.proxySourceCache,St=Math.ceil(pt.width),It=Math.ceil(pt.height);if(!this._depthFBO||this._depthFBO.width===St&&this._depthFBO.height===It||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const pt=wt.gl,Tt=wt.createFramebuffer(St,It,!0,"renderbuffer");wt.activeTexture.set(pt.TEXTURE0);const Lt=new ut.T(wt,{width:St,height:It,data:null},pt.RGBA);Lt.bind(pt.NEAREST,pt.CLAMP_TO_EDGE),Tt.colorAttachment.set(Lt.texture);const Xt=wt.createRenderbuffer(wt.gl.DEPTH_COMPONENT16,St,It);Tt.depthAttachment.set(Xt),this._depthFBO=Tt,this._depthTexture=Lt}wt.bindFramebuffer.set(this._depthFBO.framebuffer),wt.viewport.set([0,0,St,It]),function(pt,wt,Tt,St){if("globe"===pt.transform.projection.name)return;const It=pt.context,Lt=It.gl;It.clear({depth:1});const Xt=pt.getOrCreateProgram("terrainDepth"),Yt=new ut.ae(Lt.LESS,ut.ae.ReadWrite,pt.depthRangeFor3D);for(const It of St){const St=Tt.getTile(It),Mi=Gt(It.projMatrix,0,[0,0,0]);wt.setupElevationDraw(St,Xt),Xt.draw(pt,Lt.TRIANGLES,Yt,ut.ag.disabled,ut.a.unblended,ut.af.backCCW,Mi,"terrain_depth",wt.gridBuffer,wt.gridIndexBuffer,wt.gridNoSkirtSegments)}}(pt,this,Tt,this.proxyCoords)}_setupProxiedCoordsForOrtho(pt,wt,Tt){if(pt.getSource()instanceof ut.bm)return this._setupProxiedCoordsForImageSource(pt,wt,Tt);this._findCoveringTileCache[pt.id]=this._findCoveringTileCache[pt.id]||{};const St=this.proxiedCoords[pt.id]=[],It=this.proxyCoords;for(let ut=0;ut<It.length;ut++){const wt=It[ut],Lt=this._findTileCoveringTileID(wt,pt);if(Lt){const ut=this._createProxiedId(wt,Lt,Tt[wt.key]&&Tt[wt.key][pt.id]);St.push(ut),this.proxyToSource[wt.key][pt.id]=[ut]}}let Lt=!1;const Xt=new Set;for(let ut=0;ut<wt.length;ut++){const It=pt.getTile(wt[ut]);if(!It||!It.hasData())continue;const Yt=this._findTileCoveringTileID(It.tileID,this.proxySourceCache);if(Yt&&Yt.tileID.canonical.z!==It.tileID.canonical.z){const ut=this.proxyToSource[Yt.tileID.key][pt.id],wt=this._createProxiedId(Yt.tileID,It,Tt[Yt.tileID.key]&&Tt[Yt.tileID.key][pt.id]);ut?ut.splice(ut.length-1,0,wt):this.proxyToSource[Yt.tileID.key][pt.id]=[wt];const Mi=this.proxyToSource[Yt.tileID.key][pt.id];Xt.has(Mi)||Xt.add(Mi),St.push(wt),Lt=!0}}if(this._sourceTilesOverlap[pt.id]=Lt,Lt&&this._debugParams.sortTilesHiZFirst)for(const ut of Xt)ut.sort(((ut,pt)=>pt.overscaledZ-ut.overscaledZ))}_setupProxiedCoordsForImageSource(pt,wt,Tt){if(!pt.getSource().loaded())return;const St=this.proxiedCoords[pt.id]=[],It=this.proxyCoords,Lt=pt.getSource(),Xt=Lt.tileID;if(!Xt)return;const Yt=new ut.P(Xt.x,Xt.y)._div(1<<Xt.z),Mi=Lt.coordinates.map(ut.Y.fromLngLat).reduce(((ut,pt)=>(ut.min.x=Math.min(ut.min.x,pt.x-Yt.x),ut.min.y=Math.min(ut.min.y,pt.y-Yt.y),ut.max.x=Math.max(ut.max.x,pt.x-Yt.x),ut.max.y=Math.max(ut.max.y,pt.y-Yt.y),ut)),{min:new ut.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new ut.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(pt,wt)=>{const Tt=pt.wrap+pt.canonical.x/(1<<pt.canonical.z),St=pt.canonical.y/(1<<pt.canonical.z),It=ut.a3/(1<<pt.canonical.z),Lt=wt.wrap+wt.canonical.x/(1<<wt.canonical.z),Xt=wt.canonical.y/(1<<wt.canonical.z);return Tt+It<Lt+Mi.min.x||Tt>Lt+Mi.max.x||St+It<Xt+Mi.min.y||St>Xt+Mi.max.y};for(let ut=0;ut<It.length;ut++){const Lt=It[ut];for(let ut=0;ut<wt.length;ut++){const It=pt.getTile(wt[ut]);if(!It||!It.hasData())continue;if(h(Lt,It.tileID))continue;const Xt=this._createProxiedId(Lt,It,Tt[Lt.key]&&Tt[Lt.key][pt.id]),Yt=this.proxyToSource[Lt.key][pt.id];Yt?Yt.push(Xt):this.proxyToSource[Lt.key][pt.id]=[Xt],St.push(Xt)}}}_createProxiedId(pt,wt,Tt){let St=this.orthoMatrix;if(Tt){const ut=Tt.find((ut=>ut.key===wt.tileID.key));if(ut)return ut}if(wt.tileID.key!==pt.key){const Tt=pt.canonical.z-wt.tileID.canonical.z;let It,Lt,Xt;St=ut.ad.create();const Yt=wt.tileID.wrap-pt.wrap<<pt.overscaledZ;Tt>0?(It=ut.a3>>Tt,Lt=It*((wt.tileID.canonical.x<<Tt)-pt.canonical.x+Yt),Xt=It*((wt.tileID.canonical.y<<Tt)-pt.canonical.y)):(It=ut.a3<<-Tt,Lt=ut.a3*(wt.tileID.canonical.x-(pt.canonical.x+Yt<<-Tt)),Xt=ut.a3*(wt.tileID.canonical.y-(pt.canonical.y<<-Tt))),ut.ad.ortho(St,0,It,0,It,0,1),ut.ad.translate(St,St,[Lt,Xt,0])}return new Bi(wt.tileID,pt.key,St)}_findTileCoveringTileID(pt,wt){let Tt=wt.getTile(pt);if(Tt&&Tt.hasData())return Tt;const St=this._findCoveringTileCache[wt.id],It=St[pt.key];if(Tt=It?wt.getTileByID(It):null,Tt&&Tt.hasData()||null===It)return Tt;let Lt=Tt?Tt.tileID:pt,Xt=Lt.overscaledZ;const Yt=wt.getSource().minzoom,Mi=[];if(!It){const St=wt.getSource().maxzoom;if(pt.canonical.z>=St){const Tt=pt.canonical.z-St;wt.getSource().reparseOverscaled?(Xt=Math.max(pt.canonical.z+2,wt.transform.tileZoom),Lt=new ut.aL(Xt,pt.wrap,St,pt.canonical.x>>Tt,pt.canonical.y>>Tt)):0!==Tt&&(Xt=St,Lt=new ut.aL(Xt,pt.wrap,St,pt.canonical.x>>Tt,pt.canonical.y>>Tt))}Lt.key!==pt.key&&(Mi.push(Lt.key),Tt=wt.getTile(Lt))}const h=ut=>{Mi.forEach((pt=>{St[pt]=ut})),Mi.length=0};for(Xt-=1;Xt>=Yt&&(!Tt||!Tt.hasData());Xt--){Tt&&h(Tt.tileID.key);const ut=Lt.calculateScaledKey(Xt);if(Tt=wt.getTileByID(ut),Tt&&Tt.hasData())break;const pt=St[ut];if(null===pt)break;void 0===pt?Mi.push(ut):Tt=wt.getTileByID(pt)}return h(Tt?Tt.tileID.key:null),Tt&&Tt.hasData()?Tt:null}findDEMTileFor(ut){return this.enabled?this._findTileCoveringTileID(ut,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(ut,pt){let wt=this._tilesDirty[ut];wt||(wt=this._tilesDirty[ut]={}),wt[pt.key]=!0}}function Ni(pt,wt,Tt){const St=function(pt,wt,Tt){const St=ut._.dot(wt,pt),It=ut._.dot(Tt,[.2126,.7152,.0722]),s=(ut,pt,wt)=>(1-wt)*ut+wt*pt,Lt=s(1-.3*Math.min(It,1),1,Math.min(St+1,1));return s(.92,1,Math.asin(ut.at(wt[2],-1,1))/Math.PI+.5)*Lt}(pt,[0,0,1],wt),It=[0,0,0];ut._.scale(It,Tt.slice(0,3),St);const Lt=[0,0,0];ut._.scale(Lt,wt.slice(0,3),pt[2]);const Xt=[0,0,0];return ut._.add(Xt,It,Lt),ut.b8(Xt)}const bo=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],ko=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class ji{static cacheKey(ut,pt,wt,Tt){let St=`${pt}${Tt?Tt.cacheKey:""}`;for(const pt of wt)ut.usedDefines.includes(pt)&&(St+=`/${pt}`);return St}constructor(pt,wt,Tt,St,It,Lt){const Xt=pt.gl;this.program=Xt.createProgram(),this.configuration=St,this.name=wt,this.fixedDefines=[...Lt];const Yt=St?St.getBinderAttributes():[],Mi=(Tt.staticAttributes||[]).concat(Yt);let vr=St?St.defines():[];vr=vr.concat(Lt.map((ut=>`#define ${ut}`)));const br="#version 300 es\n";let Ar=br+vr.concat("precision mediump float;",Pn,In.fragmentSource).join("\n");for(const ut of Tt.fragmentIncludes)Ar+=`\n${Sn[ut]}`;Ar+=`\n${Tt.fragmentSource}`;let Vr=br+vr.concat("precision highp float;",Pn,In.vertexSource).join("\n");for(const ut of Tt.vertexIncludes)Vr+=`\n${Sn[ut]}`;Vr+=`\n${Tt.vertexSource}`;const nn=Xt.createShader(Xt.FRAGMENT_SHADER);if(Xt.isContextLost())return void(this.failedToCreate=!0);Xt.shaderSource(nn,Ar),Xt.compileShader(nn),Xt.attachShader(this.program,nn);const sn=Xt.createShader(Xt.VERTEX_SHADER);if(Xt.isContextLost())this.failedToCreate=!0;else{Xt.shaderSource(sn,Vr),Xt.compileShader(sn),Xt.attachShader(this.program,sn),this.attributes={},this.numAttributes=Mi.length;for(let ut=0;ut<this.numAttributes;ut++)if(Mi[ut]){const pt=Mi[ut].startsWith("a_")?Mi[ut]:`a_${Mi[ut]}`;Xt.bindAttribLocation(this.program,ut,pt),this.attributes[pt]=ut}Xt.linkProgram(this.program),Xt.deleteShader(sn),Xt.deleteShader(nn),this.fixedUniforms=It(pt),this.binderUniforms=St?St.getUniforms(pt):[],Lt.includes("TERRAIN")&&(this.terrainUniforms=(pt=>({u_dem:new ut.a7(pt),u_dem_prev:new ut.a7(pt),u_dem_tl:new ut.a8(pt),u_dem_scale:new ut.aa(pt),u_dem_tl_prev:new ut.a8(pt),u_dem_scale_prev:new ut.aa(pt),u_dem_size:new ut.aa(pt),u_dem_lerp:new ut.aa(pt),u_exaggeration:new ut.aa(pt),u_depth:new ut.a7(pt),u_depth_size_inv:new ut.a8(pt),u_meter_to_dem:new ut.aa(pt),u_label_plane_matrix_inv:new ut.a6(pt)}))(pt)),Lt.includes("GLOBE")&&(this.globeUniforms=(pt=>({u_tile_tl_up:new ut.aq(pt),u_tile_tr_up:new ut.aq(pt),u_tile_br_up:new ut.aq(pt),u_tile_bl_up:new ut.aq(pt),u_tile_up_scale:new ut.aa(pt)}))(pt)),Lt.includes("FOG")&&(this.fogUniforms=(pt=>({u_fog_matrix:new ut.a6(pt),u_fog_range:new ut.a8(pt),u_fog_color:new ut.as(pt),u_fog_horizon_blend:new ut.aa(pt),u_fog_vertical_limit:new ut.a8(pt),u_fog_temporal_offset:new ut.aa(pt),u_frustum_tl:new ut.aq(pt),u_frustum_tr:new ut.aq(pt),u_frustum_br:new ut.aq(pt),u_frustum_bl:new ut.aq(pt),u_globe_pos:new ut.aq(pt),u_globe_radius:new ut.aa(pt),u_globe_transition:new ut.aa(pt),u_is_globe:new ut.a7(pt),u_viewport:new ut.a8(pt)}))(pt)),Lt.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(pt=>({u_cutoff_params:new ut.as(pt)}))(pt)),Lt.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(pt=>({u_lighting_ambient_color:new ut.aq(pt),u_lighting_directional_dir:new ut.aq(pt),u_lighting_directional_color:new ut.aq(pt),u_ground_radiance:new ut.aq(pt)}))(pt)),Lt.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(pt=>({u_light_matrix_0:new ut.a6(pt),u_light_matrix_1:new ut.a6(pt),u_fade_range:new ut.a8(pt),u_shadow_normal_offset:new ut.aq(pt),u_shadow_intensity:new ut.aa(pt),u_shadow_texel_size:new ut.aa(pt),u_shadow_map_resolution:new ut.aa(pt),u_shadow_direction:new ut.aq(pt),u_shadow_bias:new ut.aq(pt),u_shadowmap_0:new ut.a7(pt),u_shadowmap_1:new ut.a7(pt)}))(pt))}}setTerrainUniformValues(ut,pt){if(!this.terrainUniforms)return;const wt=this.terrainUniforms;if(!this.failedToCreate){ut.program.set(this.program);for(const ut in pt)wt[ut]&&wt[ut].set(this.program,ut,pt[ut])}}setGlobeUniformValues(ut,pt){if(!this.globeUniforms)return;const wt=this.globeUniforms;if(!this.failedToCreate){ut.program.set(this.program);for(const ut in pt)wt[ut]&&wt[ut].set(this.program,ut,pt[ut])}}setFogUniformValues(ut,pt){if(!this.fogUniforms)return;const wt=this.fogUniforms;if(!this.failedToCreate){ut.program.set(this.program);for(const ut in pt)wt[ut].set(this.program,ut,pt[ut])}}setCutoffUniformValues(ut,pt){if(!this.cutoffUniforms)return;const wt=this.cutoffUniforms;if(!this.failedToCreate){ut.program.set(this.program);for(const ut in pt)wt[ut].set(this.program,ut,pt[ut])}}setLightsUniformValues(ut,pt){if(!this.lightsUniforms)return;const wt=this.lightsUniforms;if(!this.failedToCreate){ut.program.set(this.program);for(const ut in pt)wt[ut].set(this.program,ut,pt[ut])}}setShadowUniformValues(ut,pt){if(this.failedToCreate||!this.shadowUniforms)return;const wt=this.shadowUniforms;ut.program.set(this.program);for(const ut in pt)wt[ut].set(this.program,ut,pt[ut])}_drawDebugWireframe(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr){const br=pt.options.wireframe;if(!1===br.terrain&&!1===br.layers2D&&!1===br.layers3D)return;const Ar=pt.context;if(!(()=>!(!br.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!br.layers2D||pt._terrain&&pt._terrain.renderingToTexture||!bo.includes(this.name))||!(!br.layers3D||!ko.includes(this.name)))())return;const Vr=Ar.gl,nn=pt.wireframeDebugCache.getLinesFromTrianglesBuffer(pt.frameCounter,It,Ar);if(!nn)return;const sn=[...this.fixedDefines];sn.push("DEBUG_WIREFRAME");const an=pt.getOrCreateProgram(this.name,{config:this.configuration,defines:sn});Ar.program.set(an.program);const g=(ut,pt,wt)=>{if(pt[ut]&&wt[ut])for(const Tt in pt[ut])wt[ut][Tt]&&wt[ut][Tt].set(wt.program,Tt,pt[ut][Tt].current)};Mi&&Mi.setUniforms(an.program,Ar,an.binderUniforms,Xt,{zoom:Yt}),g("fixedUniforms",this,an),g("terrainUniforms",this,an),g("globeUniforms",this,an),g("fogUniforms",this,an),g("lightsUniforms",this,an),g("shadowUniforms",this,an),nn.bind(),Ar.setColorMode(new ut.a([Vr.ONE,Vr.ONE_MINUS_SRC_ALPHA,Vr.ZERO,Vr.ONE],ut.C.transparent,[!0,!0,!0,!1])),Ar.setDepthMode(new ut.ae(wt.func===Vr.LESS?Vr.LEQUAL:wt.func,ut.ae.ReadOnly,wt.range)),Ar.setStencilMode(ut.ag.disabled);const ln=3*Lt.primitiveLength*2,cn=3*Lt.primitiveOffset*2*2;vr&&vr>1?Vr.drawElementsInstanced(Vr.LINES,ln,Vr.UNSIGNED_SHORT,cn,vr):Vr.drawElements(Vr.LINES,ln,Vr.UNSIGNED_SHORT,cn),It.bind(),Ar.program.set(this.program),Ar.setDepthMode(wt),Ar.setStencilMode(Tt),Ar.setColorMode(St)}draw(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){const an=ut.context,ln=an.gl;if(this.failedToCreate)return;an.program.set(this.program),an.setDepthMode(wt),an.setStencilMode(Tt),an.setColorMode(St),an.setCullFace(It);for(const ut of Object.keys(this.fixedUniforms))this.fixedUniforms[ut].set(this.program,ut,Lt[ut]);Vr&&Vr.setUniforms(this.program,an,this.binderUniforms,br,{zoom:Ar});const cn={[ln.POINTS]:1,[ln.LINES]:2,[ln.TRIANGLES]:3,[ln.LINE_STRIP]:1}[pt],un=sn&&sn>0?1:void 0;for(const It of vr.get()){const Lt=It.vaos||(It.vaos={});(Lt[Xt]||(Lt[Xt]=new Rt)).bind(an,this,Yt,Vr?Vr.getPaintVertexBuffers():[],Mi,It.vertexOffset,nn||[],un),sn&&sn>1?ln.drawElementsInstanced(pt,It.primitiveLength*cn,ln.UNSIGNED_SHORT,It.primitiveOffset*cn*2,sn):Mi?ln.drawElements(pt,It.primitiveLength*cn,ln.UNSIGNED_SHORT,It.primitiveOffset*cn*2):ln.drawArrays(pt,It.vertexOffset,It.vertexLength),pt===ln.TRIANGLES&&Mi&&this._drawDebugWireframe(ut,wt,Tt,St,Mi,It,br,Ar,Vr,sn)}}}function Vi(pt,wt){const Tt=Math.pow(2,wt.tileID.overscaledZ),St=wt.tileSize*Math.pow(2,pt.transform.tileZoom)/Tt,It=St*(wt.tileID.canonical.x+wt.tileID.wrap*Tt),Lt=St*wt.tileID.canonical.y;return{u_image:0,u_texsize:wt.imageAtlasTexture?wt.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/ut.bB(wt,1,pt.transform.tileZoom),u_pixel_coord_upper:[It>>16,Lt>>16],u_pixel_coord_lower:[65535&It,65535&Lt]}}const No=ut.ad.create(),Zi=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an)=>{const ln=wt.style.light,cn=ln.properties.get("position"),un=[cn.x,cn.y,cn.z],fn=ut.bC.create();"viewport"===ln.properties.get("anchor")&&(ut.bC.fromRotation(fn,-wt.transform.angle),ut._.transformMat3(un,un,fn));const _n=ln.properties.get("color"),gn=wt.transform,yn={u_matrix:pt,u_lightpos:un,u_lightintensity:ln.properties.get("intensity"),u_lightcolor:[_n.r,_n.g,_n.b],u_vertical_gradient:+Tt,u_opacity:St,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:No,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:It,u_edge_radius:Lt,u_flood_light_color:Ar,u_vertical_scale:Vr,u_flood_light_intensity:nn,u_ground_shadow_factor:sn,u_emissive_strength:an};return"globe"===gn.projection.name&&(yn.u_tile_id=[Xt.canonical.x,Xt.canonical.y,1<<Xt.canonical.z],yn.u_zoom_transition=Mi,yn.u_inv_rot_matrix=br,yn.u_merc_center=vr,yn.u_up_dir=gn.projection.upVector(new ut.aO(0,0,0),vr[0]*ut.a3,vr[1]*ut.a3),yn.u_height_lift=Yt),yn},qi=(ut,pt,wt)=>({u_matrix:ut,u_edge_radius:pt,u_vertical_scale:wt}),Hi=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn)=>{const sn=Zi(pt,wt,Tt,St,It,Lt,Xt,Mi,vr,br,Ar,Vr,nn,1,[0,0,0],0),an={u_height_factor:-Math.pow(2,Xt.overscaledZ)/Yt.tileSize/8};return ut.W(sn,Vi(wt,Yt),an)},$i=(ut,pt)=>({u_matrix:ut,u_emissive_strength:pt}),Xi=(pt,wt,Tt,St)=>ut.W($i(pt,wt),Vi(Tt,St)),Yi=(ut,pt,wt)=>({u_matrix:ut,u_world:wt,u_emissive_strength:pt}),Ki=(pt,wt,Tt,St,It)=>ut.W(Xi(pt,wt,Tt,St),{u_world:It}),Qi=(pt,wt,Tt,St)=>{const It=ut.a3/Tt.tileSize;return{u_matrix:pt,u_camera_to_center_distance:wt.getCameraToCenterDistance(St),u_extrude_scale:[wt.pixelsToGLUnits[0]/It,wt.pixelsToGLUnits[1]/It]}},Ji=(ut,pt,wt=1)=>({u_matrix:ut,u_color:pt.toRenderColor(null),u_overlay:0,u_overlay_scale:wt}),Js=ut.ad.create(),to=(pt,wt,Tt,St,It,Lt,Xt)=>{const Yt=pt.transform,Mi="globe"===Yt.projection.name,vr=Mi?ut.bD(Yt.zoom,wt.canonical)*Yt._pixelsPerMercatorPixel:ut.bB(Tt,1,Lt),br={u_matrix:wt.projMatrix,u_extrude_scale:vr,u_intensity:Xt,u_inv_rot_matrix:Js,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(Mi){br.u_inv_rot_matrix=St,br.u_merc_center=It,br.u_tile_id=[wt.canonical.x,wt.canonical.y,1<<wt.canonical.z],br.u_zoom_transition=ut.a1(Yt.zoom);const pt=It[0]*ut.a3,Tt=It[1]*ut.a3;br.u_up_dir=Yt.projection.upVector(new ut.aO(0,0,0),pt,Tt)}return br};function io(ut,[pt,wt,Tt,St],[It,Lt]){if(It===Lt)return[0,0,0,0];const Xt=255*(ut-1)/(ut*(Lt-It));return[pt*Xt,wt*Xt,Tt*Xt,St*Xt]}function oo(ut,pt,[wt,Tt]){return wt===Tt?0:.5/ut+(pt-wt)*(ut-1)/(ut*(Tt-wt))}const ro=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un,fn,_n)=>({u_matrix:pt,u_normalize_matrix:wt,u_globe_matrix:Tt,u_merc_matrix:St,u_grid_matrix:It,u_tl_parent:Lt,u_scale_parent:vr,u_fade_t:br.mix,u_opacity:br.opacity*Ar.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:Ar.paint.get("raster-brightness-min"),u_brightness_high:Ar.paint.get("raster-brightness-max"),u_saturation_factor:ut.bE(Ar.paint.get("raster-saturation")),u_contrast_factor:ut.bF(Ar.paint.get("raster-contrast")),u_spin_weights:ao(Ar.paint.get("raster-hue-rotate")),u_perspective_transform:Vr,u_raster_elevation:nn,u_zoom_transition:Xt,u_merc_center:Yt,u_cutoff_params:Mi,u_colorization_mix:io(ut.bG,an,cn),u_colorization_offset:oo(ut.bG,ln,cn),u_color_ramp:sn,u_texture_offset:[fn/(un+2*fn),un/(un+2*fn)],u_texture_res:[un+2*fn,un+2*fn],u_emissive_strength:_n});function ao(ut){ut*=Math.PI/180;const pt=Math.sin(ut),wt=Math.cos(ut);return[(2*wt+1)/3,(-Math.sqrt(3)*pt-wt+1)/3,(Math.sqrt(3)*pt-wt+1)/3]}const ua=.15,no=(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br)=>({u_matrix:ut,u_normalize_matrix:pt,u_globe_matrix:wt,u_merc_matrix:Tt,u_grid_matrix:St,u_tl_parent:It,u_scale_parent:Mi,u_fade_t:vr.mix,u_opacity:vr.opacity,u_image0:0,u_image1:1,u_raster_elevation:br,u_zoom_transition:Lt,u_merc_center:Xt,u_cutoff_params:Yt}),lo=(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi)=>({u_particle_texture:ut,u_particle_texture_side_len:pt,u_tile_offset:wt,u_velocity:Tt,u_color_ramp:It,u_velocity_res:St,u_max_speed:Lt,u_uv_offset:Xt,u_data_scale:Yt,u_data_offset:Mi,u_particle_pos_scale:1.3,u_particle_pos_offset:[ua,ua]}),co=(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi)=>({u_particle_texture:ut,u_particle_texture_side_len:pt,u_velocity:wt,u_velocity_res:Tt,u_max_speed:St,u_speed_factor:It,u_reset_rate:Lt,u_rand_seed:Math.random(),u_uv_offset:Xt,u_data_scale:Yt,u_data_offset:Mi,u_particle_pos_scale:1.3,u_particle_pos_offset:[ua,ua]}),ga=ut.ad.create(),uo=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn)=>{const un=It.transform,fn={u_is_size_zoom_constant:+("constant"===pt||"source"===pt),u_is_size_feature_constant:+("constant"===pt||"camera"===pt),u_size_t:wt?wt.uSizeT:0,u_size:wt?wt.uSize:0,u_camera_to_center_distance:un.getCameraToCenterDistance(an),u_rotate_symbol:+Tt,u_aspect_ratio:un.width/un.height,u_fade_change:It.options.fadeDuration?It.symbolFadeChange:1,u_matrix:Lt,u_label_plane_matrix:Xt,u_coord_matrix:Yt,u_is_text:+Mi,u_pitch_with_map:+St,u_texsize:vr,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ga,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:ga,u_up_vector:[0,-1,0],u_color_adj_mat:ln,u_icon_transition:cn||0};return"globe"===an.name&&(fn.u_tile_id=[br.canonical.x,br.canonical.y,1<<br.canonical.z],fn.u_zoom_transition=Ar,fn.u_inv_rot_matrix=nn,fn.u_merc_center=Vr,fn.u_camera_forward=un._camera.forward(),fn.u_ecef_origin=ut.bH(un.globeMatrix,br.toUnwrapped()),fn.u_tile_matrix=Float32Array.from(un.globeMatrix),fn.u_up_vector=sn),fn},_o=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln)=>ut.W(uo(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,Ar,Vr,nn,sn,an,ln),{u_gamma_scale:St?It.transform.getCameraToCenterDistance(ln)*Math.cos(It.terrain?0:It.transform._pitch):1,u_device_pixel_ratio:ut.e.devicePixelRatio,u_is_halo:+br,undefined:void 0}),po=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an)=>ut.W(_o(pt,wt,Tt,St,It,Lt,Xt,Yt,!0,Mi,!0,br,Ar,Vr,nn,sn,an),{u_texsize_icon:vr,u_texture_icon:1}),fo=(ut,pt,wt,Tt)=>({u_matrix:ut,u_emissive_strength:pt,u_opacity:wt,u_color:Tt}),mo=(pt,wt,Tt,St,It,Lt,Xt,Yt)=>ut.W(function(pt,wt,Tt,St,It){const{width:Lt,height:Xt}=St.imageManager.getPixelSize(wt),Yt=Math.pow(2,It.tileID.overscaledZ),Mi=It.tileSize*Math.pow(2,St.transform.tileZoom)/Yt,vr=Mi*(It.tileID.canonical.x+It.tileID.wrap*Yt),br=Mi*It.tileID.canonical.y;return{u_image:0,u_pattern_tl:Tt.tl,u_pattern_br:Tt.br,u_texsize:[Lt,Xt],u_pattern_size:Tt.displaySize,u_tile_units_to_pixels:1/ut.bB(It,1,St.transform.tileZoom),u_pixel_coord_upper:[vr>>16,br>>16],u_pixel_coord_lower:[65535&vr,65535&br]}}(0,Lt,Xt,St,Yt),{u_matrix:pt,u_emissive_strength:wt,u_opacity:Tt}),xa=new Float32Array(ut.ad.identity([])),vo=(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn=[0,0,0],sn)=>{const an=It.style.light,ln=an.properties.get("position"),cn=[-ln.x,-ln.y,ln.z],un=ut.bC.create();"viewport"===an.properties.get("anchor")&&(ut.bC.fromRotation(un,-It.transform.angle),ut._.transformMat3(cn,cn,un));const fn="MASK"===br.alphaMode,_n=an.properties.get("color").toRenderColor(null),gn=Vr.paint.get("model-ambient-occlusion-intensity"),yn=Vr.paint.get("model-color").constantOr(ut.C.white).toRenderColor(null),xn=Vr.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:pt,u_lighting_matrix:wt,u_normal_matrix:Tt,u_node_matrix:St||xa,u_lightpos:cn,u_lightintensity:an.properties.get("intensity"),u_lightcolor:[_n.r,_n.g,_n.b],u_camera_pos:nn,u_opacity:Lt,u_baseTextureIsAlpha:0,u_alphaMask:+fn,u_alphaCutoff:br.alphaCutoff,u_baseColorFactor:[Xt.r,Xt.g,Xt.b,Xt.a],u_emissiveFactor:[Yt[0],Yt[1],Yt[2],1],u_metallicFactor:Mi,u_roughnessFactor:vr,u_baseColorTexture:Bn.BaseColor,u_metallicRoughnessTexture:Bn.MetallicRoughness,u_normalTexture:Bn.Normal,u_occlusionTexture:Bn.Occlusion,u_emissionTexture:Bn.Emission,u_lutTexture:Bn.LUT,u_color_mix:[yn.r,yn.g,yn.b,xn],u_aoIntensity:gn,u_emissive_strength:Ar,u_occlusionTextureTransform:sn||[0,0,0,0]}},xo=(ut,pt=xa,wt=xa)=>({u_matrix:ut,u_instance:pt,u_node_matrix:wt}),yo=(ut,pt,wt,Tt,St)=>({u_matrix:Float32Array.from(ut),u_anchorPos:pt,u_screenSizePx:wt,u_occluderSizePx:Tt,u_color:St}),Ra={fillExtrusion:pt=>({u_matrix:new ut.a6(pt),u_lightpos:new ut.aq(pt),u_lightintensity:new ut.aa(pt),u_lightcolor:new ut.aq(pt),u_vertical_gradient:new ut.aa(pt),u_opacity:new ut.aa(pt),u_edge_radius:new ut.aa(pt),u_ao:new ut.a8(pt),u_tile_id:new ut.aq(pt),u_zoom_transition:new ut.aa(pt),u_inv_rot_matrix:new ut.a6(pt),u_merc_center:new ut.a8(pt),u_up_dir:new ut.aq(pt),u_height_lift:new ut.aa(pt),u_flood_light_color:new ut.aq(pt),u_vertical_scale:new ut.aa(pt),u_flood_light_intensity:new ut.aa(pt),u_ground_shadow_factor:new ut.aq(pt),u_emissive_strength:new ut.aa(pt)}),fillExtrusionDepth:pt=>({u_matrix:new ut.a6(pt),u_edge_radius:new ut.aa(pt),u_vertical_scale:new ut.aa(pt)}),fillExtrusionPattern:pt=>({u_matrix:new ut.a6(pt),u_lightpos:new ut.aq(pt),u_lightintensity:new ut.aa(pt),u_lightcolor:new ut.aq(pt),u_vertical_gradient:new ut.aa(pt),u_height_factor:new ut.aa(pt),u_edge_radius:new ut.aa(pt),u_ao:new ut.a8(pt),u_tile_id:new ut.aq(pt),u_zoom_transition:new ut.aa(pt),u_inv_rot_matrix:new ut.a6(pt),u_merc_center:new ut.a8(pt),u_up_dir:new ut.aq(pt),u_height_lift:new ut.aa(pt),u_image:new ut.a7(pt),u_texsize:new ut.a8(pt),u_pixel_coord_upper:new ut.a8(pt),u_pixel_coord_lower:new ut.a8(pt),u_tile_units_to_pixels:new ut.aa(pt),u_opacity:new ut.aa(pt)}),fillExtrusionGroundEffect:pt=>({u_matrix:new ut.a6(pt),u_opacity:new ut.aa(pt),u_ao_pass:new ut.aa(pt),u_meter_to_tile:new ut.aa(pt),u_ao:new ut.a8(pt),u_flood_light_intensity:new ut.aa(pt),u_flood_light_color:new ut.aq(pt),u_attenuation:new ut.aa(pt),u_edge_radius:new ut.aa(pt),u_fb:new ut.a7(pt),u_fb_size:new ut.aa(pt)}),fill:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt)}),fillPattern:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt),u_image:new ut.a7(pt),u_texsize:new ut.a8(pt),u_pixel_coord_upper:new ut.a8(pt),u_pixel_coord_lower:new ut.a8(pt),u_tile_units_to_pixels:new ut.aa(pt)}),fillOutline:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt),u_world:new ut.a8(pt)}),fillOutlinePattern:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt),u_world:new ut.a8(pt),u_image:new ut.a7(pt),u_texsize:new ut.a8(pt),u_pixel_coord_upper:new ut.a8(pt),u_pixel_coord_lower:new ut.a8(pt),u_tile_units_to_pixels:new ut.aa(pt)}),circle:ut.bI,collisionBox:pt=>({u_matrix:new ut.a6(pt),u_camera_to_center_distance:new ut.aa(pt),u_extrude_scale:new ut.a8(pt)}),collisionCircle:pt=>({u_matrix:new ut.a6(pt),u_inv_matrix:new ut.a6(pt),u_camera_to_center_distance:new ut.aa(pt),u_viewport_size:new ut.a8(pt)}),debug:pt=>({u_color:new ut.a9(pt),u_matrix:new ut.a6(pt),u_overlay:new ut.a7(pt),u_overlay_scale:new ut.aa(pt)}),clippingMask:pt=>({u_matrix:new ut.a6(pt)}),heatmap:pt=>({u_extrude_scale:new ut.aa(pt),u_intensity:new ut.aa(pt),u_matrix:new ut.a6(pt),u_inv_rot_matrix:new ut.a6(pt),u_merc_center:new ut.a8(pt),u_tile_id:new ut.aq(pt),u_zoom_transition:new ut.aa(pt),u_up_dir:new ut.aq(pt)}),heatmapTexture:pt=>({u_image:new ut.a7(pt),u_color_ramp:new ut.a7(pt),u_opacity:new ut.aa(pt)}),hillshade:pt=>({u_matrix:new ut.a6(pt),u_image:new ut.a7(pt),u_latrange:new ut.a8(pt),u_light:new ut.a8(pt),u_shadow:new ut.a9(pt),u_highlight:new ut.a9(pt),u_emissive_strength:new ut.aa(pt),u_accent:new ut.a9(pt)}),hillshadePrepare:pt=>({u_matrix:new ut.a6(pt),u_image:new ut.a7(pt),u_dimension:new ut.a8(pt),u_zoom:new ut.aa(pt)}),line:ut.bJ,linePattern:ut.bK,raster:pt=>({u_matrix:new ut.a6(pt),u_normalize_matrix:new ut.a6(pt),u_globe_matrix:new ut.a6(pt),u_merc_matrix:new ut.a6(pt),u_grid_matrix:new ut.ar(pt),u_tl_parent:new ut.a8(pt),u_scale_parent:new ut.aa(pt),u_fade_t:new ut.aa(pt),u_opacity:new ut.aa(pt),u_image0:new ut.a7(pt),u_image1:new ut.a7(pt),u_brightness_low:new ut.aa(pt),u_brightness_high:new ut.aa(pt),u_saturation_factor:new ut.aa(pt),u_contrast_factor:new ut.aa(pt),u_spin_weights:new ut.aq(pt),u_perspective_transform:new ut.a8(pt),u_raster_elevation:new ut.aa(pt),u_zoom_transition:new ut.aa(pt),u_merc_center:new ut.a8(pt),u_cutoff_params:new ut.as(pt),u_colorization_mix:new ut.as(pt),u_colorization_offset:new ut.aa(pt),u_color_ramp:new ut.a7(pt),u_texture_offset:new ut.a8(pt),u_texture_res:new ut.a8(pt),u_emissive_strength:new ut.aa(pt)}),rasterParticle:pt=>({u_matrix:new ut.a6(pt),u_normalize_matrix:new ut.a6(pt),u_globe_matrix:new ut.a6(pt),u_merc_matrix:new ut.a6(pt),u_grid_matrix:new ut.ar(pt),u_tl_parent:new ut.a8(pt),u_scale_parent:new ut.aa(pt),u_fade_t:new ut.aa(pt),u_opacity:new ut.aa(pt),u_image0:new ut.a7(pt),u_image1:new ut.a7(pt),u_raster_elevation:new ut.aa(pt),u_zoom_transition:new ut.aa(pt),u_merc_center:new ut.a8(pt),u_cutoff_params:new ut.as(pt)}),rasterParticleTexture:pt=>({u_texture:new ut.a7(pt),u_opacity:new ut.aa(pt)}),rasterParticleDraw:pt=>({u_particle_texture:new ut.a7(pt),u_particle_texture_side_len:new ut.aa(pt),u_tile_offset:new ut.a8(pt),u_velocity:new ut.a7(pt),u_color_ramp:new ut.a7(pt),u_velocity_res:new ut.a8(pt),u_max_speed:new ut.aa(pt),u_uv_offset:new ut.a8(pt),u_data_scale:new ut.as(pt),u_data_offset:new ut.aa(pt),u_particle_pos_scale:new ut.aa(pt),u_particle_pos_offset:new ut.a8(pt)}),rasterParticleUpdate:pt=>({u_particle_texture:new ut.a7(pt),u_particle_texture_side_len:new ut.aa(pt),u_velocity:new ut.a7(pt),u_velocity_res:new ut.a8(pt),u_max_speed:new ut.aa(pt),u_speed_factor:new ut.aa(pt),u_reset_rate:new ut.aa(pt),u_rand_seed:new ut.aa(pt),u_uv_offset:new ut.a8(pt),u_data_scale:new ut.as(pt),u_data_offset:new ut.aa(pt),u_particle_pos_scale:new ut.aa(pt),u_particle_pos_offset:new ut.a8(pt)}),symbolIcon:pt=>({u_is_size_zoom_constant:new ut.a7(pt),u_is_size_feature_constant:new ut.a7(pt),u_size_t:new ut.aa(pt),u_size:new ut.aa(pt),u_camera_to_center_distance:new ut.aa(pt),u_rotate_symbol:new ut.a7(pt),u_aspect_ratio:new ut.aa(pt),u_fade_change:new ut.aa(pt),u_matrix:new ut.a6(pt),u_label_plane_matrix:new ut.a6(pt),u_coord_matrix:new ut.a6(pt),u_is_text:new ut.a7(pt),u_pitch_with_map:new ut.a7(pt),u_texsize:new ut.a8(pt),u_tile_id:new ut.aq(pt),u_zoom_transition:new ut.aa(pt),u_inv_rot_matrix:new ut.a6(pt),u_merc_center:new ut.a8(pt),u_camera_forward:new ut.aq(pt),u_tile_matrix:new ut.a6(pt),u_up_vector:new ut.aq(pt),u_ecef_origin:new ut.aq(pt),u_texture:new ut.a7(pt),u_icon_transition:new ut.aa(pt),u_color_adj_mat:new ut.a6(pt)}),symbolSDF:pt=>({u_is_size_zoom_constant:new ut.a7(pt),u_is_size_feature_constant:new ut.a7(pt),u_size_t:new ut.aa(pt),u_size:new ut.aa(pt),u_camera_to_center_distance:new ut.aa(pt),u_rotate_symbol:new ut.a7(pt),u_aspect_ratio:new ut.aa(pt),u_fade_change:new ut.aa(pt),u_matrix:new ut.a6(pt),u_label_plane_matrix:new ut.a6(pt),u_coord_matrix:new ut.a6(pt),u_is_text:new ut.a7(pt),u_pitch_with_map:new ut.a7(pt),u_texsize:new ut.a8(pt),u_texture:new ut.a7(pt),u_gamma_scale:new ut.aa(pt),u_device_pixel_ratio:new ut.aa(pt),u_tile_id:new ut.aq(pt),u_zoom_transition:new ut.aa(pt),u_inv_rot_matrix:new ut.a6(pt),u_merc_center:new ut.a8(pt),u_camera_forward:new ut.aq(pt),u_tile_matrix:new ut.a6(pt),u_up_vector:new ut.aq(pt),u_ecef_origin:new ut.aq(pt),u_is_halo:new ut.a7(pt)}),symbolTextAndIcon:pt=>({u_is_size_zoom_constant:new ut.a7(pt),u_is_size_feature_constant:new ut.a7(pt),u_size_t:new ut.aa(pt),u_size:new ut.aa(pt),u_camera_to_center_distance:new ut.aa(pt),u_rotate_symbol:new ut.a7(pt),u_aspect_ratio:new ut.aa(pt),u_fade_change:new ut.aa(pt),u_matrix:new ut.a6(pt),u_label_plane_matrix:new ut.a6(pt),u_coord_matrix:new ut.a6(pt),u_is_text:new ut.a7(pt),u_pitch_with_map:new ut.a7(pt),u_texsize:new ut.a8(pt),u_texsize_icon:new ut.a8(pt),u_texture:new ut.a7(pt),u_texture_icon:new ut.a7(pt),u_gamma_scale:new ut.aa(pt),u_device_pixel_ratio:new ut.aa(pt),u_is_halo:new ut.a7(pt)}),background:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt),u_opacity:new ut.aa(pt),u_color:new ut.a9(pt)}),backgroundPattern:pt=>({u_matrix:new ut.a6(pt),u_emissive_strength:new ut.aa(pt),u_opacity:new ut.aa(pt),u_image:new ut.a7(pt),u_pattern_tl:new ut.a8(pt),u_pattern_br:new ut.a8(pt),u_texsize:new ut.a8(pt),u_pattern_size:new ut.a8(pt),u_pixel_coord_upper:new ut.a8(pt),u_pixel_coord_lower:new ut.a8(pt),u_tile_units_to_pixels:new ut.aa(pt)}),terrainRaster:Ut,terrainDepth:Ut,skybox:pt=>({u_matrix:new ut.a6(pt),u_sun_direction:new ut.aq(pt),u_cubemap:new ut.a7(pt),u_opacity:new ut.aa(pt),u_temporal_offset:new ut.aa(pt)}),skyboxGradient:pt=>({u_matrix:new ut.a6(pt),u_color_ramp:new ut.a7(pt),u_center_direction:new ut.aq(pt),u_radius:new ut.aa(pt),u_opacity:new ut.aa(pt),u_temporal_offset:new ut.aa(pt)}),skyboxCapture:pt=>({u_matrix_3f:new ut.ar(pt),u_sun_direction:new ut.aq(pt),u_sun_intensity:new ut.aa(pt),u_color_tint_r:new ut.as(pt),u_color_tint_m:new ut.as(pt),u_luminance:new ut.aa(pt)}),globeRaster:pt=>({u_proj_matrix:new ut.a6(pt),u_globe_matrix:new ut.a6(pt),u_normalize_matrix:new ut.a6(pt),u_merc_matrix:new ut.a6(pt),u_zoom_transition:new ut.aa(pt),u_merc_center:new ut.a8(pt),u_image0:new ut.a7(pt),u_grid_matrix:new ut.ar(pt),u_skirt_height:new ut.aa(pt),u_far_z_cutoff:new ut.aa(pt),u_frustum_tl:new ut.aq(pt),u_frustum_tr:new ut.aq(pt),u_frustum_br:new ut.aq(pt),u_frustum_bl:new ut.aq(pt),u_globe_pos:new ut.aq(pt),u_globe_radius:new ut.aa(pt),u_viewport:new ut.a8(pt)}),globeAtmosphere:pt=>({u_frustum_tl:new ut.aq(pt),u_frustum_tr:new ut.aq(pt),u_frustum_br:new ut.aq(pt),u_frustum_bl:new ut.aq(pt),u_horizon:new ut.aa(pt),u_transition:new ut.aa(pt),u_fadeout_range:new ut.aa(pt),u_color:new ut.as(pt),u_high_color:new ut.as(pt),u_space_color:new ut.as(pt),u_temporal_offset:new ut.aa(pt),u_horizon_angle:new ut.aa(pt)}),model:pt=>({u_matrix:new ut.a6(pt),u_lighting_matrix:new ut.a6(pt),u_normal_matrix:new ut.a6(pt),u_node_matrix:new ut.a6(pt),u_lightpos:new ut.aq(pt),u_lightintensity:new ut.aa(pt),u_lightcolor:new ut.aq(pt),u_camera_pos:new ut.aq(pt),u_opacity:new ut.aa(pt),u_baseColorFactor:new ut.as(pt),u_emissiveFactor:new ut.as(pt),u_metallicFactor:new ut.aa(pt),u_roughnessFactor:new ut.aa(pt),u_baseTextureIsAlpha:new ut.a7(pt),u_alphaMask:new ut.a7(pt),u_alphaCutoff:new ut.aa(pt),u_baseColorTexture:new ut.a7(pt),u_metallicRoughnessTexture:new ut.a7(pt),u_normalTexture:new ut.a7(pt),u_occlusionTexture:new ut.a7(pt),u_emissionTexture:new ut.a7(pt),u_lutTexture:new ut.a7(pt),u_color_mix:new ut.as(pt),u_aoIntensity:new ut.aa(pt),u_emissive_strength:new ut.aa(pt),u_occlusionTextureTransform:new ut.as(pt)}),modelDepth:pt=>({u_matrix:new ut.a6(pt),u_instance:new ut.a6(pt),u_node_matrix:new ut.a6(pt)}),groundShadow:pt=>({u_matrix:new ut.a6(pt),u_ground_shadow_factor:new ut.aq(pt)}),stars:pt=>({u_matrix:new ut.a6(pt),u_up:new ut.aq(pt),u_right:new ut.aq(pt),u_intensity_multiplier:new ut.aa(pt)}),occlusion:pt=>({u_matrix:new ut.a6(pt),u_anchorPos:new ut.aq(pt),u_screenSizePx:new ut.a8(pt),u_occluderSizePx:new ut.a8(pt),u_color:new ut.as(pt)})};function wo(pt,wt,Tt){const St=wt.createTileMatrix(pt,pt.worldSize,Tt.toUnwrapped());return ut.ad.multiply(new Float32Array(16),pt.projMatrix,St)}function To(ut,pt,wt){if(pt.projection.name===wt.projection.name)return ut.projMatrix;const Tt=wt.clone();return Tt.setProjection(pt.projection),wo(Tt,pt.getProjection(),ut)}function Eo(ut,pt,wt){return pt.name===wt.projection.name?ut.projMatrix:wo(wt,pt,ut)}let Da;function So(pt,wt,Tt,St,It,Lt,Xt){const Yt=pt.context,Mi=Yt.gl,vr=pt.transform,br=pt.getOrCreateProgram("collisionBox"),Ar=[];let Vr=0,nn=0;for(let Yt=0;Yt<St.length;Yt++){const sn=St[Yt],an=wt.getTile(sn),ln=an.getBucket(Tt);if(!ln)continue;const cn=To(sn,ln,vr);let un=cn;0===It[0]&&0===It[1]||(un=pt.translatePosMatrix(cn,an,It,Lt));const fn=Xt?ln.textCollisionBox:ln.iconCollisionBox,_n=ln.collisionCircleArray;if(_n.length>0){const pt=ut.ad.create(),wt=un;ut.ad.mul(pt,ln.placementInvProjMatrix,vr.glCoordMatrix),ut.ad.mul(pt,pt,ln.placementViewportMatrix),Ar.push({circleArray:_n,circleOffset:nn,transform:wt,invTransform:pt,projection:ln.getProjection()}),Vr+=_n.length/4,nn=Vr}fn&&(pt.terrain&&pt.terrain.setupElevationDraw(an,br),br.draw(pt,Mi.LINES,ut.ae.disabled,ut.ag.disabled,pt.colorModeForRenderPass(),ut.af.disabled,Qi(un,vr,an,ln.getProjection()),Tt.id,fn.layoutVertexBuffer,fn.indexBuffer,fn.segments,null,vr.zoom,null,[fn.collisionVertexBuffer,fn.collisionVertexBufferExt]))}if(!Xt||!Ar.length)return;const sn=pt.getOrCreateProgram("collisionCircle"),an=new ut.bL;an.resize(4*Vr),an._trim();let ln=0;for(const ut of Ar)for(let pt=0;pt<ut.circleArray.length/4;pt++){const wt=4*pt,Tt=ut.circleArray[wt+0],St=ut.circleArray[wt+1],It=ut.circleArray[wt+2],Lt=ut.circleArray[wt+3];an.emplace(ln++,Tt,St,It,Lt,0),an.emplace(ln++,Tt,St,It,Lt,1),an.emplace(ln++,Tt,St,It,Lt,2),an.emplace(ln++,Tt,St,It,Lt,3)}(!Da||Da.length<2*Vr)&&(Da=function(pt){const wt=2*pt,Tt=new ut.bu;Tt.resize(wt),Tt._trim();for(let ut=0;ut<wt;ut++){const pt=6*ut;Tt.uint16[pt+0]=4*ut+0,Tt.uint16[pt+1]=4*ut+1,Tt.uint16[pt+2]=4*ut+2,Tt.uint16[pt+3]=4*ut+2,Tt.uint16[pt+4]=4*ut+3,Tt.uint16[pt+5]=4*ut+0}return Tt}(Vr));const cn=Yt.createIndexBuffer(Da,!0),un=Yt.createVertexBuffer(an,ut.bM.members,!0);for(const wt of Ar){const St={u_matrix:wt.transform,u_inv_matrix:wt.invTransform,u_camera_to_center_distance:(fn=vr).getCameraToCenterDistance(wt.projection),u_viewport_size:[fn.width,fn.height]};sn.draw(pt,Mi.TRIANGLES,ut.ae.disabled,ut.ag.disabled,pt.colorModeForRenderPass(),ut.af.disabled,St,Tt.id,un,cn,ut.b.simpleSegment(0,2*wt.circleOffset,wt.circleArray.length,wt.circleArray.length/2),null,vr.zoom)}var fn;un.destroy(),cn.destroy()}const ll=ut.ad.create();function Lo(pt){const wt=pt._camera.getWorldToCamera(pt.worldSize,1),Tt=ut.ad.multiply([],wt,pt.globeMatrix);ut.ad.invert(Tt,Tt);const St=[0,0,0],It=[0,1,0,0];return ut.aA.transformMat4(It,It,Tt),St[0]=It[0],St[1]=It[1],St[2]=It[2],ut._.normalize(St,St),St}function Po({width:pt,height:wt,anchor:Tt,textOffset:St,textScale:It},Lt){const{horizontalAlign:Xt,verticalAlign:Yt}=ut.bQ(Tt),Mi=-(Xt-.5)*pt,vr=-(Yt-.5)*wt,br=ut.bP(Tt,St);return new ut.P((Mi/It+br[0])*Lt,(vr/It+br[1])*Lt)}function Ao(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br){const Ar=pt.text.placedSymbolArray,Vr=pt.text.dynamicLayoutVertexArray,nn=pt.icon.dynamicLayoutVertexArray,sn={},an=pt.getProjection(),ln=Eo(Yt,an,Lt),cn=Lt.elevation,un=an.upVectorScale(Yt.canonical,Lt.center.lat,Lt.worldSize).metersToTile;Vr.clear();for(let nn=0;nn<Ar.length;nn++){const fn=Ar.get(nn),{tileAnchorX:_n,tileAnchorY:gn,numGlyphs:yn}=fn,xn=fn.hidden||!fn.crossTileID||pt.allowVerticalPlacement&&!fn.placedOrientation?null:St[fn.crossTileID];if(xn){let St=0,Ar=0,nn=0;if(cn){const ut=cn?cn.getAtTileOffset(Yt,_n,gn):0,[pt,wt,Tt]=an.upVector(Yt.canonical,_n,gn);St=ut*pt*un,Ar=ut*wt*un,nn=ut*Tt*un}let[vn,bn,wn,Tn]=ei(fn.projectedAnchorX+St,fn.projectedAnchorY+Ar,fn.projectedAnchorZ+nn,Tt?ln:Xt);const En=ti(Lt.getCameraToCenterDistance(an),Tn);let Mn=It.evaluateSizeForFeature(pt.textSizeData,vr,fn)*En/ut.bN;Tt&&(Mn*=pt.tilePixelRatio/Mi);const Sn=Po(xn,Mn);Tt?(({x:vn,y:bn,z:wn}=an.projectTilePoint(_n+Sn.x,gn+Sn.y,Yt.canonical)),[vn,bn,wn]=ei(vn+St,bn+Ar,wn+nn,Xt)):(wt&&Sn._rotate(-Lt.angle),vn+=Sn.x,bn+=Sn.y,wn=0);const An=pt.allowVerticalPlacement&&fn.placedOrientation===ut.aE.vertical?Math.PI/2:0;for(let pt=0;pt<yn;pt++)ut.aH(Vr,vn,bn,wn,An);br&&fn.associatedIconIndex>=0&&(sn[fn.associatedIconIndex]={x:vn,y:bn,z:wn,angle:An})}else hi(yn,Vr)}if(br){nn.clear();const wt=pt.icon.placedSymbolArray;for(let pt=0;pt<wt.length;pt++){const Tt=wt.get(pt),{numGlyphs:St}=Tt,It=sn[pt];if(Tt.hidden||!It)hi(St,nn);else{const{x:pt,y:wt,z:Tt,angle:Lt}=It;for(let It=0;It<St;It++)ut.aH(nn,pt,wt,Tt,Lt)}}pt.icon.dynamicLayoutVertexBuffer.updateData(nn)}pt.text.dynamicLayoutVertexBuffer.updateData(Vr)}function Ro(pt,wt,Tt,St,It,Lt,Xt={}){const Yt=Tt.paint.get("icon-translate"),Mi=Tt.paint.get("text-translate"),vr=Tt.paint.get("icon-translate-anchor"),br=Tt.paint.get("text-translate-anchor"),Ar=Tt.layout.get("icon-rotation-alignment"),Vr=Tt.layout.get("text-rotation-alignment"),nn=Tt.layout.get("icon-pitch-alignment"),sn=Tt.layout.get("text-pitch-alignment"),an=Tt.layout.get("icon-keep-upright"),ln=Tt.layout.get("text-keep-upright"),cn=Tt.paint.get("icon-color-saturation"),un=Tt.paint.get("icon-color-contrast"),fn=Tt.paint.get("icon-color-brightness-min"),_n=Tt.paint.get("icon-color-brightness-max"),gn=Tt.paint.get("icon-occlusion-opacity").constantOr(0),yn=Tt.paint.get("text-occlusion-opacity").constantOr(0),xn=pt.context,vn=xn.gl,bn=pt.transform,wn="map"===Ar,Tn="map"===Vr,En="map"===nn,Mn="map"===sn,Sn=1!==gn,An=1!==yn,In=void 0!==Tt.layout.get("symbol-sort-key").constantOr(1);let Pn=!1;const zn=pt.depthModeForSublayer(0,ut.ae.ReadOnly),Ln=[ut.aj(bn.center.lng),ut.ak(bn.center.lat)],kn=Tt.layout.get("text-variable-anchor"),Bn="globe"===bn.projection.name,Wn=[],Yn=[0,-1,0];for(const It of St){const St=wt.getTile(It),Lt=St.getBucket(Tt);if(!Lt)continue;if("mercator"===Lt.projection.name&&Bn)continue;if(Lt.fullyClipped)continue;const Ar="globe"===Lt.projection.name,Vr=Ar?ut.a1(bn.zoom):0,nn=Eo(It,Lt.getProjection(),bn),sn=bn.calculatePixelsToTileUnitsMatrix(St),gn=kn&&Lt.hasTextData(),yn=Lt.hasIconTextFit()&&gn&&Lt.hasIconData(),xn=Lt.getProjection().createInversionMatrix(bn,It.canonical),O=()=>{const wt=wn&&"point"!==Tt.layout.get("symbol-placement"),Xt=[];Tt.hasInitialOcclusionOpacityProperties&&Sn&&pt.symbolParams.useOcclusionQueries&&!Ar&&!Bn&&Xt.push("OCCLUSION_QUERIES"),Tt.hasInitialOcclusionOpacityProperties||Xt.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH");const Mi=wt||yn,br=Tt.paint.get("icon-image-cross-fade").constantOr(0);pt.terrainRenderModeElevated()&&En&&Xt.push("PITCH_WITH_MAP_TERRAIN"),Ar&&(Xt.push("PROJECTION_GLOBE_VIEW"),Mi&&Xt.push("PROJECTED_POS_ON_VIEWPORT")),br>0&&Xt.push("ICON_TRANSITION"),Lt.icon.zOffsetVertexBuffer&&Xt.push("Z_OFFSET"),0===cn&&0===un&&0===fn&&1===_n||Xt.push("COLOR_ADJUSTMENT");const ln=Lt.icon.programConfigurations.get(Tt.id),gn=pt.getOrCreateProgram(Lt.sdfIcons?"symbolSDF":"symbolIcon",{config:ln,defines:Xt});let Tn;const Mn=St.imageAtlasTexture?St.imageAtlasTexture.size:[0,0],An=Lt.iconSizeData,In=ut.aD(An,bn.zoom),Pn=En||0!==bn.pitch,zn=Kt(nn,St.tileID.canonical,En,wn,bn,Lt.getProjection(),sn),kn=Jt(nn,St.tileID.canonical,En,wn,bn,Lt.getProjection(),sn),Wn=pt.translatePosMatrix(kn,St,Yt,vr,!0),Jn=pt.translatePosMatrix(nn,St,Yt,vr),Qn=Mi?ll:zn,bo=wn&&!En&&!wt;let ko=Yn;!Bn&&!bn.mercatorFromTransition||wn||(ko=Lo(bn));const No=Ar?ko:Yn;if(Lt.sdfIcons&&!Lt.iconsInText)Tn=_o(An.kind,In,bo,En,pt,Jn,Qn,Wn,!1,Mn,!0,It,Vr,Ln,xn,No,Lt.getProjection());else{const ut=Tt.getColorAdjustmentMatrix(cn,un,fn,_n);Tn=uo(An.kind,In,bo,En,pt,Jn,Qn,Wn,!1,Mn,It,Vr,Ln,xn,No,Lt.getProjection(),ut,br)}const Js=St.imageAtlasTexture?St.imageAtlasTexture:null,ua=1!==Tt.layout.get("icon-size").constantOr(0)||Lt.iconsNeedLinear,ga=Lt.sdfIcons||pt.options.rotating||pt.options.zooming||ua||Pn?vn.LINEAR:vn.NEAREST,xa=Lt.sdfIcons&&0!==Tt.paint.get("icon-halo-width").constantOr(1),Ra=pt.terrain&&En&&wt?ut.ad.invert(ut.ad.create(),zn):ll;if(wt&&Lt.icon){const ut=bn.elevation,wt=ut?ut.getAtTileOffsetFunc(It,bn.center.lat,bn.worldSize,Lt.getProjection()):null,Tt=Qt(nn,St.tileID.canonical,En,wn,bn,Lt.getProjection(),sn);oi(Lt,nn,pt,!1,Tt,kn,En,an,wt,It)}return{program:gn,buffers:Lt.icon,uniformValues:Tn,atlasTexture:Js,atlasTextureIcon:null,atlasInterpolation:ga,atlasInterpolationIcon:null,isSDF:Lt.sdfIcons,hasHalo:xa,tile:St,labelPlaneMatrixInv:Ra}},G=()=>{const wt=Tn&&"point"!==Tt.layout.get("symbol-placement"),Xt=[],Yt=wt||kn||yn;Tt.hasInitialOcclusionOpacityProperties&&An&&pt.symbolParams.useOcclusionQueries&&!Ar&&!Bn&&Xt.push("OCCLUSION_QUERIES"),Tt.hasInitialOcclusionOpacityProperties||Xt.push("SYMBOL_OCCLUSION_BY_TERRAIN_DEPTH"),pt.terrainRenderModeElevated()&&Mn&&Xt.push("PITCH_WITH_MAP_TERRAIN"),Ar&&(Xt.push("PROJECTION_GLOBE_VIEW"),Yt&&Xt.push("PROJECTED_POS_ON_VIEWPORT")),Lt.text.zOffsetVertexBuffer&&Xt.push("Z_OFFSET");const vr=Lt.text.programConfigurations.get(Tt.id),an=pt.getOrCreateProgram(Lt.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:vr,defines:Xt});let cn,un=[0,0],fn=null;const _n=Lt.textSizeData;Lt.iconsInText&&(un=St.imageAtlasTexture?St.imageAtlasTexture.size:[0,0],fn=St.imageAtlasTexture?St.imageAtlasTexture:null,cn=Mn||0!==bn.pitch||pt.options.rotating||pt.options.zooming||"composite"===_n.kind||"camera"===_n.kind?vn.LINEAR:vn.NEAREST);const gn=St.glyphAtlasTexture?St.glyphAtlasTexture.size:[0,0],wn=ut.aD(_n,bn.zoom),En=Kt(nn,St.tileID.canonical,Mn,Tn,bn,Lt.getProjection(),sn),Sn=Jt(nn,St.tileID.canonical,Mn,Tn,bn,Lt.getProjection(),sn),In=pt.translatePosMatrix(Sn,St,Mi,br,!0),Pn=pt.translatePosMatrix(nn,St,Mi,br),zn=Yt?ll:En,Wn=Tn&&!Mn&&!wt;let Jn=Yn;!Bn&&!bn.mercatorFromTransition||Tn||(Jn=Lo(bn));const Qn=Ar?Jn:Yn;let bo;bo=Lt.iconsInText?po(_n.kind,wn,Wn,Mn,pt,Pn,zn,In,gn,un,It,Vr,Ln,xn,Qn,Lt.getProjection()):_o(_n.kind,wn,Wn,Mn,pt,Pn,zn,In,!0,gn,!0,It,Vr,Ln,xn,Qn,Lt.getProjection());const ko=St.glyphAtlasTexture?St.glyphAtlasTexture:null,No=vn.LINEAR,Js=0!==Tt.paint.get("text-halo-width").constantOr(1),ua=pt.terrain&&Mn&&wt?ut.ad.invert(ut.ad.create(),En):ll;if(wt&&Lt.text){const ut=bn.elevation,wt=ut?ut.getAtTileOffsetFunc(It,bn.center.lat,bn.worldSize,Lt.getProjection()):null,Tt=Qt(nn,St.tileID.canonical,Mn,Tn,bn,Lt.getProjection(),sn);oi(Lt,nn,pt,!0,Tt,Sn,Mn,ln,wt,It)}return{program:an,buffers:Lt.text,uniformValues:bo,atlasTexture:ko,atlasTextureIcon:fn,atlasInterpolation:No,atlasInterpolationIcon:cn,isSDF:!0,hasHalo:Js,tile:St,labelPlaneMatrixInv:ua}},zn=Lt.icon.segments.get().length,Jn=Lt.text.segments.get().length,Qn=zn&&!Xt.onlyText?O():null,bo=Jn&&!Xt.onlyIcons?G():null,ko=Tt.paint.get("icon-opacity").constantOr(1),No=Tt.paint.get("text-opacity").constantOr(1);if(In&&Lt.canOverlap){Pn=!0;const pt=ko&&!Xt.onlyText?Lt.icon.segments.get():[],wt=No&&!Xt.onlyIcons?Lt.text.segments.get():[];for(const wt of pt)Wn.push({segments:new ut.b([wt]),sortKey:wt.sortKey,state:Qn});for(const pt of wt)Wn.push({segments:new ut.b([pt]),sortKey:pt.sortKey,state:bo})}else Xt.onlyText||Wn.push({segments:ko?Lt.icon.segments:new ut.b([]),sortKey:0,state:Qn}),Xt.onlyIcons||Wn.push({segments:No?Lt.text.segments:new ut.b([]),sortKey:0,state:bo})}Pn&&Wn.sort(((ut,pt)=>ut.sortKey-pt.sortKey));for(const ut of Wn){const wt=ut.state;if(wt)if(pt.terrain&&pt.terrain.setupElevationDraw(wt.tile,wt.program,{useDepthForOcclusion:!Tt.hasInitialOcclusionOpacityProperties&&bn.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:wt.labelPlaneMatrixInv}),xn.activeTexture.set(vn.TEXTURE0),wt.atlasTexture&&wt.atlasTexture.bind(wt.atlasInterpolation,vn.CLAMP_TO_EDGE,!0),wt.atlasTextureIcon&&(xn.activeTexture.set(vn.TEXTURE1),wt.atlasTextureIcon&&wt.atlasTextureIcon.bind(wt.atlasInterpolationIcon,vn.CLAMP_TO_EDGE,!0)),pt.uploadCommonLightUniforms(pt.context,wt.program),wt.hasHalo){const St=wt.uniformValues;St.u_is_halo=1,Do(wt.buffers,ut.segments,Tt,pt,wt.program,zn,It,Lt,St,2),St.u_is_halo=0}else{if(wt.isSDF){const St=wt.uniformValues;wt.hasHalo&&(St.u_is_halo=1,Do(wt.buffers,ut.segments,Tt,pt,wt.program,zn,It,Lt,St,1)),St.u_is_halo=0}Do(wt.buffers,ut.segments,Tt,pt,wt.program,zn,It,Lt,wt.uniformValues,1)}}}function Do(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr){const br=St.context.gl,Ar=[pt.dynamicLayoutVertexBuffer,pt.opacityVertexBuffer,pt.iconTransitioningVertexBuffer,pt.globeExtVertexBuffer,pt.zOffsetVertexBuffer];pt.occlusionQueryOpacityVertexBuffer.length>0&&Ar.push(pt.occlusionQueryOpacityVertexBuffer),It.draw(St,br.TRIANGLES,Lt,Xt,Yt,ut.af.disabled,Mi,Tt.id,pt.layoutVertexBuffer,pt.indexBuffer,wt,Tt.paint,St.transform.zoom,pt.programConfigurations.get(Tt.id),Ar,vr)}function Mo(pt,wt,Tt,St,It,Lt,Xt){const Yt=pt.context.gl,Mi=Tt.paint.get("fill-pattern"),vr=Mi&&Mi.constantOr(1);let br,Ar,Vr,nn,sn;Xt?(Ar=vr&&!Tt.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",br=Yt.LINES):(Ar=vr?"fillPattern":"fill",br=Yt.TRIANGLES);for(const an of St){const St=wt.getTile(an);if(vr&&!St.patternsLoaded())continue;const ln=St.getBucket(Tt);if(!ln)continue;pt.prepareDrawTile();const cn=ln.programConfigurations.get(Tt.id),un=pt.isTileAffectedByFog(an),fn=pt.getOrCreateProgram(Ar,{config:cn,overrideFog:un});vr&&(pt.context.activeTexture.set(Yt.TEXTURE0),St.imageAtlasTexture&&St.imageAtlasTexture.bind(Yt.LINEAR,Yt.CLAMP_TO_EDGE),cn.updatePaintBuffers());const _n=Mi.constantOr(null);if(_n&&St.imageAtlas){const ut=St.imageAtlas.patternPositions[_n.toString()];ut&&cn.setConstantPatternPositions(ut)}const gn=pt.translatePosMatrix(an.projMatrix,St,Tt.paint.get("fill-translate"),Tt.paint.get("fill-translate-anchor")),yn=Tt.paint.get("fill-emissive-strength");if(Xt){nn=ln.indexBuffer2,sn=ln.segments2;const ut=pt.terrain&&pt.terrain.renderingToTexture?pt.terrain.drapeBufferSize:[Yt.drawingBufferWidth,Yt.drawingBufferHeight];Vr="fillOutlinePattern"===Ar&&vr?Ki(gn,yn,pt,St,ut):Yi(gn,yn,ut)}else nn=ln.indexBuffer,sn=ln.segments,Vr=vr?Xi(gn,yn,pt,St):$i(gn,yn);pt.uploadCommonUniforms(pt.context,fn,an.toUnwrapped()),fn.draw(pt,br,It,pt.stencilModeForClipping(an),Lt,ut.af.disabled,Vr,Tt.id,ln.layoutVertexBuffer,nn,sn,Tt.paint,pt.transform.zoom,cn,void 0)}}function zo(pt,wt,Tt,St,It,Lt,Xt,Yt){Tt.resetLayerRenderingStats(pt);const Mi=pt.context,vr=Mi.gl,br=pt.transform,Ar=Tt.paint.get("fill-extrusion-pattern"),Vr=Ar.constantOr(1),nn=Tt.paint.get("fill-extrusion-opacity"),sn=pt.style.enable3dLights(),an=Tt.paint.get(sn&&!Vr?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),ln=[Tt.paint.get("fill-extrusion-ambient-occlusion-intensity"),an],cn=Tt.layout.get("fill-extrusion-edge-radius"),un=cn>0&&!Tt.paint.get("fill-extrusion-rounded-roof"),fn=un?0:cn,_n="globe"===br.projection.name?ut.bY():0,gn="globe"===br.projection.name,yn=gn?ut.a1(br.zoom):0,xn=[ut.aj(br.center.lng),ut.ak(br.center.lat)],vn=Tt.paint.get("fill-extrusion-flood-light-color").toRenderColor(Tt.lut).toArray01().slice(0,3),bn=Tt.paint.get("fill-extrusion-flood-light-intensity"),wn=Tt.paint.get("fill-extrusion-vertical-scale"),Tn=mi(pt,Tt.paint.get("fill-extrusion-cutoff-fade-range")),En=Tt.paint.get("fill-extrusion-emissive-strength"),Mn=[];let Sn;gn&&Mn.push("PROJECTION_GLOBE_VIEW"),ln[0]>0&&Mn.push("FAUX_AO"),un&&Mn.push("ZERO_ROOF_RADIUS"),Yt&&Mn.push("HAS_CENTROID"),bn>0&&Mn.push("FLOOD_LIGHT"),Tn.shouldRenderCutoff&&Mn.push("RENDER_CUTOFF");const An="shadow"===pt.renderPass,In=pt.shadowRenderer,Pn=An&&!!In;pt.shadowRenderer&&(pt.shadowRenderer.useNormalOffset=!0);let zn=[0,0,0];if(In){const ut=pt.style.directionalLight,wt=pt.style.ambientLight;ut&&wt&&(zn=Ti(pt.style,ut,wt)),Sn=Mn.concat(["SHADOWS_SINGLE_CASCADE"])}const Ln=Pn?"fillExtrusionDepth":Vr?"fillExtrusionPattern":"fillExtrusion",kn=Tt.getLayerRenderingStats();for(const sn of St){const St=wt.getTile(sn),an=St.getBucket(Tt);if(!an||an.projection.name!==br.projection.name)continue;let cn=!1;In&&(cn=0===In.getMaxCascadeForTile(sn.toUnwrapped()));const un=pt.isTileAffectedByFog(sn),Pn=an.programConfigurations.get(Tt.id),Bn=pt.getOrCreateProgram(Ln,{config:Pn,defines:cn?Sn:Mn,overrideFog:un});if(pt.terrain&&pt.terrain.setupElevationDraw(St,Bn,{useMeterToDem:!0}),!an.centroidVertexBuffer){const ut=Bn.attributes.a_centroid_pos;void 0!==ut&&vr.vertexAttrib2f(ut,0,0)}!An&&In&&In.setupShadows(St.tileID.toUnwrapped(),Bn,"vector-tile",St.tileID.overscaledZ),Vr&&(pt.context.activeTexture.set(vr.TEXTURE0),St.imageAtlasTexture&&St.imageAtlasTexture.bind(vr.LINEAR,vr.CLAMP_TO_EDGE),Pn.updatePaintBuffers());const Wn=Ar.constantOr(null);if(Wn&&St.imageAtlas){const ut=St.imageAtlas.patternPositions[Wn.toString()];ut&&Pn.setConstantPatternPositions(ut)}const Yn=Tt.paint.get("fill-extrusion-vertical-gradient");let Jn;if(An&&In){if(Uo(St.tileID,an,pt))continue;const ut=In.calculateShadowPassMatrixFromTile(St.tileID.toUnwrapped());Jn=qi(ut,fn,wn)}else{const ut=pt.translatePosMatrix(sn.expandedProjMatrix,St,Tt.paint.get("fill-extrusion-translate"),Tt.paint.get("fill-extrusion-translate-anchor")),wt=br.projection.createInversionMatrix(br,sn.canonical);Jn=Vr?Hi(ut,pt,Yn,nn,ln,fn,sn,St,_n,yn,xn,wt,vn,wn):Zi(ut,pt,Yn,nn,ln,fn,sn,_n,yn,xn,wt,vn,wn,bn,zn,En)}pt.uploadCommonUniforms(Mi,Bn,sn.toUnwrapped(),null,Tn);let Qn=an.segments;if("mercator"===br.projection.name&&!An&&(Qn=an.getVisibleSegments(St.tileID,pt.terrain,pt.transform.getFrustum(0)),!Qn.get().length))continue;if(kn)if(An)for(const ut of Qn.get())kn.numRenderedVerticesInShadowPass+=ut.primitiveLength;else for(const ut of Qn.get())kn.numRenderedVerticesInTransparentPass+=ut.primitiveLength;const bo=[];(pt.terrain||Yt)&&bo.push(an.centroidVertexBuffer),gn&&bo.push(an.layoutVertexExtBuffer),Bn.draw(pt,Mi.gl.TRIANGLES,It,Lt,Xt,ut.af.backCCW,Jn,Tt.id,an.layoutVertexBuffer,an.indexBuffer,Qn,Tt.paint,pt.transform.zoom,Pn,bo)}pt.shadowRenderer&&(pt.shadowRenderer.useNormalOffset=!1)}function Oo(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln,cn,un){const fn=pt.context,_n=fn.gl,gn=pt.transform,yn=pt.transform.zoom,xn=[],vn=mi(pt,Tt.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===vr?(xn.push("CLEAR_SUBPASS"),un&&(xn.push("CLEAR_FROM_TEXTURE"),fn.activeTexture.set(_n.TEXTURE0),un.bind(_n.LINEAR,_n.CLAMP_TO_EDGE))):"sdf"===vr&&xn.push("SDF_SUBPASS"),ln&&xn.push("HAS_CENTROID"),vn.shouldRenderCutoff&&xn.push("RENDER_CUTOFF");const bn=Tt.layout.get("fill-extrusion-edge-radius"),I=(ut,wt,St,vr,cn)=>{const _n=wt.programConfigurations.get(Tt.id),gn=pt.isTileAffectedByFog(ut),wn=pt.getOrCreateProgram("fillExtrusionGroundEffect",{config:_n,defines:xn,overrideFog:gn}),Tn=((ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr)=>({u_matrix:pt,u_opacity:wt,u_ao_pass:Tt?1:0,u_meter_to_tile:St,u_ao:It,u_flood_light_intensity:Lt,u_flood_light_color:Xt,u_attenuation:Yt,u_edge_radius:Mi,u_fb:0,u_fb_size:vr}))(0,vr,br,Mi,cn,[Ar,Vr*cn],nn,sn,an,yn>=17?0:bn*cn,un?un.size[0]:0),En=[];ln&&En.push(wt.hiddenByLandmarkVertexBuffer),pt.uploadCommonUniforms(fn,wn,ut.toUnwrapped(),null,vn),wn.draw(pt,fn.gl.TRIANGLES,It,Lt,Xt,Yt,Tn,Tt.id,wt.vertexBuffer,wt.indexBuffer,St,Tt.paint,yn,_n,En)};for(const It of St){const St=wt.getTile(It),Lt=St.getBucket(Tt);if(!Lt||Lt.projection.name!==gn.projection.name||!Lt.groundEffect||Lt.groundEffect&&!Lt.groundEffect.hasData())continue;const Xt=Lt.groundEffect,Yt=1/Lt.tileToMeter;{const ut=pt.translatePosMatrix(It.projMatrix,St,Tt.paint.get("fill-extrusion-translate"),Tt.paint.get("fill-extrusion-translate-anchor")),wt=Xt.getDefaultSegment();I(It,Xt,wt,ut,Yt)}if(cn)for(let Lt=0;Lt<4;Lt++){const Xt=ut.bZ[Lt](It),Mi=wt.getTile(Xt);if(!Mi)continue;const vr=Mi.getBucket(Tt);if(!vr||vr.projection.name!==gn.projection.name||!vr.groundEffect||vr.groundEffect&&!vr.groundEffect.hasData())continue;const br=vr.groundEffect;let Ar,Vr;0===Lt?(Ar=[-ut.a3,0,0],Vr=1):1===Lt?(Ar=[ut.a3,0,0],Vr=0):2===Lt?(Ar=[0,-ut.a3,0],Vr=3):(Ar=[0,ut.a3,0],Vr=2);const nn=br.regionSegments[Vr];if(!nn)continue;const sn=new Float32Array(16);ut.ad.translate(sn,It.projMatrix,Ar),I(It,br,nn,pt.translatePosMatrix(sn,St,Tt.paint.get("fill-extrusion-translate"),Tt.paint.get("fill-extrusion-translate-anchor")),Yt)}}}function Fo(pt,wt,Tt,St,It,Lt,Xt){0===St.centroidVertexArray.length&&St.createCentroidsBuffer();const Yt=Lt?Lt.findDEMTileFor(Tt):null;if(!(Yt&&Yt.dem||Xt))return;const c=pt=>new ut.P(Math.ceil((pt+ut.c0)*ut.c1),0),h=ut=>{const pt=wt.getSource().minzoom,o=ut=>{const pt=wt.getTileByID(ut);if(pt&&pt.hasData())return pt.getBucket(It)},Tt=[0,-1,1];for(const wt of Tt){if(ut.overscaledZ+wt<pt)continue;const Tt=o(ut.calculateScaledKey(ut.overscaledZ+wt));if(Tt)return Tt}},Mi=[0,0,0],_=(pt,wt)=>(Mi[0]=Math.min(pt.min.y,wt.min.y),Mi[1]=Math.max(pt.max.y,wt.max.y),Mi[2]=ut.a3-wt.min.x>pt.max.x?wt.min.x-ut.a3:pt.max.x,Mi),d=(pt,wt)=>(Mi[0]=Math.min(pt.min.x,wt.min.x),Mi[1]=Math.max(pt.max.x,wt.max.x),Mi[2]=ut.a3-wt.min.y>pt.max.y?wt.min.y-ut.a3:pt.max.y,Mi),vr=[(ut,pt)=>_(ut,pt),(ut,pt)=>_(pt,ut),(ut,pt)=>d(ut,pt),(ut,pt)=>d(pt,ut)],f=(pt,wt,St,It,Xt,Mi,vr)=>{if(!Lt)return 0;const br=[[Mi?St:pt,Mi?pt:St,0],[Mi?St:wt,Mi?wt:St,0]],Ar=vr<0?ut.a3+vr:vr,Vr=[Mi?Ar:(pt+wt)/2,Mi?(pt+wt)/2:Ar,0];return 0===St&&vr<0||0!==St&&vr>0?Lt.getForTilePoints(Xt,[Vr],!0,It):br.push(Vr),Lt.getForTilePoints(Tt,br,!0,Yt),Math.max(br[0][2],br[1][2],Vr[2])/Lt.exaggeration()};for(let pt=0;pt<4;pt++){const wt=St.borderFeatureIndices[pt];if(0===wt.length)continue;const It=ut.bZ[pt](Tt),Yt=h(It);if(!(Yt&&Yt instanceof ut.b_))continue;if(St.borderDoneWithNeighborZ[pt]===Yt.canonical.z)continue;0===Yt.centroidVertexArray.length&&Yt.createCentroidsBuffer();const Mi=Lt?Lt.findDEMTileFor(It):null;if(!(Mi&&Mi.dem||Xt))continue;const Vr=(pt<2?1:5)-pt,nn=Yt.borderDoneWithNeighborZ[Vr]!==St.canonical.z,sn=Yt.borderFeatureIndices[Vr];let an=0;if(St.canonical.z!==Yt.canonical.z){for(const ut of wt)St.showCentroid(St.featuresOnBorder[ut]);if(nn)for(const ut of sn)Yt.showCentroid(Yt.featuresOnBorder[ut]);St.borderDoneWithNeighborZ[pt]=Yt.canonical.z,Yt.borderDoneWithNeighborZ[Vr]=St.canonical.z}for(const Tt of wt){const wt=St.featuresOnBorder[Tt],Lt=St.centroidData[wt.centroidDataIndex],nn=wt.borders[pt];let ln;for(;an<sn.length;){ln=Yt.featuresOnBorder[sn[an]];const ut=ln.borders[Vr];if(ut[1]>nn[0]+3||ut[0]>nn[0]-3)break;Yt.showCentroid(ln),an++}if(ln&&an<sn.length){const Tt=an;let cn=0;for(;!(ln.borders[Vr][0]>nn[1]-3)&&(cn++,++an!==sn.length);)ln=Yt.featuresOnBorder[sn[an]];if(ln=Yt.featuresOnBorder[sn[Tt]],cn>1){const ut=ln.borders[Vr];Math.abs(nn[0]-ut[0])<3&&Math.abs(nn[1]-ut[1])<3&&(cn=1,an=Tt+1)}else if(0===cn){St.showCentroid(wt);continue}const un=Yt.centroidData[ln.centroidDataIndex];Xt&&1===cn&&(((br=Lt).flags|(Ar=un).flags)&ut.b$?(br.flags|=ut.b$,Ar.flags|=ut.b$):(br.flags&=~ut.b$,Ar.flags&=~ut.b$));const fn=wt.intersectsCount()>1||ln.intersectsCount()>1;if(cn>1)an=Tt,Lt.centroidXY=un.centroidXY=new ut.P(0,0);else if(Mi&&Mi.dem&&!fn){const wt=vr[pt](Lt,un),Tt=pt%2?ut.a3-1:0,St=f(wt[0],Math.min(ut.a3-1,wt[1]),Tt,Mi,It,pt<2,wt[2]);Lt.centroidXY=un.centroidXY=c(St)}else fn?Lt.centroidXY=un.centroidXY=new ut.P(0,0):(Lt.centroidXY=St.encodeBorderCentroid(wt),un.centroidXY=Yt.encodeBorderCentroid(ln));St.writeCentroidToBuffer(Lt),Yt.writeCentroidToBuffer(un)}else St.showCentroid(wt)}St.borderDoneWithNeighborZ[pt]=Yt.canonical.z,Yt.borderDoneWithNeighborZ[Vr]=St.canonical.z}var br,Ar;(St.needsCentroidUpdate||!St.centroidVertexBuffer&&0!==St.centroidVertexArray.length)&&St.uploadCentroid(pt)}const yl=[1,0,0],Tl=[0,1,0],Al=[0,0,1];function Uo(pt,wt,Tt){const St=Tt.transform,It=Tt.shadowRenderer;if(!It)return!0;const Lt=pt.toUnwrapped(),Xt=St.tileSize*It._cascades[Tt.currentShadowCascade].scale;let Yt=wt.maxHeight;if(St.elevation){const ut=St.elevation.getMinMaxForTile(pt);ut&&(Yt+=ut.max)}const Mi=[...It.shadowDirection];Mi[2]=-Mi[2];const vr=It.computeSimplifiedTileShadowVolume(Lt,Yt,Xt,Mi);if(!vr)return!1;const br=[yl,Tl,Al,Mi,[Mi[0],0,Mi[2]],[0,Mi[1],Mi[2]]],Ar="globe"===St.projection.name,Vr=St.scaleZoom(Xt),nn=ut.aM.fromInvProjectionMatrix(St.invProjMatrix,St.worldSize,Vr,!Ar),sn=It.getCurrentCascadeFrustum();return 0===nn.intersectsPrecise(vr.vertices,vr.planes,br)||0===sn.intersectsPrecise(vr.vertices,vr.planes,br)}function Go(pt){return[pt[0]*ut.c2,pt[1]*ut.c2,pt[2]*ut.c2,0]}function jo(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi){const vr=St.getSource(),br=Tt.globeSharedBuffers;if(!br)return;let Ar,Vr,nn;if(wt&&(Ar=St.getTile(wt)),vr instanceof ut.bm?(Vr=vr.texture,nn=ut.bh(0,0,Tt.transform)):Ar&&wt&&(Vr=Ar.texture,nn=ut.bh(wt.canonical.z,wt.canonical.x,Tt.transform)),!Vr||!nn)return;pt||(nn=ut.ad.scale(ut.ad.create(),nn,[1,-1,1]));const sn=Tt.context,an=sn.gl,ln="nearest"===It.paint.get("raster-resampling")?an.NEAREST:an.LINEAR,cn=Tt.colorModeForDrapableLayerRenderPass(Lt),un=Xt.defines;un.push("GLOBE_POLES");const fn=new ut.ae(an.LEQUAL,ut.ae.ReadWrite,Tt.depthRangeFor3D),_n=Float32Array.from(Tt.transform.expandedFarZProjMatrix),gn=Float32Array.from(ut.bf(ut.bg(new ut.aO(0,0,0))));Tt.terrain&&Tt.terrain.prepareDrawTile(),sn.activeTexture.set(an.TEXTURE0),Vr.bind(ln,an.CLAMP_TO_EDGE),sn.activeTexture.set(an.TEXTURE1),Vr.bind(ln,an.CLAMP_TO_EDGE),Vr.useMipmap&&sn.extTextureFilterAnisotropic&&Tt.transform.pitch>20&&an.texParameterf(an.TEXTURE_2D,sn.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,sn.extTextureFilterAnisotropicMax);const[yn,xn,vn,bn]=wt?br.getPoleBuffers(wt.canonical.z,!1):br.getPoleBuffers(0,!0),wn=It.paint.get("raster-elevation");let Tn;pt?(Tn=yn,Tt.renderDefaultNorthPole=0!==wn):(Tn=xn,Tt.renderDefaultSouthPole=0!==wn);const En=Go(Xt.mix),Mn=((ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar)=>ro(ut,pt,wt,new Float32Array(16),new Float32Array(9),[0,0],Tt,[0,0],[0,0,0,0],1,{opacity:1,mix:0},It,[0,0]||[0,0],Xt,2,Mi,vr,br,1,0,Ar))(_n,gn,nn,ut.a1(Tt.transform.zoom),0,It,0,wn,0,En,Xt.offset,Xt.range,Lt),Sn=Tt.getOrCreateProgram("raster",{defines:un});Tt.uploadCommonUniforms(sn,Sn,null),Sn.draw(Tt,an.TRIANGLES,fn,Mi,cn,Yt,Mn,It.id,Tn,vn,bn)}function Vo(ut){const pt=ut._nearZ,wt=ut.projection.farthestPixelDistance(ut),Tt=wt-pt,St=.2*ut.height,It=pt+St;return[pt,wt,(It-St-pt)/Tt,(It-pt)/Tt]}function Wo(pt,wt,Tt,St){if(pt)return wt instanceof Di&&pt instanceof ut.c3?wt.getTextureDescriptor(pt,Tt,!0):{texture:pt.texture,mix:Go(St.mix),offset:St.offset,buffer:0,tileSize:1}}function Zo(pt,wt,Tt){if(!pt)return null;const St=wt.getTextureDescriptor(pt,Tt,!0);if(!St)return null;let{texture:It,mix:Lt,offset:Xt,tileSize:Yt,buffer:Mi,format:vr}=St;if(!It||!vr)return null;let br=!1;return"uint32"===vr&&(br=!0,Lt[3]=0,Lt=io(ut.c4,Lt,[0,Tt.paint.get("raster-particle-max-speed")]),Xt=oo(ut.c4,Xt,[0,Tt.paint.get("raster-particle-max-speed")])),{texture:It,textureOffset:[Mi/(Yt+2*Mi),Yt/(Yt+2*Mi)],tileSize:Yt,scalarData:br,scale:Lt,offset:Xt,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[vr]]}}function qo(ut){const pt=ut._nearZ,wt=ut.projection.farthestPixelDistance(ut),Tt=wt-pt,St=.2*ut.height,It=pt+St;return[pt,wt,(It-St-pt)/Tt,(It-pt)/Tt]}const Il=new ut.C(1,0,0,1),zl=new ut.C(0,1,0,1),ec=new ut.C(0,0,1,1),tc=new ut.C(1,0,1,1),ic=new ut.C(0,1,1,1);function Qo(pt,wt,Tt,St,It,Lt,Xt){const Yt=pt.context,Mi=pt.transform,vr=Yt.gl,br="globe"===Mi.projection.name,Ar=br?["PROJECTION_GLOBE_VIEW"]:[];let Vr=ut.ad.clone(Tt.projMatrix);if(br&&ut.a1(Mi.zoom)>0){const pt=ut.c5(Tt.canonical,Mi),wt=ut.c6(pt);Vr=ut.ad.multiply(new Float32Array(16),Mi.globeMatrix,wt),ut.ad.multiply(Vr,Mi.projMatrix,Vr)}const nn=ut.ad.create();nn[12]+=2*It/(ut.e.devicePixelRatio*Mi.width),nn[13]+=2*Lt/(ut.e.devicePixelRatio*Mi.height),ut.ad.multiply(Vr,nn,Vr);const sn=pt.getOrCreateProgram("debug",{defines:Ar}),an=wt.getTileByID(Tt.key);pt.terrain&&pt.terrain.setupElevationDraw(an,sn);const ln=ut.ae.disabled,cn=ut.ag.disabled,un=pt.colorModeForRenderPass(),fn="$debug";Yt.activeTexture.set(vr.TEXTURE0),pt.emptyTexture.bind(vr.LINEAR,vr.CLAMP_TO_EDGE),br?an._makeGlobeTileDebugBuffers(pt.context,Mi):an._makeDebugTileBoundsBuffers(pt.context,Mi.projection);const _n=an._tileDebugBuffer||pt.debugBuffer,gn=an._tileDebugIndexBuffer||pt.debugIndexBuffer,yn=an._tileDebugSegments||pt.debugSegments;if(sn.draw(pt,vr.LINE_STRIP,ln,cn,un,ut.af.disabled,Ji(Vr,St),fn,_n,gn,yn,null,null,null,[an._globeTileDebugBorderBuffer]),Xt){const ut=an.latestRawTileData,wt=Math.floor((ut&&ut.byteLength||0)/1024);let St=Tt.canonical.toString();Tt.overscaledZ!==Tt.canonical.z&&(St+=` => ${Tt.overscaledZ}`),St+=` ${an.state}`,St+=` ${wt}kb`,function(ut,pt){ut.initDebugOverlayCanvas();const wt=ut.debugOverlayCanvas,Tt=ut.context.gl,St=ut.debugOverlayCanvas.getContext("2d");St.clearRect(0,0,wt.width,wt.height),St.shadowColor="white",St.shadowBlur=2,St.lineWidth=1.5,St.strokeStyle="white",St.textBaseline="top",St.font="bold 36px Open Sans, sans-serif",St.fillText(pt,5,5),St.strokeText(pt,5,5),ut.debugOverlayTexture.update(wt),ut.debugOverlayTexture.bind(Tt.LINEAR,Tt.CLAMP_TO_EDGE)}(pt,St)}const xn=wt.getTile(Tt).tileSize,vn=512/Math.min(xn,512)*(Tt.overscaledZ/Mi.zoom)*.5,bn=an._tileDebugTextBuffer||pt.debugBuffer,wn=an._tileDebugTextIndexBuffer||pt.quadTriangleIndexBuffer,Tn=an._tileDebugTextSegments||pt.debugSegments;sn.draw(pt,vr.TRIANGLES,ln,cn,ut.a.alphaBlended,ut.af.disabled,Ji(Vr,ut.C.transparent,vn),fn,bn,wn,Tn,null,null,null,[an._globeTileDebugTextBuffer])}function Jo(ut,pt,wt,Tt){tr(ut,0,pt+wt/2,ut.transform.width,wt,Tt)}function er(ut,pt,wt,Tt){tr(ut,pt-wt/2,0,wt,ut.transform.height,Tt)}function tr(pt,wt,Tt,St,It,Lt){const Xt=pt.context,Yt=Xt.gl;Yt.enable(Yt.SCISSOR_TEST),Yt.scissor(wt*ut.e.devicePixelRatio,Tt*ut.e.devicePixelRatio,St*ut.e.devicePixelRatio,It*ut.e.devicePixelRatio),Xt.clear({color:Lt}),Yt.disable(Yt.SCISSOR_TEST)}const nc=ut.c7([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:oc}=nc;function rr(ut,pt,wt,Tt){ut.emplaceBack(pt,wt,Tt)}class ar{constructor(pt){this.vertexArray=new ut.c8,this.indices=new ut.bu,rr(this.vertexArray,-1,-1,1),rr(this.vertexArray,1,-1,1),rr(this.vertexArray,-1,1,1),rr(this.vertexArray,1,1,1),rr(this.vertexArray,-1,-1,-1),rr(this.vertexArray,1,-1,-1),rr(this.vertexArray,-1,1,-1),rr(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=pt.createVertexBuffer(this.vertexArray,oc),this.indexBuffer=pt.createIndexBuffer(this.indices),this.segment=ut.b.simpleSegment(0,0,36,12)}}function sr(pt,wt,Tt,St,It,Lt){const Xt=pt.context.gl,Yt=wt.paint.get("sky-atmosphere-color"),Mi=wt.paint.get("sky-atmosphere-halo-color"),vr=wt.paint.get("sky-atmosphere-sun-intensity"),br=((ut,pt,wt,Tt,St)=>({u_matrix_3f:ut,u_sun_direction:pt,u_sun_intensity:wt,u_color_tint_r:[Tt.r,Tt.g,Tt.b,Tt.a],u_color_tint_m:[St.r,St.g,St.b,St.a],u_luminance:5e-5}))(ut.bC.fromMat4(ut.bC.create(),St),It,vr,Yt,Mi);Xt.framebufferTexture2D(Xt.FRAMEBUFFER,Xt.COLOR_ATTACHMENT0,Xt.TEXTURE_CUBE_MAP_POSITIVE_X+Lt,wt.skyboxTexture,0),Tt.draw(pt,Xt.TRIANGLES,ut.ae.disabled,ut.ag.disabled,ut.a.unblended,ut.af.frontCW,br,"skyboxCapture",wt.skyboxGeometry.vertexBuffer,wt.skyboxGeometry.indexBuffer,wt.skyboxGeometry.segment)}const sc=ut.c7([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class lr{constructor(pt){const wt=new ut.c9;wt.emplaceBack(-1,1,1,0,0),wt.emplaceBack(1,1,1,1,0),wt.emplaceBack(1,-1,1,1,1),wt.emplaceBack(-1,-1,1,0,1);const Tt=new ut.bu;Tt.emplaceBack(0,1,2),Tt.emplaceBack(2,3,0),this.vertexBuffer=pt.createVertexBuffer(wt,sc.members),this.indexBuffer=pt.createIndexBuffer(Tt),this.segments=ut.b.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const ac=ut.c7([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class hr{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class ur{constructor(pt){this.colorModeAlphaBlendedWriteRGB=new ut.a([ut.ca,ut.cb,ut.ca,ut.cb],ut.C.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ut.a([ut.ca,ut.cc,ut.ca,ut.cc],ut.C.transparent,[!1,!1,!1,!0]),this.params=new hr,this.updateNeeded=!0,pt.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),pt.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),pt.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),pt.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(pt){const wt=pt.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new lr(wt);const pt=this.params.sizeRange,Tt=this.params.intensityRange,St=function(pt){const wt=ut.cf(30),Tt=[];for(let St=0;St<pt;++St){const pt=2*Math.PI*wt(),St=Math.acos(1-2*wt())-.5*Math.PI;Tt.push(ut._.fromValues(Math.cos(St)*Math.cos(pt),Math.cos(St)*Math.sin(pt),Math.sin(St)))}return Tt}(this.params.starsCount),It=ut.cf(300),Lt=new ut.cd,Xt=new ut.bu;let Yt=0;for(let wt=0;wt<St.length;++wt){const Mi=ut._.scale([],St[wt],200),vr=Math.max(0,1+.01*pt*(1*It()-.5)),br=Math.max(0,1+.01*Tt*(1*It()-.5));Lt.emplaceBack(Mi[0],Mi[1],Mi[2],-1,-1,vr,br),Lt.emplaceBack(Mi[0],Mi[1],Mi[2],1,-1,vr,br),Lt.emplaceBack(Mi[0],Mi[1],Mi[2],1,1,vr,br),Lt.emplaceBack(Mi[0],Mi[1],Mi[2],-1,1,vr,br),Xt.emplaceBack(Yt+0,Yt+1,Yt+2),Xt.emplaceBack(Yt+0,Yt+2,Yt+3),Yt+=4}this.starsVx=wt.createVertexBuffer(Lt,ac.members),this.starsIdx=wt.createIndexBuffer(Xt),this.starsSegments=ut.b.simpleSegment(0,0,Lt.length,Xt.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(pt,wt){const Tt=pt.context,St=Tt.gl,It=pt.transform,Lt=new ut.ae(St.LEQUAL,ut.ae.ReadOnly,[0,1]),Xt=ut.a1(It.zoom),Yt=pt.style.getLut(wt.scope),Mi=wt.properties.get("color").toRenderColor(Yt).toArray01(),vr=wt.properties.get("high-color").toRenderColor(Yt).toArray01(),br=wt.properties.get("space-color").toRenderColor(Yt).toArray01PremultipliedAlpha(),Ar=5e-4,Vr=ut.ce(wt.properties.get("horizon-blend"),0,1,Ar,.25),nn=ut.ba(pt,Tt,It)&&Vr===Ar?It.worldSize/(2*Math.PI*1.025)-1:It.globeRadius,sn=pt.frameCounter/1e3%1,an=ut._.length(It.globeCenterInViewSpace),ln=Math.sqrt(Math.pow(an,2)-Math.pow(nn,2)),cn=Math.acos(ln/an),x=wt=>{const Yt="globe"===It.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];wt&&Yt.push("ALPHA_PASS");const Ar=pt.getOrCreateProgram("globeAtmosphere",{defines:Yt}),nn=((ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br)=>({u_frustum_tl:ut,u_frustum_tr:pt,u_frustum_br:wt,u_frustum_bl:Tt,u_horizon:St,u_transition:It,u_fadeout_range:Lt,u_color:Xt,u_high_color:Yt,u_space_color:Mi,u_temporal_offset:vr,u_horizon_angle:br}))(It.frustumCorners.TL,It.frustumCorners.TR,It.frustumCorners.BR,It.frustumCorners.BL,It.frustumCorners.horizon,Xt,Vr,Mi,vr,br,sn,cn);pt.uploadCommonUniforms(Tt,Ar);const an=this.atmosphereBuffer;an&&Ar.draw(pt,St.TRIANGLES,Lt,ut.ag.disabled,wt?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ut.af.backCW,nn,wt?"atmosphere_glow_alpha":"atmosphere_glow",an.vertexBuffer,an.indexBuffer,an.segments)};x(!1),x(!0)}drawStars(pt,wt){const Tt=ut.at(wt.properties.get("star-intensity"),0,1);if(0===Tt)return;const St=pt.context,It=St.gl,Lt=pt.transform,Xt=pt.getOrCreateProgram("stars"),Yt=ut.av.identity([]);ut.av.rotateX(Yt,Yt,-Lt._pitch),ut.av.rotateZ(Yt,Yt,-Lt.angle),ut.av.rotateX(Yt,Yt,ut.ab(Lt._center.lat)),ut.av.rotateY(Yt,Yt,-ut.ab(Lt._center.lng));const Mi=ut.ad.fromQuat(new Float32Array(16),Yt),vr=ut.ad.multiply([],Lt.starsProjMatrix,Mi),br=ut.bC.fromMat4([],Mi),Ar=ut.bC.invert([],br),Vr=[0,1,0];ut._.transformMat3(Vr,Vr,Ar),ut._.scale(Vr,Vr,this.params.sizeMultiplier);const nn=[1,0,0];ut._.transformMat3(nn,nn,Ar),ut._.scale(nn,nn,this.params.sizeMultiplier);const sn=(an=Vr,ln=nn,cn=Tt,{u_matrix:Float32Array.from(vr),u_up:an,u_right:ln,u_intensity_multiplier:cn});var an,ln,cn;pt.uploadCommonUniforms(St,Xt),this.starsVx&&this.starsIdx&&Xt.draw(pt,It.TRIANGLES,ut.ae.disabled,ut.ag.disabled,this.colorModeAlphaBlendedWriteRGB,ut.af.disabled,sn,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function _r(pt,wt){const Tt=[...pt],St=wt.cameraWorldSizeForFog/wt.worldSize,It=ut.ad.identity([]);return ut.ad.scale(It,It,[St,St,1]),ut.ad.multiply(Tt,It,Tt),ut.ad.multiply(Tt,wt.worldToFogMatrix,Tt),Tt}function dr(pt,wt,Tt,St,It){const Lt=Tt.material,Xt=St.context,{baseColorTexture:Yt,metallicRoughnessTexture:Mi}=Lt.pbrMetallicRoughness,{normalTexture:vr,occlusionTexture:br,emissionTexture:Ar}=Lt;function d(ut,wt,Tt){if(ut&&(pt.push(wt),Xt.activeTexture.set(Xt.gl.TEXTURE0+Tt),ut.gfxTexture)){const{minFilter:pt,magFilter:wt,wrapS:Tt,wrapT:St}=ut.sampler;ut.gfxTexture.bindExtraParam(pt,wt,Tt,St)}}d(Yt,"HAS_TEXTURE_u_baseColorTexture",Bn.BaseColor),d(Mi,"HAS_TEXTURE_u_metallicRoughnessTexture",Bn.MetallicRoughness),d(vr,"HAS_TEXTURE_u_normalTexture",Bn.Normal),d(br,"HAS_TEXTURE_u_occlusionTexture",Bn.Occlusion),d(Ar,"HAS_TEXTURE_u_emissionTexture",Bn.Emission),It&&(It.texture||(It.texture=new ut.ch(St.context,It.image,[It.image.height,It.image.height,It.image.height],Xt.gl.RGBA)),Xt.activeTexture.set(Xt.gl.TEXTURE0+Bn.LUT),It.texture&&It.texture.bind(Xt.gl.LINEAR,Xt.gl.CLAMP_TO_EDGE),pt.push("APPLY_LUT_ON_GPU")),Tt.texcoordBuffer&&(pt.push("HAS_ATTRIBUTE_a_uv_2f"),wt.push(Tt.texcoordBuffer)),Tt.colorBuffer&&(pt.push(12===Tt.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),wt.push(Tt.colorBuffer)),Tt.normalBuffer&&(pt.push("HAS_ATTRIBUTE_a_normal_3f"),wt.push(Tt.normalBuffer)),Tt.pbrBuffer&&(pt.push("HAS_ATTRIBUTE_a_pbr"),pt.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),wt.push(Tt.pbrBuffer)),"OPAQUE"!==Lt.alphaMode&&"MASK"!==Lt.alphaMode||pt.push("UNPREMULT_TEXTURE_IN_SHADER"),Lt.defined||pt.push("DIFFUSE_SHADED"),pt.push("USE_STANDARD_DERIVATIVES")}function pr(pt,wt,Tt,St,It,Lt){const Xt=Tt.paint.get("model-opacity"),Yt=wt.context,Mi=new ut.ae(wt.context.gl.LEQUAL,ut.ae.ReadWrite,wt.depthRangeFor3D),vr=wt.transform,br=pt.mesh,Ar=br.material,Vr=Ar.pbrMetallicRoughness,nn=wt.style.fog;let an;an="pixels"===wt.transform.projection.zAxisUnit?[...pt.nodeModelMatrix]:ut.ad.multiply([],St.zScaleMatrix,pt.nodeModelMatrix),ut.ad.multiply(an,St.negCameraPosMatrix,an);const ln=ut.ad.invert([],an);ut.ad.transpose(ln,ln);const cn=Tt.paint.get("model-emissive-strength").constantOr(0),un=vo(new Float32Array(pt.worldViewProjection),new Float32Array(an),new Float32Array(ln),null,wt,Xt,Vr.baseColorFactor.toRenderColor(null),Ar.emissiveFactor,Vr.metallicFactor,Vr.roughnessFactor,Ar,cn,Tt),fn={defines:[]},_n=[];dr(fn.defines,_n,br,wt,Tt.lut);const gn=wt.shadowRenderer;gn&&(gn.useNormalOffset=!1);let yn=null;if(nn){const ut=_r(pt.nodeModelMatrix,wt.transform);if(yn=new Float32Array(ut),"globe"!==vr.projection.name){const pt=br.aabb.min,wt=br.aabb.max,[Tt,St]=nn.getOpacityForBounds(ut,pt[0],pt[1],wt[0],wt[1]);fn.overrideFog=Tt>=sn||St>=sn}}const xn=mi(wt,Tt.paint.get("model-cutoff-fade-range"));xn.shouldRenderCutoff&&fn.defines.push("RENDER_CUTOFF");const vn=wt.getOrCreateProgram("model",fn);wt.uploadCommonUniforms(Yt,vn,null,yn,xn),"shadow"!==wt.renderPass&&gn&&gn.setupShadowsFromMatrix(pt.nodeModelMatrix,vn),vn.draw(wt,Yt.gl.TRIANGLES,Mi,It,Lt,br.material.doubleSided?ut.af.disabled:ut.af.backCCW,un,Tt.id,br.vertexBuffer,br.indexBuffer,br.segments,Tt.paint,wt.transform.zoom,void 0,_n)}function fr(pt,wt,Tt,St,It,Lt,Xt){let Yt;Yt="globe"===pt.projection.name?ut.ci(Tt,pt):[...Tt],ut.ad.multiply(Yt,Yt,wt.matrix);const Mi=ut.ad.multiply([],St,Yt);if(wt.meshes)for(const pt of wt.meshes){if("BLEND"!==pt.material.alphaMode){Xt.push({mesh:pt,depth:0,modelIndex:It,worldViewProjection:Mi,nodeModelMatrix:Yt});continue}const wt=ut._.transformMat4([],pt.centroid,Mi);wt[2]>0&&Lt.push({mesh:pt,depth:wt[2],modelIndex:It,worldViewProjection:Mi,nodeModelMatrix:Yt})}if(wt.children)for(const ut of wt.children)fr(pt,ut,Tt,St,It,Lt,Xt)}function mr(pt,wt,Tt,St){const It=Tt.shadowRenderer;if(!It)return;const Lt=It.getShadowPassDepthMode(),Xt=It.getShadowPassColorMode(),Yt=It.calculateShadowPassMatrixFromMatrix(wt),Mi=xo(Yt);Tt.getOrCreateProgram("modelDepth",{defines:Tt._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(Tt,Tt.context.gl.TRIANGLES,Lt,ut.ag.disabled,Xt,ut.af.backCCW,Mi,St.id,pt.vertexBuffer,pt.indexBuffer,pt.segments,St.paint,Tt.transform.zoom,void 0,void 0)}function gr(pt,wt,Tt){const St=wt.updateZoomBasedPaintProperties(),It=function(pt,wt,Tt){let St,It,Lt,Xt=pt.terrain?pt.terrain.exaggeration():0;if(pt.terrain&&Xt>0){const wt=pt.terrain,It=wt.findDEMTileFor(Tt);It&&It.dem?St=ut.ck.create(wt,Tt,It):Xt=0}if(0===Xt&&(wt.terrainElevationMin=0,wt.terrainElevationMax=0),Xt===wt.validForExaggeration&&(0===Xt||St&&St._demTile&&St._demTile.tileID===wt.validForDEMTile.id&&St._dem._timestamp===wt.validForDEMTile.timestamp))return!1;for(const ut in wt.instancesPerModel){const pt=wt.instancesPerModel[ut];for(let ut=0;ut<pt.instancedDataArray.length;++ut){const Tt=(St?Xt*St.getElevationAt(0|pt.instancedDataArray.float32[16*ut],0|pt.instancedDataArray.float32[16*ut+1],!0,!0):0)+pt.instancesEvaluatedElevation[ut];pt.instancedDataArray.float32[16*ut+6]=Tt,It=It?Math.min(wt.terrainElevationMin,Tt):Tt,Lt=Lt?Math.max(wt.terrainElevationMax,Tt):Tt}}return wt.terrainElevationMin=It||0,wt.terrainElevationMax=Lt||0,wt.validForExaggeration=Xt,wt.validForDEMTile=St&&St._demTile?{id:St._demTile.tileID,timestamp:St._dem._timestamp}:{id:void 0,timestamp:0},!0}(pt,wt,Tt);(St||It)&&(wt.uploaded=!1,wt.upload(pt.context))}const lc={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new ut.b6([0,0,0],[ut.a3,ut.a3,0])};function xr(pt,wt){const Tt=1<<pt.canonical.z,St=wt.getFreeCameraOptions().position,It=wt.elevation,Lt=pt.canonical.x/Tt,Xt=(pt.canonical.x+1)/Tt,Yt=pt.canonical.y/Tt,Mi=(pt.canonical.y+1)/Tt;let vr=wt._centerAltitude;if(It){const ut=It.getMinMaxForTile(pt);ut&&ut.max>vr&&(vr=ut.max)}const br=ut.at(St.x,Lt,Xt)-St.x,Ar=ut.at(St.y,Yt,Mi)-St.y,Vr=ut.ax(vr,wt.center.lat)-St.z;return wt._zoomFromMercatorZ(Math.sqrt(br*br+Ar*Ar+Vr*Vr))}function yr(pt,wt,Tt,St,It,Lt,Xt){const Yt=pt.context,Mi="shadow"===pt.renderPass,vr=pt.shadowRenderer,br=Mi&&vr?vr.getShadowPassDepthMode():new ut.ae(Yt.gl.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D),Ar=pt.isTileAffectedByFog(Lt);if(Tt.meshes)for(const Vr of Tt.meshes){const nn=["MODEL_POSITION_ON_GPU"],sn=[];let an,ln,cn;St.instancedDataArray.length>20&&nn.push("INSTANCED_ARRAYS");const un=mi(pt,wt.paint.get("model-cutoff-fade-range"));if(un.shouldRenderCutoff&&nn.push("RENDER_CUTOFF"),Mi&&vr)an=pt.getOrCreateProgram("modelDepth",{defines:nn}),ln=xo(Xt.shadowTileMatrix,Xt.shadowTileMatrix,Float32Array.from(Tt.matrix)),cn=vr.getShadowPassColorMode();else{dr(nn,sn,Vr,pt,wt.lut),an=pt.getOrCreateProgram("model",{defines:nn,overrideFog:Ar});const St=Vr.material,Mi=St.pbrMetallicRoughness,br=wt.paint.get("model-opacity"),fn=wt.paint.get("model-emissive-strength").constantOr(0);ln=vo(Lt.expandedProjMatrix,Float32Array.from(Tt.matrix),new Float32Array(16),null,pt,br,Mi.baseColorFactor.toRenderColor(null),St.emissiveFactor,Mi.metallicFactor,Mi.roughnessFactor,St,fn,wt,It),vr&&(Xt.shadowUniformsInitialized?an.setShadowUniformValues(Yt,vr.getShadowUniformValues()):(vr.setupShadows(Lt.toUnwrapped(),an,"model-tile",Lt.overscaledZ),Xt.shadowUniformsInitialized=!0)),cn=un.shouldRenderCutoff||br<1||"OPAQUE"!==St.alphaMode?ut.a.alphaBlended:ut.a.unblended}pt.uploadCommonUniforms(Yt,an,Lt.toUnwrapped(),null,un);const fn=Vr.material.doubleSided?ut.af.disabled:ut.af.backCCW;if(St.instancedDataArray.length>20)sn.push(St.instancedDataBuffer),an.draw(pt,Yt.gl.TRIANGLES,br,ut.ag.disabled,cn,fn,ln,wt.id,Vr.vertexBuffer,Vr.indexBuffer,Vr.segments,wt.paint,pt.transform.zoom,void 0,sn,St.instancedDataArray.length);else{const Tt=Mi?"u_instance":"u_normal_matrix";for(let It=0;It<St.instancedDataArray.length;++It)ln[Tt]=new Float32Array(St.instancedDataArray.arrayBuffer,64*It,16),an.draw(pt,Yt.gl.TRIANGLES,br,ut.ag.disabled,cn,fn,ln,wt.id,Vr.vertexBuffer,Vr.indexBuffer,Vr.segments,wt.paint,pt.transform.zoom,void 0,sn)}}if(Tt.children)for(const ut of Tt.children)yr(pt,wt,ut,St,It,Lt,Xt)}const cc=[1,-1,1];function wr(pt,wt,Tt,St){if(!Tt.modelManager)return!0;const It=Tt.modelManager;if(!Tt.shadowRenderer)return!0;const Lt=Tt.shadowRenderer,Xt=wt.aabb;let Yt=!0,Mi=pt.maxHeight;if(0===Mi){let ut=0;for(const wt in pt.instancesPerModel){const pt=It.getModel(wt,St);pt?ut=Math.max(ut,Math.max(Math.max(pt.aabb.max[0],pt.aabb.max[1]),pt.aabb.max[2])):Yt=!1}Mi=pt.maxScale*ut*1.41+pt.maxVerticalOffset,Yt&&(pt.maxHeight=Mi)}Xt.max[2]=Mi,Xt.min[2]+=pt.terrainElevationMin,Xt.max[2]+=pt.terrainElevationMax,ut._.transformMat4(Xt.min,Xt.min,wt.tileMatrix),ut._.transformMat4(Xt.max,Xt.max,wt.tileMatrix);const vr=Xt.intersects(Lt.getCurrentCascadeFrustum());return 0===Tt.currentShadowCascade&&(pt.isInsideFirstShadowMapFrustum=2===vr),0===vr}function Tr(pt,wt){const Tt=pt.uniformValues.u_cutoff_params[0],St=pt.uniformValues.u_cutoff_params[1],It=pt.uniformValues.u_cutoff_params[2],Lt=pt.uniformValues.u_cutoff_params[3];return St===Tt||Lt===It?1:ut.at(((wt-Tt)/(St-Tt)-It)/(Lt-It),0,1)}function Er(pt,wt,Tt,St){if(wt.pitch<20)return 1;const It=wt.getWorldToCameraMatrix(),Lt=ut.ad.multiply([],It,pt),Xt=[...Tt.min,1];let Yt=ut.aA.transformMat4([],Xt,Lt),Mi=Yt,vr=Yt;Xt[1]=Tt.max[1],Yt=ut.aA.transformMat4([],Xt,Lt),Mi=Yt[1]<Mi[1]?Yt:Mi,vr=Yt[1]>vr[1]?Yt:vr,Xt[0]=Tt.max[0],Yt=ut.aA.transformMat4([],Xt,Lt),Mi=Yt[1]<Mi[1]?Yt:Mi,vr=Yt[1]>vr[1]?Yt:vr,Xt[1]=Tt.min[1],Yt=ut.aA.transformMat4([],Xt,Lt),Mi=Yt[1]<Mi[1]?Yt:Mi,vr=Yt[1]>vr[1]?Yt:vr;const br=ut.at(St[0],0,1),Ar=100*wt.pixelsPerMeter*ut.at(St[1],0,1),Vr=ut.at(St[2],0,1),nn=ut._.lerp([],Mi,vr,br),sn=Math.tan(.5*wt.fovX),an=-nn[2]*sn;if(0===Ar)return nn[1]<-Math.abs(an)?Vr:1;const ln=(-Math.abs(an)-nn[1])/Ar,v=(ut,pt,wt)=>(1-wt)*ut+wt*pt,cn=ut.at(v(1,Vr,ln),Vr,1);return v(1,cn,ut.at((wt.pitch-20)/20,0,1))}class Cr{}class Sr{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(pt,wt,Tt){{const ut=this._storage.get(wt.id);if(ut)return ut.lastUsedFrameIdx=pt,ut.buf}const St=Tt.gl,It=St.getBufferParameter(St.ELEMENT_ARRAY_BUFFER,St.BUFFER_SIZE),Lt=new ArrayBuffer(It),Xt=new Int16Array(Lt);St.getBufferSubData(St.ELEMENT_ARRAY_BUFFER,0,new Int16Array(Lt));const Yt=new ut.cm;for(let ut=0;ut<It/2;ut+=3){const pt=Xt[ut],wt=Xt[ut+1],Tt=Xt[ut+2];Yt.emplaceBack(pt,wt),Yt.emplaceBack(wt,Tt),Yt.emplaceBack(Tt,pt)}const Mi=Tt.bindVertexArrayOES.current,vr=new Cr;return vr.buf=new ut.I(Tt,Yt),vr.lastUsedFrameIdx=pt,this._storage.set(wt.id,vr),Tt.bindVertexArrayOES.set(Mi),vr.buf}update(ut){for(const[pt,wt]of this._storage)ut-wt.lastUsedFrameIdx>30&&(wt.buf.destroy(),this._storage.delete(pt))}destroy(){for(const[ut,pt]of this._storage)pt.buf.destroy(),this._storage.delete(ut)}}const uc=ut.c7([{type:"Float32",name:"a_offset_xy",components:2}]);class Lr{constructor(pt){const wt=new ut.cn,Tt=new ut.bu;wt.emplaceBack(-1,-1),wt.emplaceBack(1,-1),wt.emplaceBack(1,1),wt.emplaceBack(-1,1),Tt.emplaceBack(0,1,2),Tt.emplaceBack(0,2,3),this.segments=ut.b.simpleSegment(0,0,wt.length,Tt.length),this.vx=pt.createVertexBuffer(wt,uc.members),this.idx=pt.createIndexBuffer(Tt)}destroy(){this.vx.destroy(),this.idx.destroy()}}const dc={symbol:function(pt,wt,Tt,St,It){if("translucent"!==pt.renderPass)return;const Lt=ut.ag.disabled,Xt=pt.colorModeForRenderPass();Tt.layout.get("text-variable-anchor")&&function(pt,wt,Tt,St,It,Lt,Xt){const Yt=wt.transform,Mi="map"===It,vr="map"===Lt;for(const wt of pt){const pt=St.getTile(wt),It=pt.getBucket(Tt);if(!It||!It.text||!It.text.segments.get().length)continue;const Lt=ut.aD(It.textSizeData,Yt.zoom),br=Eo(wt,It.getProjection(),Yt),Ar=Yt.calculatePixelsToTileUnitsMatrix(pt),Vr=Kt(br,pt.tileID.canonical,vr,Mi,Yt,It.getProjection(),Ar),nn=It.hasIconTextFit()&&It.hasIconData();if(Lt){const Tt=Math.pow(2,Yt.zoom-pt.tileID.overscaledZ);Ao(It,Mi,vr,Xt,ut.bO,Yt,Vr,wt,Tt,Lt,nn)}}}(St,pt,Tt,wt,Tt.layout.get("text-rotation-alignment"),Tt.layout.get("text-pitch-alignment"),It);const Yt=0!==Tt.paint.get("icon-opacity").constantOr(1),Mi=0!==Tt.paint.get("text-opacity").constantOr(1);void 0!==Tt.layout.get("symbol-sort-key").constantOr(1)&&(Yt||Mi)?Ro(pt,wt,Tt,St,Lt,Xt):(Yt&&Ro(pt,wt,Tt,St,Lt,Xt,{onlyIcons:!0}),Mi&&Ro(pt,wt,Tt,St,Lt,Xt,{onlyText:!0}),function(pt,wt,Tt,St){if(!pt.symbolParams.useOcclusionQueries)return;const It=pt.context.gl,Lt=pt.transform,Xt=Tt.paint,Yt=Xt.get("icon-occlusion-opacity").constantOr(0),Mi=Xt.get("text-occlusion-opacity").constantOr(0);if(!Tt.hasInitialOcclusionOpacityProperties||1===Yt&&1===Mi)return;const vr="globe"===Lt.projection.name;for(const Xt of St){const St=wt.getTile(Xt),Yt=St.getBucket(Tt);if(!Yt)continue;if("mercator"===Yt.projection.name&&vr)continue;if(Yt.fullyClipped)continue;if("globe"===Yt.projection.name){ut.w(`Occlusion not supported for globe mode. Layer: ${Tt.type}`);continue}const Mi=Eo(Xt,Yt.getProjection(),Lt),br=ut.ad.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,pt.symbolParams.depthOffset,1),Ar=ut.ad.multiply([],br,Mi),Vr="none"!==pt.symbolParams.visualizeOcclusions?1:pt.symbolParams.occlusionQueryFrameWindow;for(let wt=0;wt<Yt.symbolInstances.length;wt++){const Tt=Yt.symbolInstances.get(wt),Xt=pt.style.placement.opacities[Tt.crossTileID];if(Xt&&Xt.isHidden())continue;if((pt.frameCounter+wt)%Vr!=0)continue;const Mi=Tt.tileAnchorX,vr=Tt.tileAnchorY,br=Tt.zOffset;let nn;if("none"===pt.symbolParams.visualizeOcclusions){const ut=Yt.queries.get(wt);if(ut){if(!ut.isFree()){if(!ut.isResultAvailable())continue;const pt=ut.consumeResult();Tt.occlusionState=0===pt?0:1;continue}nn=ut}else nn=new se(pt.context),Yt.queries.set(wt,nn)}const sn=pt.getOrCreateProgram("occlusion"),an=pt.symbolParams.occluderSize,ln=yo(Ar,[Mi,vr,br],[Lt.width,Lt.height],[an,an],"zPass"===pt.symbolParams.visualizeOcclusions?[1,0,0,.8]:[1,.4,.2,.9]);pt.terrain&&pt.terrain.setupElevationDraw(St,sn,{useDepthForOcclusion:!1,labelPlaneMatrixInv:void 0}),"none"===pt.symbolParams.visualizeOcclusions&&nn&&nn.begin();const cn=new ut.ae("zPass"===pt.symbolParams.visualizeOcclusions?pt.context.gl.ALWAYS:pt.context.gl.LEQUAL,ut.ae.ReadOnly,pt.depthRangeFor3D);sn.draw(pt,It.TRIANGLES,cn,ut.ag.disabled,"none"!==pt.symbolParams.visualizeOcclusions?ut.a.alphaBlendedNonPremultiplied:ut.a.disabled,ut.af.disabled,ln,"occlusion",pt.occlusionBuffers.vx,pt.occlusionBuffers.idx,pt.occlusionBuffers.segments),"none"===pt.symbolParams.visualizeOcclusions&&nn&&nn.end()}}}(pt,wt,Tt,St)),wt.map.showCollisionBoxes&&(So(pt,wt,Tt,St,Tt.paint.get("text-translate"),Tt.paint.get("text-translate-anchor"),!0),So(pt,wt,Tt,St,Tt.paint.get("icon-translate"),Tt.paint.get("icon-translate-anchor"),!1))},circle:function(pt,wt,Tt,St){if("translucent"!==pt.renderPass)return;const It=Tt.paint.get("circle-opacity"),Lt=Tt.paint.get("circle-stroke-width"),Xt=Tt.paint.get("circle-stroke-opacity"),Yt=void 0!==Tt.layout.get("circle-sort-key").constantOr(1),Mi=Tt.paint.get("circle-emissive-strength");if(0===It.constantOr(1)&&(0===Lt.constantOr(1)||0===Xt.constantOr(1)))return;const vr=pt.context,br=vr.gl,Ar=pt.transform,Vr=pt.depthModeForSublayer(0,ut.ae.ReadOnly),nn=ut.ag.disabled,sn=pt.colorModeForDrapableLayerRenderPass(Mi),an="globe"===Ar.projection.name,ln=[ut.aj(Ar.center.lng),ut.ak(Ar.center.lat)],cn=[];for(let It=0;It<St.length;It++){const Lt=St[It],Xt=wt.getTile(Lt),Mi=Xt.getBucket(Tt);if(!Mi||Mi.projection.name!==Ar.projection.name)continue;const vr=Mi.programConfigurations.get(Tt.id),br=ut.bR(Tt),Vr=pt.isTileAffectedByFog(Lt);an&&br.push("PROJECTION_GLOBE_VIEW");const nn=pt.getOrCreateProgram("circle",{config:vr,defines:br,overrideFog:Vr}),sn=Mi.layoutVertexBuffer,un=Mi.globeExtVertexBuffer,fn=Mi.indexBuffer,_n=Ar.projection.createInversionMatrix(Ar,Lt.canonical),gn={programConfiguration:vr,program:nn,layoutVertexBuffer:sn,globeExtVertexBuffer:un,indexBuffer:fn,uniformValues:ut.bS(pt,Lt,Xt,_n,ln,Tt),tile:Xt};if(Yt){const pt=Mi.segments.get();for(const wt of pt)cn.push({segments:new ut.b([wt]),sortKey:wt.sortKey,state:gn})}else cn.push({segments:Mi.segments,sortKey:0,state:gn})}Yt&&cn.sort(((ut,pt)=>ut.sortKey-pt.sortKey));const un={useDepthForOcclusion:Ar.depthOcclusionForSymbolsAndCircles};for(const wt of cn){const{programConfiguration:St,program:It,layoutVertexBuffer:Lt,globeExtVertexBuffer:Xt,indexBuffer:Yt,uniformValues:Mi,tile:an}=wt.state,ln=wt.segments;pt.terrain&&pt.terrain.setupElevationDraw(an,It,un),pt.uploadCommonUniforms(vr,It,an.tileID.toUnwrapped()),It.draw(pt,br.TRIANGLES,Vr,nn,sn,ut.af.disabled,Mi,Tt.id,Lt,Yt,ln,Tt.paint,Ar.zoom,St,[Xt])}},heatmap:function(pt,wt,Tt,St){if(0!==Tt.paint.get("heatmap-opacity"))if("offscreen"===pt.renderPass){const It=pt.context,Lt=It.gl,Xt=ut.ag.disabled,Yt=new ut.a([Lt.ONE,Lt.ONE,Lt.ONE,Lt.ONE],ut.C.transparent,[!0,!0,!0,!0]);!function(ut,pt,wt,Tt){const St=ut.gl,It=pt.width*Tt,Lt=pt.height*Tt;ut.activeTexture.set(St.TEXTURE1),ut.viewport.set([0,0,It,Lt]);let Xt=wt.heatmapFbo;if(!Xt||Xt&&(Xt.width!==It||Xt.height!==Lt)){Xt&&Xt.destroy();const pt=St.createTexture();St.bindTexture(St.TEXTURE_2D,pt),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_S,St.CLAMP_TO_EDGE),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_WRAP_T,St.CLAMP_TO_EDGE),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MIN_FILTER,St.LINEAR),St.texParameteri(St.TEXTURE_2D,St.TEXTURE_MAG_FILTER,St.LINEAR),Xt=wt.heatmapFbo=ut.createFramebuffer(It,Lt,!0,null),function(ut,pt,wt,Tt,St,It){const Lt=ut.gl;Lt.texImage2D(Lt.TEXTURE_2D,0,ut.extRenderToTextureHalfFloat?Lt.RGBA16F:Lt.RGBA,St,It,0,Lt.RGBA,ut.extRenderToTextureHalfFloat?Lt.HALF_FLOAT:Lt.UNSIGNED_BYTE,null),Tt.colorAttachment.set(wt)}(ut,0,pt,Xt,It,Lt)}else St.bindTexture(St.TEXTURE_2D,Xt.colorAttachment.get()),ut.bindFramebuffer.set(Xt.framebuffer)}(It,pt,Tt,"globe"===pt.transform.projection.name?.5:.25),It.clear({color:ut.C.transparent});const Mi=pt.transform,vr="globe"===Mi.projection.name,br=vr?["PROJECTION_GLOBE_VIEW"]:[],Ar=vr?ut.af.frontCCW:ut.af.disabled,Vr=[ut.aj(Mi.center.lng),ut.ak(Mi.center.lat)];for(let nn=0;nn<St.length;nn++){const sn=St[nn];if(wt.hasRenderableParent(sn))continue;const an=wt.getTile(sn),ln=an.getBucket(Tt);if(!ln||ln.projection.name!==Mi.projection.name)continue;const cn=pt.isTileAffectedByFog(sn),un=ln.programConfigurations.get(Tt.id),fn=pt.getOrCreateProgram("heatmap",{config:un,defines:br,overrideFog:cn}),{zoom:_n}=pt.transform;pt.terrain&&pt.terrain.setupElevationDraw(an,fn),pt.uploadCommonUniforms(It,fn,sn.toUnwrapped());const gn=Mi.projection.createInversionMatrix(Mi,sn.canonical);fn.draw(pt,Lt.TRIANGLES,ut.ae.disabled,Xt,Yt,Ar,to(pt,sn,an,gn,Vr,_n,Tt.paint.get("heatmap-intensity")),Tt.id,ln.layoutVertexBuffer,ln.indexBuffer,ln.segments,Tt.paint,pt.transform.zoom,un,vr?[ln.globeExtVertexBuffer]:null)}It.viewport.set([0,0,pt.width,pt.height])}else"translucent"===pt.renderPass&&(pt.context.setColorMode(pt.colorModeForRenderPass()),function(pt,wt){const Tt=pt.context,St=Tt.gl,It=wt.heatmapFbo;if(!It)return;Tt.activeTexture.set(St.TEXTURE0),St.bindTexture(St.TEXTURE_2D,It.colorAttachment.get()),Tt.activeTexture.set(St.TEXTURE1);let Lt=wt.colorRampTexture;Lt||(Lt=wt.colorRampTexture=new ut.T(Tt,wt.colorRamp,St.RGBA)),Lt.bind(St.LINEAR,St.CLAMP_TO_EDGE),pt.getOrCreateProgram("heatmapTexture").draw(pt,St.TRIANGLES,ut.ae.disabled,ut.ag.disabled,pt.colorModeForRenderPass(),ut.af.disabled,((ut,pt,wt,Tt)=>({u_image:0,u_color_ramp:1,u_opacity:pt.paint.get("heatmap-opacity")}))(0,wt),wt.id,pt.viewportBuffer,pt.quadTriangleIndexBuffer,pt.viewportSegments,wt.paint,pt.transform.zoom)}(pt,Tt))},line:function(pt,wt,Tt,St){if("translucent"!==pt.renderPass)return;const It=Tt.paint.get("line-opacity"),Lt=Tt.paint.get("line-width");if(0===It.constantOr(1)||0===Lt.constantOr(1))return;const Xt=Tt.paint.get("line-emissive-strength"),Yt=Tt.paint.get("line-occlusion-opacity"),Mi=pt.context,vr=Mi.gl,br=Tt.layout.get("line-z-offset"),Ar=!br.isConstant()||!!br.constantOr(0),Vr=Ar?new ut.ae(pt.depthOcclusion?vr.GREATER:vr.LEQUAL,ut.ae.ReadOnly,pt.depthRangeFor3D):pt.depthModeForSublayer(0,ut.ae.ReadOnly),nn=pt.colorModeForDrapableLayerRenderPass(Xt),sn=pt.terrain&&pt.terrain.renderingToTexture,an=sn?1:ut.e.devicePixelRatio,ln=Tt.paint.get("line-dasharray"),cn=ln.constantOr(1),un=Tt.layout.get("line-cap"),fn=ln.constantOr(null),_n=un.constantOr(null),gn=Tt.paint.get("line-pattern"),yn=gn.constantOr(1),xn=gn.constantOr(null),vn=Tt.paint.get("line-opacity").constantOr(1);let bn=!yn&&1!==vn||pt.depthOcclusion&&Yt>0&&Yt<1;const wn=Tt.paint.get("line-gradient"),Tn=yn?"linePattern":"line",En=ut.bT(Tt);let Mn;if(sn&&pt.terrain&&pt.terrain.clipOrMaskOverlapStencilType()&&(bn=!1),0!==Yt&&pt.depthOcclusion){const pt=Tt.paint._values["line-opacity"];pt&&pt.value&&"constant"===pt.value.kind?Mn=pt.value:ut.w(`Occlusion opacity for layer ${Tt.id} is supported only when line-opacity isn't data-driven.`)}if(Ar&&(pt.forceTerrainMode=!0),!Ar&&0!==Yt&&pt.terrain&&!sn)return void ut.w(`Occlusion opacity for layer ${Tt.id} is supported on terrain only if the layer has non-zero line-z-offset.`);const Sn=bn&&Ar?pt.stencilModeFor3D():ut.ag.disabled;for(const It of St){const St=wt.getTile(It);if(yn&&!St.patternsLoaded())continue;const Lt=St.getBucket(Tt);if(!Lt)continue;pt.prepareDrawTile();const Xt=Lt.programConfigurations.get(Tt.id),br=pt.isTileAffectedByFog(It),ln=pt.getOrCreateProgram(Tn,{config:Xt,defines:Ar?[...En,"ELEVATED"]:En,overrideFog:br});if(xn&&St.imageAtlas){const ut=St.imageAtlas.patternPositions[xn.toString()];ut&&Xt.setConstantPatternPositions(ut)}if(!yn&&fn&&_n&&St.lineAtlas){const ut=St.lineAtlas.getDash(fn,_n);ut&&Xt.setConstantPatternPositions(ut)}let[un,gn]=Tt.paint.get("line-trim-offset");if("round"===_n||"square"===_n){const ut=1;un!==gn&&(0===un&&(un-=ut),1===gn&&(gn+=ut))}const An=sn?It.projMatrix:null,In=yn?ut.bU(pt,St,Tt,An,an,[un,gn]):ut.bV(pt,St,Tt,An,Lt.lineClipsArray.length,an,[un,gn]);if(wn){const St=Lt.gradients[Tt.id];let Xt=St.texture;if(Tt.gradientVersion!==St.version){let Yt=256;if(Tt.stepInterpolant){const Tt=wt.getSource().maxzoom,St=It.canonical.z===Tt?Math.ceil(1<<pt.transform.maxZoom-It.canonical.z):1;Yt=ut.at(ut.bW(Lt.maxLineLength/ut.a3*1024*St),256,Mi.maxTextureSize)}St.gradient=ut.bX({expression:Tt.gradientExpression(),evaluationKey:"lineProgress",resolution:Yt,image:St.gradient||void 0,clips:Lt.lineClipsArray}),St.texture?St.texture.update(St.gradient):St.texture=new ut.T(Mi,St.gradient,vr.RGBA),St.version=Tt.gradientVersion,Xt=St.texture}Mi.activeTexture.set(vr.TEXTURE1),Xt.bind(Tt.stepInterpolant?vr.NEAREST:vr.LINEAR,vr.CLAMP_TO_EDGE)}cn&&(Mi.activeTexture.set(vr.TEXTURE0),St.lineAtlasTexture&&St.lineAtlasTexture.bind(vr.LINEAR,vr.REPEAT),Xt.updatePaintBuffers()),yn&&(Mi.activeTexture.set(vr.TEXTURE0),St.imageAtlasTexture&&St.imageAtlasTexture.bind(vr.LINEAR,vr.CLAMP_TO_EDGE),Xt.updatePaintBuffers()),Ar&&pt.terrain.setupElevationDraw(St,ln),pt.uploadCommonUniforms(Mi,ln,It.toUnwrapped());const z=wt=>{null!=Mn&&(Mn.value=vn*Yt),ln.draw(pt,vr.TRIANGLES,Vr,wt,nn,ut.af.disabled,In,Tt.id,Lt.layoutVertexBuffer,Lt.indexBuffer,Lt.segments,Tt.paint,pt.transform.zoom,Xt,[Lt.layoutVertexBuffer2,Lt.patternVertexBuffer,Lt.zOffsetVertexBuffer]),null!=Mn&&(Mn.value=vn)};if(bn&&!Ar){const wt=pt.stencilModeForClipping(It).ref;0===wt&&sn&&Mi.clear({stencil:0});const Tt={func:vr.EQUAL,mask:255};In.u_alpha_discard_threshold=.8,z(new ut.ag(Tt,wt,255,vr.KEEP,vr.KEEP,vr.INVERT)),In.u_alpha_discard_threshold=0,z(new ut.ag(Tt,wt,255,vr.KEEP,vr.KEEP,vr.KEEP))}else bn&&Ar&&(In.u_alpha_discard_threshold=.001),z(Ar?Sn:pt.stencilModeForClipping(It))}bn&&(pt.resetStencilClippingMasks(),sn&&Mi.clear({stencil:0})),0===Yt||pt.depthOcclusion||sn||pt.layersWithOcclusionOpacity.push(pt.currentLayer),Ar&&(pt.forceTerrainMode=!1)},fill:function(pt,wt,Tt,St){const It=Tt.paint.get("fill-color"),Lt=Tt.paint.get("fill-opacity");if(0===Lt.constantOr(1))return;const Xt=Tt.paint.get("fill-emissive-strength"),Yt=pt.colorModeForDrapableLayerRenderPass(Xt),Mi=Tt.paint.get("fill-pattern"),vr=pt.opaquePassEnabledForLayer()&&!Mi.constantOr(1)&&1===It.constantOr(ut.C.transparent).a&&1===Lt.constantOr(0)?"opaque":"translucent";if(pt.renderPass===vr){const It=pt.depthModeForSublayer(1,"opaque"===pt.renderPass?ut.ae.ReadWrite:ut.ae.ReadOnly);Mo(pt,wt,Tt,St,It,Yt,!1)}if("translucent"===pt.renderPass&&Tt.paint.get("fill-antialias")){const It=pt.depthModeForSublayer(Tt.getPaintProperty("fill-outline-color")?2:0,ut.ae.ReadOnly);Mo(pt,wt,Tt,St,It,Yt,!0)}},"fill-extrusion":function(pt,wt,Tt,St){const It=Tt.paint.get("fill-extrusion-opacity"),Lt=pt.context,Xt=Lt.gl,Yt=pt.terrain,Mi=Yt&&Yt.renderingToTexture;if(0===It)return;const vr=pt.conflationActive&&pt.style.isLayerClipped(Tt,wt.getSource()),br=pt.style.order.indexOf(Tt.fqid);if(vr&&function(ut,pt,wt,Tt,St){for(const It of Tt){const Tt=pt.getTile(It).getBucket(wt);Tt&&(Tt.updateReplacement(It,ut.replacementSource,St),Tt.uploadCentroid(ut.context))}}(pt,wt,Tt,St,br),Yt||vr)for(const ut of St){const St=wt.getTile(ut).getBucket(Tt);St&&Fo(pt.context,wt,ut,St,Tt,Yt,vr)}if("shadow"===pt.renderPass&&pt.shadowRenderer){const Lt=pt.shadowRenderer;if(Yt&&It<.65&&Tt._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof ut.Z)return;const Xt=Lt.getShadowPassDepthMode(),Mi=Lt.getShadowPassColorMode();zo(pt,wt,Tt,St,Xt,ut.ag.disabled,Mi,vr)}else if("translucent"===pt.renderPass){const br=!Tt.paint.get("fill-extrusion-pattern").constantOr(1),Ar=Tt.paint.get("fill-extrusion-color").constantOr(ut.C.white);if(!Mi&&0!==Ar.a){const Lt=new ut.ae(pt.context.gl.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D);1===It&&br?zo(pt,wt,Tt,St,Lt,ut.ag.disabled,ut.a.unblended,vr):(zo(pt,wt,Tt,St,Lt,ut.ag.disabled,ut.a.disabled,vr),zo(pt,wt,Tt,St,Lt,pt.stencilModeFor3D(),pt.colorModeForRenderPass(),vr),pt.resetStencilClippingMasks())}if(pt.style.enable3dLights()&&br&&(!Yt&&"globe"!==pt.transform.projection.name||Mi)){const It=Tt.paint.get("fill-extrusion-opacity"),br=Tt.paint.get("fill-extrusion-ambient-occlusion-intensity"),Ar=Tt.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Vr=Tt.paint.get("fill-extrusion-flood-light-intensity"),nn=Tt.paint.get("fill-extrusion-flood-light-color").toRenderColor(Tt.lut).toArray01().slice(0,3),sn=br>0&&Ar>0,an=Vr>0,g=(ut,pt,wt)=>(1-wt)*ut+wt*pt,v=Lt=>{const Yt=pt.depthModeForSublayer(1,ut.ae.ReadOnly,Xt.LEQUAL,!0),Mi=Tt.paint.get(Lt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),sn=g(.1,3,Mi),an=pt._showOverdrawInspector;if(!an){const Mi=new ut.ag({func:Xt.ALWAYS,mask:255},255,255,Xt.KEEP,Xt.KEEP,Xt.REPLACE),an=new ut.a([Xt.ONE,Xt.ONE,Xt.ONE,Xt.ONE],ut.C.transparent,[!1,!1,!1,!0],Xt.MIN);Oo(pt,wt,Tt,St,Yt,Mi,an,ut.af.disabled,Lt,"sdf",It,br,Ar,Vr,nn,sn,vr,!1)}{const Mi=an?ut.ag.disabled:new ut.ag({func:Xt.EQUAL,mask:255},255,255,Xt.KEEP,Xt.DECR,Xt.DECR),ln=an?pt.colorModeForRenderPass():new ut.a([Xt.ONE_MINUS_DST_ALPHA,Xt.DST_ALPHA,Xt.ONE,Xt.ONE],ut.C.transparent,[!0,!0,!0,!0]);Oo(pt,wt,Tt,St,Yt,Mi,ln,ut.af.disabled,Lt,"color",It,br,Ar,Vr,nn,sn,vr,!1)}};if(Mi){const c=(Lt,Yt,Mi)=>{const sn=pt.depthModeForSublayer(1,ut.ae.ReadOnly,Xt.LEQUAL,!1),an=Tt.paint.get(Lt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ln=g(.1,3,an);{const Mi=new ut.a([Xt.ONE,Xt.ONE,Xt.ONE,Xt.ONE],ut.C.transparent,[!1,!1,!1,!0]);Oo(pt,wt,Tt,St,sn,ut.ag.disabled,Mi,ut.af.disabled,Lt,"clear",It,br,Ar,Vr,nn,ln,vr,Yt)}{const Mi=new ut.ag({func:Xt.ALWAYS,mask:255},255,255,Xt.KEEP,Xt.KEEP,Xt.REPLACE),an=new ut.a([Xt.ONE,Xt.ONE,Xt.ONE,Xt.ONE],ut.C.transparent,[!1,!1,!1,!0],Xt.MIN);Oo(pt,wt,Tt,St,sn,Mi,an,ut.af.disabled,Lt,"sdf",It,br,Ar,Vr,nn,ln,vr,Yt)}{const Mi=Lt?Xt.ZERO:Xt.ONE_MINUS_DST_ALPHA,an=new ut.ag({func:Xt.EQUAL,mask:255},255,255,Xt.KEEP,Xt.DECR,Xt.DECR),cn=new ut.a([Mi,Xt.DST_ALPHA,Xt.ONE_MINUS_DST_ALPHA,Xt.ZERO],ut.C.transparent,[!0,!0,!0,!0]);Oo(pt,wt,Tt,St,sn,an,cn,ut.af.disabled,Lt,"color",It,br,Ar,Vr,nn,ln,vr,Yt)}{const an=new ut.a([Xt.ONE,Xt.ONE,Xt.ONE,Lt?Xt.ZERO:Xt.ONE],ut.C.transparent,[!1,!1,!1,!0],Lt?Xt.FUNC_ADD:Xt.MAX);Oo(pt,wt,Tt,St,sn,ut.ag.disabled,an,ut.af.disabled,Lt,"clear",It,br,Ar,Vr,nn,ln,vr,Yt,Mi)}};if(sn||an){let wt;if(pt.prepareDrawTile(),Yt){const pt=Yt.drapeBufferSize[0],Tt=Yt.drapeBufferSize[1];wt=Yt.framebufferCopyTexture,wt&&(!wt||wt.size[0]===pt&&wt.size[1]===Tt)||(wt&&wt.destroy(),wt=Yt.framebufferCopyTexture=new ut.T(Lt,new ut.i({width:pt,height:Tt}),Xt.RGBA)),wt.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE),Xt.copyTexImage2D(Xt.TEXTURE_2D,0,Xt.RGBA,0,0,pt,Tt,0)}sn&&c(!0,!1,wt),an&&c(!1,!0,wt)}}else sn&&v(!0),an&&v(!1)}}},hillshade:function(pt,wt,Tt,St){if("offscreen"!==pt.renderPass&&"translucent"!==pt.renderPass)return;if(pt.style.disableElevatedTerrain)return;const It=pt.context,Lt=pt.terrain&&pt.terrain.renderingToTexture,[Xt,Yt]="translucent"!==pt.renderPass||Lt?[{},St]:pt.stencilConfigForOverlap(St);for(const St of Yt){const It=wt.getTile(St);if(It.needsHillshadePrepare&&"offscreen"===pt.renderPass)Ot(pt,It,Tt);else if("translucent"===pt.renderPass){const wt=pt.depthModeForSublayer(0,ut.ae.ReadOnly),Yt=Tt.paint.get("hillshade-emissive-strength"),Mi=pt.colorModeForDrapableLayerRenderPass(Yt),vr=Lt&&pt.terrain?pt.terrain.stencilModeForRTTOverlap(St):Xt[St.overscaledZ];Mt(pt,St,It,Tt,wt,vr,Mi)}}It.viewport.set([0,0,pt.width,pt.height]),pt.resetStencilClippingMasks()},raster:function(pt,wt,Tt,St,It,Lt){if("translucent"!==pt.renderPass)return;if(0===Tt.paint.get("raster-opacity"))return;const Xt="globe"===pt.transform.projection.name,Yt=0!==Tt.paint.get("raster-elevation"),Mi=Yt&&Xt;if(pt.renderElevatedRasterBackface&&!Mi)return;const vr=pt.context,br=vr.gl,Ar=wt.getSource(),Vr=function(pt,wt,Tt,St){const It=wt.paint.get("raster-color"),Lt="raster-array"===pt.type,Xt=[],Yt=wt.paint.get("raster-resampling"),Mi=wt.paint.get("raster-color-mix");let vr=wt.paint.get("raster-color-range");const br=[Mi[0],Mi[1],Mi[2],0],Ar=Mi[3];let Vr="nearest"===Yt?St.NEAREST:St.LINEAR;if(Lt&&(Xt.push("RASTER_ARRAY"),It||Xt.push("RASTER_COLOR"),"linear"===Yt&&Xt.push("RASTER_ARRAY_LINEAR"),Vr=St.NEAREST,!vr&&pt.rasterLayers)){const ut=pt.rasterLayers.find((({id:ut})=>ut===wt.sourceLayer));ut&&ut.fields&&ut.fields.range&&(vr=ut.fields.range)}if(vr=vr||[0,1],It){Xt.push("RASTER_COLOR"),Tt.activeTexture.set(St.TEXTURE2),wt.updateColorRamp(vr);let pt=wt.colorRampTexture;pt||(pt=wt.colorRampTexture=new ut.T(Tt,wt.colorRamp,St.RGBA)),pt.bind(St.LINEAR,St.CLAMP_TO_EDGE)}return{mix:br,range:vr,offset:Ar,defines:Xt,resampling:Vr}}(Ar,Tt,vr,br);if(Ar instanceof ut.bm&&!St.length&&!Xt)return;const nn=Tt.paint.get("raster-emissive-strength"),sn=pt.colorModeForDrapableLayerRenderPass(nn),an=pt.terrain&&pt.terrain.renderingToTexture,ln=!pt.options.moving,cn="nearest"===Tt.paint.get("raster-resampling")?br.NEAREST:br.LINEAR;if(Ar instanceof ut.bm&&!St.length&&(Ar.onNorthPole||Ar.onSouthPole)){const St=Yt?pt.stencilModeFor3D():ut.ag.disabled;return void jo(!!Ar.onNorthPole,null,pt,wt,Tt,nn,Vr,ut.af.disabled,St)}if(!St.length)return;const[un,fn]=Ar instanceof ut.bm||an?[{},St]:pt.stencilConfigForOverlap(St),_n=fn[fn.length-1].overscaledZ;Mi&&Vr.defines.push("PROJECTION_GLOBE_VIEW"),Yt&&Vr.defines.push("RENDER_CUTOFF");const w=(St,It,fn)=>{for(const gn of St){const St=gn.toUnwrapped(),yn=wt.getTile(gn);if(an&&(!yn||!yn.hasData()))continue;vr.activeTexture.set(br.TEXTURE0);const xn=Wo(yn,Ar,Tt,Vr);if(!xn||!xn.texture)continue;const{texture:vn,mix:bn,offset:wn,tileSize:Tn,buffer:En}=xn;let Mn,Sn;an?(Mn=ut.ae.disabled,Sn=gn.projMatrix):Yt?(Mn=new ut.ae(br.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D),Sn=Xt?Float32Array.from(pt.transform.expandedFarZProjMatrix):pt.transform.calculateProjMatrix(St,ln)):(Mn=pt.depthModeForSublayer(gn.overscaledZ-_n,1===Tt.paint.get("raster-opacity")?ut.ae.ReadWrite:ut.ae.ReadOnly,br.LESS),Sn=pt.transform.calculateProjMatrix(St,ln));const An=pt.terrain&&an?pt.terrain.stencilModeForRTTOverlap(gn):un[gn.overscaledZ],In=Lt?0:Tt.paint.get("raster-fade-duration");yn.registerFadeDuration(In);const Pn=wt.findLoadedParent(gn,0),zn=Ri(yn,Pn,wt,pt.transform,In);let Ln,kn;pt.terrain&&pt.terrain.prepareDrawTile(),vr.activeTexture.set(br.TEXTURE0),vn.bind(cn,br.CLAMP_TO_EDGE),vr.activeTexture.set(br.TEXTURE1),Pn?(Pn.texture&&Pn.texture.bind(cn,br.CLAMP_TO_EDGE),Ln=Math.pow(2,Pn.tileID.overscaledZ-yn.tileID.overscaledZ),kn=[yn.tileID.canonical.x*Ln%1,yn.tileID.canonical.y*Ln%1]):vn.bind(cn,br.CLAMP_TO_EDGE),vn.useMipmap&&vr.extTextureFilterAnisotropic&&pt.transform.pitch>20&&br.texParameterf(br.TEXTURE_2D,vr.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,vr.extTextureFilterAnisotropicMax);const Bn=pt.transform;let Wn;const Yn=Yt?Vo(Bn):[0,0,0,0];let Jn,Qn,bo,ko,No,Js=0;if(Mi&&Ar instanceof ut.bm&&Ar.coordinates.length>3)Jn=Float32Array.from(ut.bf(ut.bg(new ut.aO(0,0,0)))),Qn=Float32Array.from(Bn.globeMatrix),bo=Float32Array.from(ut.bb(Bn)),ko=[ut.aj(Bn.center.lng),ut.ak(Bn.center.lat)],Wn=Ar.elevatedGlobePerspectiveTransform,No=Ar.elevatedGlobeGridMatrix||new Float32Array(9);else if(Mi){const pt=ut.bc(gn.canonical);Js=ut.bd(pt.getCenter().lat),Jn=Float32Array.from(ut.bf(ut.bg(gn.canonical))),Qn=Float32Array.from(Bn.globeMatrix),bo=Float32Array.from(ut.bb(Bn)),ko=[ut.aj(Bn.center.lng),ut.ak(Bn.center.lat)],Wn=[0,0],No=Float32Array.from(ut.be(gn.canonical,pt,Js,Bn.worldSize/Bn._pixelsPerMercatorPixel))}else Wn=Ar instanceof ut.bm?Ar.perspectiveTransform:[0,0],Jn=new Float32Array(16),Qn=new Float32Array(9),bo=new Float32Array(16),ko=[0,0],No=new Float32Array(9);const ua=ro(Sn,Jn,Qn,bo,No,kn||[0,0],ut.a1(pt.transform.zoom),ko,Yn,Ln||1,zn,Tt,Wn,Yt?Tt.paint.get("raster-elevation"):0,2,bn,wn,Vr.range,Tn,En,nn),ga=pt.isTileAffectedByFog(gn),xa=pt.getOrCreateProgram("raster",{defines:Vr.defines,overrideFog:ga});if(pt.uploadCommonUniforms(vr,xa,St),Ar instanceof ut.bm){const wt=Ar.elevatedGlobeVertexBuffer,St=Ar.elevatedGlobeIndexBuffer;if(an||!Xt)Ar.boundsBuffer&&Ar.boundsSegments&&xa.draw(pt,br.TRIANGLES,Mn,ut.ag.disabled,sn,ut.af.disabled,ua,Tt.id,Ar.boundsBuffer,pt.quadTriangleIndexBuffer,Ar.boundsSegments);else if(wt&&St){const Lt=Bn.zoom<=ut.b1?Ar.elevatedGlobeSegments:Ar.getSegmentsForLongitude(Bn.center.lng);Lt&&xa.draw(pt,br.TRIANGLES,Mn,ut.ag.disabled,sn,It,ua,Tt.id,wt,St,Lt)}}else if(Mi){Mn=new ut.ae(br.LEQUAL,ut.ae.ReadOnly,pt.depthRangeFor3D);const wt=pt.globeSharedBuffers;if(wt){const[ut,St,Lt]=wt.getGridBuffers(Js,!1);xa.draw(pt,br.TRIANGLES,Mn,fn||An,pt.colorModeForRenderPass(),It,ua,Tt.id,ut,St,Lt)}}else{const{tileBoundsBuffer:wt,tileBoundsIndexBuffer:St,tileBoundsSegments:It}=pt.getTileBoundsBuffers(yn);xa.draw(pt,br.TRIANGLES,Mn,An,sn,ut.af.disabled,ua,Tt.id,wt,St,It)}}if(!(Ar instanceof ut.bm)&&Mi)for(const Lt of St){const St=Lt.canonical.y===(1<<Lt.canonical.z)-1;0===Lt.canonical.y&&jo(!0,Lt,pt,wt,Tt,nn,Vr,It,fn||ut.ag.disabled),St&&jo(!1,Lt,pt,wt,Tt,nn,Vr,It===ut.af.frontCW?ut.af.backCW:ut.af.frontCW,fn||ut.ag.disabled)}};Mi?w(fn,pt.renderElevatedRasterBackface?ut.af.backCW:ut.af.frontCW,pt.stencilModeFor3D()):w(fn,ut.af.disabled,void 0),pt.resetStencilClippingMasks()},"raster-particle":function(pt,wt,Tt,St,It,Lt){"offscreen"===pt.renderPass&&function(pt,wt,Tt,St){if(!St.length)return;const It=pt.context,Lt=It.gl,Xt=wt.getSource();if(!(Xt instanceof Di))return;const Yt=Math.ceil(Math.sqrt(Tt.paint.get("raster-particle-count")));let Mi=Tt.particlePositionRGBAImage;if(!Mi||Mi.width!==Yt){const pt=function(ut){const pt=ut*ut,wt=new Uint8Array(4*pt),o=function(ut){return ut|=0,ut=Math.imul(2747636419^ut,2654435769),ut=Math.imul(ut^ut>>>16,2654435769),((ut=Math.imul(ut^ut>>>16,2654435769))>>>0)/4294967296},Tt=1/1.3;for(let ut=0;ut<pt;ut++){const pt=Tt*(o(2*ut+0)+ua),St=Tt*(o(2*ut+1)+ua),It=255*pt%1,Lt=255*St%1,Xt=It,Yt=St-Lt/255,Mi=Lt;wt[4*ut+0]=255*(pt-It/255),wt[4*ut+1]=255*Xt,wt[4*ut+2]=255*Yt,wt[4*ut+3]=255*Mi}return wt}(Yt);Mi=Tt.particlePositionRGBAImage=new ut.i({width:Yt,height:Yt},pt)}let vr=Tt.particleFramebuffer;vr?vr.width!==Yt&&(vr.destroy(),vr=Tt.particleFramebuffer=It.createFramebuffer(Yt,Yt,!0,null)):vr=Tt.particleFramebuffer=It.createFramebuffer(Yt,Yt,!0,null);const br=[];for(const pt of St){const St=wt.getTile(pt);if(!(St instanceof ut.c3))continue;const Lt=Zo(St,Xt,Tt);if(!Lt)continue;const vr=[St.tileSize,St.tileSize];let Ar=Tt.tileFramebuffer;Ar||(Ar=Tt.tileFramebuffer=It.createFramebuffer(vr[0],vr[1],!0,null));let Vr=St.rasterParticleState;Vr||(Vr=St.rasterParticleState=new le(It,pt,vr,Mi));const nn=Vr.update(Tt.lastInvalidatedAt);Vr.particleTextureDimension!==Yt&&Vr.updateParticleTexture(pt,Mi);const sn=Vr.targetColorTexture;Vr.targetColorTexture=Vr.backgroundColorTexture,Vr.backgroundColorTexture=sn;const an=Vr.particleTexture0;Vr.particleTexture0=Vr.particleTexture1,Vr.particleTexture1=an,br.push([pt,Lt,Vr,nn])}if(0===br.length)return;const Ar=ut.e.now(),Vr=Tt.previousDrawTimestamp?.001*(Ar-Tt.previousDrawTimestamp):.0167;if(Tt.previousDrawTimestamp=Ar,Tt.hasColorMap()){It.activeTexture.set(Lt.TEXTURE0+2);let pt=Tt.colorRampTexture;pt||(pt=Tt.colorRampTexture=new ut.T(It,Tt.colorRamp,Lt.RGBA)),pt.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE)}It.bindFramebuffer.set(Tt.tileFramebuffer.framebuffer),function(pt,wt,Tt){const St=pt.context,It=St.gl,Lt=wt.tileFramebuffer;St.activeTexture.set(It.TEXTURE0);const Xt={u_texture:0,u_opacity:1.05*(Mi=wt.paint.get("raster-particle-fade-opacity-factor"))/(Mi+.05)},Yt=pt.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Mi;for(const Mi of Tt){const[,,Tt,vr]=Mi;Lt.colorAttachment.set(Tt.targetColorTexture.texture),St.viewport.set([0,0,Lt.width,Lt.height]),St.clear({color:ut.C.transparent}),vr&&(Tt.backgroundColorTexture.bind(It.NEAREST,It.CLAMP_TO_EDGE),Yt.draw(pt,It.TRIANGLES,ut.ae.disabled,ut.ag.disabled,ut.a.alphaBlended,ut.af.disabled,Xt,wt.id,pt.viewportBuffer,pt.quadTriangleIndexBuffer,pt.viewportSegments))}}(pt,Tt,br),function(pt,wt,Tt,St){const It=pt.context,Lt=It.gl,Xt=Tt.tileFramebuffer,Yt="globe"===pt.transform.projection.name,Mi=Tt.paint.get("raster-particle-max-speed");for(const vr of St){const[St,br,Ar]=vr;It.activeTexture.set(Lt.TEXTURE0+0),br.texture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE),Xt.colorAttachment.set(Ar.targetColorTexture.texture);const Vr=pt.getOrCreateProgram("rasterParticleDraw",{defines:br.defines,overrideFog:!1});It.activeTexture.set(Lt.TEXTURE0+1);const nn=br.scalarData?[]:[0,1,2,3].map((pt=>ut.bZ[pt](St)));nn.push(St);const sn=St.canonical.x,an=St.canonical.y;for(const It of nn){const Xt=wt.getTile(Yt?It.wrapped():It);if(!Xt)continue;const vr=Xt.rasterParticleState;if(!vr)continue;const Ar=It.canonical.x+(1<<It.canonical.z)*(It.wrap-St.wrap),nn=It.canonical.y;vr.particleTexture0.bind(Lt.NEAREST,Lt.CLAMP_TO_EDGE);const ln=lo(1,vr.particleTexture0.size[0],[Ar-sn,nn-an],0,br.texture.size,2,Mi,br.textureOffset,br.scale,br.offset);Vr.draw(pt,Lt.POINTS,ut.ae.disabled,ut.ag.disabled,ut.a.alphaBlended,ut.af.disabled,ln,Tt.id,vr.particleIndexBuffer,void 0,vr.particleSegment)}}}(pt,wt,Tt,br),It.bindFramebuffer.set(Tt.particleFramebuffer.framebuffer),function(pt,wt,Tt,St){const It=pt.context,Lt=It.gl,Xt=wt.paint.get("raster-particle-max-speed"),Yt=St*wt.paint.get("raster-particle-speed-factor")*.15,Mi=function(ut){return Math.pow(ut,6)}(.01+1*wt.paint.get("raster-particle-reset-rate-factor")),vr=wt.particleFramebuffer;It.viewport.set([0,0,vr.width,vr.height]);for(const St of Tt){const[,Tt,br]=St;It.activeTexture.set(Lt.TEXTURE0+0),Tt.texture.bind(Lt.LINEAR,Lt.CLAMP_TO_EDGE),It.activeTexture.set(Lt.TEXTURE0+1);const Ar=br.particleTexture0;Ar.bind(Lt.NEAREST,Lt.CLAMP_TO_EDGE);const Vr=co(1,Ar.size[0],0,Tt.texture.size,Xt,Yt,Mi,Tt.textureOffset,Tt.scale,Tt.offset);vr.colorAttachment.set(br.particleTexture1.texture),It.clear({color:ut.C.transparent}),pt.getOrCreateProgram("rasterParticleUpdate",{defines:Tt.defines}).draw(pt,Lt.TRIANGLES,ut.ae.disabled,ut.ag.disabled,ut.a.unblended,ut.af.disabled,Vr,wt.id,pt.viewportBuffer,pt.quadTriangleIndexBuffer,pt.viewportSegments)}}(pt,Tt,br,Vr)}(pt,wt,Tt,St),"translucent"===pt.renderPass&&(function(pt,wt,Tt,St,It){const Lt=pt.context,Xt=Lt.gl,Yt=!pt.options.moving,Mi="globe"===pt.transform.projection.name;if(!St.length)return;const[vr,br]=pt.stencilConfigForOverlap(St),Ar=[];Mi&&Ar.push("PROJECTION_GLOBE_VIEW");const Vr=pt.stencilModeFor3D();for(const St of br){const It=St.toUnwrapped(),br=wt.getTile(St);if(!br.rasterParticleState)continue;const nn=br.rasterParticleState,sn=100;br.registerFadeDuration(sn);const an=wt.findLoadedParent(St,0),ln=Ri(br,an,wt,pt.transform,sn);let cn,un;pt.terrain&&pt.terrain.prepareDrawTile(),Lt.activeTexture.set(Xt.TEXTURE0),nn.targetColorTexture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE),Lt.activeTexture.set(Xt.TEXTURE1),an&&an.rasterParticleState?(an.rasterParticleState.targetColorTexture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE),cn=Math.pow(2,an.tileID.overscaledZ-br.tileID.overscaledZ),un=[br.tileID.canonical.x*cn%1,br.tileID.canonical.y*cn%1]):nn.targetColorTexture.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE);const fn=Mi?Float32Array.from(pt.transform.expandedFarZProjMatrix):pt.transform.calculateProjMatrix(It,Yt),_n=pt.transform,gn=qo(_n),yn=ut.bc(St.canonical),xn=ut.bd(yn.getCenter().lat);let vn,bn,wn,Tn,En;Mi?(vn=Float32Array.from(ut.bf(ut.bg(St.canonical))),bn=Float32Array.from(_n.globeMatrix),wn=Float32Array.from(ut.bb(_n)),Tn=[ut.aj(_n.center.lng),ut.ak(_n.center.lat)],En=Float32Array.from(ut.be(St.canonical,yn,xn,_n.worldSize/_n._pixelsPerMercatorPixel))):(vn=new Float32Array(16),bn=new Float32Array(9),wn=new Float32Array(16),Tn=[0,0],En=new Float32Array(9));const Mn=no(fn,vn,bn,wn,En,un||[0,0],ut.a1(pt.transform.zoom),Tn,gn,cn||1,ln,250),Sn=pt.isTileAffectedByFog(St),An=pt.getOrCreateProgram("rasterParticle",{defines:Ar,overrideFog:Sn});if(pt.uploadCommonUniforms(Lt,An,It),Mi){const wt=new ut.ae(Xt.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D),St=0,It=pt.globeSharedBuffers;if(It){const[Lt,Yt,Mi]=It.getGridBuffers(xn,0!==St);An.draw(pt,Xt.TRIANGLES,wt,Vr,ut.a.alphaBlended,ut.af.backCCW,Mn,Tt.id,Lt,Yt,Mi)}}else{const wt=pt.depthModeForSublayer(0,ut.ae.ReadOnly),It=vr[St.overscaledZ],{tileBoundsBuffer:Lt,tileBoundsIndexBuffer:Yt,tileBoundsSegments:Mi}=pt.getTileBoundsBuffers(br);An.draw(pt,Xt.TRIANGLES,wt,It,ut.a.alphaBlended,ut.af.disabled,Mn,Tt.id,Lt,Yt,Mi)}}pt.resetStencilClippingMasks()}(pt,wt,Tt,St),pt.style.map.triggerRepaint())},background:function(pt,wt,Tt,St){const It=Tt.paint.get("background-color"),Lt=Tt.paint.get("background-opacity"),Xt=Tt.paint.get("background-emissive-strength");if(0===Lt)return;const Yt=pt.context,Mi=Yt.gl,vr=pt.transform,br=vr.tileSize,Ar=Tt.paint.get("background-pattern");let Vr;if(void 0!==Ar){if(null===Ar)return;if(Vr=pt.imageManager.getPattern(Ar.toString(),Tt.scope,pt.style.getLut(Tt.scope)),!Vr)return}const nn=!Ar&&1===It.a&&1===Lt&&pt.opaquePassEnabledForLayer()?"opaque":"translucent";if(pt.renderPass!==nn)return;const sn=ut.ag.disabled,an=pt.depthModeForSublayer(0,"opaque"===nn?ut.ae.ReadWrite:ut.ae.ReadOnly),ln=pt.colorModeForDrapableLayerRenderPass(Xt),cn=Ar?"backgroundPattern":"background";let un,fn=St;fn||(un=pt.getBackgroundTiles(),fn=Object.values(un).map((ut=>ut.tileID))),Ar&&(Yt.activeTexture.set(Mi.TEXTURE0),pt.imageManager.bind(pt.context,Tt.scope));for(const nn of fn){const fn=pt.isTileAffectedByFog(nn),_n=pt.getOrCreateProgram(cn,{overrideFog:fn}),gn=nn.toUnwrapped(),yn=St?nn.projMatrix:pt.transform.calculateProjMatrix(gn);pt.prepareDrawTile();const xn=wt?wt.getTile(nn):un?un[nn.key]:new ut.by(nn,br,vr.zoom,pt),vn=Ar?mo(yn,Xt,Lt,pt,0,Tt.scope,Vr,{tileID:nn,tileSize:br}):fo(yn,Xt,Lt,It.toRenderColor(Tt.lut));pt.uploadCommonUniforms(Yt,_n,gn);const{tileBoundsBuffer:bn,tileBoundsIndexBuffer:wn,tileBoundsSegments:Tn}=pt.getTileBoundsBuffers(xn);_n.draw(pt,Mi.TRIANGLES,an,sn,ln,ut.af.disabled,vn,Tt.id,bn,wn,Tn)}},sky:function(pt,wt,Tt){const St=pt._atmosphere?ut.a1(pt.transform.zoom):1,It=Tt.paint.get("sky-opacity")*St;if(0===It)return;const Lt=pt.context,Xt=Tt.paint.get("sky-type"),Yt=new ut.ae(Lt.gl.LEQUAL,ut.ae.ReadOnly,[0,1]),Mi=pt.frameCounter/1e3%1;"atmosphere"===Xt?"offscreen"===pt.renderPass?Tt.needsSkyboxCapture(pt)&&(function(pt,wt,Tt,St){const It=pt.context,Lt=It.gl;let Xt=wt.skyboxFbo;if(!Xt){Xt=wt.skyboxFbo=It.createFramebuffer(32,32,!0,null),wt.skyboxGeometry=new ar(It),wt.skyboxTexture=It.gl.createTexture(),Lt.bindTexture(Lt.TEXTURE_CUBE_MAP,wt.skyboxTexture),Lt.texParameteri(Lt.TEXTURE_CUBE_MAP,Lt.TEXTURE_WRAP_S,Lt.CLAMP_TO_EDGE),Lt.texParameteri(Lt.TEXTURE_CUBE_MAP,Lt.TEXTURE_WRAP_T,Lt.CLAMP_TO_EDGE),Lt.texParameteri(Lt.TEXTURE_CUBE_MAP,Lt.TEXTURE_MIN_FILTER,Lt.LINEAR),Lt.texParameteri(Lt.TEXTURE_CUBE_MAP,Lt.TEXTURE_MAG_FILTER,Lt.LINEAR);for(let ut=0;ut<6;++ut)Lt.texImage2D(Lt.TEXTURE_CUBE_MAP_POSITIVE_X+ut,0,Lt.RGBA,32,32,0,Lt.RGBA,Lt.UNSIGNED_BYTE,null)}It.bindFramebuffer.set(Xt.framebuffer),It.viewport.set([0,0,32,32]);const Yt=wt.getCenter(pt,!0),Mi=pt.getOrCreateProgram("skyboxCapture"),vr=new Float64Array(16);ut.ad.identity(vr),ut.ad.rotateY(vr,vr,.5*-Math.PI),sr(pt,wt,Mi,vr,Yt,0),ut.ad.identity(vr),ut.ad.rotateY(vr,vr,.5*Math.PI),sr(pt,wt,Mi,vr,Yt,1),ut.ad.identity(vr),ut.ad.rotateX(vr,vr,.5*-Math.PI),sr(pt,wt,Mi,vr,Yt,2),ut.ad.identity(vr),ut.ad.rotateX(vr,vr,.5*Math.PI),sr(pt,wt,Mi,vr,Yt,3),ut.ad.identity(vr),sr(pt,wt,Mi,vr,Yt,4),ut.ad.identity(vr),ut.ad.rotateY(vr,vr,Math.PI),sr(pt,wt,Mi,vr,Yt,5),It.viewport.set([0,0,pt.width,pt.height])}(pt,Tt),Tt.markSkyboxValid(pt)):"sky"===pt.renderPass&&function(pt,wt,Tt,St,It){const Lt=pt.context,Xt=Lt.gl,Yt=pt.transform,Mi=pt.getOrCreateProgram("skybox");Lt.activeTexture.set(Xt.TEXTURE0),Xt.bindTexture(Xt.TEXTURE_CUBE_MAP,wt.skyboxTexture);const vr=((ut,pt,wt,Tt,St)=>({u_matrix:ut,u_sun_direction:pt,u_cubemap:0,u_opacity:Tt,u_temporal_offset:St}))(Yt.skyboxMatrix,wt.getCenter(pt,!1),0,St,It);pt.uploadCommonUniforms(Lt,Mi),Mi.draw(pt,Xt.TRIANGLES,Tt,ut.ag.disabled,pt.colorModeForRenderPass(),ut.af.backCW,vr,"skybox",wt.skyboxGeometry.vertexBuffer,wt.skyboxGeometry.indexBuffer,wt.skyboxGeometry.segment)}(pt,Tt,Yt,It,Mi):"gradient"===Xt&&"sky"===pt.renderPass&&function(pt,wt,Tt,St,It){const Lt=pt.context,Xt=Lt.gl,Yt=pt.transform,Mi=pt.getOrCreateProgram("skyboxGradient");wt.skyboxGeometry||(wt.skyboxGeometry=new ar(Lt)),Lt.activeTexture.set(Xt.TEXTURE0);let vr=wt.colorRampTexture;vr||(vr=wt.colorRampTexture=new ut.T(Lt,wt.colorRamp,Xt.RGBA)),vr.bind(Xt.LINEAR,Xt.CLAMP_TO_EDGE);const br=((pt,wt,Tt,St,It)=>({u_matrix:pt,u_color_ramp:0,u_center_direction:wt,u_radius:ut.ab(Tt),u_opacity:St,u_temporal_offset:It}))(Yt.skyboxMatrix,wt.getCenter(pt,!1),wt.paint.get("sky-gradient-radius"),St,It);pt.uploadCommonUniforms(Lt,Mi),Mi.draw(pt,Xt.TRIANGLES,Tt,ut.ag.disabled,pt.colorModeForRenderPass(),ut.af.backCW,br,"skyboxGradient",wt.skyboxGeometry.vertexBuffer,wt.skyboxGeometry.indexBuffer,wt.skyboxGeometry.segment)}(pt,Tt,Yt,It,Mi)},debug:function(pt,wt,Tt,St,It,Lt){for(let Xt=0;Xt<Tt.length;Xt++)if(It){const It=1,Yt=.8,Mi=new ut.C(St.r*Yt,St.g*Yt,St.b*Yt,1);Qo(pt,wt,Tt[Xt],St,-It,-It,Lt),Qo(pt,wt,Tt[Xt],St,-It,It,Lt),Qo(pt,wt,Tt[Xt],St,It,It,Lt),Qo(pt,wt,Tt[Xt],St,It,-It,Lt),Qo(pt,wt,Tt[Xt],Mi,0,0,Lt)}else Qo(pt,wt,Tt[Xt],St,0,0,Lt)},custom:function(pt,wt,Tt,St){const It=pt.context,Lt=Tt.implementation;if(!pt.transform.projection.unsupportedLayers||!pt.transform.projection.unsupportedLayers.includes("custom")||pt.terrain&&(pt.terrain.renderingToTexture||"offscreen"===pt.renderPass)&&Tt.isDraped(wt)){if("offscreen"===pt.renderPass){const wt=Lt.prerender;if(wt){if(pt.setCustomLayerDefaults(),It.setColorMode(pt.colorModeForRenderPass()),"globe"===pt.transform.projection.name){const Tt=pt.transform.pointMerc;wt.call(Lt,It.gl,pt.transform.customLayerMatrix(),pt.transform.getProjection(),pt.transform.globeToMercatorMatrix(),ut.a1(pt.transform.zoom),[Tt.x,Tt.y],pt.transform.pixelsPerMeterRatio)}else wt.call(Lt,It.gl,pt.transform.customLayerMatrix());It.setDirty(),pt.setBaseState()}}else if("translucent"===pt.renderPass){if(pt.terrain&&pt.terrain.renderingToTexture){const wt=Lt.renderToTile;if(wt){const Tt=St[0].canonical,Xt=new ut.Y(Tt.x+St[0].wrap*(1<<Tt.z),Tt.y,Tt.z);It.setDepthMode(ut.ae.disabled),It.setStencilMode(ut.ag.disabled),It.setColorMode(pt.colorModeForRenderPass()),pt.setCustomLayerDefaults(),wt.call(Lt,It.gl,Xt),It.setDirty(),pt.setBaseState()}return}pt.setCustomLayerDefaults(),It.setColorMode(pt.colorModeForRenderPass()),It.setStencilMode(ut.ag.disabled);const wt="3d"===Lt.renderingMode?new ut.ae(pt.context.gl.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D):pt.depthModeForSublayer(0,ut.ae.ReadOnly);if(It.setDepthMode(wt),"globe"===pt.transform.projection.name){const wt=pt.transform.pointMerc;Lt.render(It.gl,pt.transform.customLayerMatrix(),pt.transform.getProjection(),pt.transform.globeToMercatorMatrix(),ut.a1(pt.transform.zoom),[wt.x,wt.y],pt.transform.pixelsPerMeterRatio)}else Lt.render(It.gl,pt.transform.customLayerMatrix());It.setDirty(),pt.setBaseState(),It.bindFramebuffer.set(null)}}else ut.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(pt,wt,Tt,St){if("opaque"===pt.renderPass)return;const It=Tt.paint.get("model-opacity");if(0===It)return;const Lt=Tt.paint.get("model-cast-shadows");if("shadow"===pt.renderPass){if(!Lt)return;if(pt.terrain&&It<.65&&Tt._transitionablePaint._values["model-opacity"].value.expression instanceof ut.Z)return}const Xt=pt.shadowRenderer,Yt=Tt.paint.get("model-receive-shadows");Xt&&(Xt.useNormalOffset=!0,Yt||(Xt.enabled=!1));const c=()=>{Xt&&(Xt.useNormalOffset=!0,Yt||(Xt.enabled=!0))},Mi=wt.getSource();if("light-beam"===pt.renderPass&&"batched-model"!==Mi.type)return;if("vector"===Mi.type||"geojson"===Mi.type)return function(pt,wt,Tt,St,It){const Lt=pt.transform;if("mercator"!==Lt.projection.name)return void ut.w(`Drawing 3D models for ${Lt.projection.name} projection is not yet implemented`);const Xt=Lt.getFreeCameraOptions().position;if(!pt.modelManager)return;const Yt=pt.modelManager;Tt.modelManager=Yt;const Mi=pt.shadowRenderer;if(!Tt._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const vr=Tt._unevaluatedLayout._values["model-id"],br={...Tt.layout.get("model-id").parameters},Ar=pt.style.order.indexOf(Tt.fqid);for(const Vr of St){const St=wt.getTile(Vr).getBucket(Tt);if(!St||St.projection.name!==Lt.projection.name)continue;const nn=St.getModelUris();nn&&!St.modelsRequested&&(Yt.addModelsFromBucket(nn,It),St.modelsRequested=!0);const sn=xr(Vr,Lt);br.zoom=sn;const an=vr.possiblyEvaluate(br);if(gr(pt,St,Vr),lc.shadowUniformsInitialized=!1,lc.useSingleShadowCascade=!!Mi&&0===Mi.getMaxCascadeForTile(Vr.toUnwrapped()),"shadow"===pt.renderPass&&Mi){if(1===pt.currentShadowCascade&&St.isInsideFirstShadowMapFrustum)continue;const wt=Lt.calculatePosMatrix(Vr.toUnwrapped(),Lt.worldSize);if(lc.tileMatrix.set(wt),lc.shadowTileMatrix=Float32Array.from(Mi.calculateShadowPassMatrixFromMatrix(wt)),lc.aabb.min.fill(0),lc.aabb.max[0]=lc.aabb.max[1]=ut.a3,lc.aabb.max[2]=0,wr(St,lc,pt,Tt.scope))continue}const ln=1<<Vr.canonical.z,cn=[((Xt.x-Vr.wrap)*ln-Vr.canonical.x)*ut.a3,(Xt.y*ln-Vr.canonical.y)*ut.a3,Xt.z*ln*ut.a3];pt.conflationActive&&Object.keys(St.instancesPerModel).length>0&&pt.style.isLayerClipped(Tt,wt.getSource())&&St.updateReplacement(Vr,pt.replacementSource,Ar)&&(St.uploaded=!1,St.upload(pt.context));for(let ut in St.instancesPerModel){const wt=St.instancesPerModel[ut];wt.features.length>0&&(ut=an.evaluate(wt.features[0].feature,{}));const Lt=Yt.getModel(ut,It);if(Lt&&Lt.uploaded)for(const ut of Lt.nodes)yr(pt,Tt,ut,wt,cn,Vr,lc)}}}(pt,wt,Tt,St,"vector"===Mi.type?Tt.scope:""),void c();if(!Mi.loaded())return;if("batched-model"===Mi.type)return function(pt,wt,Tt,St){Tt.resetLayerRenderingStats(pt);const It=pt.context,Lt=pt.transform,Xt=pt.style.fog,Yt=pt.shadowRenderer;if("mercator"!==Lt.projection.name)return void ut.w(`Drawing 3D landmark models for ${Lt.projection.name} projection is not yet implemented`);const Mi=pt.transform.getFreeCameraOptions().position,vr=ut._.scale([],[Mi.x,Mi.y,Mi.z],pt.transform.worldSize);ut._.negate(vr,vr);const br=ut.ad.identity([]),Ar=ut.cg(Lt.center.lat,Lt.zoom),Vr=ut.ad.fromScaling([],[1,1,1/Ar]);ut.ad.translate(br,br,vr);const nn=Tt.paint.get("model-opacity"),an=new ut.ae(It.gl.LEQUAL,ut.ae.ReadWrite,pt.depthRangeFor3D),ln=new ut.ae(It.gl.LEQUAL,ut.ae.ReadOnly,pt.depthRangeFor3D),cn=new ut.b6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),un="shadow"===pt.renderPass,fn=un&&Yt?Yt.getCurrentCascadeFrustum():Lt.getFrustum(Lt.scaleZoom(Lt.worldSize)),_n=Tt.paint.get("model-front-cutoff"),gn=_n[2]<1,yn=mi(pt,Tt.paint.get("model-cutoff-fade-range")),xn=Tt.getLayerRenderingStats();(function(ut,pt,wt,Tt){const St=ut.terrain?ut.terrain.exaggeration():0,It=ut.transform.zoom;for(const Lt of Tt){const Tt=pt.getTile(Lt).getBucket(wt);Tt&&(ut.conflationActive&&Tt.updateReplacement(Lt,ut.replacementSource),Tt.evaluateScale(ut,wt),ut.terrain&&St>0&&Tt.elevationUpdate(ut.terrain,St,Lt,wt.source),Tt.needsReEvaluation(ut,It,wt)&&Tt.evaluate(wt))}})(pt,wt,Tt,St),function(){let Mi,vr,Ar;gn?(Mi=St.length-1,vr=-1,Ar=-1):(Mi=0,vr=St.length,Ar=1);for(let vn=Mi;vn!==vr;vn+=Ar){const Mi=St[vn],vr=wt.getTile(Mi).getBucket(Tt);if(!vr||!vr.uploaded)continue;let Ar=!1;Yt&&(Ar=0===Yt.getMaxCascadeForTile(Mi.toUnwrapped()));const bn=Lt.calculatePosMatrix(Mi.toUnwrapped(),Lt.worldSize),wn=vr.modelTraits,Tn=[];for(const wt of vr.getNodesInfo()){if(wt.hiddenByReplacement)continue;if(!wt.node.meshes)continue;const Tt=wt.node;let St=0;pt.terrain&&Tt.elevation&&(St=Tt.elevation*pt.terrain.exaggeration());const It=wt.evaluatedScale;if(It[0]<=1&&It[1]<=1&&It[2]<=1&&0===(()=>{const pt=wt.aabb;return cn.min=[...pt.min],cn.max=[...pt.max],cn.min[2]+=St,cn.max[2]+=St,ut._.transformMat4(cn.min,cn.min,bn),ut._.transformMat4(cn.max,cn.max,bn),cn})().intersects(fn))continue;const Xt=[...bn],Yt=Tt.anchor?Tt.anchor[0]:0,Mi=Tt.anchor?Tt.anchor[1]:0;ut.ad.translate(Xt,Xt,[Yt*(It[0]-1),Mi*(It[1]-1),St]),ut._.exactEquals(It,ut.cj)||ut.ad.scale(Xt,Xt,It);const vr=ut.ad.multiply([],Xt,Tt.matrix),br=ut.ad.multiply([],Lt.expandedFarZProjMatrix,vr),Ar=ut.ad.multiply([],Lt.expandedFarZProjMatrix,Xt),Vr=ut.aA.transformMat4([],[Yt,Mi,St,1],br)[2];Tt.hidden=!1;let sn=nn;un||(gn&&(sn*=Er(Xt,Lt,wt.aabb,_n)),sn*=Tr(yn,Vr)),0!==sn?Tn.push({nodeInfo:wt,depth:Vr,opacity:sn,wvpForNode:br,wvpForTile:Ar,nodeModelMatrix:vr,tileModelMatrix:Xt}):Tt.hidden=!0}un||Tn.sort(((ut,pt)=>!gn||1===ut.opacity&&1===pt.opacity?ut.depth<pt.depth?-1:1:1===ut.opacity?-1:1===pt.opacity?1:ut.depth>pt.depth?-1:1));for(const wt of Tn){const St=wt.nodeInfo,Mi=St.node;let vr=ut.ad.multiply([],Vr,wt.tileModelMatrix);ut.ad.multiply(vr,br,vr);const nn=ut.ad.invert([],vr);ut.ad.transpose(nn,nn),ut.ad.scale(nn,nn,cc),vr=ut.ad.multiply(vr,vr,Mi.matrix);const cn="light-beam"===pt.renderPass,fn=wn&ut.cl.HasMapboxMeshFeatures,_n=fn?0:St.evaluatedRMEA[0][2];for(let br=0;br<Mi.meshes.length;++br){const Vr=Mi.meshes[br],gn=br===Mi.lightMeshIndex;let yn=wt.wvpForNode;if(gn){if(!cn&&!pt.terrain&&pt.shadowRenderer){pt.currentLayer<pt.firstLightBeamLayer&&(pt.firstLightBeamLayer=pt.currentLayer);continue}yn=wt.wvpForTile}else if(cn)continue;const vn={defines:[]},bn=[];if(dr(vn.defines,bn,Vr,pt,Tt.lut),fn||vn.defines.push("DIFFUSE_SHADED"),Ar&&vn.defines.push("SHADOWS_SINGLE_CASCADE"),xn&&(un?xn.numRenderedVerticesInShadowPass+=Vr.vertexArray.length:xn.numRenderedVerticesInTransparentPass+=Vr.vertexArray.length),un){mr(Vr,wt.nodeModelMatrix,pt,Tt);continue}let wn=null;if(Xt){const ut=_r(wt.nodeModelMatrix,pt.transform);if(wn=new Float32Array(ut),"globe"!==Lt.projection.name){const pt=Vr.aabb.min,wt=Vr.aabb.max,[Tt,St]=Xt.getOpacityForBounds(ut,pt[0],pt[1],wt[0],wt[1]);vn.overrideFog=Tt>=sn||St>=sn}}const Tn=Vr.material;let En;Tn.occlusionTexture&&Tn.occlusionTexture.offsetScale&&(En=Tn.occlusionTexture.offsetScale,vn.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!un&&Yt&&(Yt.useNormalOffset=!!Vr.normalBuffer);const Mn=pt.getOrCreateProgram("model",vn);!un&&Yt&&Yt.setupShadowsFromMatrix(wt.tileModelMatrix,Mn,Yt.useNormalOffset),pt.uploadCommonUniforms(It,Mn,null,wn);const Sn=Tn.pbrMetallicRoughness;Sn.metallicFactor=.9,Sn.roughnessFactor=.5;const An=vo(new Float32Array(yn),new Float32Array(vr),new Float32Array(nn),new Float32Array(Mi.matrix),pt,wt.opacity,Sn.baseColorFactor.toRenderColor(null),Tn.emissiveFactor,Sn.metallicFactor,Sn.roughnessFactor,Tn,_n,Tt,[0,0,0],En);!gn&&(St.hasTranslucentParts||wt.opacity<1)&&Mn.draw(pt,It.gl.TRIANGLES,an,ut.ag.disabled,ut.a.disabled,ut.af.backCCW,An,Tt.id,Vr.vertexBuffer,Vr.indexBuffer,Vr.segments,Tt.paint,pt.transform.zoom,void 0,bn),Mn.draw(pt,It.gl.TRIANGLES,gn?ln:an,ut.ag.disabled,gn||wt.opacity<1||St.hasTranslucentParts?ut.a.alphaBlended:ut.a.unblended,ut.af.backCCW,An,Tt.id,Vr.vertexBuffer,Vr.indexBuffer,Vr.segments,Tt.paint,pt.transform.zoom,void 0,bn)}}}}()}(pt,wt,Tt,St),void c();const vr=Mi.getModels(),br=[],Ar=pt.transform.getFreeCameraOptions().position,Vr=ut._.scale([],[Ar.x,Ar.y,Ar.z],pt.transform.worldSize);ut._.negate(Vr,Vr);const nn=[],an=[];let ln=0;for(const wt of vr){const St=Tt.paint.get("model-rotation").constantOr(null),It=Tt.paint.get("model-scale").constantOr(null),Lt=Tt.paint.get("model-translation").constantOr(null);wt.computeModelMatrix(pt,St,It,Lt,!0,!0,!1);const Xt=ut.ad.identity([]),Yt=ut.cg(wt.position.lat,pt.transform.zoom),Mi=ut.ad.fromScaling([],[1,1,1/Yt]);ut.ad.translate(Xt,Xt,Vr),br.push({zScaleMatrix:Mi,negCameraPosMatrix:Xt});for(const ut of wt.nodes)fr(pt.transform,ut,wt.matrix,pt.transform.expandedFarZProjMatrix,ln,nn,an);ln++}if(nn.sort(((ut,pt)=>pt.depth-ut.depth)),"shadow"!==pt.renderPass){if(1===It)for(const wt of an)pr(wt,pt,Tt,br[wt.modelIndex],ut.ag.disabled,pt.colorModeForRenderPass());else{for(const wt of an)pr(wt,pt,Tt,br[wt.modelIndex],ut.ag.disabled,ut.a.disabled);for(const ut of an)pr(ut,pt,Tt,br[ut.modelIndex],pt.stencilModeFor3D(),pt.colorModeForRenderPass());pt.resetStencilClippingMasks()}for(const wt of nn)pr(wt,pt,Tt,br[wt.modelIndex],ut.ag.disabled,pt.colorModeForRenderPass());c()}else{for(const ut of an)mr(ut.mesh,ut.nodeModelMatrix,pt,Tt);for(const ut of nn)mr(ut.mesh,ut.nodeModelMatrix,pt,Tt);c()}}},fc={model:function(ut,pt,wt){const Tt=pt.getSource();if(!Tt.loaded())return;if("vector"===Tt.type||"geojson"===Tt.type)return void(wt.modelManager&&wt.modelManager.upload(wt,"vector"===Tt.type?ut.scope:""));if("batched-model"===Tt.type)return;const St=Tt.getModels();for(const ut of St)ut.upload(wt.context)},raster:function(ut,pt,wt){const Tt=pt.getSource();if(!(Tt instanceof Di&&Tt.loaded()))return;const St=ut.sourceLayer||Tt.rasterLayerIds&&Tt.rasterLayerIds[0];if(!St)return;const It=ut.paint.get("raster-array-band")||Tt.getInitialBand(St);if(null==It)return;const Lt=pt.getIds().map((ut=>pt.getTileByID(ut)));for(const ut of Lt)ut.updateNeeded(St,It)&&Tt.prepareTile(ut,St,It)},"raster-particle":function(ut,pt,wt){const Tt=pt.getSource();if(!(Tt instanceof Di&&Tt.loaded()))return;const St=ut.sourceLayer||Tt.rasterLayerIds&&Tt.rasterLayerIds[0];if(!St)return;const It=ut.paint.get("raster-particle-array-band")||Tt.getInitialBand(St);if(null==It)return;const Lt=pt.getIds().map((ut=>pt.getTileByID(ut)));for(const ut of Lt)ut.updateNeeded(St,It)&&Tt.prepareTile(ut,St,It)}};class Rr{constructor(pt,wt,Tt,St){this.context=new ae(pt,wt),this.occlusionBuffers=new Lr(this.context),this.transform=Tt,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=St,this._timeStamp=ut.e.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const It=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const ut of It)this._debugParams.enabledLayers[ut]=!0;St.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),St.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),St.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),St.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),St.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const ut of It)St.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],ut);this.symbolParams=new ne(St),this.setup(),this.numSublayers=ut.bv.maxUnderzooming+ut.bv.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new ut.co,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new yi(this),this._wireframeDebugCache=new Sr,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[]}updateTerrain(ut,pt){const wt=!!ut&&!!ut.terrain&&this.transform.projection.supportsTerrain;if(!(wt||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new ki(this,ut));const Tt=this._terrain;this.transform.elevation=wt?Tt:null,Tt.update(ut,this.transform,pt),this.transform.elevation&&!Tt.enabled&&(this.transform.elevation=null)}_updateFog(ut){const pt=ut.fog;if(!pt||"globe"===this.transform.projection.name||pt.getOpacity(this.transform.pitch)<1||pt.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[wt,Tt]=pt.getFovAdjustedRange(this.transform._fov);if(wt>Tt)return void(this.transform.fogCullDistSq=null);const St=wt+.78*(Tt-wt);this.transform.fogCullDistSq=St*St}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(ut){ut&&!this._terrain&&(this._terrain=new ki(this,this.style)),this._forceTerrainMode=ut}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(pt,wt){if(this.width=pt*ut.e.devicePixelRatio,this.height=wt*ut.e.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const ut of this.style.order)this.style._mergedLayers[ut].resize()}setup(){const pt=this.context,wt=new ut.bt;wt.emplaceBack(0,0),wt.emplaceBack(ut.a3,0),wt.emplaceBack(0,ut.a3),wt.emplaceBack(ut.a3,ut.a3),this.tileExtentBuffer=pt.createVertexBuffer(wt,ut.br.members),this.tileExtentSegments=ut.b.simpleSegment(0,0,4,2);const Tt=new ut.bt;Tt.emplaceBack(0,0),Tt.emplaceBack(ut.a3,0),Tt.emplaceBack(0,ut.a3),Tt.emplaceBack(ut.a3,ut.a3),this.debugBuffer=pt.createVertexBuffer(Tt,ut.br.members),this.debugSegments=ut.b.simpleSegment(0,0,4,5);const St=new ut.bt;St.emplaceBack(-1,-1),St.emplaceBack(1,-1),St.emplaceBack(-1,1),St.emplaceBack(1,1),this.viewportBuffer=pt.createVertexBuffer(St,ut.br.members),this.viewportSegments=ut.b.simpleSegment(0,0,4,2);const It=new ut.cp;It.emplaceBack(0,0,0,0),It.emplaceBack(ut.a3,0,ut.a3,0),It.emplaceBack(0,ut.a3,0,ut.a3),It.emplaceBack(ut.a3,ut.a3,ut.a3,ut.a3),this.mercatorBoundsBuffer=pt.createVertexBuffer(It,ut.cq.members),this.mercatorBoundsSegments=ut.b.simpleSegment(0,0,4,2);const Lt=new ut.bu;Lt.emplaceBack(0,1,2),Lt.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=pt.createIndexBuffer(Lt);const Xt=new ut.cr;for(const ut of[0,1,3,2,0])Xt.emplaceBack(ut);this.debugIndexBuffer=pt.createIndexBuffer(Xt),this.emptyTexture=new ut.T(pt,new ut.i({width:1,height:1},Uint8Array.of(0,0,0,0)),pt.gl.RGBA),this.identityMat=ut.ad.create();const Yt=this.context.gl;this.stencilClearMode=new ut.ag({func:Yt.ALWAYS,mask:0},0,255,Yt.ZERO,Yt.ZERO,Yt.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(ut){return ut._makeTileBoundsBuffers(this.context,this.transform.projection),ut._tileBoundsBuffer?{tileBoundsBuffer:ut._tileBoundsBuffer,tileBoundsIndexBuffer:ut._tileBoundsIndexBuffer,tileBoundsSegments:ut._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const pt=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,pt.TRIANGLES,ut.ae.disabled,this.stencilClearMode,ut.a.disabled,ut.af.disabled,Ai(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(pt,wt,Tt){if(!wt||this.currentStencilSource===wt.id||!pt.isTileClipped()||!Tt||0===Tt.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let ut=!1;for(const pt of Tt)if(void 0===this._tileClippingMaskIDs[pt.key]){ut=!0;break}if(!ut)return}this.currentStencilSource=wt.id;const St=this.context,It=St.gl;this.nextStencilID+Tt.length>256&&this.clearStencil(),St.setColorMode(ut.a.disabled),St.setDepthMode(ut.ae.disabled);const Lt=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const pt of Tt){const Tt=wt.getTile(pt),St=this._tileClippingMaskIDs[pt.key]=this.nextStencilID++,{tileBoundsBuffer:Xt,tileBoundsIndexBuffer:Yt,tileBoundsSegments:Mi}=this.getTileBoundsBuffers(Tt);Lt.draw(this,It.TRIANGLES,ut.ae.disabled,new ut.ag({func:It.ALWAYS,mask:0},St,255,It.KEEP,It.KEEP,It.REPLACE),ut.a.disabled,ut.af.disabled,Ai(pt.projMatrix),"$clipping",Xt,Yt,Mi)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const pt=this.nextStencilID++,wt=this.context.gl;return new ut.ag({func:wt.NOTEQUAL,mask:255},pt,255,wt.KEEP,wt.KEEP,wt.REPLACE)}stencilModeForClipping(pt){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(pt);const wt=this.context.gl;return new ut.ag({func:wt.EQUAL,mask:255},this._tileClippingMaskIDs[pt.key],0,wt.KEEP,wt.KEEP,wt.REPLACE)}stencilConfigForOverlap(pt){const wt=this.context.gl,Tt=pt.sort(((ut,pt)=>pt.overscaledZ-ut.overscaledZ)),St=Tt[Tt.length-1].overscaledZ,It=Tt[0].overscaledZ-St+1;if(It>1){this.currentStencilSource=void 0,this.nextStencilID+It>256&&this.clearStencil();const pt={};for(let Tt=0;Tt<It;Tt++)pt[Tt+St]=new ut.ag({func:wt.GEQUAL,mask:255},Tt+this.nextStencilID,255,wt.KEEP,wt.KEEP,wt.REPLACE);return this.nextStencilID+=It,[pt,Tt]}return[{[St]:ut.ag.disabled},Tt]}colorModeForRenderPass(){const pt=this.context.gl;if(this._showOverdrawInspector){const wt=1/8;return new ut.a([pt.CONSTANT_COLOR,pt.ONE,pt.CONSTANT_COLOR,pt.ONE],new ut.C(wt,wt,wt,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ut.a.unblended:ut.a.alphaBlended}colorModeForDrapableLayerRenderPass(pt){const wt=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new ut.a([wt.ONE,wt.ONE_MINUS_SRC_ALPHA,wt.CONSTANT_ALPHA,wt.ONE_MINUS_SRC_ALPHA],new ut.C(0,0,0,void 0===pt?0:pt),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(pt,wt,Tt,St=!1){if(this.depthOcclusion)return new ut.ae(this.context.gl.GREATER,ut.ae.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!St)return ut.ae.disabled;const It=1-((1+this.currentLayer)*this.numSublayers+pt)*this.depthEpsilon;return new ut.ae(Tt||this.context.gl.LEQUAL,wt,[It,It])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((ut,pt)=>ut+pt/this._fpsHistory.length),0))}render(pt,wt){const Tt=ut.e.now();this._dt=Tt-this._timeStamp,this._timeStamp=Tt,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=pt.map.repaint,this.style=pt,this.options=wt;const St=this.style._mergedLayers,It=this.style.order.filter((ut=>{const pt=St[ut];return!(pt.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[pt.type]})),Lt=It.map((ut=>St[ut])),Xt=this.style._mergedSourceCaches;this.imageManager=pt.imageManager,this.modelManager=pt.modelManager,this.symbolFadeChange=pt.placement.symbolFadeChange(ut.e.now()),this.imageManager.beginFrame();let Yt=0,Mi=!1;for(const ut in Xt){const pt=Xt[ut];pt.used&&(pt.prepare(this.context),pt.getSource().usedInConflation&&++Yt)}let vr=!1;for(const ut of Lt)ut.isHidden(this.transform.zoom)||("clip"===ut.type&&(vr=!0),this.prepareLayer(ut));const br={},Ar={},Vr={},nn={},sn={};for(const ut in Xt){const pt=Xt[ut];br[ut]=pt.getVisibleCoordinates(),Ar[ut]=br[ut].slice().reverse(),Vr[ut]=pt.getVisibleCoordinates(!0).reverse(),nn[ut]=pt.getShadowCasterCoordinates(),sn[ut]=pt.sortCoordinatesByDistance(br[ut])}const m=ut=>{const pt=this.style.getLayerSourceCache(ut);return pt&&pt.used?pt.getSource():null};if(Yt||vr){const pt=[],wt=[];let Tt=0;for(const ut of Lt)this.isSourceForClippingOrConflation(ut,m(ut))&&(pt.push(ut),wt.push(Tt)),Tt++;if(pt&&(vr||pt.length>1)){const Tt=[];for(let St=0;St<pt.length;St++){const It=pt[St],Lt=wt[St],Xt=this.style.getLayerSourceCache(It);if(!Xt||!Xt.used||!Xt.getSource().usedInConflation&&"clip"!==It.type)continue;let Yt=1/0,Mi=ut.cu.None;if("clip"===It.type){Yt=Lt;for(const pt of It.layout.get("clip-layer-types"))Mi|="model"===pt?ut.cu.Model:"symbol"===pt?ut.cu.Symbol:ut.cu.FillExtrusion}Tt.push({layer:It.fqid,cache:Xt,order:Yt,clipMask:Mi})}this.replacementSource.setSources(Tt),Mi=!0}}Mi||this.replacementSource.clear(),this.conflationActive=Mi,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ut=0;ut<Lt.length;ut++){const pt=Lt[ut],wt=pt.cutoffRange();if(this.longestCutoffRange=Math.max(wt,this.longestCutoffRange),wt>0){const ut=m(pt);ut&&(this.minCutoffZoom=Math.max(ut.minzoom,this.minCutoffZoom)),pt.minzoom&&(this.minCutoffZoom=Math.max(pt.minzoom,this.minCutoffZoom))}pt.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ut),this._lastOcclusionLayer=ut)}const an=this.style&&this.style.fog;an?(this._fogVisible=0!==an.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=an.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Vr),this.opaquePassCutoff=0);const ln=this._shadowRenderer;if(ln){ln.updateShadowParameters(this.transform,this.style.directionalLight);for(const ut in Xt)for(const pt of br[ut]){let ut={min:0,max:0};this.terrain&&(ut=this.terrain.getMinMaxForTile(pt)||ut),ln.addShadowReceiver(pt.toUnwrapped(),ut.min,ut.max)}}if("globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new ut.cs(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new ur(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!ut.ct(this.context.gl))return;this.renderPass="offscreen";for(const ut of Lt){const wt=pt.getLayerSourceCache(ut);if(!ut.hasOffscreenPass()||ut.isHidden(this.transform.zoom))continue;const Tt=wt?Ar[wt.id]:void 0;("custom"===ut.type||"raster"===ut.type||"raster-particle"===ut.type||ut.isSky()||Tt&&Tt.length)&&this.renderLayer(this,wt,ut,Tt)}this.depthRangeFor3D=[0,1-(Lt.length+2)*this.numSublayers*this.depthEpsilon];const cn=this.terrain;cn&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&cn.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,nn)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const un="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),fn=(()=>{if(wt.showOverdrawInspector)return ut.C.black;const pt=this.style.fog;if(pt&&this.transform.projection.supportsFog){const wt=this.style.getLut(pt.scope);if(!un){const Tt=pt.properties.get("color").toRenderColor(wt).toArray01();return new ut.C(...Tt)}if(un){const Tt=pt.properties.get("space-color").toRenderColor(wt).toArray01();return new ut.C(...Tt)}}return ut.C.transparent})();if(this.context.clear({color:fn,depth:1}),this.clearStencil(),this._showOverdrawInspector=wt.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&un&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=It.length-1;this.currentLayer>=0;this.currentLayer--){const ut=Lt[this.currentLayer],wt=pt.getLayerSourceCache(ut);if(ut.isSky())continue;const Tt=wt?(ut.is3D()?sn:Ar)[wt.id]:void 0;this._renderTileClippingMasks(ut,wt,Tt),this.renderLayer(this,wt,ut,Tt)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&un&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||ut.a1(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<It.length;this.currentLayer++){const ut=Lt[this.currentLayer],wt=pt.getLayerSourceCache(ut);ut.isSky()&&this.renderLayer(this,wt,ut,wt?Ar[wt.id]:void 0)}function w(ut,pt){let wt;return pt&&(wt=("symbol"===ut.type?Vr:ut.is3D()?sn:Ar)[pt.id]),wt}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<It.length;){const ut=Lt[this.currentLayer];if("raster"===ut.type){const wt=pt.getLayerSourceCache(ut);this.renderLayer(this,wt,ut,w(ut,wt))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let _n=0;for(ln&&(_n=ln.getShadowCastingLayerCount());this.currentLayer<It.length;){const ut=Lt[this.currentLayer],wt=pt.getLayerSourceCache(ut);if(ut.isSky())++this.currentLayer;else if(cn&&this.style.isLayerDraped(ut)){if(ut.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=cn.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(ut.is3D()||this.terrain||this._renderTileClippingMasks(ut,wt,wt?br[wt.id]:void 0),this.renderLayer(this,wt,ut,w(ut,wt)),!cn&&ln&&_n>0&&ut.hasShadowPass()&&0==--_n&&(ln.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const ut=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ut;this.currentLayer++){const ut=Lt[this.currentLayer];if(!ut.hasLightBeamPass())continue;const wt=pt.getLayerSourceCache(ut);this.renderLayer(this,wt,ut,wt?Ar[wt.id]:void 0)}this.currentLayer=ut,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const ut=this.currentLayer;this.depthOcclusion=!0;for(const ut of this.layersWithOcclusionOpacity){this.currentLayer=ut;const wt=Lt[this.currentLayer],Tt=pt.getLayerSourceCache(wt),St=Tt?Ar[Tt.id]:void 0;wt.is3D()||this.terrain||this._renderTileClippingMasks(wt,Tt,Tt?br[Tt.id]:void 0),this.renderLayer(this,Tt,wt,St)}this.depthOcclusion=!1,this.currentLayer=ut,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let wt=null;Lt.forEach((ut=>{const Tt=pt.getLayerSourceCache(ut);Tt&&!ut.isHidden(this.transform.zoom)&&Tt.getVisibleCoordinates().length&&(!wt||wt.getSource().maxzoom<Tt.getSource().maxzoom)&&(wt=Tt)})),wt&&this.options.showTileBoundaries&&dc.debug(this,wt,wt.getVisibleCoordinates(),ut.C.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&dc.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new ut.C(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(ut){const pt=ut.transform.padding;Jo(ut,ut.transform.height-(pt.top||0),3,Il),Jo(ut,pt.bottom||0,3,zl),er(ut,pt.left||0,3,ec),er(ut,ut.transform.width-(pt.right||0),3,tc);const wt=ut.transform.centerPoint;!function(ut,pt,wt,Tt){tr(ut,pt-1,wt-10,2,20,Tt),tr(ut,pt-10,wt-1,20,2,Tt)}(ut,wt.x,ut.transform.height-wt.y,ic)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),Mi||(this.conflationActive=!1)}prepareLayer(ut){this.gpuTimingStart(ut);const{unsupportedLayers:pt}=this.transform.projection,wt=!pt||!pt.includes(ut.type);if(fc[ut.type]&&(wt||this.terrain&&"custom"===ut.type)){const pt=this.style.getLayerSourceCache(ut);fc[ut.type](ut,pt,this)}this.gpuTimingEnd()}renderLayer(ut,pt,wt,Tt){wt.isHidden(this.transform.zoom)||("background"===wt.type||"sky"===wt.type||"custom"===wt.type||"model"===wt.type||"raster"===wt.type||"raster-particle"===wt.type||Tt&&Tt.length)&&(this.id=wt.id,this.gpuTimingStart(wt),ut.transform.projection.unsupportedLayers&&ut.transform.projection.unsupportedLayers.includes(wt.type)&&(!ut.terrain||"custom"!==wt.type)||"clip"===wt.type||dc[wt.type](ut,pt,wt,Tt,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(ut){if(!this.options.gpuTiming)return;const pt=this.context.extTimerQuery,wt=this.context.gl;let Tt=this.gpuTimers[ut.id];Tt||(Tt=this.gpuTimers[ut.id]={calls:0,cpuTime:0,query:wt.createQuery()}),Tt.calls++,wt.beginQuery(pt.TIME_ELAPSED_EXT,Tt.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const ut=this.context.extTimerQuery,pt=this.context.gl,wt=pt.createQuery();this.deferredRenderGpuTimeQueries.push(wt),pt.beginQuery(ut.TIME_ELAPSED_EXT,wt)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const ut=this.gpuTimers;return this.gpuTimers={},ut}collectDeferredRenderGpuQueries(){const ut=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],ut}queryGpuTimers(ut){const pt={};for(const wt in ut){const Tt=ut[wt],St=this.context.extTimerQuery,It=St.getQueryParameter(Tt.query,this.context.gl.QUERY_RESULT)/1e6;St.deleteQueryEXT(Tt.query),pt[wt]=It}return pt}queryGpuTimeDeferredRender(ut){if(!this.options.gpuTimingDeferredRender)return 0;const pt=this.context.extTimerQuery,wt=this.context.gl;let Tt=0;for(const St of ut)Tt+=pt.getQueryParameter(St,wt.QUERY_RESULT)/1e6,pt.deleteQueryEXT(St);return Tt}translatePosMatrix(pt,wt,Tt,St,It){if(!Tt[0]&&!Tt[1])return pt;const Lt=It?"map"===St?this.transform.angle:0:"viewport"===St?-this.transform.angle:0;if(Lt){const ut=Math.sin(Lt),pt=Math.cos(Lt);Tt=[Tt[0]*pt-Tt[1]*ut,Tt[0]*ut+Tt[1]*pt]}const Xt=[It?Tt[0]:ut.bB(wt,Tt[0],this.transform.zoom),It?Tt[1]:ut.bB(wt,Tt[1],this.transform.zoom),0],Yt=new Float32Array(16);return ut.ad.translate(Yt,pt,Xt),Yt}saveTileTexture(ut){const pt=ut.size[0],wt=this._tileTextures[pt];wt?wt.push(ut):this._tileTextures[pt]=[ut]}getTileTexture(ut){const pt=this._tileTextures[ut];return pt&&pt.length>0?pt.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(ut,pt,wt){const Tt=void 0===wt?this.terrain&&this.terrain.renderingToTexture:wt,St=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===ut||"terrainRaster"===ut?(St.push("LIGHTING_3D_MODE"),St.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):Tt||St.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||St.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?St.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):St.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(St.push("TERRAIN"),this.linearFloatFilteringSupported()&&St.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&St.push("GLOBE"),!this._fogVisible||Tt||void 0!==pt&&!pt||St.push("FOG","FOG_DITHERING"),Tt&&St.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&St.push("OVERDRAW_INSPECTOR"),St}getOrCreateProgram(ut,pt){this.cache=this.cache||{};const wt=pt&&pt.defines||[],Tt=pt&&pt.config,St=this.currentGlobalDefines(ut,pt&&pt.overrideFog,pt&&pt.overrideRtt).concat(wt),It=ji.cacheKey(zn[ut],ut,St,Tt);return this.cache[It]||(this.cache[It]=new ji(this.context,ut,zn[ut],Tt,Ra[ut],St)),this.cache[It]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const ut=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(ut.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new ut.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(pt,wt){if(this.style.enable3dLights()){const Tt=this.style.directionalLight,St=this.style.ambientLight;if(Tt&&St){const It=((pt,wt,Tt)=>{const St=pt.properties.get("direction"),It=pt.properties.get("color").toRenderColor(Tt.getLut(pt.scope)).toArray01(),Lt=pt.properties.get("intensity"),Xt=wt.properties.get("color").toRenderColor(Tt.getLut(wt.scope)).toArray01(),Yt=wt.properties.get("intensity"),Mi=[St.x,St.y,St.z],vr=ut.bA(Xt,Yt),br=ut.bA(It,Lt);return{u_lighting_ambient_color:vr,u_lighting_directional_dir:Mi,u_lighting_directional_color:br,u_ground_radiance:Ni(Mi,br,vr)}})(Tt,St,this.style);wt.setLightsUniformValues(pt,It)}}}uploadCommonUniforms(pt,wt,Tt,St,It){if(this.uploadCommonLightUniforms(pt,wt),this.terrain&&this.terrain.renderingToTexture)return;const Lt=this.style.fog;if(Lt){const It=Lt.getOpacity(this.transform.pitch),Xt=((pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar)=>{const Vr=pt.transform,nn=wt.properties.get("color").toRenderColor(pt.style.getLut(wt.scope)).toArray01();nn[3]=St;const sn=pt.frameCounter/1e3%1,[an,ln]=wt.properties.get("vertical-range");return{u_fog_matrix:Tt?Vr.calculateFogTileMatrix(Tt):Ar||pt.identityMat,u_fog_range:wt.getFovAdjustedRange(Vr._fov),u_fog_color:nn,u_fog_horizon_blend:wt.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(an,ln),ln],u_fog_temporal_offset:sn,u_frustum_tl:It,u_frustum_tr:Lt,u_frustum_br:Xt,u_frustum_bl:Yt,u_globe_pos:Mi,u_globe_radius:vr,u_viewport:br,u_globe_transition:ut.a1(Vr.zoom),u_is_globe:+("globe"===Vr.projection.name)}})(this,Lt,Tt,It,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*ut.e.devicePixelRatio,this.transform.height*ut.e.devicePixelRatio],St);wt.setFogUniformValues(pt,Xt)}It&&wt.setCutoffUniformValues(pt,It.uniformValues)}setTileLoadedFlag(ut){this.tileLoaded=ut}saveCanvasCopy(){const ut=this.canvasCopy();ut&&(this.frameCopies.push(ut),this.tileLoaded=!1)}canvasCopy(){const ut=this.context.gl,pt=ut.createTexture();return ut.bindTexture(ut.TEXTURE_2D,pt),ut.copyTexImage2D(ut.TEXTURE_2D,0,ut.RGBA,0,0,ut.drawingBufferWidth,ut.drawingBufferHeight,0),pt}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const ut=this.style&&this.style.fog;return!!ut&&0!==ut.getOpacity(this.transform.pitch)}getBackgroundTiles(){const pt=this._backgroundTiles,wt=this._backgroundTiles={},Tt=this.transform.coveringTiles({tileSize:512});for(const St of Tt)wt[St.key]=pt[St.key]||new ut.by(St,512,this.transform.tileZoom,this);return wt}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(ut,pt){return!(!ut.is3D()||ut.minzoom&&ut.minzoom>this.transform.zoom||(this.style._clipLayerIndices.length||"building"!==ut.sourceLayer)&&"clip"!==ut.type&&(!pt||"batched-model"!==pt.type))}isTileAffectedByFog(ut){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let pt=this._cachedTileFogOpacities[ut.key];return pt||(this._cachedTileFogOpacities[ut.key]=pt=this.style.fog.getOpacityForTile(ut)),pt[0]>=sn||pt[1]>=sn}}class Dr{constructor(ut,pt,wt,Tt){this.screenBounds=ut,this.cameraPoint=pt,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=wt,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,Tt)}static createFromScreenPoints(pt,wt){let Tt,St;if(pt instanceof ut.P||"number"==typeof pt[0]){const It=ut.P.convert(pt);Tt=[It],St=wt.isPointAboveHorizon(It)}else{const It=ut.P.convert(pt[0]),Lt=ut.P.convert(pt[1]);Tt=[It,Lt],St=ut.cv(It,Lt).every((ut=>wt.isPointAboveHorizon(ut)))}return new Dr(Tt,wt.getCameraPoint(),St,wt)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(pt){return ut.cv(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],pt)}bufferedCameraGeometry(pt){const wt=this.screenBounds[0],Tt=1===this.screenBounds.length?this.screenBounds[0].add(new ut.P(1,1)):this.screenBounds[1],St=ut.cv(wt,Tt,0,!1);return this.cameraPoint.y>Tt.y&&(this.cameraPoint.x>wt.x&&this.cameraPoint.x<Tt.x?St.splice(3,0,this.cameraPoint):this.cameraPoint.x>=Tt.x?St[2]=this.cameraPoint:this.cameraPoint.x<=wt.x&&(St[3]=this.cameraPoint)),ut.cw(St,pt)}bufferedCameraGeometryGlobe(pt){const wt=this.screenBounds[0],Tt=1===this.screenBounds.length?this.screenBounds[0].add(new ut.P(1,1)):this.screenBounds[1],St=ut.cv(wt,Tt,pt),It=this.cameraPoint.clone();switch(3*((It.y>wt.y)+(It.y>Tt.y))+((It.x>wt.x)+(It.x>Tt.x))){case 0:St[0]=It,St[4]=It.clone();break;case 1:St.splice(1,0,It);break;case 2:St[1]=It;break;case 3:St.splice(4,0,It);break;case 5:St.splice(2,0,It);break;case 6:St[3]=It;break;case 7:St.splice(3,0,It);break;case 8:St[2]=It}return St}containsTile(pt,wt,Tt,St=0){const It=pt.queryPadding/wt._pixelsPerMercatorPixel+1,Lt=Tt?this._bufferedCameraMercator(It,wt):this._bufferedScreenMercator(It,wt);let Xt=pt.tileID.wrap+(Lt.unwrapped?St:0);const Yt=Lt.polygon.map((wt=>ut.cx(pt.tileTransform,wt,Xt)));if(!ut.cy(Yt,0,0,ut.a3,ut.a3))return;Xt=pt.tileID.wrap+(this.screenGeometryMercator.unwrapped?St:0);const Mi=this.screenGeometryMercator.polygon.map((wt=>ut.cz(pt.tileTransform,wt,Xt))),vr=Mi.map((pt=>new ut.P(pt[0],pt[1]))),br=wt.getFreeCameraOptions().position||new ut.Y(0,0,0),Ar=ut.cz(pt.tileTransform,br,Xt),Vr=Mi.map((pt=>{const wt=ut._.sub(pt,pt,Ar);return ut._.normalize(wt,wt),new ut.aT(Ar,wt)})),nn=ut.bB(pt,1,wt.zoom)*wt._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:vr,tilespaceRays:Vr,bufferedTilespaceGeometry:Yt,bufferedTilespaceBounds:(sn=ut.cA(Yt),sn.min.x=ut.at(sn.min.x,0,ut.a3),sn.min.y=ut.at(sn.min.y,0,ut.a3),sn.max.x=ut.at(sn.max.x,0,ut.a3),sn.max.y=ut.at(sn.max.y,0,ut.a3),sn),tile:pt,tileID:pt.tileID,pixelToTileUnitsFactor:nn};var sn}_bufferedScreenMercator(ut,pt){const wt=Or(ut);if(this._screenRaycastCache[wt])return this._screenRaycastCache[wt];{let Tt;return Tt="globe"===pt.projection.name?this._projectAndResample(this.bufferedScreenGeometry(ut),pt):{polygon:this.bufferedScreenGeometry(ut).map((ut=>pt.pointCoordinate3D(ut))),unwrapped:!0},this._screenRaycastCache[wt]=Tt,Tt}}_bufferedCameraMercator(ut,pt){const wt=Or(ut);if(this._cameraRaycastCache[wt])return this._cameraRaycastCache[wt];{let Tt;return Tt="globe"===pt.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(ut),pt):{polygon:this.bufferedCameraGeometry(ut).map((ut=>pt.pointCoordinate3D(ut))),unwrapped:!0},this._cameraRaycastCache[wt]=Tt,Tt}}_projectAndResample(pt,wt){const Tt=function(pt,wt){const Tt=ut.ad.multiply([],wt.pixelMatrix,wt.globeMatrix),St=[0,-ut.cD,0,1],It=[0,ut.cD,0,1],Lt=[0,0,0,1];ut.aA.transformMat4(St,St,Tt),ut.aA.transformMat4(It,It,Tt),ut.aA.transformMat4(Lt,Lt,Tt);const Xt=new ut.P(St[0]/St[3],St[1]/St[3]),Yt=new ut.P(It[0]/It[3],It[1]/It[3]),Mi=ut.cB(pt,Xt)&&St[3]<Lt[3],vr=ut.cB(pt,Yt)&&It[3]<Lt[3];if(!Mi&&!vr)return null;const br=function(ut,pt,wt){for(let Tt=1;Tt<ut.length;Tt++){const St=zr(pt.pointCoordinate3D(ut[Tt-1]).x),It=zr(pt.pointCoordinate3D(ut[Tt]).x);if(wt<0){if(St<It)return{idx:Tt,t:-St/(It-1-St)}}else if(It<St)return{idx:Tt,t:(1-St)/(It+1-St)}}return null}(pt,wt,Mi?-1:1);if(!br)return null;const{idx:Ar,t:Vr}=br;let nn=Ar>1?Mr(pt.slice(0,Ar),wt):[],sn=Ar<pt.length?Mr(pt.slice(Ar),wt):[];nn=nn.map((pt=>new ut.P(zr(pt.x),pt.y))),sn=sn.map((pt=>new ut.P(zr(pt.x),pt.y)));const an=[...nn];0===an.length&&an.push(sn[sn.length-1]);const ln=ut.a2(an[an.length-1].y,(0===sn.length?nn[0]:sn[0]).y,Vr);let cn;return cn=Mi?[new ut.P(0,ln),new ut.P(0,0),new ut.P(1,0),new ut.P(1,ln)]:[new ut.P(1,ln),new ut.P(1,1),new ut.P(0,1),new ut.P(0,ln)],an.push(...cn),0===sn.length?an.push(nn[0]):an.push(...sn),{polygon:an.map((pt=>new ut.Y(pt.x,pt.y))),unwrapped:!1}}(pt,wt);if(Tt)return Tt;const St=function(pt,wt){let Tt=!1,St=-1/0,It=0;for(let ut=0;ut<pt.length-1;ut++)pt[ut].x>St&&(St=pt[ut].x,It=ut);for(let ut=0;ut<pt.length-1;ut++){const wt=(It+ut)%(pt.length-1),St=pt[wt],Lt=pt[wt+1];Math.abs(St.x-Lt.x)>.5&&(St.x<Lt.x?(St.x+=1,0===wt&&(pt[pt.length-1].x+=1)):(Lt.x+=1,wt+1===pt.length-1&&(pt[0].x+=1)),Tt=!0)}const Lt=ut.aj(wt.center.lng);return Tt&&Lt<Math.abs(Lt-1)&&pt.forEach((ut=>{ut.x-=1})),{polygon:pt,unwrapped:Tt}}(Mr(pt,wt).map((pt=>new ut.P(zr(pt.x),pt.y))),wt);return{polygon:St.polygon.map((pt=>new ut.Y(pt.x,pt.y))),unwrapped:St.unwrapped}}}function Mr(pt,wt){return ut.cC(pt,(ut=>{const pt=wt.pointCoordinate3D(ut);ut.x=pt.x,ut.y=pt.y}),1/256)}function zr(ut){return ut<0?1+ut%1:ut%1}function Or(ut){return 100*ut|0}function Fr(pt,wt){const Tt=ut.ad.identity([]);return ut.ad.scale(Tt,Tt,[.5*pt.width,.5*-pt.height,1]),ut.ad.translate(Tt,Tt,[1,-1,0]),ut.ad.multiply(Tt,Tt,pt.calculateProjMatrix(wt.toUnwrapped())),Float32Array.from(Tt)}function Br(ut,pt,wt,Tt,St,It,Lt,Xt=!1){const Yt=ut.tilesIn(Tt,Lt,Xt);Yt.sort(Nr);const Mi=[];for(const Tt of Yt)Mi.push({wrappedTileID:Tt.tile.tileID.wrapped().key,queryResults:Tt.tile.queryRenderedFeatures(pt,wt,ut._state,Tt,St,It,Fr(ut.transform,Tt.tile.tileID),Xt)});const vr=function(ut){const pt={},wt={};for(const Tt of ut){const ut=Tt.queryResults,St=Tt.wrappedTileID,It=wt[St]=wt[St]||{};for(const wt in ut){const Tt=ut[wt],St=It[wt]=It[wt]||{},Lt=pt[wt]=pt[wt]||[];for(const ut of Tt)St[ut.featureIndex]||(St[ut.featureIndex]=!0,Lt.push(ut))}}return pt}(Mi);for(const pt in vr)vr[pt].forEach((pt=>{const wt=pt.feature,Tt=wt.layer;Tt&&"background"!==Tt.type&&"sky"!==Tt.type&&"slot"!==Tt.type&&(wt.source=Tt.source,Tt["source-layer"]&&(wt.sourceLayer=Tt["source-layer"]),wt.state=void 0!==wt.id?ut.getFeatureState(Tt["source-layer"],wt.id):{})}));return vr}function kr(ut,pt){const wt=ut.getRenderableIds().map((pt=>ut.getTileByID(pt))),Tt=[],St={};for(let ut=0;ut<wt.length;ut++){const It=wt[ut],Lt=It.tileID.canonical.key;St[Lt]||(St[Lt]=!0,It.querySourceFeatures(Tt,pt))}return Tt}function Nr(ut,pt){const wt=ut.tileID,Tt=pt.tileID;return wt.overscaledZ-Tt.overscaledZ||wt.canonical.y-Tt.canonical.y||wt.wrap-Tt.wrap||wt.canonical.x-Tt.canonical.x}class Ur{constructor(ut){this.style=ut,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const ut=!1,pt=!1;for(const wt in this.style._mergedLayers){const Tt=this.style._mergedLayers[wt];if("fill-extrusion"===Tt.type)this.layers.push({layer:Tt,visible:ut,visibilityChanged:pt});else if("model"===Tt.type){const wt=this.style.getLayerSource(Tt);wt&&"batched-model"===wt.type&&this.layers.push({layer:Tt,visible:ut,visibilityChanged:pt})}}}onNewFrame(ut){this.layersGotHidden=!1;for(const pt of this.layers){const wt=pt.layer;let Tt=!1;"fill-extrusion"===wt.type?Tt=!wt.isHidden(ut)&&wt.paint.get("fill-extrusion-opacity")>0:"model"===wt.type&&(Tt=!wt.isHidden(ut)&&wt.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!Tt&&pt.visible,pt.visible=Tt}}updateZOffset(ut,pt){this.currentBuildingBuckets=[];for(const ut of this.layers){const wt=ut.layer,Tt=this.style.getLayerSourceCache(wt);let St=1;"fill-extrusion"===wt.type&&(St=ut.visible?wt.paint.get("fill-extrusion-vertical-scale"):0);let It=Tt?Tt.getTile(pt):null;if(!It&&Tt&&pt.canonical.z>Tt.getSource().minzoom){let ut=pt.scaledTo(Math.min(Tt.getSource().maxzoom,pt.overscaledZ-1));for(;ut.overscaledZ>=Tt.getSource().minzoom&&(It=Tt.getTile(ut),!It&&0!==ut.overscaledZ);)ut=ut.scaledTo(ut.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:It?It.getBucket(wt):null,tileID:It?It.tileID:pt,verticalScale:St})}ut.hasAnyZOffset=!1;let wt=!1;for(let Tt=0;Tt<ut.symbolInstances.length;Tt++){const St=ut.symbolInstances.get(Tt),It=St.zOffset,Lt=this._getHeightAtTileOffset(pt,St.tileAnchorX,St.tileAnchorY);St.zOffset=Lt!==Number.NEGATIVE_INFINITY?Lt:It,wt||It===St.zOffset||(wt=!0),ut.hasAnyZOffset||0===St.zOffset||(ut.hasAnyZOffset=!0)}wt&&(ut.zOffsetBuffersNeedUpload=!0,ut.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(pt,wt,Tt,St){let It=wt,Lt=Tt;if(pt.canonical.z!==St.canonical.z){const Xt=St.canonical,Yt=1/(1<<pt.canonical.z-Xt.z);It=(wt+pt.canonical.x*ut.a3)*Yt-Xt.x*ut.a3|0,Lt=(Tt+pt.canonical.y*ut.a3)*Yt-Xt.y*ut.a3|0}return{tileX:It,tileY:Lt}}_getHeightAtTileOffset(ut,pt,wt){let Tt,St;for(let It=0;It<this.layers.length;++It){if("fill-extrusion"!==this.layers[It].layer.type)continue;const{bucket:Lt,tileID:Xt,verticalScale:Yt}=this.currentBuildingBuckets[It];if(!Lt)continue;const{tileX:Mi,tileY:vr}=this._mapCoordToOverlappingTile(ut,pt,wt,Xt),br=Lt.getHeightAtTileCoord(Mi,vr);br&&void 0!==br.height&&(br.hidden?Tt=br.height:St=Math.max(br.height*Yt,St||0))}if(void 0!==St)return St;for(let St=0;St<this.layers.length;++St){const It=this.layers[St];if("model"!==It.layer.type||!It.visible)continue;const{bucket:Lt,tileID:Xt}=this.currentBuildingBuckets[St];if(!Lt)continue;const{tileX:Yt,tileY:Mi}=this._mapCoordToOverlappingTile(ut,pt,wt,Xt),vr=Lt.getHeightAtTileCoord(Yt,Mi);if(vr&&!vr.hidden)return void 0===vr.height&&void 0!==Tt?Math.min(vr.maxHeight,Tt)*vr.verticalScale:vr.height?vr.height*vr.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Gr(pt,wt){const Tt={};for(const ut in pt)"ref"!==ut&&(Tt[ut]=pt[ut]);return ut.cE.forEach((ut=>{ut in wt&&(Tt[ut]=wt[ut])})),Tt}function jr(ut){ut=ut.slice();const pt=Object.create(null);for(let wt=0;wt<ut.length;wt++)pt[ut[wt].id]=ut[wt];for(let wt=0;wt<ut.length;wt++)"ref"in ut[wt]&&(ut[wt]=Gr(ut[wt],pt[ut[wt].ref]));return ut}const gc={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Wr(ut,pt,wt){wt.push({command:gc.addSource,args:[ut,pt[ut]]})}function Zr(ut,pt,wt){pt.push({command:gc.removeSource,args:[ut]}),wt[ut]=!0}function qr(ut,pt,wt,Tt){Zr(ut,wt,Tt),Wr(ut,pt,wt)}function Hr(ut,pt,wt){let Tt;for(Tt in ut[wt])if(ut[wt].hasOwnProperty(Tt)&&"data"!==Tt&&!t(ut[wt][Tt],pt[wt][Tt]))return!1;for(Tt in pt[wt])if(pt[wt].hasOwnProperty(Tt)&&"data"!==Tt&&!t(ut[wt][Tt],pt[wt][Tt]))return!1;return!0}function $r(ut,pt,wt,Tt,St,It){let Lt;for(Lt in pt=pt||{},ut=ut||{})ut.hasOwnProperty(Lt)&&(t(ut[Lt],pt[Lt])||wt.push({command:It,args:[Tt,Lt,pt[Lt],St]}));for(Lt in pt)pt.hasOwnProperty(Lt)&&!ut.hasOwnProperty(Lt)&&(t(ut[Lt],pt[Lt])||wt.push({command:It,args:[Tt,Lt,pt[Lt],St]}))}function Xr(ut){return ut.id}function Yr(ut,pt){return ut[pt.id]=pt,ut}class Kr{constructor(ut,pt){this.reset(ut,pt)}reset(ut,pt){this.points=ut||[],this._distances=[0];for(let ut=1;ut<this.points.length;ut++)this._distances[ut]=this._distances[ut-1]+this.points[ut].dist(this.points[ut-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(pt||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(pt){if(1===this.points.length)return this.points[0];pt=ut.at(pt,0,1);let wt=1,Tt=this._distances[wt];const St=pt*this.paddedLength+this.padding;for(;Tt<St&&wt<this._distances.length;)Tt=this._distances[++wt];const It=wt-1,Lt=this._distances[It],Xt=Tt-Lt,Yt=Xt>0?(St-Lt)/Xt:0;return this.points[It].mult(1-Yt).add(this.points[wt].mult(Yt))}}class Qr{constructor(ut,pt,wt){const Tt=this.boxCells=[],St=this.circleCells=[];this.xCellCount=Math.ceil(ut/wt),this.yCellCount=Math.ceil(pt/wt);for(let ut=0;ut<this.xCellCount*this.yCellCount;ut++)Tt.push([]),St.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=ut,this.height=pt,this.xScale=this.xCellCount/ut,this.yScale=this.yCellCount/pt,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(ut,pt,wt,Tt,St){this._forEachCell(pt,wt,Tt,St,this._insertBoxCell,this.boxUid++),this.boxKeys.push(ut),this.bboxes.push(pt),this.bboxes.push(wt),this.bboxes.push(Tt),this.bboxes.push(St)}insertCircle(ut,pt,wt,Tt){this._forEachCell(pt-Tt,wt-Tt,pt+Tt,wt+Tt,this._insertCircleCell,this.circleUid++),this.circleKeys.push(ut),this.circles.push(pt),this.circles.push(wt),this.circles.push(Tt)}_insertBoxCell(ut,pt,wt,Tt,St,It){this.boxCells[St].push(It)}_insertCircleCell(ut,pt,wt,Tt,St,It){this.circleCells[St].push(It)}_query(ut,pt,wt,Tt,St,It){if(wt<0||ut>this.width||Tt<0||pt>this.height)return!St&&[];const Lt=[];if(ut<=0&&pt<=0&&this.width<=wt&&this.height<=Tt){if(St)return!0;for(let ut=0;ut<this.boxKeys.length;ut++)Lt.push({key:this.boxKeys[ut],x1:this.bboxes[4*ut],y1:this.bboxes[4*ut+1],x2:this.bboxes[4*ut+2],y2:this.bboxes[4*ut+3]});for(let ut=0;ut<this.circleKeys.length;ut++){const pt=this.circles[3*ut],wt=this.circles[3*ut+1],Tt=this.circles[3*ut+2];Lt.push({key:this.circleKeys[ut],x1:pt-Tt,y1:wt-Tt,x2:pt+Tt,y2:wt+Tt})}return It?Lt.filter(It):Lt}return this._forEachCell(ut,pt,wt,Tt,this._queryCell,Lt,{hitTest:St,seenUids:{box:{},circle:{}}},It),St?Lt.length>0:Lt}_queryCircle(ut,pt,wt,Tt,St){const It=ut-wt,Lt=ut+wt,Xt=pt-wt,Yt=pt+wt;if(Lt<0||It>this.width||Yt<0||Xt>this.height)return!Tt&&[];const Mi=[];return this._forEachCell(It,Xt,Lt,Yt,this._queryCellCircle,Mi,{hitTest:Tt,circle:{x:ut,y:pt,radius:wt},seenUids:{box:{},circle:{}}},St),Tt?Mi.length>0:Mi}query(ut,pt,wt,Tt,St){return this._query(ut,pt,wt,Tt,!1,St)}hitTest(ut,pt,wt,Tt,St){return this._query(ut,pt,wt,Tt,!0,St)}hitTestCircle(ut,pt,wt,Tt){return this._queryCircle(ut,pt,wt,!0,Tt)}_queryCell(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=Lt.seenUids,Mi=this.boxCells[St];if(null!==Mi){const St=this.bboxes;for(const vr of Mi)if(!Yt.box[vr]){Yt.box[vr]=!0;const Mi=4*vr;if(ut<=St[Mi+2]&&pt<=St[Mi+3]&&wt>=St[Mi+0]&&Tt>=St[Mi+1]&&(!Xt||Xt(this.boxKeys[vr]))){if(Lt.hitTest)return It.push(!0),!0;It.push({key:this.boxKeys[vr],x1:St[Mi],y1:St[Mi+1],x2:St[Mi+2],y2:St[Mi+3]})}}}const vr=this.circleCells[St];if(null!==vr){const St=this.circles;for(const Mi of vr)if(!Yt.circle[Mi]){Yt.circle[Mi]=!0;const vr=3*Mi;if(this._circleAndRectCollide(St[vr],St[vr+1],St[vr+2],ut,pt,wt,Tt)&&(!Xt||Xt(this.circleKeys[Mi]))){if(Lt.hitTest)return It.push(!0),!0;{const ut=St[vr],pt=St[vr+1],wt=St[vr+2];It.push({key:this.circleKeys[Mi],x1:ut-wt,y1:pt-wt,x2:ut+wt,y2:pt+wt})}}}}}_queryCellCircle(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=Lt.circle,Mi=Lt.seenUids,vr=this.boxCells[St];if(null!==vr){const ut=this.bboxes;for(const pt of vr)if(!Mi.box[pt]){Mi.box[pt]=!0;const wt=4*pt;if(this._circleAndRectCollide(Yt.x,Yt.y,Yt.radius,ut[wt+0],ut[wt+1],ut[wt+2],ut[wt+3])&&(!Xt||Xt(this.boxKeys[pt])))return It.push(!0),!0}}const br=this.circleCells[St];if(null!==br){const ut=this.circles;for(const pt of br)if(!Mi.circle[pt]){Mi.circle[pt]=!0;const wt=3*pt;if(this._circlesCollide(ut[wt],ut[wt+1],ut[wt+2],Yt.x,Yt.y,Yt.radius)&&(!Xt||Xt(this.circleKeys[pt])))return It.push(!0),!0}}}_forEachCell(ut,pt,wt,Tt,St,It,Lt,Xt){const Yt=this._convertToXCellCoord(ut),Mi=this._convertToYCellCoord(pt),vr=this._convertToXCellCoord(wt),br=this._convertToYCellCoord(Tt);for(let Ar=Yt;Ar<=vr;Ar++)for(let Yt=Mi;Yt<=br;Yt++)if(St.call(this,ut,pt,wt,Tt,this.xCellCount*Yt+Ar,It,Lt,Xt))return}_convertToXCellCoord(ut){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(ut*this.xScale)))}_convertToYCellCoord(ut){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(ut*this.yScale)))}_circlesCollide(ut,pt,wt,Tt,St,It){const Lt=Tt-ut,Xt=St-pt,Yt=wt+It;return Yt*Yt>Lt*Lt+Xt*Xt}_circleAndRectCollide(ut,pt,wt,Tt,St,It,Lt){const Xt=(It-Tt)/2,Yt=Math.abs(ut-(Tt+Xt));if(Yt>Xt+wt)return!1;const Mi=(Lt-St)/2,vr=Math.abs(pt-(St+Mi));if(vr>Mi+wt)return!1;if(Yt<=Xt||vr<=Mi)return!0;const br=Yt-Xt,Ar=vr-Mi;return br*br+Ar*Ar<=wt*wt}}const xc=100;class ea{constructor(ut,pt,wt=new Qr(ut.width+200,ut.height+200,25),Tt=new Qr(ut.width+200,ut.height+200,25)){this.transform=ut,this.grid=wt,this.ignoredGrid=Tt,this.pitchfactor=Math.cos(ut._pitch)*ut.cameraToCenterDistance,this.screenRightBoundary=ut.width+xc,this.screenBottomBoundary=ut.height+xc,this.gridRightBoundary=ut.width+200,this.gridBottomBoundary=ut.height+200,this.fogState=pt}placeCollisionBox(ut,pt,wt,Tt,St,It,Lt,Xt){let Yt=wt.projectedAnchorX,Mi=wt.projectedAnchorY,vr=wt.projectedAnchorZ;const br=wt.elevation,Ar=wt.tileID,Vr=ut.getProjection();if(br&&Ar){const[ut,pt,Tt]=Vr.upVector(Ar.canonical,wt.tileAnchorX,wt.tileAnchorY),St=Vr.upVectorScale(Ar.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;Yt+=ut*br*St,Mi+=pt*br*St,vr+=Tt*br*St}const nn=this.projectAndGetPerspectiveRatio(Lt,Yt,Mi,vr,wt.tileID,"globe"===Vr.name||!!br||this.transform.pitch>0,Vr),sn=It*nn.perspectiveRatio,an=(wt.x1*pt+Tt.x-wt.padding)*sn+nn.point.x,ln=(wt.y1*pt+Tt.y-wt.padding)*sn+nn.point.y,cn=(wt.x2*pt+Tt.x+wt.padding)*sn+nn.point.x,un=(wt.y2*pt+Tt.y+wt.padding)*sn+nn.point.y,fn=nn.perspectiveRatio<=.55||nn.occluded;return!this.isInsideGrid(an,ln,cn,un)||!St&&this.grid.hitTest(an,ln,cn,un,Xt)||fn?{box:[],offscreen:!1,occluded:nn.occluded}:{box:[an,ln,cn,un],offscreen:this.isOffscreen(an,ln,cn,un),occluded:!1}}placeCollisionCircles(pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn){const an=[],ln=this.transform.elevation,cn=pt.getProjection(),un=ln?ln.getAtTileOffsetFunc(sn,this.transform.center.lat,this.transform.worldSize,cn):null,fn=new ut.P(Tt.tileAnchorX,Tt.tileAnchorY);let{x:_n,y:gn,z:yn}=cn.projectTilePoint(fn.x,fn.y,sn.canonical);if(un){const[ut,pt,wt]=un(fn);_n+=ut,gn+=pt,yn+=wt}const xn="globe"===cn.name,vn=this.projectAndGetPerspectiveRatio(Xt,_n,gn,yn,sn,xn||!!ln||this.transform.pitch>0,cn),{perspectiveRatio:bn}=vn,wn=(br?Lt/bn:Lt*bn)/ut.bN,Tn=ei(_n,gn,yn,Yt),En=vn.signedDistanceFromCamera>0?ri(wn,It,Tt.lineOffsetX*wn,Tt.lineOffsetY*wn,!1,Tn,fn,Tt,St,Yt,{},ln&&!br?un:null,br&&!!ln,cn,sn,br):null;let Mn=!1,Sn=!1,An=!0;if(En&&!vn.occluded){const pt=.5*Vr*bn+nn,Tt=new ut.P(-100,-100),St=new ut.P(this.screenRightBoundary,this.screenBottomBoundary),It=new Kr,{first:Lt,last:Xt}=En,Yt=Lt.path.length;let br=[];for(let ut=Yt-1;ut>=1;ut--)br.push(Lt.path[ut]);for(let ut=1;ut<Xt.path.length;ut++)br.push(Xt.path[ut]);const sn=2.5*pt;Mi&&(br=br.map((([ut,pt,wt],Tt)=>(un&&!xn&&(wt=un(Tt<Yt-1?Lt.tilePath[Yt-1-Tt]:Xt.tilePath[Tt-Yt+2])[2]),ei(ut,pt,wt,Mi)))),br.some((ut=>ut[3]<=0))&&(br=[]));let ln=[];if(br.length>0){let pt=1/0,wt=-1/0,It=1/0,Lt=-1/0;for(const ut of br)pt=Math.min(pt,ut[0]),It=Math.min(It,ut[1]),wt=Math.max(wt,ut[0]),Lt=Math.max(Lt,ut[1]);wt>=Tt.x&&pt<=St.x&&Lt>=Tt.y&&It<=St.y&&(ln=[br.map((pt=>new ut.P(pt[0],pt[1])))],(pt<Tt.x||wt>St.x||It<Tt.y||Lt>St.y)&&(ln=ut.cF(ln,Tt.x,Tt.y,St.x,St.y)))}for(const ut of ln){It.reset(ut,.25*pt);let Tt=0;Tt=It.length<=.5*pt?1:Math.ceil(It.paddedLength/sn)+1;for(let ut=0;ut<Tt;ut++){const St=ut/Math.max(Tt-1,1),Lt=It.lerp(St),Xt=Lt.x+xc,Yt=Lt.y+xc;an.push(Xt,Yt,pt,0);const Mi=Xt-pt,br=Yt-pt,Vr=Xt+pt,nn=Yt+pt;if(An=An&&this.isOffscreen(Mi,br,Vr,nn),Sn=Sn||this.isInsideGrid(Mi,br,Vr,nn),!wt&&this.grid.hitTestCircle(Xt,Yt,pt,Ar)&&(Mn=!0,!vr))return{circles:[],offscreen:!1,collisionDetected:Mn,occluded:!1}}}}return{circles:!vr&&Mn||!Sn?[]:an,offscreen:An,collisionDetected:Mn,occluded:vn.occluded}}queryRenderedSymbols(pt){if(0===pt.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const wt=[];let Tt=1/0,St=1/0,It=-1/0,Lt=-1/0;for(const Xt of pt){const pt=new ut.P(Xt.x+xc,Xt.y+xc);Tt=Math.min(Tt,pt.x),St=Math.min(St,pt.y),It=Math.max(It,pt.x),Lt=Math.max(Lt,pt.y),wt.push(pt)}const Xt=this.grid.query(Tt,St,It,Lt).concat(this.ignoredGrid.query(Tt,St,It,Lt)),Yt={},Mi={};for(const pt of Xt){const Tt=pt.key;if(void 0===Yt[Tt.bucketInstanceId]&&(Yt[Tt.bucketInstanceId]={}),Yt[Tt.bucketInstanceId][Tt.featureIndex])continue;const St=[new ut.P(pt.x1,pt.y1),new ut.P(pt.x2,pt.y1),new ut.P(pt.x2,pt.y2),new ut.P(pt.x1,pt.y2)];ut.cG(wt,St)&&(Yt[Tt.bucketInstanceId][Tt.featureIndex]=!0,void 0===Mi[Tt.bucketInstanceId]&&(Mi[Tt.bucketInstanceId]=[]),Mi[Tt.bucketInstanceId].push(Tt.featureIndex))}return Mi}insertCollisionBox(ut,pt,wt,Tt,St){(pt?this.ignoredGrid:this.grid).insert({bucketInstanceId:wt,featureIndex:Tt,collisionGroupID:St},ut[0],ut[1],ut[2],ut[3])}insertCollisionCircles(ut,pt,wt,Tt,St){const It=pt?this.ignoredGrid:this.grid,Lt={bucketInstanceId:wt,featureIndex:Tt,collisionGroupID:St};for(let pt=0;pt<ut.length;pt+=4)It.insertCircle(Lt,ut[pt],ut[pt+1],ut[pt+2])}projectAndGetPerspectiveRatio(pt,wt,Tt,St,It,Lt,Xt){const Yt=[wt,Tt,St,1];let Mi=!1;if(St||this.transform.pitch>0){if(ut.aA.transformMat4(Yt,Yt,pt),this.fogState&&It&&"globe"!==Xt.name){const pt=function(pt,wt,Tt,St,It,Lt){const Xt=Lt.calculateFogTileMatrix(It),Yt=[wt,Tt,St];return ut._.transformMat4(Yt,Yt,Xt),ot(pt,ut._.length(Yt),Lt.pitch,Lt._fov)}(this.fogState,wt,Tt,St,It.toUnwrapped(),this.transform);Mi=pt>.9}}else ui(Yt,Yt,pt);const vr=Yt[3];return{point:new ut.P((Yt[0]/vr+1)/2*this.transform.width+xc,(-Yt[1]/vr+1)/2*this.transform.height+xc),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(Xt)/vr*.5,1.5),signedDistanceFromCamera:vr,occluded:Lt&&Yt[2]>vr||Mi}}isOffscreen(ut,pt,wt,Tt){return wt<xc||ut>=this.screenRightBoundary||Tt<xc||pt>this.screenBottomBoundary}isInsideGrid(ut,pt,wt,Tt){return wt>=0&&ut<this.gridRightBoundary&&Tt>=0&&pt<this.gridBottomBoundary}getViewportMatrix(){const pt=ut.ad.identity([]);return ut.ad.translate(pt,pt,[-100,-100,0]),pt}}class ta{constructor(ut,pt,wt,Tt){this.opacity=ut?Math.max(0,Math.min(1,ut.opacity+(ut.placed?pt:-pt))):Tt&&wt?1:0,this.placed=wt}isHidden(){return 0===this.opacity&&!this.placed}}class ia{constructor(ut,pt,wt,Tt,St,It=!1){this.text=new ta(ut?ut.text:null,pt,wt,St),this.icon=new ta(ut?ut.icon:null,pt,Tt,St),this.clipped=It}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class oa{constructor(ut,pt,wt,Tt=!1){this.text=ut,this.icon=pt,this.skipFade=wt,this.clipped=Tt}}class ra{constructor(){this.invProjMatrix=ut.ad.create(),this.viewportMatrix=ut.ad.create(),this.circles=[]}}class aa{constructor(ut,pt,wt,Tt,St){this.bucketInstanceId=ut,this.featureIndex=pt,this.sourceLayerIndex=wt,this.bucketIndex=Tt,this.tileID=St}}class sa{constructor(ut){this.crossSourceCollisions=ut,this.maxGroupID=0,this.collisionGroups={}}get(ut){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[ut]){const pt=++this.maxGroupID;this.collisionGroups[ut]={ID:pt,predicate:ut=>ut.collisionGroupID===pt}}return this.collisionGroups[ut]}}function na(pt,wt,Tt,St,It){const{horizontalAlign:Lt,verticalAlign:Xt}=ut.bQ(pt),Yt=-(Lt-.5)*wt,Mi=-(Xt-.5)*Tt,vr=ut.bP(pt,St);return new ut.P(Yt+vr[0]*It,Mi+vr[1]*It)}function la(pt,wt,Tt,St,It){const Lt=new ut.P(pt,wt);return Tt&&Lt._rotate(St?It:-It),Lt}class ca{constructor(ut,pt,wt,Tt,St,It){this.transform=ut.clone(),this.projection=ut.projection.name,this.collisionIndex=new ea(this.transform,St),this.buildingIndex=It,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=pt,this.retainedQueryData={},this.collisionGroups=new sa(wt),this.collisionCircleArrays={},this.prevPlacement=Tt,Tt&&(Tt.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(pt,wt,Tt,St){const It=Tt.getBucket(wt),Lt=Tt.latestFeatureIndex;if(!It||!Lt||wt.fqid!==It.layerIds[0])return;const Xt=It.layers[0].layout,Yt=Tt.collisionBoxArray,Mi=Math.pow(2,this.transform.zoom-Tt.tileID.overscaledZ),vr=Tt.tileSize/ut.a3,br=Tt.tileID.toUnwrapped();this.transform.setProjection(It.projection);const Ar=(Vr=Tt.tileID,nn=It.getProjection(),sn=this.transform,nn.name===this.projection?sn.calculateProjMatrix(Vr.toUnwrapped()):wo(sn,nn,Vr));var Vr,nn,sn;const an="map"===Xt.get("text-pitch-alignment"),ln="map"===Xt.get("text-rotation-alignment");wt.compileFilter();const cn=wt.dynamicFilter(),un=wt.dynamicFilterNeedsFeature(),fn=this.transform.calculatePixelsToTileUnitsMatrix(Tt),_n=Qt(Ar,Tt.tileID.canonical,an,ln,this.transform,It.getProjection(),fn);let gn=null;if(an){const pt=Jt(Ar,Tt.tileID.canonical,an,ln,this.transform,It.getProjection(),fn);gn=ut.ad.multiply([],this.transform.labelPlaneMatrix,pt)}let yn=null;cn&&Tt.latestFeatureIndex&&(yn={unwrappedTileID:br,dynamicFilter:cn,dynamicFilterNeedsFeature:un,featureIndex:Tt.latestFeatureIndex}),this.retainedQueryData[It.bucketInstanceId]=new aa(It.bucketInstanceId,Lt,It.sourceLayerIndex,It.index,Tt.tileID);const xn={bucket:It,layout:Xt,posMatrix:Ar,textLabelPlaneMatrix:_n,labelToScreenMatrix:gn,clippingData:yn,scale:Mi,textPixelRatio:vr,holdingForFade:Tt.holdingForFade(),collisionBoxArray:Yt,partiallyEvaluatedTextSize:ut.aD(It.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:ut.aD(It.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(It.sourceID)};if(St)for(const ut of It.sortKeyRanges){const{sortKey:wt,symbolInstanceStart:Tt,symbolInstanceEnd:St}=ut;pt.push({sortKey:wt,symbolInstanceStart:Tt,symbolInstanceEnd:St,parameters:xn})}else pt.push({symbolInstanceStart:0,symbolInstanceEnd:It.symbolInstances.length,parameters:xn})}attemptAnchorPlacement(ut,pt,wt,Tt,St,It,Lt,Xt,Yt,Mi,vr,br,Ar,Vr,nn,sn,an,ln){const{textOffset0:cn,textOffset1:un,crossTileID:fn}=br,_n=[cn,un],gn=na(ut,wt,Tt,_n,St),yn=this.collisionIndex.placeCollisionBox(Vr,St,pt,la(gn.x,gn.y,It,Lt,this.transform.angle),vr,Xt,Yt,Mi.predicate);if(sn){const ut=Vr.getSymbolInstanceIconSize(ln,this.transform.zoom,br.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(Vr,ut,sn,la(gn.x,gn.y,It,Lt,this.transform.angle),vr,Xt,Yt,Mi.predicate).box.length)return}if(yn.box.length>0){let pt;return this.prevPlacement&&this.prevPlacement.variableOffsets[fn]&&this.prevPlacement.placements[fn]&&this.prevPlacement.placements[fn].text&&(pt=this.prevPlacement.variableOffsets[fn].anchor),this.variableOffsets[fn]={textOffset:_n,width:wt,height:Tt,anchor:ut,textScale:St,prevAnchor:pt},this.markUsedJustification(Vr,ut,br,nn),Vr.allowVerticalPlacement&&(this.markUsedOrientation(Vr,nn,br),this.placedOrientations[fn]=nn),{shift:gn,placedGlyphBoxes:yn}}}placeLayerBucketPart(pt,wt,Tt,St){const{bucket:It,layout:Lt,posMatrix:Xt,textLabelPlaneMatrix:Yt,labelToScreenMatrix:Mi,clippingData:vr,textPixelRatio:br,holdingForFade:Ar,collisionBoxArray:Vr,partiallyEvaluatedTextSize:nn,partiallyEvaluatedIconSize:sn,collisionGroup:an}=pt.parameters,ln=Lt.get("text-optional"),cn=Lt.get("icon-optional"),un=Lt.get("text-allow-overlap"),fn=Lt.get("icon-allow-overlap"),_n="map"===Lt.get("text-rotation-alignment"),gn="map"===Lt.get("text-pitch-alignment"),yn="viewport-y"===Lt.get("symbol-z-order"),xn=Lt.get("symbol-z-elevate");this.transform.setProjection(It.projection);let vn=un&&(fn||!It.hasIconData()||cn),bn=fn&&(un||!It.hasTextData()||ln);!It.collisionArrays&&Vr&&It.deserializeCollisionBoxes(Vr),Tt&&St&&It.updateCollisionDebugBuffers(this.transform.zoom,Vr);const I=(pt,St,Vr)=>{const{crossTileID:yn,numVerticalGlyphVertices:xn}=pt;if(vr){const Tt={zoom:this.transform.zoom,pitch:this.transform.pitch};let St=null;if(vr.dynamicFilterNeedsFeature){const ut=this.retainedQueryData[It.bucketInstanceId];St=vr.featureIndex.loadFeature({featureIndex:pt.featureIndex,bucketIndex:ut.bucketIndex,sourceLayerIndex:ut.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,vr.dynamicFilter)(Tt,St,this.retainedQueryData[It.bucketInstanceId].tileID.canonical,new ut.P(pt.tileAnchorX,pt.tileAnchorY),this.transform.calculateDistanceTileData(vr.unwrappedTileID)))return this.placements[yn]=new oa(!1,!1,!1,!0),void wt.add(yn)}if(wt.has(yn))return;if(Ar)return void(this.placements[yn]=new oa(!1,!1,!1));let wn=!1,Tn=!1,En=!0,Mn=!1,Sn=!1,An=null,In={box:null,offscreen:null,occluded:null},Pn={box:null,offscreen:null,occluded:null},zn=null,Ln=null,kn=null,Bn=0,Wn=0,Yn=0;Vr.textFeatureIndex?Bn=Vr.textFeatureIndex:pt.useRuntimeCollisionCircles&&(Bn=pt.featureIndex),Vr.verticalTextFeatureIndex&&(Wn=Vr.verticalTextFeatureIndex);const G=ut=>{ut.tileID=this.retainedQueryData[It.bucketInstanceId].tileID;const wt=this.transform.elevation;ut.elevation=pt.zOffset+(wt?wt.getAtTileOffset(ut.tileID,ut.tileAnchorX,ut.tileAnchorY):0)},Jn=Vr.textBox;if(Jn){G(Jn);const i=wt=>{let Tt=ut.aE.horizontal;if(It.allowVerticalPlacement&&!wt&&this.prevPlacement){const ut=this.prevPlacement.placedOrientations[yn];ut&&(this.placedOrientations[yn]=ut,Tt=ut,this.markUsedOrientation(It,Tt,pt))}return Tt},o=(pt,wt)=>{if(It.allowVerticalPlacement&&xn>0&&Vr.verticalTextBox){for(const Tt of It.writingModes)if(Tt===ut.aE.vertical?(In=wt(),Pn=In):In=pt(),In&&In.box&&In.box.length)break}else In=pt()};if(Lt.get("text-variable-anchor")){let wt=Lt.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[yn]){const ut=this.prevPlacement.variableOffsets[yn];wt.indexOf(ut.anchor)>0&&(wt=wt.filter((pt=>pt!==ut.anchor)),wt.unshift(ut.anchor))}const c=(ut,Tt,Lt)=>{const Yt=It.getSymbolInstanceTextSize(nn,pt,this.transform.zoom,St),Mi=(ut.x2-ut.x1)*Yt+2*ut.padding,vr=(ut.y2-ut.y1)*Yt+2*ut.padding,Ar=pt.hasIconTextFit&&!fn?Tt:null;Ar&&G(Ar);let Vr={box:[],offscreen:!1,occluded:!1};const ln=un?2*wt.length:wt.length;for(let Tt=0;Tt<ln;++Tt){const ln=this.attemptAnchorPlacement(wt[Tt%wt.length],ut,Mi,vr,Yt,_n,gn,br,Xt,an,Tt>=wt.length,pt,St,It,Lt,Ar,nn,sn);if(ln&&(Vr=ln.placedGlyphBoxes,Vr&&Vr.box&&Vr.box.length)){wn=!0,An=ln.shift;break}}return Vr};o((()=>c(Jn,Vr.iconBox,ut.aE.horizontal)),(()=>{const pt=Vr.verticalTextBox;return pt&&G(pt),It.allowVerticalPlacement&&!(In&&In.box&&In.box.length)&&xn>0&&pt?c(pt,Vr.verticalIconBox,ut.aE.vertical):{box:null,offscreen:null,occluded:null}})),In&&(wn=In.box,En=In.offscreen,Mn=In.occluded);const Tt=i(!(!In||!In.box));if(!wn&&this.prevPlacement){const ut=this.prevPlacement.variableOffsets[yn];ut&&(this.variableOffsets[yn]=ut,this.markUsedJustification(It,ut.anchor,pt,Tt))}}else{const s=(wt,Tt)=>{const Lt=It.getSymbolInstanceTextSize(nn,pt,this.transform.zoom,St),Yt=this.collisionIndex.placeCollisionBox(It,Lt,wt,new ut.P(0,0),un,br,Xt,an.predicate);return Yt&&Yt.box&&Yt.box.length&&(this.markUsedOrientation(It,Tt,pt),this.placedOrientations[yn]=Tt),Yt};o((()=>s(Jn,ut.aE.horizontal)),(()=>{const pt=Vr.verticalTextBox;return It.allowVerticalPlacement&&xn>0&&pt?(G(pt),s(pt,ut.aE.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(In&&In.box&&In.box.length))}}if(zn=In,wn=zn&&zn.box&&zn.box.length>0,En=zn&&zn.offscreen,Mn=zn&&zn.occluded,pt.useRuntimeCollisionCircles){const wt=It.text.placedSymbolArray.get(pt.centerJustifiedTextSymbolIndex>=0?pt.centerJustifiedTextSymbolIndex:pt.verticalPlacedTextSymbolIndex),St=ut.aF(It.textSizeData,nn,wt),vr=Lt.get("text-padding");Ln=this.collisionIndex.placeCollisionCircles(It,un,wt,It.lineVertexArray,It.glyphOffsetArray,St,Xt,Yt,Mi,Tt,gn,an.predicate,pt.collisionCircleDiameter*St/ut.bN,vr,this.retainedQueryData[It.bucketInstanceId].tileID),wn=un||Ln.circles.length>0&&!Ln.collisionDetected,En=En&&Ln.offscreen,Mn=Ln.occluded}if(Vr.iconFeatureIndex&&(Yn=Vr.iconFeatureIndex),Vr.iconBox){const i=wt=>{G(wt);const Tt=pt.hasIconTextFit&&An?la(An.x,An.y,_n,gn,this.transform.angle):new ut.P(0,0),St=It.getSymbolInstanceIconSize(sn,this.transform.zoom,pt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(It,St,wt,Tt,fn,br,Xt,an.predicate)};Pn&&Pn.box&&Pn.box.length&&Vr.verticalIconBox?(kn=i(Vr.verticalIconBox),Tn=kn.box.length>0):(kn=i(Vr.iconBox),Tn=kn.box.length>0),En=En&&kn.offscreen,Sn=kn.occluded}const Qn=ln||0===pt.numHorizontalGlyphVertices&&0===xn,bo=cn||0===pt.numIconVertices;if(Qn||bo?bo?Qn||(Tn=Tn&&wn):wn=Tn&&wn:Tn=wn=Tn&&wn,wn&&zn&&zn.box&&this.collisionIndex.insertCollisionBox(zn.box,Lt.get("text-ignore-placement"),It.bucketInstanceId,Pn&&Pn.box&&Wn?Wn:Bn,an.ID),Tn&&kn&&this.collisionIndex.insertCollisionBox(kn.box,Lt.get("icon-ignore-placement"),It.bucketInstanceId,Yn,an.ID),Ln&&(wn&&this.collisionIndex.insertCollisionCircles(Ln.circles,Lt.get("text-ignore-placement"),It.bucketInstanceId,Bn,an.ID),Tt)){const ut=It.bucketInstanceId;let pt=this.collisionCircleArrays[ut];void 0===pt&&(pt=this.collisionCircleArrays[ut]=new ra);for(let ut=0;ut<Ln.circles.length;ut+=4)pt.circles.push(Ln.circles[ut+0]),pt.circles.push(Ln.circles[ut+1]),pt.circles.push(Ln.circles[ut+2]),pt.circles.push(Ln.collisionDetected?1:0)}const ko="globe"!==It.projection.name;vn=vn&&(ko||!Mn),bn=bn&&(ko||!Sn),this.placements[yn]=new oa(wn||vn,Tn||bn,En||It.justReloaded),wt.add(yn)};if(xn&&this.buildingIndex&&(this.buildingIndex.updateZOffset(It,this.retainedQueryData[It.bucketInstanceId].tileID),It.updateZOffset()),yn){const pt=It.getSortedSymbolIndexes(this.transform.angle);for(let ut=pt.length-1;ut>=0;--ut){const wt=pt[ut];I(It.symbolInstances.get(wt),wt,It.collisionArrays[wt])}It.hasAnyZOffset&&ut.w(`${It.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(It.hasAnyZOffset){const ut=It.getSortedIndexesByZOffset();for(let pt=0;pt<ut.length;++pt){const wt=ut[pt];I(It.symbolInstances.get(wt),wt,It.collisionArrays[wt])}}else for(let ut=pt.symbolInstanceStart;ut<pt.symbolInstanceEnd;ut++)I(It.symbolInstances.get(ut),ut,It.collisionArrays[ut]);if(Tt&&It.bucketInstanceId in this.collisionCircleArrays){const pt=this.collisionCircleArrays[It.bucketInstanceId];ut.ad.invert(pt.invProjMatrix,Xt),pt.viewportMatrix=this.collisionIndex.getViewportMatrix()}It.justReloaded=!1}markUsedJustification(pt,wt,Tt,St){const{leftJustifiedTextSymbolIndex:It,centerJustifiedTextSymbolIndex:Lt,rightJustifiedTextSymbolIndex:Xt,verticalPlacedTextSymbolIndex:Yt,crossTileID:Mi}=Tt,vr=ut.cJ(wt),br=St===ut.aE.vertical?Yt:"left"===vr?It:"center"===vr?Lt:"right"===vr?Xt:-1;It>=0&&(pt.text.placedSymbolArray.get(It).crossTileID=br>=0&&It!==br?0:Mi),Lt>=0&&(pt.text.placedSymbolArray.get(Lt).crossTileID=br>=0&&Lt!==br?0:Mi),Xt>=0&&(pt.text.placedSymbolArray.get(Xt).crossTileID=br>=0&&Xt!==br?0:Mi),Yt>=0&&(pt.text.placedSymbolArray.get(Yt).crossTileID=br>=0&&Yt!==br?0:Mi)}markUsedOrientation(pt,wt,Tt){const St=wt===ut.aE.horizontal||wt===ut.aE.horizontalOnly?wt:0,It=wt===ut.aE.vertical?wt:0,{leftJustifiedTextSymbolIndex:Lt,centerJustifiedTextSymbolIndex:Xt,rightJustifiedTextSymbolIndex:Yt,verticalPlacedTextSymbolIndex:Mi}=Tt,vr=pt.text.placedSymbolArray;Lt>=0&&(vr.get(Lt).placedOrientation=St),Xt>=0&&(vr.get(Xt).placedOrientation=St),Yt>=0&&(vr.get(Yt).placedOrientation=St),Mi>=0&&(vr.get(Mi).placedOrientation=It)}commit(ut){this.commitTime=ut,this.zoomAtLastRecencyCheck=this.transform.zoom;const pt=this.prevPlacement;let wt=!1;this.prevZoomAdjustment=pt?pt.zoomAdjustment(this.transform.zoom):0;const Tt=pt?pt.symbolFadeChange(ut):1,St=pt?pt.opacities:{},It=pt?pt.variableOffsets:{},Lt=pt?pt.placedOrientations:{};for(const ut in this.placements){const pt=this.placements[ut],It=St[ut];It?(this.opacities[ut]=new ia(It,Tt,pt.text,pt.icon,null,pt.clipped),wt=wt||pt.text!==It.text.placed||pt.icon!==It.icon.placed):(this.opacities[ut]=new ia(null,Tt,pt.text,pt.icon,pt.skipFade,pt.clipped),wt=wt||pt.text||pt.icon)}for(const ut in St){const pt=St[ut];if(!this.opacities[ut]){const St=new ia(pt,Tt,!1,!1);St.isHidden()||(this.opacities[ut]=St,wt=wt||pt.text.placed||pt.icon.placed)}}for(const ut in It)this.variableOffsets[ut]||!this.opacities[ut]||this.opacities[ut].isHidden()||(this.variableOffsets[ut]=It[ut]);for(const ut in Lt)this.placedOrientations[ut]||!this.opacities[ut]||this.opacities[ut].isHidden()||(this.placedOrientations[ut]=Lt[ut]);wt?this.lastPlacementChangeTime=ut:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=pt?pt.lastPlacementChangeTime:ut)}updateLayerOpacities(ut,pt,wt,Tt){const St=new Set;for(const It of pt){const pt=It.getBucket(ut);pt&&It.latestFeatureIndex&&ut.fqid===pt.layerIds[0]&&(this.updateBucketOpacities(pt,St,It.collisionBoxArray,wt,Tt,It.tileID),pt.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(pt,It.tileID),pt.updateZOffset()))}}updateBucketOpacities(pt,wt,Tt,St,It,Lt){pt.hasTextData()&&pt.text.opacityVertexArray.clear(),pt.hasIconData()&&pt.icon.opacityVertexArray.clear(),pt.hasIconCollisionBoxData()&&pt.iconCollisionBox.collisionVertexArray.clear(),pt.hasTextCollisionBoxData()&&pt.textCollisionBox.collisionVertexArray.clear();const Xt=pt.layers[0].layout,Yt=!!pt.layers[0].dynamicFilter(),Mi=new ia(null,0,!1,!1,!0),vr=Xt.get("text-allow-overlap"),br=Xt.get("icon-allow-overlap"),Ar=Xt.get("text-variable-anchor"),Vr="map"===Xt.get("text-rotation-alignment"),nn="map"===Xt.get("text-pitch-alignment"),sn=new ia(null,0,vr&&(br||!pt.hasIconData()||Xt.get("icon-optional")),br&&(vr||!pt.hasTextData()||Xt.get("text-optional")),!0);!pt.collisionArrays&&Tt&&(pt.hasIconCollisionBoxData()||pt.hasTextCollisionBoxData())&&pt.deserializeCollisionBoxes(Tt);const m=(ut,pt,wt)=>{for(let Tt=0;Tt<pt/4;Tt++)ut.opacityVertexArray.emplaceBack(wt)};let an=0;It&&pt.updateReplacement(Lt,It);for(let Tt=0;Tt<pt.symbolInstances.length;Tt++){const Xt=pt.symbolInstances.get(Tt),{numHorizontalGlyphVertices:vr,numVerticalGlyphVertices:br,crossTileID:ln,numIconVertices:cn,tileAnchorX:un,tileAnchorY:fn}=Xt,_n=wt.has(ln);let gn=this.opacities[ln];_n?gn=Mi:gn||(gn=sn,this.opacities[ln]=gn),wt.add(ln);const yn=vr>0||br>0,xn=cn>0,vn=this.placedOrientations[ln],bn=vn===ut.aE.vertical,wn=vn===ut.aE.horizontal||vn===ut.aE.horizontalOnly;!yn&&!xn||gn.isHidden()||an++;let Tn=!1;if((yn||xn)&&It)for(const wt of pt.activeReplacements){if(wt.order<St||wt.order===1/0||!(wt.clipMask&ut.cu.Symbol))continue;if(wt.min.x>un||un>wt.max.x||wt.min.y>fn||fn>wt.max.y)continue;const pt=ut.cH(un,fn,Lt.canonical,wt.footprintTileId.canonical);if(Tn=ut.cI(pt,wt),Tn)break}if(yn){const ut=Tn?Tu:va(gn.text);m(pt.text,vr,bn?Tu:ut),m(pt.text,br,wn?Tu:ut);const wt=gn.text.isHidden(),{leftJustifiedTextSymbolIndex:Tt,centerJustifiedTextSymbolIndex:St,rightJustifiedTextSymbolIndex:It,verticalPlacedTextSymbolIndex:Lt}=Xt,Yt=pt.text.placedSymbolArray,Mi=wt||bn?1:0;Tt>=0&&(Yt.get(Tt).hidden=Mi),St>=0&&(Yt.get(St).hidden=Mi),It>=0&&(Yt.get(It).hidden=Mi),Lt>=0&&(Yt.get(Lt).hidden=wt||wn?1:0);const Ar=this.variableOffsets[ln];Ar&&this.markUsedJustification(pt,Ar.anchor,Xt,vn);const Vr=this.placedOrientations[ln];Vr&&(this.markUsedJustification(pt,"left",Xt,Vr),this.markUsedOrientation(pt,Vr,Xt))}if(xn){const ut=Tn?Tu:va(gn.icon),{placedIconSymbolIndex:wt,verticalPlacedIconSymbolIndex:Tt}=Xt,St=pt.icon.placedSymbolArray,It=gn.icon.isHidden()?1:0;wt>=0&&(m(pt.icon,cn,bn?Tu:ut),St.get(wt).hidden=It),Tt>=0&&(m(pt.icon,Xt.numVerticalIconVertices,wn?Tu:ut),St.get(Tt).hidden=It)}if(pt.hasIconCollisionBoxData()||pt.hasTextCollisionBoxData()){const wt=pt.collisionArrays[Tt];if(wt){let Tt=new ut.P(0,0),St=!0;if(wt.textBox||wt.verticalTextBox){if(Ar){const ut=this.variableOffsets[ln];ut?(Tt=na(ut.anchor,ut.width,ut.height,ut.textOffset,ut.textScale),Vr&&Tt._rotate(nn?this.transform.angle:-this.transform.angle)):St=!1}Yt&&(St=!gn.clipped),wt.textBox&&ha(pt.textCollisionBox.collisionVertexArray,gn.text.placed,!St||bn,Tt.x,Tt.y),wt.verticalTextBox&&ha(pt.textCollisionBox.collisionVertexArray,gn.text.placed,!St||wn,Tt.x,Tt.y)}const It=St&&Boolean(!wn&&wt.verticalIconBox);wt.iconBox&&ha(pt.iconCollisionBox.collisionVertexArray,gn.icon.placed,It,Xt.hasIconTextFit?Tt.x:0,Xt.hasIconTextFit?Tt.y:0),wt.verticalIconBox&&ha(pt.iconCollisionBox.collisionVertexArray,gn.icon.placed,!It,Xt.hasIconTextFit?Tt.x:0,Xt.hasIconTextFit?Tt.y:0)}}}if(pt.fullyClipped=0===an,pt.sortFeatures(this.transform.angle),this.retainedQueryData[pt.bucketInstanceId]&&(this.retainedQueryData[pt.bucketInstanceId].featureSortOrder=pt.featureSortOrder),pt.hasTextData()&&pt.text.opacityVertexBuffer&&pt.text.opacityVertexBuffer.updateData(pt.text.opacityVertexArray),pt.hasIconData()&&pt.icon.opacityVertexBuffer&&pt.icon.opacityVertexBuffer.updateData(pt.icon.opacityVertexArray),pt.hasIconCollisionBoxData()&&pt.iconCollisionBox.collisionVertexBuffer&&pt.iconCollisionBox.collisionVertexBuffer.updateData(pt.iconCollisionBox.collisionVertexArray),pt.hasTextCollisionBoxData()&&pt.textCollisionBox.collisionVertexBuffer&&pt.textCollisionBox.collisionVertexBuffer.updateData(pt.textCollisionBox.collisionVertexArray),pt.bucketInstanceId in this.collisionCircleArrays){const ut=this.collisionCircleArrays[pt.bucketInstanceId];pt.placementInvProjMatrix=ut.invProjMatrix,pt.placementViewportMatrix=ut.viewportMatrix,pt.collisionCircleArray=ut.circles,delete this.collisionCircleArrays[pt.bucketInstanceId]}}symbolFadeChange(ut){return 0===this.fadeDuration?1:(ut-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(ut){return Math.max(0,(this.transform.zoom-ut)/1.5)}hasTransitions(ut){return this.stale||ut-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(ut,pt){const wt=this.zoomAtLastRecencyCheck===pt?1-this.zoomAdjustment(pt):1;return this.zoomAtLastRecencyCheck=pt,this.commitTime+this.fadeDuration*wt>ut}setStale(){this.stale=!0}}function ha(ut,pt,wt,Tt,St){ut.emplaceBack(pt?1:0,wt?1:0,Tt||0,St||0),ut.emplaceBack(pt?1:0,wt?1:0,Tt||0,St||0),ut.emplaceBack(pt?1:0,wt?1:0,Tt||0,St||0),ut.emplaceBack(pt?1:0,wt?1:0,Tt||0,St||0)}const Mc=Math.pow(2,25),Sc=Math.pow(2,24),Ac=Math.pow(2,17),Dc=Math.pow(2,16),qc=Math.pow(2,9),$c=Math.pow(2,8),wu=Math.pow(2,1);function va(ut){if(0===ut.opacity&&!ut.placed)return 0;if(1===ut.opacity&&ut.placed)return 4294967295;const pt=ut.placed?1:0,wt=Math.floor(127*ut.opacity);return wt*Mc+pt*Sc+wt*Ac+pt*Dc+wt*qc+pt*$c+wt*wu+pt}const Tu=0;class ya{constructor(ut){this._sortAcrossTiles="viewport-y"!==ut.layout.get("symbol-z-order")&&void 0!==ut.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(ut,pt,wt,Tt,St){const It=this._bucketParts;for(;this._currentTileIndex<ut.length;)if(pt.getBucketParts(It,Tt,ut[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,St())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,It.sort(((ut,pt)=>ut.sortKey-pt.sortKey)));this._currentPartIndex<It.length;){const ut=It[this._currentPartIndex];if(pt.placeLayerBucketPart(ut,this._seenCrossTileIDs,wt,0===ut.symbolInstanceStart),this._currentPartIndex++,St())return!0}return!1}}class ba{constructor(ut,pt,wt,Tt,St,It,Lt,Xt,Yt){this.placement=new ca(ut,St,It,Lt,Xt,Yt),this._currentPlacementIndex=pt.length-1,this._forceFullPlacement=wt,this._showCollisionBoxes=Tt,this._done=!1}isDone(){return this._done}continuePlacement(pt,wt,Tt,St){const It=ut.e.now(),s=()=>{const pt=ut.e.now()-It;return!this._forceFullPlacement&&pt>2};for(;this._currentPlacementIndex>=0;){const It=wt[pt[this._currentPlacementIndex]],Lt=this.placement.collisionIndex.transform.zoom;if("symbol"===It.type&&(!It.minzoom||It.minzoom<=Lt)&&(!It.maxzoom||It.maxzoom>Lt)){const pt=It,wt=pt.layout.get("symbol-z-elevate"),Lt=this._inProgressLayer=this._inProgressLayer||new ya(pt),Xt=ut.al(It.source,It.scope);if(Lt.continuePlacement(wt?St[Xt]:Tt[Xt],this.placement,this._showCollisionBoxes,It,s))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(ut){return this.placement.commit(ut),this.placement}}const Mu=512/ut.a3/2;class Ta{constructor(pt,wt,Tt){this.tileID=pt,this.bucketInstanceId=Tt,this.index=new ut.cK(wt.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const St=pt.canonical.x*ut.a3,It=pt.canonical.y*ut.a3;for(let ut=0;ut<wt.length;ut++){const{key:pt,crossTileID:Tt,tileAnchorX:Lt,tileAnchorY:Xt}=wt.get(ut),Yt=Math.floor((St+Lt)*Mu),Mi=Math.floor((It+Xt)*Mu);this.index.add(Yt,Mi),this.keys.push(pt),this.crossTileIDs.push(Tt)}this.index.finish()}findMatches(pt,wt,Tt){const St=this.tileID.canonical.z<wt.canonical.z?1:Math.pow(2,this.tileID.canonical.z-wt.canonical.z),It=Mu/Math.pow(2,wt.canonical.z-this.tileID.canonical.z),Lt=wt.canonical.x*ut.a3,Xt=wt.canonical.y*ut.a3;for(let ut=0;ut<pt.length;ut++){const wt=pt.get(ut);if(wt.crossTileID)continue;const{key:Yt,tileAnchorX:Mi,tileAnchorY:vr}=wt,br=Math.floor((Lt+Mi)*It),Ar=Math.floor((Xt+vr)*It),Vr=this.index.range(br-St,Ar-St,br+St,Ar+St);for(const ut of Vr){const pt=this.crossTileIDs[ut];if(this.keys[ut]===Yt&&!Tt.has(pt)){Tt.add(pt),wt.crossTileID=pt;break}}}}}class Ea{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Ca{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(ut){const pt=Math.round((ut-this.lng)/360);if(0!==pt)for(const ut in this.indexes){const wt=this.indexes[ut],Tt={};for(const ut in wt){const St=wt[ut];St.tileID=St.tileID.unwrapTo(St.tileID.wrap+pt),Tt[St.tileID.key]=St}this.indexes[ut]=Tt}this.lng=ut}addBucket(ut,pt,wt){if(this.indexes[ut.overscaledZ]&&this.indexes[ut.overscaledZ][ut.key]){if(this.indexes[ut.overscaledZ][ut.key].bucketInstanceId===pt.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(ut.overscaledZ,this.indexes[ut.overscaledZ][ut.key])}for(let ut=0;ut<pt.symbolInstances.length;ut++)pt.symbolInstances.get(ut).crossTileID=0;this.usedCrossTileIDs[ut.overscaledZ]||(this.usedCrossTileIDs[ut.overscaledZ]=new Set);const Tt=this.usedCrossTileIDs[ut.overscaledZ];for(const wt in this.indexes){const St=this.indexes[wt];if(Number(wt)>ut.overscaledZ)for(const wt in St){const It=St[wt];It.tileID.isChildOf(ut)&&It.findMatches(pt.symbolInstances,ut,Tt)}else{const It=St[ut.scaledTo(Number(wt)).key];It&&It.findMatches(pt.symbolInstances,ut,Tt)}}for(let ut=0;ut<pt.symbolInstances.length;ut++){const St=pt.symbolInstances.get(ut);St.crossTileID||(St.crossTileID=wt.generate(),Tt.add(St.crossTileID))}return void 0===this.indexes[ut.overscaledZ]&&(this.indexes[ut.overscaledZ]={}),this.indexes[ut.overscaledZ][ut.key]=new Ta(ut,pt.symbolInstances,pt.bucketInstanceId),!0}removeBucketCrossTileIDs(ut,pt){for(const wt of pt.crossTileIDs)this.usedCrossTileIDs[ut].delete(wt)}removeStaleBuckets(ut){let pt=!1;for(const wt in this.indexes){const Tt=this.indexes[wt];for(const St in Tt)ut[Tt[St].bucketInstanceId]||(this.removeBucketCrossTileIDs(wt,Tt[St]),delete Tt[St],pt=!0)}return pt}}class Sa{constructor(){this.layerIndexes={},this.crossTileIDs=new Ea,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(ut,pt,wt,Tt){let St=this.layerIndexes[ut.fqid];void 0===St&&(St=this.layerIndexes[ut.fqid]=new Ca);let It=!1;const Lt={};"globe"!==Tt.name&&St.handleWrapJump(wt);for(const wt of pt){const pt=wt.getBucket(ut);pt&&ut.fqid===pt.layerIds[0]&&(pt.bucketInstanceId||(pt.bucketInstanceId=++this.maxBucketInstanceId),St.addBucket(wt.tileID,pt,this.crossTileIDs)&&(It=!0),Lt[pt.bucketInstanceId]=!0)}return St.removeStaleBuckets(Lt)&&(It=!0),It}pruneUnusedLayers(ut){const pt={};ut.forEach((ut=>{pt[ut]=!0}));for(const ut in this.layerIndexes)pt[ut]||delete this.layerIndexes[ut]}}const Iu=new ut.N({data:new ut.O(ut.L.colorTheme.data)}),La=(ut,pt)=>Xe(ut,pt&&pt.filter((ut=>"source.canvas"!==ut.identifier))),Ou=ut.ah(gc,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),Nu=ut.ah(gc,["setCenter","setZoom","setBearing","setPitch"]),ju={version:8,layers:[],sources:{}},Ju={duration:300,delay:0};class Ma extends ut.E{constructor(pt,wt={}){super(),this.map=pt,this.scope=wt.scope||"",this.globalId=null,this.fragments=[],this.importDepth=wt.importDepth||0,this.importsCache=wt.importsCache||new Map,this.resolvedImports=wt.resolvedImports||new Set,this.transition=ut.W({},Ju),this._buildingIndex=new Ur(this),this.crossTileSymbolIndex=new Sa,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerIndices=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=wt.styleChanges||new v,this.dispatcher=wt.dispatcher?wt.dispatcher:new ut.bw(ut.bx(),this),wt.imageManager?this.imageManager=wt.imageManager:(this.imageManager=new ue,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=wt.glyphManager?wt.glyphManager:new ut.cM(pt._requestManager,wt.localFontFamily?ut.cN.all:wt.localIdeographFontFamily?ut.cN.ideographs:ut.cN.none,wt.localFontFamily||wt.localIdeographFontFamily),wt.modelManager?this.modelManager=wt.modelManager:(this.modelManager=new ce(pt._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this._styleColorTheme={lut:null,lutLoading:!1,colorTheme:null},this._styleColorThemeForScope={},this.options=wt.configOptions?wt.configOptions:new Map,this._configDependentLayers=wt.configDependentLayers?wt.configDependentLayers:new Set,this._config=wt.config,this._initialConfig=wt.initialConfig,this.dispatcher.broadcast("setReferrer",ut.cO());const Tt=this;this._rtlTextPluginCallback=Ma.registerForPluginStateChange((pt=>{Tt.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:pt.pluginStatus,pluginURL:pt.pluginURL},((pt,wt)=>{if(ut.cP(pt),wt&&wt.every((ut=>ut)))for(const ut in Tt._sourceCaches){const pt=Tt._sourceCaches[ut],wt=pt.getSource().type;"vector"!==wt&&"geojson"!==wt||pt.reload()}}))})),this.on("data",(ut=>{if("source"!==ut.dataType||"metadata"!==ut.sourceDataType)return;const pt=this.getOwnSource(ut.sourceId);if(pt&&pt.vectorLayerIds)for(const ut in this._layers){const wt=this._layers[ut];wt.source===pt.id&&this._validateLayer(wt)}}))}load(ut){return ut?("string"==typeof ut?this.loadURL(ut):this.loadJSON(ut),this):this}_getGlobalId(pt){if(!pt)return null;if("string"==typeof pt){if(ut.cQ(pt))return pt;const wt=ut.cR(pt);if(!wt.startsWith("http"))try{return new URL(wt,location.href).toString()}catch(ut){return wt}return wt}return`json://${ut.cS(JSON.stringify(pt))}`}_diffStyle(pt,wt,Tt){this.globalId=this._getGlobalId(pt);const r=(ut,pt)=>{try{pt(null,this.setState(ut,Tt))}catch(ut){pt(ut,!1)}};if("string"==typeof pt){const Tt=this.map._requestManager.normalizeStyleURL(pt),St=this.map._requestManager.transformRequest(Tt,ut.R.Style);ut.g(St,((pt,Tt)=>{pt?this.fire(new ut.d(pt)):Tt&&r(Tt,wt)}))}else"object"==typeof pt&&r(pt,wt)}loadURL(pt,wt={}){this.fire(new ut.f("dataloading",{dataType:"style"}));const Tt="boolean"==typeof wt.validate?wt.validate:!ut.cQ(pt);this.globalId=this._getGlobalId(pt),pt=this.map._requestManager.normalizeStyleURL(pt,wt.accessToken),this.resolvedImports.add(pt);const St=this.importsCache.get(pt);if(St)return this._load(St,Tt);const It=this.map._requestManager.transformRequest(pt,ut.R.Style);this._request=ut.g(It,((wt,St)=>{if(this._request=null,wt)this.fire(new ut.d(wt));else if(St)return this.importsCache.set(pt,St),this._load(St,Tt)}))}loadJSON(pt,wt={}){this.fire(new ut.f("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(pt),this._request=ut.e.frame((()=>{this._request=null,this._load(pt,!1!==wt.validate)}))}loadEmpty(){this.fire(new ut.f("dataloading",{dataType:"style"})),this._load(ju,!1)}_loadImports(pt,wt,Tt){if(this.importDepth>=4)return ut.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const St=[];for(const ut of pt){const pt=this._createFragmentStyle(ut),It=new Promise((ut=>{pt.once("style.import.load",ut),pt.once("error",ut)})).then((()=>this.mergeAll()));if(St.push(It),this.resolvedImports.has(ut.url)){pt.loadEmpty();continue}const Lt=ut.data||this.importsCache.get(ut.url);Lt?(pt.loadJSON(Lt,{validate:wt}),this._isInternalStyle(Lt)&&(pt.globalId=null)):ut.url?pt.loadURL(ut.url,{validate:wt}):pt.loadEmpty();const Xt={style:pt,id:ut.id,config:ut.config};if(Tt){const ut=this.fragments.findIndex((({id:ut})=>ut===Tt));this.fragments=this.fragments.slice(0,ut).concat(Xt).concat(this.fragments.slice(ut))}else this.fragments.push(Xt)}return Promise.allSettled(St)}getImportGlobalIds(ut=this,pt=new Set){for(const wt of ut.fragments)wt.style.globalId&&pt.add(wt.style.globalId),this.getImportGlobalIds(wt.style,pt);return[...pt.values()]}_createFragmentStyle(pt){const wt=this.scope?ut.al(pt.id,this.scope):pt.id;let Tt;const St=this._initialConfig&&this._initialConfig[wt];(pt.config||St)&&(Tt=ut.W({},pt.config,St));const It=new Ma(this.map,{scope:wt,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:Tt,configOptions:this.options,configDependentLayers:this._configDependentLayers});return It.setEventedParent(this.map,{style:It}),It}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.isRootStyle()}_isInternalStyle(ut){return this.isRootStyle()&&(ut.fragment||!!ut.schema&&!1!==ut.fragment)}_load(pt,wt){const Tt=pt.schema;if(this._isInternalStyle(pt)){const Tt=ut.W({},ju,{imports:[{id:"basemap",data:pt,url:""}]});return void this._load(Tt,wt)}if(this.updateConfig(this._config,Tt),wt&&La(this,Be(pt)))return;this._loaded=!0,this.stylesheet=ut.cT(pt);const r=()=>{for(const ut in pt.sources)this.addSource(ut,pt.sources[ut],{validate:!1,isInitialLoad:!0});pt.sprite?this._loadSprite(pt.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(pt.glyphs,this.scope);const Tt=jr(this.stylesheet.layers);if(this._order=Tt.map((ut=>ut.id)),this.stylesheet.light&&ut.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const ut=this.stylesheet.lights[0];this.light=new Ke(ut.properties,ut.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Ke(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const pt of Tt){const wt=ut.cY(pt,this.scope,this._styleColorTheme.lut,this.options);wt.isConfigDependent&&this._configDependentLayers.add(wt.fqid),wt.setEventedParent(this,{layer:{id:wt.id}}),this._layers[wt.id]=wt,this._serializedLayers[wt.id]=wt.serialize();const Tt=this.getOwnLayerSourceCache(wt),St=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Tt&&wt.canCastShadows()&&St&&(Tt.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const St=this.stylesheet.terrain;St&&(this.checkCanvasFingerprintNoise(),this.terrainSetForDrapingOnly()||this._createTerrain(St,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new ut.f("data",{dataType:"style"}));const It=this.isRootStyle();pt.imports?this._loadImports(pt.imports,wt).then((()=>{this._reloadImports(),this.fire(new ut.f(It?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new ut.f(It?"style.load":"style.import.load")))},St=this.stylesheet["color-theme"];if(this._styleColorTheme.colorTheme=St,St){const pt=this._evaluateColorThemeData(St);this._loadColorTheme(pt).then((()=>{r()})).catch((pt=>{ut.w(`Couldn't load color theme from the stylesheet: ${pt}`),r()}))}else this._styleColorTheme.lut=null,r()}isRootStyle(){return 0===this.importDepth}mergeAll(){let pt,wt,Tt,St,It,Lt,Xt,Yt;const Mi={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((ut=>{if(ut.stylesheet){if(null!=ut.light&&(pt=ut.light),ut.stylesheet.lights)for(const pt of ut.stylesheet.lights)"ambient"===pt.type&&null!=ut.ambientLight&&(wt=ut.ambientLight),"directional"===pt.type&&null!=ut.directionalLight&&(Tt=ut.directionalLight);St=this._prioritizeTerrain(St,ut.terrain,ut.stylesheet.terrain),ut.stylesheet.fog&&null!=ut.fog&&(It=ut.fog),null!=ut.stylesheet.camera&&(Yt=ut.stylesheet.camera),null!=ut.stylesheet.projection&&(Lt=ut.stylesheet.projection),null!=ut.stylesheet.transition&&(Xt=ut.stylesheet.transition),Mi[ut.scope]=ut._styleColorTheme}})),this.light=pt,this.ambientLight=wt,this.directionalLight=Tt,this.fog=It,this._styleColorThemeForScope=Mi,null===St?delete this.terrain:this.terrain=St,this.camera=Yt||{"camera-projection":"perspective"},this.projection=Lt||{name:"mercator"},this.transition=ut.W({},Ju,Xt),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(ut){const t=pt=>{for(const ut of pt.fragments)t(ut.style);ut(pt)};t(this)}_prioritizeTerrain(ut,pt,wt){const Tt=ut&&0===ut.drapeRenderMode;return null===wt?pt&&0===pt.drapeRenderMode?pt:Tt?ut:null:null!=pt&&(!ut||Tt||pt&&1===pt.drapeRenderMode)?pt:ut}mergeTerrain(){let ut;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((pt=>{ut=this._prioritizeTerrain(ut,pt.terrain,pt.stylesheet.terrain)})),null===ut?delete this.terrain:this.terrain=ut}mergeProjection(){let ut;this.forEachFragmentStyle((pt=>{null!=pt.stylesheet.projection&&(ut=pt.stylesheet.projection)})),this.projection=ut||{name:"mercator"}}mergeSources(){const pt={},wt={},Tt={};this.forEachFragmentStyle((St=>{for(const wt in St._sourceCaches){const Tt=ut.al(wt,St.scope);pt[Tt]=St._sourceCaches[wt]}for(const pt in St._otherSourceCaches){const Tt=ut.al(pt,St.scope);wt[Tt]=St._otherSourceCaches[pt]}for(const pt in St._symbolSourceCaches){const wt=ut.al(pt,St.scope);Tt[wt]=St._symbolSourceCaches[pt]}})),this._mergedSourceCaches=pt,this._mergedOtherSourceCaches=wt,this._mergedSymbolSourceCaches=Tt}mergeLayers(){const pt={},wt=[],Tt={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((Tt=>{for(const St of Tt._order){const It=Tt._layers[St];if("slot"===It.type){const wt=ut.cU(St);if(pt[wt])continue;pt[wt]=[]}It.slot&&pt[It.slot]?pt[It.slot].push(It):wt.push(It)}})),this._mergedOrder=[],this._clipLayerIndices=[];let St=0;const a=(wt=[])=>{for(const It of wt)if("slot"===It.type){const wt=ut.cU(It.id);pt[wt]&&a(pt[wt]),this._mergedSlots.push(wt)}else{const pt=ut.al(It.id,It.scope);this._mergedOrder.push(pt),Tt[pt]=It,It.is3D()&&(this._has3DLayers=!0),"circle"===It.type&&(this._hasCircleLayers=!0),"symbol"===It.type&&(this._hasSymbolLayers=!0),"clip"===It.type&&this._clipLayerIndices.push(St),St++}};a(wt),this._mergedLayers=Tt,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(pt){return this.stylesheet.camera=ut.W({},this.stylesheet.camera,pt),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(pt){return pt.data?function(pt,wt,Tt){const St=ut.W({},wt);for(const pt of Object.keys(ut.L.colorTheme))void 0===St[pt]&&(St[pt]=ut.L.colorTheme[pt].default);const It=new ut.U(Iu,pt,new Map(Tt));return It.setTransitionOrValue(St,Tt),It.untransitioned().possiblyEvaluate(new ut.X(0))}(this.scope,pt,this.options).get("data"):null}_loadColorTheme(pt){return this._styleColorTheme.lutLoading=!0,new Promise(((wt,Tt)=>{const St="data:image/png;base64,";if(0===pt.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void wt();pt.startsWith(St)||(pt=St+pt);const It="mapbox-reserved-lut",Lt=new Image;Lt.src=pt,Lt.onerror=()=>{this._styleColorTheme.lutLoading=!1,Tt(new Error("Failed to load image data"))},Lt.onload=()=>{this._styleColorTheme.lutLoading=!1;const{width:St,height:Xt,data:Yt}=ut.e.getImageData(Lt);if(Xt>32)return void Tt(new Error("The height of the image must be less than or equal to 32 pixels."));if(St!==Xt*Xt)return void Tt(new Error("The width of the image must be equal to the height squared."));this.getImage(It)&&this.removeImage(It),this.addImage(It,{data:new ut.i({width:St,height:Xt},Yt),pixelRatio:1,sdf:!1,version:0});const Mi=this.imageManager.getImage(It,this.scope);Mi?(this._styleColorTheme.lut={image:Mi.data,data:pt},wt()):Tt(new Error("Missing LUT image."))}}))}getLut(ut){const pt=this._styleColorThemeForScope[ut];return pt?pt.lut:null}setProjection(ut){ut?this.stylesheet.projection=ut:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(pt){this._spriteRequest=function(pt,wt,Tt){let St,It,Lt;const Xt=ut.e.devicePixelRatio>1?"@2x":"";let Yt=ut.g(wt.transformRequest(wt.normalizeSpriteURL(pt,Xt,".json"),ut.R.SpriteJSON),((ut,pt)=>{Yt=null,Lt||(Lt=ut,St=pt,h())})),Mi=ut.h(wt.transformRequest(wt.normalizeSpriteURL(pt,Xt,".png"),ut.R.SpriteImage),((ut,pt)=>{Mi=null,Lt||(Lt=ut,It=pt,h())}));function h(){if(Lt)Tt(Lt);else if(St&&It){const pt=ut.e.getImageData(It),wt={};for(const Tt in St){const{width:It,height:Lt,x:Xt,y:Yt,sdf:Mi,pixelRatio:vr,stretchX:br,stretchY:Ar,content:Vr}=St[Tt],nn=new ut.i({width:It,height:Lt});ut.i.copy(pt,nn,{x:Xt,y:Yt},{x:0,y:0},{width:It,height:Lt},null),wt[Tt]={data:nn,pixelRatio:vr,sdf:Mi,stretchX:br,stretchY:Ar,content:Vr}}Tt(null,wt)}}return{cancel(){Yt&&(Yt.cancel(),Yt=null),Mi&&(Mi.cancel(),Mi=null)}}}(pt,this.map._requestManager,((pt,wt)=>{if(this._spriteRequest=null,pt)this.fire(new ut.d(pt));else if(wt)for(const ut in wt)this.imageManager.addImage(ut,this.scope,wt[ut]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new ut.f("data",{dataType:"style"}))}))}_validateLayer(pt){const wt=this.getOwnSource(pt.source);if(!wt)return;const Tt=pt.sourceLayer;Tt&&("geojson"===wt.type||wt.vectorLayerIds&&-1===wt.vectorLayerIds.indexOf(Tt))&&this.fire(new ut.d(new Error(`Source layer "${Tt}" does not exist on source "${wt.id}" as specified by style layer "${pt.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const ut in this._sourceCaches)if(!this._sourceCaches[ut].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:ut}of this.fragments)if(!ut.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((ut,pt)=>{const wt=this.fragments[pt];return wt&&wt.style&&(ut.data=wt.style.serialize()),ut}))}_serializeSources(){const ut={};for(const pt in this._sourceCaches){const wt=this._sourceCaches[pt].getSource();ut[wt.id]||(ut[wt.id]=wt.serialize())}return ut}_serializeLayers(ut){const pt=[];for(const wt of ut){const ut=this._layers[wt];ut&&"custom"!==ut.type&&pt.push(ut.serialize())}return pt}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;for(const ut in this._sourceCaches)if(this._sourceCaches[ut].hasTransition())return!0;for(const ut in this._layers)if(this._layers[ut].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(ut){return!!this.terrain&&ut.isDraped(this.getLayerSourceCache(ut))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(pt){const wt=this.getOwnLayer(pt);if(wt)return wt;this.fire(new ut.d(new Error(`The layer '${pt}' does not exist in the map's style.`)))}_checkSource(pt){const wt=this.getOwnSource(pt);if(wt)return wt;this.fire(new ut.d(new Error(`The source '${pt}' does not exist in the map's style.`)))}update(pt){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(pt),this.directionalLight&&this.directionalLight.recalculate(pt);const wt=this.calculateLightsBrightness();pt.brightness=wt||0,wt!==this._brightness&&(this._brightness=wt,this.dispatcher.broadcast("setBrightness",wt));const Tt=this._changes.isDirty();let St=!1;if(this._changes.isDirty()){const ut=this._changes.getLayerUpdatesByScope();for(const pt in ut){const{updatedIds:wt,removedIds:Tt}=ut[pt];(wt||Tt)&&(this._updateWorkerLayers(pt,wt,Tt),St=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(pt),this.light&&this.light.updateTransitions(pt),this.ambientLight&&this.ambientLight.updateTransitions(pt),this.directionalLight&&this.directionalLight.updateTransitions(pt),this.fog&&this.fog.updateTransitions(pt),this._changes.reset()}const It={};for(const ut in this._mergedSourceCaches){const pt=this._mergedSourceCaches[ut];It[ut]=pt.used,pt.used=!1,pt.tileCoverLift=0}for(const ut of this._mergedOrder){const wt=this._mergedLayers[ut];if(wt.recalculate(pt,this._availableImages),!wt.isHidden(pt.zoom)){const ut=this.getLayerSourceCache(wt);ut&&(ut.used=!0,ut.tileCoverLift=Math.max(ut.tileCoverLift,wt.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let ut=wt.minzoom||0;ut<(wt.maxzoom||25.5);ut++){const ut=this.map.painter;if(ut){const Tt=wt.getProgramIds();if(!Tt)continue;for(const St of Tt){const Tt=wt.getDefaultProgramParams(St,pt.zoom,this._styleColorTheme.lut);Tt&&(ut.style=this,this.fog&&(ut._fogVisible=!0,Tt.overrideFog=!0,ut.getOrCreateProgram(St,Tt)),ut._fogVisible=!1,Tt.overrideFog=!1,ut.getOrCreateProgram(St,Tt),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(Tt.overrideRtt=!0,ut.getOrCreateProgram(St,Tt)))}}}}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&St&&this.mergeLayers();for(const pt in It){const wt=this._mergedSourceCaches[pt];It[pt]!==wt.used&&wt.getSource().fire(new ut.f("data",{sourceDataType:"visibility",dataType:"source",sourceId:wt.getSource().id}))}this.light&&this.light.recalculate(pt),this.terrain&&this.terrain.recalculate(pt),this.fog&&this.fog.recalculate(pt),this.z=pt.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),Tt&&this.fire(new ut.f("data",{dataType:"style"}))}_updateTilesForChangedImages(){const ut=this._changes.getUpdatedImages();if(ut.length){for(const pt in this._sourceCaches)this._sourceCaches[pt].reloadTilesForDependencies(["icons","patterns"],ut);this._changes.resetUpdatedImages()}}_updateWorkerLayers(ut,pt,wt){const Tt=this.getFragmentStyle(ut);Tt&&this.dispatcher.broadcast("updateLayers",{layers:pt?Tt._serializeLayers(pt):[],scope:ut,removedIds:wt||[],options:Tt.options})}setState(pt,wt){if(this._checkLoaded(),La(this,Be(pt)))return!1;(pt=ut.cT(pt)).layers=jr(pt.layers);const Tt=function(ut,pt){if(!ut)return[{command:gc.setStyle,args:[pt]}];let wt=[];try{if(!t(ut.version,pt.version))return[{command:gc.setStyle,args:[pt]}];if(t(ut.center,pt.center)||wt.push({command:gc.setCenter,args:[pt.center]}),t(ut.zoom,pt.zoom)||wt.push({command:gc.setZoom,args:[pt.zoom]}),t(ut.bearing,pt.bearing)||wt.push({command:gc.setBearing,args:[pt.bearing]}),t(ut.pitch,pt.pitch)||wt.push({command:gc.setPitch,args:[pt.pitch]}),t(ut.sprite,pt.sprite)||wt.push({command:gc.setSprite,args:[pt.sprite]}),t(ut.glyphs,pt.glyphs)||wt.push({command:gc.setGlyphs,args:[pt.glyphs]}),t(ut.imports,pt.imports)||function(ut=[],pt=[],wt){pt=pt||[];const Tt=(ut=ut||[]).map(Xr),St=pt.map(Xr),It=ut.reduce(Yr,{}),Lt=pt.reduce(Yr,{}),Xt=Tt.slice();let Yt,Mi,vr,br;for(Yt=0,Mi=0;Yt<Tt.length;Yt++)vr=Tt[Yt],Lt.hasOwnProperty(vr)?Mi++:(wt.push({command:gc.removeImport,args:[vr]}),Xt.splice(Xt.indexOf(vr,Mi),1));for(Yt=0,Mi=0;Yt<St.length;Yt++)vr=St[St.length-1-Yt],Xt[Xt.length-1-Yt]!==vr&&(It.hasOwnProperty(vr)?(wt.push({command:gc.removeImport,args:[vr]}),Xt.splice(Xt.lastIndexOf(vr,Xt.length-Mi),1)):Mi++,br=Xt[Xt.length-Yt],wt.push({command:gc.addImport,args:[Lt[vr],br]}),Xt.splice(Xt.length-Yt,0,vr));for(const ut of pt){const pt=It[ut.id];pt&&!t(pt,ut)&&wt.push({command:gc.updateImport,args:[ut.id,ut]})}}(ut.imports,pt.imports,wt),t(ut.transition,pt.transition)||wt.push({command:gc.setTransition,args:[pt.transition]}),t(ut.light,pt.light)||wt.push({command:gc.setLight,args:[pt.light]}),t(ut.fog,pt.fog)||wt.push({command:gc.setFog,args:[pt.fog]}),t(ut.projection,pt.projection)||wt.push({command:gc.setProjection,args:[pt.projection]}),t(ut.lights,pt.lights)||wt.push({command:gc.setLights,args:[pt.lights]}),t(ut.camera,pt.camera)||wt.push({command:gc.setCamera,args:[pt.camera]}),!t(ut["color-theme"],pt["color-theme"]))return[{command:gc.setStyle,args:[pt]}];const Tt={},St=[];!function(ut,pt,wt,Tt){let St;for(St in pt=pt||{},ut=ut||{})ut.hasOwnProperty(St)&&(pt.hasOwnProperty(St)||Zr(St,wt,Tt));for(St in pt){if(!pt.hasOwnProperty(St))continue;const It=pt[St];ut.hasOwnProperty(St)?t(ut[St],It)||("geojson"===ut[St].type&&"geojson"===It.type&&Hr(ut,pt,St)?wt.push({command:gc.setGeoJSONSourceData,args:[St,It.data]}):qr(St,pt,wt,Tt)):Wr(St,pt,wt)}}(ut.sources,pt.sources,St,Tt);const It=[];ut.layers&&ut.layers.forEach((ut=>{ut.source&&Tt[ut.source]?wt.push({command:gc.removeLayer,args:[ut.id]}):It.push(ut)}));let Lt=ut.terrain;Lt&&Tt[Lt.source]&&(wt.push({command:gc.setTerrain,args:[void 0]}),Lt=void 0),wt=wt.concat(St),t(Lt,pt.terrain)||wt.push({command:gc.setTerrain,args:[pt.terrain]}),function(ut,pt,wt){pt=pt||[];const Tt=(ut=ut||[]).map(Xr),St=pt.map(Xr),It=ut.reduce(Yr,{}),Lt=pt.reduce(Yr,{}),Xt=Tt.slice(),Yt=Object.create(null);let Mi,vr,br,Ar,Vr,nn,sn;for(Mi=0,vr=0;Mi<Tt.length;Mi++)br=Tt[Mi],Lt.hasOwnProperty(br)?vr++:(wt.push({command:gc.removeLayer,args:[br]}),Xt.splice(Xt.indexOf(br,vr),1));for(Mi=0,vr=0;Mi<St.length;Mi++)br=St[St.length-1-Mi],Xt[Xt.length-1-Mi]!==br&&(It.hasOwnProperty(br)?(wt.push({command:gc.removeLayer,args:[br]}),Xt.splice(Xt.lastIndexOf(br,Xt.length-vr),1)):vr++,nn=Xt[Xt.length-Mi],wt.push({command:gc.addLayer,args:[Lt[br],nn]}),Xt.splice(Xt.length-Mi,0,br),Yt[br]=!0);for(Mi=0;Mi<St.length;Mi++)if(br=St[Mi],Ar=It[br],Vr=Lt[br],!Yt[br]&&!t(Ar,Vr))if(t(Ar.source,Vr.source)&&t(Ar["source-layer"],Vr["source-layer"])&&t(Ar.type,Vr.type)){for(sn in $r(Ar.layout,Vr.layout,wt,br,null,gc.setLayoutProperty),$r(Ar.paint,Vr.paint,wt,br,null,gc.setPaintProperty),t(Ar.slot,Vr.slot)||wt.push({command:gc.setSlot,args:[br,Vr.slot]}),t(Ar.filter,Vr.filter)||wt.push({command:gc.setFilter,args:[br,Vr.filter]}),t(Ar.minzoom,Vr.minzoom)&&t(Ar.maxzoom,Vr.maxzoom)||wt.push({command:gc.setLayerZoomRange,args:[br,Vr.minzoom,Vr.maxzoom]}),Ar)Ar.hasOwnProperty(sn)&&"layout"!==sn&&"paint"!==sn&&"filter"!==sn&&"metadata"!==sn&&"minzoom"!==sn&&"maxzoom"!==sn&&"slot"!==sn&&(0===sn.indexOf("paint.")?$r(Ar[sn],Vr[sn],wt,br,sn.slice(6),gc.setPaintProperty):t(Ar[sn],Vr[sn])||wt.push({command:gc.setLayerProperty,args:[br,sn,Vr[sn]]}));for(sn in Vr)Vr.hasOwnProperty(sn)&&!Ar.hasOwnProperty(sn)&&"layout"!==sn&&"paint"!==sn&&"filter"!==sn&&"metadata"!==sn&&"minzoom"!==sn&&"maxzoom"!==sn&&"slot"!==sn&&(0===sn.indexOf("paint.")?$r(Ar[sn],Vr[sn],wt,br,sn.slice(6),gc.setPaintProperty):t(Ar[sn],Vr[sn])||wt.push({command:gc.setLayerProperty,args:[br,sn,Vr[sn]]}))}else wt.push({command:gc.removeLayer,args:[br]}),nn=Xt[Xt.lastIndexOf(br)+1],wt.push({command:gc.addLayer,args:[Vr,nn]})}(It,pt.layers,wt)}catch(ut){console.warn("Unable to compute style diff:",ut),wt=[{command:gc.setStyle,args:[pt]}]}return wt}(this.serialize(),pt).filter((ut=>!(ut.command in Nu)));if(0===Tt.length)return!1;const St=Tt.filter((ut=>!(ut.command in Ou)));if(St.length>0)throw new Error(`Unimplemented: ${St.map((ut=>ut.command)).join(", ")}.`);const It=[];return Tt.forEach((ut=>{It.push(this[ut.command].apply(this,ut.args))})),wt&&Promise.all(It).then(wt),this.stylesheet=pt,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(pt,wt){return this.getImage(pt)?this.fire(new ut.d(new Error("An image with this name already exists."))):(this.imageManager.addImage(pt,this.scope,wt),this._afterImageUpdated(pt),this)}updateImage(ut,pt){this.imageManager.updateImage(ut,this.scope,pt)}getImage(ut){return this.imageManager.getImage(ut,this.scope)}removeImage(pt){return this.getImage(pt)?(this.imageManager.removeImage(pt,this.scope),this._afterImageUpdated(pt),this):this.fire(new ut.d(new Error("No image with this name exists.")))}_afterImageUpdated(pt){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(pt),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new ut.f("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(ut,pt,wt={}){return this._checkLoaded(),this._validate(He,`models.${ut}`,pt,null,wt)||(this.modelManager.addModel(ut,pt,this.scope),this._changes.setDirty()),this}hasModel(ut){return this.modelManager.hasModel(ut,this.scope)}removeModel(pt){return this.hasModel(pt)?(this.modelManager.removeModel(pt,this.scope),this):this.fire(new ut.d(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(pt,wt,Tt={}){if(this._checkLoaded(),void 0!==this.getOwnSource(pt))throw new Error(`There is already a source with ID "${pt}".`);if(!wt.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(wt).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(wt.type)>=0&&this._validate(ke,`sources.${pt}`,wt,null,Tt))return;this.map&&this.map._collectResourceTiming&&(wt.collectResourceTiming=!0);const St=zi(pt,wt,this.dispatcher,this);St.scope=this.scope,St.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(St.id),source:St.serialize(),sourceId:St.id})));const a=pt=>{const wt=(pt?"symbol:":"other:")+St.id,Tt=ut.al(wt,this.scope),It=this._sourceCaches[wt]=new ut.bv(Tt,St,pt);(pt?this._symbolSourceCaches:this._otherSourceCaches)[St.id]=It,It.onAdd(this.map)};a(!1),"vector"!==wt.type&&"geojson"!==wt.type||a(!0),St.onAdd&&St.onAdd(this.map),Tt.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(pt){this._checkLoaded();const wt=this.getOwnSource(pt);if(!wt)throw new Error("There is no source with this ID");for(const wt in this._layers)if(this._layers[wt].source===pt)return this.fire(new ut.d(new Error(`Source "${pt}" cannot be removed while layer "${wt}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===pt)return this.fire(new ut.d(new Error(`Source "${pt}" cannot be removed while terrain is using it.`)));const Tt=this.getOwnSourceCaches(pt);for(const pt of Tt){const wt=ut.cU(pt.id);delete this._sourceCaches[wt],this._changes.discardSourceCacheUpdate(pt.id),pt.fire(new ut.f("data",{sourceDataType:"metadata",dataType:"source",sourceId:pt.getSource().id})),pt.setEventedParent(null),pt.clearTiles()}return delete this._otherSourceCaches[pt],delete this._symbolSourceCaches[pt],this.mergeSources(),wt.setEventedParent(null),wt.onRemove&&wt.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(ut,pt){this._checkLoaded(),this.getOwnSource(ut).setData(pt),this._changes.setDirty()}getOwnSource(ut){const pt=this.getOwnSourceCache(ut);return pt&&pt.getSource()}getOwnSources(){const ut=[];for(const pt in this._otherSourceCaches){const wt=this.getOwnSourceCache(pt);wt&&ut.push(wt.getSource())}return ut}areTilesLoaded(){const ut=this._mergedSourceCaches;for(const pt in ut){const wt=ut[pt]._tiles;for(const ut in wt){const pt=wt[ut];if("loaded"!==pt.state&&"errored"!==pt.state)return!1}}return!0}setLights(pt){if(this._checkLoaded(),!pt)return delete this.ambientLight,void delete this.directionalLight;const wt=this._getTransitionParameters();for(const ut of pt){if(this._validate(Ue,"lights",ut))return;switch(ut.type){case"ambient":if(this.ambientLight){const pt=this.ambientLight;pt.set(ut),pt.updateTransitions(wt)}else this.ambientLight=new ct(ut,ln,this.scope,this.options);break;case"directional":if(this.directionalLight){const pt=this.directionalLight;pt.set(ut),pt.updateTransitions(wt)}else this.directionalLight=new ct(ut,cn,this.scope,this.options)}}const Tt=new ut.X(this.z||0,wt);this.ambientLight&&this.ambientLight.recalculate(Tt),this.directionalLight&&this.directionalLight.recalculate(Tt),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const pt=this.directionalLight,wt=this.ambientLight;if(!pt||!wt)return;const o=ut=>.2126*(ut[0]<=.03928?ut[0]/12.92:Math.pow((ut[0]+.055)/1.055,2.4))+.7152*(ut[1]<=.03928?ut[1]/12.92:Math.pow((ut[1]+.055)/1.055,2.4))+.0722*(ut[2]<=.03928?ut[2]/12.92:Math.pow((ut[2]+.055)/1.055,2.4)),Tt=pt.properties.get("color").toRenderColor(null).toArray01(),St=pt.properties.get("intensity"),It=pt.properties.get("direction"),Lt=1-ut.ac(It.x,It.y,It.z)[2]/90,Xt=o(Tt)*St*Lt,Yt=wt.properties.get("color").toRenderColor(null).toArray01(),Mi=wt.properties.get("intensity");return(Xt+o(Yt)*Mi)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const ut=[];return this.directionalLight&&ut.push(this.directionalLight.get()),this.ambientLight&&ut.push(this.ambientLight.get()),ut}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(pt){if(!pt)return this;if(ut.cV(pt)){const wt=ut.cW(pt),Tt=this.fragments.find((({id:ut})=>ut===wt));if(!Tt)throw new Error(`Style import not found: ${pt}`);const St=ut.cU(pt);return Tt.style.getFragmentStyle(St)}{const ut=this.fragments.find((({id:ut})=>ut===pt));if(!ut)throw new Error(`Style import not found: ${pt}`);return ut.style}}getConfigProperty(pt,wt){const Tt=this.getFragmentStyle(pt);if(!Tt)return null;const St=ut.al(wt,Tt.scope),It=Tt.options.get(St),Lt=It?It.value||It.default:null;return Lt?Lt.serialize():null}setConfigProperty(pt,wt,Tt){const St=this.getFragmentStyle(pt);if(!St)return;const It=St.stylesheet.schema;if(!It||!It[wt])return;const Lt=ut.y(Tt);if("success"!==Lt.result)return void La(this,Lt.value);const Xt=Lt.value.expression,Yt=ut.al(wt,St.scope),Mi=St.options.get(Yt);if(!Mi)return;let vr;const{minValue:br,maxValue:Ar,stepValue:Vr,type:nn,values:sn}=It[wt],an=ut.y(It[wt].default);"success"===an.result&&(vr=an.value.expression),vr?(this.options.set(Yt,{...Mi,value:Xt,default:vr,minValue:br,maxValue:Ar,stepValue:Vr,type:nn,values:sn}),this.updateConfigDependencies()):this.fire(new ut.d(new Error(`No schema defined for the config option "${wt}" in the "${pt}" fragment.`)))}getConfig(pt){const wt=this.getFragmentStyle(pt);if(!wt)return null;const Tt=wt.stylesheet.schema;if(!Tt)return null;const St={};for(const pt in Tt){const Tt=ut.al(pt,wt.scope),It=wt.options.get(Tt),Lt=It?It.value||It.default:null;St[pt]=Lt?Lt.serialize():null}return St}setConfig(ut,pt){const wt=this.getFragmentStyle(ut);wt&&(wt.updateConfig(pt,wt.stylesheet.schema),this.updateConfigDependencies())}getSchema(ut){const pt=this.getFragmentStyle(ut);return pt?pt.stylesheet.schema:null}setSchema(ut,pt){const wt=this.getFragmentStyle(ut);wt&&(wt.stylesheet.schema=pt,wt.updateConfig(wt._config,pt),this.updateConfigDependencies())}updateConfig(pt,wt){if(this._config=pt,pt||wt)if(wt)for(const Tt in wt){let St,It;const Lt=ut.y(wt[Tt].default);if("success"===Lt.result&&(St=Lt.value.expression),pt&&void 0!==pt[Tt]){const wt=ut.y(pt[Tt]);"success"===wt.result&&(It=wt.value.expression)}const{minValue:Xt,maxValue:Yt,stepValue:Mi,type:vr,values:br}=wt[Tt];if(St){const pt=ut.al(Tt,this.scope);this.options.set(pt,{default:St,value:It,minValue:Xt,maxValue:Yt,stepValue:Mi,type:vr,values:br})}else this.fire(new ut.d(new Error(`No schema defined for config option "${Tt}".`)))}else this.fire(new ut.d(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const ut of this._configDependentLayers){const pt=this.getLayer(ut);pt&&(pt.possiblyEvaluateVisibility(),this._updateLayer(pt))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.forEachFragmentStyle((ut=>{if(ut._styleColorTheme.colorTheme){const pt=ut._evaluateColorThemeData(ut._styleColorTheme.colorTheme);(!ut._styleColorTheme.lut||ut._styleColorTheme.lut&&pt!==ut._styleColorTheme.lut.data)&&ut.setColorTheme(ut._styleColorTheme.colorTheme)}})),this._changes.setDirty()}addLayer(pt,wt,Tt={}){this._checkLoaded();const St=pt.id;if(this._layers[St])return void this.fire(new ut.d(new Error(`Layer with id "${St}" already exists on this map`)));let It;if("custom"===pt.type){if(La(this,ut.cX(pt)))return;It=ut.cY(pt,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof pt.source&&(this.addSource(St,pt.source),pt=ut.cT(pt),pt=ut.W(pt,{source:St})),this._validate(Ve,`layers.${St}`,pt,{arrayIndex:-1},Tt))return;It=ut.cY(pt,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(It),It.setEventedParent(this,{layer:{id:St}}),this._serializedLayers[It.id]=It.serialize()}It.isConfigDependent&&this._configDependentLayers.add(It.fqid);let Lt=this._order.length;if(wt){const pt=this._order.indexOf(wt);if(-1===pt)return void this.fire(new ut.d(new Error(`Layer with id "${wt}" does not exist on this map.`)));It.slot===this._layers[wt].slot?Lt=pt:ut.w(`Layer with id "${wt}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(Lt,0,St),this._layerOrderChanged=!0,this._layers[St]=It;const Xt=this.getOwnLayerSourceCache(It),Yt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Xt&&It.canCastShadows()&&Yt&&(Xt.castsShadows=!0);const Mi=this._changes.getRemovedLayer(It);if(Mi&&It.source&&Xt&&"custom"!==It.type){this._changes.discardLayerRemoval(It);const pt=ut.al(It.source,It.scope);Mi.type!==It.type?this._changes.updateSourceCache(pt,"clear"):(this._changes.updateSourceCache(pt,"reload"),Xt.pause())}this._updateLayer(It),It.onAdd&&It.onAdd(this.map),It.scope=this.scope,this.mergeLayers()}moveLayer(pt,wt){this._checkLoaded();const Tt=this._checkLayer(pt);if(!Tt)return;if(pt===wt)return;const St=this._order.indexOf(pt);this._order.splice(St,1);let It=this._order.length;if(wt){const pt=this._order.indexOf(wt);if(-1===pt)return void this.fire(new ut.d(new Error(`Layer with id "${wt}" does not exist on this map.`)));Tt.slot===this._layers[wt].slot?It=pt:ut.w(`Layer with id "${wt}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(It,0,pt),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(ut){this._checkLoaded();const pt=this._checkLayer(ut);if(!pt)return;pt.setEventedParent(null);const wt=this._order.indexOf(ut);this._order.splice(wt,1),delete this._layers[ut],delete this._serializedLayers[ut],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(pt.fqid),this._changes.removeLayer(pt);const Tt=this.getOwnLayerSourceCache(pt);if(Tt&&Tt.castsShadows){let ut=!1;for(const wt in this._layers)if(this._layers[wt].source===pt.source&&this._layers[wt].canCastShadows()){ut=!0;break}Tt.castsShadows=ut}pt.onRemove&&pt.onRemove(this.map),this.mergeLayers()}getOwnLayer(ut){return this._layers[ut]}hasLayer(ut){return ut in this._mergedLayers}hasLayerType(ut){for(const pt in this._layers)if(this._layers[pt].type===ut)return!0;return!1}setLayerZoomRange(ut,pt,wt){this._checkLoaded();const Tt=this._checkLayer(ut);Tt&&(Tt.minzoom===pt&&Tt.maxzoom===wt||(null!=pt&&(Tt.minzoom=pt),null!=wt&&(Tt.maxzoom=wt),this._updateLayer(Tt)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(ut,pt){this._checkLoaded();const wt=this._checkLayer(ut);wt&&wt.slot!==pt&&(wt.slot=pt,this._updateLayer(wt))}setFilter(pt,wt,Tt={}){this._checkLoaded();const St=this._checkLayer(pt);if(St&&!t(St.filter,wt))return null==wt?(St.filter=void 0,void this._updateLayer(St)):void(this._validate(We,`layers.${St.id}.filter`,wt,{layerType:St.type},Tt)||(St.filter=ut.cT(wt),this._updateLayer(St)))}getFilter(pt){const wt=this._checkLayer(pt);if(wt)return ut.cT(wt.filter)}setLayoutProperty(pt,wt,Tt,St={}){this._checkLoaded();const It=this._checkLayer(pt);if(It&&!t(It.getLayoutProperty(wt),Tt)){if(null!=Tt&&(!St||!1!==St.validate)&&La(It,qe.call(Be,{key:`layers.${pt}.layout.${wt}`,layerType:It.type,objectKey:wt,value:Tt,styleSpec:ut.L,style:{glyphs:!0,sprite:!0}})))return;It.setLayoutProperty(wt,Tt),It.isConfigDependent&&this._configDependentLayers.add(It.fqid),this._updateLayer(It)}}getLayoutProperty(ut,pt){const wt=this._checkLayer(ut);if(wt)return wt.getLayoutProperty(pt)}setPaintProperty(pt,wt,Tt,St={}){this._checkLoaded();const It=this._checkLayer(pt);if(!It)return;if(t(It.getPaintProperty(wt),Tt))return;if(null!=Tt&&(!St||!1!==St.validate)&&La(It,Ze.call(Be,{key:`layers.${pt}.paint.${wt}`,layerType:It.type,objectKey:wt,value:Tt,styleSpec:ut.L})))return;const Lt=It.setPaintProperty(wt,Tt);It.isConfigDependent&&this._configDependentLayers.add(It.fqid),Lt&&this._updateLayer(It),this._changes.updatePaintProperties(It)}getPaintProperty(ut,pt){const wt=this._checkLayer(ut);if(wt)return wt.getPaintProperty(pt)}setFeatureState(pt,wt){this._checkLoaded();const Tt=pt.source,St=pt.sourceLayer,It=this._checkSource(Tt);if(!It)return;const Lt=It.type;if("geojson"===Lt&&St)return void this.fire(new ut.d(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===Lt&&!St)return void this.fire(new ut.d(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===pt.id&&this.fire(new ut.d(new Error("The feature id parameter must be provided.")));const Xt=this.getOwnSourceCaches(Tt);for(const ut of Xt)ut.setFeatureState(St,pt.id,wt)}removeFeatureState(pt,wt){this._checkLoaded();const Tt=pt.source,St=this._checkSource(Tt);if(!St)return;const It=St.type,Lt="vector"===It?pt.sourceLayer:void 0;if("vector"===It&&!Lt)return void this.fire(new ut.d(new Error("The sourceLayer parameter must be provided for vector source types.")));if(wt&&"string"!=typeof pt.id&&"number"!=typeof pt.id)return void this.fire(new ut.d(new Error("A feature id is required to remove its specific state property.")));const Xt=this.getOwnSourceCaches(Tt);for(const ut of Xt)ut.removeFeatureState(Lt,pt.id,wt)}getFeatureState(pt){this._checkLoaded();const wt=pt.source,Tt=pt.sourceLayer,St=this._checkSource(wt);if(St){if("vector"!==St.type||Tt)return void 0===pt.id&&this.fire(new ut.d(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(wt)[0].getFeatureState(Tt,pt.id);this.fire(new ut.d(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(pt){return this.stylesheet.transition=ut.W({},this.stylesheet.transition,pt),this.transition=this.stylesheet.transition,this}getTransition(){return ut.W({},this.stylesheet.transition)}serialize(){this._checkLoaded();const pt=this.getTerrain(),wt=pt&&this.terrain&&this.terrain.scope===this.scope?pt:this.stylesheet.terrain;return ut.cZ({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:wt,fog:this.stylesheet.fog,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(ut=>void 0!==ut))}_updateLayer(pt){this._changes.updateLayer(pt);const wt=this.getLayerSourceCache(pt),Tt=ut.al(pt.source,pt.scope),St=this._changes.getUpdatedSourceCaches();pt.source&&!St[Tt]&&wt&&"raster"!==wt.getSource().type&&(this._changes.updateSourceCache(Tt,"reload"),wt.pause()),pt.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(ut){const t=ut=>"fill-extrusion"===this._mergedLayers[ut].type||"model"===this._mergedLayers[ut].type,pt=this.order,wt={},Tt=[];for(let St=pt.length-1;St>=0;St--){const It=pt[St];if(t(It)){wt[It]=St;for(const pt of ut){const ut=pt[It];if(ut)for(const pt of ut)Tt.push(pt)}}}Tt.sort(((ut,pt)=>pt.intersectionZ-ut.intersectionZ));const St=[];for(let It=pt.length-1;It>=0;It--){const Lt=pt[It];if(t(Lt))for(let ut=Tt.length-1;ut>=0;ut--){const pt=Tt[ut].feature;if(pt.layer&&wt[pt.layer.id]<It)break;St.push(pt),Tt.pop()}else for(const pt of ut){const ut=pt[Lt];if(ut)for(const pt of ut)St.push(pt.feature)}}return St}queryRenderedFeatures(pt,wt,Tt){wt&&wt.filter&&this._validate(We,"queryRenderedFeatures.filter",wt.filter,null,wt),wt.scope=this.scope,wt.availableImages=this._availableImages,wt.serializedLayers=this._serializedLayers;const St={};if(wt&&wt.layers){if(!Array.isArray(wt.layers))return this.fire(new ut.d(new Error("parameters.layers must be an Array."))),[];for(const pt of wt.layers){const wt=this._mergedLayers[pt];if(!wt)return this.fire(new ut.d(new Error(`The layer '${pt}' does not exist in the map's style and cannot be queried for features.`))),[];St[wt.source]=!0}}const It=[],Lt=wt.serializedLayers||{},Xt=wt&&wt.layers?wt.layers.some((ut=>{const pt=this.getLayer(ut);return pt&&pt.is3D()})):this.has3DLayers(),Yt=Dr.createFromScreenPoints(pt,Tt);for(const ut in this._mergedSourceCaches){const pt=this._mergedSourceCaches[ut].getSource();if(!pt||pt.scope!==wt.scope)continue;const Mi=this._mergedSourceCaches[ut].getSource().id;wt.layers&&!St[Mi]||It.push(Br(this._mergedSourceCaches[ut],this._mergedLayers,Lt,Yt,wt,Tt,Xt,!!this.map._showQueryGeometry))}return this.placement&&It.push(function(ut,pt,wt,Tt,St,It,Lt){const Xt={},Yt=It.queryRenderedSymbols(Tt),Mi=[];for(const ut of Object.keys(Yt).map(Number))Mi.push(Lt[ut]);Mi.sort(Nr);for(const wt of Mi){const Tt=wt.featureIndex.lookupSymbolFeatures(Yt[wt.bucketInstanceId],pt,wt.bucketIndex,wt.sourceLayerIndex,St.filter,St.layers,St.availableImages,ut);for(const ut in Tt){const pt=Xt[ut]=Xt[ut]||[],St=Tt[ut];St.sort(((ut,pt)=>{const Tt=wt.featureSortOrder;if(Tt){const wt=Tt.indexOf(ut.featureIndex);return Tt.indexOf(pt.featureIndex)-wt}return pt.featureIndex-ut.featureIndex}));for(const ut of St)pt.push(ut)}}for(const pt in Xt)Xt[pt].forEach((Tt=>{const St=Tt.feature,It=wt(ut[pt]);if(!It)return;const Lt=It.getFeatureState(St.layer["source-layer"],St.id);St.source=St.layer.source,St.layer["source-layer"]&&(St.sourceLayer=St.layer["source-layer"]),St.state=Lt}));return Xt}(this._mergedLayers,Lt,this.getLayerSourceCache.bind(this),Yt.screenGeometry,wt,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(It)}querySourceFeatures(ut,pt){pt&&pt.filter&&this._validate(We,"querySourceFeatures.filter",pt.filter,null,pt);const wt=this.getOwnSourceCaches(ut);let Tt=[];for(const ut of wt)Tt=Tt.concat(kr(ut,pt));return Tt}addSourceType(ut,pt,wt){return Ma.getSourceType(ut)?wt(new Error(`A source type called "${ut}" already exists.`)):(Ma.setSourceType(ut,pt),pt.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:ut,url:pt.workerSourceURL},wt):wt(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(ut,pt,wt={}){this._checkLoaded();const Tt=this.light.getLight();let St=!1;for(const pt in ut)if(!t(ut[pt],Tt[pt])){St=!0;break}if(!St)return;const It=this._getTransitionParameters();this.light.setLight(ut,pt,wt),this.light.updateTransitions(It)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=ut.e.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&ut.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(pt,wt=1){if(this._checkLoaded(),!pt)return this.terrainSetForDrapingOnly()&&0!==wt||delete this.terrain,null===pt?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let Tt=pt;const St=null==pt.source;if(1===wt){if(this.disableElevatedTerrain)return;if("object"==typeof Tt.source){const pt="terrain-dem-src";this.addSource(pt,Tt.source),Tt=ut.cT(Tt),Tt=ut.W(Tt,{source:pt})}const pt=ut.W({},Tt),wt={};if(this.terrain&&St){pt.source=this.terrain.get().source;const ut=this.terrain?this.getFragmentStyle(this.terrain.scope):null;ut&&(wt.style=ut.serialize())}if(this._validate(Ge,"terrain",pt,wt))return}if(!this.terrain||this.terrain.scope!==this.scope&&!St||this.terrain&&wt!==this.terrain.drapeRenderMode){if(!Tt)return;this._createTerrain(Tt,wt),this.fire(new ut.f("data",{dataType:"style"}))}else{const wt=this.terrain,St=wt.get();for(const pt of Object.keys(ut.L.terrain))!Tt.hasOwnProperty(pt)&&ut.L.terrain[pt].default&&(Tt[pt]=ut.L.terrain[pt].default);for(const Tt in pt)if(!t(pt[Tt],St[Tt])){wt.set(pt,this.options),this.stylesheet.terrain=pt;const Tt=this._getTransitionParameters({duration:0});wt.updateTransitions(Tt),this.fire(new ut.f("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(ut){const pt=this.fog=new lt(ut,this.map.transform,this.scope,this.options);this.stylesheet.fog=pt.get();const wt=this._getTransitionParameters({duration:0});pt.updateTransitions(wt)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const ut of this.map._markers)ut._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(ut){if(this._checkLoaded(),!ut)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const pt=this.fog;if(!t(pt.get(),ut)){pt.set(ut,this.options),this.stylesheet.fog=pt.get();const wt=this._getTransitionParameters({duration:0});pt.updateTransitions(wt)}}else this._createFog(ut);this._markersNeedUpdate=!0}setColorTheme(pt){this._checkLoaded();const i=()=>{for(const ut in this._layers)this._layers[ut].lut=this._styleColorTheme.lut;for(const ut in this._sourceCaches)this._sourceCaches[ut].clearTiles()};if(this._styleColorTheme.colorTheme=pt,!pt)return this._styleColorTheme.lut=null,void i();const wt=this._evaluateColorThemeData(pt);this._loadColorTheme(wt).then((()=>{i()})).catch((pt=>{ut.w(`Couldn't set color theme: ${pt}`)}))}_getTransitionParameters(pt){return{now:ut.e.now(),transition:ut.W(this.transition,pt)}}updateDrapeFirstLayers(){if(!this.terrain)return;const ut=[],pt=[];for(const wt in this._mergedLayers)this.isLayerDraped(this._mergedLayers[wt])?ut.push(wt):pt.push(wt);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...ut),this._drapedFirstOrder.push(...pt)}_createTerrain(ut,pt){const wt=this.terrain=new Ar(ut,pt,this.scope,this.options);1===pt&&(this.stylesheet.terrain=ut),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const Tt=this._getTransitionParameters({duration:0});wt.updateTransitions(Tt)}_force3DLayerUpdate(){for(const ut in this._layers){const pt=this._layers[ut];"fill-extrusion"===pt.type&&this._updateLayer(pt)}}_forceSymbolLayerUpdate(){for(const ut in this._layers){const pt=this._layers[ut];"symbol"===pt.type&&this._updateLayer(pt)}}_validate(pt,wt,Tt,St,It={}){if(It&&!1===It.validate)return!1;const Lt=ut.W({},this.serialize());return La(this,pt.call(Be,ut.W({key:wt,style:Lt,value:Tt,styleSpec:ut.L},St)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),ut.c_.off("pluginStateChange",this._rtlTextPluginCallback);for(const ut in this._mergedLayers)this._mergedLayers[ut].setEventedParent(null);for(const ut in this._mergedSourceCaches)this._mergedSourceCaches[ut].clearTiles(),this._mergedSourceCaches[ut].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(ut){const pt=this.getSourceCaches(ut);for(const ut of pt)ut.clearTiles()}clearSources(){for(const ut in this._mergedSourceCaches)this._mergedSourceCaches[ut].clearTiles()}reloadSource(ut){const pt=this.getSourceCaches(ut);for(const ut of pt)ut.resume(),ut.reload()}reloadSources(){for(const ut of this.getSources())ut.reload&&ut.reload()}updateSources(ut){let pt;this.directionalLight&&(pt=wi(this.directionalLight));for(const wt in this._mergedSourceCaches)this._mergedSourceCaches[wt].update(ut,void 0,void 0,pt)}_generateCollisionBoxes(){for(const ut in this._sourceCaches){const pt=this._sourceCaches[ut];pt.resume(),pt.reload()}}_updatePlacement(pt,wt,Tt,St,It,Lt,Xt=!1){let Yt=!1,Mi=!1;const vr={},br={};for(const pt of this._mergedOrder){const Tt=this._mergedLayers[pt];if("symbol"!==Tt.type)continue;const St=ut.al(Tt.source,Tt.scope);let It=vr[St];if(!It){const ut=this.getLayerSourceCache(Tt);if(!ut)continue;const pt=ut.getRenderableIds(!0).map((pt=>ut.getTileByID(pt)));br[St]=pt.slice(),It=vr[St]=pt.sort(((ut,pt)=>pt.tileID.overscaledZ-ut.tileID.overscaledZ||(ut.tileID.isLessThan(pt.tileID)?-1:1)))}const Lt=this.crossTileSymbolIndex.addLayer(Tt,It,wt.center.lng,wt.projection);Yt=Yt||Lt}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),Xt=Xt||this._layerOrderChanged||0===St,this._layerOrderChanged&&this.fire(new ut.f("neworder")),(Xt||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(ut.e.now(),wt.zoom))&&(this.pauseablePlacement=new ba(wt,this._mergedOrder,Xt,Tt,St,It,this.placement,this.fog&&wt.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,vr,br),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(ut.e.now()),Mi=!0),Yt&&this.pauseablePlacement.placement.setStale()),Mi||Yt){this._buildingIndex.onNewFrame(wt.zoom);for(let pt=0;pt<this._mergedOrder.length;pt++){const wt=this._mergedLayers[this._mergedOrder[pt]];if("symbol"!==wt.type)continue;const Tt=this.isLayerClipped(wt)&&this._clipLayerIndices.some((ut=>pt<ut));this.placement.updateLayerOpacities(wt,vr[ut.al(wt.source,wt.scope)],pt,Tt?Lt:null)}}let Ar=!1;for(const wt of this._mergedOrder){const Tt=this._mergedLayers[wt];if("symbol"!==Tt.type)continue;const St=vr[ut.al(Tt.source,Tt.scope)];for(const ut of St){const wt=ut.getBucket(Tt);wt&&ut.latestFeatureIndex&&Tt.fqid===wt.layerIds[0]&&(Ar=wt.updateOcclusionOpacities(pt.context,pt.symbolParams,pt._dt)||Ar)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(ut.e.now())||Ar,occlusionQueryBasedOpacityChanged:Ar}}_releaseSymbolFadeTiles(){for(const ut in this._sourceCaches)this._sourceCaches[ut].releaseSymbolFadeTiles()}addImport(pt,wt){this._checkLoaded();const Tt=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==Tt.findIndex((({id:ut})=>ut===pt.id)))return void this.fire(new ut.d(new Error(`Import with id '${pt.id}' already exists in the map's style.`)));if(!wt)return Tt.push(pt),this._loadImports([pt],!0);const St=Tt.findIndex((({id:ut})=>ut===wt));return-1===St&&this.fire(new ut.d(new Error(`Import with id "${wt}" does not exist on this map.`))),this.stylesheet.imports=Tt.slice(0,St).concat(pt).concat(Tt.slice(St)),this._loadImports([pt],!0,wt)}updateImport(ut,pt){this._checkLoaded();const wt=this.stylesheet.imports||[],Tt=this.getImportIndex(ut);return-1===Tt?this:"string"==typeof pt?(this.setImportUrl(ut,pt),this):(pt.url&&pt.url!==wt[Tt].url&&this.setImportUrl(ut,pt.url),t(pt.config,wt[Tt].config)||this.setImportConfig(ut,pt.config),t(pt.data,wt[Tt].data)||this.setImportData(ut,pt.data),this)}moveImport(ut,pt){this._checkLoaded();let wt=this.stylesheet.imports||[];const Tt=this.getImportIndex(ut);if(-1===Tt)return this;const St=this.getImportIndex(pt);if(-1===St)return this;const It=wt[Tt],Lt=this.fragments[Tt];return wt=wt.filter((({id:pt})=>pt!==ut)),this.fragments=this.fragments.filter((({id:pt})=>pt!==ut)),this.stylesheet.imports=wt.slice(0,St).concat(It).concat(wt.slice(St)),this.fragments=this.fragments.slice(0,St).concat(Lt).concat(this.fragments.slice(St)),this.mergeLayers(),this}setImportUrl(ut,pt){this._checkLoaded();const wt=this.stylesheet.imports||[],Tt=this.getImportIndex(ut);if(-1===Tt)return this;wt[Tt].url=pt;const St=this.fragments[Tt];return St.style=this._createFragmentStyle(wt[Tt]),St.style.on("style.import.load",(()=>this.mergeAll())),St.style.loadURL(pt),this}setImportData(ut,pt){this._checkLoaded();const wt=this.getImportIndex(ut),Tt=this.stylesheet.imports||[];return-1===wt?this:pt?(this.fragments[wt].style.setState(pt),this._reloadImports(),this):(delete Tt[wt].data,this.setImportUrl(ut,Tt[wt].url))}setImportConfig(ut,pt){this._checkLoaded();const wt=this.getImportIndex(ut),Tt=this.stylesheet.imports||[];if(-1===wt)return this;pt?Tt[wt].config=pt:delete Tt[wt].config;const St=this.fragments[wt],It=St.style.stylesheet&&St.style.stylesheet.schema;return St.config=pt,St.style.updateConfig(pt,It),this.updateConfigDependencies(),this}removeImport(ut){this._checkLoaded();const pt=this.stylesheet.imports||[],wt=this.getImportIndex(ut);-1!==wt&&(pt.splice(wt,1),this.fragments[wt].style._remove(),this.fragments.splice(wt,1),this._reloadImports())}getImportIndex(pt){const wt=(this.stylesheet.imports||[]).findIndex((ut=>ut.id===pt));return-1===wt&&this.fire(new ut.d(new Error(`Import '${pt}' does not exist in the map's style and cannot be updated.`))),wt}getLayer(ut){return this._mergedLayers[ut]}getSources(){const ut=[];for(const pt in this._mergedOtherSourceCaches){const wt=this._mergedOtherSourceCaches[pt];wt&&ut.push(wt.getSource())}return ut}getSource(ut,pt){const wt=this.getSourceCache(ut,pt);return wt&&wt.getSource()}getLayerSource(ut){const pt=this.getLayerSourceCache(ut);return pt&&pt.getSource()}getSourceCache(pt,wt){const Tt=ut.al(pt,wt);return this._mergedOtherSourceCaches[Tt]}getLayerSourceCache(pt){const wt=ut.al(pt.source,pt.scope);return"symbol"===pt.type?this._mergedSymbolSourceCaches[wt]:this._mergedOtherSourceCaches[wt]}getSourceCaches(ut){if(null==ut)return Object.values(this._mergedSourceCaches);const pt=[];return this._mergedOtherSourceCaches[ut]&&pt.push(this._mergedOtherSourceCaches[ut]),this._mergedSymbolSourceCaches[ut]&&pt.push(this._mergedSymbolSourceCaches[ut]),pt}updateSourceCaches(){const ut=this._changes.getUpdatedSourceCaches();for(const pt in ut){const wt=ut[pt];"reload"===wt?this.reloadSource(pt):"clear"===wt&&this.clearSource(pt)}}updateLayers(ut){const pt=this._changes.getUpdatedPaintProperties();for(const wt of pt){const pt=this.getLayer(wt);pt&&pt.updateTransitions(ut)}}getImages(ut,pt,wt){this.imageManager.getImages(pt.icons,pt.scope,wt),this._updateTilesForChangedImages();const o=ut=>{ut&&ut.setDependencies(pt.tileID.key,pt.type,pt.icons)};o(this._otherSourceCaches[pt.source]),o(this._symbolSourceCaches[pt.source])}getGlyphs(ut,pt,wt){this.glyphManager.getGlyphs(pt.stacks,pt.scope,wt)}getResource(pt,wt,Tt){return ut.c$(wt,Tt)}getOwnSourceCache(ut){return this._otherSourceCaches[ut]}getOwnLayerSourceCache(ut){return"symbol"===ut.type?this._symbolSourceCaches[ut.source]:this._otherSourceCaches[ut.source]}getOwnSourceCaches(ut){const pt=[];return this._otherSourceCaches[ut]&&pt.push(this._otherSourceCaches[ut]),this._symbolSourceCaches[ut]&&pt.push(this._symbolSourceCaches[ut]),pt}_isSourceCacheLoaded(pt){const wt=this.getOwnSourceCaches(pt);return 0===wt.length?(this.fire(new ut.d(new Error(`There is no source with ID '${pt}'`))),!1):wt.every((ut=>ut.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(pt,wt){if(0===this._clipLayerIndices.length&&"fill-extrusion"!==pt.type)return!1;const Tt="fill-extrusion"===pt.type&&"building"===pt.sourceLayer;let St=0;if(pt.is3D()){if(Tt||wt&&"batched-model"===wt.type)return!0;"model"===pt.type&&(St=ut.cu.Model)}else"symbol"===pt.type&&(St=ut.cu.Symbol);for(const pt of this._clipLayerIndices){const wt=this._mergedLayers[this._mergedOrder[pt]];if(!wt)continue;const Tt=[];for(const pt of wt.layout.get("clip-layer-types"))Tt.push("model"===pt?ut.cu.Model:"symbol"===pt?ut.cu.Symbol:ut.cu.FillExtrusion);for(const ut of Tt)if(St&ut)return!0}return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((ut=>{ut.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function za(ut,pt){let wt=!1,Tt=null;const r=()=>{Tt=null,wt&&(ut(),Tt=setTimeout(r,pt),wt=!1)};return()=>(wt=!0,Tt||r(),Tt)}Ma.getSourceType=function(ut){return Qn[ut]},Ma.setSourceType=function(ut,pt){Qn[ut]=pt},Ma.registerForPluginStateChange=ut.cL;class Oa{constructor(pt){this._hashName=pt&&encodeURIComponent(pt),ut.bp(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=za(this._updateHashUnthrottled.bind(this),300)}addTo(ut){return this._map=ut,window.addEventListener("hashchange",this._onHashChange,!1),ut.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const ut=this._map;if(!ut)return"";const pt=Fa(ut);if(this._hashName){const ut=this._hashName;let wt=!1;const Tt=location.hash.slice(1).split("&").map((Tt=>{const St=Tt.split("=")[0];return St===ut?(wt=!0,`${St}=${pt}`):Tt})).filter((ut=>ut));return wt||Tt.push(`${ut}=${pt}`),`#${Tt.join("&")}`}return`#${pt}`}_getCurrentHash(){const ut=location.hash.replace("#","");if(this._hashName){let pt;return ut.split("&").map((ut=>ut.split("="))).forEach((ut=>{ut[0]===this._hashName&&(pt=ut)})),(pt&&pt[1]||"").split("/")}return ut.split("/")}_onHashChange(){const ut=this._map;if(!ut)return!1;const pt=this._getCurrentHash();if(pt.length>=3&&!pt.some((ut=>isNaN(ut)))){const wt=ut.dragRotate.isEnabled()&&ut.touchZoomRotate.isEnabled()?+(pt[3]||0):ut.getBearing();return ut.jumpTo({center:[+pt[2],+pt[1]],zoom:+pt[0],bearing:wt,pitch:+(pt[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Fa(ut,pt){const wt=ut.getCenter(),Tt=Math.round(100*ut.getZoom())/100,St=Math.ceil((Tt*Math.LN2+Math.log(512/360/.5))/Math.LN10),It=Math.pow(10,St),Lt=Math.round(wt.lng*It)/It,Xt=Math.round(wt.lat*It)/It,Yt=ut.getBearing(),Mi=ut.getPitch();let vr=pt?`/${Lt}/${Xt}/${Tt}`:`${Tt}/${Xt}/${Lt}`;return(Yt||Mi)&&(vr+="/"+Math.round(10*Yt)/10),Mi&&(vr+=`/${Math.round(Mi)}`),vr}const mh={linearity:.3,easing:ut.d0(0,0,.3,1)},yh=ut.W({deceleration:2500,maxSpeed:1400},mh),Th=ut.W({deceleration:20,maxSpeed:1400},mh),Sh=ut.W({deceleration:1e3,maxSpeed:360},mh),Ih=ut.W({deceleration:1e3,maxSpeed:90},mh);class ja{constructor(ut){this._map=ut,this.clear()}clear(){this._inertiaBuffer=[]}record(pt){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:ut.e.now(),settings:pt})}_drainInertiaBuffer(){const pt=this._inertiaBuffer,wt=ut.e.now();for(;pt.length>0&&wt-pt[0].time>160;)pt.shift()}_onMoveEnd(pt){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const wt={zoom:0,bearing:0,pitch:0,pan:new ut.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:ut}of this._inertiaBuffer)wt.zoom+=ut.zoomDelta||0,wt.bearing+=ut.bearingDelta||0,wt.pitch+=ut.pitchDelta||0,ut.panDelta&&wt.pan._add(ut.panDelta),ut.around&&(wt.around=ut.around),ut.pinchAround&&(wt.pinchAround=ut.pinchAround);const Tt=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,St={};if(wt.pan.mag()){const It=Wa(wt.pan.mag(),Tt,ut.W({},yh,pt||{}));St.offset=wt.pan.mult(It.amount/wt.pan.mag()),St.center=this._map.transform.center,Va(St,It)}if(wt.zoom){const ut=Wa(wt.zoom,Tt,Th);St.zoom=this._map.transform.zoom+ut.amount,Va(St,ut)}if(wt.bearing){const pt=Wa(wt.bearing,Tt,Sh);St.bearing=this._map.transform.bearing+ut.at(pt.amount,-179,179),Va(St,pt)}if(wt.pitch){const ut=Wa(wt.pitch,Tt,Ih);St.pitch=this._map.transform.pitch+ut.amount,Va(St,ut)}if(St.zoom||St.bearing){const ut=void 0===wt.pinchAround?wt.around:wt.pinchAround;St.around=ut?this._map.unproject(ut):this._map.getCenter()}return this.clear(),St.noMoveStart=!0,St}}function Va(ut,pt){(!ut.duration||ut.duration<pt.duration)&&(ut.duration=pt.duration,ut.easing=pt.easing)}function Wa(pt,wt,Tt){const{maxSpeed:St,linearity:It,deceleration:Lt}=Tt,Xt=ut.at(pt*It/(wt/1e3),-St,St),Yt=Math.abs(Xt)/(Lt*It);return{easing:Tt.easing,duration:1e3*Yt,amount:Xt*(Yt/2)}}class Za extends ut.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(pt,wt,Tt,St={}){const It=p(wt.getCanvasContainer(),Tt),Lt=wt.unproject(It);super(pt,ut.W({point:It,lngLat:Lt,originalEvent:Tt},St)),this._defaultPrevented=!1,this.target=wt}}class qa extends ut.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(pt,wt,Tt){const St="touchend"===pt?Tt.changedTouches:Tt.touches,It=f(wt.getCanvasContainer(),St),Lt=It.map((ut=>wt.unproject(ut))),Xt=It.reduce(((ut,pt,wt,Tt)=>ut.add(pt.div(Tt.length))),new ut.P(0,0));super(pt,{points:It,point:Xt,lngLats:Lt,lngLat:wt.unproject(Xt),originalEvent:Tt}),this._defaultPrevented=!1}}class Ha extends ut.f{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(ut,pt,wt){super(ut,{originalEvent:wt}),this._defaultPrevented=!1}}class $a{constructor(ut,pt){this._map=ut,this._clickTolerance=pt.clickTolerance}reset(){this._mousedownPos=void 0}wheel(ut){return this._firePreventable(new Ha(ut.type,this._map,ut))}mousedown(ut,pt){return this._mousedownPos=pt,this._firePreventable(new Za(ut.type,this._map,ut))}mouseup(ut){this._map.fire(new Za(ut.type,this._map,ut))}preclick(pt){const wt=ut.W({},pt);wt.type="preclick",this._map.fire(new Za(wt.type,this._map,wt))}click(ut,pt){this._mousedownPos&&this._mousedownPos.dist(pt)>=this._clickTolerance||(this.preclick(ut),this._map.fire(new Za(ut.type,this._map,ut)))}dblclick(ut){return this._firePreventable(new Za(ut.type,this._map,ut))}mouseover(ut){this._map.fire(new Za(ut.type,this._map,ut))}mouseout(ut){this._map.fire(new Za(ut.type,this._map,ut))}touchstart(ut){return this._firePreventable(new qa(ut.type,this._map,ut))}touchmove(ut){this._map.fire(new qa(ut.type,this._map,ut))}touchend(ut){this._map.fire(new qa(ut.type,this._map,ut))}touchcancel(ut){this._map.fire(new qa(ut.type,this._map,ut))}_firePreventable(ut){if(this._map.fire(ut),ut.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Xa{constructor(ut){this._map=ut}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(ut){this._map.fire(new Za(ut.type,this._map,ut))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Za("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(ut){this._delayContextMenu?this._contextMenuEvent=ut:this._map.fire(new Za(ut.type,this._map,ut)),this._map.listens("contextmenu")&&ut.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ya{constructor(ut,pt){this._map=ut,this._el=ut.getCanvasContainer(),this._container=ut.getContainer(),this._clickTolerance=pt.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(ut,pt){this.isEnabled()&&ut.shiftKey&&0===ut.button&&(h(),this._startPos=this._lastPos=pt,this._active=!0)}mousemoveWindow(ut,pt){if(!this._active)return;const wt=pt,Tt=this._startPos,St=this._lastPos;if(!Tt||!St||St.equals(wt)||!this._box&&wt.dist(Tt)<this._clickTolerance)return;this._lastPos=wt,this._box||(this._box=a("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",ut));const It=Math.min(Tt.x,wt.x),Lt=Math.max(Tt.x,wt.x),Xt=Math.min(Tt.y,wt.y),Yt=Math.max(Tt.y,wt.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${It}px,${Xt}px)`,this._box.style.width=Lt-It+"px",this._box.style.height=Yt-Xt+"px")}))}mouseupWindow(pt,wt){if(!this._active)return;const Tt=this._startPos,St=wt;if(Tt&&0===pt.button){if(this.reset(),d(),Tt.x!==St.x||Tt.y!==St.y)return this._map.fire(new ut.f("boxzoomend",{originalEvent:pt})),{cameraAnimation:ut=>ut.fitScreenCoordinates(Tt,St,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",pt)}}keydown(ut){this._active&&27===ut.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",ut))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),u(),delete this._startPos,delete this._lastPos}_fireEvent(pt,wt){return this._map.fire(new ut.f(pt,{originalEvent:wt}))}}function Ka(ut,pt){const wt={};for(let Tt=0;Tt<ut.length;Tt++)wt[ut[Tt].identifier]=pt[Tt];return wt}class Qa{constructor(ut){this.reset(),this.numTouches=ut.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(pt,wt,Tt){(this.centroid||Tt.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=pt.timeStamp),Tt.length===this.numTouches&&(this.centroid=function(pt){const wt=new ut.P(0,0);for(const ut of pt)wt._add(ut);return wt.div(pt.length)}(wt),this.touches=Ka(Tt,wt)))}touchmove(ut,pt,wt){if(this.aborted||!this.centroid)return;const Tt=Ka(wt,pt);for(const ut in this.touches){const pt=Tt[ut];(!pt||pt.dist(this.touches[ut])>30)&&(this.aborted=!0)}}touchend(ut,pt,wt){if((!this.centroid||ut.timeStamp-this.startTime>500)&&(this.aborted=!0),0===wt.length){const ut=!this.aborted&&this.centroid;if(this.reset(),ut)return ut}}}class Ja{constructor(ut){this.singleTap=new Qa(ut),this.numTaps=ut.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(ut,pt,wt){this.singleTap.touchstart(ut,pt,wt)}touchmove(ut,pt,wt){this.singleTap.touchmove(ut,pt,wt)}touchend(ut,pt,wt){const Tt=this.singleTap.touchend(ut,pt,wt);if(Tt){const pt=ut.timeStamp-this.lastTime<500,wt=!this.lastTap||this.lastTap.dist(Tt)<30;if(pt&&wt||this.reset(),this.count++,this.lastTime=ut.timeStamp,this.lastTap=Tt,this.count===this.numTaps)return this.reset(),Tt}}}class es{constructor(){this._zoomIn=new Ja({numTouches:1,numTaps:2}),this._zoomOut=new Ja({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(ut,pt,wt){this._zoomIn.touchstart(ut,pt,wt),this._zoomOut.touchstart(ut,pt,wt)}touchmove(ut,pt,wt){this._zoomIn.touchmove(ut,pt,wt),this._zoomOut.touchmove(ut,pt,wt)}touchend(ut,pt,wt){const Tt=this._zoomIn.touchend(ut,pt,wt),St=this._zoomOut.touchend(ut,pt,wt);return Tt?(this._active=!0,ut.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:pt=>pt.easeTo({duration:300,zoom:pt.getZoom()+1,around:pt.unproject(Tt)},{originalEvent:ut})}):St?(this._active=!0,ut.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:pt=>pt.easeTo({duration:300,zoom:pt.getZoom()-1,around:pt.unproject(St)},{originalEvent:ut})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Ph={0:1,2:2};class is{constructor(ut){this.reset(),this._clickTolerance=ut.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(ut,pt){return!1}_move(ut,pt){return{}}mousedown(ut,pt){if(this._lastPoint)return;const wt=m(ut);this._correctButton(ut,wt)&&(this._lastPoint=pt,this._eventButton=wt)}mousemoveWindow(ut,pt){const wt=this._lastPoint;if(wt)if(ut.preventDefault(),null!=this._eventButton&&function(ut,pt){const wt=Ph[pt];return void 0===ut.buttons||(ut.buttons&wt)!==wt}(ut,this._eventButton))this.reset();else if(this._moved||!(pt.dist(wt)<this._clickTolerance))return this._moved=!0,this._lastPoint=pt,this._move(wt,pt)}mouseupWindow(ut){this._lastPoint&&m(ut)===this._eventButton&&(this._moved&&d(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class os extends is{mousedown(ut,pt){super.mousedown(ut,pt),this._lastPoint&&(this._active=!0)}_correctButton(ut,pt){return 0===pt&&!ut.ctrlKey}_move(ut,pt){return{around:pt,panDelta:pt.sub(ut)}}}class rs extends is{_correctButton(ut,pt){return 0===pt&&ut.ctrlKey||2===pt}_move(ut,pt){const wt=.8*(pt.x-ut.x);if(wt)return this._active=!0,{bearingDelta:wt}}contextmenu(ut){ut.preventDefault()}}class as extends is{_correctButton(ut,pt){return 0===pt&&ut.ctrlKey||2===pt}_move(ut,pt){const wt=-.5*(pt.y-ut.y);if(wt)return this._active=!0,{pitchDelta:wt}}contextmenu(ut){ut.preventDefault()}}class ss{constructor(pt,wt){this._map=pt,this._el=pt.getCanvasContainer(),this._minTouches=1,this._clickTolerance=wt.clickTolerance||1,this.reset(),ut.bp(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new ut.P(0,0)}touchstart(ut,pt,wt){return this._calculateTransform(ut,pt,wt)}touchmove(pt,wt,Tt){if(this._active&&!(Tt.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===Tt.length&&!ut.d1())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return pt.cancelable&&pt.preventDefault(),this._calculateTransform(pt,wt,Tt)}}touchend(ut,pt,wt){this._calculateTransform(ut,pt,wt),this._active&&wt.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(pt,wt,Tt){Tt.length>0&&(this._active=!0);const St=Ka(Tt,wt),It=new ut.P(0,0),Lt=new ut.P(0,0);let Xt=0;for(const ut in St){const pt=St[ut],wt=this._touches[ut];wt&&(It._add(pt),Lt._add(pt.sub(wt)),Xt++,St[ut]=pt)}if(this._touches=St,Xt<this._minTouches||!Lt.mag())return;const Yt=Lt.div(Xt);return this._sum._add(Yt),this._sum.mag()<this._clickTolerance?void 0:{around:It.div(Xt),panDelta:Yt}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class ns{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(ut){}_move(ut,pt,wt){return{}}touchstart(ut,pt,wt){this._firstTwoTouches||wt.length<2||(this._firstTwoTouches=[wt[0].identifier,wt[1].identifier],this._start([pt[0],pt[1]]))}touchmove(ut,pt,wt){const Tt=this._firstTwoTouches;if(!Tt)return;ut.preventDefault();const[St,It]=Tt,Lt=ls(wt,pt,St),Xt=ls(wt,pt,It);if(!Lt||!Xt)return;const Yt=this._aroundCenter?null:Lt.add(Xt).div(2);return this._move([Lt,Xt],Yt,ut)}touchend(ut,pt,wt){if(!this._firstTwoTouches)return;const[Tt,St]=this._firstTwoTouches,It=ls(wt,pt,Tt),Lt=ls(wt,pt,St);It&&Lt||(this._active&&d(),this.reset())}touchcancel(){this.reset()}enable(ut){this._enabled=!0,this._aroundCenter=!!ut&&"center"===ut.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function ls(ut,pt,wt){for(let Tt=0;Tt<ut.length;Tt++)if(ut[Tt].identifier===wt)return pt[Tt]}function cs(ut,pt){return Math.log(ut/pt)/Math.LN2}class hs extends ns{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(ut){this._startDistance=this._distance=ut[0].dist(ut[1])}_move(ut,pt){const wt=this._distance;if(this._distance=ut[0].dist(ut[1]),this._active||!(Math.abs(cs(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:cs(this._distance,wt),pinchAround:pt}}}function us(ut,pt){return 180*ut.angleWith(pt)/Math.PI}class _s extends ns{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(ut){this._startVector=this._vector=ut[0].sub(ut[1]),this._minDiameter=ut[0].dist(ut[1])}_move(ut,pt){const wt=this._vector;if(this._vector=ut[0].sub(ut[1]),wt&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:us(this._vector,wt),pinchAround:pt}}_isBelowThreshold(ut){this._minDiameter=Math.min(this._minDiameter,ut.mag());const pt=25/(Math.PI*this._minDiameter)*360,wt=this._startVector;if(!wt)return!1;const Tt=us(ut,wt);return Math.abs(Tt)<pt}}function ds(ut){return Math.abs(ut.y)>Math.abs(ut.x)}class ps extends ns{constructor(ut){super(),this._map=ut}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(ut){this._lastPoints=ut,ds(ut[0].sub(ut[1]))&&(this._valid=!1)}_move(pt,wt,Tt){const St=this._lastPoints;if(!St)return;const It=pt[0].sub(St[0]),Lt=pt[1].sub(St[1]);return this._map._cooperativeGestures&&!ut.d1()&&Tt.touches.length<3||(this._valid=this.gestureBeginsVertically(It,Lt,Tt.timeStamp),!this._valid)?void 0:(this._lastPoints=pt,this._active=!0,{pitchDelta:(It.y+Lt.y)/2*-.5})}gestureBeginsVertically(ut,pt,wt){if(void 0!==this._valid)return this._valid;const Tt=ut.mag()>=2,St=pt.mag()>=2;if(!Tt&&!St)return;if(!Tt||!St)return null==this._firstMove&&(this._firstMove=wt),wt-this._firstMove<100&&void 0;const It=ut.y>0==pt.y>0;return ds(ut)&&ds(pt)&&It}}const kh={panStep:100,bearingStep:15,pitchStep:10};class ms{constructor(){const ut=kh;this._panStep=ut.panStep,this._bearingStep=ut.bearingStep,this._pitchStep=ut.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(ut){if(ut.altKey||ut.ctrlKey||ut.metaKey)return;let pt=0,wt=0,Tt=0,St=0,It=0;switch(ut.keyCode){case 61:case 107:case 171:case 187:pt=1;break;case 189:case 109:case 173:pt=-1;break;case 37:ut.shiftKey?wt=-1:(ut.preventDefault(),St=-1);break;case 39:ut.shiftKey?wt=1:(ut.preventDefault(),St=1);break;case 38:ut.shiftKey?Tt=1:(ut.preventDefault(),It=-1);break;case 40:ut.shiftKey?Tt=-1:(ut.preventDefault(),It=1);break;default:return}return this._rotationDisabled&&(wt=0,Tt=0),{cameraAnimation:Lt=>{const Xt=Lt.getZoom();Lt.easeTo({duration:300,easeId:"keyboardHandler",easing:gs,zoom:pt?Math.round(Xt)+pt*(ut.shiftKey?2:1):Xt,bearing:Lt.getBearing()+wt*this._bearingStep,pitch:Lt.getPitch()+Tt*this._pitchStep,offset:[-St*this._panStep,-It*this._panStep],center:Lt.getCenter()},{originalEvent:ut})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function gs(ut){return ut*(2-ut)}const qh=4.000244140625,Jh=1/450;class ys{constructor(pt,wt){this._map=pt,this._el=pt.getCanvasContainer(),this._handler=wt,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Jh,ut.bp(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(ut){this._defaultZoomRate=ut}setWheelZoomRate(ut){this._wheelZoomRate=ut}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(ut){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!ut&&"center"===ut.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(pt){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(pt.ctrlKey||pt.metaKey||this.isZooming()||ut.d1()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let wt=pt.deltaMode===WheelEvent.DOM_DELTA_LINE?40*pt.deltaY:pt.deltaY;const Tt=ut.e.now(),St=Tt-(this._lastWheelEventTime||0);this._lastWheelEventTime=Tt,0!==wt&&wt%qh==0?this._type="wheel":0!==wt&&Math.abs(wt)<4?this._type="trackpad":St>400?(this._type=null,this._lastValue=wt,this._timeout=setTimeout(this._onTimeout,40,pt)):this._type||(this._type=Math.abs(St*wt)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,wt+=this._lastValue)),pt.shiftKey&&wt&&(wt/=4),this._type&&(this._lastWheelEvent=pt,this._delta-=wt,this._active||this._start(pt)),pt.preventDefault()}_onTimeout(ut){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(ut)}_start(ut){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const pt=p(this._el,ut);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:pt,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const pt=this._map.transform;"wheel"===this._type&&pt.projection.wrap&&(pt._center.lng>=180||pt._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>pt._terrainEnabled()&&this._aroundCoord?pt.computeZoomRelativeTo(this._aroundCoord):pt.zoom;if(0!==this._delta){const ut="wheel"===this._type&&Math.abs(this._delta)>qh?this._wheelZoomRate:this._defaultZoomRate;let wt=2/(1+Math.exp(-Math.abs(this._delta*ut)));this._delta<0&&0!==wt&&(wt=1/wt);const Tt=i(),St=Math.pow(2,Tt),It="number"==typeof this._targetZoom?pt.zoomScale(this._targetZoom):St;this._targetZoom=Math.min(pt.maxZoom,Math.max(pt.minZoom,pt.scaleZoom(It*wt))),"wheel"===this._type&&(this._startZoom=Tt,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const wt="number"==typeof this._targetZoom?this._targetZoom:i(),Tt=this._startZoom,St=this._easing;let It,Lt=!1;if("wheel"===this._type&&Tt&&St){const pt=Math.min((ut.e.now()-this._lastWheelEventTime)/200,1),Xt=St(pt);It=ut.a2(Tt,wt,Xt),pt<1?this._frameId||(this._frameId=!0):Lt=!0}else It=wt,Lt=!0;this._active=!0,Lt&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let Xt=It-i();return Xt*this._lastDelta<0&&(Xt=0),{noInertia:!0,needsRenderFrame:!Lt,zoomDelta:Xt,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(pt){let wt=ut.d2;if(this._prevEase){const pt=this._prevEase,Tt=(ut.e.now()-pt.start)/pt.duration,St=pt.easing(Tt+.01)-pt.easing(Tt),It=.27/Math.sqrt(St*St+1e-4)*.01,Lt=Math.sqrt(.0729-It*It);wt=ut.d0(It,Lt,.25,1)}return this._prevEase={start:ut.e.now(),duration:pt,easing:wt},wt}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=a("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class bs{constructor(ut,pt){this._clickZoom=ut,this._tapZoom=pt}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ws{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(ut,pt){return ut.preventDefault(),{cameraAnimation:wt=>{wt.easeTo({duration:300,zoom:wt.getZoom()+(ut.shiftKey?-1:1),around:wt.unproject(pt)},{originalEvent:ut})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ts{constructor(){this._tap=new Ja({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(ut,pt,wt){this._swipePoint||(this._tapTime&&ut.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?wt.length>0&&(this._swipePoint=pt[0],this._swipeTouch=wt[0].identifier):this._tap.touchstart(ut,pt,wt))}touchmove(ut,pt,wt){if(this._tapTime){if(this._swipePoint){if(wt[0].identifier!==this._swipeTouch)return;const Tt=pt[0],St=Tt.y-this._swipePoint.y;return this._swipePoint=Tt,ut.preventDefault(),this._active=!0,{zoomDelta:St/128}}}else this._tap.touchmove(ut,pt,wt)}touchend(ut,pt,wt){this._tapTime?this._swipePoint&&0===wt.length&&this.reset():this._tap.touchend(ut,pt,wt)&&(this._tapTime=ut.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Es{constructor(ut,pt,wt){this._el=ut,this._mousePan=pt,this._touchPan=wt}enable(ut){this._inertiaOptions=ut||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Cs{constructor(ut,pt,wt){this._pitchWithRotate=ut.pitchWithRotate,this._mouseRotate=pt,this._mousePitch=wt}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Ss{constructor(ut,pt,wt,Tt){this._el=ut,this._touchZoom=pt,this._touchRotate=wt,this._tapDragZoom=Tt,this._rotationDisabled=!1,this._enabled=!0}enable(ut){this._touchZoom.enable(ut),this._rotationDisabled||this._touchRotate.enable(ut),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Is=ut=>ut.zoom||ut.drag||ut.pitch||ut.rotate;class Ls extends ut.f{}class Ps{constructor(){this.constants=[1,1,.01],this.radius=0}setup(pt,wt){const Tt=ut._.sub([],wt,pt);this.radius=ut._.length(Tt[2]<0?ut._.div([],Tt,this.constants):[Tt[0],Tt[1],0])}projectRay(pt){ut._.div(pt,pt,this.constants),ut._.normalize(pt,pt),ut._.mul(pt,pt,this.constants);const wt=ut._.scale([],pt,this.radius);if(wt[2]>0){const pt=ut._.scale([],[0,0,1],ut._.dot(wt,[0,0,1])),Tt=ut._.scale([],ut._.normalize([],[wt[0],wt[1],0]),this.radius),St=ut._.add([],wt,ut._.scale([],ut._.sub([],ut._.add([],Tt,pt),wt),2));wt[0]=St[0],wt[1]=St[1]}return wt}}function As(ut){return ut.panDelta&&ut.panDelta.mag()||ut.zoomDelta||ut.bearingDelta||ut.pitchDelta}class Rs{constructor(pt,wt){this._map=pt,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ja(pt),this._bearingSnap=wt.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ps,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(wt),ut.bp(["handleEvent","handleWindowEvent"],this);const Tt=this._el;this._listeners=[[Tt,"touchstart",{passive:!0}],[Tt,"touchmove",{passive:!1}],[Tt,"touchend",void 0],[Tt,"touchcancel",void 0],[Tt,"mousedown",void 0],[Tt,"mousemove",void 0],[Tt,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[Tt,"mouseover",void 0],[Tt,"mouseout",void 0],[Tt,"dblclick",void 0],[Tt,"click",void 0],[Tt,"keydown",{capture:!1}],[Tt,"keyup",void 0],[Tt,"wheel",{passive:!1}],[Tt,"contextmenu",void 0],[window,"blur",void 0]];for(const[ut,pt,wt]of this._listeners){const Tt=ut===document?this.handleWindowEvent:this.handleEvent;ut.addEventListener(pt,Tt,wt)}}destroy(){for(const[ut,pt,wt]of this._listeners){const Tt=ut===document?this.handleWindowEvent:this.handleEvent;ut.removeEventListener(pt,Tt,wt)}}_addDefaultHandlers(ut){const pt=this._map,wt=pt.getCanvasContainer();this._add("mapEvent",new $a(pt,ut));const Tt=pt.boxZoom=new Ya(pt,ut);this._add("boxZoom",Tt);const St=new es,It=new ws;pt.doubleClickZoom=new bs(It,St),this._add("tapZoom",St),this._add("clickZoom",It);const Lt=new Ts;this._add("tapDragZoom",Lt);const Xt=pt.touchPitch=new ps(pt);this._add("touchPitch",Xt);const Yt=new rs(ut),Mi=new as(ut);pt.dragRotate=new Cs(ut,Yt,Mi),this._add("mouseRotate",Yt,["mousePitch"]),this._add("mousePitch",Mi,["mouseRotate"]);const vr=new os(ut),br=new ss(pt,ut);pt.dragPan=new Es(wt,vr,br),this._add("mousePan",vr),this._add("touchPan",br,["touchZoom","touchRotate"]);const Ar=new _s,Vr=new hs;pt.touchZoomRotate=new Ss(wt,Vr,Ar,Lt),this._add("touchRotate",Ar,["touchPan","touchZoom"]),this._add("touchZoom",Vr,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Xa(pt));const nn=pt.scrollZoom=new ys(pt,this);this._add("scrollZoom",nn,["mousePan"]);const sn=pt.keyboard=new ms;this._add("keyboard",sn);for(const wt of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])ut.interactive&&ut[wt]&&pt[wt].enable(ut[wt])}_add(ut,pt,wt){this._handlers.push({handlerName:ut,handler:pt,allowed:wt}),this._handlersById[ut]=pt}stop(ut){if(!this._updatingCamera){for(const{handler:ut}of this._handlers)ut.reset();this._inertia.clear(),this._fireEvents({},{},ut),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:ut}of this._handlers)if(ut.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Is(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(ut,pt,wt){for(const Tt in ut)if(Tt!==wt&&(!pt||pt.indexOf(Tt)<0))return!0;return!1}handleWindowEvent(ut){this.handleEvent(ut,`${ut.type}Window`)}_getMapTouches(ut){const pt=[];for(const wt of ut)this._el.contains(wt.target)&&pt.push(wt);return pt}handleEvent(ut,pt){this._updatingCamera=!0;const wt="renderFrame"===ut.type,Tt=wt?void 0:ut,St={needsRenderFrame:!1},It={},Lt={},Xt=ut.touches?this._getMapTouches(ut.touches):void 0,Yt=Xt?f(this._el,Xt):wt?void 0:p(this._el,ut);for(const{handlerName:wt,handler:Mi,allowed:vr}of this._handlers){if(!Mi.isEnabled())continue;let br;this._blockedByActive(Lt,vr,wt)?Mi.reset():Mi[pt||ut.type]&&(br=Mi[pt||ut.type](ut,Yt,Xt),this.mergeHandlerResult(St,It,br,wt,Tt),br&&br.needsRenderFrame&&this._triggerRenderFrame()),(br||Mi.isActive())&&(Lt[wt]=Mi)}const Mi={};for(const ut in this._previousActiveHandlers)Lt[ut]||(Mi[ut]=Tt);this._previousActiveHandlers=Lt,(Object.keys(Mi).length||As(St))&&(this._changes.push([St,It,Mi]),this._triggerRenderFrame()),(Object.keys(Lt).length||As(St))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:vr}=St;vr&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],vr(this._map))}mergeHandlerResult(pt,wt,Tt,St,It){if(!Tt)return;ut.W(pt,Tt);const Lt={handlerName:St,originalEvent:Tt.originalEvent||It};void 0!==Tt.zoomDelta&&(wt.zoom=Lt),void 0!==Tt.panDelta&&(wt.drag=Lt),void 0!==Tt.pitchDelta&&(wt.pitch=Lt),void 0!==Tt.bearingDelta&&(wt.rotate=Lt)}_applyChanges(){const pt={},wt={},Tt={};for(const[St,It,Lt]of this._changes)St.panDelta&&(pt.panDelta=(pt.panDelta||new ut.P(0,0))._add(St.panDelta)),St.zoomDelta&&(pt.zoomDelta=(pt.zoomDelta||0)+St.zoomDelta),St.bearingDelta&&(pt.bearingDelta=(pt.bearingDelta||0)+St.bearingDelta),St.pitchDelta&&(pt.pitchDelta=(pt.pitchDelta||0)+St.pitchDelta),void 0!==St.around&&(pt.around=St.around),void 0!==St.aroundCoord&&(pt.aroundCoord=St.aroundCoord),void 0!==St.pinchAround&&(pt.pinchAround=St.pinchAround),St.noInertia&&(pt.noInertia=St.noInertia),ut.W(wt,It),ut.W(Tt,Lt);this._updateMapTransform(pt,wt,Tt),this._changes=[]}_updateMapTransform(pt,wt,Tt){const St=this._map,It=St.transform,s=ut=>[ut.x,ut.y,ut.z];if((ut=>{const pt=this._eventsInProgress.drag;return pt&&!this._handlersById[pt.handlerName].isActive()})()&&!As(pt)){const ut=It.zoom;It.cameraElevationReference="sea",null!=this._originalZoom&&It._orthographicProjectionAtLowPitch&&"globe"!==It.projection.name&&0===It.pitch?(It.cameraElevationReference="ground",It.zoom=this._originalZoom):(It.recenterOnTerrain(),It.cameraElevationReference="ground"),ut!==It.zoom&&this._map._update(!0)}if(It._isCameraConstrained&&St._stop(!0),!As(pt))return void this._fireEvents(wt,Tt,!0);let{panDelta:Lt,zoomDelta:Xt,bearingDelta:Yt,pitchDelta:Mi,around:vr,aroundCoord:br,pinchAround:Ar}=pt;It._isCameraConstrained&&(Xt>0&&(Xt=0),It._isCameraConstrained=!1),void 0!==Ar&&(vr=Ar),(Xt||(ut=>wt[ut]&&!this._eventsInProgress[ut])("drag"))&&vr&&(this._dragOrigin=s(It.pointCoordinate3D(vr)),this._originalZoom=It.zoom,this._trackingEllipsoid.setup(It._camera.position,this._dragOrigin)),It.cameraElevationReference="sea",St._stop(!0),vr=vr||St.transform.centerPoint,Yt&&(It.bearing+=Yt),Mi&&(It.pitch+=Mi),It._updateCameraState();const Vr=[0,0,0];if(Lt)if("mercator"===It.projection.name){const ut=this._trackingEllipsoid.projectRay(It.screenPointToMercatorRay(vr).dir),pt=this._trackingEllipsoid.projectRay(It.screenPointToMercatorRay(vr.sub(Lt)).dir);Vr[0]=pt[0]-ut[0],Vr[1]=pt[1]-ut[1]}else{const pt=It.pointCoordinate(vr);if("globe"===It.projection.name){Lt=Lt.rotate(-It.angle);const wt=It._pixelsPerMercatorPixel/It.worldSize;Vr[0]=-Lt.x*ut.d3(ut.ay(pt.y))*wt,Vr[1]=-Lt.y*ut.d3(It.center.lat)*wt}else{const ut=It.pointCoordinate(vr.sub(Lt));pt&&ut&&(Vr[0]=ut.x-pt.x,Vr[1]=ut.y-pt.y)}}const nn=It.zoom,sn=[0,0,0];if(Xt){const pt=s(br||It.pointCoordinate3D(vr)),wt={dir:ut._.normalize([],ut._.sub([],pt,It._camera.position))};if(wt.dir[2]<0){const Tt=It.zoomDeltaToMovement(pt,Xt);ut._.scale(sn,wt.dir,Tt)}}const an=ut._.add(Vr,Vr,sn);It._translateCameraConstrained(an),Xt&&Math.abs(It.zoom-nn)>1e-4&&It.recenterOnTerrain(),It.cameraElevationReference="ground",this._map._update(),pt.noInertia||this._inertia.record(pt),this._fireEvents(wt,Tt,!0)}_fireEvents(pt,wt,Tt){const St=Is(this._eventsInProgress),It=Is(pt),Lt={};for(const ut in pt){const{originalEvent:wt}=pt[ut];this._eventsInProgress[ut]||(Lt[`${ut}start`]=wt),this._eventsInProgress[ut]=pt[ut]}!St&&It&&this._fireEvent("movestart",It.originalEvent);for(const ut in Lt)this._fireEvent(ut,Lt[ut]);It&&this._fireEvent("move",It.originalEvent);for(const ut in pt){const{originalEvent:wt}=pt[ut];this._fireEvent(ut,wt)}const Xt={};let Yt;for(const ut in this._eventsInProgress){const{handlerName:pt,originalEvent:Tt}=this._eventsInProgress[ut];this._handlersById[pt].isActive()||(delete this._eventsInProgress[ut],Yt=wt[pt]||Tt,Xt[`${ut}end`]=Yt)}for(const ut in Xt)this._fireEvent(ut,Xt[ut]);const Mi=Is(this._eventsInProgress);if(Tt&&(St||It)&&!Mi){this._updatingCamera=!0;const pt=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=ut=>0!==ut&&-this._bearingSnap<ut&&ut<this._bearingSnap;pt?(i(pt.bearing||this._map.getBearing())&&(pt.bearing=0),this._map.easeTo(pt,{originalEvent:Yt})):(this._map.fire(new ut.f("moveend",{originalEvent:Yt})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(pt,wt){this._map.fire(new ut.f(pt,wt?{originalEvent:wt}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((ut=>{this._frameId=void 0,this.handleEvent(new Ls("renderFrame",{timeStamp:ut})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Qh="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ms extends ut.E{constructor(pt,wt){super(),this._moving=!1,this._zooming=!1,this.transform=pt,this._bearingSnap=wt.bearingSnap,this._respectPrefersReducedMotion=!1!==wt.respectPrefersReducedMotion,ut.bp(["_renderFrameCallback"],this)}getCenter(){return new ut.aI(this.transform.center.lng,this.transform.center.lat)}setCenter(ut,pt){return this.jumpTo({center:ut},pt)}panBy(pt,wt,Tt){return pt=ut.P.convert(pt).mult(-1),this.panTo(this.transform.center,ut.W({offset:pt},wt),Tt)}panTo(pt,wt,Tt){return this.easeTo(ut.W({center:pt},wt),Tt)}getZoom(){return this.transform.zoom}setZoom(ut,pt){return this.jumpTo({zoom:ut},pt),this}zoomTo(pt,wt,Tt){return this.easeTo(ut.W({zoom:pt},wt),Tt)}zoomIn(ut,pt){return this.zoomTo(this.getZoom()+1,ut,pt),this}zoomOut(ut,pt){return this.zoomTo(this.getZoom()-1,ut,pt),this}getBearing(){return this.transform.bearing}setBearing(ut,pt){return this.jumpTo({bearing:ut},pt),this}getPadding(){return this.transform.padding}setPadding(ut,pt){return this.jumpTo({padding:ut},pt),this}rotateTo(pt,wt,Tt){return this.easeTo(ut.W({bearing:pt},wt),Tt)}resetNorth(pt,wt){return this.rotateTo(0,ut.W({duration:1e3},pt),wt),this}resetNorthPitch(pt,wt){return this.easeTo(ut.W({bearing:0,pitch:0,duration:1e3},pt),wt),this}snapToNorth(ut,pt){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(ut,pt):this}getPitch(){return this.transform.pitch}setPitch(ut,pt){return this.jumpTo({pitch:ut},pt),this}cameraForBounds(pt,wt){pt=ut.ai.convert(pt);const Tt=wt&&wt.bearing||0,St=wt&&wt.pitch||0,It=pt.getNorthWest(),Lt=pt.getSouthEast();return this._cameraForBounds(this.transform,It,Lt,Tt,St,wt)}_extendPadding(pt){const wt={top:0,right:0,bottom:0,left:0};return null==pt?ut.W({},wt,this.transform.padding):"number"==typeof pt?{top:pt,bottom:pt,right:pt,left:pt}:ut.W({},wt,pt)}_extendCameraOptions(pt){return(pt=ut.W({offset:[0,0],maxZoom:this.transform.maxZoom},pt)).padding=this._extendPadding(pt.padding),pt}_minimumAABBFrustumDistance(ut,pt){const wt=pt.max[0]-pt.min[0],Tt=pt.max[1]-pt.min[1];return wt/Tt>ut.aspect?wt/(2*Math.tan(.5*ut.fovX)*ut.aspect):Tt/(2*Math.tan(.5*ut.fovY)*ut.aspect)}_cameraForBoundsOnGlobe(pt,wt,Tt,St,It,Lt){const Xt=pt.clone(),Yt=this._extendCameraOptions(Lt);Xt.bearing=St,Xt.pitch=It;const Mi=ut.aI.convert(wt),vr=ut.aI.convert(Tt),br=.5*(Mi.lat+vr.lat),Ar=.5*(Mi.lng+vr.lng),Vr=ut.d4(br,Ar),nn=ut._.normalize([],Vr),sn=ut._.normalize([],ut._.cross([],nn,[0,1,0])),an=ut._.cross([],sn,nn),ln=[sn[0],sn[1],sn[2],0,an[0],an[1],an[2],0,nn[0],nn[1],nn[2],0,0,0,0,1],cn=[Vr,ut.d4(Mi.lat,Mi.lng),ut.d4(vr.lat,Mi.lng),ut.d4(vr.lat,vr.lng),ut.d4(Mi.lat,vr.lng),ut.d4(br,Mi.lng),ut.d4(br,vr.lng),ut.d4(Mi.lat,Ar),ut.d4(vr.lat,Ar)];let un=ut.b6.fromPoints(cn.map((pt=>[ut._.dot(sn,pt),ut._.dot(an,pt),ut._.dot(nn,pt)])));const fn=ut._.transformMat4([],un.center,ln);0===ut._.squaredLength(fn)&&ut._.set(fn,0,0,1),ut._.normalize(fn,fn),ut._.scale(fn,fn,ut.cD),Xt.center=ut.d5(fn);const _n=Xt.getWorldToCameraMatrix(),gn=ut.ad.invert(new Float64Array(16),_n);un=ut.b6.applyTransform(un,ut.ad.multiply([],_n,ln));const yn=this._extendAABB(un,Xt,Yt,St);if(!yn)return void ut.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");un=yn,ut._.transformMat4(fn,fn,_n);const xn=.5*(un.max[2]-un.min[2]),vn=this._minimumAABBFrustumDistance(Xt,un),bn=ut._.scale([],[0,0,1],xn),wn=ut._.add(bn,fn,bn),Tn=vn+(0===Xt.pitch?0:ut._.distance(fn,wn)),En=Xt.globeCenterInViewSpace,Mn=ut._.sub([],fn,[En[0],En[1],En[2]]);ut._.normalize(Mn,Mn),ut._.scale(Mn,Mn,Tn);const Sn=ut._.add([],fn,Mn);ut._.transformMat4(Sn,Sn,gn);const An=ut.d7/ut.cD,In=ut._.length(Sn),Pn=ut.ax(Math.max(In*An-ut.d7,Number.EPSILON),0),zn=Math.min(Xt.zoomFromMercatorZAdjusted(Pn),Yt.maxZoom);return zn>.5*(ut.b1+ut.aU)?(Xt.setProjection({name:"mercator"}),Xt.zoom=zn,this._cameraForBounds(Xt,wt,Tt,St,It,Lt)):{center:Xt.center,zoom:zn,bearing:St,pitch:It}}_extendAABB(pt,wt,Tt,St){const It=.5*((Tt.padding.left||0)+(Tt.padding.right||0)),Lt=.5*((Tt.padding.top||0)+(Tt.padding.bottom||0)),Xt=Lt,Yt=It,Mi=It,vr=Lt,br=wt.width-(Yt+Mi),Ar=wt.height-(Xt+vr),Vr=ut._.sub([],pt.max,pt.min),nn=Math.min(br/Vr[0],Ar/Vr[1]),sn=Math.min(wt.scaleZoom(wt.scale*nn),Tt.maxZoom);if(isNaN(sn))return null;const an=wt.scale/wt.zoomScale(sn),ln=new ut.b6([pt.min[0]-Yt*an,pt.min[1]-vr*an,pt.min[2]],[pt.max[0]+Mi*an,pt.max[1]+Xt*an,pt.max[2]]),cn=("number"==typeof Tt.offset.x&&"number"==typeof Tt.offset.y?new ut.P(Tt.offset.x,Tt.offset.y):ut.P.convert(Tt.offset)).rotate(-ut.ab(St));return ln.center[0]-=cn.x*an,ln.center[1]+=cn.y*an,ln}queryTerrainElevation(pt,wt){const Tt=this.transform.elevation;return Tt?(wt=ut.W({},{exaggerated:!0},wt),Tt.getAtPoint(ut.Y.fromLngLat(pt),null,wt.exaggerated)):null}_cameraForBounds(pt,wt,Tt,St,It,Lt){if("globe"===pt.projection.name)return this._cameraForBoundsOnGlobe(pt,wt,Tt,St,It,Lt);const Xt=pt.clone(),Yt=this._extendCameraOptions(Lt);Xt.bearing=St,Xt.pitch=It;const Mi=ut.aI.convert(wt),vr=ut.aI.convert(Tt),br=new ut.aI(Mi.lng,vr.lat),Ar=new ut.aI(vr.lng,Mi.lat),Vr=Xt.project(Mi),nn=Xt.project(vr),sn=this.queryTerrainElevation(Mi),an=this.queryTerrainElevation(vr),ln=this.queryTerrainElevation(br),cn=this.queryTerrainElevation(Ar),un=[[Vr.x,Vr.y,Math.min(sn||0,an||0,ln||0,cn||0)],[nn.x,nn.y,Math.max(sn||0,an||0,ln||0,cn||0)]];let fn=ut.b6.fromPoints(un);const _n=Xt.getWorldToCameraMatrix(),gn=ut.ad.invert(new Float64Array(16),_n);fn=ut.b6.applyTransform(fn,_n);const yn=this._extendAABB(fn,Xt,Yt,St);if(!yn)return void ut.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");fn=yn;const xn=.5*ut._.sub([],fn.max,fn.min)[2],vn=this._minimumAABBFrustumDistance(Xt,fn),bn=[0,0,1,0];ut.aA.transformMat4(bn,bn,_n),ut.aA.normalize(bn,bn);const wn=ut._.scale([],bn,vn+xn),Tn=ut._.add([],fn.center,wn);ut._.transformMat4(fn.center,fn.center,gn),ut._.transformMat4(Tn,Tn,gn);const En=[fn.center[0],fn.center[1],Tn[2]*Xt.pixelsPerMeter];ut._.scale(En,En,1/Xt.worldSize);const Mn=ut.d6(En[0]),Sn=ut.ay(En[1]),An=Math.min(Xt._zoomFromMercatorZ(En[2]),Yt.maxZoom),In=new ut.aI(Mn,Sn);return Xt.mercatorFromTransition&&An<.5*(ut.b1+ut.aU)?(Xt.setProjection({name:"globe"}),Xt.zoom=An,this._cameraForBounds(Xt,wt,Tt,St,It,Lt)):{center:In,zoom:An,bearing:St,pitch:It}}fitBounds(ut,pt,wt){const Tt=this.cameraForBounds(ut,pt);return this._fitInternal(Tt,pt,wt)}fitScreenCoordinates(pt,wt,Tt,St,It){const Lt=ut.P.convert(pt),Xt=ut.P.convert(wt),Yt=new ut.P(Math.min(Lt.x,Xt.x),Math.min(Lt.y,Xt.y)),Mi=new ut.P(Math.max(Lt.x,Xt.x),Math.max(Lt.y,Xt.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(Lt,Xt))return this;const vr=this.transform.pointLocation3D(Yt),br=this.transform.pointLocation3D(Mi),Ar=this.transform.pointLocation3D(new ut.P(Yt.x,Mi.y)),Vr=this.transform.pointLocation3D(new ut.P(Mi.x,Yt.y)),nn=[Math.min(vr.lng,br.lng,Ar.lng,Vr.lng),Math.min(vr.lat,br.lat,Ar.lat,Vr.lat)],sn=[Math.max(vr.lng,br.lng,Ar.lng,Vr.lng),Math.max(vr.lat,br.lat,Ar.lat,Vr.lat)],an=St&&St.pitch?St.pitch:this.getPitch(),ln=this._cameraForBounds(this.transform,nn,sn,Tt,an,St);return this._fitInternal(ln,St,It)}_fitInternal(pt,wt,Tt){return pt?(wt=ut.W(pt,wt)).linear?this.easeTo(wt,Tt):this.flyTo(wt,Tt):this}jumpTo(pt,wt){this.stop();const Tt=pt.preloadOnly?this.transform.clone():this.transform;let St=!1,It=!1,Lt=!1;return"zoom"in pt&&Tt.zoom!==+pt.zoom&&(St=!0,Tt.zoom=+pt.zoom),void 0!==pt.center&&(Tt.center=ut.aI.convert(pt.center)),"bearing"in pt&&Tt.bearing!==+pt.bearing&&(It=!0,Tt.bearing=+pt.bearing),"pitch"in pt&&Tt.pitch!==+pt.pitch&&(Lt=!0,Tt.pitch=+pt.pitch),null==pt.padding||Tt.isPaddingEqual(pt.padding)||(Tt.padding=pt.padding),pt.preloadOnly?(this._preloadTiles(Tt),this):(this.fire(new ut.f("movestart",wt)).fire(new ut.f("move",wt)),St&&this.fire(new ut.f("zoomstart",wt)).fire(new ut.f("zoom",wt)).fire(new ut.f("zoomend",wt)),It&&this.fire(new ut.f("rotatestart",wt)).fire(new ut.f("rotate",wt)).fire(new ut.f("rotateend",wt)),Lt&&this.fire(new ut.f("pitchstart",wt)).fire(new ut.f("pitch",wt)).fire(new ut.f("pitchend",wt)),this.fire(new ut.f("moveend",wt)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||ut.w(Qh),this.transform.getFreeCameraOptions()}setFreeCameraOptions(pt,wt){const Tt=this.transform;if(!Tt.projection.supportsFreeCamera)return ut.w(Qh),this;this.stop();const St=Tt.zoom,It=Tt.pitch,Lt=Tt.bearing;Tt.setFreeCameraOptions(pt);const Xt=St!==Tt.zoom,Yt=It!==Tt.pitch,Mi=Lt!==Tt.bearing;return this.fire(new ut.f("movestart",wt)).fire(new ut.f("move",wt)),Xt&&this.fire(new ut.f("zoomstart",wt)).fire(new ut.f("zoom",wt)).fire(new ut.f("zoomend",wt)),Mi&&this.fire(new ut.f("rotatestart",wt)).fire(new ut.f("rotate",wt)).fire(new ut.f("rotateend",wt)),Yt&&this.fire(new ut.f("pitchstart",wt)).fire(new ut.f("pitch",wt)).fire(new ut.f("pitchend",wt)),this.fire(new ut.f("moveend",wt)),this}easeTo(pt,wt){this._stop(!1,pt.easeId),(!1===(pt=ut.W({offset:[0,0],duration:500,easing:ut.d2},pt)).animate||this._prefersReducedMotion(pt))&&(pt.duration=0);const Tt=this.transform,St=this.getZoom(),It=this.getBearing(),Lt=this.getPitch(),Xt=this.getPadding(),Yt="zoom"in pt?+pt.zoom:St,Mi="bearing"in pt?this._normalizeBearing(pt.bearing,It):It,vr="pitch"in pt?+pt.pitch:Lt,br=this._extendPadding(pt.padding),Ar=ut.P.convert(pt.offset);let Vr,nn,sn;if("globe"===Tt.projection.name){const wt=ut.Y.fromLngLat(Tt.center),St=Ar.rotate(-Tt.angle);wt.x+=St.x/Tt.worldSize,wt.y+=St.y/Tt.worldSize;const It=wt.toLngLat(),Lt=ut.aI.convert(pt.center||It);this._normalizeCenter(Lt),Vr=Tt.centerPoint.add(St),nn=new ut.P(wt.x,wt.y).mult(Tt.worldSize),sn=new ut.P(ut.aj(Lt.lng),ut.ak(Lt.lat)).mult(Tt.worldSize).sub(nn)}else{Vr=Tt.centerPoint.add(Ar);const wt=Tt.pointLocation(Vr),St=ut.aI.convert(pt.center||wt);this._normalizeCenter(St),nn=Tt.project(wt),sn=Tt.project(St).sub(nn)}const an=Tt.zoomScale(Yt-St);let ln,cn;pt.around&&(ln=ut.aI.convert(pt.around),cn=Tt.locationPoint(ln));const un=this._zooming||Yt!==St,fn=this._rotating||It!==Mi,_n=this._pitching||vr!==Lt,gn=!Tt.isPaddingEqual(br),T=Tt=>yn=>{if(un&&(Tt.zoom=ut.a2(St,Yt,yn)),fn&&(Tt.bearing=ut.a2(It,Mi,yn)),_n&&(Tt.pitch=ut.a2(Lt,vr,yn)),gn&&(Tt.interpolatePadding(Xt,br,yn),Vr=Tt.centerPoint.add(Ar)),ln)Tt.setLocationAtPoint(ln,cn);else{const ut=Tt.zoomScale(Tt.zoom-St),pt=Yt>St?Math.min(2,an):Math.max(.5,an),wt=Math.pow(pt,1-yn),It=Tt.unproject(nn.add(sn.mult(yn*wt)).mult(ut));Tt.setLocationAtPoint(Tt.renderWorldCopies?It.wrap():It,Vr)}return pt.preloadOnly||this._fireMoveEvents(wt),Tt};if(pt.preloadOnly){const ut=this._emulate(T,pt.duration,Tt);return this._preloadTiles(ut),this}const yn={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=un,this._rotating=fn,this._pitching=_n,this._padding=gn,this._easeId=pt.easeId,this._prepareEase(wt,pt.noMoveStart,yn),this._ease(T(Tt),(ut=>{"sea"===Tt.cameraElevationReference&&Tt.recenterOnTerrain(),this._afterEase(wt,ut)}),pt),this}_prepareEase(pt,wt,Tt={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),wt||Tt.moving||this.fire(new ut.f("movestart",pt)),this._zooming&&!Tt.zooming&&this.fire(new ut.f("zoomstart",pt)),this._rotating&&!Tt.rotating&&this.fire(new ut.f("rotatestart",pt)),this._pitching&&!Tt.pitching&&this.fire(new ut.f("pitchstart",pt))}_fireMoveEvents(pt){this.fire(new ut.f("move",pt)),this._zooming&&this.fire(new ut.f("zoom",pt)),this._rotating&&this.fire(new ut.f("rotate",pt)),this._pitching&&this.fire(new ut.f("pitch",pt))}_afterEase(pt,wt){if(this._easeId&&wt&&this._easeId===wt)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const Tt=this._zooming,St=this._rotating,It=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,Tt&&this.fire(new ut.f("zoomend",pt)),St&&this.fire(new ut.f("rotateend",pt)),It&&this.fire(new ut.f("pitchend",pt)),this.fire(new ut.f("moveend",pt))}flyTo(pt,wt){if(this._prefersReducedMotion(pt)){const Tt=ut.ah(pt,["center","zoom","bearing","pitch","around","padding"]);return this.jumpTo(Tt,wt)}this.stop(),pt=ut.W({offset:[0,0],speed:1.2,curve:1.42,easing:ut.d2},pt);const Tt=this.transform,St=this.getZoom(),It=this.getBearing(),Lt=this.getPitch(),Xt=this.getPadding(),Yt="zoom"in pt?ut.at(+pt.zoom,Tt.minZoom,Tt.maxZoom):St,Mi="bearing"in pt?this._normalizeBearing(pt.bearing,It):It,vr="pitch"in pt?+pt.pitch:Lt,br=this._extendPadding(pt.padding),Ar=Tt.zoomScale(Yt-St),Vr=ut.P.convert(pt.offset);let nn=Tt.centerPoint.add(Vr);const sn=Tt.pointLocation(nn),an=ut.aI.convert(pt.center||sn);this._normalizeCenter(an);const ln=Tt.project(sn),cn=Tt.project(an).sub(ln);let un=pt.curve;const fn=Math.max(Tt.width,Tt.height),_n=fn/Ar,gn=cn.mag();if("minZoom"in pt){const wt=ut.at(Math.min(pt.minZoom,St,Yt),Tt.minZoom,Tt.maxZoom),It=fn/Tt.zoomScale(wt-St);un=Math.sqrt(It/gn*2)}const yn=un*un;function E(ut){const pt=(_n*_n-fn*fn+(ut?-1:1)*yn*yn*gn*gn)/(2*(ut?_n:fn)*yn*gn);return Math.log(Math.sqrt(pt*pt+1)-pt)}function C(ut){return(Math.exp(ut)-Math.exp(-ut))/2}function S(ut){return(Math.exp(ut)+Math.exp(-ut))/2}const xn=E(0);let L=function(ut){return S(xn)/S(xn+un*ut)},P=function(ut){return fn*((S(xn)*(C(pt=xn+un*ut)/S(pt))-C(xn))/yn)/gn;var pt},vn=(E(1)-xn)/un;if(Math.abs(gn)<1e-6||!isFinite(vn)){if(Math.abs(fn-_n)<1e-6)return this.easeTo(pt,wt);const ut=_n<fn?-1:1;vn=Math.abs(Math.log(_n/fn))/un,P=function(){return 0},L=function(pt){return Math.exp(ut*un*pt)}}pt.duration="duration"in pt?+pt.duration:1e3*vn/("screenSpeed"in pt?+pt.screenSpeed/un:+pt.speed),pt.maxDuration&&pt.duration>pt.maxDuration&&(pt.duration=0);const bn=It!==Mi,wn=vr!==Lt,Tn=!Tt.isPaddingEqual(br),z=Tt=>Ar=>{const sn=Ar*vn,un=1/L(sn);Tt.zoom=1===Ar?Yt:St+Tt.scaleZoom(un),bn&&(Tt.bearing=ut.a2(It,Mi,Ar)),wn&&(Tt.pitch=ut.a2(Lt,vr,Ar)),Tn&&(Tt.interpolatePadding(Xt,br,Ar),nn=Tt.centerPoint.add(Vr));const fn=1===Ar?an:Tt.unproject(ln.add(cn.mult(P(sn))).mult(un));return Tt.setLocationAtPoint(Tt.renderWorldCopies?fn.wrap():fn,nn),Tt._updateCameraOnTerrain(),pt.preloadOnly||this._fireMoveEvents(wt),Tt};if(pt.preloadOnly){const ut=this._emulate(z,pt.duration,Tt);return this._preloadTiles(ut),this}return this._zooming=!0,this._rotating=bn,this._pitching=wn,this._padding=Tn,this._prepareEase(wt,!1),this._ease(z(Tt),(()=>this._afterEase(wt)),pt),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(ut){}_cancelRenderFrame(ut){}_stop(ut,pt){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const ut=this._onEaseEnd;this._onEaseEnd=void 0,ut.call(this,pt)}if(!ut){const ut=this.handlers;ut&&ut.stop(!1)}return this}_ease(pt,wt,Tt){!1===Tt.animate||0===Tt.duration?(pt(1),wt()):(this._easeStart=ut.e.now(),this._easeOptions=Tt,this._onEaseFrame=pt,this._onEaseEnd=wt,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const pt=Math.min((ut.e.now()-this._easeStart)/this._easeOptions.duration,1),wt=this._onEaseFrame;wt&&wt(this._easeOptions.easing(pt)),pt<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(pt,wt){pt=ut.au(pt,-180,180);const Tt=Math.abs(pt-wt);return Math.abs(pt-360-wt)<Tt&&(pt-=360),Math.abs(pt+360-wt)<Tt&&(pt+=360),pt}_normalizeCenter(ut){const pt=this.transform;if(pt.maxBounds)return;if("globe"!==pt.projection.name&&!pt.renderWorldCopies)return;const wt=ut.lng-pt.center.lng;ut.lng+=wt>180?-360:wt<-180?360:0}_prefersReducedMotion(pt){return this._respectPrefersReducedMotion&&ut.e.prefersReducedMotion&&!(pt&&pt.essential)}_emulate(ut,pt,wt){const Tt=Math.ceil(15*pt/1e3),St=[],It=ut(wt.clone());for(let ut=0;ut<=Tt;ut++){const pt=It(ut/Tt);St.push(pt.clone())}return St}_preloadTiles(ut,pt){}}class zs{constructor(pt={}){this.options=pt,ut.bp(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(ut){const pt=this.options&&this.options.compact;return this._map=ut,this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=a("button","mapboxgl-ctrl-attrib-button",this._container),a("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=a("div","mapboxgl-ctrl-attrib-inner",this._container),pt&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===pt&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(ut,pt){const wt=this._map._getUIString(`AttributionControl.${pt}`);ut.removeAttribute("title"),ut.firstElementChild&&ut.firstElementChild.setAttribute("title",wt)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let pt=this._editLink;pt||(pt=this._editLink=this._container.querySelector(".mapbox-improve-map"));const wt=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||ut.d8.ACCESS_TOKEN}];if(pt){const Tt=wt.reduce(((ut,pt,Tt)=>(pt.value&&(ut+=`${pt.key}=${pt.value}${Tt<wt.length-1?"&":""}`),ut)),"?");pt.href=`${ut.d8.FEEDBACK_URL}/${Tt}#${Fa(this._map,!0)}`,pt.rel="noopener nofollow",this._setElementTitle(pt,"MapFeedback")}}_updateData(ut){!ut||"metadata"!==ut.sourceDataType&&"visibility"!==ut.sourceDataType&&"style"!==ut.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let ut=[];if(this._map.style.stylesheet){const ut=this._map.style.stylesheet;this.styleOwner=ut.owner,this.styleId=ut.id}const pt=this._map.style._mergedSourceCaches;for(const wt in pt){const Tt=pt[wt];if(Tt.used){const pt=Tt.getSource();pt.attribution&&ut.indexOf(pt.attribution)<0&&ut.push(pt.attribution)}}ut.sort(((ut,pt)=>ut.length-pt.length)),ut=ut.filter(((pt,wt)=>{for(let Tt=wt+1;Tt<ut.length;Tt++)if(ut[Tt].indexOf(pt)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?ut=[...this.options.customAttribution,...ut]:ut.unshift(this.options.customAttribution));const wt=ut.join(" | ");wt!==this._attribHTML&&(this._attribHTML=wt,ut.length?(this._innerContainer.innerHTML=wt,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Os{constructor(){ut.bp(["_updateLogo","_updateCompact"],this)}onAdd(ut){this._map=ut,this._container=a("div","mapboxgl-ctrl");const pt=a("a","mapboxgl-ctrl-logo");return pt.target="_blank",pt.rel="noopener nofollow",pt.href="https://www.mapbox.com/",pt.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),pt.setAttribute("rel","noopener nofollow"),this._container.appendChild(pt),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(ut){ut&&"metadata"!==ut.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const ut=this._map.style._sourceCaches;if(0===Object.entries(ut).length)return!0;for(const pt in ut){const wt=ut[pt].getSource();if(wt.hasOwnProperty("mapbox_logo")&&!wt.mapbox_logo)return!1}return!0}_updateCompact(){const ut=this._container.children;if(ut.length){const pt=ut[0];this._map.getCanvasContainer().offsetWidth<250?pt.classList.add("mapboxgl-compact"):pt.classList.remove("mapboxgl-compact")}}}class Fs{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(ut){const pt=++this._id;return this._queue.push({callback:ut,id:pt,cancelled:!1}),pt}remove(ut){const pt=this._currentlyRunning,wt=pt?this._queue.concat(pt):this._queue;for(const pt of wt)if(pt.id===ut)return void(pt.cancelled=!0)}run(ut=0){const pt=this._currentlyRunning=this._queue;this._queue=[];for(const wt of pt)if(!wt.cancelled&&(wt.callback(ut),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Bs(pt,wt,Tt){if(pt=new ut.aI(pt.lng,pt.lat),wt){const St=new ut.aI(pt.lng-360,pt.lat),It=new ut.aI(pt.lng+360,pt.lat),Lt=360*Math.ceil(Math.abs(pt.lng-Tt.center.lng)/360),Xt=Tt.locationPoint(pt).distSqr(wt),Yt=wt.x<0||wt.y<0||wt.x>Tt.width||wt.y>Tt.height;Tt.locationPoint(St).distSqr(wt)<Xt&&(Yt||Math.abs(St.lng-Tt.center.lng)<Lt)?pt=St:Tt.locationPoint(It).distSqr(wt)<Xt&&(Yt||Math.abs(It.lng-Tt.center.lng)<Lt)&&(pt=It)}for(;Math.abs(pt.lng-Tt.center.lng)>180;){const ut=Tt.locationPoint(pt);if(ut.x>=0&&ut.y>=0&&ut.x<=Tt.width&&ut.y<=Tt.height)break;pt.lng>Tt.center.lng?pt.lng-=360:pt.lng+=360}return pt}const ed={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Ns extends ut.E{constructor(pt,wt){if(super(),(pt instanceof HTMLElement||wt)&&(pt=ut.W({element:pt},wt)),ut.bp(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=pt&&pt.anchor||"center",this._color=pt&&pt.color||"#3FB1CE",this._scale=pt&&pt.scale||1,this._draggable=pt&&pt.draggable||!1,this._clickTolerance=pt&&pt.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=pt&&pt.rotation||0,this._rotationAlignment=pt&&pt.rotationAlignment||"auto",this._pitchAlignment=pt&&pt.pitchAlignment&&pt.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=pt&&pt.occludedOpacity||.2,pt&&pt.element)this._element=pt.element,this._offset=ut.P.convert(pt&&pt.offset||[0,0]);else{this._defaultMarker=!0,this._element=a("div");const wt=41,Tt=27,St=s("svg",{display:"block",height:wt*this._scale+"px",width:Tt*this._scale+"px",viewBox:`0 0 ${Tt} ${wt}`},this._element),It=s("radialGradient",{id:"shadowGradient"},s("defs",{},St));s("stop",{offset:"10%","stop-opacity":.4},It),s("stop",{offset:"100%","stop-opacity":.05},It),s("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},St),s("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},St),s("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},St),s("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},St),this._offset=ut.P.convert(pt&&pt.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(ut=>{ut.preventDefault()})),this._element.addEventListener("mousedown",(ut=>{ut.preventDefault()}));const Tt=this._element.classList;for(const ut in ed)Tt.remove(`mapboxgl-marker-anchor-${ut}`);Tt.add(`mapboxgl-marker-anchor-${this._anchor}`);const St=pt&&pt.className?pt.className.trim().split(/\s+/):[];Tt.add(...St),this._popup=null}addTo(ut){return ut===this._map||(this.remove(),this._map=ut,ut.getCanvasContainer().appendChild(this._element),ut.on("move",this._updateMoving),ut.on("moveend",this._update),ut.on("remove",this._clearFadeTimer),ut._addMarker(this),this.setDraggable(this._draggable),this._update(),ut.on("click",this._onMapClick)),this}remove(){const ut=this._map;return ut&&(ut.off("click",this._onMapClick),ut.off("move",this._updateMoving),ut.off("moveend",this._update),ut.off("mousedown",this._addDragHandler),ut.off("touchstart",this._addDragHandler),ut.off("mouseup",this._onUp),ut.off("touchend",this._onUp),ut.off("mousemove",this._onMove),ut.off("touchmove",this._onMove),ut.off("remove",this._clearFadeTimer),ut._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(pt){return this._lngLat=ut.aI.convert(pt),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(ut){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),ut){if(!("offset"in ut.options)){const pt=38.1,wt=13.5,Tt=Math.sqrt(Math.pow(wt,2)/2);ut.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-pt],"bottom-left":[Tt,-1*(pt-wt+Tt)],"bottom-right":[-Tt,-1*(pt-wt+Tt)],left:[wt,-1*(pt-wt)],right:[-wt,-1*(pt-wt)]}:this._offset}this._popup=ut,ut._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(ut){const pt=ut.code,wt=ut.charCode||ut.keyCode;"Space"!==pt&&"Enter"!==pt&&32!==wt&&13!==wt||this.togglePopup()}_onMapClick(ut){const pt=ut.originalEvent.target,wt=this._element;this._popup&&(pt===wt||wt.contains(pt))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const ut=this._popup;return ut?(ut.isOpen()?(ut.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(ut.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const ut=this._map,pt=this._pos;if(!ut||!pt)return!1;const wt=ut.unproject(pt),Tt=ut.getFreeCameraOptions();if(!Tt.position)return!1;const St=Tt.position.toLngLat();return St.distanceTo(wt)<.9*St.distanceTo(this._lngLat)}_evaluateOpacity(){const pt=this._map;if(!pt)return;const wt=this._pos;if(!wt||wt.x<0||wt.x>pt.transform.width||wt.y<0||wt.y>pt.transform.height)return void this._clearFadeTimer();const Tt=pt.unproject(wt);let St;pt._showingGlobe()&&ut.d9(pt.transform,this._lngLat)?St=0:(St=1-pt._queryFogOpacity(Tt),pt.transform._terrainEnabled()&&pt.getTerrain()&&this._behindTerrain()&&(St*=this._occludedOpacity)),this._element.style.opacity=`${St}`,this._element.style.pointerEvents=St>0?"auto":"none",this._popup&&this._popup._setOpacity(St),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const ut=this._pos;if(!ut||!this._map)return;const pt=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${ut.x}px,${ut.y}px)\n            ${ed[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${pt.x}px,${pt.y}px)\n        `}_calculateXYTransform(){const pt=this._pos,wt=this._map,Tt=this.getPitchAlignment();if(!wt||!pt||"map"!==Tt)return"";if(!wt._showingGlobe()){const ut=wt.getPitch();return ut?`rotateX(${ut}deg)`:""}const St=ut.b0(ut.da(wt.transform,this._lngLat)),It=pt.sub(ut.db(wt.transform)),Lt=Math.abs(It.x)+Math.abs(It.y);if(0===Lt)return"";const Xt=St/Lt;return`rotateX(${-It.y*Xt}deg) rotateY(${It.x*Xt}deg)`}_calculateZTransform(){const pt=this._pos,wt=this._map;if(!wt||!pt)return"";let Tt=0;const St=this.getRotationAlignment();if("map"===St)if(wt._showingGlobe()){const pt=wt.project(new ut.aI(this._lngLat.lng,this._lngLat.lat+.001)),St=wt.project(new ut.aI(this._lngLat.lng,this._lngLat.lat-.001)).sub(pt);Tt=ut.b0(Math.atan2(St.y,St.x))-90}else Tt=-wt.getBearing();else if("horizon"===St){const St=ut.$(4,6,wt.getZoom()),It=ut.db(wt.transform);It.y+=St*wt.transform.height;const Lt=pt.sub(It),Xt=ut.b0(Math.atan2(Lt.y,Lt.x));Tt=(Xt>90?Xt-270:Xt+90)*(1-St)}return Tt+=this._rotation,Tt?`rotateZ(${Tt}deg)`:""}_update(ut){cancelAnimationFrame(this._updateFrameId);const pt=this._map;pt&&(pt.transform.renderWorldCopies&&(this._lngLat=Bs(this._lngLat,this._pos,pt.transform)),this._pos=pt.project(this._lngLat),!0===ut?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),pt._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(pt._showingGlobe()||pt.getTerrain()||pt.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(pt){return this._offset=ut.P.convert(pt),this._update(),this}addClassName(ut){return this._element.classList.add(ut),this}removeClassName(ut){return this._element.classList.remove(ut),this}toggleClassName(ut){return this._element.classList.toggle(ut)}_onMove(pt){const wt=this._map;if(!wt)return;const Tt=this._pointerdownPos,St=this._positionDelta;if(Tt&&St){if(!this._isDragging){const ut=this._clickTolerance||wt._clickTolerance;if(pt.point.dist(Tt)<ut)return;this._isDragging=!0}this._pos=pt.point.sub(St),this._lngLat=wt.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new ut.f("dragstart"))),this.fire(new ut.f("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const pt=this._map;pt&&(pt.off("mousemove",this._onMove),pt.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new ut.f("dragend")),this._state="inactive"}_addDragHandler(ut){const pt=this._map,wt=this._pos;pt&&wt&&this._element.contains(ut.originalEvent.target)&&(ut.preventDefault(),this._positionDelta=ut.point.sub(wt),this._pointerdownPos=ut.point,this._state="pending",pt.on("mousemove",this._onMove),pt.on("touchmove",this._onMove),pt.once("mouseup",this._onUp),pt.once("touchend",this._onUp))}setDraggable(ut){this._draggable=!!ut;const pt=this._map;return pt&&(ut?(pt.on("mousedown",this._addDragHandler),pt.on("touchstart",this._addDragHandler)):(pt.off("mousedown",this._addDragHandler),pt.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(ut){return this._rotation=ut||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(ut){return this._rotationAlignment=ut||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(ut){return this._pitchAlignment=ut||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(ut){return this._occludedOpacity=ut||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const td={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},id=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function js(pt=new ut.P(0,0),wt="bottom"){if("number"==typeof pt){const Tt=Math.round(Math.sqrt(.5*Math.pow(pt,2)));switch(wt){case"top":return new ut.P(0,pt);case"top-left":return new ut.P(Tt,Tt);case"top-right":return new ut.P(-Tt,Tt);case"bottom":return new ut.P(0,-pt);case"bottom-left":return new ut.P(Tt,-Tt);case"bottom-right":return new ut.P(-Tt,-Tt);case"left":return new ut.P(pt,0);case"right":return new ut.P(-pt,0)}return new ut.P(0,0)}return pt instanceof ut.P||Array.isArray(pt)?ut.P.convert(pt):ut.P.convert(pt[wt]||[0,0])}class Vs{constructor(ut){this.jumpTo(ut)}getValue(pt){if(pt<=this._startTime)return this._start;if(pt>=this._endTime)return this._end;const wt=ut.b9((pt-this._startTime)/(this._endTime-this._startTime));return this._start*(1-wt)+this._end*wt}isEasing(ut){return ut>=this._startTime&&ut<=this._endTime}jumpTo(ut){this._startTime=-1/0,this._endTime=-1/0,this._start=ut,this._end=ut}easeTo(ut,pt,wt){this._start=this.getValue(pt),this._end=ut,this._startTime=pt,this._endTime=pt+wt}}const rd={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Zs{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}const nd={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},od={showCompass:!0,showZoom:!0,visualizePitch:!1};class $s{constructor(pt,wt,Tt=!1){this._clickTolerance=10,this.element=wt,this.mouseRotate=new rs({clickTolerance:pt.dragRotate._mouseRotate._clickTolerance}),this.map=pt,Tt&&(this.mousePitch=new as({clickTolerance:pt.dragRotate._mousePitch._clickTolerance})),ut.bp(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),wt.addEventListener("mousedown",this.mousedown),wt.addEventListener("touchstart",this.touchstart,{passive:!1}),wt.addEventListener("touchmove",this.touchmove),wt.addEventListener("touchend",this.touchend),wt.addEventListener("touchcancel",this.reset)}down(ut,pt){this.mouseRotate.mousedown(ut,pt),this.mousePitch&&this.mousePitch.mousedown(ut,pt),h()}move(ut,pt){const wt=this.map,Tt=this.mouseRotate.mousemoveWindow(ut,pt),St=Tt&&Tt.bearingDelta;if(St&&wt.setBearing(wt.getBearing()+St),this.mousePitch){const Tt=this.mousePitch.mousemoveWindow(ut,pt),St=Tt&&Tt.pitchDelta;St&&wt.setPitch(wt.getPitch()+St)}}off(){const ut=this.element;ut.removeEventListener("mousedown",this.mousedown),ut.removeEventListener("touchstart",this.touchstart,{passive:!1}),ut.removeEventListener("touchmove",this.touchmove),ut.removeEventListener("touchend",this.touchend),ut.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){u(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(pt){this.down(ut.W({},pt,{ctrlKey:!0,preventDefault:()=>pt.preventDefault()}),p(this.element,pt)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(ut){this.move(ut,p(this.element,ut))}mouseup(ut){this.mouseRotate.mouseupWindow(ut),this.mousePitch&&this.mousePitch.mouseupWindow(ut),this.offTemp()}touchstart(ut){1!==ut.targetTouches.length?this.reset():(this._startPos=this._lastPos=f(this.element,ut.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>ut.preventDefault()},this._startPos))}touchmove(ut){1!==ut.targetTouches.length?this.reset():(this._lastPos=f(this.element,ut.targetTouches)[0],this.move({preventDefault:()=>ut.preventDefault()},this._lastPos))}touchend(ut){0===ut.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const sd={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},ad={maxWidth:100,unit:"metric"},md={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Cd={version:ut.dt,supported:pt,setRTLTextPlugin:ut.dv,getRTLTextPluginStatus:ut.dw,Map:class extends Ms{constructor(pt){ut.dc.mark(ut.dd.create);const wt=pt;if(null!=(pt=ut.W({},nd,pt)).minZoom&&null!=pt.maxZoom&&pt.minZoom>pt.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=pt.minPitch&&null!=pt.maxPitch&&pt.minPitch>pt.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=pt.minPitch&&pt.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=pt.maxPitch&&pt.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(pt.antialias&&ut.de(window)&&(pt.antialias=!1,ut.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new pi(pt.minZoom,pt.maxZoom,pt.minPitch,pt.maxPitch,pt.renderWorldCopies),pt),this._repaint=!!pt.repaint,this._interactive=pt.interactive,this._minTileCacheSize=pt.minTileCacheSize,this._maxTileCacheSize=pt.maxTileCacheSize,this._failIfMajorPerformanceCaveat=pt.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=pt.preserveDrawingBuffer,this._antialias=pt.antialias,this._trackResize=pt.trackResize,this._bearingSnap=pt.bearingSnap,this._refreshExpiredTiles=pt.refreshExpiredTiles,this._fadeDuration=pt.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=pt.crossSourceCollisions,this._collectResourceTiming=pt.collectResourceTiming,this._language=this._parseLanguage(pt.language),this._worldview=pt.worldview,this._renderTaskQueue=new Fs,this._domRenderTaskQueue=new Fs,this._controls=[],this._markers=[],this._popups=[],this._mapId=ut.df(),this._locale=ut.W({},rd,pt.locale),this._clickTolerance=pt.clickTolerance,this._cooperativeGestures=pt.cooperativeGestures,this._performanceMetricsCollection=pt.performanceMetricsCollection,this._tessellationStep=pt.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Vs(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._lastDirtyFrameId=0,this._requestManager=new ut.dg(pt.transformRequest,pt.accessToken,pt.testMode),this._silenceAuthErrors=!!pt.testMode,this._contextCreateOptions=pt.contextCreateOptions?{...pt.contextCreateOptions}:{},"string"==typeof pt.container){const ut=document.getElementById(pt.container);if(!ut)throw new Error(`Container '${pt.container.toString()}' not found.`);this._container=ut}else{if(!(pt.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=pt.container}if(this._container.childNodes.length>0&&ut.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),pt.maxBounds&&this.setMaxBounds(pt.maxBounds),ut.bp(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Zs),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Rs(this,pt),this._localFontFamily=pt.localFontFamily,this._localIdeographFontFamily=pt.localIdeographFontFamily,(pt.style||!pt.testMode)&&this.setStyle(pt.style||ut.d8.DEFAULT_STYLE,{config:pt.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),pt.projection&&this.setProjection(pt.projection),pt.hash&&(this._hash=new Oa("string"==typeof pt.hash&&pt.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==wt.center&&null==wt.zoom||(this.transform._unmodified=!1),this.jumpTo({center:pt.center,zoom:pt.zoom,bearing:pt.bearing,pitch:pt.pitch});const Tt=pt.bounds;Tt&&(this.resize(),this.fitBounds(Tt,ut.W({},pt.fitBoundsOptions,{duration:0})))}this.resize(),pt.attributionControl&&this.addControl(new zs({customAttribution:pt.customAttribution})),this._logoControl=new Os,this.addControl(this._logoControl,pt.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(pt=>{this._update("style"===pt.dataType),this.fire(new ut.f(`${pt.dataType}data`,pt))})),this.on("dataloading",(pt=>{this.fire(new ut.f(`${pt.dataType}dataloading`,pt))}))}_getMapId(){return this._mapId}addControl(pt,wt){if(void 0===wt&&(wt=pt.getDefaultPosition?pt.getDefaultPosition():"top-right"),!pt||!pt.onAdd)return this.fire(new ut.d(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const Tt=pt.onAdd(this);this._controls.push(pt);const St=this._controlPositions[wt];return-1!==wt.indexOf("bottom")?St.insertBefore(Tt,St.firstChild):St.appendChild(Tt),this}removeControl(pt){if(!pt||!pt.onRemove)return this.fire(new ut.d(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const wt=this._controls.indexOf(pt);return wt>-1&&this._controls.splice(wt,1),pt.onRemove(this),this}hasControl(ut){return this._controls.indexOf(ut)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(pt){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const wt=!this._moving;return wt&&this.fire(new ut.f("movestart",pt)).fire(new ut.f("move",pt)),this.fire(new ut.f("resize",pt)),wt&&this.fire(new ut.f("moveend",pt)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(pt){return this.transform.setMaxBounds(ut.ai.convert(pt)),this._update()}setMinZoom(pt){if((pt=pt??-2)>=-2&&pt<=this.transform.maxZoom)return this.transform.minZoom=pt,this._update(),this.getZoom()<pt?this.setZoom(pt):this.fire(new ut.f("zoomstart")).fire(new ut.f("zoom")).fire(new ut.f("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(pt){if((pt=pt??22)>=this.transform.minZoom)return this.transform.maxZoom=pt,this._update(),this.getZoom()>pt?this.setZoom(pt):this.fire(new ut.f("zoomstart")).fire(new ut.f("zoom")).fire(new ut.f("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(pt){if((pt=pt??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(pt>=0&&pt<=this.transform.maxPitch)return this.transform.minPitch=pt,this._update(),this.getPitch()<pt?this.setPitch(pt):this.fire(new ut.f("pitchstart")).fire(new ut.f("pitch")).fire(new ut.f("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(pt){if((pt=pt??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(pt>=this.transform.minPitch)return this.transform.maxPitch=pt,this._update(),this.getPitch()>pt?this.setPitch(pt):this.fire(new ut.f("pitchstart")).fire(new ut.f("pitch")).fire(new ut.f("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(ut){return this.transform.renderWorldCopies=ut,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(ut){return"auto"===ut?navigator.language:Array.isArray(ut)?0===ut.length?void 0:ut.map((ut=>"auto"===ut?navigator.language:ut)):ut}setLanguage(ut){const pt=this._parseLanguage(ut);if(!this.style||pt===this._language)return this;this._language=pt,this.style.reloadSources();for(const ut of this._controls)ut._setLanguage&&ut._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(ut){return this.style&&ut!==this._worldview?(this._worldview=ut,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(ut){return this._lazyInitEmptyStyle(),ut?"string"==typeof ut&&(ut={name:ut}):ut=null,this._useExplicitProjection=!!ut,this._prioritizeAndUpdateProjection(ut,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const pt=this.transform,wt=pt.projection.name;let Tt;"globe"===wt&&pt.zoom>=ut.aU?(pt.setMercatorFromTransition(),Tt=!0):"mercator"===wt&&pt.zoom<ut.aU&&(pt.setProjection({name:"globe"}),Tt=!0),Tt&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(ut,pt){return this._updateProjection(ut||pt||{name:"mercator"})}_updateProjection(pt){let wt;return wt="globe"===pt.name&&this.transform.zoom>=ut.aU?this.transform.setMercatorFromTransition():this.transform.setProjection(pt),this.style.applyProjectionUpdate(),wt&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(pt){return this.transform.locationPoint3D(ut.aI.convert(pt))}unproject(pt){return this.transform.pointLocation3D(ut.P.convert(pt))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(ut,pt,wt){if("mouseenter"===ut||"mouseover"===ut){let Tt=!1;const r=St=>{const It=pt.filter((ut=>this.getLayer(ut))),Lt=It.length?this.queryRenderedFeatures(St.point,{layers:It}):[];Lt.length?Tt||(Tt=!0,wt.call(this,new Za(ut,this,St.originalEvent,{features:Lt}))):Tt=!1},a=()=>{Tt=!1};return{layers:new Set(pt),listener:wt,delegates:{mousemove:r,mouseout:a}}}if("mouseleave"===ut||"mouseout"===ut){let Tt=!1;const r=St=>{const It=pt.filter((ut=>this.getLayer(ut)));(It.length?this.queryRenderedFeatures(St.point,{layers:It}):[]).length?Tt=!0:Tt&&(Tt=!1,wt.call(this,new Za(ut,this,St.originalEvent)))},a=pt=>{Tt&&(Tt=!1,wt.call(this,new Za(ut,this,pt.originalEvent)))};return{layers:new Set(pt),listener:wt,delegates:{mousemove:r,mouseout:a}}}{const o=ut=>{const Tt=pt.filter((ut=>this.getLayer(ut))),St=Tt.length?this.queryRenderedFeatures(ut.point,{layers:Tt}):[];St.length&&(ut.features=St,wt.call(this,ut),delete ut.features)};return{layers:new Set(pt),listener:wt,delegates:{[ut]:o}}}}on(ut,pt,wt){if("function"==typeof pt||void 0===wt)return super.on(ut,pt);if(Array.isArray(pt)||(pt=[pt]),pt)for(const ut of pt)if(!this._isValidId(ut))return this;const Tt=this._createDelegatedListener(ut,pt,wt);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[ut]=this._delegatedListeners[ut]||[],this._delegatedListeners[ut].push(Tt);for(const ut in Tt.delegates)this.on(ut,Tt.delegates[ut]);return this}once(ut,pt,wt){if("function"==typeof pt||void 0===wt)return super.once(ut,pt);if(Array.isArray(pt)||(pt=[pt]),pt)for(const ut of pt)if(!this._isValidId(ut))return this;const Tt=this._createDelegatedListener(ut,pt,wt);for(const ut in Tt.delegates)this.once(ut,Tt.delegates[ut]);return this}off(ut,pt,wt){if("function"==typeof pt||void 0===wt)return super.off(ut,pt);const Tt=new Set(Array.isArray(pt)?pt:[pt]);for(const ut of Tt)if(!this._isValidId(ut))return this;const r=(ut,pt)=>{if(ut.size!==pt.size)return!1;for(const wt of ut)if(!pt.has(wt))return!1;return!0},St=this._delegatedListeners?this._delegatedListeners[ut]:void 0;return St&&(ut=>{for(let pt=0;pt<ut.length;pt++){const St=ut[pt];if(St.listener===wt&&r(St.layers,Tt)){for(const ut in St.delegates)this.off(ut,St.delegates[ut]);return ut.splice(pt,1),this}}})(St),this}queryRenderedFeatures(pt,wt){if(!this.style)return[];if(void 0!==wt||void 0===pt||pt instanceof ut.P||Array.isArray(pt)||(wt=pt,pt=void 0),pt=pt||[[0,0],[this.transform.width,this.transform.height]],(wt=wt||{}).layers&&Array.isArray(wt.layers))for(const ut of wt.layers)if(!this._isValidId(ut))return[];return this.style.queryRenderedFeatures(pt,wt,this.transform)}querySourceFeatures(ut,pt){return this._isValidId(ut)?this.style.querySourceFeatures(ut,pt):[]}isPointOnSurface(pt){const{name:wt}=this.transform.projection;return"globe"!==wt&&"mercator"!==wt&&ut.w(`${wt} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(ut.P.convert(pt))}setStyle(pt,wt){return wt=ut.W({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},wt),this.style&&pt&&!1!==wt.diff&&wt.localFontFamily===this._localFontFamily&&wt.localIdeographFontFamily===this._localIdeographFontFamily&&!wt.config?(this.style._diffStyle(pt,((Tt,St)=>{Tt?(ut.w(`Unable to perform style diff: ${String(Tt.message||Tt.error||Tt)}. Rebuilding the style from scratch.`),this._updateStyle(pt,wt)):St&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=wt.localIdeographFontFamily,this._localFontFamily=wt.localFontFamily,this._updateStyle(pt,wt))}_getUIString(ut){const pt=this._locale[ut];if(null==pt)throw new Error(`Missing UI string '${ut}'`);return pt}_updateStyle(pt,wt){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),pt){const Tt=ut.W({},wt);wt&&wt.config&&(Tt.initialConfig=wt.config,delete Tt.config),this.style=new Ma(this,Tt).load(pt),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Ma(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(ut.w("There is no style added to the map."),!1)}_isValidId(pt){return null==pt?(this.fire(new ut.d(new Error("IDs can't be empty."))),!1):!ut.cV(pt)||(this.fire(new ut.d(new Error(`IDs can't contain special symbols: "${pt}".`))),!1)}addSource(ut,pt){return this._isValidId(ut)?(this._lazyInitEmptyStyle(),this.style.addSource(ut,pt),this._update(!0)):this}isSourceLoaded(ut){return!!this._isValidId(ut)&&!!this.style&&this.style._isSourceCacheLoaded(ut)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(ut,pt,wt){this._lazyInitEmptyStyle(),this.style.addSourceType(ut,pt,wt)}removeSource(ut){return this._isValidId(ut)?(this.style.removeSource(ut),this._updateTerrain(),this._update(!0)):this}getSource(ut){return this._isValidId(ut)?this.style.getOwnSource(ut):null}addImage(pt,wt,{pixelRatio:Tt=1,sdf:St=!1,stretchX:It,stretchY:Lt,content:Xt}={}){if(this._lazyInitEmptyStyle(),wt instanceof HTMLImageElement||ImageBitmap&&wt instanceof ImageBitmap){const{width:Yt,height:Mi,data:vr}=ut.e.getImageData(wt);this.style.addImage(pt,{data:new ut.i({width:Yt,height:Mi},vr),pixelRatio:Tt,stretchX:It,stretchY:Lt,content:Xt,sdf:St,version:0})}else if(void 0===wt.width||void 0===wt.height)this.fire(new ut.d(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:Yt,height:Mi}=wt,vr=wt;this.style.addImage(pt,{data:new ut.i({width:Yt,height:Mi},new Uint8Array(vr.data)),pixelRatio:Tt,stretchX:It,stretchY:Lt,content:Xt,sdf:St,version:0,userImage:vr}),vr.onAdd&&vr.onAdd(this,pt)}}updateImage(pt,wt){this._lazyInitEmptyStyle();const Tt=this.style.getImage(pt);if(!Tt)return void this.fire(new ut.d(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const St=wt instanceof HTMLImageElement||ImageBitmap&&wt instanceof ImageBitmap?ut.e.getImageData(wt):wt,{width:It,height:Lt,data:Xt}=St;if(void 0===It||void 0===Lt)return void this.fire(new ut.d(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(It!==Tt.data.width||Lt!==Tt.data.height)return void this.fire(new ut.d(new Error(`The width and height of the updated image (${It}, ${Lt})\n                must be that same as the previous version of the image\n                (${Tt.data.width}, ${Tt.data.height})`)));const Yt=!(wt instanceof HTMLImageElement||ImageBitmap&&wt instanceof ImageBitmap);Tt.data.replace(Xt,Yt),this.style.updateImage(pt,Tt)}hasImage(pt){return pt?!!this.style&&!!this.style.getImage(pt):(this.fire(new ut.d(new Error("Missing required image id"))),!1)}removeImage(ut){this.style.removeImage(ut)}loadImage(pt,wt){ut.h(this._requestManager.transformRequest(pt,ut.R.Image),((pt,Tt)=>{wt(pt,Tt instanceof HTMLImageElement?ut.e.getImageData(Tt):Tt)}))}listImages(){return this.style.listImages()}addModel(ut,pt){this._lazyInitEmptyStyle(),this.style.addModel(ut,pt)}hasModel(pt){return pt?this.style.hasModel(pt):(this.fire(new ut.d(new Error("Missing required model id"))),!1)}removeModel(ut){this.style.removeModel(ut)}listModels(){return this.style.listModels()}addLayer(ut,pt){return this._isValidId(ut.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(ut,pt),this._update(!0)):this}getSlot(ut){const pt=this.getLayer(ut);return pt&&pt.slot||null}setSlot(ut,pt){return this.style.setSlot(ut,pt),this.style.mergeLayers(),this._update(!0)}addImport(ut,pt){return this.style.addImport(ut,pt),this}updateImport(ut,pt){return"string"!=typeof pt&&pt.id!==ut?(this.removeImport(ut),this.addImport(pt)):(this.style.updateImport(ut,pt),this._update(!0))}removeImport(ut){return this.style.removeImport(ut),this}moveImport(ut,pt){return this.style.moveImport(ut,pt),this._update(!0)}moveLayer(ut,pt){return this._isValidId(ut)?(this.style.moveLayer(ut,pt),this._update(!0)):this}removeLayer(ut){return this._isValidId(ut)?(this.style.removeLayer(ut),this._update(!0)):this}getLayer(ut){return this._isValidId(ut)?this.style.getOwnLayer(ut):null}getSlots(){return this.style.getSlots()}setLayerZoomRange(ut,pt,wt){return this._isValidId(ut)?(this.style.setLayerZoomRange(ut,pt,wt),this._update(!0)):this}setFilter(ut,pt,wt={}){return this._isValidId(ut)?(this.style.setFilter(ut,pt,wt),this._update(!0)):this}getFilter(ut){return this._isValidId(ut)?this.style.getFilter(ut):null}setPaintProperty(ut,pt,wt,Tt={}){return this._isValidId(ut)?(this.style.setPaintProperty(ut,pt,wt,Tt),this._update(!0)):this}getPaintProperty(ut,pt){return this._isValidId(ut)?this.style.getPaintProperty(ut,pt):null}setLayoutProperty(ut,pt,wt,Tt={}){return this._isValidId(ut)?(this.style.setLayoutProperty(ut,pt,wt,Tt),this._update(!0)):this}getLayoutProperty(ut,pt){return this._isValidId(ut)?this.style.getLayoutProperty(ut,pt):null}getSchema(ut){return this.style.getSchema(ut)}setSchema(ut,pt){return this.style.setSchema(ut,pt),this._update(!0)}getConfig(ut){return this.style.getConfig(ut)}setConfig(ut,pt){return this.style.setConfig(ut,pt),this._update(!0)}getConfigProperty(ut,pt){return this.style.getConfigProperty(ut,pt)}setConfigProperty(ut,pt,wt){return this.style.setConfigProperty(ut,pt,wt),this._update(!0)}setLights(ut){if(this._lazyInitEmptyStyle(),ut&&1===ut.length&&"flat"===ut[0].type){const pt=ut[0];pt.properties?this.style.setFlatLight(pt.properties,pt.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(ut),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const ut=this.style.getLights()||[];return 0===ut.length&&ut.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),ut}setLight(ut,pt={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:ut}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(ut){return this._lazyInitEmptyStyle(),!ut&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(ut),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(ut){return this._lazyInitEmptyStyle(),this.style.setFog(ut),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setColorTheme(ut){return this._lazyInitEmptyStyle(),this.style.setColorTheme(ut),this._update(!0)}setCamera(ut){return this.style.setCamera(ut),this._triggerCameraUpdate(ut)}_triggerCameraUpdate(ut){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===ut["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(pt){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(ut.aI.convert(pt),this.transform):0}setFeatureState(ut,pt){return this._isValidId(ut.source)?(this.style.setFeatureState(ut,pt),this._update()):this}removeFeatureState(ut,pt){return this._isValidId(ut.source)?(this.style.removeFeatureState(ut,pt),this._update()):this}getFeatureState(ut){return this._isValidId(ut.source)?this.style.getFeatureState(ut):null}_updateContainerDimensions(){if(!this._container)return;const ut=this._container.getBoundingClientRect().width||400,pt=this._container.getBoundingClientRect().height||300;let wt,Tt,St,It=this._container;for(;It&&(!Tt||!St);){const ut=window.getComputedStyle(It).transform;ut&&"none"!==ut&&(wt=ut.match(/matrix.*\((.+)\)/)[1].split(", "),wt[0]&&"0"!==wt[0]&&"1"!==wt[0]&&(Tt=wt[0]),wt[3]&&"0"!==wt[3]&&"1"!==wt[3]&&(St=wt[3])),It=It.parentElement}this._containerWidth=Tt?Math.abs(ut/Tt):ut,this._containerHeight=St?Math.abs(pt/St):pt}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&ut.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const ut=this._container;ut.classList.add("mapboxgl-map"),(this._missingCSSCanary=a("div","mapboxgl-canary",ut)).style.visibility="hidden",this._detectMissingCSS();const pt=this._canvasContainer=a("div","mapboxgl-canvas-container",ut);this._canvas=a("canvas","mapboxgl-canvas",pt),this._interactive&&(pt.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const wt=this._controlContainer=a("div","mapboxgl-control-container",ut),Tt=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((ut=>{Tt[ut]=a("div",`mapboxgl-ctrl-${ut}`,wt)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(pt,wt){const Tt=ut.e.devicePixelRatio||1;this._canvas.width=Tt*Math.ceil(pt),this._canvas.height=Tt*Math.ceil(wt),this._canvas.style.width=`${pt}px`,this._canvas.style.height=`${wt}px`}_addMarker(ut){this._markers.push(ut)}_removeMarker(ut){const pt=this._markers.indexOf(ut);-1!==pt&&this._markers.splice(pt,1)}_addPopup(ut){this._popups.push(ut)}_removePopup(ut){const pt=this._popups.indexOf(ut);-1!==pt&&this._popups.splice(pt,1)}_setupPainter(){const wt=ut.W({},pt.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),Tt=this._canvas.getContext("webgl2",wt);Tt?(ut.dh(Tt,!0),this.painter=new Rr(Tt,this._contextCreateOptions,this.transform,this._tp),this.on("data",(ut=>{"source"===ut.dataType&&this.painter.setTileLoadedFlag(!0)})),ut.di.testSupport(Tt)):this.fire(new ut.d(new Error("Failed to initialize WebGL")))}_contextLost(pt){pt.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new ut.f("webglcontextlost",{originalEvent:pt}))}_contextRestored(pt){this._setupPainter(),this.resize(),this._update(),this.fire(new ut.f("webglcontextrestored",{originalEvent:pt}))}_onMapScroll(ut){if(ut.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty&&!this._occlusionOpacityChanged&&this._occlusionCriteriaSatisfied()}_update(ut){return this.style?(this._styleDirty=this._styleDirty||ut,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(ut){return this._update(),this._renderTaskQueue.add(ut)}_cancelRenderFrame(ut){this._renderTaskQueue.remove(ut)}_requestDomTask(ut){!this.loaded()||this.loaded()&&!this.isMoving()?ut():this._domRenderTaskQueue.add(ut)}_render(pt){let wt;this.fire(new ut.f("renderstart")),++this._frameId;const Tt=this.painter.context.extTimerQuery,St=ut.e.now(),It=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(wt=It.createQuery(),It.beginQuery(Tt.TIME_ELAPSED_EXT,wt)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(pt),this._domRenderTaskQueue.run(pt),this._removed)return;this._updateProjectionTransition();const Lt=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const pt=this.transform.zoom,wt=this.transform.pitch,Tt=ut.e.now(),St=new ut.X(pt,{now:Tt,fadeDuration:Lt,pitch:wt,transition:this.style.transition});this.style.update(St)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let Xt=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),Xt=this._updateAverageElevation(St),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):Xt=this._updateAverageElevation(St);const Yt=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,Lt,this._crossSourceCollisions,this.painter.replacementSource);if(Yt&&(this._placementDirty=Yt.needsRerender,this._occlusionOpacityChanged=Yt.occlusionQueryBasedOpacityChanged),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:Lt,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new ut.f("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,ut.dc.mark(ut.dd.load),this.fire(new ut.f("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),wt){const pt=ut.e.now()-St;It.endQuery(Tt.TIME_ELAPSED_EXT),setTimeout((()=>{const Tt=It.getQueryParameter(wt,It.QUERY_RESULT)/1e6;It.deleteQuery(wt),this.fire(new ut.f("gpu-timing-frame",{cpuTime:pt,gpuTime:Tt}))}),50)}if(this.listens("gpu-timing-layer")){const pt=this.painter.collectGpuTimers();setTimeout((()=>{const wt=this.painter.queryGpuTimers(pt);this.fire(new ut.f("gpu-timing-layer",{layerTimes:wt}))}),50)}if(this.listens("gpu-timing-deferred-render")){const pt=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const wt=this.painter.queryGpuTimeDeferredRender(pt);this.fire(new ut.f("gpu-timing-deferred-render",{gpuTime:wt}))}),50)}const Mi=this._sourcesDirty||this._styleDirty||this._placementDirty||this._occlusionOpacityChanged||Xt;if((this._sourcesDirty||this._styleDirty||Xt||this._occlusionOpacityChanged)&&(this._lastDirtyFrameId=this._frameId),Mi||this._repaint||!this._occlusionCriteriaSatisfied())this.triggerRepaint();else{const pt=!this.isMoving()&&this.loaded();if(pt&&(Xt=this._updateAverageElevation(St,!0)),Xt)this.triggerRepaint();else if(this._triggerFrame(!1),pt&&(this.fire(new ut.f("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const pt=this._calculateSpeedIndex();this.fire(new ut.f("speedindexcompleted",{speedIndex:pt})),this.speedIndexTiming=!1}}this._loaded&&!this._fullyLoaded&&!Mi&&this._occlusionCriteriaSatisfied()&&(this._fullyLoaded=!0,ut.dc.mark(ut.dd.fullLoad),this._performanceMetricsCollection&&ut.dj(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(ut){for(const pt of this._markers)ut&&!this.getRenderWorldCopies()&&(pt._lngLat=pt._lngLat.wrap()),pt._update();for(const pt of this._popups)!ut||this.getRenderWorldCopies()||pt._trackPointer||(pt._lngLat=pt._lngLat.wrap()),pt._update()}_updateAverageElevation(ut,pt=!1){const i=ut=>(this.transform.averageElevation=ut,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const wt=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(wt||(pt||ut-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(ut)){const pt=this.transform.averageElevation;let Tt=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(Tt)?Tt=0:this._averageElevationLastSampledAt=ut;const St=Math.abs(pt-Tt);if(St>1){if(this._isInitialLoad||wt)return this._averageElevation.jumpTo(Tt),i(Tt);this._averageElevation.easeTo(Tt,ut,300)}else if(St>1e-4)return this._averageElevation.jumpTo(Tt),i(Tt)}return!!this._averageElevation.isEasing(ut)&&i(this._averageElevation.getValue(ut))}_authenticate(){ut.dk(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(pt=>{if(pt&&(pt.message===ut.dl||401===pt.status)){const pt=this.painter.context.gl;ut.dh(pt,!1),this._logoControl instanceof Os&&this._logoControl._updateLogo(),pt&&pt.clear(pt.DEPTH_BUFFER_BIT|pt.COLOR_BUFFER_BIT|pt.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new ut.d(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),ut.dm(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&ut.dn(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const ut=this._isDragging();this.painter.updateTerrain(this.style,ut)}_calculateSpeedIndex(){const ut=this.painter.canvasCopy(),pt=this.painter.getCanvasCopiesAndTimestamps();pt.timeStamps.push(performance.now());const wt=this.painter.context.gl,Tt=wt.createFramebuffer();function r(ut){wt.framebufferTexture2D(wt.FRAMEBUFFER,wt.COLOR_ATTACHMENT0,wt.TEXTURE_2D,ut,0);const pt=new Uint8Array(wt.drawingBufferWidth*wt.drawingBufferHeight*4);return wt.readPixels(0,0,wt.drawingBufferWidth,wt.drawingBufferHeight,wt.RGBA,wt.UNSIGNED_BYTE,pt),pt}return wt.bindFramebuffer(wt.FRAMEBUFFER,Tt),this._canvasPixelComparison(r(ut),pt.canvasCopies.map(r),pt.timeStamps)}_canvasPixelComparison(ut,pt,wt){let Tt=wt[1]-wt[0];const St=ut.length/4;for(let It=0;It<pt.length;It++){const Lt=pt[It];let Xt=0;for(let pt=0;pt<Lt.length;pt+=4)Lt[pt]===ut[pt]&&Lt[pt+1]===ut[pt+1]&&Lt[pt+2]===ut[pt+2]&&Lt[pt+3]===ut[pt+3]&&(Xt+=1);Tt+=(wt[It+2]-wt[It+1])*(1-Xt/St)}return Tt}remove(){this._hash&&this._hash.remove();for(const ut of this._controls)ut.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const pt=this.painter.context.gl.getExtension("WEBGL_lose_context");pt&&pt.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ut.dp(this.painter.context.gl),ut.dq.remove(),ut.dr.remove(),this._removed=!0,this.fire(new ut.f("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(pt){this._renderNextFrame=this._renderNextFrame||pt,this.style&&!this._frame&&(this._frame=ut.e.frame((ut=>{const pt=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,pt&&this._render(ut)})))}_preloadTiles(pt){const wt=this.style?this.style.getSourceCaches():[];return ut.ds(wt,((ut,wt)=>ut._preloadTiles(pt,wt)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(ut){this._trackResize&&this.resize({originalEvent:ut})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(ut){this._showTileBoundaries!==ut&&(this._showTileBoundaries=ut,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(ut){this._showParseStatus!==ut&&(this._showParseStatus=ut,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(ut){this._showTerrainWireframe!==ut&&(this._showTerrainWireframe=ut,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(ut){this._showLayers2DWireframe!==ut&&(this._showLayers2DWireframe=ut,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(ut){this._showLayers3DWireframe!==ut&&(this._showLayers3DWireframe=ut,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(ut){this._speedIndexTiming!==ut&&(this._speedIndexTiming=ut,this._update())}get showPadding(){return!!this._showPadding}set showPadding(ut){this._showPadding!==ut&&(this._showPadding=ut,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(ut){this._showCollisionBoxes!==ut&&(this._showCollisionBoxes=ut,this._tp.refreshUI(),ut?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(ut){this._showOverdrawInspector!==ut&&(this._showOverdrawInspector=ut,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(ut){this._repaint!==ut&&(this._repaint=ut,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(ut){this._vertices=ut,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(ut){this._showTileAABBs!==ut&&(this._showTileAABBs=ut,this._tp.refreshUI(),ut&&this._update())}_setCacheLimits(pt,wt){ut.du(pt,wt)}_occlusionCriteriaSatisfied(){const ut=this.style&&(this.style.has3DLayers()||this.style.terrain&&!this.style.disableElevatedTerrain);return!(this.style&&this.style.hasSymbolLayers()&&ut&&this.painter)||this._frameId-this._lastDirtyFrameId>5+2*this.painter.symbolParams.occlusionQueryFrameWindow}get version(){return ut.dt}},NavigationControl:class{constructor(pt){this.options=ut.W({},od,pt),this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(ut=>ut.preventDefault())),this.options.showZoom&&(ut.bp(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(ut=>{this._map&&this._map.zoomIn({},{originalEvent:ut})})),a("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(ut=>{this._map&&this._map.zoomOut({},{originalEvent:ut})})),a("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(ut.bp(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(ut=>{const pt=this._map;pt&&(this.options.visualizePitch?pt.resetNorthPitch({},{originalEvent:ut}):pt.resetNorth({},{originalEvent:ut}))})),this._compassIcon=a("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const ut=this._map;if(!ut)return;const pt=ut.getZoom(),wt=pt===ut.getMaxZoom(),Tt=pt===ut.getMinZoom();this._zoomInButton.disabled=wt,this._zoomOutButton.disabled=Tt,this._zoomInButton.setAttribute("aria-disabled",wt.toString()),this._zoomOutButton.setAttribute("aria-disabled",Tt.toString())}_rotateCompassArrow(){const ut=this._map;if(!ut)return;const pt=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(ut.transform.pitch*(Math.PI/180)),.5)}) rotateX(${ut.transform.pitch}deg) rotateZ(${ut.transform.angle*(180/Math.PI)}deg)`:`rotate(${ut.transform.angle*(180/Math.PI)}deg)`;ut._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=pt)}))}onAdd(ut){return this._map=ut,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),ut.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&ut.on("pitch",this._rotateCompassArrow),ut.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new $s(ut,this._compass,this.options.visualizePitch)),this._container}onRemove(){const ut=this._map;ut&&(this._container.remove(),this.options.showZoom&&ut.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&ut.off("pitch",this._rotateCompassArrow),ut.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(ut,pt){const wt=a("button",ut,this._container);return wt.type="button",wt.addEventListener("click",pt),wt}_setButtonTitle(ut,pt){if(!this._map)return;const wt=this._map._getUIString(`NavigationControl.${pt}`);ut.setAttribute("aria-label",wt),ut.firstElementChild&&ut.firstElementChild.setAttribute("title",wt)}},GeolocateControl:class extends ut.E{constructor(pt){super();const wt=navigator.geolocation;this.options=ut.W({geolocation:wt},sd,pt),ut.bp(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=za(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(ut){return this._map=ut,this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(ut){const t=(pt=!!this.options.geolocation)=>{this._supportsGeolocation=pt,ut(pt)};void 0!==this._supportsGeolocation?ut(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((ut=>t("denied"!==ut.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(ut){const pt=this._map.getMaxBounds(),wt=ut.coords;return!!pt&&(wt.longitude<pt.getWest()||wt.longitude>pt.getEast()||wt.latitude<pt.getSouth()||wt.latitude>pt.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(pt){if(this._map){if(this._isOutOfMapMaxBounds(pt))return this._setErrorState(),this.fire(new ut.f("outofmaxbounds",pt)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=pt,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(pt),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(pt),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new ut.f("geolocate",pt)),this._finish()}}_updateCamera(pt){const wt=new ut.aI(pt.coords.longitude,pt.coords.latitude),Tt=pt.coords.accuracy,St=this._map.getBearing(),It=ut.W({bearing:St},this.options.fitBoundsOptions);this._map.fitBounds(wt.toBounds(Tt),It,{geolocateSource:!0})}_updateMarker(pt){if(pt){const wt=new ut.aI(pt.coords.longitude,pt.coords.latitude);this._accuracyCircleMarker.setLngLat(wt).addTo(this._map),this._userLocationDotMarker.setLngLat(wt).addTo(this._map),this._accuracy=pt.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const pt=this._map.transform,wt=ut.ax(1,pt._center.lat)*pt.worldSize,Tt=Math.ceil(2*this._accuracy*wt);this._circleElement.style.width=`${Tt}px`,this._circleElement.style.height=`${Tt}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(pt){if(this._map){if(this.options.trackUserLocation)if(1===pt.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const ut=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",ut),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",ut),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===pt.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new ut.f("error",pt)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(pt){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(ut=>ut.preventDefault())),this._geolocateButton=a("button","mapboxgl-ctrl-geolocate",this._container),a("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===pt){ut.w("Geolocation support is not available so the GeolocateControl will be disabled.");const pt=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",pt),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",pt)}else{const ut=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",ut),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",ut)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=a("div","mapboxgl-user-location"),this._dotElement.appendChild(a("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(a("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ns({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=a("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ns({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(pt=>{pt.geolocateSource||"ACTIVE_LOCK"!==this._watchState||pt.originalEvent&&"resize"===pt.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new ut.f("trackuserlocationend")))}))}}_onDeviceOrientation(ut){this._userLocationDotMarker&&(ut.webkitCompassHeading?this._heading=ut.webkitCompassHeading:!0===ut.absolute&&(this._heading=-1*ut.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return ut.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new ut.f("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new ut.f("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new ut.f("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let ut;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(ut={maximumAge:6e5,timeout:0},this._noTimeout=!0):(ut=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,ut),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((ut=>{"granted"===ut&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:zs,ScaleControl:class{constructor(pt){this.options=ut.W({},ad,pt),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(ut){return!1}}(),ut.bp(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const ut=this.options.maxWidth||100,pt=this._map,wt=pt._containerHeight/2,Tt=pt._containerWidth/2-ut/2,St=pt.unproject([Tt,wt]),It=pt.unproject([Tt+ut,wt]),Lt=St.distanceTo(It);if("imperial"===this.options.unit){const pt=3.2808*Lt;pt>5280?this._setScale(ut,pt/5280,"mile"):this._setScale(ut,pt,"foot")}else"nautical"===this.options.unit?this._setScale(ut,Lt/1852,"nautical-mile"):Lt>=1e3?this._setScale(ut,Lt/1e3,"kilometer"):this._setScale(ut,Lt,"meter")}_setScale(ut,pt,wt){this._map._requestDomTask((()=>{const Tt=function(ut){const pt=Math.pow(10,`${Math.floor(ut)}`.length-1);let wt=ut/pt;return wt=wt>=10?10:wt>=5?5:wt>=3?3:wt>=2?2:wt>=1?1:function(ut){const pt=Math.pow(10,Math.ceil(-Math.log(ut)/Math.LN10));return Math.round(ut*pt)/pt}(wt),pt*wt}(pt),St=Tt/pt;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==wt?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:wt}).format(Tt):`${Tt}&nbsp;${md[wt]}`,this._container.style.width=ut*St+"px"}))}onAdd(ut){return this._map=ut,this._language=ut.getLanguage(),this._container=a("div","mapboxgl-ctrl mapboxgl-ctrl-scale",ut.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(ut){this._language=ut,this._update()}setUnit(ut){this.options.unit=ut,this._update()}},FullscreenControl:class{constructor(pt){this._fullscreen=!1,pt&&pt.container&&(pt.container instanceof HTMLElement?this._container=pt.container:ut.w("Full screen control 'container' must be a DOM element.")),ut.bp(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(pt){return this._map=pt,this._container||(this._container=this._map.getContainer()),this._controlContainer=a("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",ut.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const ut=this._fullscreenButton=a("button","mapboxgl-ctrl-fullscreen",this._controlContainer);a("span","mapboxgl-ctrl-icon",ut).setAttribute("aria-hidden","true"),ut.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const ut=this._getTitle();this._fullscreenButton.setAttribute("aria-label",ut),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",ut)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends ut.E{constructor(pt){super(),this.options=ut.W(Object.create(td),pt),ut.bp(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(pt&&pt.className?pt.className.trim().split(/\s+/):[])}addTo(pt){return this._map&&this.remove(),this._map=pt,this.options.closeOnClick&&pt.on("preclick",this._onClose),this.options.closeOnMove&&pt.on("move",this._onClose),pt.on("remove",this.remove),this._update(),pt._addPopup(this),this._focusFirstElement(),this._trackPointer?(pt.on("mousemove",this._onMouseEvent),pt.on("mouseup",this._onMouseEvent),pt._canvasContainer.classList.add("mapboxgl-track-pointer")):pt.on("move",this._update),this.fire(new ut.f("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const pt=this._map;return pt&&(pt.off("move",this._update),pt.off("move",this._onClose),pt.off("preclick",this._onClose),pt.off("click",this._onClose),pt.off("remove",this.remove),pt.off("mousemove",this._onMouseEvent),pt.off("mouseup",this._onMouseEvent),pt.off("drag",this._onMouseEvent),pt._canvasContainer&&pt._canvasContainer.classList.remove("mapboxgl-track-pointer"),pt._removePopup(this),this._map=void 0),this.fire(new ut.f("close")),this}getLngLat(){return this._lngLat}setLngLat(pt){this._lngLat=ut.aI.convert(pt),this._pos=null,this._trackPointer=!1,this._update();const wt=this._map;return wt&&(wt.on("move",this._update),wt.off("mousemove",this._onMouseEvent),wt._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const ut=this._map;return ut&&(ut.off("move",this._update),ut.on("mousemove",this._onMouseEvent),ut.on("drag",this._onMouseEvent),ut._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(ut){return this.setDOMContent(document.createTextNode(ut))}setHTML(ut){const pt=document.createDocumentFragment(),wt=document.createElement("body");let Tt;for(wt.innerHTML=ut;Tt=wt.firstChild,Tt;)pt.appendChild(Tt);return this.setDOMContent(pt)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(ut){return this.options.maxWidth=ut,this._update(),this}setDOMContent(ut){let pt=this._content;if(pt)for(;pt.hasChildNodes();)pt.firstChild&&pt.removeChild(pt.firstChild);else pt=this._content=a("div","mapboxgl-popup-content",this._container||void 0);if(pt.appendChild(ut),this.options.closeButton){const ut=this._closeButton=a("button","mapboxgl-popup-close-button",pt);ut.type="button",ut.setAttribute("aria-label","Close popup"),ut.setAttribute("aria-hidden","true"),ut.innerHTML="&#215;",ut.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(ut){return this._classList.add(ut),this._updateClassList(),this}removeClassName(ut){return this._classList.delete(ut),this._updateClassList(),this}setOffset(ut){return this.options.offset=ut,this._update(),this}toggleClassName(ut){let pt;return this._classList.delete(ut)?pt=!1:(this._classList.add(ut),pt=!0),this._updateClassList(),pt}_onMouseEvent(ut){this._update(ut.point)}_getAnchor(ut){if(this.options.anchor)return this.options.anchor;const pt=this._map,wt=this._container,Tt=this._pos;if(!pt||!wt||!Tt)return"bottom";const St=wt.offsetWidth,It=wt.offsetHeight,Lt=Tt.x<St/2,Xt=Tt.x>pt.transform.width-St/2;if(Tt.y+ut<It)return Lt?"top-left":Xt?"top-right":"top";if(Tt.y>pt.transform.height-It){if(Lt)return"bottom-left";if(Xt)return"bottom-right"}return Lt?"left":Xt?"right":"bottom"}_updateClassList(){const ut=this._container;if(!ut)return;const pt=[...this._classList];pt.push("mapboxgl-popup"),this._anchor&&pt.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&pt.push("mapboxgl-popup-track-pointer"),ut.className=pt.join(" ")}_update(pt){const wt=this._map,Tt=this._content;if(!wt||!this._lngLat&&!this._trackPointer||!Tt)return;let St=this._container;if(St||(St=this._container=a("div","mapboxgl-popup",wt.getContainer()),this._tip=a("div","mapboxgl-popup-tip",St),St.appendChild(Tt)),this.options.maxWidth&&St.style.maxWidth!==this.options.maxWidth&&(St.style.maxWidth=this.options.maxWidth),wt.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Bs(this._lngLat,this._pos,wt.transform)),!this._trackPointer||pt){const ut=this._pos=this._trackPointer&&pt?pt:wt.project(this._lngLat),Tt=js(this.options.offset),St=this._anchor=this._getAnchor(Tt.y),It=js(this.options.offset,St),Lt=ut.add(It).round();wt._requestDomTask((()=>{this._container&&St&&(this._container.style.transform=`${ed[St]} translate(${Lt.x}px,${Lt.y}px)`)}))}if(!this._marker&&wt._showingGlobe()){const pt=ut.d9(wt.transform,this._lngLat)?0:1;this._setOpacity(pt)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const ut=this._container.querySelector(id);ut&&ut.focus()}_onClose(){this.remove()}_setOpacity(ut){this._container&&(this._container.style.opacity=`${ut}`),this._content&&(this._content.style.pointerEvents=ut?"auto":"none")}},Marker:Ns,Style:Ma,LngLat:ut.aI,LngLatBounds:ut.ai,Point:ut.P,MercatorCoordinate:ut.Y,FreeCameraOptions:Ht,Evented:ut.E,config:ut.d8,prewarm:ut.dx,clearPrewarmedResources:ut.dy,get accessToken(){return ut.d8.ACCESS_TOKEN},set accessToken(pt){ut.d8.ACCESS_TOKEN=pt},get baseApiUrl(){return ut.d8.API_URL},set baseApiUrl(pt){ut.d8.API_URL=pt},get workerCount(){return ut.dz.workerCount},set workerCount(pt){ut.dz.workerCount=pt},get maxParallelImageRequests(){return ut.d8.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(pt){ut.d8.MAX_PARALLEL_IMAGE_REQUESTS=pt},clearStorage(pt){ut.dA(pt)},get workerUrl(){return ut.dB.workerUrl},set workerUrl(pt){ut.dB.workerUrl=pt},get workerClass(){return ut.dB.workerClass},set workerClass(pt){ut.dB.workerClass=pt},get workerParams(){return ut.dB.workerParams},set workerParams(pt){ut.dB.workerParams=pt},get dracoUrl(){return ut.dC()},set dracoUrl(pt){ut.dD(pt)},get meshoptUrl(){return ut.dE()},set meshoptUrl(pt){ut.dF(pt)},setNow:ut.e.setNow,restoreNow:ut.e.restoreNow};return Cd}));var It=St;return It}));var St=wt;export{St as default};

